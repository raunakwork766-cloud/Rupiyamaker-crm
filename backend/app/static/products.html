<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products & Forms - Rupiya CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: #343a40;
        }
        .section-header {
            background-color: #212529;
            color: #0dcaf0;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .section-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .form-label {
            font-weight: 500;
        }
        .required::after {
            content: "*";
            color: red;
            margin-left: 3px;
        }
        .card {
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #0d6efd;
        }
        .btn-info {
            background-color: #0dcaf0;
            color: #fff;
        }
        .table th {
            background-color: #f8f9fa;
        }
        .obligation-entry {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .read-only-field {
            background-color: #e9ecef;
        }
        .admin-only {
            border-color: #0dcaf0;
        }
        #calculation-results {
            background-color: #f8f9fa;
            border-left: 4px solid #0dcaf0;
        }
        .status-badge {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 12px;
        }
        .status-new {
            background-color: #0dcaf0;
            color: white;
        }
        .status-in-progress {
            background-color: #ffc107;
            color: #212529;
        }
        .status-approved {
            background-color: #198754;
            color: white;
        }
        .status-rejected {
            background-color: #dc3545;
            color: white;
        }
        .form-section {
            margin-bottom: 30px;
        }
        .invalid-feedback {
            display: none;
        }
        .field-description {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        /* Admin-only and read-only field styling */
        .admin-only-field {
            background-color: rgba(255, 235, 205, 0.2);
            border-left: 3px solid #FF9800;
            padding-left: 10px;
        }
        
        .admin-only-field label::after {
            content: " (Admin Only)";
            font-size: 0.8em;
            color: #FF9800;
            font-style: italic;
        }
        
        .readonly-field {
            background-color: rgba(224, 224, 224, 0.2);
            border-left: 3px solid #9E9E9E;
            padding-left: 10px;
        }
        
        .readonly-field label::after {
            content: " (Read Only)";
            font-size: 0.8em;
            color: #9E9E9E;
            font-style: italic;
        }
        
        /* Form status styling */
        .form-status-container {
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
            margin-bottom: 20px;
        }
        
        /* Obligation table styling */
        .obligation-table th, .obligation-table td {
            vertical-align: middle;
        }
        
        /* Financial summary styling */
        .financial-summary {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .financial-summary .form-control[readonly] {
            background-color: #ffffff;
            font-weight: bold;
        }
        
        /* Calculation results styling */
        .calculation-result {
            font-weight: bold;
            color: #0d6efd;
        }
        
        /* Loading Indicator */
        #loading-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        /* Success Alert */
        #successAlert {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9998;
        }

        /* Error Alert */
        #errorAlert {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9998;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Rupiya CRM</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/leads-page">Leads</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/products-page">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/products-page">Feeds</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> <span id="current-user">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="logout-btn">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 id="page-title">Product Application Form</h2>
            <div>
                <button class="btn btn-outline-secondary me-2" id="cancelBtn"><i class="fas fa-arrow-left"></i> Back to List</button>
                <button class="btn btn-primary" id="productForm"><i class="fas fa-save"></i> Save Form</button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span>Product Selection</span>
                        <button id="newProductBtn" class="btn btn-sm btn-light"><i class="fas fa-plus"></i> New Product</button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="productSelect" class="form-label">Select Product</label>
                            <select class="form-select" id="productSelect">
                                <option value="" selected>-- Select Product --</option>
                                <!-- Products will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="leadSelect" class="form-label">Select Lead</label>
                            <select class="form-select" id="leadSelect">
                                <option value="" selected>-- Select Lead --</option>
                                <!-- Leads will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3" id="submission-status-container" style="display: none;">
                            <label class="form-label">Status</label>
                            <div>
                                <span class="status-badge status-new" id="submission-status">New</span>
                                <span class="ms-2 text-muted" id="submission-date"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        Lead Information
                    </div>
                    <div class="card-body">
                        <div id="leadDetails">
                            <p class="text-muted" id="no-lead-message">Select a lead to view details</p>
                            <div id="lead-details-content" style="display: none;">
                                <div class="mb-2"><strong>Lead ID:</strong> <span id="leadId">-</span></div>
                                <div class="mb-2"><strong>Name:</strong> <span id="customerName">-</span></div>
                                <div class="mb-2"><strong>Status:</strong> <span id="leadStatus" class="badge bg-primary">New</span></div>
                                <div class="mb-2"><strong>Phone:</strong> <span id="customerPhone">-</span></div>
                            </div>
                        </div>
                        <button id="viewLeadBtn" class="btn btn-sm btn-outline-info mt-2" style="display: none;">
                            <i class="fas fa-user"></i> View Full Lead Details
                        </button>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-primary text-white">
                        Product Information
                    </div>
                    <div class="card-body">
                        <div id="productDetails" style="display: none;">
                            <div class="mb-2">
                                <strong>Product ID:</strong> <span id="productCode">-</span>
                            </div>
                            <div class="mb-2">
                                <strong>Status:</strong> <span id="productStatus">-</span>
                            </div>
                            <div class="mb-2">
                                <strong>Creator:</strong> <span id="productCreator">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span>Form Details</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="edit-mode-toggle" checked>
                            <label class="form-check-label text-white" for="edit-mode-toggle">Edit Mode</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="formContainer">
                            <p class="text-muted" id="noProductMessage">Select a product and lead to load the form</p>
                            <!-- Dynamic form will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Application Form Container -->
        <div id="dynamic-form-container" style="display: none;">
            <!-- This will hold the dynamic form content based on the selected product -->
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading-indicator" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div id="loading-message" class="mt-2">Loading...</div>
    </div>
    
    <!-- Success Alert -->
    <div id="successAlert" class="alert alert-success alert-dismissible fade show" style="display:none; position: fixed; top: 20px; right: 20px; z-index: 9998;">
        <span id="successMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <!-- Error Alert -->
    <div id="errorAlert" class="alert alert-danger alert-dismissible fade show" style="display:none; position: fixed; top: 20px; right: 20px; z-index: 9998;">
        <span id="errorMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <!-- Alert Container for auth.js alerts -->
    <div id="alertContainer" class="position-fixed top-0 start-50 translate-middle-x mt-4" style="z-index: 9999;"></div>
    
    <!-- Form Templates -->
    <template id="personal-loan-template">
        <!-- Lead Information Section -->
        <div class="row">
            <div class="col-12">
                <div class="section-header">LEAD INFORMATION</div>
                <div class="section-container">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="campaign-name" class="form-label required">Campaign Name</label>
                            <select class="form-select" id="campaign-name" required>
                                <option value="CRM Data">CRM Data</option>
                                <option value="Website">Website</option>
                                <option value="Referral">Referral</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="data-code" class="form-label">Data Code</label>
                            <select class="form-select" id="data-code">
                                <option value="Money Maker 1">Money Maker 1</option>
                                <option value="Money Maker 2">Money Maker 2</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="company-category" class="form-label required">Company Category</label>
                            <select class="form-select" id="company-category" required>
                                <option value="Category A">Category A</option>
                                <option value="Category B">Category B</option>
                                <option value="Category C">Category C</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Information Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="section-header">PERSONAL</div>
                <div class="section-container">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="customer-name" class="form-label required">Customer Name</label>
                            <input type="text" class="form-control" id="customer-name" placeholder="Full Name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="alternate-number" class="form-label">Alternate Number</label>
                            <input type="tel" class="form-control" id="alternate-number" placeholder="Alternate Mobile Number">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="pincode" class="form-label required">Pincode</label>
                            <input type="text" class="form-control" id="pincode" placeholder="6-digit Pincode" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="city" class="form-label required">City</label>
                            <input type="text" class="form-control" id="city" placeholder="City" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="company-name" class="form-label required">Company Name</label>
                            <input type="text" class="form-control" id="company-name" placeholder="Company Name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="company-type" class="form-label required">Company Type</label>
                            <select class="form-select" id="company-type" required>
                                <option value="">Select Type</option>
                                <option value="Private">Private</option>
                                <option value="Public">Public</option>
                                <option value="Government">Government</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Information Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="section-header">FINANCIAL</div>
                <div class="section-container">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="monthly-salary" class="form-label required">Monthly Salary</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control financial-input" id="monthly-salary" placeholder="In Rupees" required>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="partner-salary" class="form-label">Partner's Salary</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control financial-input" id="partner-salary" placeholder="In Rupees">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="yearly-bonus" class="form-label">Yearly Bonus</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control financial-input" id="yearly-bonus" placeholder="In Rupees">
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="bonus-division" class="form-label">Bonus Division</label>
                            <select class="form-select" id="bonus-division">
                                <option value="12 Months">12 Months</option>
                                <option value="6 Months">6 Months</option>
                                <option value="3 Months">3 Months</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="loan-amount-required" class="form-label required">Loan Amount Required</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control financial-input" id="loan-amount-required" placeholder="In Rupees" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Obligation Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="section-header">CUSTOMER OBLIGATION</div>
                <div class="section-container">
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <label for="total-bt-pos" class="form-label">Total BT POS</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control calculation-input" id="total-bt-pos" placeholder="BT POS Amount">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="total-obligation" class="form-label">Total Obligation</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control calculation-input" id="total-obligation" placeholder="Obligation Amount">
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered" id="obligation-table">
                            <thead>
                                <tr>
                                    <th>S.No</th>
                                    <th>Product</th>
                                    <th>Bank Name</th>
                                    <th>Tenure</th>
                                    <th>ROI%</th>
                                    <th>Total Loan</th>
                                    <th>Outstanding</th>
                                    <th>EMI</th>
                                    <th>Action</th>
                                    <th>Delete</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="obligation-row">
                                    <td>1</td>
                                    <td>
                                        <select class="form-select form-select-sm">
                                            <option value="">Select Product</option>
                                            <option value="Personal Loan">Personal Loan</option>
                                            <option value="Home Loan">Home Loan</option>
                                            <option value="Auto Loan">Auto Loan</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm">
                                            <option value="">Select Bank</option>
                                            <option value="HDFC">HDFC Bank</option>
                                            <option value="ICICI">ICICI Bank</option>
                                            <option value="SBI">State Bank of India</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control form-control-sm" placeholder="Months"></td>
                                    <td><input type="text" class="form-control form-control-sm" placeholder="%"></td>
                                    <td><input type="text" class="form-control form-control-sm loan-amount" placeholder="Loan"></td>
                                    <td><input type="text" class="form-control form-control-sm outstanding-amount" placeholder="Outstanding"></td>
                                    <td><input type="text" class="form-control form-control-sm emi-amount" placeholder="EMI"></td>
                                    <td>
                                        <select class="form-select form-select-sm">
                                            <option value="">Select</option>
                                            <option value="BT">BT</option>
                                            <option value="Continue">Continue</option>
                                        </select>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-danger delete-row-btn">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-info" id="addObligationRow">
                            <i class="fas fa-plus"></i> Add Another Obligation
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Eligibility Check Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="section-header">CHECK ELIGIBILITY</div>
                <div class="section-container">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="total-income" class="form-label">Total Income</label>
                            <input type="text" class="form-control read-only-field" id="total-income" readonly>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="eligibility-category" class="form-label">Company Category</label>
                            <select class="form-select" id="eligibility-category">
                                <option value="">Select Category</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="foir" class="form-label">FOIR %</label>
                            <input type="text" class="form-control" id="foir" placeholder="FOIR Percentage">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="foir-amount" class="form-label">FOIR Amount</label>
                            <input type="text" class="form-control read-only-field" id="foir-amount" readonly>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="eligibility-total-obligation" class="form-label">Total Obligation</label>
                            <input type="text" class="form-control read-only-field" id="eligibility-total-obligation" readonly>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="monthly-emi-can-pay" class="form-label">Monthly EMI Can Pay</label>
                            <input type="text" class="form-control read-only-field" id="monthly-emi-can-pay" readonly>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="tenure-months" class="form-label">TENURE (Months)</label>
                            <input type="number" class="form-control" id="tenure-months">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="tenure-years" class="form-label">TENURE (Years)</label>
                            <input type="text" class="form-control read-only-field" id="tenure-years" readonly>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="roi" class="form-label">ROI</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="roi" placeholder="Rate of Interest">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="eligibility-bt-pos" class="form-label">TOTAL BT POS</label>
                            <input type="text" class="form-control read-only-field" id="eligibility-bt-pos" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="loan-eligibility-hour" class="form-label">Loan Eligibility as per Hour</label>
                            <input type="text" class="form-control read-only-field" id="loan-eligibility-hour" readonly>
                            <div id="eligibility-message" class="mt-2"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="loan-eligibility-multiplier" class="form-label">Loan Eligibility as per Multiplier</label>
                            <input type="text" class="form-control read-only-field" id="loan-eligibility-multiplier" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="multiplier" class="form-label">Multiplier</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="multiplier" placeholder="Multiplier value">
                                <span class="input-group-text">Max 3x</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status and Submission Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="section-header">STATUS UPDATE</div>
                <div class="section-container">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="status-select" class="form-label">Status</label>
                            <select class="form-select" id="status-select">
                                <option value="submitted">Submitted</option>
                                <option value="in-progress">In Progress</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="status-notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="status-notes" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-4 mb-5">
            <div class="col-12 d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" id="cancel-form">Cancel</button>
                <div>
                    <button type="button" class="btn btn-info me-2" id="calculate-eligibility">Calculate Eligibility</button>
                    <button type="submit" class="btn btn-primary" id="submit-form">Submit Application</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Product Creation Modal -->
    <div class="modal fade" id="newProductModal" tabindex="-1" aria-labelledby="newProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="newProductModalLabel">Create New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="productCreationTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basic-info" type="button" role="tab" aria-controls="basic-info" aria-selected="true">Basic Info</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="form-sections-tab" data-bs-toggle="tab" data-bs-target="#form-sections" type="button" role="tab" aria-controls="form-sections" aria-selected="false">Form Sections</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="form-fields-tab" data-bs-toggle="tab" data-bs-target="#form-fields" type="button" role="tab" aria-controls="form-fields" aria-selected="false">Form Fields</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3" id="productCreationTabContent">
                        <!-- Basic Info Tab -->
                        <div class="tab-pane fade show active" id="basic-info" role="tabpanel" aria-labelledby="basic-info-tab">
                            <form id="productBasicInfoForm">
                                <div class="mb-3">
                                    <label for="productName" class="form-label">Loan Product Name *</label>
                                    <input type="text" class="form-control" id="productName" required placeholder="Enter loan product name">
                                </div>
                                <div class="mb-3">
                                    <label for="productStatus" class="form-label">Status</label>
                                    <select class="form-select" id="productStatus">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="draft">Draft</option>
                                    </select>
                                </div>
                            </form>
                            <div class="d-flex justify-content-end mt-3">
                                <button type="button" class="btn btn-primary" id="nextToSectionsBtn">Next: Form Sections</button>
                            </div>
                        </div>
                        
                        <!-- Form Sections Tab -->
                        <div class="tab-pane fade" id="form-sections" role="tabpanel" aria-labelledby="form-sections-tab">
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle"></i> Form sections organize your form fields. Add at least one section before adding fields.
                                <br>
                                <strong>Note:</strong> If you create a section with the word "obligation" in its name, standard obligation fields will be automatically added.
                            </div>
                            <form id="sectionForm" class="mb-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="sectionName" class="form-label">Section Name *</label>
                                        <input type="text" class="form-control" id="sectionName" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="sectionOrder" class="form-label">Display Order</label>
                                        <input type="number" class="form-control" id="sectionOrder" value="1" min="1">
                                    </div>
                                    <div class="col-12">
                                        <label for="sectionDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="sectionDescription" rows="2"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="sectionRequired" checked>
                                            <label class="form-check-label" for="sectionRequired">
                                                Required Section
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="sectionActive" checked>
                                            <label class="form-check-label" for="sectionActive">
                                                Active
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button type="button" id="addSectionBtn" class="btn btn-success">
                                            <i class="fas fa-plus"></i> Add Section
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <div class="card mt-3">
                                <div class="card-header bg-light">
                                    Form Sections
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Order</th>
                                                <th>Required</th>
                                                <th>Active</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sectionsList">
                                            <!-- Sections will be added here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-secondary" id="backToBasicBtn">Back: Basic Info</button>
                                <button type="button" class="btn btn-primary" id="nextToFieldsBtn">Next: Form Fields</button>
                            </div>
                        </div>
                        
                        <!-- Form Fields Tab -->
                        <div class="tab-pane fade" id="form-fields" role="tabpanel" aria-labelledby="form-fields-tab">
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle"></i> Add fields to your form sections. Different field types support different input formats.
                            </div>
                            <form id="fieldForm" class="mb-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="fieldSection" class="form-label">Section *</label>
                                        <select class="form-select" id="fieldSection" required>
                                            <option value="">Select Section</option>
                                            <!-- Sections will be added here dynamically -->
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="fieldType" class="form-label">Field Type *</label>
                                        <select class="form-select" id="fieldType" required>
                                            <option value="">Select Type</option>
                                            <option value="text">Text</option>
                                            <option value="textarea">Text Area</option>
                                            <option value="number">Number</option>
                                            <option value="email">Email</option>
                                            <option value="tel">Phone</option>
                                            <option value="date">Date</option>
                                            <option value="select">Dropdown</option>
                                            <option value="checkbox">Checkbox</option>
                                            <option value="radio">Radio Buttons</option>
                                            <option value="file">File Upload</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8">
                                        <label for="fieldLabel" class="form-label">Field Label *</label>
                                        <input type="text" class="form-control" id="fieldLabel" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="fieldOrder" class="form-label">Display Order</label>
                                        <input type="number" class="form-control" id="fieldOrder" value="1" min="1">
                                    </div>
                                    <div class="col-md-12">
                                        <label for="fieldPlaceholder" class="form-label">Placeholder</label>
                                        <input type="text" class="form-control" id="fieldPlaceholder">
                                    </div>
                                    <div class="col-md-12">
                                        <label for="fieldHelpText" class="form-label">Help Text</label>
                                        <input type="text" class="form-control" id="fieldHelpText">
                                    </div>
                                    <div class="col-md-12" id="optionsContainer" style="display: none;">
                                        <label class="form-label">Options</label>
                                        <div id="optionsList">
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control option-label" placeholder="Option Label">
                                                <input type="text" class="form-control option-value" placeholder="Option Value">
                                                <button type="button" class="btn btn-outline-danger remove-option">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <button type="button" id="addOptionBtn" class="btn btn-sm btn-outline-secondary mt-1">
                                            <i class="fas fa-plus"></i> Add Option
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="fieldRequired">
                                            <label class="form-check-label" for="fieldRequired">
                                                Required Field
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="fieldActive" checked>
                                            <label class="form-check-label" for="fieldActive">
                                                Active
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="fieldVisible" checked>
                                            <label class="form-check-label" for="fieldVisible">
                                                Visible
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="fieldAdminOnly">
                                            <label class="form-check-label" for="fieldAdminOnly">
                                                Admin Only
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="fieldReadOnly">
                                            <label class="form-check-label" for="fieldReadOnly">
                                                Read Only
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button type="button" id="addFieldBtn" class="btn btn-success">
                                            <i class="fas fa-plus"></i> Add Field
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <div class="card mt-3">
                                <div class="card-header bg-light">
                                    Form Fields
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th>Section</th>
                                                <th>Label</th>
                                                <th>Type</th>
                                                <th>Required</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fieldsList">
                                            <!-- Fields will be added here dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-secondary" id="backToSectionsBtn">Back: Form Sections</button>
                                <button type="button" class="btn btn-primary" id="completeProductCreationBtn">Create Product</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Load auth.js first since product-utils.js might need functions from it -->
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/product-utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded - Starting initialization");
            
            // Hardcode user ID - no authentication required
            const HARDCODED_USER_ID = '6852a2978d7cdc3a71c482a6';
            const HARDCODED_TOKEN = 'hardcoded-token';
            
            // Set hardcoded values in localStorage for compatibility
            localStorage.setItem('userId', HARDCODED_USER_ID);
            localStorage.setItem('token', HARDCODED_TOKEN);
            localStorage.setItem('userName', 'Demo User');
            
            console.log("Using hardcoded user ID:", HARDCODED_USER_ID);
            
            // Initialize variables
            let currentUser = null;
            let selectedProductId = null;
            let selectedLeadId = null;
            let formSections = [];
            let formFields = {};
            let editMode = true;
            let formSubmissionId = null;
            let submissionId = null; // Added to fix a reference
            
            // Get DOM elements
            const productSelect = document.getElementById('productSelect');
            const leadSelect = document.getElementById('leadSelect');
            const formContainer = document.getElementById('formContainer');
            const noProductMessage = document.getElementById('noProductMessage');
            const dynamicFormContainer = document.getElementById('dynamic-form-container');
            const submissionStatusContainer = document.getElementById('submission-status-container');
            const submissionStatus = document.getElementById('submission-status');
            const submissionDate = document.getElementById('submission-date');
            const leadDetails = document.getElementById('leadDetails');
            const editModeToggle = document.getElementById('edit-mode-toggle');
            const saveFormBtn = document.getElementById('productForm');
            const cancelBtn = document.getElementById('cancelBtn');
            const loadingIndicator = document.getElementById('loading-indicator');
            const successAlert = document.getElementById('successAlert');
            const errorAlert = document.getElementById('errorAlert');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const newProductBtn = document.getElementById('newProductBtn');
            
            // Set current user display
            const currentUserElement = document.getElementById('current-user');
            if (currentUserElement) {
                currentUserElement.textContent = 'Demo User';
            }
            
            // Set current user object for consistency
            currentUser = {
                id: HARDCODED_USER_ID,
                first_name: 'Demo',
                last_name: 'User',
                username: 'demo-user'
            };
            
            // Helper function to safely get DOM elements with logging
            function safeGetElement(id) {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`DOM element with ID '${id}' not found`);
                }
                return element;
            }
            
            // Initialize the page by loading products and leads
            try {
                loadProducts();
                loadLeads();
            } catch (e) {
                console.error("Error initializing page:", e);
                showErrorAlert("Error loading data. Please refresh the page.");
            }
            
            // Load products list
            function loadProducts() {
                showLoadingIndicator(true, 'Loading products...');
                const token = localStorage.getItem('token'); // This will always be the hardcoded token
                
                axios.get('/products/', {  // Note the trailing slash added
                    params: {
                        user_id: localStorage.getItem('userId')
                    },
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    console.log('Products loaded:', response.data.items.length);
                    productSelect.innerHTML = '<option value="" selected>-- Select Product --</option>';
                    
                    response.data.items.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product._id;
                        option.textContent = product.name;
                        productSelect.appendChild(option);
                    });
                    
                    showLoadingIndicator(false);
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    showErrorAlert('Failed to load products. Please try again.');
                    showLoadingIndicator(false);
                });
            }
            
            // Load leads list
            function loadLeads() {
                showLoadingIndicator(true, 'Loading leads...');
                const token = localStorage.getItem('token'); // This will always be the hardcoded token
                
                axios.get('/leads/', {  // Note the trailing slash added
                    params: {
                        user_id: localStorage.getItem('userId'),
                        page: 1,
                        page_size: 100
                    },
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    console.log('Leads loaded:', response.data.items.length);
                    leadSelect.innerHTML = '<option value="" selected>-- Select Lead --</option>';
                    
                    response.data.items.forEach(lead => {
                        const option = document.createElement('option');
                        option.value = lead._id;
                        option.textContent = `${lead.first_name} ${lead.last_name} (${lead.phone})`;
                        leadSelect.appendChild(option);
                    });
                    
                    showLoadingIndicator(false);
                })
                .catch(error => {
                    console.error('Error loading leads:', error);
                    showErrorAlert('Failed to load leads. Please try again.');
                    showLoadingIndicator(false);
                });
            }
            
            // Load product form template - SIMPLIFIED VERSION
            function loadProductFormTemplate(productId) {
                console.log('Loading basic product info for:', productId);
                showLoadingIndicator(true, 'Loading product information...');
                
                const token = localStorage.getItem('token');
                
                // Just get basic product details
                axios.get(`/products/${productId}/`, {
                    params: {
                        user_id: localStorage.getItem('userId')
                    },
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    const product = response.data;
                    console.log('Product details loaded:', product.name);
                    
                    // Update product details section
                    document.getElementById('productCode').textContent = product._id || '-';
                    document.getElementById('productStatus').textContent = product.status || 'Active';
                    document.getElementById('productCreator').textContent = product.creator_name || '-';
                    document.getElementById('productDetails').style.display = 'block';
                    
                    // Show simple message instead of complex form
                    showSimpleProductMessage(product);
                    
                    selectedProductId = productId;
                    showLoadingIndicator(false);
                })
                .catch(error => {
                    console.error('Error loading product details:', error);
                    showErrorAlert('Failed to load product details. Please try again.');
                    showLoadingIndicator(false);
                });
            }
            
            // Show simple product selection message
            function showSimpleProductMessage(product) {
                if (formContainer) {
                    formContainer.style.display = 'block';
                    formContainer.innerHTML = `
                        <div class="alert alert-success" role="alert">
                            <h4 class="alert-heading"><i class="fas fa-check-circle"></i> Product Selected!</h4>
                            <p>You have selected: <strong>${product.name}</strong></p>
                            <p class="mb-0">Product Code: <code>${product._id}</code></p>
                            <hr>
                            <p class="mb-0">Now select a lead from the dropdown to associate with this loan product.</p>
                        </div>
                    `;
                }
                
                // Hide the no product message
                const noProductMsg = document.getElementById('noProductMessage');
                if (noProductMsg) {
                    noProductMsg.style.display = 'none';
                }
            }
            
            // Load lead details - SIMPLIFIED VERSION
            function loadLeadDetails(leadId) {
                console.log('Loading lead details:', leadId);
                showLoadingIndicator(true, 'Loading lead details...');
                
                const token = localStorage.getItem('token');
                axios.get(`/leads/${leadId}/`, {
                    params: {
                        user_id: localStorage.getItem('userId')
                    },
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    const lead = response.data;
                    console.log('Lead details loaded:', lead.first_name, lead.last_name);
                    
                    // Hide the "no lead selected" message
                    const noLeadMsg = document.getElementById('no-lead-message');
                    if (noLeadMsg) noLeadMsg.style.display = 'none';
                    
                    // Show the lead details content
                    const leadDetailsContent = document.getElementById('lead-details-content');
                    if (leadDetailsContent) leadDetailsContent.style.display = 'block';
                    
                    // Update lead details
                    const leadIdElement = document.getElementById('leadId');
                    if (leadIdElement) leadIdElement.textContent = lead._id;
                    
                    const customerNameElement = document.getElementById('customerName');
                    if (customerNameElement) customerNameElement.textContent = `${lead.first_name} ${lead.last_name}`;
                    
                    // Set lead status with appropriate class
                    const statusBadge = document.getElementById('leadStatus');
                    if (statusBadge) {
                        statusBadge.textContent = lead.status_name || 'New';
                        statusBadge.className = 'badge';
                        statusBadge.classList.add(`bg-${getStatusColor(lead.status_name)}`);
                    }
                    
                    const customerPhoneElement = document.getElementById('customerPhone');
                    if (customerPhoneElement) customerPhoneElement.textContent = lead.phone || '-';
                    
                    // Show the view lead button
                    const viewLeadBtn = document.getElementById('viewLeadBtn');
                    if (viewLeadBtn) viewLeadBtn.style.display = 'inline-block';
                    
                    selectedLeadId = leadId;
                    
                    // Show success message if both product and lead are selected
                    if (selectedProductId && selectedLeadId) {
                        showLeadProductAssociation();
                    }
                    
                    showLoadingIndicator(false);
                })
                .catch(error => {
                    console.error('Error loading lead details:', error);
                    showErrorAlert('Failed to load lead details. Please try again.');
                    showLoadingIndicator(false);
                });
            }
            
            // Show lead-product association message
            function showLeadProductAssociation() {
                if (formContainer && selectedProductId && selectedLeadId) {
                    const productName = productSelect.options[productSelect.selectedIndex].text;
                    const leadName = leadSelect.options[leadSelect.selectedIndex].text;
                    
                    formContainer.innerHTML = `
                        <div class="alert alert-info" role="alert">
                            <h4 class="alert-heading"><i class="fas fa-link"></i> Lead & Product Associated!</h4>
                            <p><strong>Product:</strong> ${productName}</p>
                            <p><strong>Lead:</strong> ${leadName}</p>
                            <hr>
                            <p class="mb-0">This lead is now associated with the selected loan product. You can create additional leads for different products.</p>
                        </div>
                    `;
                }
            }
            
            // COMMENTED OUT: Complex form submission functionality
            /*
            // Check if lead already has a form submission for this product
            function checkExistingSubmission(leadId, productId) {
                console.log('Checking existing submissions for lead:', leadId, 'and product:', productId);
                if (!leadId || !productId) return;
                
                showLoadingIndicator(true, 'Checking existing submissions...');
                
                const token = localStorage.getItem('token');
                axios.get(`/products/lead/${leadId}/forms`, {
                    params: {
                        user_id: localStorage.getItem('userId')
                    },
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    const submissions = response.data;
                    console.log('Found submissions:', submissions.length);
                    const matchingSubmission = submissions.find(sub => sub.product_id === productId);
                    
                    if (matchingSubmission) {
                        console.log('Found matching submission:', matchingSubmission._id);
                        formSubmissionId = matchingSubmission._id;
                        
                        // Update UI to show submission exists
                        submissionStatusContainer.style.display = 'block';
                        submissionStatus.textContent = matchingSubmission.status.charAt(0).toUpperCase() + matchingSubmission.status.slice(1);
                        submissionStatus.className = `status-badge status-${matchingSubmission.status.toLowerCase()}`;
                        submissionDate.textContent = `Submitted on ${formatDate(matchingSubmission.created_at)}`;
                        
                        // Load submission data
                        loadFormSubmission(matchingSubmission._id);
                    } else {
                        console.log('No matching submission found, showing empty form');
                        formSubmissionId = null;
                        submissionStatusContainer.style.display = 'none';
                        
                        // Reset form to empty state with lead details
                        resetFormFields();
                    }
                    
                    showLoadingIndicator(false);
                })
                .catch(error => {
                    console.error('Error checking existing submissions:', error);
                    showErrorAlert('Failed to check existing submissions. Please try again.');
                    showLoadingIndicator(false);
                });
            }
            
            // Load form submission data
            function loadFormSubmission(submissionId) {
                const token = localStorage.getItem('token');
                axios.get(`/products/forms/submissions/${submissionId}`, {
                    params: {
                        user_id: localStorage.getItem('userId')
                    },
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    const submission = response.data;
                    
                    // Fill form with submission data
                    // For our demo, we'll manually populate fields from the personal loan template
                    populateFormWithSubmissionData(submission);
                })
                .catch(error => {
                    console.error('Error loading submission data:', error);
                });
            }
            
            // Populate form with submission data
            function populateFormWithSubmissionData(submission) {
                // In a real implementation, this would dynamically populate based on form structure
                // For demo, we'll use the predefined field IDs
                const formData = submission.form_data || {};
                
                // Example population for personal loan demo
                // Personal section
                if (document.getElementById('customer-name') && formData.customer_name) {
                    document.getElementById('customer-name').value = formData.customer_name;
                }
                if (document.getElementById('city') && formData.city) {
                    document.getElementById('city').value = formData.city;
                }
                // And so on for other fields
                
                // Financial section
                if (document.getElementById('monthly-salary') && formData.monthly_salary) {
                    document.getElementById('monthly-salary').value = formData.monthly_salary;
                }
                if (document.getElementById('loan-amount-required') && formData.loan_amount) {
                    document.getElementById('loan-amount-required').value = formData.loan_amount;
                }
                
                // Update status
                if (document.getElementById('status-select') && submission.status) {
                    document.getElementById('status-select').value = submission.status;
                }
                
                // Update edit mode based on permissions
                updateEditMode(submission.can_edit !== false);
            }
            */
            
            // Render the dynamic form based on the selected product
            function renderDynamicForm() {
                console.log("Rendering dynamic form...");
                
                // Make sure formContainer exists
                if (!formContainer) {
                    console.error("Form container not found");
                    showErrorAlert("Form container not found. Please contact support.");
                    return;
                }
                
                // Make sure dynamicFormContainer exists and is visible
                if (dynamicFormContainer) {
                    dynamicFormContainer.style.display = 'block';
                    console.log("Dynamic form container made visible");
                }
                
                // For the demo, we're using a predefined template
                // In a real implementation, you would render dynamically based on sections and fields
                
                const template = document.getElementById('personal-loan-template');
                if (!template) {
                    console.error("Form template not found!");
                    showErrorAlert("Form template not found. Please contact support.");
                    return;
                }
                
                console.log("Template found, cloning content");
                const templateContent = template.content.cloneNode(true);
                
                // Clear the form container
                formContainer.innerHTML = '';
                
                // Show the form - ensure formContainer is visible
                formContainer.style.display = 'block';
                
                // Hide the no product message if it exists
                const noProductMsg = document.getElementById('noProductMessage');
                if (noProductMsg) {
                    noProductMsg.style.display = 'none';
                }
                
                console.log("Appending template content to form container");
                formContainer.appendChild(templateContent);
                
                // Initialize form calculations
                initializeFormCalculations();
                
                // Setup add/delete row functionality
                setupObligationTable();
                
                console.log("Form rendering complete - form should now be visible");
            }
            
            // Render dynamic form from API response
            function renderDynamicFormFromAPI(template) {
                console.log("Rendering dynamic form from API data...", template);
                
                // Make sure formContainer exists
                if (!formContainer) {
                    console.error("Form container not found");
                    showErrorAlert("Form container not found. Please contact support.");
                    return;
                }
                
                // Make sure dynamicFormContainer exists and is visible
                if (dynamicFormContainer) {
                    dynamicFormContainer.style.display = 'block';
                    console.log("Dynamic form container made visible");
                }
                
                // Clear the form container
                formContainer.innerHTML = '';
                
                // Show the form - ensure formContainer is visible
                formContainer.style.display = 'block';
                
                // Hide the no product message if it exists
                const noProductMsg = document.getElementById('noProductMessage');
                if (noProductMsg) {
                    noProductMsg.style.display = 'none';
                }
                
                // Check if we have sections to render
                if (!template.sections || template.sections.length === 0) {
                    console.log("No sections found, falling back to static template");
                    renderDynamicForm(); // Fallback to static template
                    return;
                }
                
                // Render each section
                template.sections.forEach(section => {
                    console.log("Rendering section:", section.section_name);
                    const sectionHtml = renderSection(section);
                    formContainer.appendChild(sectionHtml);
                });
                
                // Initialize form functionality
                initializeFormCalculations();
                setupObligationTable();
                
                console.log("Dynamic form rendering complete - form should now be visible");
            }
            
            // Render a single section
            function renderSection(section) {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'row mt-4';
                
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                sectionHeader.textContent = section.section_name.toUpperCase();
                
                const sectionContainer = document.createElement('div');
                sectionContainer.className = 'section-container';
                
                const fieldsRow = document.createElement('div');
                fieldsRow.className = 'row';
                
                // Render fields in this section
                if (section.fields && section.fields.length > 0) {
                    section.fields.forEach(field => {
                        const fieldHtml = renderField(field);
                        fieldsRow.appendChild(fieldHtml);
                    });
                } else {
                    // Show message if no fields
                    const noFieldsMsg = document.createElement('div');
                    noFieldsMsg.className = 'col-12 text-muted';
                    noFieldsMsg.textContent = 'No fields configured for this section.';
                    fieldsRow.appendChild(noFieldsMsg);
                }
                
                sectionContainer.appendChild(fieldsRow);
                
                const colDiv = document.createElement('div');
                colDiv.className = 'col-12';
                colDiv.appendChild(sectionHeader);
                colDiv.appendChild(sectionContainer);
                
                sectionDiv.appendChild(colDiv);
                
                return sectionDiv;
            }
            
            // Render a single field
            function renderField(field) {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'col-md-4 mb-3'; // Default column size
                
                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = field.label;
                if (field.is_required) {
                    label.classList.add('required');
                }
                
                let input;
                
                // Create input based on field type
                switch (field.field_type) {
                    case 'text':
                    case 'email':
                    case 'tel':
                        input = document.createElement('input');
                        input.type = field.field_type;
                        input.className = 'form-control';
                        input.placeholder = field.placeholder || '';
                        if (field.default_value) input.value = field.default_value;
                        break;
                        
                    case 'number':
                        input = document.createElement('input');
                        input.type = 'number';
                        input.className = 'form-control';
                        input.placeholder = field.placeholder || '';
                        if (field.default_value) input.value = field.default_value;
                        if (field.validation) {
                            if (field.validation.min !== undefined) input.min = field.validation.min;
                            if (field.validation.max !== undefined) input.max = field.validation.max;
                        }
                        break;
                        
                    case 'textarea':
                        input = document.createElement('textarea');
                        input.className = 'form-control';
                        input.placeholder = field.placeholder || '';
                        if (field.default_value) input.value = field.default_value;
                        input.rows = 3;
                        break;
                        
                    case 'select':
                        input = document.createElement('select');
                        input.className = 'form-select';
                        
                        // Add default empty option
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = field.placeholder || 'Select...';
                        input.appendChild(defaultOption);
                        
                        // Add options
                        if (field.options && field.options.length > 0) {
                            field.options.forEach(option => {
                                const optionElement = document.createElement('option');
                                optionElement.value = option.value;
                                optionElement.textContent = option.label;
                                if (option.value === field.default_value) {
                                    optionElement.selected = true;
                                }
                                input.appendChild(optionElement);
                            });
                        }
                        break;
                        
                    case 'checkbox':
                        fieldDiv.className = 'col-md-6 mb-3'; // Checkboxes get different sizing
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.className = 'form-check';
                        
                        input = document.createElement('input');
                        input.type = 'checkbox';
                        input.className = 'form-check-input';
                        if (field.default_value) input.checked = field.default_value;
                        
                        label.className = 'form-check-label';
                        checkboxDiv.appendChild(input);
                        checkboxDiv.appendChild(label);
                        
                        fieldDiv.appendChild(checkboxDiv);
                        
                        // Add help text if available
                        if (field.help_text) {
                            const helpText = document.createElement('small');
                            helpText.className = 'form-text text-muted';
                            helpText.textContent = field.help_text;
                            fieldDiv.appendChild(helpText);
                        }
                        
                        return fieldDiv;
                        
                    case 'date':
                        input = document.createElement('input');
                        input.type = 'date';
                        input.className = 'form-control';
                        if (field.default_value) input.value = field.default_value;
                        break;
                        
                    default:
                        // Default to text input
                        input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'form-control';
                        input.placeholder = field.placeholder || '';
                        if (field.default_value) input.value = field.default_value;
                }
                
                // Set common attributes
                if (input && input.type !== 'checkbox') {
                    input.id = field.label.toLowerCase().replace(/\s+/g, '-') + '-' + field._id;
                    input.name = field._id;
                    if (field.is_required) input.required = true;
                    if (field.is_readonly && !field.can_edit) input.readOnly = true;
                    
                    label.setAttribute('for', input.id);
                    
                    fieldDiv.appendChild(label);
                    fieldDiv.appendChild(input);
                    
                    // Add help text if available
                    if (field.help_text) {
                        const helpText = document.createElement('small');
                        helpText.className = 'form-text text-muted';
                        helpText.textContent = field.help_text;
                        fieldDiv.appendChild(helpText);
                    }
                }
                
                return fieldDiv;
            }
            
            // ...existing code...
