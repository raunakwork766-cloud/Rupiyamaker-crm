<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Feeds</title>
    <!-- Author: soheru -->
    <!-- Updated: 2025-06-18 13:56:58 -->
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .feed-card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .feed-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        .feed-actions {
            display: flex;
            padding: 8px 15px;
            border-top: 1px solid #eee;
        }
        .feed-action {
            margin-right: 20px;
            color: #666;
            cursor: pointer;
        }
        .feed-action.active {
            color: #0d6efd;
        }
        /* Enhanced image gallery styling */
        .feed-media {
            margin-top: 15px;
        }
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            position: relative;
        }
        .image-gallery.one-image {
            grid-template-columns: 1fr;
        }
        .image-gallery.two-images {
            grid-template-columns: 1fr 1fr;
        }
        .gallery-item {
            position: relative;
            padding-bottom: 100%; /* Square aspect ratio */
            overflow: hidden;
            border-radius: 6px;
        }
        .gallery-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        .more-images {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 6px;
        }
        .file-attachments {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        .file-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .file-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
            margin-right: 10px;
            color: #6c757d;
        }
        .file-info {
            flex-grow: 1;
        }
        .file-size {
            color: #6c757d;
            font-size: 12px;
        }
        .file-attachments-summary {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 10px;
            cursor: pointer;
        }
        .file-summary-icon {
            margin-right: 10px;
            color: #6c757d;
        }
        .comment {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .comment:last-child {
            border-bottom: none;
        }
        #createPostForm {
            margin-bottom: 30px;
        }
        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .file-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 5px;
            border: 1px solid #ddd;
            overflow: hidden;
        }
        .file-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .file-preview-item .file-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 3px;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 10px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-remove {
            position: absolute;
            top: 3px;
            right: 3px;
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #dc3545;
            font-weight: bold;
        }
        .comment-actions {
            display: none;
            margin-top: 5px;
        }
        .comment:hover .comment-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }
        #loadingSpinner {
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        #userProfileBar {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .nav-pills .nav-link {
            color: #495057;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- User profile bar -->
        <div id="userProfileBar" class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <img id="userAvatar" src="" class="avatar me-2" alt="User Avatar">
                <div>
                    <h5 class="mb-0" id="userName">Loading user...</h5>
                    <small class="text-muted" id="userRole">User</small>
                </div>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="logout()">
                <i class="fas fa-sign-out-alt me-1"></i> Logout
            </button>
        </div>
        
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <h2 class="mb-4">CRM Feeds</h2>
                
                <!-- Post creation - Only shown if user has "post" permission -->
                <div id="createPostForm" class="card card-body">
                    <div class="mb-3">
                        <textarea class="form-control" id="postContent" rows="3" placeholder="Share an update or announcement..."></textarea>
                    </div>
                    <div class="file-preview" id="filePreview"></div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <label for="fileInput" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-paperclip me-1"></i> Attach Files
                            </label>
                            <input type="file" id="fileInput" multiple style="display: none;" onchange="previewFiles(this)">
                        </div>
                        <button class="btn btn-primary" onclick="createPost()" id="postButton">
                            Post
                        </button>
                    </div>
                </div>
                
                <!-- Feed listing -->
                <div id="feedContainer">
                    <!-- Loading spinner -->
                    <div id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    
                    <!-- Empty state - shown when no posts -->
                    <div id="emptyState" class="empty-state" style="display: none;">
                        <i class="far fa-newspaper"></i>
                        <h4>No posts yet</h4>
                        <p>Be the first to share something with your team!</p>
                    </div>
                </div>
                
                <div class="d-flex justify-content-center mt-4" id="loadMoreContainer" style="display: none;">
                    <button class="btn btn-outline-primary" id="loadMoreButton">Load More Posts</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for image gallery -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Images</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-0">
                    <img id="modalImage" src="" class="img-fluid">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="prevImage()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="imageCounter">1 of 5</span>
                    <button type="button" class="btn btn-outline-secondary" onclick="nextImage()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comment edit modal -->
    <div class="modal fade" id="editCommentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="editCommentContent" rows="3"></textarea>
                    <input type="hidden" id="editCommentId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedComment()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Post edit modal -->
    <div class="modal fade" id="editPostModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="editPostContent" rows="5"></textarea>
                    <input type="hidden" id="editPostId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedPost()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete confirmation modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteConfirmMessage">Are you sure you want to delete this?</p>
                    <input type="hidden" id="deleteItemId">
                    <input type="hidden" id="deleteItemType">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Login modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Login to CRM</h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" id="loginError" style="display: none;"></div>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username or Email</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="login()">Login</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast notifications container -->
    <div class="toast-container"></div>
    
    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // API base URL
        const API_BASE_URL = '';
        
        // Current user info - will be populated from login
        const userId = localStorage.getItem('userId') || '';
        console.log('Retrieved userId from localStorage:', userId);
        
        let currentUser = {
            id: userId,
            name: localStorage.getItem('userName') || '',
            username: localStorage.getItem('userUsername') || '',
            permissions: JSON.parse(localStorage.getItem('userPermissions') || '{}')
        };
        
        // Debug user info
        console.log('Current user:', currentUser);
        
        // Pagination state
        let currentPage = 1;
        const PAGE_SIZE = 10;
        let totalPages = 1;
        let isLoading = false;
        
        // Gallery state
        let currentGallery = [];
        let currentImageIndex = 0;
        
        // Files for upload
        let filesToUpload = [];
        
        // Check if user is logged in
        function checkAuth() {
            if (!currentUser.id) {
                // Show login modal
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
                return false;
            }
            return true;
        }
        
        // Login user
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                document.getElementById('loginError').textContent = 'Please enter both username/email and password';
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username_or_email: username,
                        password: password
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Login failed');
                }
                
                const data = await response.json();
                
                // Store user data
                currentUser = {
                    id: data.user.id,
                    name: `${data.user.first_name} ${data.user.last_name}`,
                    username: data.user.username,
                    permissions: data.permissions.reduce((acc, perm) => {
                        if (!acc[perm.page]) acc[perm.page] = [];
                        acc[perm.page] = perm.actions;
                        return acc;
                    }, {})
                };
                
                // Save to localStorage
                localStorage.setItem('userId', currentUser.id);
                localStorage.setItem('userName', currentUser.name);
                localStorage.setItem('userUsername', currentUser.username);
                localStorage.setItem('userPermissions', JSON.stringify(currentUser.permissions));
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                
                // Update UI
                updateUserProfile();
                
                // Load posts
                initializeApp();
                
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginError').textContent = 'Invalid username or password';
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        // Logout user
        function logout() {
            // Clear user data
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            localStorage.removeItem('userUsername');
            localStorage.removeItem('userPermissions');
            
            // Reset current user
            currentUser = {
                id: '',
                name: '',
                username: '',
                permissions: {}
            };
            
            // Show login modal
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }
        
        // Update user profile in UI
        function updateUserProfile() {
            if (currentUser.id) {
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=random`;
                
                // Show/hide elements based on permissions
                if (!hasPermission('feeds', 'post')) {
                    document.getElementById('createPostForm').style.display = 'none';
                } else {
                    document.getElementById('createPostForm').style.display = 'block';
                }
            }
        }
        
        // Check if user has specific permission
        function hasPermission(page, permission) {
            const pagePermissions = currentUser.permissions[page];
            if (!pagePermissions) return false;
            
            // Wildcard permission check
            if (pagePermissions.includes('*')) return true;
            
            return pagePermissions.includes(permission);
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 1) {
                const hours = date.getHours();
                const minutes = date.getMinutes();
                return `Today at ${hours}:${minutes.toString().padStart(2, '0')}`;
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return weekdays[date.getDay()];
            } else {
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }
        }
        
        // Show a toast notification
        function showToast(message, type = 'success') {
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'}" 
                     role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                                data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            $('.toast-container').append(toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // Remove toast from DOM after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function () {
                $(this).remove();
            });
        }
        
        // Get file type icon class
        function getFileIconClass(fileType) {
            if (fileType === 'image') return 'fa-file-image';
            if (fileType === 'video') return 'fa-file-video';
            if (fileType === 'pdf') return 'fa-file-pdf';
            if (fileType === 'document') return 'fa-file-word';
            if (fileType === 'spreadsheet') return 'fa-file-excel';
            if (fileType === 'presentation') return 'fa-file-powerpoint';
            return 'fa-file';
        }
        
        // Get file size in human-readable format
        function formatFileSize(bytes) {
            if (!bytes) return "Unknown";
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        // Generate HTML for image gallery
        function generateImageGalleryHTML(images, postId) {
            if (!images || images.length === 0) return '';
            
            let galleryClass = 'image-gallery';
            if (images.length === 1) galleryClass += ' one-image';
            else if (images.length === 2) galleryClass += ' two-images';
            
            // Only show first 3 images in grid
            const displayImages = images.slice(0, Math.min(3, images.length));
            const hasMoreImages = images.length > 3;
            
            let html = `<div class="feed-media"><div class="${galleryClass}">`;
            
            displayImages.forEach((image, index) => {
                const showMoreOverlay = hasMoreImages && index === 2;
                
                html += `
                    <div class="gallery-item">
                        <img src="${image.file_path}" alt="${image.filename}" 
                             onclick="openImageGallery(${index}, '${postId}')">
                        ${showMoreOverlay ? 
                          `<div class="more-images" onclick="openImageGallery(${index}, '${postId}')">
                             +${images.length - 3} more
                           </div>` : ''}
                    </div>
                `;
            });
            
            html += '</div></div>';
            return html;
        }
        
        // Generate HTML for file attachments
        function generateFileAttachmentsHTML(files) {
            if (!files || files.filter(f => f.file_type !== 'image').length === 0) return '';
            
            const documentFiles = files.filter(f => f.file_type !== 'image');
            
            let html = '<div class="file-attachments">';
            
            documentFiles.forEach(file => {
                html += `
                    <div class="file-item">
                        <div class="file-icon">
                            <i class="far ${getFileIconClass(file.file_type)}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name"><strong>${file.filename}</strong></div>
                            <div class="file-size">${formatFileSize(file.size)} • ${file.file_type.toUpperCase()}</div>
                        </div>
                        <a href="${file.file_path}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        // Generate file attachments summary when there are many files
        function generateFilesSummaryHTML(files, postId) {
            if (!files || files.filter(f => f.file_type !== 'image').length <= 3) return '';
            
            const documentFiles = files.filter(f => f.file_type !== 'image');
            if (documentFiles.length <= 3) return '';
            
            return `
                <div class="file-attachments-summary" onclick="expandFiles(this, '${postId}')">
                    <div class="file-summary-icon">
                        <i class="fas fa-paperclip"></i>
                    </div>
                    <strong>${documentFiles.length} files attached</strong>
                    <i class="fas fa-chevron-down ms-auto"></i>
                </div>
            `;
        }
        
        // Generate HTML for comments
        function generateCommentsHTML(comments, postId) {
            if (!comments || comments.length === 0) {
                return `
                    <div class="comments-container">
                        <p class="text-muted text-center my-3">No comments yet</p>
                    </div>
                `;
            }
            
            console.log('Generating HTML for comments:', comments);
            let html = '<div class="comments-container">';
            
            comments.forEach(comment => {
                // Handle missing comment ID
                if (!comment.id && comment._id) {
                    console.warn('Comment has no id property but has _id - fixing');
                    comment.id = comment._id;
                }
                
                if (!comment.id) {
                    console.error('Comment is missing ID:', comment);
                }
                
                const canEdit = comment.can_edit || comment.created_by === currentUser.id;
                
                html += `
                    <div class="comment" data-id="${comment.id}">
                        <div class="d-flex">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(comment.user_name)}&background=random" 
                                 class="avatar" style="width: 32px; height: 32px;">
                            <div class="ms-2 flex-grow-1">
                                <div class="d-flex align-items-center">
                                    <h6 class="mb-0">${comment.user_name}</h6>
                                    <small class="text-muted ms-2">${formatDate(comment.created_at)}</small>
                                </div>
                                <p class="mb-0">${comment.content}</p>
                                ${canEdit ? `
                                <div class="comment-actions">
                                    <button class="btn btn-sm btn-link text-primary p-0" 
                                            onclick="openEditCommentModal('${comment.id}', '${comment.content.replace(/'/g, "\\'")}')">
                                        Edit
                                    </button>
                                    <button class="btn btn-sm btn-link text-danger p-0" 
                                            onclick="openDeleteConfirmModal('${comment.id}', 'comment')">
                                        Delete
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <div class="comment-form mt-3">
                    <div class="d-flex">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=random" 
                             class="avatar" style="width: 32px; height: 32px;">
                        <div class="flex-grow-1 ms-2">
                            <textarea class="form-control form-control-sm comment-input" 
                                      placeholder="Write a comment..."></textarea>
                            <div class="d-flex justify-content-end mt-2">
                                <button class="btn btn-primary btn-sm" 
                                        onclick="addComment('${postId}', this)">Comment</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // Generate HTML for a post
        function generatePostHTML(post) {
            console.log('Generating HTML for post:', post);
            
            // Handle missing post ID
            if (!post.id && post._id) {
                console.warn('Post has no id property but has _id - fixing');
                post.id = post._id;
            }
            
            // Error if still no ID
            if (!post.id) {
                console.error('Post has no ID! Cannot render properly:', post);
                return `<div class="alert alert-danger">Error: Post is missing its ID</div>`;
            }
            
            const canEdit = hasPermission('feeds', 'edit') || post.created_by === currentUser.id;
            const canDelete = hasPermission('feeds', 'delete') || post.created_by === currentUser.id;
            
            // Sort files: images first, then documents
            const imageFiles = post.files?.filter(f => f.file_type === 'image') || [];
            const documentFiles = post.files?.filter(f => f.file_type !== 'image') || [];
            const allFiles = [...imageFiles, ...documentFiles];
            
            // Store image URLs for gallery
            if (imageFiles.length > 0) {
                window.postGalleries = window.postGalleries || {};
                window.postGalleries[post.id] = imageFiles.map(img => img.file_path);
            }
            
            return `
                <div class="card feed-card" data-id="${post.id}">
                    <div class="feed-header">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(post.creator_name)}&background=random" class="avatar">
                        <div>
                            <h6 class="mb-0">${post.creator_name}</h6>
                            <small class="text-muted">${post.creator_username} • ${formatDate(post.created_at)}</small>
                        </div>
                        ${(canEdit || canDelete) ? `
                            <div class="dropdown ms-auto">
                                <button class="btn btn-sm text-muted" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    ${canEdit ? `<li><a class="dropdown-item" href="#" onclick="openEditPostModal('${post.id}', '${post.content.replace(/'/g, "\\'")}')"><i class="fas fa-edit me-2"></i> Edit</a></li>` : ''}
                                    ${canDelete ? `<li><a class="dropdown-item text-danger" href="#" onclick="openDeleteConfirmModal('${post.id}', 'post')"><i class="fas fa-trash me-2"></i> Delete</a></li>` : ''}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    <div class="card-body">
                        <p class="card-text post-content-${post.id}">${post.content}</p>
                        ${generateImageGalleryHTML(imageFiles, post.id)}
                        ${generateFileAttachmentsHTML(documentFiles.slice(0, 3))}
                        ${documentFiles.length > 3 ? generateFilesSummaryHTML(documentFiles, post.id) : ''}
                    </div>
                    <div class="feed-actions">
                        <div class="feed-action ${post.liked_by_user ? 'active' : ''}" onclick="toggleLikePost('${post.id}', this)">
                            <i class="${post.liked_by_user ? 'fas' : 'far'} fa-thumbs-up me-1"></i> 
                            ${post.liked_by_user ? 'Liked' : 'Like'} (${post.likes_count || 0})
                        </div>
                        <div class="feed-action" onclick="toggleComments('${post.id}', this)">
                            <i class="far fa-comment me-1"></i> Comment (${post.comments_count || 0})
                        </div>
                    </div>
                    <div class="comments-section p-3 bg-light" id="comments-${post.id}" style="display: none;">
                        <div id="comments-container-${post.id}">
                            <div class="text-center p-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading comments...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Load posts from API
        async function loadPosts(page = 1) {
            if (isLoading || !currentUser.id) return;
            
            isLoading = true;
            
            if (page === 1) {
                $('#feedContainer').html(`
                    <div id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `);
                $('#loadMoreContainer').hide();
            } else {
                $('#loadMoreButton').prop('disabled', true).html(`
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Loading...
                `);
            }
            
            try {
                // Make sure user_id is properly set
                const userId = currentUser.id;
                if (!userId) {
                    console.error('User ID is missing! Cannot fetch posts without user_id');
                    showAlert('User ID is missing! Please log in again.', 'danger');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }
                
                const params = new URLSearchParams({
                    page: page,
                    page_size: PAGE_SIZE,
                    user_id: userId
                });
                
                console.log(`Loading posts with user_id: ${userId}`);
                console.log(`API call: ${API_BASE_URL}/feeds?${params}`);
                
                const response = await fetch(`${API_BASE_URL}/feeds?${params}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    try {
                        const errorData = await response.json();
                        console.error('Error details:', errorData);
                        
                        // Check for permission error
                        if (errorData.detail === "You don't have permission to view feeds") {
                            showAlert('Permission error: You don\'t have permission to view feeds. Adding permission automatically.', 'warning');
                            
                            // Add feeds permission
                            let permissions = JSON.parse(localStorage.getItem('userPermissions') || '{}');
                            if (!permissions.feeds) {
                                permissions.feeds = ["show", "post", "comment", "like", "edit", "delete"];
                                localStorage.setItem('userPermissions', JSON.stringify(permissions));
                                currentUser.permissions = permissions;
                                console.log('Updated permissions:', permissions);
                                
                                // Reload the page after adding permissions
                                setTimeout(() => {
                                    window.location.reload();
                                }, 2000);
                                return;
                            }
                        }
                        
                        throw new Error(errorData.detail || `Error: ${response.status}`);
                    } catch (e) {
                        const errorText = await response.text();
                        console.error(`Error parsing response: ${errorText}`);
                        throw new Error(`Error: ${response.status}`);
                    }
                }
                
                const data = await response.json();
                console.log('Posts loaded:', data);
                
                // Initialize post galleries
                window.postGalleries = window.postGalleries || {};
                
                // Update pagination info
                totalPages = data.pages;
                currentPage = data.page;
                
                if (page === 1) {
                    $('#feedContainer').empty();
                }
                
                // Display posts
                if (data.items.length === 0 && page === 1) {
                    $('#emptyState').show();
                } else {
                    $('#emptyState').hide();
                    
                    data.items.forEach(post => {
                        console.log('Processing post:', post);
                        console.log('Post ID (_id):', post._id);
                        console.log('Post ID (id):', post.id);
                        
                        if (!post.id && post._id) {
                            console.warn('Post ID missing, using _id instead');
                            post.id = post._id;
                        }
                        
                        if (!post.id) {
                            console.error('Post has no ID!', post);
                        }
                        
                        $('#feedContainer').append(generatePostHTML(post));
                    });
                }
                
                // Show/hide load more button
                if (currentPage < totalPages) {
                    $('#loadMoreContainer').show();
                    $('#loadMoreButton').prop('disabled', false).html('Load More Posts');
                } else {
                    $('#loadMoreContainer').hide();
                }
                
            } catch (error) {
                console.error('Error loading posts:', error);
                showToast('Failed to load posts. Please try again.', 'error');
                
                if (page === 1) {
                    $('#feedContainer').html(`
                        <div class="alert alert-danger">
                            Failed to load posts. Please refresh the page to try again.
                        </div>
                    `);
                }
            } finally {
                isLoading = false;
                $('#loadingSpinner').hide();
            }
        }
        
        // Create a new post
        async function createPost() {
            if (!checkAuth()) return;
            
            const content = $('#postContent').val().trim();
            
            if (!content) {
                showToast('Please write something to post.', 'error');
                return;
            }
            
            // Disable button and show loading state
            const postButton = $('#postButton');
            const originalBtnText = postButton.html();
            postButton.prop('disabled', true).html(`
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Posting...
            `);
            
            try {
                const formData = new FormData();
                formData.append('content', content);
                formData.append('user_id', currentUser.id);
                
                // Append files if any
                filesToUpload.forEach(file => {
                    formData.append('files', file);
                });
                
                console.log('Creating post:', content);
                console.log('With files:', filesToUpload.map(f => f.name));
                
                const response = await fetch(`${API_BASE_URL}/feeds`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    const errorData = await response.text();
                    console.error(`Error details: ${errorData}`);
                    throw new Error(errorData || 'Failed to create post');
                }
                
                const result = await response.json();
                console.log('Post created:', result);
                
                // Clear form
                $('#postContent').val('');
                $('#filePreview').empty();
                filesToUpload = [];
                
                // Show success message
                showToast('Post created successfully!');
                
                // Reload posts
                loadPosts(1);
                
            } catch (error) {
                console.error('Error creating post:', error);
                showToast(error.message || 'Failed to create post. Please try again.', 'error');
            } finally {
                // Restore button
                postButton.prop('disabled', false).html(originalBtnText);
            }
        }
        
        // Toggle like on a post
        async function toggleLikePost(postId, element) {
            if (!checkAuth()) return;
            
            try {
                const isLiked = $(element).hasClass('active');
                const endpoint = isLiked ? 
                    `${API_BASE_URL}/feeds/${postId}/unlike` :
                    `${API_BASE_URL}/feeds/${postId}/like`;
                
                console.log(`${isLiked ? 'Unliking' : 'Liking'} post: ${postId}`);
                
                // Append user_id as a query parameter
                const urlWithParams = `${endpoint}?user_id=${encodeURIComponent(currentUser.id)}`;
                
                const response = await fetch(urlWithParams, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    try {
                        const errorData = await response.json();
                        console.error('Error details:', errorData);
                        
                        // Check if the error is about user_id being required
                        if (errorData.detail && 
                            Array.isArray(errorData.detail) && 
                            errorData.detail.some(err => err.loc && err.loc.includes("user_id") && err.type === "value_error.missing")) {
                            console.error('user_id missing error detected, retrying with query param');
                            
                            // Try again with a different method
                            const retryResponse = await fetch(`${endpoint}?user_id=${encodeURIComponent(currentUser.id)}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (retryResponse.ok) {
                                console.log('Retry successful');
                                const retryResult = await retryResponse.json();
                                console.log('Like/unlike result:', retryResult);
                                
                                // Update UI
                                $(element).toggleClass('active');
                                const icon = $(element).find('i');
                                
                                if ($(element).hasClass('active')) {
                                    icon.removeClass('far').addClass('fas');
                                    const likeText = $(element).text().replace('Like', 'Liked');
                                    $(element).html(`<i class="fas fa-thumbs-up me-1"></i> ${likeText}`);
                                } else {
                                    icon.removeClass('fas').addClass('far');
                                    const likeText = $(element).text().replace('Liked', 'Like');
                                    $(element).html(`<i class="far fa-thumbs-up me-1"></i> ${likeText}`);
                                }
                                
                                return;
                            }
                        }
                        
                        throw new Error(errorData.detail || 'Failed to update like status');
                    } catch (e) {
                        console.error('Error parsing response:', e);
                        const errorText = await response.text();
                        console.error(`Error response text: ${errorText}`);
                        throw new Error('Failed to update like status');
                    }
                }
                
                const result = await response.json();
                console.log('Like/unlike result:', result);
                
                // Update UI
                $(element).toggleClass('active');
                const icon = $(element).find('i');
                
                if ($(element).hasClass('active')) {
                    icon.removeClass('far').addClass('fas');
                    const likeText = $(element).text().replace('Like', 'Liked');
                    $(element).html(`<i class="fas fa-thumbs-up me-1"></i> ${likeText}`);
                } else {
                    icon.removeClass('fas').addClass('far');
                    const likeText = $(element).text().replace('Liked', 'Like');
                    $(element).html(`<i class="far fa-thumbs-up me-1"></i> ${likeText}`);
                }
                
            } catch (error) {
                console.error('Error toggling like:', error);
                showToast('Failed to update like. Please try again.', 'error');
            }
        }
        
        // Load comments for a post
        async function loadComments(postId) {
            if (!checkAuth()) return;
            
            try {
                console.log(`Loading comments for post ID: ${postId}`);
                
                // Handle missing or malformed post ID
                if (!postId) {
                    console.error('Post ID is missing, cannot load comments');
                    throw new Error('Invalid post ID');
                }
                
                // Make sure we're using the correct ID (could be _id or id)
                let postIdToUse = postId;
                const post = $(`[data-id="${postId}"]`);
                if (!post.length) {
                    console.warn(`Could not find post with ID ${postId} in DOM, checking alternative data-attributes`);
                    const postAlt = $(`[data-_id="${postId}"]`);
                    if (postAlt.length) {
                        postIdToUse = postAlt.attr('data-_id');
                        console.log(`Found post with _id=${postIdToUse}`);
                    }
                }
                
                if (!currentUser.id) {
                    console.error('User ID is missing, cannot load comments');
                    throw new Error('User authentication issue');
                }
                
                const commentApiUrl = `${API_BASE_URL}/feeds/${postIdToUse}/comments?user_id=${encodeURIComponent(currentUser.id)}`;
                console.log(`API call: ${commentApiUrl}`);
                
                const response = await fetch(commentApiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    const errorData = await response.text();
                    console.error(`Error details: ${errorData}`);
                    throw new Error('Failed to load comments');
                }
                
                const comments = await response.json();
                console.log('Comments loaded:', comments);
                
                // Update UI
                $(`#comments-container-${postId}`).html(generateCommentsHTML(comments, postId));
                
            } catch (error) {
                console.error('Error loading comments:', error);
                $(`#comments-container-${postId}`).html(`
                    <div class="alert alert-danger">
                        Failed to load comments. Please try again.
                    </div>
                `);
            }
        }
        
        // Toggle comments section
        function toggleComments(postId, element) {
            if (!checkAuth()) return;
            
            const commentsSection = $(`#comments-${postId}`);
            
            if (commentsSection.is(':visible')) {
                commentsSection.hide();
            } else {
                commentsSection.show();
                loadComments(postId);
            }
        }
        
        // Add a comment to a post
        async function addComment(postId, button) {
            if (!checkAuth()) return;
            
            const commentTextarea = $(button).closest('.comment-form').find('.comment-input');
            const content = commentTextarea.val().trim();
            
            if (!content) {
                showToast('Please write a comment before submitting.', 'error');
                return;
            }
            
            if (!postId) {
                console.error('Post ID is missing, cannot add comment');
                showToast('Error: Invalid post ID', 'error');
                return;
            }
            
            if (!currentUser.id) {
                console.error('User ID is missing, cannot add comment');
                showToast('Authentication issue: Please log in again', 'error');
                setTimeout(() => window.location.href = '/', 2000);
                return;
            }
            
            // Disable button and show loading state
            const originalBtnText = $(button).html();
            $(button).prop('disabled', true).html(`
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Sending...
            `);
            
            try {
                console.log(`Adding comment to post ID: ${postId}, content: ${content}`);
                
                // Make sure we have a valid post ID and user ID
                if (!postId) {
                    console.error('Post ID is undefined');
                    throw new Error('Invalid post ID');
                }
                
                if (!currentUser.id) {
                    console.error('User ID is undefined');
                    throw new Error('User authentication issue');
                }
                
                // Construct the API URL with the query parameter for user_id
                const commentApiUrl = `${API_BASE_URL}/feeds/${postId}/comments?user_id=${encodeURIComponent(currentUser.id)}`;
                console.log(`API call: ${commentApiUrl}`);
                
                const response = await fetch(commentApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        feed_id: postId,
                        content: content,
                        created_by: currentUser.id
                    })
                });
                
                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    try {
                        const errorData = await response.json();
                        console.error('Error details:', errorData);
                        
                        // Check if the error is about user_id being required
                        if (errorData.detail && 
                            Array.isArray(errorData.detail) && 
                            errorData.detail.some(err => err.loc && err.loc.includes("user_id") && err.type === "value_error.missing")) {
                            console.error('user_id missing error detected, retrying with query param');
                            
                            // Try again with a different method
                            const retryUrl = `${API_BASE_URL}/feeds/${postId}/comments?user_id=${encodeURIComponent(currentUser.id)}`;
                            console.log(`Retrying with: ${retryUrl}`);
                            
                            const retryResponse = await fetch(retryUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json'
                                },
                                body: JSON.stringify({
                                    feed_id: postId,
                                    content: content,
                                    created_by: currentUser.id
                                })
                            });
                            
                            if (retryResponse.ok) {
                                console.log('Retry successful');
                                const retryResult = await retryResponse.json();
                                console.log('Comment added:', retryResult);
                                
                                // Clear textarea
                                commentTextarea.val('');
                                
                                // Reload comments
                                await loadComments(postId);
                                
                                return;
                            }
                        }
                        
                        throw new Error(errorData.detail || 'Failed to add comment');
                    } catch (e) {
                        console.error('Error parsing response:', e);
                        const errorText = await response.text();
                        console.error(`Error response text: ${errorText}`);
                        throw new Error('Failed to add comment');
                    }
                }
                
                const result = await response.json();
                console.log('Comment added:', result);
                
                // Clear textarea
                commentTextarea.val('');
                
                // Reload comments
                loadComments(postId);
                
                // Update comment count
                const commentText = $(button).closest('.feed-card').find('.feed-action:contains("Comment")');
                const currentCount = parseInt(commentText.text().match(/\d+/)[0]);
                const newText = commentText.text().replace(`(${currentCount})`, `(${currentCount + 1})`);
                commentText.html(`<i class="far fa-comment me-1"></i> ${newText}`);
                
            } catch (error) {
                console.error('Error adding comment:', error);
                showToast('Failed to add comment. Please try again.', 'error');
            } finally {
                // Restore button
                $(button).prop('disabled', false).html(originalBtnText);
            }
        }
        
        // Open modal to edit comment
        function openEditCommentModal(commentId, content) {
            if (!checkAuth()) return;
            
            $('#editCommentId').val(commentId);
            $('#editCommentContent').val(content);
            new bootstrap.Modal(document.getElementById('editCommentModal')).show();
        }
        
        // Open modal to edit post
        function openEditPostModal(postId, content) {
            if (!checkAuth()) return;
            
            $('#editPostId').val(postId);
            $('#editPostContent').val(content);
            new bootstrap.Modal(document.getElementById('editPostModal')).show();
        }
        
        // Save edited comment
        async function saveEditedComment() {
            if (!checkAuth()) return;
            
            const commentId = $('#editCommentId').val();
            const content = $('#editCommentContent').val().trim();
            
            if (!content) {
                showToast('Comment cannot be empty.', 'error');
                return;
            }
            
            try {
                console.log(`Updating comment: ${commentId}, content: ${content}`);
                
                const response = await fetch(`${API_BASE_URL}/feeds/comments/${commentId}?user_id=${currentUser.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content
                    })
                });
                
                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    const errorData = await response.text();
                    console.error(`Error details: ${errorData}`);
                    throw new Error('Failed to update comment');
                }
                
                const result = await response.json();
                console.log('Comment updated:', result);
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editCommentModal')).hide();
                
                // Update comment text in UI
                $(`.comment[data-id="${commentId}"] p`).text(content);
                
                showToast('Comment updated successfully!');
                
            } catch (error) {
                console.error('Error updating comment:', error);
                showToast('Failed to update comment. Please try again.', 'error');
            }
        }
        
        // Save edited post
        async function saveEditedPost() {
            if (!checkAuth()) return;
            
            const postId = $('#editPostId').val();
            const content = $('#editPostContent').val().trim();
            
            if (!content) {
                showToast('Post content cannot be empty.', 'error');
                return;
            }
            
            try {
                console.log(`Updating post: ${postId}, content: ${content}`);
                
                const response = await fetch(`${API_BASE_URL}/feeds/${postId}?user_id=${currentUser.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content
                    })
                });
                
                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    const errorData = await response.text();
                    console.error(`Error details: ${errorData}`);
                    throw new Error('Failed to update post');
                }
                
                const result = await response.json();
                console.log('Post updated:', result);
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editPostModal')).hide();
                
                // Update post text in UI
                $(`.post-content-${postId}`).text(content);
                
                showToast('Post updated successfully!');
                
            } catch (error) {
                console.error('Error updating post:', error);
                showToast('Failed to update post. Please try again.', 'error');
            }
        }
        
        // Open confirm delete modal
        function openDeleteConfirmModal(itemId, itemType) {
            if (!checkAuth()) return;
            
            $('#deleteItemId').val(itemId);
            $('#deleteItemType').val(itemType);
            
            const message = itemType === 'post' 
                ? 'Are you sure you want to delete this post? This will also delete all comments and likes.'
                : 'Are you sure you want to delete this comment?';
                
            $('#deleteConfirmMessage').text(message);
            
            new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
        }
        
        // Confirm delete action
        async function confirmDelete() {
            if (!checkAuth()) return;
            
            const itemId = $('#deleteItemId').val();
            const itemType = $('#deleteItemType').val();
            
            if (!itemId) {
                console.error('Item ID is missing, cannot delete');
                showAlert('Error: Item ID is missing', 'danger');
                return;
            }
            
            try {
                let endpoint;
                
                // Make sure we have valid IDs
                if (!currentUser.id) {
                    throw new Error('User ID is missing, please log in again');
                }
                
                console.log(`Attempting to delete ${itemType} with ID: ${itemId}`);
                
                if (itemType === 'post') {
                    endpoint = `${API_BASE_URL}/feeds/${itemId}?user_id=${encodeURIComponent(currentUser.id)}`;
                } else if (itemType === 'comment') {
                    endpoint = `${API_BASE_URL}/feeds/comments/${itemId}?user_id=${encodeURIComponent(currentUser.id)}`;
                } else {
                    throw new Error('Invalid item type');
                }
                
                console.log(`Delete endpoint: ${endpoint}`);
                
                const response = await fetch(endpoint, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error(`Error response: ${response.status} ${response.statusText}`);
                    try {
                        // Try to parse as JSON first
                        const errorData = await response.json();
                        console.error(`Error details:`, errorData);
                        throw new Error(errorData.detail || `Failed to delete ${itemType}`);
                    } catch (jsonError) {
                        // If not JSON, get as text
                        const errorText = await response.text();
                        console.error(`Error details: ${errorText}`);
                        throw new Error(`Failed to delete ${itemType}`);
                    }
                }
                
                // Parse response safely
                let result;
                try {
                    const text = await response.text();
                    console.log(`Raw response:`, text);
                    result = text ? JSON.parse(text) : {};
                } catch (e) {
                    console.warn('Could not parse response as JSON, continuing anyway');
                    result = { message: `${itemType} deleted successfully` };
                }
                
                console.log(`${itemType} deleted:`, result);
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                
                // Update UI
                if (itemType === 'post') {
                    $(`.feed-card[data-id="${itemId}"]`).fadeOut(() => {
                        $(`.feed-card[data-id="${itemId}"]`).remove();
                        
                        // Show empty state if no posts left
                        if ($('.feed-card').length === 0) {
                            $('#emptyState').show();
                        }
                    });
                    
                    showToast('Post deleted successfully!');
                } else if (itemType === 'comment') {
                    $(`.comment[data-id="${itemId}"]`).fadeOut(() => {
                        const commentCard = $(`.comment[data-id="${itemId}"]`);
                        const postId = commentCard.closest('.comments-section').attr('id').replace('comments-', '');
                        
                        // Update comment count
                        const commentText = $(`.feed-card[data-id="${postId}"] .feed-action:contains("Comment")`);
                        const currentCount = parseInt(commentText.text().match(/\d+/)[0]);
                        const newText = commentText.text().replace(`(${currentCount})`, `(${currentCount - 1})`);
                        commentText.html(`<i class="far fa-comment me-1"></i> ${newText}`);
                        
                        commentCard.remove();
                    });
                    
                    showToast('Comment deleted successfully!');
                }
                
            } catch (error) {
                console.error('Error deleting item:', error);
                showToast('Failed to delete. Please try again.', 'error');
            }
        }
        
        // Open image gallery modal
        function openImageGallery(index, postId) {
            currentGallery = window.postGalleries[postId];
            currentImageIndex = index;
            
            // Set the image
            document.getElementById('modalImage').src = currentGallery[currentImageIndex];
            
            // Update counter
            updateImageCounter();
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }
        
        // Update image counter in modal
        function updateImageCounter() {
            document.getElementById('imageCounter').textContent = `${currentImageIndex + 1} of ${currentGallery.length}`;
        }
        
        // Navigate to next image
        function nextImage() {
            currentImageIndex = (currentImageIndex + 1) % currentGallery.length;
            document.getElementById('modalImage').src = currentGallery[currentImageIndex];
            updateImageCounter();
        }
        
        // Navigate to previous image
        function prevImage() {
            currentImageIndex = (currentImageIndex - 1 + currentGallery.length) % currentGallery.length;
            document.getElementById('modalImage').src = currentGallery[currentImageIndex];
            updateImageCounter();
        }
        
        // Toggle file attachments visibility
        function expandFiles(element, postId) {
            const postCard = $(element).closest('.card-body');
            const filesList = postCard.find('.file-attachments');
            const chevron = $(element).find('.fa-chevron-down, .fa-chevron-up');
            
            if (filesList.is(':visible')) {
                filesList.hide();
                chevron.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
                filesList.show();
                chevron.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        }
        
        // File preview for post creation
        function previewFiles(input) {
            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';
            
            if (input.files) {
                // Store files for upload
                filesToUpload = Array.from(input.files);
                
                filesToUpload.forEach(file => {
                    const reader = new FileReader();
                    const item = document.createElement('div');
                    item.className = 'file-preview-item';
                    const fileName = file.name;
                    
                    reader.onload = function(e) {
                        if (file.type.startsWith('image/')) {
                            item.innerHTML = `
                                <img src="${e.target.result}" alt="${fileName}">
                                <div class="file-name">${fileName}</div>
                                <div class="file-remove" onclick="removeFile(this, '${fileName}')">×</div>
                            `;
                        } else {
                            let iconClass = 'fa-file';
                            if (file.type.includes('pdf')) iconClass = 'fa-file-pdf';
                            else if (file.type.includes('word')) iconClass = 'fa-file-word';
                            else if (file.type.includes('excel')) iconClass = 'fa-file-excel';
                            else if (file.type.includes('powerpoint')) iconClass = 'fa-file-powerpoint';
                            
                            item.innerHTML = `
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <i class="far ${iconClass}" style="font-size: 40px; color: #6c757d;"></i>
                                </div>
                                <div class="file-name">${fileName}</div>
                                <div class="file-remove" onclick="removeFile(this, '${fileName}')">×</div>
                            `;
                        }
                    }
                    
                    reader.readAsDataURL(file);
                    preview.appendChild(item);
                });
            }
        }
        
        // Remove file from preview and upload list
        function removeFile(element, fileName) {
            // Remove from UI
            element.parentElement.remove();
            
            // Remove from files array
            filesToUpload = filesToUpload.filter(file => file.name !== fileName);
        }
        
        // Keyboard navigation for image gallery
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('imageModal');
            if (modal && modal.classList.contains('show')) {
                if (event.key === 'ArrowLeft') {
                    prevImage();
                } else if (event.key === 'ArrowRight') {
                    nextImage();
                }
            }
        });
        
        // Initialize app
        function initializeApp() {
            // Update user profile
            updateUserProfile();
            
            // Load initial posts
            loadPosts(1);
            
            // Set up load more button
            const loadMoreButton = document.getElementById('loadMoreButton');
            if (loadMoreButton) {
                loadMoreButton.addEventListener('click', function() {
                    loadPosts(currentPage + 1);
                });
            }
        }
        
        // Check if user is logged in on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Feeds module initializing...');
            
            if (currentUser.id) {
                initializeApp();
            } else {
                // Show login modal
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
            }
            
            // Add event listener for Enter key in login form
            document.getElementById('loginForm').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    login();
                }
            });
        });
    </script>
</body>
</html>