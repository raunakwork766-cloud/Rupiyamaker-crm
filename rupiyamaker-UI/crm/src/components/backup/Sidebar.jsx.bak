"use client";

import React, { useState, useEffect } from 'react';
import { Layout, Menu } from 'antd';
import {
  UserOutlined,
  MessageOutlined,
  HomeOutlined,
  TeamOutlined
} from '@ant-design/icons';
import {
  CreditCard,
  BarChart3,
  Monitor,
  Building2,
  Ticket,
  Briefcase,
  TrendingUp,
  AlertTriangle,
  PieChart,
  Calculator,
  Settings,
  Target,
  List,
  RefreshCw,
  Key,
  ListTodo,
  CalendarX,
  CheckCircle,
  LogIn,
  ChevronUp,
  ChevronDown,
  Activity,
  Users,
  UserPlus
} from "lucide-react";
import { useNavigate, useLocation, useRoutes } from 'react-router-dom';
import { cn } from "../lib/utils.js";
import { hasPermission, getUserPermissions, canViewLoginCRM } from '../utils/permissions';
import { filterNavItems, getNavigationItems } from '../utils/navigation';

const { Sider } = Layout;
const { SubMenu } = Menu;

const iconMap = {
  'lead-crm': <UserOutlined />,
  'feed': <MessageOutlined />,
  'home-loan-updates': <HomeOutlined />,
  'hrms': <TeamOutlined />
};

// Create a version of the sidebar that doesn't use router hooks
function SidebarWithoutRouter({ selectedLabel, setSelectedLabel }) {
  const [collapsed, setCollapsed] = useState(false);
  const [menuItems, setMenuItems] = useState([]);

  // Use a dummy navigate function and location object
  const navigate = () => { };
  const location = { pathname: '/' };
  const [isLEADCRMOpen, setLEADCRMOpen] = useState(false);
  const [isLoginCRMOpen, setLoginCRMOpen] = useState(false);
  const [isWarningOpen, setWarningOpen] = useState(false);
  const [isHRMSOpen, setHRMSOpen] = useState(false);
  const [isPinnedOpen, setIsPinnedOpen] = useState(true);
  const [isHovered, setIsHovered] = useState(false);
  const [loanTypes, setLoanTypes] = useState([]);
  const [selectedLoanType, setSelectedLoanType] = useState('all');
  const [userPermissions, setUserPermissions] = useState({});
  const [permissionsLoaded, setPermissionsLoaded] = useState(false);
  const isOpen = isPinnedOpen || isHovered;

  // Load permissions on component mount
  useEffect(() => {
    try {
      const permissions = getUserPermissions();
      console.log("Sidebar loaded permissions:", permissions);
      setUserPermissions(permissions || {});
      setPermissionsLoaded(true);
    } catch (error) {
      console.error("Error loading permissions in sidebar:", error);
      // Set default minimal permissions for critical navigation
      setUserPermissions({
        feeds: { view: true }
      });
      setPermissionsLoaded(true);
    }
  }, []);

  // Fetch loan types when the component mounts
  useEffect(() => {
    loadLoanTypes();
  }, []);

  // Safe wrapper for permission checks
  const checkPermission = (page, action) => {
    try {
      return hasPermission(userPermissions, page, action);
    } catch (error) {
      console.error(`Permission check error for ${page}:${action}:`, error);
      // Default to showing critical items if permission check fails
      return page === 'feeds' && action === 'view';
    }
  };

  const loadLoanTypes = async () => {
    try {
      const userId = localStorage.getItem('userId') || '';
      const response = await fetch(`http://localhost:8048/loan-types?user_id=${userId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      if (!response.ok) {
        throw new Error('Failed to fetch loan types');
      }

      const data = await response.json();
      const loanTypesData = data.items || data.loan_types || data || [];

      // Filter out any duplicates and format as needed
      setLoanTypes([
        { _id: 'all', name: 'All Leads', description: 'Show all leads' },
        ...loanTypesData
      ]);

    } catch (error) {
      console.error('Error loading loan types:', error);
      // Set default loan types if fetch fails
      setLoanTypes([
        { _id: 'all', name: 'All Leads', description: 'Show all leads' },
        { _id: 'personal', name: 'Personal Loan', description: 'Personal loans' },
        { _id: 'home', name: 'Home Loan', description: 'Home loans' },
      ]);
    }
  };

  // Handle loan type selection and navigate to Lead CRM with selected loan type
  const handleLoanTypeSelection = (loanTypeId, loanTypeName) => {
    setSelectedLoanType(loanTypeId);
    // Update the localStorage with selected loan type for LeadCRM to use
    localStorage.setItem('selectedLoanType', loanTypeId);
    localStorage.setItem('selectedLoanTypeName', loanTypeName);
    // Set the selected label to Lead CRM
    setSelectedLabel('Lead CRM');
    // Dispatch a storage event to notify LeadCRM component about the change
    window.dispatchEvent(new Event('storage'));
  };

  // Show loading while permissions are being fetched
  if (!permissionsLoaded) {
    return (
      <div className="h-screen w-20 bg-black flex items-center justify-center">
        <div className="text-[#03B0F5] text-sm">Loading...</div>
      </div>
    );
  }

  const getSelectedKeys = () => {
    const path = location.pathname;
    const parts = path.split('/').filter(Boolean);

    if (parts.length === 0) {
      return ['lead-crm']; // Default route
    }

    if (parts.length >= 2) {
      // For nested routes like /hrms/employees
      return [parts[1]]; // Return the second part as the selected key
    }

    return [parts[0]]; // First level route
  };

  const getOpenKeys = () => {
    const path = location.pathname;
    const parts = path.split('/').filter(Boolean);

    if (parts.length >= 2) {
      // If we're in a nested route, open the parent menu
      return [parts[0]];
    }

    return [];
  };

  const handleMenuClick = (e) => {
    const clickedItem = findItemByKey(menuItems, e.key);
    if (clickedItem && clickedItem.path) {
      navigate(clickedItem.path);
    }
  };

  const findItemByKey = (items, key) => {
    for (const item of items) {
      if (item.key === key) {
        return item;
      }
      if (item.children) {
        const found = findItemByKey(item.children, key);
        if (found) return found;
      }
    }
    return null;
  };

  const renderMenuItems = (items) => {
    return items.map(item => {
      if (item.children) {
        return (
          <SubMenu
            key={item.key}
            icon={iconMap[item.key] || null}
            title={item.label}
          >
            {renderMenuItems(item.children)}
          </SubMenu>
        );
      }
      return (
        <Menu.Item key={item.key} icon={iconMap[item.key] || null}>
          {item.label}
        </Menu.Item>
      );
    });
  };

  return (
    <div
      className={cn(
        "h-screen relative shadow-6xl bg-gradient-to-br from-white/1 to-yellow-100/1 transition-all duration-300 z-10",
        isOpen ? "w-64" : "w-20"
      )}
      onMouseEnter={() => {
        // Only set hovered to true if the sidebar is not pinned open
        if (!isPinnedOpen) {
          setIsHovered(true);
        }
      }}
      onMouseLeave={() => setIsHovered(false)}
    >
     <div className="flex items-center flex-shrink-0 h-16 p-4">
          <button
            onClick={() => setIsPinnedOpen(!isPinnedOpen)}
            className="p-2 rounded-lg shadow-md hover:bg-gradient-to-r from-purple-400 to-pink-400"
          >
            ☰
          </button>
          {isOpen && (
            <div className="flex items-center ml-3 text-[16px] font-extrabold text-[#03B0F5]">
              CRM
              <span className="ml-1 rounded-full p-0.5 flex items-center justify-center">
                <span className="text-xs">©</span>
              </span>
            </div>
          )}
        </div>
      <Menu
        theme="dark"
        mode="inline"
        selectedKeys={getSelectedKeys()}
        defaultOpenKeys={getOpenKeys()}
        onClick={handleMenuClick}
      >
        {/* FEED - Always show Feed for basic navigation */}
        <MenuItem
          icon={<img src="/Images/image.png" className="h-6 w-6 " />}
          label="Feed"
          {...{ isOpen, selectedLabel, setSelectedLabel }}
        />

        {/* LEAD CRM - Only show if user has leads:view or leads:view_junior permission */}
        {(checkPermission('leads', 'view') || checkPermission('leads', 'view_junior')) && (
          <div className="w-full">
            <button
              onClick={() => {
                if (isOpen) setLEADCRMOpen(!isLEADCRMOpen);
              }}
              className={cn(
                "flex items-center w-full p-3 mb-1 rounded-lg hover:bg-white transition-all font-extrabold text-[15px] text-[#03B0F5] shadow animate-pop",
                (selectedLabel === "Lead CRM" || selectedLabel === "CRM Dashboard" || selectedLabel === "Create LEAD") && "bg-[#FFFF00] border border-[#03B0F5]"
              )}
            >
              <img src="/Images/filter.png" className="h-6 w-6" />
              {isOpen && (
                <>
                  <span className="flex-1 ml-3 text-left">LEAD CRM</span>
                  {isLEADCRMOpen ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                </>
              )}
            </button>

            {isLEADCRMOpen && isOpen && (
              <ul className="pl-6 pr-2 mt-1 space-y-1 backdrop-blur-md bg-white/10 rounded-lg">
                {/* Main LEAD CRM Menu Items */}
                <li>
                  <SidebarSubItem icon={<BarChart3 className="h-6 w-6" />} label="CRM Dashboard" {...{ selectedLabel, setSelectedLabel, isOpen }} />
                </li>
                <li>
                  <SidebarSubItem icon={<Users className="h-6 w-6" />} label="Lead CRM" {...{ selectedLabel, setSelectedLabel, isOpen }} />
                </li>
                {/* Only show Create LEAD if user has leads:create permission */}
                {checkPermission('leads', 'edit') && (
                  <li>
                    <SidebarSubItem icon={<UserPlus className="h-6 w-6" />} label="Create LEAD" {...{ selectedLabel, setSelectedLabel, isOpen }} />
                  </li>
                )}
                {/* Loan Types Section */}
                <li className="mt-2 pt-2 border-t border-gray-700">
                  <div className="px-2 py-1 text-xs text-gray-400">LOAN TYPES</div>
                </li>
                {/* Display all loan types */}
                {loanTypes.map((loanType) => (
                  <li key={loanType._id}>
                    <button
                      className={cn(
                        "flex w-full p-2 text-left mb-1 rounded-md hover:bg-white text-[14px] transition-all font-semibold text-[#03B0F5] animate-pop ml-2",
                        selectedLoanType === loanType._id && selectedLabel === "Lead CRM" && "bg-[#FFFF00] border border-[#03B0F5]"
                      )}
                      onClick={() => handleLoanTypeSelection(loanType._id, loanType.name)}
                    >
                      <CreditCard className="h-5 w-5" />
                      {isOpen && <span className="ml-2">{loanType.name}</span>}
                    </button>
                  </li>
                ))}
              </ul>
            )}
          </div>
        )}

        {/* LOGIN CRM - Only show if user has users:view permission */}
        {checkPermission('users', 'view') && (
          <Dropdown
            label="Login CRM"
            icon={<LogIn className="h-6 w-6" />}
            isOpen={isOpen}
            isExpanded={isLoginCRMOpen}
            toggle={() => setLoginCRMOpen(!isLoginCRMOpen)}
            items={[
              { icon: <Monitor className="h-6 w-6" />, label: "Dashboard" },
              { icon: <LogIn className="h-6 w-6" />, label: "Login CRM" },
              { icon: <Key className="h-6 w-6" />, label: "PL & ODD LOGIN" },
              { icon: <Building2 className="h-6 w-6" />, label: "Home Loan LOGIN" },
            ]}
            {...{ selectedLabel, setSelectedLabel }}
          />
        )}

        {/* TASK - Only show if user has feeds:view or tasks:view permission */}
        {(checkPermission('feeds', 'view') || checkPermission('tasks', 'view')) && (
          <MenuItem icon={<ListTodo className="h-6 w-6" />} label="Task" {...{ isOpen, selectedLabel, setSelectedLabel }} />
        )}

        {/* TICKET - Only show if user has feeds:view or tickets:view permission */}
        {(checkPermission('feeds', 'view') || checkPermission('tickets', 'view')) && (
          <MenuItem icon={<Ticket className="h-6 w-6" />} label="Ticket" {...{ isOpen, selectedLabel, setSelectedLabel }} />
        )}

        {/* HRMS - Only show if user has users:view permission */}
        {checkPermission('users', 'view') && (
          <Dropdown
            label="HRMS"
            icon={<Briefcase className="h-6 w-6" />}
            isOpen={isOpen}
            isExpanded={isHRMSOpen}
            toggle={() => setHRMSOpen(!isHRMSOpen)}
            items={[
              { icon: <Monitor className="h-6 w-6" />, label: "Dashboard" },
              { icon: <Users className="h-6 w-6" />, label: "All Employees" },
              { icon: <CalendarX className="h-6 w-6" />, label: "All Leave" },
              { icon: <CheckCircle className="h-6 w-6" />, label: "All Attendance" },
              { icon: <TrendingUp className="h-6 w-6" />, label: "Daily Performance" },
            ]}
            {...{ selectedLabel, setSelectedLabel }}
          />
        )}

        {/* WARNING, CHARTS, CALCULATOR, SETTINGS - Show to all users */}
        <MenuItem icon={<AlertTriangle className="h-6 w-6" />} label="Warning" {...{ isOpen, selectedLabel, setSelectedLabel }} />
        <MenuItem icon={<PieChart className="h-6 w-6" />} label="Charts" {...{ isOpen, selectedLabel, setSelectedLabel }} />
        <MenuItem icon={<Calculator className="h-6 w-6" />} label="EMI Calculator" {...{ isOpen, selectedLabel, setSelectedLabel }} />
        <MenuItem icon={<Settings className="h-6 w-6" />} label="Settings" {...{ isOpen, selectedLabel, setSelectedLabel }} />
      </Menu>
    </div>
  );
}

function Dropdown({ label, icon, isOpen, isExpanded, toggle, items, selectedLabel, setSelectedLabel }) {
  const isSelected = items.some((item) => selectedLabel === item.label);

  return (
    <div className="w-full">
      <button
        onClick={() => {
          if (isOpen) toggle();
        }}
        className={cn(
          "flex items-center w-full p-3 mb-1 rounded-lg hover:bg-white transition-all font-extrabold text-[15px] text-[#03B0F5] shadow animate-pop",
          isSelected && "bg-[#FFFF00] border border-[#03B0F5]"
        )}
      >
        {icon}
        {isOpen && (
          <>
            <span className="flex-1 ml-3 text-left">{label}</span>
            {isExpanded ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
          </>
        )}
      </button>

      {isExpanded && isOpen && (
        <ul className="pl-6 pr-2 mt-1 space-y-1 backdrop-blur-md bg-white/10 rounded-lg">
          {items.map((item, index) => (
            <li key={index}>
              <SidebarSubItem icon={item.icon} label={item.label} {...{ selectedLabel, setSelectedLabel, isOpen }} />
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}

function MenuItem({ icon, label, isOpen, selectedLabel, setSelectedLabel }) {
  return (
    <button
      className={cn(
        "flex  w-full p-3 mb-1 rounded-lg hover:bg-white text-[15px] font-extrabold transition-all text-[#03B0F5] shadow animate-pop",
        selectedLabel === label && "bg-[#FFFF00] border border-[#03B0F5]"
      )}
      onClick={() => setSelectedLabel(label)}
    >
      {icon}
      {isOpen && <span className="ml-3">{label}</span>}
    </button>
  );
}

function SidebarSubItem({ icon, label, selectedLabel, setSelectedLabel, isOpen }) {
  return (
    <button
      className={cn(
        "flex w-full p-2 text-left mb-1 rounded-md hover:bg-white text-[14px] transition-all font-semibold text-[#03B0F5] animate-pop ml-2",
        selectedLabel === label && "bg-[#FFFF00] border border-[#03B0F5]"
      )}
      onClick={() => setSelectedLabel(label)}
    >
      {icon}
      {isOpen && <span className="ml-2">{label}</span>}
    </button>
  );
}

// Create a version of the sidebar that uses router hooks
function SidebarWithRouter({ selectedLabel, setSelectedLabel }) {
  const navigate = useNavigate();
  const location = useLocation();
  const [collapsed, setCollapsed] = useState(false);
  const [isLEADCRMOpen, setLEADCRMOpen] = useState(false);
  const [isLoginCRMOpen, setLoginCRMOpen] = useState(false);
  const [isHRMSOpen, setHRMSOpen] = useState(false);
  const [isPinnedOpen, setIsPinnedOpen] = useState(true);
  const [isHovered, setIsHovered] = useState(false);
  const [loanTypes, setLoanTypes] = useState([]);
  const [selectedLoanType, setSelectedLoanType] = useState('all');
  const [userPermissions, setUserPermissions] = useState({});
  const [permissionsLoaded, setPermissionsLoaded] = useState(false);
  const isOpen = isPinnedOpen || isHovered;

  // Load permissions on component mount
  useEffect(() => {
    try {
      const permissions = getUserPermissions();
      console.log("Sidebar loaded permissions:", permissions);
      setUserPermissions(permissions || {});
      setPermissionsLoaded(true);
    } catch (error) {
      console.error("Error loading permissions in sidebar:", error);
      // Set default minimal permissions for critical navigation
      setUserPermissions({
        feeds: { view: true }
      });
      setPermissionsLoaded(true);
    }
  }, []);

  // Fetch loan types when the component mounts
  useEffect(() => {
    loadLoanTypes();
  }, []);

  // Safe wrapper for permission checks
  const checkPermission = (page, action) => {
    try {
      return hasPermission(userPermissions, page, action);
    } catch (error) {
      console.error(`Permission check error for ${page}:${action}:`, error);
      // Default to showing critical items if permission check fails
      return page === 'feeds' && action === 'view';
    }
  };

  const loadLoanTypes = async () => {
    try {
      const userId = localStorage.getItem('userId') || '';
      const response = await fetch(`http://localhost:8048/loan-types?user_id=${userId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      if (!response.ok) {
        throw new Error('Failed to fetch loan types');
      }

      const data = await response.json();
      const loanTypesData = data.items || data.loan_types || data || [];

      // Filter out any duplicates and format as needed
      setLoanTypes([
        { _id: 'all', name: 'All Leads', description: 'Show all leads' },
        ...loanTypesData
      ]);

    } catch (error) {
      console.error('Error loading loan types:', error);
      // Set default loan types if fetch fails
      setLoanTypes([
        { _id: 'all', name: 'All Leads', description: 'Show all leads' },
        { _id: 'personal', name: 'Personal Loan', description: 'Personal loans' },
        { _id: 'home', name: 'Home Loan', description: 'Home loans' },
      ]);
    }
  };

  // Handle loan type selection and navigate to Lead CRM with selected loan type
  const handleLoanTypeSelection = (loanTypeId, loanTypeName) => {
    setSelectedLoanType(loanTypeId);
    // Update the localStorage with selected loan type for LeadCRM to use
    localStorage.setItem('selectedLoanType', loanTypeId);
    localStorage.setItem('selectedLoanTypeName', loanTypeName);
    // Set the selected label to Lead CRM
    setSelectedLabel('Lead CRM');
    // Dispatch a storage event to notify LeadCRM component about the change
    window.dispatchEvent(new Event('storage'));
  };

  // Show loading while permissions are being fetched
  if (!permissionsLoaded) {
    return (
      <div className="h-screen w-20 bg-black flex items-center justify-center">
        <div className="text-[#03B0F5] text-sm">Loading...</div>
      </div>
    );
  }

  return (
    <div
      className={cn(
        "h-screen relative shadow-6xl bg-gradient-to-br from-white/1 to-yellow-100/1 transition-all duration-300 z-10",
        isOpen ? "w-64" : "w-20"
      )}
      onMouseEnter={() => {
        // Only set hovered to true if the sidebar is not pinned open
        if (!isPinnedOpen) {
          setIsHovered(true);
        }
      }}
      onMouseLeave={() => setIsHovered(false)}
    >
      <div className="flex flex-col h-full">
      <div className="flex items-center flex-shrink-0 h-16 p-4">
          <button
            onClick={() => setIsPinnedOpen(!isPinnedOpen)}
            className="p-2 rounded-lg shadow-md hover:bg-gradient-to-r from-purple-400 to-pink-400"
          >
            ☰
          </button>
          {isOpen && (
            <div className="flex items-center ml-3 text-[16px] font-extrabold text-[#03B0F5]">
              CRM
              <span className="ml-1 rounded-full p-0.5 flex items-center justify-center">
                <span className="text-xs">©</span>
              </span>
            </div>
          )}
        </div>
      <Menu
        theme="dark"
        mode="inline"
        selectedKeys={[location.pathname]}
      >
        {/* FEED - Always show Feed for basic navigation */}
        <MenuItem
          icon={<img src="./public/Images/marketing.png" className="h-6 w-6 " />}
          label="Feed"
          {...{ isOpen, selectedLabel, setSelectedLabel }}
        />

        {/* LEAD CRM - Only show if user has leads:view or leads:view_junior permission */}
        {(checkPermission('leads', 'view') || checkPermission('leads', 'view_junior')) && (
          <div className="w-full">
            <button
              onClick={() => {
                if (isOpen) setLEADCRMOpen(!isLEADCRMOpen);
              }}
              className={cn(
                "flex items-center w-full p-3 mb-1 rounded-lg hover:bg-white transition-all font-extrabold text-[15px] text-[#03B0F5] shadow animate-pop",
                (selectedLabel === "Lead CRM" || selectedLabel === "CRM Dashboard" || selectedLabel === "Create LEAD") && "bg-[#FFFF00] border border-[#03B0F5]"
              )}
            >
              <img src="/Images/filter.png" className="h-6 w-6" />
              {isOpen && (
                <>
                  <span className="flex-1 ml-3 text-left">LEAD CRM</span>
                  {isLEADCRMOpen ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                </>
              )}
            </button>

            {isLEADCRMOpen && isOpen && (
              <ul className="pl-6 pr-2 mt-1 space-y-1 backdrop-blur-md bg-white/10 rounded-lg">
                {/* Main LEAD CRM Menu Items */}
                <li>
                  <SidebarSubItem icon={<img src="./public/Images/dashboard (1).png" className="h-6 w-6" />} label="CRM Dashboard" {...{ selectedLabel, setSelectedLabel, isOpen }} />
                </li>
                <li>
                  <SidebarSubItem icon={<Users className="h-6 w-6" />} label="Lead CRM" {...{ selectedLabel, setSelectedLabel, isOpen }} />
                </li>
                {/* Only show Create LEAD if user has leads:create permission */}
                {checkPermission('leads', 'edit') && (
                  <li>
                    <SidebarSubItem icon={<img src="./public/Images/deal.png" className="h-6 w-6" />} label="Create LEAD" {...{ selectedLabel, setSelectedLabel, isOpen }} />
                  </li>
                )}
                {/* Loan Types Section */}
                <li className="mt-2 pt-2 border-t border-gray-700">
                  <div className="px-2 py-1 text-xs text-gray-400">LOAN TYPES</div>
                </li>
                {/* Display all loan types */}
                {loanTypes.map((loanType) => (
                  <li key={loanType._id}>
                    <button
                      className={cn(
                        "flex w-full p-2 text-left mb-1 rounded-md hover:bg-white text-[14px] transition-all font-semibold text-[#03B0F5] animate-pop ml-2",
                        selectedLoanType === loanType._id && selectedLabel === "Lead CRM" && "bg-[#FFFF00] border border-[#03B0F5]"
                      )}
                      onClick={() => handleLoanTypeSelection(loanType._id, loanType.name)}
                    >
                      <CreditCard className="h-5 w-5" />
                      {isOpen && <span className="ml-2">{loanType.name}</span>}
                    </button>
                  </li>
                ))}
              </ul>
            )}
          </div>
        )}

        {/* LOGIN CRM - Only show if user has users:view permission */}
        {checkPermission('users', 'view') && (
          <Dropdown
            label="Login CRM"
            icon={<LogIn className="h-6 w-6" />}
            isOpen={isOpen}
            isExpanded={isLoginCRMOpen}
            toggle={() => setLoginCRMOpen(!isLoginCRMOpen)}
            items={[
              { icon: <Monitor className="h-6 w-6" />, label: "Dashboard" },
              { icon: <LogIn className="h-6 w-6" />, label: "Login CRM" },
              { icon: <Key className="h-6 w-6" />, label: "PL & ODD LOGIN" },
              { icon: <Building2 className="h-6 w-6" />, label: "Home Loan LOGIN" },
            ]}
            {...{ selectedLabel, setSelectedLabel }}
          />
        )}

        {/* TASK - Only show if user has feeds:view or tasks:view permission */}
        {(checkPermission('feeds', 'view') || checkPermission('tasks', 'view')) && (
          <MenuItem icon={<ListTodo className="h-6 w-6" />} label="Task" {...{ isOpen, selectedLabel, setSelectedLabel }} />
        )}

        {/* TICKET - Only show if user has feeds:view or tickets:view permission */}
        {(checkPermission('feeds', 'view') || checkPermission('tickets', 'view')) && (
          <MenuItem icon={<Ticket className="h-6 w-6" />} label="Ticket" {...{ isOpen, selectedLabel, setSelectedLabel }} />
        )}

        {/* HRMS - Only show if user has users:view permission */}
        {checkPermission('users', 'view') && (
          <Dropdown
            label="HRMS"
            icon={<Briefcase className="h-6 w-6" />}
            isOpen={isOpen}
            isExpanded={isHRMSOpen}
            toggle={() => setHRMSOpen(!isHRMSOpen)}
            items={[
              { icon: <Monitor className="h-6 w-6" />, label: "Dashboard" },
              { icon: <Users className="h-6 w-6" />, label: "All Employees" },
              { icon: <CalendarX className="h-6 w-6" />, label: "All Leave" },
              { icon: <CheckCircle className="h-6 w-6" />, label: "All Attendance" },
              { icon: <TrendingUp className="h-6 w-6" />, label: "Daily Performance" },
            ]}
            {...{ selectedLabel, setSelectedLabel }}
          />
        )}

        {/* WARNING, CHARTS, CALCULATOR, SETTINGS - Show to all users */}
        <MenuItem icon={<AlertTriangle className="h-6 w-6" />} label="Warning" {...{ isOpen, selectedLabel, setSelectedLabel }} />
        <MenuItem icon={<PieChart className="h-6 w-6" />} label="Charts" {...{ isOpen, selectedLabel, setSelectedLabel }} />
        <MenuItem icon={<Calculator className="h-6 w-6" />} label="EMI Calculator" {...{ isOpen, selectedLabel, setSelectedLabel }} />
        <MenuItem icon={<Settings className="h-6 w-6" />} label="Settings" {...{ isOpen, selectedLabel, setSelectedLabel }} />
      </Menu>
    </div>
    </div>
  );
}

// Main Sidebar component that determines which version to use based on router context availability
function Sidebar(props) {
  // Check if we're in a router context by trying to use useLocation
  try {
    // This will throw an error if we're not in a router context
    useLocation();

    // If we get here, we're in a router context
    return <SidebarWithRouter {...props} />;
  } catch (error) {
    // If useLocation throws an error, we're not in a router context
    console.warn("Router context not available in Sidebar, using fallback version without router hooks");
    return <SidebarWithoutRouter {...props} />;
  }
}

export default Sidebar;
