import React, { useState, useEffect } from 'react';
import {
    Settings,
    Plus,
    Edit,
    Trash2,
    Upload,
    Search,
    Building,
    CreditCard,
    Code,
    Users,
    FileSpreadsheet,
    CheckCircle,
    AlertCircle,
    X,
    Shield,
    Lock,
    Paperclip,
    Clock,
    Save
} from 'lucide-react';
import axios from 'axios';
import { getUserPermissions, isSuperAdmin, hasPermission } from '../utils/permissions';
import StatusManagementTab from './StatusManagementTab';
import AttendanceSettingsTab from './attendance/AttendanceSettingsTab';

const SettingsPage = () => {
    // State management
    const [activeTab, setActiveTab] = useState('campaigns');
    const [loading, setLoading] = useState(false);
    const [user_id] = useState(localStorage.getItem('userId') || '');
    const [userPermissions, setUserPermissions] = useState({});
    const [hasSettingsAccess, setHasSettingsAccess] = useState(false);
    const [error, setError] = useState(null);
    const [permissionsLoaded, setPermissionsLoaded] = useState(false);

    // Data states
    const [campaignNames, setCampaignNames] = useState([]);
    const [dataCodes, setDataCodes] = useState([]);
    const [bankNames, setBankNames] = useState([]);
    const [companyData, setCompanyData] = useState([]);
    const [departments, setDepartments] = useState([]);
    const [roles, setRoles] = useState([]);
    const [statuses, setStatuses] = useState([]);
    const [attendanceSettings, setAttendanceSettings] = useState({
        check_in_time: '10:00',
        check_out_time: '19:00',
        required_working_hours: 8.0,
        late_check_in_threshold: '10:30',
        early_check_out_threshold: '18:30',
        geo_location_required: true,
        photo_required: true,
        working_days: [0, 1, 2, 3, 4, 5], // Monday to Saturday
        half_day_rules: {
            late_check_in: true,
            early_check_out: true,
            insufficient_hours: true
        },
        attendance_editable_by_admin: true,
        date_time_format: 'DD MMMM YYYY, HH:mm'
    });

    // Status management states
    const [selectedDepartment, setSelectedDepartment] = useState('leads');
    const [selectedStatus, setSelectedStatus] = useState(null);
    const [showStatusModal, setShowStatusModal] = useState(false);
    const [showSubStatusModal, setShowSubStatusModal] = useState(false);
    const [statusModalType, setStatusModalType] = useState('add');
    const [subStatusModalType, setSubStatusModalType] = useState('add');

    // Permissions management states
    const [availablePermissions, setAvailablePermissions] = useState([]);
    const [selectedRole, setSelectedRole] = useState(null);
    const [rolePermissions, setRolePermissions] = useState([]);
    const [showPermissionModal, setShowPermissionModal] = useState(false);
    const [editingStatus, setEditingStatus] = useState(null);
    const [editingSubStatus, setEditingSubStatus] = useState(null);

    // Modal states
    const [showModal, setShowModal] = useState(false);
    const [modalType, setModalType] = useState(''); // 'add' or 'edit'
    const [editingItem, setEditingItem] = useState(null);
    const [formData, setFormData] = useState({});

    // Search and file upload states
    const [searchQuery, setSearchQuery] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [uploadFile, setUploadFile] = useState(null);
    const [uploadProgress, setUploadProgress] = useState(0);

    const BASE_URL = 'http://localhost:8048';

    // Tab configuration
    const tabs = [
        { id: 'campaigns', label: 'Campaign Names', icon: Users, color: 'blue' },
        { id: 'dataCodes', label: 'Data Codes', icon: Code, color: 'green' },
        { id: 'bankNames', label: 'Bank Names', icon: CreditCard, color: 'purple' },
        { id: 'companyData', label: 'Company Data', icon: Building, color: 'orange' },
        { id: 'excelUpload', label: 'Excel Upload', icon: FileSpreadsheet, color: 'red' },
        { id: 'departments', label: 'Departments', icon: Building, color: 'cyan' },
        { id: 'roles', label: 'Roles & Permissions', icon: Users, color: 'indigo' },
        { id: 'permissions', label: 'Permission Management', icon: Shield, color: 'violet' },
        { id: 'statuses', label: 'Status Management', icon: Paperclip, color: 'teal' },
        { id: 'attendance', label: 'Attendance Settings', icon: Clock, color: 'emerald' }
    ];

    // Complete permissions structure
    const PERMISSION_STRUCTURE = {
        'Global': {
            'show': 'Global show access',
            'wildcard': 'Full system access (*)'
        },
        'Feeds': {
            'show': 'View feeds',
            'feeds': 'Manage feeds',
            'post': 'Create posts',
            'wildcard': 'All feeds permissions (*)'
        },
        'Leads': {
            'create': 'Create leads',
            'show': 'View leads interface',
            'assign': 'Assign leads',
            'view_own': 'View own leads',
            'view_other': 'View other leads',
            'view_all': 'View all leads',
            'view_junior': 'View junior leads'
        },
        'Login': {
            'show': 'View login interface',
            'view_own': 'View own login data',
            'view_other': 'View other login data',
            'view_all': 'View all login data',
            'view_junior': 'View junior login data'
        },
        'Tasks': {
            'show': 'View tasks interface',
            'create': 'Create tasks',
            'edit_others': 'Edit others tasks'
        },
        'Tickets': {
            'show': 'View tickets interface',
            'view_tickets_own': 'View own tickets',
            'view_tickets_others': 'View other tickets'
        },
        'HRMS Employees': {
            'employees_show': 'View employees interface',
            'employees_edit': 'Edit employees',
            'employees_create': 'Create employees',
            'employees_delete': 'Delete employees',
            'all_employees': 'Manage all employees'
        },
        'Leaves': {
            'leaves_show': 'View leaves interface',
            'leaves_own': 'View own leaves',
            'leave_admin': 'Admin leave permissions',
            'leaves_create': 'Create leaves'
        },
        'Attendance': {
            'attendance_show': 'View attendance interface',
            'attendance_own': 'View own attendance',
            'attendance_admin': 'Admin attendance permissions',
            'attendance_edit': 'Edit attendance',
            'attendance_mark': 'Mark attendance'
        },
        'Warnings': {
            'show': 'View warnings interface',
            'warnings_own': 'View own warnings',
            'warnings_admin': 'Admin warning permissions'
        },
        'Charts': {
            'show': 'View charts interface'
        },
        'EMI Calculator': {
            'show': 'View EMI calculator'
        },
        'Settings': {
            'show': 'View settings interface',
            'edit': 'Edit settings'
        }
    };

    // Check permissions on component mount
    useEffect(() => {
        try {
            // Debug user_id retrieval
            console.log('SettingsPage: User ID from localStorage:', user_id);
            console.log('SettingsPage: All localStorage items:', {
                userId: localStorage.getItem('userId'),
                user_id: localStorage.getItem('user_id'), // Check both variants
                userPermissions: localStorage.getItem('userPermissions'),
                token: localStorage.getItem('token')
            });

            const permissions = getUserPermissions();
            setUserPermissions(permissions);

            // Check if user is super admin or has settings permissions
            const isSuper = isSuperAdmin(permissions);
            const hasSettingsView = hasPermission(permissions, 'settings', 'view') || 
                                   hasPermission(permissions, 'settings', 'show') ||
                                   hasPermission(permissions, 'Settings', 'view') ||
                                   hasPermission(permissions, 'Settings', 'show');

            console.log('Settings permission check:', {
                isSuper,
                hasSettingsView,
                permissions,
                user_id,
                userPermissionsRaw: localStorage.getItem('userPermissions')
            });

            setHasSettingsAccess(isSuper || hasSettingsView);
            setPermissionsLoaded(true);
        } catch (error) {
            console.error('Error checking permissions:', error);
            setError('Error loading permissions: ' + error.message);
            // Default to allowing access if there's an error with permissions
            setHasSettingsAccess(true);
            setPermissionsLoaded(true);
        }
    }, []);

    // Load data on component mount (only if has access)
    useEffect(() => {
        if (hasSettingsAccess) {
            loadAllData();
        }
    }, [hasSettingsAccess]);

    // Load data for active tab
    useEffect(() => {
        switch (activeTab) {
            case 'campaigns':
                loadCampaignNames();
                break;
            case 'dataCodes':
                loadDataCodes();
                break;
            case 'bankNames':
                loadBankNames();
                break;
            case 'companyData':
                loadCompanyData();
                break;
            case 'departments':
                loadDepartments();
                break;
            case 'roles':
                loadRoles();
                break;
            case 'statuses':
                loadStatuses();
                break;
            case 'attendance':
                loadAttendanceSettings();
                break;
        }
    }, [activeTab]);

    // API calls
    const loadAllData = async () => {
        await Promise.all([
            loadCampaignNames(),
            loadDataCodes(),
            loadBankNames(),
            loadCompanyData(),
            loadDepartments(),
            loadRoles(),
            loadAttendanceSettings()
        ]);
    };

    const loadCampaignNames = async () => {
        try {
            const response = await axios.get(`${BASE_URL}/settings/campaign-names?user_id=${user_id}`);
            setCampaignNames(response.data);
        } catch (error) {
            console.error('Error loading campaign names:', error);
        }
    };

    const loadDataCodes = async () => {
        try {
            const response = await axios.get(`${BASE_URL}/settings/data-codes?user_id=${user_id}`);
            setDataCodes(response.data);
        } catch (error) {
            console.error('Error loading data codes:', error);
        }
    };

    const loadBankNames = async () => {
        try {
            const response = await axios.get(`${BASE_URL}/settings/bank-names?user_id=${user_id}`);
            setBankNames(response.data);
        } catch (error) {
            console.error('Error loading bank names:', error);
        }
    };

    const loadCompanyData = async () => {
        try {
            const response = await axios.get(`${BASE_URL}/settings/company-data?user_id=${user_id}`);
            setCompanyData(response.data);
        } catch (error) {
            console.error('Error loading company data:', error);
        }
    };

    const loadDepartments = async () => {
        try {
            const response = await axios.get(`${BASE_URL}/departments?user_id=${user_id}`);
            setDepartments(response.data.departments || response.data);
        } catch (error) {
            console.error('Error loading departments:', error);
        }
    };

    const loadRoles = async () => {
        try {
            const response = await axios.get(`${BASE_URL}/roles?user_id=${user_id}`);
            setRoles(response.data.roles || response.data);
        } catch (error) {
            console.error('Error loading roles:', error);
        }
    };

    // Status management functions
    const loadStatuses = async () => {
        try {
            const response = await axios.get(`/api/leads/admin/statuses?user_id=${localStorage.getItem('user_id')}`);
            const statusesData = response.data;
            
            // Ensure we always set an array
            if (Array.isArray(statusesData)) {
                setStatuses(statusesData);
            } else if (statusesData && Array.isArray(statusesData.statuses)) {
                setStatuses(statusesData.statuses);
            } else if (statusesData && Array.isArray(statusesData.data)) {
                setStatuses(statusesData.data);
            } else {
                console.warn('Unexpected statuses API response structure:', statusesData);
                setStatuses([]);
            }
        } catch (error) {
            console.error('Error loading statuses:', error);
            setStatuses([]);
        }
    };

    const createStatus = async (statusData) => {
        try {
            const response = await axios.post(`/api/leads/admin/statuses?user_id=${localStorage.getItem('user_id')}`, statusData);
            if (response.status === 201) {
                await loadStatuses(); // Reload statuses
                return true;
            }
        } catch (error) {
            console.error('Error creating status:', error);
            alert('Failed to create status');
        }
        return false;
    };

    const updateStatus = async (statusId, statusData) => {
        try {
            const response = await axios.put(`/api/leads/admin/statuses/${statusId}?user_id=${localStorage.getItem('user_id')}`, statusData);
            if (response.status === 200) {
                await loadStatuses(); // Reload statuses
                return true;
            }
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Failed to update status');
        }
        return false;
    };

    const deleteStatus = async (statusId) => {
        try {
            const response = await axios.delete(`/api/leads/admin/statuses/${statusId}?user_id=${localStorage.getItem('user_id')}`);
            if (response.status === 200) {
                await loadStatuses(); // Reload statuses
                return true;
            }
        } catch (error) {
            console.error('Error deleting status:', error);
            alert('Failed to delete status');
        }
        return false;
    };

    const deleteSubStatusFromArray = async (statusId, subStatus, index) => {
        try {
            const status = statuses.find(s => (s._id || s.id) === statusId);
            if (!status) return false;

            // Remove sub-status from array
            const updatedSubStatuses = [...(status.sub_statuses || [])];
            updatedSubStatuses.splice(index, 1);

            // Update the status with new sub-statuses array
            return await updateStatus(statusId, {
                sub_statuses: updatedSubStatuses
            });
        } catch (error) {
            console.error('Error deleting sub-status:', error);
            alert('Failed to delete sub-status');
        }
        return false;
    };

    // CRUD operations
    const handleAdd = (type) => {
        setModalType('add');
        setEditingItem(null);
        setFormData({});
        setShowModal(true);
    };

    const handleEdit = (item, type) => {
        setModalType('edit');
        setEditingItem(item);
        setFormData(item);
        setShowModal(true);
    };

    const handleDelete = async (id, type) => {
        if (!window.confirm('Are you sure you want to delete this item?')) return;

        try {
            let endpoint;
            switch (type) {
                case 'campaigns':
                    endpoint = `/settings/campaign-names/${id}`;
                    break;
                case 'dataCodes':
                    endpoint = `/settings/data-codes/${id}`;
                    break;
                case 'bankNames':
                    endpoint = `/settings/bank-names/${id}`;
                    break;
                case 'companyData':
                    endpoint = `/settings/company-data/${id}`;
                    break;
                case 'departments':
                    endpoint = `/departments/${id}`;
                    break;
                case 'roles':
                    endpoint = `/roles/${id}`;
                    break;
            }

            await axios.delete(`${BASE_URL}${endpoint}?user_id=${user_id}`);

            // Reload data
            switch (type) {
                case 'campaigns':
                    loadCampaignNames();
                    break;
                case 'dataCodes':
                    loadDataCodes();
                    break;
                case 'bankNames':
                    loadBankNames();
                    break;
                case 'companyData':
                    loadCompanyData();
                    break;
                case 'departments':
                    loadDepartments();
                    break;
                case 'roles':
                    loadRoles();
                    break;
            }

            alert('Item deleted successfully!');
        } catch (error) {
            console.error('Error deleting item:', error);
            alert('Error deleting item: ' + (error.response?.data?.detail || error.message));
        }
    };

    const handleSave = async () => {
        try {
            setLoading(true);
            let endpoint, data;

            switch (activeTab) {
                case 'campaigns':
                    endpoint = modalType === 'add'
                        ? `/settings/campaign-names`
                        : `/settings/campaign-names/${editingItem.id}`;
                    data = {
                        name: formData.name,
                        description: formData.description,
                        is_active: formData.is_active !== false
                    };
                    break;
                case 'dataCodes':
                    endpoint = modalType === 'add'
                        ? `/settings/data-codes`
                        : `/settings/data-codes/${editingItem.id}`;
                    data = {
                        code: formData.code,
                        description: formData.description,
                        is_active: formData.is_active !== false
                    };
                    break;
                case 'bankNames':
                    endpoint = modalType === 'add'
                        ? `/settings/bank-names`
                        : `/settings/bank-names/${editingItem.id}`;
                    data = {
                        name: formData.name,
                        full_name: formData.full_name,
                        code: formData.code,
                        is_active: formData.is_active !== false
                    };
                    break;
                case 'departments':
                    endpoint = modalType === 'add'
                        ? `/departments`
                        : `/departments/${editingItem.id}`;
                    data = {
                        name: formData.name,
                        description: formData.description,
                        parent_id: formData.parent_id,
                        is_active: formData.is_active !== false
                    };
                    break;
                case 'roles':
                    endpoint = modalType === 'add'
                        ? `/roles`
                        : `/roles/${editingItem.id}`;
                    data = {
                        name: formData.name,
                        description: formData.description,
                        department_id: formData.department_id,
                        reporting_id: formData.reporting_id,
                        permissions: formData.permissions || []
                    };
                    break;
            }

            if (modalType === 'add') {
                await axios.post(`${BASE_URL}${endpoint}?user_id=${user_id}`, data);
            } else {
                await axios.put(`${BASE_URL}${endpoint}?user_id=${user_id}`, data);
            }

            setShowModal(false);
            loadAllData();
            alert(`${modalType === 'add' ? 'Created' : 'Updated'} successfully!`);
        } catch (error) {
            console.error('Error saving:', error);
            alert('Error saving: ' + (error.response?.data?.detail || error.message));
        } finally {
            setLoading(false);
        }
    };

    // Excel upload
    const handleFileUpload = async () => {
        if (!uploadFile) {
            alert('Please select a file first');
            return;
        }

        // Debug permission check
        const permissions = getUserPermissions();
        const isSuper = isSuperAdmin(permissions);
        const hasCreatePermission = hasPermission(permissions, 'settings', 'create');

        console.log('Upload permission debug:', {
            permissions,
            isSuper,
            hasCreatePermission,
            user_id
        });

        try {
            setLoading(true);
            const formData = new FormData();
            formData.append('file', uploadFile);

            const response = await axios.post(
                `${BASE_URL}/settings/upload-excel?user_id=${user_id}`,
                formData,
                {
                    headers: { 'Content-Type': 'multipart/form-data' },
                    onUploadProgress: (progressEvent) => {
                        const percentCompleted = Math.round(
                            (progressEvent.loaded * 100) / progressEvent.total
                        );
                        setUploadProgress(percentCompleted);
                    }
                }
            );

            alert(`Upload successful! ${response.data.message}`);
            setUploadFile(null);
            setUploadProgress(0);
            loadCompanyData();
        } catch (error) {
            console.error('Error uploading file:', error);
            alert('Error uploading file: ' + (error.response?.data?.detail || error.message));
        } finally {
            setLoading(false);
        }
    };

    // Company search
    const handleCompanySearch = async () => {
        if (!searchQuery.trim()) {
            alert('Please enter a company name to search');
            return;
        }

        try {
            setLoading(true);
            const response = await axios.post(
                `${BASE_URL}/settings/search-companies?user_id=${user_id}`,
                {
                    company_name: searchQuery,
                    similarity_threshold: 0.8
                }
            );
            setSearchResults(response.data);
        } catch (error) {
            console.error('Error searching companies:', error);
            alert('Error searching companies: ' + (error.response?.data?.detail || error.message));
        } finally {
            setLoading(false);
        }
    };

    // Attendance settings functions
    const loadAttendanceSettings = async () => {
        try {
            const response = await axios.get(`${BASE_URL}/settings/attendance-settings?user_id=${user_id}`);
            if (response.data && response.data.data) {
                setAttendanceSettings(response.data.data);
            }
        } catch (error) {
            console.error('Error loading attendance settings:', error);
        }
    };

    const updateAttendanceSettings = async (updatedSettings) => {
        try {
            setLoading(true);
            const response = await axios.put(
                `${BASE_URL}/settings/attendance-settings?user_id=${user_id}`,
                updatedSettings
            );
            
            if (response.data && response.data.settings) {
                setAttendanceSettings(response.data.settings);
                alert('Attendance settings updated successfully!');
            }
        } catch (error) {
            console.error('Error updating attendance settings:', error);
            alert('Error updating attendance settings: ' + (error.response?.data?.detail || error.message));
        } finally {
            setLoading(false);
        }
    };

    // Render functions
    const renderTabContent = () => {
        switch (activeTab) {
            case 'campaigns':
                return renderDataTable(campaignNames, 'campaigns', ['name', 'description', 'is_active']);
            case 'dataCodes':
                return renderDataTable(dataCodes, 'dataCodes', ['code', 'description', 'is_active']);
            case 'bankNames':
                return renderDataTable(bankNames, 'BankNames', ['name', 'full_name', 'code', 'is_active']);
            case 'companyData':
                return renderCompanyDataTable();
            case 'excelUpload':
                return renderExcelUpload();
            case 'departments':
                return renderDataTable(departments, 'departments', ['name', 'description', 'is_active']);
            case 'roles':
                return renderRolesTable();
            case 'permissions':
                return renderPermissionsTab();
            case 'statuses':
                return (
                    <StatusManagementTab
                        statuses={statuses}
                        selectedDepartment={selectedDepartment}
                        setSelectedDepartment={setSelectedDepartment}
                        showStatusModal={showStatusModal}
                        setShowStatusModal={setShowStatusModal}
                        showSubStatusModal={showSubStatusModal}
                        setShowSubStatusModal={setShowSubStatusModal}
                        statusModalType={statusModalType}
                        setStatusModalType={setStatusModalType}
                        subStatusModalType={subStatusModalType}
                        setSubStatusModalType={setSubStatusModalType}
                        editingStatus={editingStatus}
                        setEditingStatus={setEditingStatus}
                        editingSubStatus={editingSubStatus}
                        setEditingSubStatus={setEditingSubStatus}
                        selectedStatus={selectedStatus}
                        setSelectedStatus={setSelectedStatus}
                        createStatus={createStatus}
                        updateStatus={updateStatus}
                        deleteStatus={deleteStatus}
                        deleteSubStatusFromArray={deleteSubStatusFromArray}
                    />
                );
            case 'attendance':
                return <AttendanceSettingsTab userId={user_id} />;
            default:
                return null;
        }
    };

    const renderDataTable = (data, type, columns) => (
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
            <div className="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 className="text-xl font-bold text-gray-800">
                    {tabs.find(t => t.id === type)?.label || type}
                </h3>
                {(isSuperAdmin(userPermissions) || hasPermission(userPermissions, 'settings', 'create')) && (
                    <button
                        onClick={() => handleAdd(type)}
                        className="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-blue-600 hover:to-blue-700 transition-all"
                    >
                        <Plus size={16} />
                        Add New
                    </button>
                )}
            </div>

            <div className="overflow-x-auto">
                <table className="w-full">
                    <thead className="bg-gray-50">
                        <tr>
                            {columns.map(col => (
                                <th key={col} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {col.replace('_', ' ')}
                                </th>
                            ))}
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                        {data.map((item, index) => (
                            <tr key={item.id || index} className="hover:bg-gray-50">
                                {columns.map(col => (
                                    <td key={col} className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {col === 'is_active' ? (
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${item[col] ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                }`}>
                                                {item[col] ? 'Active' : 'Inactive'}
                                            </span>
                                        ) : (
                                            item[col] || '-'
                                        )}
                                    </td>
                                ))}
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div className="flex gap-2">
                                        {(isSuperAdmin(userPermissions) || hasPermission(userPermissions, 'settings', 'edit')) && (
                                            <button
                                                onClick={() => handleEdit(item, type)}
                                                className="text-blue-600 hover:text-blue-900"
                                                title="Edit"
                                            >
                                                <Edit size={16} />
                                            </button>
                                        )}
                                        {(isSuperAdmin(userPermissions) || hasPermission(userPermissions, 'settings', 'delete')) && (
                                            <button
                                                onClick={() => handleDelete(item.id, type)}
                                                className="text-red-600 hover:text-red-900"
                                                title="Delete"
                                            >
                                                <Trash2 size={16} />
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );

    const renderCompanyDataTable = () => (
        <div className="space-y-6">
            {/* Search Section */}
            <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-xl font-bold text-gray-800 mb-4">Search Similar Companies</h3>
                <div className="flex gap-4">
                    <input
                        type="text"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Enter company name to search..."
                        className="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <button
                        onClick={handleCompanySearch}
                        disabled={loading}
                        className="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 hover:from-green-600 hover:to-green-700 transition-all disabled:opacity-50"
                    >
                        <Search size={16} />
                        Search
                    </button>
                </div>

                {searchResults.length > 0 && (
                    <div className="mt-4">
                        <h4 className="font-semibold text-gray-700 mb-2">Search Results:</h4>
                        <div className="space-y-2">
                            {searchResults.map((result, index) => (
                                <div key={index} className="bg-gray-50 p-3 rounded-lg">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="font-medium">{result.company_name}</p>
                                            <p className="text-sm text-gray-600">Categories: {result.categories.join(', ')}</p>
                                            <p className="text-sm text-gray-600">Banks: {result.bank_names.join(', ')}</p>
                                        </div>
                                        <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-medium">
                                            {result.similarity_percentage}% match
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>

            {/* Company Data Table */}
            <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                <div className="p-6 border-b border-gray-200">
                    <h3 className="text-xl font-bold text-gray-800">Company Data</h3>
                </div>

                <div className="overflow-x-auto">
                    <table className="w-full">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Company Name
                                </th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Categories
                                </th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Bank Names
                                </th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                            {companyData.map((company, index) => (
                                <tr key={company.id || index} className="hover:bg-gray-50">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        {company.company_name}
                                    </td>
                                    <td className="px-6 py-4 text-sm text-gray-900">
                                        <div className="flex flex-wrap gap-1">
                                            {company.categories.map((category, idx) => (
                                                <span key={idx} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                                                    {category}
                                                </span>
                                            ))}
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 text-sm text-gray-900">
                                        <div className="flex flex-wrap gap-1">
                                            {company.bank_names.map((bank, idx) => (
                                                <span key={idx} className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                                    {bank}
                                                </span>
                                            ))}
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button
                                            onClick={() => handleDelete(company.id, 'companyData')}
                                            className="text-red-600 hover:text-red-900"
                                        >
                                            <Trash2 size={16} />
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );

    const renderExcelUpload = () => {
        // Check if user has permission to upload Excel files (create permission)
        // For now, also allow if user has any admin permissions as fallback
        const canUpload = isSuperAdmin(userPermissions) ||
            hasPermission(userPermissions, 'settings', 'create');

        if (!canUpload) {
            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-xl font-bold text-gray-800 mb-4">Upload Excel File</h3>
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <Lock className="h-8 w-8 text-red-500 mx-auto mb-2" />
                        <p className="text-red-700">You don't have permission to upload Excel files.</p>
                        <p className="text-sm text-red-600 mt-1">Required permission: settings.create</p>
                        <div className="mt-2 text-xs text-gray-600">
                            <p>Debug info:</p>
                            <p>Super Admin: {isSuperAdmin(userPermissions) ? 'Yes' : 'No'}</p>
                            <p>Settings Create: {hasPermission(userPermissions, 'settings', 'create') ? 'Yes' : 'No'}</p>
                        </div>
                    </div>
                </div>
            );
        }

        return (
            <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-xl font-bold text-gray-800 mb-4">Upload Excel File</h3>
                <p className="text-gray-600 mb-6">
                    Upload an Excel file with columns: Company Name, Categories, Bank Name
                </p>

                <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <Upload size={48} className="mx-auto text-gray-400 mb-4" />

                    <input
                        type="file"
                        accept=".xlsx,.xls"
                        onChange={(e) => setUploadFile(e.target.files[0])}
                        className="hidden"
                        id="file-upload"
                    />

                    <label
                        htmlFor="file-upload"
                        className="cursor-pointer bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-lg inline-flex items-center gap-2 hover:from-blue-600 hover:to-blue-700 transition-all"
                    >
                        <FileSpreadsheet size={20} />
                        Choose Excel File
                    </label>

                    {uploadFile && (
                        <div className="mt-4">
                            <p className="text-sm text-gray-600">Selected: {uploadFile.name}</p>

                            {uploadProgress > 0 && (
                                <div className="mt-2">
                                    <div className="bg-gray-200 rounded-full h-2">
                                        <div
                                            className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                            style={{ width: `${uploadProgress}%` }}
                                        ></div>
                                    </div>
                                    <p className="text-sm text-gray-600 mt-1">{uploadProgress}% uploaded</p>
                                </div>
                            )}

                            <button
                                onClick={handleFileUpload}
                                disabled={loading}
                                className="mt-4 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all disabled:opacity-50"
                            >
                                {loading ? 'Uploading...' : 'Upload File'}
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    const renderRolesTable = () => (
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
            <div className="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 className="text-xl font-bold text-gray-800">Roles & Permissions</h3>
                {(isSuperAdmin(userPermissions) || hasPermission(userPermissions, 'roles', 'create')) && (
                    <button
                        onClick={() => handleAdd('roles')}
                        className="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-blue-600 hover:to-blue-700 transition-all"
                    >
                        <Plus size={16} />
                        Add Role
                    </button>
                )}
            </div>

            <div className="overflow-x-auto">
                <table className="w-full">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Role Name
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Description
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Department
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Permissions
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                        {roles.map((role, index) => (
                            <tr key={role.id || index} className="hover:bg-gray-50">
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    {role.name}
                                </td>
                                <td className="px-6 py-4 text-sm text-gray-900">
                                    {role.description || '-'}
                                </td>
                                <td className="px-6 py-4 text-sm text-gray-900">
                                    {departments.find(d => d.id === role.department_id)?.name || '-'}
                                </td>
                                <td className="px-6 py-4 text-sm text-gray-900">
                                    <div className="flex flex-wrap gap-1">
                                        {role.permissions?.slice(0, 3).map((perm, idx) => (
                                            <span key={idx} className="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">
                                                {perm.page}: {Array.isArray(perm.actions) ? perm.actions.join(',') : perm.actions}
                                            </span>
                                        )) || '-'}
                                        {role.permissions?.length > 3 && (
                                            <span className="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">
                                                +{role.permissions.length - 3} more
                                            </span>
                                        )}
                                    </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div className="flex gap-2">
                                        {(isSuperAdmin(userPermissions) || hasPermission(userPermissions, 'roles', 'edit')) && (
                                            <button
                                                onClick={() => handleEdit(role, 'roles')}
                                                className="text-blue-600 hover:text-blue-900"
                                                title="Edit Role"
                                            >
                                                <Edit size={16} />
                                            </button>
                                        )}
                                        {(isSuperAdmin(userPermissions) || hasPermission(userPermissions, 'roles', 'delete')) && (
                                            <button
                                                onClick={() => handleDelete(role.id, 'roles')}
                                                className="text-red-600 hover:text-red-900"
                                                title="Delete Role"
                                            >
                                                <Trash2 size={16} />
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );

    // Permission management functions
    const loadRolePermissions = async (roleId) => {
        try {
            const response = await axios.get(`${BASE_URL}/roles/${roleId}/permissions`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            setRolePermissions(response.data.permissions || []);
        } catch (error) {
            console.error('Error loading role permissions:', error);
            setRolePermissions([]);
        }
    };

    const handlePermissionToggle = (permission, isChecked) => {
        if (isChecked) {
            setRolePermissions(prev => [...prev, permission]);
        } else {
            setRolePermissions(prev => prev.filter(p => p !== permission));
        }
    };

    const saveRolePermissions = async (roleId) => {
        try {
            setLoading(true);
            await axios.put(`${BASE_URL}/roles/${roleId}/permissions`, {
                permissions: rolePermissions
            }, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            
            // Show success message
            alert('Permissions updated successfully!');
            
            // Reload roles to reflect changes
            await loadData('roles');
        } catch (error) {
            console.error('Error saving permissions:', error);
            alert('Error saving permissions: ' + (error.response?.data?.detail || error.message));
        } finally {
            setLoading(false);
        }
    };

    const renderPermissionsTab = () => (
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
            <div className="p-6 border-b border-gray-200">
                <h3 className="text-xl font-bold text-gray-800 mb-4">Permission Management</h3>
                <p className="text-gray-600 mb-4">
                    Manage role permissions. Select a role to view and edit its permissions.
                </p>
                
                {/* Role Selection */}
                <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Select Role</label>
                    <select
                        value={selectedRole?.id || ''}
                        onChange={(e) => {
                            const role = roles.find(r => r.id === e.target.value);
                            setSelectedRole(role);
                            if (role) {
                                loadRolePermissions(role.id);
                            }
                        }}
                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="">Select a role...</option>
                        {roles.map(role => (
                            <option key={role.id} value={role.id}>{role.name}</option>
                        ))}
                    </select>
                </div>
            </div>

            {/* Permissions Grid */}
            {selectedRole && (
                <div className="p-6">
                    <div className="mb-4 flex justify-between items-center">
                        <h4 className="text-lg font-semibold text-gray-800">
                            Permissions for: {selectedRole.name}
                        </h4>
                        <button
                            onClick={() => saveRolePermissions(selectedRole.id)}
                            className="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-green-600 hover:to-green-700 transition-all"
                        >
                            <Save size={16} />
                            Save Permissions
                        </button>
                    </div>

                    <div className="grid gap-6">
                        {Object.entries(PERMISSION_STRUCTURE).map(([module, permissions]) => (
                            <div key={module} className="border border-gray-200 rounded-lg p-4">
                                <h5 className="text-md font-semibold text-gray-800 mb-3">{module}</h5>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    {Object.entries(permissions).map(([permissionKey, description]) => {
                                        const fullPermissionKey = module === 'Global' ? permissionKey : `${module.toLowerCase().replace(/\s+/g, '_')}_${permissionKey}`;
                                        const isChecked = rolePermissions.includes(fullPermissionKey);
                                        
                                        return (
                                            <label key={permissionKey} className="flex items-center space-x-2 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={isChecked}
                                                    onChange={(e) => handlePermissionToggle(fullPermissionKey, e.target.checked)}
                                                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                                />
                                                <div>
                                                    <span className="text-sm font-medium text-gray-900">
                                                        {permissionKey}
                                                    </span>
                                                    <p className="text-xs text-gray-500">{description}</p>
                                                </div>
                                            </label>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Super Admin Override */}
                    <div className="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <h6 className="text-sm font-semibold text-red-800 mb-2">Super Admin Override</h6>
                        <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                                type="checkbox"
                                checked={rolePermissions.includes('*')}
                                onChange={(e) => handlePermissionToggle('*', e.target.checked)}
                                className="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
                            />
                            <div>
                                <span className="text-sm font-medium text-red-900">
                                    Grant Super Admin Access (*)
                                </span>
                                <p className="text-xs text-red-600">
                                    This grants full access to all pages and actions. Use with extreme caution.
                                </p>
                            </div>
                        </label>
                    </div>
                </div>
            )}
        </div>
    );

    const renderModal = () => {
        if (!showModal) return null;

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-xl p-6 w-full max-w-md max-h-90vh overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold">
                            {modalType === 'add' ? 'Add' : 'Edit'} {tabs.find(t => t.id === activeTab)?.label}
                        </h3>
                        <button
                            onClick={() => setShowModal(false)}
                            className="text-gray-500 hover:text-gray-700"
                        >
                            <X size={20} />
                        </button>
                    </div>

                    <div className="space-y-4">
                        {/* Dynamic form fields based on active tab */}
                        {activeTab === 'campaigns' && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                                    <input
                                        type="text"
                                        value={formData.name || ''}
                                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea
                                        value={formData.description || ''}
                                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        rows="3"
                                    />
                                </div>
                            </>
                        )}

                        {activeTab === 'dataCodes' && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Code *</label>
                                    <input
                                        type="text"
                                        value={formData.code || ''}
                                        onChange={(e) => setFormData({ ...formData, code: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea
                                        value={formData.description || ''}
                                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        rows="3"
                                    />
                                </div>
                            </>
                        )}

                        {activeTab === 'bankNames' && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Bank Name *</label>
                                    <input
                                        type="text"
                                        value={formData.name || ''}
                                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                    <input
                                        type="text"
                                        value={formData.full_name || ''}
                                        onChange={(e) => setFormData({ ...formData, full_name: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Bank Code</label>
                                    <input
                                        type="text"
                                        value={formData.code || ''}
                                        onChange={(e) => setFormData({ ...formData, code: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                            </>
                        )}

                        {activeTab === 'departments' && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Department Name *</label>
                                    <input
                                        type="text"
                                        value={formData.name || ''}
                                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea
                                        value={formData.description || ''}
                                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        rows="3"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Parent Department</label>
                                    <select
                                        value={formData.parent_id || ''}
                                        onChange={(e) => setFormData({ ...formData, parent_id: e.target.value || null })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">No Parent</option>
                                        {departments.filter(d => d.id !== editingItem?.id).map(dept => (
                                            <option key={dept.id} value={dept.id}>{dept.name}</option>
                                        ))}
                                    </select>
                                </div>
                            </>
                        )}

                        {activeTab === 'roles' && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Role Name *</label>
                                    <input
                                        type="text"
                                        value={formData.name || ''}
                                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea
                                        value={formData.description || ''}
                                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        rows="3"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Department</label>
                                    <select
                                        value={formData.department_id || ''}
                                        onChange={(e) => setFormData({ ...formData, department_id: e.target.value || null })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">Select Department</option>
                                        {departments.map(dept => (
                                            <option key={dept.id} value={dept.id}>{dept.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Reporting Role</label>
                                    <select
                                        value={formData.reporting_id || ''}
                                        onChange={(e) => setFormData({ ...formData, reporting_id: e.target.value || null })}
                                        className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">No Reporting Role</option>
                                        {roles.filter(r => r.id !== editingItem?.id).map(role => (
                                            <option key={role.id} value={role.id}>{role.name}</option>
                                        ))}
                                    </select>
                                </div>
                            </>
                        )}

                        {/* Active status checkbox for all items */}
                        <div className="flex items-center">
                            <input
                                type="checkbox"
                                id="is_active"
                                checked={formData.is_active !== false}
                                onChange={(e) => setFormData({ ...formData, is_active: e.target.checked })}
                                className="mr-2"
                            />
                            <label htmlFor="is_active" className="text-sm font-medium text-gray-700">
                                Active
                            </label>
                        </div>
                    </div>

                    <div className="flex gap-3 mt-6">
                        <button
                            onClick={() => setShowModal(false)}
                            className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors"
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleSave}
                            disabled={loading}
                            className="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all disabled:opacity-50"
                        >
                            {loading ? 'Saving...' : 'Save'}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // Error state
    if (error) {
        return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                <div className="max-w-md w-full bg-white rounded-lg shadow-lg p-8 text-center">
                    <AlertCircle className="h-16 w-16 text-red-500 mx-auto mb-4" />
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">Error</h2>
                    <p className="text-red-600 mb-4">{error}</p>
                    <button
                        onClick={() => window.location.reload()}
                        className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                    >
                        Reload Page
                    </button>
                </div>
            </div>
        );
    }

    // Loading state
    if (!permissionsLoaded) {
        return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <p className="text-gray-600">Loading permissions...</p>
                </div>
            </div>
        );
    }

    // Access denied component
    if (!hasSettingsAccess) {
        return (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                <div className="max-w-md w-full bg-white rounded-lg shadow-lg p-8 text-center">
                    <Lock className="h-16 w-16 text-red-500 mx-auto mb-4" />
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">Access Denied</h2>
                    <p className="text-gray-600 mb-4">
                        You don't have permission to access the Settings page.
                        Please contact your administrator if you need access.
                    </p>
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div className="flex items-center">
                            <Shield className="h-5 w-5 text-red-500 mr-2" />
                            <span className="text-sm text-red-700">
                                Required permission: <code className="bg-red-100 px-2 py-1 rounded">settings.view</code>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-100">
            {/* Header */}
            <div className="bg-white shadow-sm border-b border-gray-200">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex items-center justify-between h-16">
                        <div className="flex items-center">
                            <Settings className="h-8 w-8 text-blue-600 mr-3" />
                            <h1 className="text-2xl font-bold text-gray-900">Settings Management</h1>
                        </div>
                    </div>
                </div>
            </div>

            {/* Tabs */}
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

                <div className="flex flex-wrap gap-2 mb-6">
                    {tabs.map((tab) => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${activeTab === tab.id
                                ? `bg-${tab.color}-500 text-white shadow-lg`
                                : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-200'
                                }`}
                        >
                            <tab.icon size={16} />
                            {tab.label}
                        </button>
                    ))}
                </div>

                {/* Content */}
                <div className="space-y-6">
                    {renderTabContent()}
                </div>
            </div>

            {/* Modal */}
            {renderModal()}
        </div>
    );
};

export default SettingsPage;
