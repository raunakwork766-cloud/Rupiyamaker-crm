import React, { useState, useEffect, useRef, useLayoutEffect } from 'react';
import { ChevronDown, Search } from 'lucide-react';
import { saveObligationData, loadSavedObligationData } from '../../utils/leadDataHelper';
import { saveObligationDataToAPIDebounced, prepareObligationData } from '../../utils/obligationDataHelper';

// API base URL
const API_BASE_URL = 'https://rupiya.me:8049';

// Get userId from localStorage
const getUserId = () => {
  try {
    const userId = localStorage.getItem('userId');
    console.log('ðŸ” Getting userId from localStorage:', userId);
    if (userId) return userId;
    
    // Try to get from user object
    const userData = localStorage.getItem('user');
    console.log('ðŸ” Getting user data from localStorage:', userData);
    if (userData) {
      const parsedUser = JSON.parse(userData);
      console.log('ðŸ” Parsed user data:', parsedUser);
      const id = parsedUser.id || parsedUser._id || parsedUser.user_id;
      console.log('ðŸ” Extracted user ID:', id);
      return id;
    }
    
    // Try to get from userData 
    const userDataAlt = localStorage.getItem('userData');
    console.log('ðŸ” Getting userData from localStorage:', userDataAlt);
    if (userDataAlt) {
      const parsedUserAlt = JSON.parse(userDataAlt);
      console.log('ðŸ” Parsed userData:', parsedUserAlt);
      const idAlt = parsedUserAlt.id || parsedUserAlt._id || parsedUserAlt.user_id;
      console.log('ðŸ” Extracted user ID from userData:', idAlt);
      return idAlt;
    }
    
    console.warn('âš ï¸ No user ID found in localStorage');
    return null;
  } catch (error) {
    console.error('âŒ Error getting user ID:', error);
    return null;
  }
};

// Fetch company names from Vakilsearch API with improved error handling
const fetchCompanyNames = async (companyName) => {
  try {
    const userId = getUserId();
    if (!userId) {
      console.warn('No user ID available for Vakilsearch API');
      return [];
    }
    
    if (!companyName || companyName.trim().length < 1) {
      // Don't make API calls for empty search terms
      return [];
    }
    
    console.log(`Fetching Vakilsearch data for company: ${companyName}`);
    const response = await fetch(`${API_BASE_URL}/settings/company-names-from-vakilsearch?company_name=${encodeURIComponent(companyName)}&user_id=${userId}`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Vakilsearch API response:', data);
    
    if (Array.isArray(data) && data.length > 0) {
      console.log(`Found ${data.length} companies from Vakilsearch`);
      return data;
    } else {
      console.log('No company matches found in Vakilsearch');
      return [];
    }
  } catch (error) {
    console.error('Error fetching company names from Vakilsearch:', error);
    // Return empty array on error
    return [];
  }
};

// Fetch company categories based on company name
const fetchCompanyCategoriesForCompany = async (companyName) => {
  try {
    const userId = getUserId();
    if (!userId) {
      console.error('No userId available for company categories API');
      return [];
    }
    if (!companyName) {
      console.error('No company name provided for categories API');
      return [];
    }
    
    console.log(`ðŸ” Fetching categories for company: "${companyName}" with userId: ${userId}`);
    
    // Using POST method with company_name and similarity_threshold
    const apiUrl = `${API_BASE_URL}/settings/search-companies?user_id=${userId}`;
    const requestBody = {
      company_name: companyName,
      similarity_threshold: 0.6
    };
    
    console.log(`ðŸ“¡ API Request:`, {
      url: apiUrl,
      method: 'POST',
      body: requestBody
    });
    
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(localStorage.getItem('token') && {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        })
      },
      body: JSON.stringify(requestBody)
    });
    
    console.log(`ðŸ“¤ Response status: ${response.status} ${response.statusText}`);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error(`âŒ API Error: ${response.status} - ${errorText}`);
      throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
    }
    
    const data = await response.json();
    console.log('ðŸ“¥ Raw API response for company categories:', {
      companyName,
      responseType: typeof data,
      isArray: Array.isArray(data),
      dataKeys: data && typeof data === 'object' ? Object.keys(data) : 'Not an object',
      dataLength: Array.isArray(data) ? data.length : 'Not an array',
      fullData: data
    });
    
    // Handle the new API response structure
    let categories = [];
    if (Array.isArray(data)) {
      // Return the data as-is since it matches the new structure
      categories = data;
      console.log(`âœ… Using direct array response with ${categories.length} items`);
    } else if (data.companies && Array.isArray(data.companies)) {
      categories = data.companies;
      console.log(`âœ… Using data.companies with ${categories.length} items`);
    } else if (data.categories && Array.isArray(data.categories)) {
      categories = data.categories;
      console.log(`âœ… Using data.categories with ${categories.length} items`);
    } else if (data.data && Array.isArray(data.data)) {
      categories = data.data;
      console.log(`âœ… Using data.data with ${categories.length} items`);
    } else {
      console.warn(`âš ï¸ Unexpected API response structure for company categories:`, data);
    }
    
    // Log first item structure if available
    if (categories.length > 0) {
      console.log(`ðŸ” First category item structure:`, {
        firstItem: categories[0],
        keys: Object.keys(categories[0] || {}),
        hasCompanyName: !!(categories[0]?.company_name),
        hasBankNames: !!(categories[0]?.bank_names),
        hasCategories: !!(categories[0]?.categories)
      });
    }
    
    // Return the raw data without transformation for the new structure
    console.log(`ðŸ“Š Returning ${categories.length} categories for "${companyName}"`);
    return categories;
  } catch (error) {
    console.error(`âŒ Error fetching company categories for "${companyName}":`, error);
    // Return empty array on error to show proper "no results" message
    return [];
  }
};

// Fetch bank names from settings API
const fetchBankNames = async () => {
  try {
    const userId = getUserId();
    if (!userId) return [];
    
    // Using the specific API endpoint for bank names
    const response = await fetch(`${API_BASE_URL}/settings/bank-names?user_id=${userId}`);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    console.log('Bank names response:', data);
    
    // Add "Custom" option to the list
    let bankNames = [];
    if (Array.isArray(data)) {
      bankNames = data;
    } else if (data.bank_names && Array.isArray(data.bank_names)) {
      bankNames = data.bank_names;
    } else if (data.data && Array.isArray(data.data)) {
      bankNames = data.data;
    }
    
    return [
      'Custom', // Always keep Custom as an option
      ...bankNames.map(bank => bank.name || bank)
    ];
  } catch (error) {
    console.error('Error fetching bank names:', error);
    return ['Custom']; // Return at least Custom option in case of error
  }
};

// Fetch company categories from settings API
const fetchCompanyCategories = async () => {
  try {
    const userId = getUserId();
    if (!userId) return [];
    
    // Note: This function is used for loading categories when no specific company is selected
    // Since the backend API requires a company name, we return empty array
    // Categories should be loaded via fetchCompanyCategoriesForCompany when a company is selected
    console.log('fetchCompanyCategories called - returning empty array as no specific company provided');
    return [];
  } catch (error) {
    console.error('Error fetching company categories:', error);
    return [];
  }
};

export default function CustomerObligationForm({ leadData, handleChangeFunc, onDataUpdate, onUnsavedChangesUpdate, canEdit = true }) {
  // Immediate safety check to prevent any initialization errors
  if (typeof React === 'undefined' || !React.useState) {
    console.error('React is not properly loaded');
    return <div>Loading...</div>;
  }
  
  // All State variables - moved to beginning to avoid initialization errors
  const [salary, setSalary] = useState('');
  const [partnerSalary, setPartnerSalary] = useState('');
  const [yearlyBonus, setYearlyBonus] = useState('');
  const [bonusDivision, setBonusDivision] = useState(null);
  const [loanRequired, setLoanRequired] = useState('');
  const [companyName, setCompanyName] = useState('');
  // Always initialize companyType as an array to prevent "companyType.map is not a function" error
  const [companyType, setCompanyType] = useState([]);
  const [showBankPopup, setShowBankPopup] = useState(false);
  const [companyCategory, setCompanyCategory] = useState([]);
  const [showCategoryPopup, setShowCategoryPopup] = useState(false);
  const [totalBtPos, setTotalBtPos] = useState('0');
  const [totalObligation, setTotalObligation] = useState('0');
  const [cibilScore, setCibilScore] = useState('');
  const [obligations, setObligations] = useState([
    {
      id: Date.now(), // Add unique ID
      product: '',
      bankName: '',
      tenure: '',
      roi: '',
      totalLoan: '',
      outstanding: '',
      emi: '',
      action: 'Obligate',
      selectedPercentage: null, // Keep for backward compatibility
      selectedTenurePercentage: null, // For 4% tenure button
      selectedRoiPercentage: null // For 5% ROI button
    }
  ]);
  
  // Unsaved changes detection
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const [showUnsavedChangesModal, setShowUnsavedChangesModal] = useState(false);
  const [originalData, setOriginalData] = useState({});
  const [isInitialLoad, setIsInitialLoad] = useState(true); // Track if data is being initially loaded
  const [hasUserInteraction, setHasUserInteraction] = useState(false); // Track if user has actually made any changes
  
  // Force re-render state for Credit Card button updates
  const [forceRender, setForceRender] = useState(0);
  
  // Bank list state from API
  const [bankList, setBankList] = useState(['Custom']);
  
  // Note: companyType now stores selected banks for "Decide Bank For Case" (supports multiple selection)

  // States for searchable dropdowns in obligation table - initialized with proper defaults to prevent initialization errors
  const [productSearchStates, setProductSearchStates] = useState({ 0: { isOpen: false, searchQuery: '' } });
  const [bankSearchStates, setBankSearchStates] = useState({ 0: { isOpen: false, searchQuery: '' } });
  
  // Company name dropdown states
  const [companyDropdownOpen, setCompanyDropdownOpen] = useState(false);
  const [companySuggestions, setCompanySuggestions] = useState([]);
  const [isCompanyLoading, setIsCompanyLoading] = useState(false);
  const [companySearchTimeout, setCompanySearchTimeout] = useState(null);
  const [isSelectingFromDropdown, setIsSelectingFromDropdown] = useState(false);
  
  // Company dropdown ref for positioning
  const companyDropdownRef = useRef(null);

  // Notify parent component when unsaved changes state updates
  useEffect(() => {
    if (onUnsavedChangesUpdate && typeof onUnsavedChangesUpdate === 'function') {
      onUnsavedChangesUpdate(hasUnsavedChanges, () => setShowUnsavedChangesModal(true));
    }
  }, [hasUnsavedChanges, onUnsavedChangesUpdate]);
  
  // Emergency safety check - ensure states are always defined
  const safeProductSearchStates = productSearchStates || {};
  const safeBankSearchStates = bankSearchStates || {};
  
  // Used for tracking if a bank list API call is in progress
  const [bankListLoaded, setBankListLoaded] = useState(false);
  
  // Eligibility states - moved here to avoid initialization errors
  const [eligibility, setEligibility] = useState({
    totalIncome: '',
    foirAmount: '',
    totalObligations: '',
    totalBtPos: '',
    finalEligibility: '',
    multiplierEligibility: ''
  });
  
  // Check Eligibility section states - moved here to be available for useEffects
  const [loanEligibilityStatus, setLoanEligibilityStatus] = useState('Not Eligible');
  
  const [ceCompanyCategory, setCeCompanyCategory] = useState('');
  const [ceFoirPercent, setCeFoirPercent] = useState(60);
  const [ceCustomFoirPercent, setCeCustomFoirPercent] = useState('');
  const [ceMonthlyEmiCanPay, setCeMonthlyEmiCanPay] = useState(0);
  const [ceTenureMonths, setCeTenureMonths] = useState('');
  const [ceTenureYears, setCeTenureYears] = useState('');
  const [ceRoi, setCeRoi] = useState('');
  const [ceMultiplier, setCeMultiplier] = useState('0');

  // State to track if data has been loaded to prevent continuous API calls
  const [dataLoaded, setDataLoaded] = useState(false);
  const [lastLoadedLeadId, setLastLoadedLeadId] = useState(null);

  // Load saved obligation data from API when component mounts
  useEffect(() => {
    const fetchObligationData = async () => {
      // Only fetch if we have a different lead or haven't loaded data yet
      const currentLeadId = leadData?._id;
      if (currentLeadId && currentLeadId !== lastLoadedLeadId) {
        setIsInitialLoad(true); // Mark as initial load when loading new lead data
        setHasUserInteraction(false); // Reset user interaction flag for new lead
        try {
          const userId = getUserId();
          if (!userId) {
            console.warn('No user ID available');
            return;
          }
          
          setLastLoadedLeadId(currentLeadId);
          
          // Use the dedicated obligations endpoint
          const apiUrl = `${API_BASE_URL}/leads/${currentLeadId}/obligations?user_id=${userId}`;
          
          const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const savedData = await response.json();
          
          // Fallback to legacy data location if the new endpoint doesn't return data
          if (!savedData || Object.keys(savedData).length === 0) {
            const legacyData = leadData?.dynamic_fields?.obligation_data || loadSavedObligationData();
            if (legacyData && Object.keys(legacyData).length > 0) {
              processObligationData(legacyData);
              setDataLoaded(true);
              return;
            }
          } else {
            // Process the API data
            processObligationData(savedData);
            setDataLoaded(true);
          }
        } catch (error) {
          console.error('Error fetching obligation data:', error);
          // Fallback to local data if API call fails
          const localData = leadData?.dynamic_fields?.obligation_data || loadSavedObligationData();
          if (localData && Object.keys(localData).length > 0) {
            processObligationData(localData);
            setDataLoaded(true);
          }
        }
      } else if (!dataLoaded && !currentLeadId) {
        // No lead ID, load from local storage only if we haven't loaded data yet
        const localData = loadSavedObligationData();
        if (localData && Object.keys(localData).length > 0) {
          processObligationData(localData);
          setDataLoaded(true);
        }
      }
    };
    
    // Helper function to process obligation data and update state
    const processObligationData = (savedData) => {
      if (!savedData || Object.keys(savedData).length === 0) return;
      
      // Store original data for unsaved changes detection
      const currentData = {
        salary: savedData.salary || savedData.dynamic_fields?.financial_details?.monthly_income || '',
        partnerSalary: savedData.partnerSalary || savedData.dynamic_fields?.financial_details?.partner_salary || '',
        yearlyBonus: savedData.yearlyBonus || savedData.dynamic_fields?.financial_details?.yearly_bonus || '',
        bonusDivision: savedData.bonusDivision || savedData.dynamic_fields?.financial_details?.bonus_division || null,
        loanRequired: savedData.loanRequired || '',
        companyName: savedData.companyName || savedData.dynamic_fields?.personal_details?.company_name || '',
        companyType: savedData.companyType || savedData.dynamic_fields?.personal_details?.company_type || [],
        companyCategory: savedData.companyCategory || savedData.dynamic_fields?.personal_details?.company_category || [],
        cibilScore: savedData.cibilScore || savedData.dynamic_fields?.financial_details?.cibil_score || '',
        obligations: savedData.obligations || [],
        totalBtPos: savedData.totalBtPos || '0',
        totalObligation: savedData.totalObligation || '0'
      };
      setOriginalData(currentData);
      setHasUnsavedChanges(false);
      setIsInitialLoad(false); // Mark initial loading as complete
      setHasUserInteraction(false); // Reset user interaction flag when data is loaded
      
      // Try to fetch bank names in the background if not already loaded
      if (!bankListLoaded) {
        fetchBankNames().then(bankNames => {
          if (Array.isArray(bankNames) && bankNames.length > 0) {
            const normalizedBankNames = bankNames.map(bank => 
              typeof bank === 'string' ? bank : (bank.name || bank.label || String(bank))
            );
            
            // Always include 'Custom' if not already in the list
            if (!normalizedBankNames.includes('Custom')) {
              normalizedBankNames.unshift('Custom');
            }
            
            setBankList(normalizedBankNames);
            setBankListLoaded(true);
          }
        }).catch(error => {
          console.error('Error fetching bank names:', error);
        });
      }
      
      // First look for data in the top level of savedData
      // Then check leadData.dynamic_fields.financial_details, personal_details, check_eligibility
      
      // Restore form fields from saved data
      // For salary, check multiple possible locations based on the JSON structure
      if (savedData.salary) {
        setSalary(savedData.salary);
      } else if (savedData.dynamic_fields?.financial_details?.monthly_income) {
        setSalary(String(savedData.dynamic_fields.financial_details.monthly_income));
      }
      
      // Partner salary - check multiple locations
      if (savedData.partnerSalary) {
        setPartnerSalary(savedData.partnerSalary);
      } else if (savedData.dynamic_fields?.financial_details?.partner_salary) {
        setPartnerSalary(String(savedData.dynamic_fields.financial_details.partner_salary));
      }
      
      // Yearly bonus - check multiple locations
      if (savedData.yearlyBonus) {
        setYearlyBonus(savedData.yearlyBonus);
      } else if (savedData.dynamic_fields?.financial_details?.yearly_bonus) {
        setYearlyBonus(String(savedData.dynamic_fields.financial_details.yearly_bonus));
      }
      
      // Bonus division - check multiple locations
      if (savedData.bonusDivision) {
        setBonusDivision(savedData.bonusDivision);
      } else if (savedData.dynamic_fields?.financial_details?.bonus_division) {
        setBonusDivision(savedData.dynamic_fields.financial_details.bonus_division);
      }
      
      // Loan required amount
      console.log("Loading loan amount data:", {
        loanRequired: savedData.loanRequired,
        loan_amount: savedData.loan_amount,
        loan_required_from_financial: savedData.dynamic_fields?.financial_details?.loan_required,
        loan_amount_from_financial: savedData.dynamic_fields?.financial_details?.loan_amount,
        loan_amount_from_process: savedData.dynamic_fields?.process?.loan_amount,
        loan_amount_required_from_process: savedData.dynamic_fields?.process?.loan_amount_required
      });
      
      if (savedData.loanRequired) {
        setLoanRequired(savedData.loanRequired);
        console.log("Using loanRequired:", savedData.loanRequired);
      } else if (savedData.loan_amount) {
        setLoanRequired(String(savedData.loan_amount));
        console.log("Using loan_amount:", savedData.loan_amount);
      }
      
      // Company name - check multiple locations
      if (savedData.companyName) {
        setCompanyName(savedData.companyName);
      } else if (savedData.dynamic_fields?.personal_details?.company_name) {
        setCompanyName(savedData.dynamic_fields.personal_details.company_name);
      }
      
      // Company type - check multiple locations and ensure it's an array
      if (savedData.companyType) {
        // If it's a string (like "government"), convert it to an array for backwards compatibility
        if (typeof savedData.companyType === 'string') {
          setCompanyType([savedData.companyType]);
        } else if (Array.isArray(savedData.companyType)) {
          setCompanyType(savedData.companyType);
        } else {
          setCompanyType([]); // Fallback to empty array
        }
      } else if (savedData.dynamic_fields?.personal_details?.company_type) {
        const companyTypeValue = savedData.dynamic_fields.personal_details.company_type;
        // If it's a string (like "government"), convert it to an array for backwards compatibility
        if (typeof companyTypeValue === 'string') {
          setCompanyType([companyTypeValue]);
        } else if (Array.isArray(companyTypeValue)) {
          setCompanyType(companyTypeValue);
        } else {
          setCompanyType([]); // Fallback to empty array
        }
      }
      
      // Company category - check multiple locations and ensure it's an array
      if (savedData.companyCategory) {
        // If it's a string (like "Category B"), convert it to an array for backwards compatibility
        if (typeof savedData.companyCategory === 'string') {
          setCompanyCategory([savedData.companyCategory]);
        } else if (Array.isArray(savedData.companyCategory)) {
          setCompanyCategory(savedData.companyCategory);
        } else {
          setCompanyCategory([]); // Fallback to empty array
        }
      } else if (savedData.dynamic_fields?.personal_details?.company_category) {
        const companyCategoryValue = savedData.dynamic_fields.personal_details.company_category;
        // If it's a string (like "Category B"), convert it to an array for backwards compatibility
        if (typeof companyCategoryValue === 'string') {
          setCompanyCategory([companyCategoryValue]);
        } else if (Array.isArray(companyCategoryValue)) {
          setCompanyCategory(companyCategoryValue);
        } else {
          setCompanyCategory([]); // Fallback to empty array
        }
      }
      
      // CIBIL score - check multiple locations
      if (savedData.cibilScore) {
        setCibilScore(savedData.cibilScore);
      } else if (savedData.dynamic_fields?.financial_details?.cibil_score) {
        setCibilScore(savedData.dynamic_fields.financial_details.cibil_score);
      }
      
      // Processing bank - check multiple locations
      if (savedData.processingBank) {
        // If it's a string, convert to array for multiple bank support
        setCompanyType(Array.isArray(savedData.processingBank) ? savedData.processingBank : [savedData.processingBank]);
      } else if (savedData.processing_bank) {
        setCompanyType(Array.isArray(savedData.processing_bank) ? savedData.processing_bank : [savedData.processing_bank]);
      } else if (savedData.selectedBanks) {
        setCompanyType(Array.isArray(savedData.selectedBanks) ? savedData.selectedBanks : [savedData.selectedBanks]);
      }
      
      // Handle FOIR settings - check multiple locations
      const checkEligibilityData = savedData.check_eligibility || savedData.dynamic_fields?.check_eligibility;
      if (savedData.foirPercent || savedData.ceFoirPercent || 
          (checkEligibilityData && (checkEligibilityData.foir_percent || checkEligibilityData.custom_foir_percent))) {
        
        // Get FOIR percent from all possible locations
        const foirValue = savedData.foirPercent || 
                         savedData.ceFoirPercent || 
                         (checkEligibilityData && checkEligibilityData.foir_percent);
        
        if (foirValue === 'custom') {
          setCeFoirPercent('custom');
          // Get custom FOIR from all possible locations
          const customValue = savedData.customFoirPercent || 
                             savedData.ceCustomFoirPercent ||
                             (checkEligibilityData && checkEligibilityData.custom_foir_percent);
          
          if (customValue) setCeCustomFoirPercent(customValue);
        } else {
          setCeFoirPercent(foirValue);
        }
      }
      
      // Load obligations - check both direct and in dynamic_fields
      if (savedData.obligations && savedData.obligations.length > 0) {
        // Ensure Credit Card percentage fields are included when loading from direct obligations
        const processedObligations = savedData.obligations.map((obl, index) => {
          return {
            ...obl,
            id: obl.id || Date.now() + index + Math.random(), // Ensure unique ID for proper React tracking
            // Ensure null/0 values are displayed as empty strings instead of "0"
            tenure: obl.tenure && obl.tenure !== 0 && obl.tenure !== '0' ? String(obl.tenure) : '',
            roi: obl.roi && obl.roi !== 0 && obl.roi !== '0' ? String(obl.roi) : '',
            totalLoan: obl.totalLoan && obl.totalLoan !== 0 && obl.totalLoan !== '0' ? String(obl.totalLoan) : '',
            outstanding: obl.outstanding && obl.outstanding !== 0 && obl.outstanding !== '0' ? String(obl.outstanding) : '',
            emi: obl.emi && obl.emi !== 0 && obl.emi !== '0' ? String(obl.emi) : '',
            action: (obl.action && obl.action.trim() !== '') ? obl.action : 'Obligate',
            selectedPercentage: obl.selectedPercentage || null, // Keep for backward compatibility
            selectedTenurePercentage: obl.selectedTenurePercentage ? parseInt(obl.selectedTenurePercentage) : null, // Ensure integer for 4% tenure button
            selectedRoiPercentage: obl.selectedRoiPercentage ? parseInt(obl.selectedRoiPercentage) : null // Ensure integer for 5% ROI button
          };
        });
        setObligations(processedObligations);
        
        // React will handle re-rendering automatically when obligations change
      } else if (savedData.dynamic_fields?.obligations && savedData.dynamic_fields.obligations.length > 0) {
        // Map from backend format to frontend format if necessary
        const mappedObligations = savedData.dynamic_fields.obligations.map((obl, index) => {
          return {
            id: obl.id || Date.now() + index + Math.random(), // Ensure unique ID for proper React tracking
            product: obl.product || '',
            bankName: obl.bank_name || '',
            tenure: obl.tenure && obl.tenure !== 0 && obl.tenure !== '0' ? String(obl.tenure) : '',
            roi: obl.roi && obl.roi !== 0 && obl.roi !== '0' ? String(obl.roi) : '',
            totalLoan: obl.total_loan && obl.total_loan !== 0 && obl.total_loan !== '0' ? String(obl.total_loan) : '',
            outstanding: obl.outstanding && obl.outstanding !== 0 && obl.outstanding !== '0' ? String(obl.outstanding) : '',
            emi: obl.emi && obl.emi !== 0 && obl.emi !== '0' ? String(obl.emi) : '',
            action: (obl.action && obl.action.trim() !== '') ? obl.action : 'Obligate',
            selectedPercentage: obl.selectedPercentage || obl.selected_percentage || null, // Keep for backward compatibility
            selectedTenurePercentage: (obl.selectedTenurePercentage || obl.selected_tenure_percentage) ? parseInt(obl.selectedTenurePercentage || obl.selected_tenure_percentage) : null, // Ensure integer for 4% tenure button
            selectedRoiPercentage: (obl.selectedRoiPercentage || obl.selected_roi_percentage) ? parseInt(obl.selectedRoiPercentage || obl.selected_roi_percentage) : null // Ensure integer for 5% ROI button
          };
        });
        setObligations(mappedObligations);
        
        // React will handle re-rendering automatically when obligations change
      }
      
      // Ensure at least one default obligation exists with correct action if no obligations were loaded
      if (!savedData.obligations || savedData.obligations.length === 0) {
        if (!savedData.dynamic_fields?.obligations || savedData.dynamic_fields.obligations.length === 0) {
          // No obligations found in either location, ensure default obligation with correct action
          setObligations([{
            id: Date.now(),
            product: '',
            bankName: '',
            tenure: '',
            roi: '',
            totalLoan: '',
            outstanding: '',
            emi: '',
            action: 'Obligate', // Ensure default action is Obligate
            selectedPercentage: null,
            selectedTenurePercentage: null,
            selectedRoiPercentage: null
          }]);
        }
      }
      
      // Load calculated totals
      if (savedData.totalBtPos) {
        setTotalBtPos(savedData.totalBtPos);
      } else if (savedData.dynamic_fields?.eligibility_details?.totalBtPos) {
        setTotalBtPos(savedData.dynamic_fields.eligibility_details.totalBtPos);
      }
      
      if (savedData.totalObligation) {
        setTotalObligation(savedData.totalObligation);
      } else if (savedData.dynamic_fields?.eligibility_details?.totalObligations) {
        setTotalObligation(savedData.dynamic_fields.eligibility_details.totalObligations);
      }
      
      // Load eligibility data from all possible locations
      const eligibilityDetails = savedData.eligibility || savedData.dynamic_fields?.eligibility_details;
      if (eligibilityDetails) {
        setEligibility({
          totalIncome: eligibilityDetails.totalIncome || '',
          foirAmount: eligibilityDetails.foirAmount || '',
          totalObligations: eligibilityDetails.totalObligations || '',
          totalBtPos: eligibilityDetails.totalBtPos || '',
          finalEligibility: eligibilityDetails.finalEligibility || '',
          multiplierEligibility: eligibilityDetails.multiplierEligibility || ''
        });
      }
      
      // Check eligibility fields from all possible locations
      if (savedData.ceCompanyCategory || (checkEligibilityData && checkEligibilityData.company_category)) {
        setCeCompanyCategory(savedData.ceCompanyCategory || (checkEligibilityData && checkEligibilityData.company_category));
      }
      
      if (savedData.ceMonthlyEmiCanPay || (checkEligibilityData && checkEligibilityData.monthly_emi_can_pay)) {
        setCeMonthlyEmiCanPay(savedData.ceMonthlyEmiCanPay || (checkEligibilityData && checkEligibilityData.monthly_emi_can_pay));
      }
      
      if (savedData.ceTenureMonths || (checkEligibilityData && checkEligibilityData.tenure_months)) {
        setCeTenureMonths(savedData.ceTenureMonths || (checkEligibilityData && checkEligibilityData.tenure_months));
      }
      
      if (savedData.ceTenureYears || (checkEligibilityData && checkEligibilityData.tenure_years)) {
        setCeTenureYears(savedData.ceTenureYears || (checkEligibilityData && checkEligibilityData.tenure_years));
      }
      
      if (savedData.ceRoi || (checkEligibilityData && checkEligibilityData.roi)) {
        setCeRoi(savedData.ceRoi || (checkEligibilityData && checkEligibilityData.roi));
      }
      
      // Handle multiplier with robust default value logic; default to 0 when not present
      let multiplierValue = undefined;
      if (savedData && savedData.ceMultiplier !== undefined && savedData.ceMultiplier !== null) {
        multiplierValue = savedData.ceMultiplier;
      } else if (checkEligibilityData && checkEligibilityData.multiplier !== undefined && checkEligibilityData.multiplier !== null) {
        multiplierValue = checkEligibilityData.multiplier;
      }
      if (multiplierValue !== undefined && multiplierValue !== null) {
        setCeMultiplier(String(multiplierValue));
      } else {
        // Default multiplier to '0' when no data is provided
        setCeMultiplier('0');
      }
      
      if (savedData.loanEligibilityStatus || (checkEligibilityData && checkEligibilityData.loan_eligibility_status)) {
        setLoanEligibilityStatus(savedData.loanEligibilityStatus || (checkEligibilityData && checkEligibilityData.loan_eligibility_status));
      }
    };
    
    fetchObligationData();
    
    // Ensure initial load flag is reset even if no data is loaded
    setTimeout(() => {
      setIsInitialLoad(false);
      // Don't reset hasUserInteraction here - let it stay false until actual user action
    }, 100);
  }, [leadData, bankListLoaded]);

  // Function to check if current data differs from original data
  const hasDataChanged = () => {
    if (!originalData || Object.keys(originalData).length === 0) {
      console.log("No original data available, cannot determine changes");
      return false;
    }
    
    const currentData = {
      salary,
      partnerSalary,
      yearlyBonus,
      bonusDivision,
      loanRequired,
      companyName,
      companyType,
      companyCategory,
      cibilScore,
      obligations,
      totalBtPos,
      totalObligation
    };
    
    // Log current and original data for debugging
    console.log("Checking for changes - Current data:", currentData);
    console.log("Checking for changes - Original data:", originalData);
    
    // Deep comparison of objects
    const hasChanged = JSON.stringify(currentData) !== JSON.stringify(originalData);
    console.log("Data has changed:", hasChanged);
    
    return hasChanged;
  };

  // Function to mark data as changed
  const markAsChanged = () => {
    setHasUserInteraction(true); // Mark that user has interacted with the form
    
    // Force hasUnsavedChanges to true whenever user makes any change
    setHasUnsavedChanges(true);
    
    // Log debug info
    console.log("User interaction detected - marking as changed");
    console.log("Current hasUnsavedChanges state:", hasUnsavedChanges);
    console.log("Has data changed:", hasDataChanged());
  };

  // Handle beforeunload event to warn about unsaved changes
  useEffect(() => {
    const handleBeforeUnload = (e) => {
      if (hasUnsavedChanges && hasDataChanged()) {
        e.preventDefault();
        e.returnValue = ''; // For most browsers
        setShowUnsavedChangesModal(true);
        return ''; // For older browsers
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [hasUnsavedChanges]);

  // Force re-render for Credit Card button states when obligations change
  useEffect(() => {
    const creditCardObligations = obligations.filter(obl => obl.product === 'CC (Credit Card)');
    if (creditCardObligations.length > 0) {
      // React will handle re-rendering automatically when obligations change
      // No need to force re-render which can cause infinite loops
    }
  }, [obligations]);

  // Enhanced save function that resets unsaved changes
  const handleSaveObligationsWithChangeTracking = async () => {
    try {
      console.log("=== SAVE BUTTON CLICKED ===");
      console.log("hasUnsavedChanges:", hasUnsavedChanges);
      console.log("hasUserInteraction:", hasUserInteraction);
      console.log("Current data:", {
        salary,
        partnerSalary,
        yearlyBonus,
        bonusDivision,
        loanRequired,
        companyName,
        companyType,
        companyCategory,
        cibilScore,
        obligations,
        totalBtPos,
        totalObligation,
        // Additional fields
        ceCompanyCategory,
        ceFoirPercent,
        ceCustomFoirPercent,
        ceMonthlyEmiCanPay,
        ceTenureMonths,
        ceTenureYears,
        ceRoi,
        ceMultiplier,
        loanEligibilityStatus
      });
      
      // Force proceed with save operation regardless of change detection
      await handleSaveObligations();
      
      // Update original data to current state after successful save
      const savedData = {
        salary,
        partnerSalary,
        yearlyBonus,
        bonusDivision,
        loanRequired,
        companyName,
        companyType,
        companyCategory,
        cibilScore,
        obligations,
        totalBtPos,
        totalObligation,
        // Include additional fields
        ceCompanyCategory,
        ceFoirPercent,
        ceCustomFoirPercent,
        ceMonthlyEmiCanPay,
        ceTenureMonths,
        ceTenureYears,
        ceRoi,
        ceMultiplier,
        loanEligibilityStatus
      };
      setOriginalData(savedData);
      setHasUnsavedChanges(false);
      setHasUserInteraction(false);
      
      console.log("Save completed successfully");
    } catch (error) {
      console.error('Error saving obligations:', error);
      alert("Failed to save changes. Please try again.");
    }
  };

  // Initialize search states when obligations are loaded
  useEffect(() => {
    const initialProductSearchStates = {};
    const initialBankSearchStates = {};
    
    obligations.forEach((_, index) => {
      initialProductSearchStates[index] = { isOpen: false, searchQuery: '' };
      initialBankSearchStates[index] = { isOpen: false, searchQuery: '' };
    });
    
    setProductSearchStates(initialProductSearchStates);
    setBankSearchStates(initialBankSearchStates);
  }, [obligations.length]);

  // Focus search input when dropdown opens - with proper guards against initialization errors
  useEffect(() => {
    try {
      // Guard: Only proceed if productSearchStates is properly initialized
      if (safeProductSearchStates && typeof safeProductSearchStates === 'object' && Object.keys(safeProductSearchStates).length > 0) {
        Object.keys(safeProductSearchStates).forEach(idx => {
          if (safeProductSearchStates[idx]?.isOpen) {
            setTimeout(() => {
              const input = document.querySelector(`[data-search-input="product"]`);
              if (input) input.focus();
            }, 50);
          }
        });
      }
      
      // Guard: Only proceed if bankSearchStates is properly initialized
      if (safeBankSearchStates && typeof safeBankSearchStates === 'object' && Object.keys(safeBankSearchStates).length > 0) {
        Object.keys(safeBankSearchStates).forEach(idx => {
          if (safeBankSearchStates[idx]?.isOpen) {
            setTimeout(() => {
              const input = document.querySelector(`[data-search-input="bank"]`);
              if (input) input.focus();
            }, 50);
          }
        });
      }
    } catch (error) {
      console.warn('Error in focus effect:', error);
    }
  }, [productSearchStates, bankSearchStates]);

  // Close dropdowns when clicking outside or scrolling
  useEffect(() => {
    const handleClickOutside = (event) => {
      // Check if click is inside any dropdown or popup
      const clickedElement = event.target;
      const isInsideDropdown = clickedElement.closest('[data-dropdown-container]') || 
                              clickedElement.closest('.fixed.z-\\[9999\\]') ||
                              clickedElement.closest('.fixed.z-50') || // CategoryPopup uses z-50
                              clickedElement.closest('[data-dropdown-trigger]') ||
                              clickedElement.closest('[data-category-popup-container]') || // CategoryPopup container
                              clickedElement.closest('[data-category-popup-backdrop]') || // CategoryPopup backdrop
                              clickedElement.closest('[data-category-popup-item]') || // CategoryPopup items
                              clickedElement.closest('.bg-transparent.backdrop-blur-sm'); // CategoryPopup container
      
      if (!isInsideDropdown) {
        closeAllDropdowns();
      }
    };

    const handleScroll = (event) => {
      // Check if scrolling is happening inside a dropdown container
      const scrolledElement = event.target;
      const isInsideDropdown = scrolledElement.closest('[data-dropdown-container]') || 
                              scrolledElement.closest('.fixed.z-\\[9999\\]') ||
                              scrolledElement.closest('[data-dropdown-scroll]') ||
                              scrolledElement.hasAttribute('data-dropdown-scroll') ||
                              scrolledElement.classList.contains('max-h-60') ||
                              scrolledElement.classList.contains('max-h-48') ||
                              scrolledElement.classList.contains('overflow-y-auto');
      
      // Only close dropdowns if scrolling is NOT inside a dropdown
      if (!isInsideDropdown) {
        closeAllDropdowns();
      }
    };

    const handleResize = () => {
      // Close all dropdowns when window is resized
      closeAllDropdowns();
    };

    // Add event listeners
    document.addEventListener('mousedown', handleClickOutside);
    window.addEventListener('scroll', handleScroll, true); // Use capture to catch all scroll events
    window.addEventListener('resize', handleResize);
    
    return () => {
      // Cleanup event listeners
      document.removeEventListener('mousedown', handleClickOutside);
      window.removeEventListener('scroll', handleScroll, true);
      window.removeEventListener('resize', handleResize);
    };
  }, []);

  // Re-initialize when leadData changes (e.g., when switching tabs and coming back)
  useEffect(() => {
    if (leadData && leadData._id) {
      // Reset dataLoaded to allow re-initialization
      setDataLoaded(false);
      
      // Process the updated lead data
      const processObligationData = (savedData) => {
        if (!savedData || Object.keys(savedData).length === 0) return;
        
        // Update all state variables with the new data
        // Salary - check multiple locations
        if (savedData.salary) {
          setSalary(savedData.salary);
        } else if (savedData.dynamic_fields?.financial_details?.monthly_income) {
          setSalary(savedData.dynamic_fields.financial_details.monthly_income);
        } else if (savedData.dynamic_fields?.personal_details?.salary) {
          setSalary(savedData.dynamic_fields.personal_details.salary);
        }
        
        // Partner salary
        if (savedData.partnerSalary) {
          setPartnerSalary(savedData.partnerSalary);
        } else if (savedData.dynamic_fields?.financial_details?.partner_salary) {
          setPartnerSalary(savedData.dynamic_fields.financial_details.partner_salary);
        }
        
        // Yearly bonus
        if (savedData.yearlyBonus) {
          setYearlyBonus(savedData.yearlyBonus);
        } else if (savedData.dynamic_fields?.financial_details?.yearly_bonus) {
          setYearlyBonus(savedData.dynamic_fields.financial_details.yearly_bonus);
        }
        
        // Bonus division
        if (savedData.bonusDivision) {
          setBonusDivision(savedData.bonusDivision);
        } else if (savedData.dynamic_fields?.financial_details?.bonus_division) {
          setBonusDivision(savedData.dynamic_fields.financial_details.bonus_division);
        }
        
        // Loan required
        console.log("Loading loan amount data (dynamic fields):", {
          loanRequired: savedData.loanRequired,
          loan_amount: savedData.loan_amount,
          loan_required_from_financial: savedData.dynamic_fields?.financial_details?.loan_required,
          loan_amount_from_financial: savedData.dynamic_fields?.financial_details?.loan_amount,
          loan_amount_from_process: savedData.dynamic_fields?.process?.loan_amount,
          loan_amount_required_from_process: savedData.dynamic_fields?.process?.loan_amount_required
        });
        
        if (savedData.loanRequired) {
          setLoanRequired(savedData.loanRequired);
          console.log("Using loanRequired:", savedData.loanRequired);
        } else if (savedData.loan_amount) {
          setLoanRequired(String(savedData.loan_amount));
          console.log("Using loan_amount:", savedData.loan_amount);
        } else if (savedData.dynamic_fields?.financial_details?.loan_required) {
          setLoanRequired(savedData.dynamic_fields.financial_details.loan_required);
          console.log("Using financial_details.loan_required:", savedData.dynamic_fields.financial_details.loan_required);
        } else if (savedData.dynamic_fields?.financial_details?.loan_amount) {
          setLoanRequired(String(savedData.dynamic_fields.financial_details.loan_amount));
          console.log("Using financial_details.loan_amount:", savedData.dynamic_fields.financial_details.loan_amount);
        } else if (savedData.dynamic_fields?.process?.loan_amount) {
          setLoanRequired(String(savedData.dynamic_fields.process.loan_amount));
          console.log("Using process.loan_amount:", savedData.dynamic_fields.process.loan_amount);
        } else if (savedData.dynamic_fields?.process?.loan_amount_required) {
          setLoanRequired(String(savedData.dynamic_fields.process.loan_amount_required));
          console.log("Using process.loan_amount_required:", savedData.dynamic_fields.process.loan_amount_required);
        }
        
        // Company name
        if (savedData.companyName) {
          setCompanyName(savedData.companyName);
        } else if (savedData.dynamic_fields?.personal_details?.company_name) {
          setCompanyName(savedData.dynamic_fields.personal_details.company_name);
        }
        
        // Company type (banks) - check multiple locations
        if (savedData.companyType && Array.isArray(savedData.companyType)) {
          setCompanyType(savedData.companyType);
        } else if (savedData.selectedBanks && Array.isArray(savedData.selectedBanks)) {
          setCompanyType(savedData.selectedBanks);
        } else if (savedData.processing_banks && Array.isArray(savedData.processing_banks)) {
          setCompanyType(savedData.processing_banks);
        } else if (savedData.bank_name) {
          // If bank_name is a string, split it into array
          const bankNames = savedData.bank_name.split(',').map(name => name.trim()).filter(name => name);
          setCompanyType(bankNames);
        }
        
        // Company category
        if (savedData.companyCategory && Array.isArray(savedData.companyCategory)) {
          setCompanyCategory(savedData.companyCategory);
        } else if (savedData.dynamic_fields?.personal_details?.company_category) {
          const categoriesValue = savedData.dynamic_fields.personal_details.company_category;
          setCompanyCategory(Array.isArray(categoriesValue) ? categoriesValue : [categoriesValue]);
        }
        
        // CIBIL score
        if (savedData.cibilScore) {
          setCibilScore(savedData.cibilScore);
        } else if (savedData.dynamic_fields?.financial_details?.cibil_score) {
          setCibilScore(savedData.dynamic_fields.financial_details.cibil_score);
        }
        
        // FOIR settings
        const checkEligibilityData = savedData.check_eligibility || savedData.dynamic_fields?.check_eligibility;
        if (checkEligibilityData) {
          if (checkEligibilityData.foir_percent) {
            setCeFoirPercent(checkEligibilityData.foir_percent);
          }
          if (checkEligibilityData.custom_foir_percent) {
            setCeCustomFoirPercent(checkEligibilityData.custom_foir_percent);
          }
          if (checkEligibilityData.total_bt_pos) {
            setTotalBtPos(checkEligibilityData.total_bt_pos);
          }
          if (checkEligibilityData.total_obligation) {
            setTotalObligation(checkEligibilityData.total_obligation);
          }
          if (checkEligibilityData.eligibility) {
            setEligibility(checkEligibilityData.eligibility);
          }
          if (checkEligibilityData.loan_eligibility_status) {
            setLoanEligibilityStatus(checkEligibilityData.loan_eligibility_status);
          }
        }
        
        // Load obligations
        if (savedData.obligations && Array.isArray(savedData.obligations) && savedData.obligations.length > 0) {
          setObligations(savedData.obligations);
        } else if (savedData.dynamic_fields?.obligations && Array.isArray(savedData.dynamic_fields.obligations)) {
          const mappedObligations = savedData.dynamic_fields.obligations.map(obl => ({
            product: obl.product || '',
            bankName: obl.bank_name || '',
            tenure: obl.tenure ? String(obl.tenure) : '',
            roi: obl.roi ? String(obl.roi) : '',
            totalLoan: obl.total_loan ? String(obl.total_loan) : '',
            outstanding: obl.outstanding ? String(obl.outstanding) : '',
            emi: obl.emi ? String(obl.emi) : '',
            action: obl.action || 'Obligate'
          }));
          setObligations(mappedObligations);
        }
        
        setDataLoaded(true);
      };
      
      // Process current lead data
      processObligationData(leadData);
      
      // Also check if there's obligation_data in dynamic_fields
      if (leadData.dynamic_fields?.obligation_data) {
        processObligationData(leadData.dynamic_fields.obligation_data);
      }
    }
  }, [leadData?._id, leadData?.dynamic_fields]);

  // Create a function to prepare obligation data that we'll use with the Save button
  // Instead of autosaving on every field change which causes loop API calls
  const prepareObligationDataForSave = () => {
    // Determine effective company name - use first company from categories if available, otherwise use companyName
    let effectiveCompanyName = companyName;
    
    console.log('=== COMPANY NAME CALCULATION DEBUG ===');
    console.log('prepareObligationDataForSave - Initial companyName:', companyName);
    console.log('prepareObligationDataForSave - companyCategory:', companyCategory);
    console.log('companyCategory type:', typeof companyCategory);
    console.log('companyCategory isArray:', Array.isArray(companyCategory));
    console.log('companyCategory length:', Array.isArray(companyCategory) ? companyCategory.length : 'Not array');
    
    if (Array.isArray(companyCategory) && companyCategory.length > 0) {
      console.log('Processing categories to find company name...');
      // Find the first category with a company name
      const firstCategoryWithCompany = companyCategory.find(cat => {
        console.log('Checking category object:', cat);
        console.log('Category type:', typeof cat);
        if (typeof cat === 'object' && cat.company_name) {
          console.log('Found company_name:', cat.company_name);
          console.log('Trimmed length:', cat.company_name.trim().length);
          return cat.company_name.trim() !== '';
        }
        return false;
      });
      
      console.log('First category with company found:', firstCategoryWithCompany);
      if (firstCategoryWithCompany && firstCategoryWithCompany.company_name) {
        effectiveCompanyName = firstCategoryWithCompany.company_name;
        console.log('âœ… Using first company from categories as effective company name:', effectiveCompanyName);
      } else {
        console.log('âŒ No valid company found in categories, keeping original:', companyName);
      }
    } else {
      console.log('âŒ No categories array or empty, keeping original companyName:', companyName);
    }
    
    console.log('ðŸŽ¯ FINAL effectiveCompanyName result:', effectiveCompanyName);
    console.log('=====================================');
    
    console.log('Final effective company name:', effectiveCompanyName);
    
    // Structure the data to match both the API expectations and the dynamic_fields structure
    const obligationData = {
      // Direct fields
      salary,
      partnerSalary,
      yearlyBonus,
      bonusDivision,
      loanRequired,
      companyName: effectiveCompanyName, // Use effective company name
      companyType, 
      companyCategory: (() => {
        // Send complete category objects with company name, bank name, and category name
        if (Array.isArray(companyCategory)) {
          return companyCategory.map(cat => {
            if (typeof cat === 'string') {
              // Legacy format - convert to object structure
              return {
                company_name: effectiveCompanyName || '',
                bank_name: '',
                category_name: cat,
                display: cat
              };
            } else if (typeof cat === 'object' && cat !== null) {
              // New format - preserve all information
              return {
                company_name: cat.company_name || effectiveCompanyName || '',
                bank_name: cat.bank_name || '',
                category_name: cat.category_name || cat.key || cat.display || '',
                display: cat.display || cat.key || '',
                ...cat // Include any additional fields
              };
            }
            return cat;
          });
        }
        return companyCategory;
      })(),
      cibilScore,
      obligations,
      foirPercent: ceFoirPercent,
      customFoirPercent: ceCustomFoirPercent,
      totalBtPos,
      totalObligation,
      eligibility,
      ceCompanyCategory,
      ceFoirPercent,
      ceCustomFoirPercent,
      ceMonthlyEmiCanPay,
      ceTenureMonths,
      ceTenureYears,
      ceRoi,
      ceMultiplier,
      loanEligibilityStatus,
      
      // Multiple banks support - send as array and string formats for API compatibility
      processingBanks: companyType, // Array of selected banks
      processing_banks: companyType, // Array format
      processing_bank: companyType.length > 0 ? companyType[0] : '', // First bank for backward compatibility
      bank_name: companyType.length > 0 ? companyType.join(', ') : '', // Comma-separated string
      bankName: companyType.length > 0 ? companyType.join(', ') : '', // Comma-separated string
      selectedBanks: companyType, // Clear naming for selected banks
      
      // Also include nested structure to match dynamic_fields format
      // Add loan_amount at the top level to match database schema
      loan_amount: loanRequired ? parseINR(loanRequired) : 0,
      
      // Debug loan amount values being saved
      _debug_loan_amount: {
        raw_loan_required: loanRequired,
        parsed_loan_required: loanRequired ? parseINR(loanRequired) : 0,
        typeof_raw: typeof loanRequired,
        typeof_parsed: typeof (loanRequired ? parseINR(loanRequired) : 0),
        loan_amount_value: loanRequired ? parseINR(loanRequired) : 0
      },
      
      dynamic_fields: {
        financial_details: {
          monthly_income: salary ? parseINR(salary) : null,
          partner_salary: partnerSalary ? parseINR(partnerSalary) : null,
          yearly_bonus: yearlyBonus ? parseINR(yearlyBonus) : null,
          bonus_division: bonusDivision || null,
          cibil_score: cibilScore ? String(cibilScore) : null,
          loan_required: loanRequired ? parseINR(loanRequired) : null,
          loan_amount: loanRequired ? parseINR(loanRequired) : 0
        },
        personal_details: {
          company_name: effectiveCompanyName || '', // Use empty string instead of null
          company_type: companyType ? String(companyType) : null,
          company_category: (() => {
            // Send complete category objects with company name, bank name, and category name
            if (Array.isArray(companyCategory)) {
              return companyCategory.map(cat => {
                if (typeof cat === 'string') {
                  // Legacy format - convert to object structure
                  return {
                    company_name: effectiveCompanyName || '', // Use effective company name
                    bank_name: '',
                    category_name: cat,
                    display: cat
                  };
                } else if (typeof cat === 'object' && cat !== null) {
                  // New format - preserve all information
                  return {
                    company_name: cat.company_name || effectiveCompanyName || '', // Use effective company name
                    bank_name: cat.bank_name || '',
                    category_name: cat.category_name || cat.key || cat.display || '',
                    display: cat.display || cat.key || '',
                    ...cat // Include any additional fields
                  };
                }
                return cat;
              });
            }
            return companyCategory;
          })()
        },
        check_eligibility: {
          company_category: ceCompanyCategory ? String(ceCompanyCategory) : null,
          foir_percent: ceFoirPercent || 60,
          custom_foir_percent: ceCustomFoirPercent || null,
          monthly_emi_can_pay: ceMonthlyEmiCanPay || 0,
          tenure_months: ceTenureMonths || null,
          tenure_years: ceTenureYears || null,
          roi: ceRoi || null,
          multiplier: ceMultiplier || null,
          loan_eligibility_status: loanEligibilityStatus || 'Not Eligible'
        },
        eligibility_details: eligibility || {
          totalIncome: '',
          foirAmount: '',
          totalObligations: '',
          totalBtPos: '',
          finalEligibility: '',
          multiplierEligibility: ''
        },
        process: {
          processing_bank: companyType.length > 0 ? companyType.join(', ') : '',
          loan_amount: loanRequired ? parseINR(loanRequired) : 0,
          loan_amount_required: loanRequired ? parseINR(loanRequired) : 0,
          how_to_process: "None",
          case_type: "Normal"
        },
        obligations: obligations.map((obl, index) => {
          // Make sure bank name is properly captured from the row
          
          return {
            product: obl.product || '',
            bank_name: obl.bankName || '', // This maps to bank_name in the API
            bankName: obl.bankName || '',  // Adding this to make sure both versions are sent
            tenure: obl.tenure ? parseINR(obl.tenure) : null,
            roi: obl.roi ? parseROI(obl.roi) : null,
            total_loan: obl.totalLoan ? parseINR(obl.totalLoan) : null,
            outstanding: obl.outstanding ? parseINR(obl.outstanding) : null,
            emi: obl.emi ? parseINR(obl.emi) : null,
            action: obl.action || 'Obligate',
            // Include Credit Card button states for proper persistence
            selectedPercentage: obl.selectedPercentage || null, // Keep for backward compatibility
            selectedTenurePercentage: obl.selectedTenurePercentage || null, // For 4% tenure button
            selectedRoiPercentage: obl.selectedRoiPercentage || null, // For 5% ROI button
            // Also include snake_case versions for backend compatibility
            selected_percentage: obl.selectedPercentage || null,
            selected_tenure_percentage: obl.selectedTenurePercentage || null,
            selected_roi_percentage: obl.selectedRoiPercentage || null
          };
        })
      }
    };
    
    console.log('=== OBLIGATION DATA BEING SAVED ===');
    console.log('Current companyName state:', companyName);
    console.log('Current companyCategory state:', companyCategory);
    console.log('Calculated effectiveCompanyName:', effectiveCompanyName);
    console.log('Final obligationData.companyName:', effectiveCompanyName);
    console.log('====================================');
    
    // Return the prepared data
    return obligationData;
  };
  
  // Track if changes have been made that need saving
  const [isSaving, setIsSaving] = useState(false);

  // Synchronous initialization to prevent race conditions
  useLayoutEffect(() => {
    try {
      if (!productSearchStates || typeof productSearchStates !== 'object' || Object.keys(productSearchStates).length === 0) {
        console.warn('Synchronous initialization of productSearchStates');
        setProductSearchStates({ 0: { isOpen: false, searchQuery: '' } });
      }
      if (!bankSearchStates || typeof bankSearchStates !== 'object' || Object.keys(bankSearchStates).length === 0) {
        console.warn('Synchronous initialization of bankSearchStates');
        setBankSearchStates({ 0: { isOpen: false, searchQuery: '' } });
      }
    } catch (error) {
      console.error('Error in synchronous state initialization:', error);
    }
  }, []);
  
  // Emergency initialization effect to prevent any race conditions
  useEffect(() => {
    try {
      if (!productSearchStates || typeof productSearchStates !== 'object') {
        console.warn('Emergency initialization of productSearchStates');
        setProductSearchStates({ 0: { isOpen: false, searchQuery: '' } });
      }
      if (!bankSearchStates || typeof bankSearchStates !== 'object') {
        console.warn('Emergency initialization of bankSearchStates');
        setBankSearchStates({ 0: { isOpen: false, searchQuery: '' } });
      }
    } catch (error) {
      console.error('Error in emergency state initialization:', error);
    }
  }, []);
  
  // State to track dropdown positions for smart positioning
  const [dropdownPositions, setDropdownPositions] = useState({});
  
  // Refs for dropdown elements to calculate positions
  const dropdownRefs = useRef({});
  
  // Handler for save button click
  const handleSaveObligations = async () => {
    if (!hasUnsavedChanges) {
      console.log('No changes to save');
      return;
    }
    
    setIsSaving(true);
    
    // Notify parent that saving is starting
    if (onDataUpdate && typeof onDataUpdate === 'function') {
      onDataUpdate({
        hasUnsavedChanges: true,
        isSaving: true
      });
    }
    
    try {
      const obligationData = prepareObligationDataForSave();
      
      // Debug Credit Card button states being saved
      const creditCardObligations = obligationData.obligations?.filter(obl => obl.product === 'CC (Credit Card)');
      
      if (leadData?._id) {
        // Call API to save data
        await saveObligationDataToAPI(obligationData);
      } else {
        console.log('No lead ID, saving to localStorage...');
        // Local storage save for offline/temporary use
        saveObligationData(obligationData);
        console.log('LocalStorage save completed');
      }
      
      setHasUnsavedChanges(false);
      setHasUserInteraction(false); // Reset user interaction flag after saving
      
      // Update originalData to reflect the newly saved state (including Credit Card button states)
      const currentData = {
        salary,
        partnerSalary,
        yearlyBonus,
        bonusDivision,
        loanRequired,
        companyName,
        companyType,
        companyCategory,
        cibilScore,
        obligations, // This includes selectedTenurePercentage and selectedRoiPercentage
        totalBtPos,
        totalObligation
      };
      setOriginalData(currentData);
      console.log('Updated originalData to reflect saved state, including Credit Card button states');
      
      // Force immediate re-render to ensure Credit Card button states are visible
      setForceRender(prev => prev + 1);
      
      // Additional force re-render with timeout to ensure UI updates
      setTimeout(() => {
        setObligations([...obligations]);
        setForceRender(prev => prev + 1);
      }, 0);
      
      // Notify parent that saving is completed successfully
      if (onDataUpdate && typeof onDataUpdate === 'function') {
        onDataUpdate({
          hasUnsavedChanges: false,
          isSaving: false
        });
      }
      
      console.log('âœ… Obligation data saved successfully');
      console.log('======= SAVE OPERATION COMPLETED =======');
    } catch (error) {
      console.error('âŒ ERROR SAVING OBLIGATION DATA:', error);
      console.error('Error details:', error.message);
      
      // Notify parent that saving failed
      if (onDataUpdate && typeof onDataUpdate === 'function') {
        onDataUpdate({
          hasUnsavedChanges: true,
          isSaving: false,
          error: error.message
        });
      }
      
      // Could add user-visible error notification here
    } finally {
      setIsSaving(false);
    }
  };
  
  // Set unsaved changes flag whenever key data changes (but only after initial load and with user interaction)
  useEffect(() => {
    if (!isInitialLoad && hasUserInteraction) {
      setHasUnsavedChanges(true);
      console.log("Data changed after initial load with user interaction - setting unsaved changes flag");
    }
  }, [
    salary, partnerSalary, yearlyBonus, bonusDivision, loanRequired, companyName, companyType, companyCategory, cibilScore, obligations,
    ceFoirPercent, ceCustomFoirPercent, totalBtPos, totalObligation, eligibility,
    ceCompanyCategory, ceMonthlyEmiCanPay, ceTenureMonths, ceTenureYears, ceRoi, ceMultiplier, loanEligibilityStatus, isInitialLoad, hasUserInteraction
  ]);
  const [isLoadingBanks, setIsLoadingBanks] = useState(false);
  
  // Dynamic company category states
  const [dynamicCompanyCategories, setDynamicCompanyCategories] = useState([]);
  const [isLoadingCategories, setIsLoadingCategories] = useState(false);
  
  // Constants
  const bonusDivisions = [
    { value: 1, label: '1' },
    { value: 3, label: '3' },
    { value: 6, label: '6' },
    { value: 12, label: '12' },
    { value: 24, label: '24' },
    { value: 48, label: '48' }
  ];

  const [companyTypes, setCompanyTypes] = useState([
    { value: 'private', label: 'Private' },
    { value: 'government', label: 'Government' },
    { value: 'psu', label: 'PSU' },
    { value: 'mnc', label: 'MNC' },
    { value: 'decide-bank-for-case', label: 'Decide Bank For Case' }
  ]);

  const companyCategories = [
    { value: 'category-a', label: 'Category A' },
    { value: 'category-b', label: 'Category B' },
    { value: 'category-c', label: 'Category C' }
  ];

  const productTypes = [
    { value: '', label: 'Select Product' },
    { value: 'PL (Personal Loan)', label: 'PL (Personal Loan)' },
    { value: 'OD (Overdraft)', label: 'OD (Overdraft)' },
    { value: 'CC (Credit Card)', label: 'CC (Credit Card)' },
    { value: 'BL (Business Loan)', label: 'BL (Business Loan)' },
    { value: 'HL (Home Loan)', label: 'HL (Home Loan)' },
    { value: 'LAP (Loan Against Property)', label: 'LAP (Loan Against Property)' },
    { value: 'AL (Auto Loan/ Car Loan)', label: 'AL (Auto Loan/ Car Loan)' },
    { value: 'EL (Education Loan)', label: 'EL (Education Loan)' },
    { value: 'GL (Gold Loan)', label: 'GL (Gold Loan)' },
    { value: 'LOC (Loan On Credit Card)', label: 'LOC (Loan On Credit Card)' },
    { value: 'CD (Consumer Durable Loan)', label: 'CD (Consumer Durable Loan)' },
    { value: 'APP LOAN', label: 'APP LOAN' },
    { value: 'INSURANCE', label: 'INSURANCE' }
  ];

  const actionTypes = [
    { value: 'BT', label: 'BT', color: 'green' },
    { value: 'Obligate', label: 'Obligate', color: 'yellow' },
    { value: 'CO-PAY', label: 'CO-PAY', color: 'orange' },
    { value: 'NO-PAY', label: 'NO-PAY', color: 'blue' },
    { value: 'Closed', label: 'Closed', color: 'red' }
  ];

  const checkEligibilityCompanyCategories = [
    { value: 'category-a', label: 'Category A' },
    { value: 'category-b', label: 'Category B' },
    { value: 'category-c', label: 'Category C' },
    { value: 'category-d', label: 'Category D' },
    { value: 'unlisted-company', label: 'Unlisted Company' }
  ];

  // Utility functions
  const formatINR = (value) => {
    if (!value) return '';
    // Ensure we're dealing with a string before using replace
    const strValue = String(value);
    const number = parseFloat(strValue.replace(/[^0-9.]/g, ''));
    if (isNaN(number)) return '';
    return new Intl.NumberFormat('en-IN').format(number);
  };

  const parseINR = (value) => {
    console.log("parseINR called with:", {
      value: value,
      type: typeof value,
      isEmpty: !value
    });
    
    if (!value) return 0;
    
    // Handle non-string values by converting to string first
    const strValue = String(value);
    // Clean the string and parse it
    const cleanedValue = strValue.replace(/[^0-9.]/g, '');
    const parsedValue = parseFloat(cleanedValue) || 0;
    
    console.log("parseINR processing:", {
      originalValue: value,
      strValue: strValue,
      cleanedValue: cleanedValue,
      parsedValue: parsedValue,
      resultType: typeof parsedValue
    });
    
    return parsedValue;
  };

  // Format tenure with "Months" suffix
  const formatTenure = (value) => {
    if (!value) return '';
    // Ensure we're dealing with a string before using replace
    const strValue = String(value);
    const number = strValue.replace(/[^0-9]/g, '');
    return number ? `${number} Months` : '';
  };

  // Parse tenure to get just the number
  const parseTenure = (value) => {
    if (!value) return '';
    // Handle non-string values by converting to string first
    const strValue = String(value);
    return strValue.replace(/[^0-9]/g, '');
  };

  // Format ROI with "%" suffix
  const formatROI = (value) => {
    if (!value) return '';
    // Ensure we're dealing with a string before using replace
    const strValue = String(value);
    const number = strValue.replace(/[^0-9.]/g, '');
    return number ? `${number}%` : '';
  };

  // Parse ROI to get just the number
  const parseROI = (value) => {
    if (!value) return '';
    // Handle non-string values by converting to string first
    const strValue = String(value);
    return strValue.replace(/[^0-9.]/g, '');
  };

  // Parse years to get just the number
  const parseYears = (value) => {
    if (!value) return '';
    // Handle non-string values by converting to string first
    const strValue = String(value);
    return strValue.replace(/[^0-9.]/g, '');
  };

  // Event handlers
  const handleSalaryChange = (e) => {
    const raw = e.target.value.replace(/[^0-9.]/g, '');
    const formattedValue = formatINR(raw);
    setSalary(formattedValue);
    
    // Mark as changed and force unsaved changes flag
    markAsChanged();
    setHasUnsavedChanges(true);
    setHasUserInteraction(true);
    
    console.log("Salary changed to:", formattedValue);
    
    // Notify parent component of changes immediately for unsaved changes detection
    if (handleChangeFunc) {
      handleChangeFunc('salary', formattedValue);
    }
  };

  const handlePartnerSalaryChange = (e) => {
    const raw = e.target.value.replace(/[^0-9.]/g, '');
    const formattedValue = formatINR(raw);
    setPartnerSalary(formattedValue);
    markAsChanged();
    
    // Notify parent component of changes immediately for unsaved changes detection
    if (handleChangeFunc) {
      handleChangeFunc('partner_salary', formattedValue);
    }
  };

  const handleYearlyBonusChange = (e) => {
    const raw = e.target.value.replace(/[^0-9.]/g, '');
    const formattedValue = formatINR(raw);
    setYearlyBonus(formattedValue);
    markAsChanged();
    
    // Clear division when bonus is cleared
    if (!raw) {
      setBonusDivision(null);
      // Notify parent of division change too
      if (handleChangeFunc) {
        handleChangeFunc('bonus_division', null);
      }
    }
    
    // Notify parent component of changes immediately for unsaved changes detection
    if (handleChangeFunc) {
      handleChangeFunc('yearly_bonus', formattedValue);
    }
  };

  // Handle bonus division toggle (like credit card buttons)
  const handleBonusDivisionToggle = (division) => {
    const bonusAmount = parseINR(yearlyBonus);
    
    // Only proceed if there's a bonus amount
    if (bonusAmount > 0) {
      let newDivision;
      // If the same division is already selected, deactivate it
      if (bonusDivision === division) {
        newDivision = null;
        setBonusDivision(null);
      } else {
        // Activate the selected division
        newDivision = division;
        setBonusDivision(division);
      }
      
      markAsChanged();
      
      // Notify parent component of changes immediately for unsaved changes detection
      if (handleChangeFunc) {
        handleChangeFunc('bonus_division', newDivision);
      }
    }
  };

  const handleObligationChange = (index, field, value) => {
    // Immediately mark as changed when any obligation field is changed
    setHasUserInteraction(true);
    setHasUnsavedChanges(true);
    
    console.log(`Obligation field changed: index=${index}, field=${field}, value=${value}`);
    
    setObligations(prevObligations => {
      const newObligations = [...prevObligations];
      
      // Get the current row to ensure we're working with the right data
      const currentRow = newObligations[index];
      if (!currentRow) {
        console.error(`Row at index ${index} not found`);
        return prevObligations;
      }
      
      // Convert text values to uppercase for display consistency
      let processedValue = value;
      if (typeof value === 'string' && !['emi', 'roi', 'tenure', 'totalLoan', 'outstanding'].includes(field)) {
        processedValue = value.toUpperCase();
      }
      
      console.log(`Processing ${field} change from "${currentRow[field]}" to "${processedValue}" for row ${index} (ID: ${currentRow.id})`);
      
      // Special handling for bank name field to ensure it's properly saved
      if (field === "bankName") {
        console.log(`Setting bank name for obligation ${index} to "${processedValue}"`);
        // Set the bankName field properly
        newObligations[index] = { ...newObligations[index], bankName: processedValue, bank_name: processedValue };
        
        // Log both fields to verify they're set correctly
        console.log(`Obligation ${index} bank fields: bankName=${processedValue}, bank_name=${processedValue}`);
      } else {
        newObligations[index] = { ...newObligations[index], [field]: processedValue };
      }
      
      console.log(`Updated row ${index}:`, newObligations[index]);
      
      // Credit Card specific logic
      if (newObligations[index].product === 'CC (Credit Card)') {
        if (field === 'product') {
          // Clear tenure, ROI, EMI, and selectedPercentage for credit card
          newObligations[index] = {
            ...newObligations[index],
            tenure: '',
            roi: '',
            emi: '',
            selectedPercentage: null
          };
        }
        
        // Handle outstanding changes for credit card
        if (field === 'outstanding') {
          const outstandingAmount = parseINR(value);
          if (outstandingAmount > 0) {
            // Only calculate EMI if a percentage is already selected
            if (newObligations[index].selectedPercentage) {
              const emiAmount = outstandingAmount * (newObligations[index].selectedPercentage / 100);
              newObligations[index] = { ...newObligations[index], emi: formatINR(emiAmount.toString()) };
            } else {
              // Clear EMI if no percentage is selected
              newObligations[index] = { ...newObligations[index], emi: '' };
            }
          } else {
            // Clear EMI and percentage if outstanding is cleared or zero
            newObligations[index] = {
              ...newObligations[index],
              emi: '',
              selectedPercentage: null
            };
          }
        }
      } else if (field === 'product' && newObligations[index].product !== 'CC (Credit Card)') {
        // Clear selectedPercentage if changing away from credit card
        newObligations[index] = { ...newObligations[index], selectedPercentage: null };
      }
      
      // Handle action field changes (temporarily disable sorting for testing)
      if (field === 'action') {
        console.log(`ðŸ”§ Action field updated for obligation ${index}: ${processedValue}`);
        console.log(`ðŸ”§ Before update - Row ${index} action:`, currentRow.action);
        
        // Ensure the action is properly set
        newObligations[index] = { ...newObligations[index], action: processedValue };
        console.log(`ðŸ”§ After update - Row ${index} action:`, newObligations[index].action);
        
        // Add a unique identifier if it doesn't exist
        if (!newObligations[index].id) {
          newObligations[index].id = `obligation-${Date.now()}-${index}`;
        }
        
        console.log(`ðŸ”§ Returning updated obligations WITHOUT sorting for testing`);
        
        // Notify parent component of changes immediately
        if (handleChangeFunc) {
          handleChangeFunc('obligations', newObligations);
        }
        
        markAsChanged();
        
        // TEMPORARILY DISABLE SORTING to test if it's causing the dropdown issue
        // Comment out the sorting setTimeout for now
        /*
        setTimeout(() => {
          console.log(`ðŸ”§ Starting delayed sorting...`);
          setObligations(currentObligations => {
            const sortedObligations = [...currentObligations].sort((a, b) => {
              const priority = { 'BT': 1, 'Obligate': 2, 'CO-PAY': 3, 'NO-PAY': 4, 'Closed': 5 };
              return (priority[a.action] || 6) - (priority[b.action] || 6);
            });
            
            console.log(`ðŸ”§ Sorted obligations after delay:`, sortedObligations.map(o => ({ id: o.id, action: o.action })));
            
            // Notify parent of sorted data
            if (handleChangeFunc) {
              handleChangeFunc('obligations', sortedObligations);
            }
            
            return sortedObligations;
          });
        }, 150);
        */
        
        return newObligations;
      } else {
        // Notify parent component of changes immediately for unsaved changes detection
        if (handleChangeFunc) {
          handleChangeFunc('obligations', newObligations);
        }
        
        markAsChanged();
        return newObligations;
      }
    });
  };

  // Handle credit card tenure (4%) selection with mutual exclusivity
  const handleCreditCardTenure = (index) => {
    setObligations(prevObligations => {
      const newObligations = [...prevObligations];
      const outstandingAmount = parseINR(newObligations[index].outstanding);
      
      // Only proceed if there's an outstanding amount
      if (outstandingAmount > 0) {
        // If 4% is already selected for tenure, deactivate it
        if (newObligations[index].selectedTenurePercentage === 4) {
          newObligations[index] = {
            ...newObligations[index],
            tenure: '',
            roi: '',
            emi: '',
            selectedTenurePercentage: null,
            selectedRoiPercentage: null
          };
        } else {
          // Activate 4% for tenure and deactivate ROI (mutual exclusivity)
          newObligations[index] = {
            ...newObligations[index],
            tenure: '4%',
            roi: '4%', // Set ROI to same value for calculation
            selectedTenurePercentage: 4,
            selectedRoiPercentage: null // Clear ROI button selection
          };
          
          // Calculate EMI immediately when 4% is selected
          const emiAmount = outstandingAmount * 0.04; // 4% of outstanding
          newObligations[index].emi = formatINR(emiAmount.toString());
        }
        
        // Notify parent component of changes immediately for unsaved changes detection
        if (handleChangeFunc) {
          handleChangeFunc('obligations', newObligations);
        }
        
        markAsChanged();
        return newObligations;
      }
      
      return prevObligations;
    });
  };

  // Handle credit card ROI (5%) selection with mutual exclusivity
  const handleCreditCardRoi = (index) => {
    setObligations(prevObligations => {
      const newObligations = [...prevObligations];
      const outstandingAmount = parseINR(newObligations[index].outstanding);
      
      // Only proceed if there's an outstanding amount
      if (outstandingAmount > 0) {
        // If 5% is already selected for ROI, deactivate it
        if (newObligations[index].selectedRoiPercentage === 5) {
          newObligations[index] = {
            ...newObligations[index],
            tenure: '',
            roi: '',
            emi: '',
            selectedTenurePercentage: null,
            selectedRoiPercentage: null
          };
        } else {
          // Activate 5% for ROI and deactivate tenure (mutual exclusivity)
          newObligations[index] = {
            ...newObligations[index],
            tenure: '5%', // Set tenure to same value for display
            roi: '5%',
            selectedTenurePercentage: null, // Clear tenure button selection
            selectedRoiPercentage: 5
          };
          
          // Calculate EMI immediately when 5% is selected
          const emiAmount = outstandingAmount * 0.05; // 5% of outstanding
          newObligations[index].emi = formatINR(emiAmount.toString());
        }
        
        // Notify parent component of changes immediately for unsaved changes detection
        if (handleChangeFunc) {
          handleChangeFunc('obligations', newObligations);
        }
        
        markAsChanged();
        return newObligations;
      }
      
      return prevObligations;
    });
  };

  // Legacy function - keep for backward compatibility but mark as deprecated
  const handleCreditCardEmiPercentage = (index, percentage) => {
    console.warn('handleCreditCardEmiPercentage is deprecated. Use handleCreditCardTenure or handleCreditCardRoi instead.');
    // For backward compatibility, if percentage is 4, treat as tenure, if 5, treat as ROI
    if (percentage === 4) {
      handleCreditCardTenure(index);
    } else if (percentage === 5) {
      handleCreditCardRoi(index);
    }
  };

  const handleAddObligation = () => {
    const newIndex = obligations.length;
    const newObligations = [...obligations, {
      id: Date.now() + Math.random(), // Add unique ID
      product: '',
      bankName: '',
      tenure: '',
      roi: '',
      totalLoan: '',
      outstanding: '',
      emi: '',
      action: 'Obligate',
      selectedPercentage: null, // Keep for backward compatibility
      selectedTenurePercentage: null, // For 4% tenure button
      selectedRoiPercentage: null // For 5% ROI button
    }];
    setObligations(newObligations);
    
    // Initialize search states for the new row
    initializeSearchState(newIndex);
    
    // Notify parent component of changes immediately for unsaved changes detection
    if (handleChangeFunc) {
      handleChangeFunc('obligations', newObligations);
    }
  };

  const handleDeleteObligation = (index) => {
    if (obligations.length > 1) {
      // Create a new array without the deleted row
      const newObligations = obligations.filter((_, i) => i !== index);
      setObligations(newObligations);
      
      // Clean up search states for deleted row and reindex remaining rows
      const newProductSearchStates = {};
      const newBankSearchStates = {};
      
      if (productSearchStates && typeof productSearchStates === 'object') {
        Object.keys(productSearchStates).forEach(key => {
          const idx = parseInt(key);
          if (idx < index) {
            newProductSearchStates[idx] = productSearchStates[key];
          } else if (idx > index) {
            newProductSearchStates[idx - 1] = productSearchStates[key];
          }
        });
      }
      
      if (bankSearchStates && typeof bankSearchStates === 'object') {
        Object.keys(bankSearchStates).forEach(key => {
          const idx = parseInt(key);
          if (idx < index) {
            newBankSearchStates[idx] = bankSearchStates[key];
          } else if (idx > index) {
            newBankSearchStates[idx - 1] = bankSearchStates[key];
          }
        });
      }
      
      setProductSearchStates(newProductSearchStates);
      setBankSearchStates(newBankSearchStates);
      
      // Mark as having unsaved changes
      setHasUnsavedChanges(true);
      
      // Notify parent component of changes immediately for unsaved changes detection
      if (handleChangeFunc) {
        handleChangeFunc('obligations', newObligations);
      }
      
      console.log(`Deleted obligation row at index ${index}. ${newObligations.length} rows remaining.`);
    } else {
      // If it's the last row, just clear the values but keep the row
      console.log("Can't delete the last row. Clearing values instead.");
      const clearedObligation = {
        product: '',
        bankName: '',
        tenure: '',
        roi: '',
        totalLoan: '',
        outstanding: '',
        emi: '',
        action: 'Obligate',
        selectedPercentage: null
      };
      const clearedObligations = [clearedObligation];
      setObligations(clearedObligations);
      
      // Reset search states for the cleared row
      setProductSearchStates({ 0: { isOpen: false, searchQuery: '' } });
      setBankSearchStates({ 0: { isOpen: false, searchQuery: '' } });
      
      // Mark as having unsaved changes
      setHasUnsavedChanges(true);
      
      // Notify parent component of changes immediately for unsaved changes detection
      if (handleChangeFunc) {
        handleChangeFunc('obligations', clearedObligations);
      }
    }
  };

  // Eligibility handlers
  const handleCeCompanyCategoryChange = (e) => {
    const value = e.target.value;
    setCeCompanyCategory(value);
    
    // Mark as changed to trigger save button
    setHasUserInteraction(true);
    setHasUnsavedChanges(true);
    console.log("Company category changed:", value);
    
    // Notify parent component of changes immediately for unsaved changes detection
    if (handleChangeFunc) {
      handleChangeFunc('ce_company_category', value);
    }
  };

  const handleCeFoirPercentChange = (e) => {
    const value = e.target.value;
    setCeFoirPercent(value);
    
    // Mark as changed to trigger save button
    setHasUserInteraction(true);
    setHasUnsavedChanges(true);
    
    // If switching to custom, start with empty value
    if (value === 'custom') {
      setCeCustomFoirPercent('');
    }
    
    // Notify parent component of changes immediately for unsaved changes detection
    if (handleChangeFunc) {
      handleChangeFunc('ce_foir_percent', value);
    }
    
    console.log("FOIR percent changed:", value);
  };

  const handleCeTenureMonthsChange = (e) => {
    const input = e.target;
    const cursorPosition = input.selectionStart;
    const rawValue = e.target.value.replace(/[^0-9]/g, "");
    const formattedValue = rawValue ? formatTenure(rawValue) : '';
    const months = Number(rawValue);
    setCeTenureMonths(formattedValue);
    
    // Mark as changed to trigger save button
    setHasUserInteraction(true);
    setHasUnsavedChanges(true);
    console.log("Tenure months changed:", formattedValue);
    
    // Format years with proper display
    if (months) {
      const totalYears = Math.floor(months / 12);
      const remainingMonths = months % 12;
      
      if (remainingMonths === 0) {
        setCeTenureYears(`${totalYears} Years`);
      } else if (remainingMonths === 1) {
        setCeTenureYears(`${totalYears} Years 1 Month`);
      } else {
        setCeTenureYears(`${totalYears} Years ${remainingMonths} Months`);
      }
    } else {
      setCeTenureYears('');
    }
    
    // Restore cursor position after formatting
    setTimeout(() => {
      if (input && rawValue) {
        const newPosition = Math.min(cursorPosition, rawValue.length);
        input.setSelectionRange(newPosition, newPosition);
      }
    }, 0);
  };

  const handleCeTenureYearsChange = (e) => {
    const input = e.target;
    const cursorPosition = input.selectionStart;
    const rawValue = e.target.value.replace(/[^0-9]/g, "");
    const years = Number(rawValue);
    
    // Mark as changed to trigger save button
    setHasUserInteraction(true);
    setHasUnsavedChanges(true);
    console.log("Tenure years changed:", rawValue);
    
    if (rawValue) {
      setCeTenureYears(`${rawValue} Years`);
      setCeTenureMonths(formatTenure((years * 12).toString()));
    } else {
      setCeTenureYears('');
      setCeTenureMonths('');
    }
    
    // Restore cursor position after formatting
    setTimeout(() => {
      if (input && rawValue) {
        const newPosition = Math.min(cursorPosition, rawValue.length);
        input.setSelectionRange(newPosition, newPosition);
      }
    }, 0);
  };

  const handleCeRoiChange = (e) => {
    const input = e.target;
    const cursorPosition = input.selectionStart;
    const rawValue = e.target.value.replace(/[^0-9.]/g, "");
    const formattedValue = rawValue ? formatROI(rawValue) : '';
    setCeRoi(formattedValue);
    
    // Mark as changed to trigger save button
    setHasUserInteraction(true);
    setHasUnsavedChanges(true);
    console.log("ROI changed:", formattedValue);
    
    // Restore cursor position after formatting
    setTimeout(() => {
      if (input && rawValue) {
        const newPosition = Math.min(cursorPosition, rawValue.length);
        input.setSelectionRange(newPosition, newPosition);
      }
    }, 0);
  };

  const handleCeMultiplierChange = (e) => {
    const value = e.target.value;
    setCeMultiplier(value);
    
    // Mark as changed to trigger save button
    setHasUserInteraction(true);
    setHasUnsavedChanges(true);
    console.log("Multiplier changed:", value);
  };

  // Get row styling - No background colors, just clean white rows
  const getRowStyling = (action) => {
    return 'bg-white border-white'; // Clean white rows with white borders
  };

  // Get input styling based on action - Color the cell content based on action
  const getInputStyling = (action) => {
    switch (action) {
      case 'BT':
        return 'bg-green-400 border-green-600 text-black font-bold'; // Green background for BT cells
      case 'Obligate':
        return 'bg-yellow-400 border-yellow-600 text-black font-bold'; // Yellow background for Obligate cells
      case 'CO-PAY':
        return 'bg-orange-400 border-orange-600 text-black font-bold'; // Orange background for CO-PAY cells
      case 'NO-PAY':
        return 'bg-blue-400 border-blue-600 text-black font-bold'; // Blue background for NO-PAY cells
      case 'Closed':
        return 'bg-red-400 border-red-600 text-black font-bold'; // Red background for Closed cells
      default:
        return 'bg-yellow-400 border-yellow-600 text-black font-bold'; // Default to Obligate styling
    }
  };

  // Get action select styling - Color the action dropdown based on selected action
  const getActionSelectStyling = (action) => {
    // Ensure we have a valid action value
    const actionValue = action || 'Obligate'; // Default to Obligate if no action
    
    switch (actionValue) {
      case 'BT':
        return 'bg-green-400 border-green-600 text-black font-bold'; // Green background for BT
      case 'Obligate':
        return 'bg-yellow-400 border-yellow-600 text-black font-bold'; // Yellow background for Obligate
      case 'CO-PAY':
        return 'bg-orange-400 border-orange-600 text-black font-bold'; // Orange background for CO-PAY
      case 'NO-PAY':
        return 'bg-blue-400 border-blue-600 text-black font-bold'; // Blue background for NO-PAY
      case 'Closed':
        return 'bg-red-400 border-red-600 text-black font-bold'; // Red background for Closed
      default:
        return 'bg-yellow-400 border-yellow-600 text-black font-bold'; // Default to Obligate styling
    }
  };

  // Bank handlers for Decide Bank For Case - Updated to support multiple selections
  const handleRemoveBank = (bankToRemove) => {
    if (bankToRemove) {
      // Remove specific bank from companyType array
      setCompanyType(prev => prev.filter(bank => bank !== bankToRemove));
      console.log('Removed bank:', bankToRemove);
    } else {
      // Clear all banks
      setCompanyType([]);
      console.log('All banks cleared');
    }
  };

  const handleAddBank = (newBankName) => {
    console.log('Selected bank for Decide Bank For Case:', newBankName);
    
    // Check if bank is already selected to prevent duplicates
    if (companyType.includes(newBankName)) {
      console.log('Bank already selected:', newBankName);
      return;
    }
    
    // Add new bank to the existing list (multiple selection allowed)
    setCompanyType(prevBanks => {
      const updatedBanks = [...prevBanks, newBankName];
      console.log('Updated bank list:', updatedBanks);
      
      // Notify parent component of changes immediately for unsaved changes detection
      if (handleChangeFunc) {
        handleChangeFunc('company_type', updatedBanks);
      }
      
      return updatedBanks;
    });
    
    console.log('Bank added to selection:', newBankName);
    console.log('Multiple bank selection enabled');
    
    // Also add to bankList if not already included, for obligations dropdown
    setBankList(prevBanks => {
      if (!prevBanks.includes(newBankName)) {
        return [...prevBanks, newBankName];
      }
      return prevBanks;
    });
  };

  // Category handlers for multiple selection
  const handleRemoveCategory = (categoryToRemove) => {
    setCompanyCategory((prev) => {
      const newList = prev.filter((category) => {
        // Handle both string (legacy) and object (new format) comparisons
        if (typeof categoryToRemove === 'string') {
          if (typeof category === 'string') {
            return category !== categoryToRemove;
          } else if (typeof category === 'object') {
            return category.key !== categoryToRemove && category.display !== categoryToRemove;
          }
        } else if (typeof categoryToRemove === 'object') {
          if (typeof category === 'string') {
            return category !== categoryToRemove.key && category !== categoryToRemove.display;
          } else if (typeof category === 'object') {
            return category.key !== categoryToRemove.key;
          }
        }
        return true;
      });
      console.log('Category removed:', categoryToRemove, 'New list:', newList);
      
      // Notify parent component of changes immediately for unsaved changes detection
      if (handleChangeFunc) {
        handleChangeFunc('company_category', newList);
      }
      
      return newList;
    });
  };

  const handleAddCategory = (newCategoryData, isRemove = false) => {
    console.log('handleAddCategory called with:', { newCategoryData, isRemove });
    
    // Handle both string (legacy) and object (new format) inputs
    let categoryKey, displayText, categoryName;
    
    if (typeof newCategoryData === 'string') {
      // Legacy format - just the category name
      categoryKey = newCategoryData;
      displayText = newCategoryData;
      categoryName = newCategoryData;
    } else if (typeof newCategoryData === 'object' && newCategoryData !== null) {
      // New format - full category object with company, bank, and category info
      const { company_name, bank_name, category_name, display_key } = newCategoryData;
      categoryKey = display_key || category_name; // Use display_key as unique identifier
      categoryName = category_name; // Extract just the category name for backend
      
      // Create display text in format: "Company â†’ Bank â†’ Category" or "Company â†’ Category"
      if (company_name && bank_name && category_name) {
        displayText = `${company_name} â†’ ${bank_name} â†’ ${category_name}`;
      } else if (company_name && category_name) {
        displayText = `${company_name} â†’ ${category_name}`;
      } else {
        displayText = category_name || categoryKey;
      }
    } else {
      console.error('Invalid category data format:', newCategoryData);
      return;
    }
    
    console.log('Processed category:', { categoryKey, displayText, categoryName });
    
    if (isRemove) {
      // If this is a remove operation from the popup
      console.log('Removing category from main display:', categoryKey);
      setCompanyCategory((prev) => {
        const newList = prev.filter((category) => {
          // Handle both string and object comparisons
          if (typeof category === 'string') {
            // For legacy string format, compare with categoryKey/displayText/categoryName
            return category !== categoryKey && category !== displayText && category !== categoryName;
          } else if (typeof category === 'object') {
            // For object format, compare all three: company_name, bank_name, and category_name
            const existingCompany = category.company_name || '';
            const existingBank = category.bank_name || '';
            const existingCategory = category.category_name || category.key || category.display || '';
            
            const removeCompany = newCategoryData.company_name || '';
            const removeBank = newCategoryData.bank_name || '';
            
            // Keep the category if it doesn't match all three components
            return !(existingCompany === removeCompany && 
                    existingBank === removeBank && 
                    existingCategory === categoryName);
          }
          return true;
        });
        console.log('Category removed:', {
          company: newCategoryData.company_name,
          bank: newCategoryData.bank_name,
          category: categoryName
        }, 'New list:', newList);
        
        // Notify parent component of changes immediately for unsaved changes detection
        // Send complete category objects with all information
        if (handleChangeFunc) {
          const categoryObjects = newList.map(cat => {
            if (typeof cat === 'string') {
              return {
                company_name: companyName || '',
                bank_name: '',
                category_name: cat,
                display: cat
              };
            } else if (typeof cat === 'object') {
              return {
                company_name: cat.company_name || companyName || '',
                bank_name: cat.bank_name || '',
                category_name: cat.category_name || cat.key || cat.display || '',
                display: cat.display || cat.key || '',
                ...cat
              };
            }
            return cat;
          });
          handleChangeFunc('company_category', categoryObjects);
        }
        
        return newList;
      });
      return;
    }
    
    // Check if this exact combination of company+bank+category already exists (prevent duplicates)
    if (Array.isArray(companyCategory)) {
      const categoryAlreadyExists = companyCategory.some((category) => {
        if (typeof category === 'string') {
          // For legacy string format, compare with categoryName only
          return category === categoryName;
        } else if (typeof category === 'object') {
          // For object format, compare all three: company_name, bank_name, and category_name
          const existingCompany = category.company_name || '';
          const existingBank = category.bank_name || '';
          const existingCategory = category.category_name || category.key || category.display || '';
          
          const newCompany = newCategoryData.company_name || '';
          const newBank = newCategoryData.bank_name || '';
          
          return existingCompany === newCompany && 
                 existingBank === newBank && 
                 existingCategory === categoryName;
        }
        return false;
      });
      
      if (categoryAlreadyExists) {
        console.log('Exact combination of company+bank+category already exists, not adding again:', {
          company: newCategoryData.company_name,
          bank: newCategoryData.bank_name,
          category: categoryName
        });
        return;
      }
    }
    
    console.log('Adding category to main display:', displayText);
    setCompanyCategory((prevCategories) => {
      const currentCategories = Array.isArray(prevCategories) ? prevCategories : [];
      
      // Store as object with both key and display text for full information
      const categoryObject = {
        key: categoryKey,
        display: displayText,
        category_name: categoryName, // Store the actual category name for backend
        ...newCategoryData // Include all original data for reference
      };
      
      const newList = [...currentCategories, categoryObject];
      console.log('Category added:', displayText, 'New list:', newList);
      
      // Notify parent component of changes immediately for unsaved changes detection
      // Send complete category objects with all information
      if (handleChangeFunc) {
        const categoryObjects = newList.map(cat => {
          if (typeof cat === 'string') {
            return {
              company_name: companyName || '',
              bank_name: '',
              category_name: cat,
              display: cat
            };
          } else if (typeof cat === 'object') {
            return {
              company_name: cat.company_name || companyName || '',
              bank_name: cat.bank_name || '',
              category_name: cat.category_name || cat.key || cat.display || '',
              display: cat.display || cat.key || '',
              ...cat
            };
          }
          return cat;
        });
        console.log('Sending complete category objects to backend:', categoryObjects);
        handleChangeFunc('company_category', categoryObjects);
      }
      
      // Auto-update company name with the first company from categories if not already set
      if (newList.length > 0) {
        // Find the first category with a company name
        const firstCategoryWithCompany = newList.find(cat => {
          if (typeof cat === 'object' && cat.company_name) {
            return cat.company_name.trim() !== '';
          }
          return false;
        });
        
        if (firstCategoryWithCompany && firstCategoryWithCompany.company_name) {
          // Update company name if it's empty or if we want to always use first company
          if (!companyName.trim()) {
            console.log('Auto-updating company name to first company:', firstCategoryWithCompany.company_name);
            setCompanyName(firstCategoryWithCompany.company_name);
            if (handleChangeFunc) {
              handleChangeFunc('company_name', firstCategoryWithCompany.company_name);
            }
          }
        }
      }
      
      return newList;
    });
    
    // Mark as having unsaved changes
    setHasUnsavedChanges(true);
  };

  // Initialize search states for new obligations - defined as regular function to avoid initialization errors
  function initializeSearchState(index) {
    setProductSearchStates(prev => ({
      ...prev,
      [index]: { isOpen: false, searchQuery: '' }
    }));
    setBankSearchStates(prev => ({
      ...prev,
      [index]: { isOpen: false, searchQuery: '' }
    }));
  }

  // Function to calculate optimal dropdown position - defined as regular function to avoid initialization errors
  function calculateDropdownPosition(triggerElement) {
    if (!triggerElement) return { openUpward: false, left: 0, top: 0, width: 200 };
    
    const rect = triggerElement.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const viewportWidth = window.innerWidth;
    const dropdownHeight = 250; // Estimated height of dropdown with search and options
    const dropdownWidth = Math.max(rect.width, 300); // Minimum 300px width for better UX
    
    // Calculate space below and above
    const spaceBelow = viewportHeight - rect.bottom;
    const spaceAbove = rect.top;
    
    // If there's not enough space below, open upward
    const shouldOpenUpward = spaceBelow < dropdownHeight && spaceAbove > spaceBelow;
    
    // Calculate position relative to viewport
    let left = rect.left;
    let top = shouldOpenUpward ? rect.top - dropdownHeight : rect.bottom;
    
    // Ensure dropdown doesn't go off-screen horizontally
    if (left + dropdownWidth > viewportWidth) {
      left = viewportWidth - dropdownWidth - 10; // 10px margin from edge
    }
    if (left < 10) {
      left = 10; // 10px margin from left edge
    }
    
    // Ensure dropdown doesn't go off-screen vertically
    if (top < 10) {
      top = 10;
    }
    if (top + dropdownHeight > viewportHeight - 10) {
      top = viewportHeight - dropdownHeight - 10;
    }
    
    return { 
      openUpward: shouldOpenUpward, 
      left: left, 
      top: top, 
      width: dropdownWidth 
    };
  }

  // Function to close all dropdowns - centralized function for consistency
  function closeAllDropdowns() {
    // Close all product dropdowns
    setProductSearchStates(prev => {
      const updated = {};
      Object.keys(prev).forEach(key => {
        updated[key] = { ...prev[key], isOpen: false };
      });
      return updated;
    });
    
    // Close all bank dropdowns
    setBankSearchStates(prev => {
      const updated = {};
      Object.keys(prev).forEach(key => {
        updated[key] = { ...prev[key], isOpen: false };
      });
      return updated;
    });
    
    // Close company dropdown
    setCompanyDropdownOpen(false);
  }

  // Handlers for product dropdown - defined as regular functions to avoid initialization errors
  function handleProductDropdownToggle(index) {
    if (!safeProductSearchStates || typeof safeProductSearchStates !== 'object') {
      console.warn('productSearchStates not properly initialized');
      return;
    }
    const isOpening = !(safeProductSearchStates && safeProductSearchStates[index]?.isOpen);
    
    if (isOpening) {
      // Close all other dropdowns first (both product and bank dropdowns)
      closeAllDropdowns();
      
      // Calculate position when opening
      const triggerElement = dropdownRefs.current[`product-${index}`];
      const position = calculateDropdownPosition(triggerElement);
      
      setDropdownPositions(prev => ({
        ...prev,
        [`product-${index}`]: position
      }));
      
      // Open this specific product dropdown
      setProductSearchStates(prev => ({
        ...prev,
        [index]: { 
          ...prev[index], 
          isOpen: true,
          searchQuery: prev[index]?.searchQuery || ''
        }
      }));
    } else {
      // Close this dropdown
      setProductSearchStates(prev => ({
        ...prev,
        [index]: { 
          ...prev[index], 
          isOpen: false,
          searchQuery: prev[index]?.searchQuery || ''
        }
      }));
    }
  }

  function handleProductSearchChange(index, query) {
    if (!productSearchStates || typeof productSearchStates !== 'object') {
      console.warn('productSearchStates not properly initialized');
      return;
    }
    setProductSearchStates(prev => ({
      ...prev,
      [index]: { ...prev[index], searchQuery: query }
    }));
  }

  function handleProductSelect(index, product) {
    console.log(`Product selection triggered for index ${index} with product: "${product.label}"`);
    handleObligationChange(index, "product", product.value);
    setProductSearchStates(prev => ({
      ...prev,
      [index]: { isOpen: false, searchQuery: '' }
    }));
    
    // Mark as having unsaved changes
    setHasUnsavedChanges(true);
    
    console.log(`Product dropdown closed for index ${index}`);
  }

  // Handlers for bank dropdown
  function handleBankDropdownToggle(index) {
    if (!bankSearchStates || typeof bankSearchStates !== 'object') {
      console.warn('bankSearchStates not properly initialized');
      return;
    }
    const isOpening = !(bankSearchStates && bankSearchStates[index]?.isOpen);
    
    if (isOpening) {
      // Close all other dropdowns first (both product and bank dropdowns)
      closeAllDropdowns();
      
      // Calculate position when opening
      const triggerElement = dropdownRefs.current[`bank-${index}`];
      const position = calculateDropdownPosition(triggerElement);
      
      setDropdownPositions(prev => ({
        ...prev,
        [`bank-${index}`]: position
      }));
      
      // Open this specific bank dropdown
      setBankSearchStates(prev => ({
        ...prev,
        [index]: { 
          ...prev[index], 
          isOpen: true,
          searchQuery: prev[index]?.searchQuery || ''
        }
      }));
    } else {
      // Close this dropdown
      setBankSearchStates(prev => ({
        ...prev,
        [index]: { 
          ...prev[index], 
          isOpen: false,
          searchQuery: prev[index]?.searchQuery || ''
        }
      }));
    }
  }

  function handleBankSearchChange(index, query) {
    if (!bankSearchStates || typeof bankSearchStates !== 'object') {
      console.warn('bankSearchStates not properly initialized');
      return;
    }
    setBankSearchStates(prev => ({
      ...prev,
      [index]: { ...prev[index], searchQuery: query }
    }));
  }

  function handleBankSelect(index, bank) {
    console.log(`Bank selection triggered for index ${index} with bank: "${bank}"`);
    const bankValue = bank.includes('') ? bank.replace(' ', '') : bank;
    console.log(`Cleaned bank value: "${bankValue}"`);
    
    handleObligationChange(index, "bankName", bankValue);
    
    setBankSearchStates(prev => ({
      ...prev,
      [index]: { isOpen: false, searchQuery: '' }
    }));
    
    // Mark as having unsaved changes
    setHasUnsavedChanges(true);
    
    console.log(`Bank dropdown closed for index ${index}`);
  }

  // Handlers for company name dropdown
  function handleCompanyDropdownToggle() {
    const isOpening = !companyDropdownOpen;
    
    if (isOpening) {
      // Close all other dropdowns first
      closeAllDropdowns();
      
      // Load suggestions if we have enough text
      if (companyName.trim().length >= 2) {
        loadCompanySuggestions(companyName.trim());
      }
    }
    
    setCompanyDropdownOpen(isOpening);
  }

  function handleCompanySearchChange(query) {
    // No need for separate search query state since company name is the search
    
    // Load suggestions if we have any text
    if (query.trim().length >= 1) {
      // Debounce the search
      if (companySearchTimeout) {
        clearTimeout(companySearchTimeout);
      }
      
      const timeout = setTimeout(() => {
        loadCompanySuggestions(query.trim());
      }, 300);
      
      setCompanySearchTimeout(timeout);
    } else {
      setCompanySuggestions([]);
    }
  }

  async function handleCompanySelect(companyName) {
    console.log(`ðŸ¢ Company selected: "${companyName}"`);
    
    // Set flag to prevent onBlur interference
    setIsSelectingFromDropdown(true);
    
    // Set the company name immediately and mark as changed
    setCompanyName(companyName);
    setCompanyDropdownOpen(false);
    setHasUnsavedChanges(true);
    markAsChanged();
    
    // Immediately notify parent component to ensure the change is tracked
    if (handleChangeFunc) {
      handleChangeFunc('company_name', companyName);
    }
    
    // Clear suggestions after selection to prevent interference
    setCompanySuggestions([]);
    
    // Force focus on the input to ensure value is displayed
    setTimeout(() => {
      if (companyDropdownRef.current) {
        companyDropdownRef.current.focus();
        companyDropdownRef.current.blur(); // Immediately blur to trigger value display
      }
    }, 100);
    
    console.log(`âœ… Company name set to: "${companyName}"`);
    
    // Load categories for the selected company
    if (companyName && companyName.trim()) {
      setIsLoadingCategories(true);
      try {
        console.log(`ðŸ¢ Loading categories for company: "${companyName}"`);
        const categories = await fetchCompanyCategoriesForCompany(companyName.trim());
        console.log(`ðŸ“‹ Categories received:`, categories);
        
        if (categories && categories.length > 0) {
          console.log(`ðŸ”„ Processing ${categories.length} categories...`);
          
          // Transform the API response to the expected format
          const formattedCategories = categories.map((company, index) => {
            console.log(`Processing category ${index}:`, company);
            
            const formatted = {
              id: `${company.company_name || 'Unknown'}-${company.bank_names?.[0] || 'Unknown'}-${company.categories?.[0] || 'Unknown'}-${index}`,
              company_name: company.company_name || 'Unknown',
              bank_name: company.bank_names?.[0] || company.bank_name || null,
              category_name: company.categories?.[0] || company.category_name || null,
              similarity_percentage: company.similarity_percentage || 0,
              display_key: `${company.company_name || 'Unknown'}-${company.bank_names?.[0] || company.bank_name || 'Unknown'}-${company.categories?.[0] || company.category_name || 'Unknown'}`,
              display_text: `${company.company_name || 'Unknown'} â†’ ${company.bank_names?.[0] || company.bank_name || 'Unknown'} â†’ ${company.categories?.[0] || company.category_name || 'Unknown'}`,
              label: `${company.company_name || 'Unknown'} â†’ ${company.bank_names?.[0] || company.bank_name || 'Unknown'} â†’ ${company.categories?.[0] || company.category_name || 'Unknown'}`,
              value: `${company.company_name || 'Unknown'}-${company.bank_names?.[0] || company.bank_name || 'Unknown'}-${company.categories?.[0] || company.category_name || 'Unknown'}`
            };
            
            console.log(`âœ… Formatted category ${index}:`, formatted);
            return formatted;
          });
          
          setDynamicCompanyCategories(formattedCategories);
          console.log(`âœ… Successfully loaded ${formattedCategories.length} categories for company: "${companyName}"`, formattedCategories);
        } else {
          console.log(`âš ï¸ No categories found for company: "${companyName}"`);
          setDynamicCompanyCategories([]);
        }
      } catch (error) {
        console.error(`âŒ Error loading categories for company "${companyName}":`, error);
        setDynamicCompanyCategories([]);
      } finally {
        setIsLoadingCategories(false);
      }
    } else {
      // Clear categories if no company is selected
      console.log(`ðŸ§¹ Clearing categories - no company name provided`);
      setDynamicCompanyCategories([]);
    }
    
    console.log(`ðŸŽ¯ Company selection completed. Final value: "${companyName}"`);
    
    // Reset the selection flag after a longer delay to ensure value is properly displayed
    setTimeout(() => {
      setIsSelectingFromDropdown(false);
      console.log(`ðŸ”„ Selection flag reset. Company name should be: "${companyName}"`);
    }, 500);
  }

  // Function to load company suggestions
  async function loadCompanySuggestions(searchText) {
    setIsCompanyLoading(true);
    try {
      const companyData = await fetchCompanyNames(searchText);
      let suggestions = [];
      
      if (Array.isArray(companyData)) {
        suggestions = companyData.map(company => 
          company.name || company.company_name || company
        );
      } else if (companyData && typeof companyData === 'object') {
        if (companyData.companies && Array.isArray(companyData.companies)) {
          suggestions = companyData.companies.map(company => 
            company.name || company.company_name || company
          );
        } else if (companyData.data && Array.isArray(companyData.data)) {
          suggestions = companyData.data.map(company => 
            company.name || company.company_name || company
          );
        }
      }
      
      // Filter out non-string values and ensure uniqueness
      suggestions = [...new Set(suggestions.filter(name => typeof name === 'string'))];
      
      // If no suggestions found, include the search text as an option
      if (suggestions.length === 0) {
        suggestions = [searchText];
      }
      
      setCompanySuggestions(suggestions);
    } catch (error) {
      console.error('Error loading company suggestions:', error);
      setCompanySuggestions([searchText]);
    } finally {
      setIsCompanyLoading(false);
    }
  }

  // Filter functions - defined as regular functions to avoid initialization errors
  function getFilteredProducts(index) {
    if (!safeProductSearchStates || typeof safeProductSearchStates !== 'object') {
      return productTypes.slice(1);
    }
    const searchQuery = (safeProductSearchStates && safeProductSearchStates[index]?.searchQuery) || '';
    return productTypes.slice(1).filter(product =>
      product.label.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }

  function getFilteredBanks(index) {
    if (!bankSearchStates || typeof bankSearchStates !== 'object') {
      return [];
    }
    const searchQuery = (bankSearchStates && bankSearchStates[index]?.searchQuery) || '';
    const allBanks = [];
    
    // Add selected banks if they exist and not in bankList
    companyType.forEach(selectedBank => {
      if (selectedBank && !bankList.includes(selectedBank)) {
        allBanks.push(`${selectedBank}`);
      }
    });
    
    // Add all banks from bankList
    bankList.forEach(bank => {
      if (bank) {
        const isSelected = companyType.includes(bank);
        allBanks.push(isSelected ? `${bank}` : bank);
      }
    });
    
    return allBanks.filter(bank =>
      bank.toLowerCase().includes(searchQuery.toLowerCase())
    );
  }

  // Fetch API data on mount
  useEffect(() => {
    const loadInitialData = async () => {
      setIsLoadingBanks(true);
      
      try {
        // Fetch bank names and company categories in parallel
        const [bankNames, categoryData] = await Promise.all([
          fetchBankNames(),
          fetchCompanyCategories()
        ]);
        
        // Make sure bankNames is always an array of strings
        const processedBankNames = Array.isArray(bankNames) ? bankNames : ['Custom'];
        
        // Ensure all banks are strings, not objects
        const normalizedBankNames = processedBankNames.map(bank => 
          typeof bank === 'string' ? bank : (bank.name || bank.label || String(bank))
        );
        
        // Always include 'Custom' if it's not already in the list
        if (!normalizedBankNames.includes('Custom')) {
          normalizedBankNames.unshift('Custom');
        }
        
        // Update bank list
        setBankList(normalizedBankNames);
        
        // Always load dynamic categories on component mount
        if (categoryData && categoryData.length > 0) {
          setDynamicCompanyCategories(categoryData);
          console.log('Loaded dynamic categories on mount:', categoryData);
        }
        
        // Fetch company categories for 'Decide Bank For Case'
        // Ensure companyType is always treated as an array
        const companyTypeArray = Array.isArray(companyType) ? companyType : 
                               (typeof companyType === 'string' && companyType ? [companyType] : []);
        
        if (companyTypeArray.includes('decide-bank-for-case')) {
          const categories = await fetchCompanyCategories();
          if (categories && categories.length > 0) {
            setCompanyTypes(prevCompanyTypes => 
              prevCompanyTypes.map(type => 
                type.value === 'decide-bank-for-case' 
                  ? { ...type, categories } 
                  : type
              )
            );
          }
        }
      } catch (error) {
        console.error('Error loading initial data:', error);
      } finally {
        setIsLoadingBanks(false);
      }
    };
    
    loadInitialData();
  }, []);
  
  // Update company categories when company type changes to 'decide-bank-for-case'
  useEffect(() => {
    // Ensure companyType is always treated as an array to prevent "companyType.map is not a function" error
    const companyTypeArray = Array.isArray(companyType) ? companyType : 
                             (typeof companyType === 'string' && companyType ? [companyType] : []);
    
    // Check if companyType includes 'decide-bank-for-case'
    if (companyTypeArray.includes('decide-bank-for-case')) {
      const loadCategories = async () => {
        setIsLoadingCategories(true);
        try {
          const categories = await fetchCompanyCategories();
          setDynamicCompanyCategories(categories);
        } catch (error) {
          console.error('Error loading company categories:', error);
        } finally {
          setIsLoadingCategories(false);
        }
      };
      
      loadCategories();
    }
  }, [companyType]);

  // Calculate totals and eligibility
  useEffect(() => {
    // Only include bonus in total income if a division is selected
    const bonusContribution = bonusDivision ? (parseINR(yearlyBonus) / bonusDivision) : 0;
    const totalIncome = parseINR(salary) + parseINR(partnerSalary) + bonusContribution;
    
    // Get the effective FOIR percentage
    const effectiveFoirPercent = ceFoirPercent === 'custom' ? parseROI(ceCustomFoirPercent) : ceFoirPercent;
    const foirAmount = (totalIncome * effectiveFoirPercent) / 100;
    
    // Calculate total obligations based on action logic
    let totalObligations = 0;
    let totalBtPosValue = 0;
    
    obligations.forEach(obl => {
      const emiValue = parseINR(obl.emi);
      const outstandingValue = parseINR(obl.outstanding);
      
      switch (obl.action) {
        case 'BT':
          totalBtPosValue += outstandingValue;
          break;
        case 'Obligate':
          totalObligations += emiValue;
          break;
        case 'CO-PAY':
          totalObligations += emiValue / 2; // Half of EMI for CO-PAY
          break;
        case 'NO-PAY':
        case 'Closed':
          // Nothing added to totals
          break;
        default:
          // Default to Obligate behavior
          totalObligations += emiValue;
          break;
      }
    });
    
    // Auto-calculate Monthly EMI Can Pay (FOIR Amount - Total Obligation)
    const monthlyEmiCanPay = Math.max(0, foirAmount - totalObligations);
    
    // Update the Monthly EMI Can Pay state with the calculated value
    setCeMonthlyEmiCanPay(Math.round(monthlyEmiCanPay));
    
    // Calculate Loan Eligibility as per Foir using PMT formula
    // PMT = P * [r(1+r)^n] / [(1+r)^n - 1]
    // Where P = Principal, r = monthly interest rate, n = number of months
    const roiValue = parseROI(ceRoi); // Get ROI value without default
    const numberOfMonths = parseTenure(ceTenureMonths); // Parse months from formatted string
    
    let loanEligibilityFoir = 0;
    // Only calculate if ROI, tenure, and EMI are all provided
    if (roiValue > 0 && numberOfMonths > 0 && monthlyEmiCanPay > 0) {
      const monthlyRate = roiValue / 100 / 12; // Convert ROI to monthly rate
      // Using PMT formula rearranged to find Principal: P = EMI * [(1+r)^n - 1] / [r(1+r)^n]
      const powerTerm = Math.pow(1 + monthlyRate, numberOfMonths);
      loanEligibilityFoir = monthlyEmiCanPay * (powerTerm - 1) / (monthlyRate * powerTerm);
    }
    
    const multiplierValue = Number(ceMultiplier) || 0; // Handle empty multiplier
    const multiplierEligibility = (totalIncome - totalObligations) * multiplierValue;
    
    // Round off all values to remove decimals
    setEligibility({
      totalIncome: formatINR(Math.round(totalIncome).toString()),
      foirAmount: formatINR(Math.round(foirAmount).toString()),
      totalObligations: formatINR(Math.round(totalObligations).toString()),
      totalBtPos: formatINR(Math.round(totalBtPosValue).toString()),
      finalEligibility: formatINR(Math.round(loanEligibilityFoir).toString()),
      multiplierEligibility: formatINR(Math.round(multiplierEligibility).toString())
    });

    setTotalBtPos(formatINR(Math.round(totalBtPosValue).toString()));
    setTotalObligation(formatINR(Math.round(totalObligations).toString()));

    // Check eligibility status
    const requiredAmount = parseINR(loanRequired);
    setLoanEligibilityStatus(Math.round(loanEligibilityFoir) >= requiredAmount ? 'Eligible' : 'Not Eligible');
  }, [salary, partnerSalary, yearlyBonus, bonusDivision, obligations, ceFoirPercent, ceCustomFoirPercent, ceMultiplier, ceRoi, ceTenureMonths, ceTenureYears, loanRequired]);

  // Function to save obligation data to backend API - Using debounced version to avoid excessive API calls
  const saveObligationDataToAPI = async (obligationData) => {
    if (!leadData?._id) {
      console.warn('No lead ID available, cannot save to API');
      return;
    }

    try {
      const userId = getUserId();
      if (!userId) {
        console.warn('No user ID available');
        return;
      }
      
      const token = localStorage.getItem('token');
      
      // Ensure processingBank is properly included in all relevant fields
      const enrichedData = {
        ...obligationData,
        // Ensure bank name is consistently stored in all required fields
        processingBank: obligationData.bank_name || '',
        processing_bank: obligationData.bank_name || '',
        bank_name: obligationData.bank_name || '',
        bankName: obligationData.bank_name || '',
      };
      
      // Log the data being sent to API for debugging
      console.log('Sending obligation data to API with bank info:', { 
        processingBank: enrichedData.processingBank,
        processing_bank: enrichedData.processing_bank,
        bankName: enrichedData.bankName,
        bank_name: enrichedData.bank_name,
        selectedBanks: enrichedData.selectedBanks
      });
      
      // Make a direct API call (not debounced) when explicitly saving
      // Use the raw API call instead of debounced version to avoid delayed saving
      const API_BASE_URL = 'https://rupiya.me:8049';
      const apiUrl = `${API_BASE_URL}/leads/${leadData._id}/obligations?user_id=${userId}`;
      
      console.log('Making API call to:', apiUrl);
      
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(enrichedData)
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const responseData = await response.json();
      console.log('âœ… API SAVE RESPONSE:', responseData);
      console.log('Response status:', response.status);
      console.log('Response headers:', response.headers);
      
      // Check if the response contains the saved data
      if (responseData && responseData.personal_details) {
        console.log('ðŸ“‹ SAVED personal_details from API response:', responseData.personal_details);
        console.log('ðŸ¢ SAVED company_name from API response:', responseData.personal_details.company_name);
      }
      
      console.log('API response:', responseData);
      
      // Update parent component if handleChangeFunc is provided - use the correct field structure
      if (handleChangeFunc) {
        const updatedDynamicFields = {
          ...leadData.dynamic_fields,
          // Store obligation data in the structure the component expects
          obligation_data: obligationData,
          obligations: obligationData.obligations || [],
          // Also update individual fields for easier access
          personal_details: {
            ...leadData.dynamic_fields?.personal_details,
            salary: obligationData.salary,
            partner_salary: obligationData.partnerSalary,
            company_name: obligationData.companyName,
            company_type: obligationData.companyType,
            company_category: obligationData.companyCategory,
            yearly_bonus: obligationData.yearlyBonus,
            bonus_division: obligationData.bonusDivision,
            loan_required: obligationData.loanRequired,
            cibil_score: obligationData.cibilScore ? String(obligationData.cibilScore) : null
          },
          financial_details: {
            ...leadData.dynamic_fields?.financial_details,
            monthly_income: obligationData.salary,
            partner_salary: obligationData.partnerSalary,
            yearly_bonus: obligationData.yearlyBonus,
            bonus_division: obligationData.bonusDivision,
            loan_required: obligationData.loanRequired,
            loan_amount: obligationData.loanRequired,
            cibil_score: obligationData.cibilScore ? String(obligationData.cibilScore) : null
          },
          check_eligibility: {
            ...leadData.dynamic_fields?.check_eligibility,
            company_category: obligationData.ceCompanyCategory,
            foir_percent: obligationData.ceFoirPercent,
            custom_foir_percent: obligationData.ceCustomFoirPercent,
            monthly_emi_can_pay: obligationData.ceMonthlyEmiCanPay,
            tenure_months: obligationData.ceTenureMonths,
            tenure_years: obligationData.ceTenureYears,
            roi: obligationData.ceRoi,
            multiplier: obligationData.ceMultiplier,
            total_bt_pos: obligationData.totalBtPos,
            total_obligation: obligationData.totalObligation,
            eligibility: obligationData.eligibility,
            loan_eligibility_status: obligationData.loanEligibilityStatus
          },
          process: {
            ...leadData.dynamic_fields?.process,
            processing_bank: obligationData.bank_name || '',
            loan_amount: obligationData.loanRequired ? parseINR(obligationData.loanRequired) : 0,
            loan_amount_required: obligationData.loanRequired ? parseINR(obligationData.loanRequired) : 0,
            how_to_process: leadData.dynamic_fields?.process?.how_to_process || "None",
            case_type: leadData.dynamic_fields?.process?.case_type || "Normal"
          }
        };
        
        // Update the dynamic_fields with all the obligation data
        handleChangeFunc('dynamic_fields', updatedDynamicFields);
        
        // Also update root-level fields for backward compatibility
        handleChangeFunc('obligations', obligationData.obligations || []);
        handleChangeFunc('salary', obligationData.salary);
        handleChangeFunc('total_obligation', obligationData.totalObligation);
        handleChangeFunc('eligibility', obligationData.eligibility);
        handleChangeFunc('processing_banks', obligationData.selectedBanks || []);
        handleChangeFunc('bank_name', obligationData.bank_name || '');
        
        const parsedLoanAmount = obligationData.loanRequired ? parseINR(obligationData.loanRequired) : 0;
        console.log("Setting final loan_amount via handleChangeFunc:", {
          rawLoanRequired: obligationData.loanRequired,
          parsedLoanAmount: parsedLoanAmount,
          typeof_parsed: typeof parsedLoanAmount
        });
        handleChangeFunc('loan_amount', parsedLoanAmount);
      }
      
      // Call onDataUpdate callback to notify parent component about data update
      if (onDataUpdate && typeof onDataUpdate === 'function') {
        console.log('Calling onDataUpdate callback to refresh parent component data');
        onDataUpdate({
          hasUnsavedChanges: false,
          isSaving: false
        });
      }
      
      console.log('Obligation data saved successfully to API');
      
    } catch (error) {
      console.error('Error saving obligation data to API:', error);
      // Fallback to localStorage save
      saveObligationData(obligationData);
      throw error; // Re-throw to allow handling in the calling function
    }
  };

  // Final safety check before rendering
  if (!safeProductSearchStates || !safeBankSearchStates) {
    console.warn('Dropdown states not properly initialized, showing loading state');
    return <div className="min-h-screen bg-black p-6 flex items-center justify-center">
      <div className="text-white text-xl">Loading...</div>
    </div>;
  }

  return (
    <div className="min-h-screen bg-black p-6">
      <div className="max-w-7xl mx-auto">
        {/* <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-white mb-4">Customer Obligation Calculator</h1>
        </div> */}

        <div className="mb-8 form-section">
          {/* Customer Details Section */}
          <div className="mb-6">
            <div className="mb-2 text-2xl font-bold text-white">Customer Details</div>
            <div className="p-4 mb-4 border rounded-lg bg-black border-gray-600">
              {/* Row 1: Salary, Partner's Salary, Bonus */}
              <div className="flex flex-wrap items-end gap-4 mb-6">
                {/* Salary */}
                <div className="form-group flex-1 min-w-[140px] max-w-[180px]">
                  <label className="block mb-2 text-lg font-bold text-white">Salary</label>
                  <input
                    type="text"
                    className="w-full px-3 py-2 text-white bg-gray-700 border text-lg rounded-lg border-gray-600 focus:outline-none focus:border-sky-400 font-bold placeholder-gray-400 uppercase"
                    value={salary}
                    onChange={canEdit ? handleSalaryChange : undefined}
                    disabled={!canEdit}
                    placeholder="In Rupees"
                    inputMode="numeric"
                  />
                </div>
                {/* Partner's Salary */}
                <div className="form-group flex-1 min-w-[140px] max-w-[180px]">
                  <label className="block mb-2 text-lg font-bold text-white">Partner's Salary</label>
                  <input
                    type="text"
                    className="w-full px-3 py-2 text-lg text-white bg-gray-700 border rounded-lg border-gray-600 focus:outline-none focus:border-sky-400 font-bold placeholder-gray-400 uppercase"
                    value={partnerSalary}
                    onChange={canEdit ? handlePartnerSalaryChange : undefined}
                    disabled={!canEdit}
                    
                    placeholder="In Rupees"
                    inputMode="numeric"
                  />
                </div>
                {/* Bonus with Divide By dropdown on the right */}
                <div className="form-group flex-1 min-w-[200px]">
                  <label htmlFor="yearlyBonus" className="block mb-2 text-lg font-bold text-white">Bonus</label>
                  <div className="flex items-center gap-2">
                    <input
                      type="text"
                      id="yearlyBonus"
                      className="flex-1 px-3 py-2 text-lg text-white bg-gray-700 border rounded-lg border-gray-600 focus:outline-none focus:border-sky-400 font-bold placeholder-gray-400 uppercase"
                      value={yearlyBonus}
                      onChange={canEdit ? handleYearlyBonusChange : undefined}
                      disabled={!canEdit}
                      placeholder="In Rupees"
                      inputMode="numeric"
                    />
                    {yearlyBonus && parseINR(yearlyBonus) > 0 && (
                      <div className="flex items-center gap-2">
                        <label className="text-sm font-bold text-white whitespace-nowrap">Divide By:</label>
                        <select
                          className="px-2 py-2 text-white text-lg bg-gray-700 border rounded-lg form-select border-gray-600 focus:outline-none focus:border-sky-400 font-bold"
                          value={bonusDivision || ''}
                          onChange={(e) => canEdit && handleBonusDivisionToggle(Number(e.target.value))}
                          disabled={!canEdit}
                        >
                          <option value="" className="text-gray-400 font-bold">Select</option>
                          {bonusDivisions.map((opt) => (
                            <option key={opt.value} value={opt.value} className="text-white font-bold bg-gray-700">
                              {opt.label} {opt.value === 1 ? 'Month' : 'Months'}
                            </option>
                          ))}
                        </select>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Row 2: Loan Amount Required, Company Name */}
              <div className="flex flex-wrap items-end gap-4 mb-4">
                {/* Loan Amount Required */}
                <div className="form-group flex-1 min-w-[140px]">
                  <label className="block mb-2 text-lg font-bold text-white">Loan Amount Required</label>
                  <input
                    type="text"
                    className="w-full px-3 py-2 text-white text-lg bg-gray-700 border rounded-lg border-gray-600 focus:outline-none focus:border-sky-400 font-bold placeholder-gray-400 uppercase"
                    value={formatINR(loanRequired)}
                    onChange={(e) => {
                      if (!canEdit) return;
                      const value = e.target.value;
                      setLoanRequired(value);
                      
                      // Mark as changed to trigger save button
                      setHasUserInteraction(true);
                      setHasUnsavedChanges(true);
                      
                      // Notify parent component of changes immediately for unsaved changes detection
                      if (handleChangeFunc) {
                        // Update both loan_required and loan_amount fields
                        handleChangeFunc('loan_required', value);
                        const parsedValue = parseINR(value);
                        handleChangeFunc('loan_amount', parsedValue);
                        
                        console.log("Setting loan fields with handleChangeFunc:", {
                          loan_required: value,
                          loan_amount: parsedValue,
                          raw_value: value,
                          parsed_value: parsedValue,
                          typeof_parsed: typeof parsedValue
                        });
                      }
                      
                      console.log("Loan required/amount changed:", value, "Parsed value:", parseINR(value));
                    }}
                    disabled={!canEdit}
                    placeholder="In Rupees"
                    inputMode="numeric"
                  />
                </div>

                {/* Company Name with searchable input */}
                <div className="form-group flex-1 min-w-[250px] relative">
                  <label className="block mb-2 text-lg font-bold text-white">Company Name</label>
                  <div className="relative">
                    <input
                      ref={companyDropdownRef}
                      type="text"
                      className="w-full px-3 py-2 text-lg text-white bg-gray-700 border rounded-lg border-gray-600 focus:outline-none focus:border-sky-400 font-bold placeholder-gray-400 uppercase"
                      placeholder="Type company name..."
                      value={companyName}
                      disabled={!canEdit}
                      onChange={(e) => {
                        if (!canEdit) return;
                        
                        const value = e.target.value.toUpperCase();
                        console.log(`ðŸ“ Company input changed to: "${value}"`);
                        
                        // Only process changes if not in the middle of a dropdown selection
                        if (!isSelectingFromDropdown) {
                          setCompanyName(value);
                          markAsChanged();
                          
                          // Only trigger search if user is actually typing (has inputType)
                          if (e.nativeEvent && e.nativeEvent.inputType) {
                            handleCompanySearchChange(value);
                            if (!companyDropdownOpen && value.length >= 1) {
                              setCompanyDropdownOpen(true);
                              setIsSelectingFromDropdown(false); // Reset flag when dropdown opens from typing
                            }
                          }
                          
                          // Notify parent component of changes immediately for unsaved changes detection
                          if (handleChangeFunc) {
                            handleChangeFunc('company_name', value);
                          }
                        } else {
                          console.log(`ðŸš« Ignoring input change during dropdown selection`);
                        }
                      }}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' && companyName.trim().length >= 1) {
                          e.preventDefault();
                          if (companySuggestions.length > 0) {
                            // Select the first suggestion
                            handleCompanySelect(companySuggestions[0]);
                          } else {
                            // Add the typed text as new company
                            handleCompanySelect(companyName.trim());
                          }
                        } else if (e.key === 'Escape') {
                          setCompanyDropdownOpen(false);
                        }
                      }}
                      onFocus={() => {
                        if (companyName.length >= 1) {
                          setCompanyDropdownOpen(true);
                          setIsSelectingFromDropdown(false); // Reset flag when dropdown opens from focus
                        }
                      }}
                      onBlur={(e) => {
                        const currentValue = e.target.value.trim();
                        console.log(`ðŸ” Company input blur. Current value: "${currentValue}"`);
                        
                        // Delay to allow for dropdown selection
                        setTimeout(() => {
                          setCompanyDropdownOpen(false);
                          
                          // Only auto-select if user manually typed something and we're not in the middle of a dropdown selection
                          if (currentValue && currentValue.length >= 1 && !isSelectingFromDropdown) {
                            // Check if this is a new value or just confirming existing selection
                            if (currentValue !== companyName.trim()) {
                              console.log(`ðŸŽ¯ Auto-selecting manually typed company: "${currentValue}"`);
                              handleCompanySelect(currentValue);
                            } else {
                              console.log(`âœ… Company value already set: "${currentValue}"`);
                            }
                          } else if (isSelectingFromDropdown) {
                            console.log(`ðŸš« Skipping auto-select due to dropdown selection in progress`);
                          }
                        }, 200);
                      }}
                      data-dropdown-trigger="true"
                    />
                    <div className="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center gap-2">
                      {isCompanyLoading && (
                        <div className="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-sky-400"></div>
                      )}
                      <ChevronDown className="h-4 w-4 flex-shrink-0 text-gray-400" />
                    </div>
                  </div>
                </div>
              </div>

              {/* Row 3: Decide Bank For Case, Company Category */}
              <div className="flex flex-wrap items-end gap-4">
                {/* Decide Bank For Case - Updated to show multiple selected banks */}
                <div className="form-group flex-1 min-w-[140px]">
                  <label className="block mb-2 text-lg font-extrabold text-white">Decide Bank For Case</label>
                  <div className="flex flex-wrap items-center gap-2 border border-gray-600 rounded-lg bg-gray-700 p-2 min-h-[42px]">
                    {/* Display all selected banks as pills */}
                    {companyType.map((bank, index) => (
                      <div
                        key={`${bank}-${index}`}
                        className="bg-blue-100 text-blue-800 py-1 px-3 rounded-md flex items-center"
                      >
                        {/* Profile icon with bank's first letter */}
                        <div className="w-6 h-6 rounded-full bg-[#03B0F5] text-white flex items-center justify-center mr-2 text-xs flex-shrink-0">
                          {bank.charAt(0).toUpperCase()}
                        </div>
                        <span className="text-lg font-extrabold uppercase">{bank}</span>
                        <button
                          type="button"
                          className="ml-2 h-10 w-10 text-xl text-blue-500 hover:text-blue-700 font-bold"
                          onClick={() => canEdit && handleRemoveBank(bank)}
                          disabled={!canEdit}
                        >
                          Ã—
                        </button>
                      </div>
                    ))}
                    <button
                      type="button"
                      className="text-white text-lg font-medium hover:text-gray-300 ml-auto"
                      onClick={() => canEdit && setShowBankPopup(true)}
                      disabled={!canEdit}
                    >
                      + Add Bank
                    </button>
                  </div>
                </div>

                {/* Company Category - Multi-select Enabled */}
                <div className="form-group flex-1 min-w-[140px]">
                  <div className="flex items-center gap-2 mb-2">
                    <label className="text-lg font-extrabold text-white">Company Category</label>
                    {isLoadingCategories && (
                      <div className="flex items-center gap-1 text-sm text-yellow-400">
                        <div className="animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-yellow-400"></div>
                        Loading...
                      </div>
                    )}
                    {!isLoadingCategories && dynamicCompanyCategories.length > 0 && (
                      <span className="text-sm text-green-400">
                        {dynamicCompanyCategories.length} found
                      </span>
                    )}
                    {!isLoadingCategories && companyName && companyName.trim() && dynamicCompanyCategories.length === 0 && (
                      <span className="text-sm text-red-400">
                        No categories found
                      </span>
                    )}
                  </div>
                  <div className="flex flex-wrap items-center gap-2 border border-gray-600 rounded-lg bg-gray-700 p-2 min-h-[42px]">
                    {/* Display all selected categories as pills */}
                    {Array.isArray(companyCategory) && companyCategory.length > 0 ? (
                      companyCategory.map((category, index) => {
                        // Handle both string (legacy) and object (new format) categories
                        let displayText, categoryKey, initialsText;
                        
                        if (typeof category === 'string') {
                          // Legacy format - just the category name
                          displayText = category;
                          categoryKey = category;
                          initialsText = category;
                        } else if (typeof category === 'object' && category !== null) {
                          // New format - full category object with display text
                          displayText = category.display || category.display_text || category.label || category.category_name || 
                                       (category.company_name && category.bank_name && category.category_name 
                                        ? `${category.company_name} â†’ ${category.bank_name} â†’ ${category.category_name}`
                                        : category.company_name && category.category_name 
                                        ? `${category.company_name} â†’ ${category.category_name}`
                                        : 'Unknown Category');
                          categoryKey = category.key || category.display_key || category.value || category.display || `category-${index}`;
                          // Use the category name for initials if available, otherwise use display text
                          initialsText = category.category_name || category.display || category.display_text || category.label || 'CA';
                        } else {
                          // Fallback for unexpected formats
                          displayText = 'Unknown Category';
                          categoryKey = `unknown-${index}`;
                          initialsText = 'CA';
                        }
                        
                        return (
                          <div
                            key={`${categoryKey}-${index}`}
                            className="bg-green-100 text-green-800 py-1 px-3 rounded-md flex items-center"
                          >
                            {/* Profile icon with initials */}
                            <div className="w-6 h-6 rounded-full bg-[#10B981] text-white flex items-center justify-center mr-2 text-xs flex-shrink-0">
                              {initialsText.split(' ')
                                .map(part => part[0] || '')
                                .slice(0, 2)
                                .join('')
                                .toUpperCase()}
                            </div>
                            <span className="text-lg font-extrabold uppercase">{displayText}</span>
                            <button
                              type="button"
                              className="ml-2 h-10 w-10 text-xl text-green-500 hover:text-green-700 font-bold"
                              onClick={() => canEdit && handleRemoveCategory(category)}
                              disabled={!canEdit}
                            >
                              Ã—
                            </button>
                          </div>
                        );
                      })
                    ) : (
                      <span className="text-gray-400 italic">No categories selected</span>
                    )}
                    <button
                      type="button"
                      className="text-white text-lg font-medium hover:text-gray-300 ml-auto"
                      disabled={!canEdit}
                      onClick={async () => {
                        if (!canEdit) return;
                        setShowCategoryPopup(true);
                        
                        // Load categories from API when popup opens
                        if (dynamicCompanyCategories.length === 0) {
                          setIsLoadingCategories(true);
                          try {
                            const categories = await fetchCompanyCategories();
                            setDynamicCompanyCategories(categories);
                            console.log('Loaded categories for popup:', categories);
                          } catch (error) {
                            console.error('Error loading company categories:', error);
                          } finally {
                            setIsLoadingCategories(false);
                          }
                        }
                      }}
                    >
                      + Add Categories
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {/* Customer Obligation Section - with enhanced styling and logic */}
          <div className="mb-4">
            <div className="mb-4 text-3xl font-bold text-center text-green-400">Customer Obligations</div>
            
            {/* Summary fields with enhanced styling */}
            <div className="flex flex-wrap items-center gap-6 p-6 mb-4 bg-black/90 border-2 border-gray-600 rounded-lg shadow-lg">
              <div className="form-group flex-1 min-w-[250px]">
                <label className="block mb-2 text-lg font-bold text-green-400 uppercase tracking-wide">TOTAL BT POS</label>
                <input
                  type="text"
                  className="w-full px-4 py-3 font-bold text-2xl text-center text-black bg-green-400 border-2 border-green-500 rounded-lg"
                  value={totalBtPos}
                  readOnly
                />
              </div>
              <div className="form-group flex-1 min-w-[250px]">
                <label className="block mb-2 text-lg font-bold text-yellow-400 uppercase tracking-wide">TOTAL OBLIGATION</label>
                <input
                  type="text"
                  className="w-full px-4 py-3 font-bold text-2xl text-center text-black bg-yellow-400 border-2 border-yellow-500 rounded-lg"
                  value={totalObligation}
                  readOnly
                />
              </div>
              <div className="form-group flex-1 min-w-[200px]">
                <label className="block mb-2 text-lg font-bold text-blue-400 uppercase tracking-wide">CIBIL Score</label>
                <input
                  type="text"
                  className="w-full px-4 py-3 text-xl text-center text-black bg-blue-100 border-2 border-blue-400 rounded-lg focus:outline-none focus:border-blue-600 font-bold placeholder-black"
                  value={cibilScore}
                  onChange={(e) => {
                    const value = e.target.value;
                    setCibilScore(value);
                    // Notify parent component of changes immediately for unsaved changes detection
                    if (handleChangeFunc) {
                      handleChangeFunc('cibil_score', value);
                    }
                  }}
                  placeholder="Enter CIBIL Score"
                  inputMode="numeric"
                />
              </div>
            </div>
          </div>
          
          {/* Company Name Dropdown Portal */}
          {companyDropdownOpen && (
            <div 
              className="fixed inset-0 z-[9999]" 
              style={{ zIndex: 9999 }}
            >
              {/* Backdrop */}
              <div 
                className="absolute inset-0" 
                onClick={() => setCompanyDropdownOpen(false)}
              />
              
              {/* Dropdown Content */}
              <div 
                className="absolute bg-gray-800 border border-gray-600 rounded-lg shadow-lg"
                style={{
                  left: companyDropdownRef.current ? companyDropdownRef.current.getBoundingClientRect().left : 0,
                  top: companyDropdownRef.current ? companyDropdownRef.current.getBoundingClientRect().bottom + 5 : 0,
                  width: companyDropdownRef.current ? companyDropdownRef.current.getBoundingClientRect().width : 300,
                  minWidth: '300px'
                }}
                data-dropdown-container="true"
              >
                {/* Options List - Directly show options without search input */}
                <div className="max-h-60 overflow-y-auto" data-dropdown-scroll="true">
                  {companySuggestions.length > 0 ? (
                    companySuggestions.map((company, index) => (
                      <div
                        key={`company-${index}`}
                        className="px-4 py-3 text-lg text-white cursor-pointer hover:bg-gray-700 border-b border-gray-700 last:border-b-0 transition-colors"
                        onClick={() => canEdit && handleCompanySelect(company)}
                      >
                        <div className="flex items-center">
                          <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center mr-3 text-sm font-bold">
                            {company.charAt(0).toUpperCase()}
                          </div>
                          <span className="font-medium">{company}</span>
                        </div>
                      </div>
                    ))
                  ) : companyName.length >= 2 && !isCompanyLoading ? (
                    <div className="px-4 py-3 text-lg text-gray-400 italic">
                      No companies found. Click to add "{companyName}"
                    </div>
                  ) : companyName.length < 2 ? (
                    <div className="px-4 py-3 text-lg text-gray-400 italic">
                      Type at least 2 characters to search...
                    </div>
                  ) : null}
                  
                  {/* Add custom option if company name exists and is not in suggestions */}
                  {companyName.length >= 2 && !companySuggestions.includes(companyName) && (
                    <div
                      className="px-4 py-3 text-lg text-sky-400 cursor-pointer hover:bg-gray-700 border-t border-gray-600 font-medium transition-colors"
                      onClick={() => canEdit && handleCompanySelect(companyName)}
                    >
                      <div className="flex items-center">
                        <div className="w-8 h-8 rounded-full bg-sky-500 text-white flex items-center justify-center mr-3 text-sm font-bold">
                          +
                        </div>
                        <span>Add "{companyName}"</span>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
          
          {/* Enhanced Obligations Table */}
          <div className="mb-6 bg-black rounded-lg border-2 border-gray-600 shadow-lg relative">
            <div className="relative" style={{ position: 'relative', zIndex: 1 }}>
              <div className="overflow-x-auto" style={{ overflowY: 'visible' }}>
                <table className="w-full border-collapse align-middle" style={{ position: 'relative' }}>
                <thead>
                  <tr className="bg-black border-b-2 border-gray-600 align-middle">
                    <th className="px-2 py-2 text-sm font-bold text-white border-r-2 border-gray-600 text-center w-8">#</th>
                    <th className="px-2 py-2 text-sm font-bold text-white border-r-2 border-gray-600 text-center w-48">PRODUCT</th>
                    <th className="px-2 py-2 text-sm font-bold text-white border-r-2 border-gray-600 text-center w-72">BANK NAME</th>
                    <th className="px-2 py-2 text-sm font-bold text-white border-r-2 border-gray-600 text-center w-26">TENURE</th>
                    <th className="px-2 py-2 text-sm font-bold text-white border-r-2 border-gray-600 text-center w-16">ROI %</th>
                    <th className="px-2 py-2 text-sm font-bold text-white border-r-2 border-gray-600 text-center w-32">TOTAL LOAN</th>
                    <th className="px-2 py-2 text-sm font-bold text-white border-r-2 border-gray-600 text-center w-32">OUTSTANDING</th>
                    <th className="px-2 py-2 text-sm font-bold text-white border-r-2 border-gray-600 text-center w-28">EMI</th>
                    <th className="px-2 py-2 text-sm font-bold text-white border-r-2 border-gray-600 text-center w-24">ACTIONS</th>
                    <th className="px-2 py-2 text-sm font-bold text-white text-center w-8">DEL</th>
                  </tr>
                </thead>
                <tbody>
                  {obligations.map((row, idx) => {
                    // Debug Credit Card button states
                    if (row.product === 'CC (Credit Card)') {
                      console.log(`Rendering Credit Card row ${idx}:`, {
                        selectedTenurePercentage: row.selectedTenurePercentage,
                        selectedRoiPercentage: row.selectedRoiPercentage,
                        selectedTenurePercentageType: typeof row.selectedTenurePercentage,
                        selectedRoiPercentageType: typeof row.selectedRoiPercentage,
                        tenure: row.tenure,
                        roi: row.roi,
                        tenureButtonActive: row.selectedTenurePercentage === 4,
                        roiButtonActive: row.selectedRoiPercentage === 5
                      });
                    }
                    
                    // Debug action value for each row render  
                    console.log(`ðŸŽ¬ Rendering row ${idx} with action: "${row.action}" (ID: ${row.id})`);
                    console.log(`ðŸŽ¬ Full row data:`, { id: row.id, action: row.action, product: row.product });
                    
                    return (
                    <tr key={row.id || `row-${idx}`} className={`border-b-2 text-[12px] border-gray-600 align-middle ${getRowStyling(row.action)}`}>
                      <td className="px-1 py-1 text-center  text-white font-bold border-r-2 border-gray-600 bg-black">{idx + 1}</td>

                      {/* Product Select - Searchable Dropdown */}
                      <td className="px-2 py-2 border-r-2 border-gray-600 bg-black relative">
                        <div className="relative">
                          <div 
                            ref={el => dropdownRefs.current[`product-${idx}`] = el}
                            className={`w-full px-2 py-2 text-sm font-bold rounded border-2 focus:outline-none focus:ring-1 focus:ring-blue-400 cursor-pointer flex items-center justify-between ${getInputStyling(row.action)} ${!canEdit ? 'opacity-50 cursor-not-allowed' : ''}`}
                            onClick={() => canEdit && handleProductDropdownToggle(idx)}
                            data-dropdown-trigger="true"
                          >
                            <span className={`${row.product ? '' : 'text-black'} uppercase`}>
                              {row.product ? productTypes.find(p => p.value === row.product)?.label || row.product : 'Select Product'}
                            </span>
                            <ChevronDown className="h-4 w-4 ml-2 flex-shrink-0" />
                          </div>
                        </div>
                      </td>

                      {/* Bank Name Select - Searchable Dropdown */}
                      <td className="px-2 py-2 border-r-2 border-gray-600 bg-black relative">
                        <div className="relative">
                          <div 
                            ref={el => dropdownRefs.current[`bank-${idx}`] = el}
                            className={`w-full px-2 py-2 text-sm font-bold rounded border-2 focus:outline-none focus:ring-1 focus:ring-blue-400 cursor-pointer flex items-center justify-between ${getInputStyling(row.action)} ${!canEdit ? 'opacity-50 cursor-not-allowed' : ''}`}
                            onClick={() => canEdit && handleBankDropdownToggle(idx)}
                            data-dropdown-trigger="true"
                          >
                            <span className={`${row.bankName ? '' : 'text-black'} uppercase`}>
                              {row.bankName || ''}
                              {row.bankName && companyType.includes(row.bankName) ? '': ''}
                            </span>
                            <ChevronDown className="h-4 w-4 ml-2 flex-shrink-0" />
                          </div>
                        </div>
                      </td>

                      {/* Tenure - Show 4% button for Credit Card */}
                      <td className="px-1 py-1 border-r-2 border-gray-600 bg-black">
                        {row.product === 'CC (Credit Card)' ? (
                          <div className="flex gap-1 justify-center">
                            <button
                              type="button"
                              className={`px-2 py-1 text-sm font-bold rounded border-2 transition-colors ${
                                (row.selectedTenurePercentage === 4 || row.selectedTenurePercentage === '4')
                                  ? 'bg-green-500 text-white border-green-600' 
                                  : 'bg-white text-black border-gray-300 hover:bg-gray-100'
                              } ${
                                !row.outstanding || parseINR(row.outstanding) === 0
                                  ? 'opacity-50 cursor-not-allowed'
                                  : 'cursor-pointer'
                              }`}
                              onClick={() => {
                                if (!canEdit) return;
                                console.log('4% button clicked for row:', idx, 'Current selectedTenurePercentage:', row.selectedTenurePercentage, 'Type:', typeof row.selectedTenurePercentage);
                                handleCreditCardTenure(idx);
                              }}
                              disabled={!canEdit || !row.outstanding || parseINR(row.outstanding) === 0}
                            >
                              4%
                            </button>
                          </div>
                        ) : (
                          <input
                            type="text"
                            className={`w-full px-2 py-2 text-sm text-center rounded border-2 focus:outline-none focus:ring-1 focus:ring-blue-400 ${getInputStyling(row.action)} placeholder-black`}
                            placeholder="months"
                            maxLength="12"
                            value={row.tenure}
                            disabled={!canEdit}
                            onFocus={e => {
                              // Position cursor at the end of numbers when focusing
                              const input = e.target;
                              const rawValue = input.value.replace(/[^0-9]/g, "");
                              if (rawValue) {
                                setTimeout(() => {
                                  input.setSelectionRange(rawValue.length, rawValue.length);
                                }, 0);
                              }
                            }}
                            onChange={e => {
                              if (!canEdit) return;
                              const input = e.target;
                              const cursorPosition = input.selectionStart;
                              const rawValue = e.target.value.replace(/[^0-9]/g, "");
                              const formattedValue = rawValue ? formatTenure(rawValue) : '';
                              handleObligationChange(idx, "tenure", formattedValue);
                              
                              // Restore cursor position after formatting
                              setTimeout(() => {
                                if (input && rawValue) {
                                  const newPosition = Math.min(cursorPosition, rawValue.length);
                                  input.setSelectionRange(newPosition, newPosition);
                                }
                              }, 0);
                            }}
                          />
                        )}
                      </td>

                      {/* ROI - Show 5% button for Credit Card */}
                      <td className="px-1 py-1 border-r-2 border-gray-600 bg-black">
                        {row.product === 'CC (Credit Card)' ? (
                          <div className="flex gap-1 justify-center">
                            <button
                              type="button"
                              className={`px-2 py-1 text-sm font-bold rounded border-2 transition-colors ${
                                (row.selectedRoiPercentage === 5 || row.selectedRoiPercentage === '5')
                                  ? 'bg-green-500 text-white border-green-600' 
                                  : 'bg-white text-black border-gray-300 hover:bg-gray-100'
                              } ${
                                !row.outstanding || parseINR(row.outstanding) === 0
                                  ? 'opacity-50 cursor-not-allowed'
                                  : 'cursor-pointer'
                              }`}
                              onClick={() => {
                                if (!canEdit) return;
                                console.log('5% button clicked for row:', idx, 'Current selectedRoiPercentage:', row.selectedRoiPercentage, 'Type:', typeof row.selectedRoiPercentage);
                                handleCreditCardRoi(idx);
                              }}
                              disabled={!canEdit || !row.outstanding || parseINR(row.outstanding) === 0}
                            >
                              5%
                            </button>
                          </div>
                        ) : (
                          <input
                            type="text"
                            className={`w-full px-2 py-2 text-sm text-center rounded border-2 focus:outline-none focus:ring-1 focus:ring-blue-400 ${getInputStyling(row.action)} placeholder-black`}
                            placeholder="%"
                            maxLength="8"
                            value={row.roi}
                            disabled={!canEdit}
                            onFocus={e => {
                              // Position cursor at the end of numbers when focusing
                              const input = e.target;
                              const rawValue = input.value.replace(/[^0-9.]/g, "");
                              if (rawValue) {
                                setTimeout(() => {
                                  input.setSelectionRange(rawValue.length, rawValue.length);
                                }, 0);
                              }
                            }}
                            onChange={e => {
                              if (!canEdit) return;
                              const input = e.target;
                              const cursorPosition = input.selectionStart;
                              const rawValue = e.target.value.replace(/[^0-9.]/g, "");
                              const formattedValue = rawValue ? formatROI(rawValue) : '';
                              handleObligationChange(idx, "roi", formattedValue);
                              
                              // Restore cursor position after formatting
                              setTimeout(() => {
                                if (input && rawValue) {
                                  const newPosition = Math.min(cursorPosition, rawValue.length);
                                  input.setSelectionRange(newPosition, newPosition);
                                }
                              }, 0);
                            }}
                          />
                        )}
                      </td>

                      {/* Total Loan */}
                      <td className="px-1 py-1 border-r-2 border-gray-600 bg-black">
                        <input
                          type="text"
                          className={`w-full px-1 py-1 text-sm text-center rounded border-2 focus:outline-none focus:ring-1 focus:ring-blue-400 ${getInputStyling(row.action)} placeholder-black`}
                          placeholder="Total loan"
                          value={row.totalLoan}
                          disabled={!canEdit}
                          onChange={e => {
                            if (!canEdit) return;
                            const raw = e.target.value.replace(/[^0-9.]/g, "");
                            handleObligationChange(idx, "totalLoan", formatINR(raw));
                          }}
                          inputMode="numeric"
                        />
                      </td>

                      {/* Outstanding */}
                      <td className="px-1 py-1 border-r-2 border-gray-600 bg-black">
                        <input
                          type="text"
                          className={`w-full px-1 py-1 text-sm text-center rounded border-2 focus:outline-none focus:ring-1 focus:ring-blue-400 ${getInputStyling(row.action)} placeholder-black`}
                          placeholder="Outstanding"
                          value={row.outstanding}
                          disabled={!canEdit}
                          onChange={e => {
                            if (!canEdit) return;
                            const raw = e.target.value.replace(/[^0-9.]/g, "");
                            handleObligationChange(idx, "outstanding", formatINR(raw));
                          }}
                          inputMode="numeric"
                        />
                      </td>

                      {/* EMI - Read-only for Credit Card */}
                      <td className="px-1 py-1 border-r-2 border-gray-600 bg-black">
                        <input
                          type="text"
                          className={`w-full px-1 py-1 text-sm text-center rounded border-2 focus:outline-none focus:ring-1 focus:ring-blue-400 ${getInputStyling(row.action)} placeholder-black`}
                          placeholder="EMI"
                          value={row.emi}
                          disabled={!canEdit}
                          onChange={e => {
                            if (!canEdit || row.product === 'CC (Credit Card)') return;
                            const raw = e.target.value.replace(/[^0-9.]/g, "");
                            handleObligationChange(idx, "emi", formatINR(raw));
                          }}
                          readOnly={row.product === 'CC (Credit Card)'}
                          inputMode="numeric"
                        />
                      </td>

                      {/* Action Select with Enhanced Color Coding - UNCONTROLLED VERSION */}
                      <td className="px-1 py-1 border-r-2 border-gray-600 bg-black">
                        <select
                          ref={el => {
                            if (el) {
                              // Always force the correct value on render
                              const correctValue = row.action || 'Obligate';
                              if (el.value !== correctValue) {
                                el.value = correctValue;
                                console.log(`ðŸ”§ REF UPDATE: Row ${idx} select forced to show "${correctValue}"`);
                              }
                            }
                          }}
                          className={`w-full px-1 py-1 text-sm text-center rounded border-2 focus:outline-none focus:ring-1 focus:ring-blue-400 ${getActionSelectStyling(row.action)}`}
                          disabled={!canEdit}
                          onChange={e => {
                            if (!canEdit) return;
                            const newAction = e.target.value;
                            console.log(`CHANGE EVENT: Row ${idx} changed to "${newAction}"`);
                            
                            // Update the state
                            handleObligationChange(idx, "action", newAction);
                            
                            console.log(`STATE UPDATED: Row ${idx} action set to "${newAction}"`);
                          }}
                          onFocus={() => {
                            console.log(`FOCUS: Row ${idx} dropdown focused`);
                          }}
                          onBlur={() => {
                            console.log(`BLUR: Row ${idx} dropdown blurred`);
                          }}
                        >
                          {actionTypes.map(opt => (
                            if (!canEdit) return;
                            const newAction = e.target.value;
                            console.log(`ðŸ”„ Action dropdown onChange - Row ${idx}: ${row.action} â†’ ${newAction}`);
                            console.log(`ðŸ”„ Dropdown element value:`, e.target.value);
                            console.log(`ðŸ”„ Row object before change:`, row);
                            
                            // Immediately update the select element's value
                            e.target.value = newAction;
                            
                            // Update state
                            handleObligationChange(idx, "action", newAction);
                            
                            console.log(`âœ… Action change completed for row ${idx} - Select shows: ${e.target.value}`);
                            
                            // Additional forced update
                            setTimeout(() => {
                              if (e.target) {
                                e.target.value = newAction;
                                console.log(`ï¿½ Forced select update - Value now: ${e.target.value}`);
                              }
                            }, 10);
                          }}
                          onFocus={() => {
                            console.log(`ðŸŽ¯ Action dropdown focused - Row ${idx}, Current value: ${row.action}`);
                          }}
                          onBlur={(e) => {
                            console.log(`ðŸ‘‹ Action dropdown blurred - Row ${idx}, Final value: ${e.target.value}`);
                            // Ensure the value is correct on blur
                            if (e.target.value !== (row.action || 'Obligate')) {
                              e.target.value = row.action || 'Obligate';
                              console.log(`ï¿½ Corrected select value on blur to: ${e.target.value}`);
                            }
                          }}
                        >
                          {actionTypes.map(opt => (
                            <option 
                              key={opt.value} 
                              value={opt.value} 
                              className="bg-white text-black font-bold"
                            >
                              {opt.label}
                            </option>
                          ))}
                        </select>
                      </td>

                      {/* Delete Button */}
                      <td className="px-1 py-1 text-center bg-black">
                        <button
                          className={`${
                            obligations.length <= 1 
                              ? 'text-gray-400 cursor-not-allowed' 
                              : 'text-red-500 hover:text-red-700 hover:bg-red-100'
                          } p-1 rounded transition-colors`}
                          onClick={() => handleDeleteObligation(idx)}
                          disabled={obligations.length <= 1}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </td>
                    </tr>
                    );
                  })}
                </tbody>
              </table>
              </div>
            </div>
            
            {/* Add New Row Button and Save Button */}
            <div className="flex justify-center gap-4 p-4 bg-black border-t-2 border-gray-600">
              <button
                className="px-6 py-3 font-bold text-lg text-white bg-blue-600 border-2 border-blue-700 rounded-lg hover:bg-blue-700 hover:border-blue-800 transition-all duration-200"
                onClick={handleAddObligation}
                type="button"
              >
                ADD NEW ROW
              </button>
            </div>
          </div>

          {/* --- CHECK ELIGIBILITY SECTION --- */}
          <div className="p-4 mt-6 mb-4 border rounded-lg border-gray-600 bg-black">
            <div className="mb-3 text-2xl font-bold text-green-400">Check Eligibility</div>
            {/* First Row */}
            <div className="flex flex-wrap gap-4 mb-4">
              {/* Total Income */}
              <div className="form-group flex-1 min-w-[180px]">
                <label className="block mb-1 text-base font-bold text-white">Total Income</label>
                <input
                  type="text"
                  className="w-full px-2 py-1 text-lg font-bold text-white bg-black border rounded-lg form-control border-gray-600"
                  value={eligibility.totalIncome}
                  readOnly
                />
              </div>
              {/* Company Category Dropdown */}
              <div className="form-group flex-1 min-w-[320px]">
                <label className="block mb-1 text-base font-bold text-white">
                  Company Category
                </label>
                <select
                  className="w-full px-2 py-1 text-lg text-white bg-gray-700 border rounded-lg form-select border-gray-600 font-bold"
                  value={ceCompanyCategory}
                  onChange={canEdit ? handleCeCompanyCategoryChange : undefined}
                  disabled={!canEdit}
                >
                  <option value="" className="text-gray-400 font-bold">Select Category</option>
                  {(dynamicCompanyCategories.length > 0 ? dynamicCompanyCategories : checkEligibilityCompanyCategories).map((opt) => (
                    <option key={opt.value || opt.id} value={opt.value || opt.id} className="text-white font-bold bg-gray-700">
                      {opt.label || opt.display_text || opt.category_name}
                    </option>
                  ))}
                </select>
              </div>
              {/* FOIR % */}
              <div className="form-group flex-1 min-w-[120px] max-w-[120px]">
                <label className="block mb-1 text-base font-bold text-white">FOIR %</label>
                {ceFoirPercent === 'custom' ? (
                  <input
                    type="text"
                    className="w-full px-2 py-1 text-lg text-white bg-gray-700 border rounded-lg form-control border-gray-600 font-bold [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none placeholder-gray-400"
                    value={ceCustomFoirPercent}
                    placeholder="Enter %"
                    disabled={!canEdit}
                    onFocus={e => {
                      // Position cursor at the end of numbers when focusing
                      const input = e.target;
                      const rawValue = input.value.replace(/[^0-9.]/g, "");
                      if (rawValue) {
                        setTimeout(() => {
                          input.setSelectionRange(rawValue.length, rawValue.length);
                        }, 0);
                      }
                    }}
                    onChange={e => {
                      if (!canEdit) return;
                      const input = e.target;
                      const cursorPosition = input.selectionStart;
                      const rawValue = e.target.value.replace(/[^0-9.]/g, "");
                      const formattedValue = rawValue ? formatROI(rawValue) : '';
                      setCeCustomFoirPercent(formattedValue);
                      
                      // Mark as changed to trigger save button
                      setHasUserInteraction(true);
                      setHasUnsavedChanges(true);
                      console.log("Custom FOIR percent changed:", formattedValue);
                      
                      // If custom value is cleared, switch back to dropdown
                      if (!rawValue) {
                        setCeFoirPercent(60); // Switch back to default dropdown value
                      }
                      
                      // Restore cursor position after formatting
                      setTimeout(() => {
                        if (input && rawValue) {
                          const newPosition = Math.min(cursorPosition, rawValue.length);
                          input.setSelectionRange(newPosition, newPosition);
                        }
                      }, 0);
                    }}
                  />
                ) : (
                  <select
                    className="w-full px-2 py-1 text-lg text-white bg-gray-700 border rounded-lg form-select border-gray-600 font-bold"
                    value={ceFoirPercent}
                    onChange={canEdit ? handleCeFoirPercentChange : undefined}
                    disabled={!canEdit}
                  >
                    <option value={45} className="text-white font-bold bg-gray-700">45%</option>
                    <option value={50} className="text-white font-bold bg-gray-700">50%</option>
                    <option value={55} className="text-white font-bold bg-gray-700">55%</option>
                    <option value={60} className="text-white font-bold bg-gray-700">60%</option>
                    <option value={65} className="text-white font-bold bg-gray-700">65%</option>
                    <option value={70} className="text-white font-bold bg-gray-700">70%</option>
                    <option value={75} className="text-white font-bold bg-gray-700">75%</option>
                    <option value={80} className="text-white font-bold bg-gray-700">80%</option>
                    <option value="custom" className="text-white font-bold bg-gray-700">Custom</option>
                  </select>
                )}
              </div>
              {/* FOIR Amount */}
              <div className="form-group flex-1 min-w-[160px]">
                <label className="block mb-1 text-base font-bold text-white">FOIR Amount</label>
                <input
                  type="text"
                  className="w-full px-2 py-1 text-lg font-bold text-white bg-black border rounded-lg form-control border-gray-600"
                  value={eligibility.foirAmount}
                  readOnly
                />
              </div>
              {/* Total Obligation */}
              <div className="form-group flex-1 min-w-[180px] max-w-[180px]">
                <label className="block mb-1 text-base font-bold text-white">Total Obligation</label>
                <input
                  type="text"
                  className="w-full px-2 py-1 text-lg font-bold text-black bg-yellow-400 border border-yellow-600 rounded-lg form-control"
                  value={eligibility.totalObligations}
                  readOnly
                />
              </div>
            </div>
            {/* Second Row */}
            <div className="flex flex-wrap gap-4 mb-4">
              {/* Monthly EMI Can Pay - Auto Calculated */}
              <div className="form-group flex-1 min-w-[180px]">
                <label className="block mb-1 text-base font-bold text-white">Monthly EMI Can Pay</label>
                <input
                  type="text"
                  className="w-full px-2 py-1 text-lg font-bold text-white bg-black border rounded-lg form-control border-gray-600"
                  value={formatINR(ceMonthlyEmiCanPay.toString())}
                  readOnly
                />
              </div>
              {/* Tenure (Months) */}
              <div className="form-group flex-1 min-w-[180px]">
                <label className="block mb-1 text-base font-bold text-white">TENURE (Months)</label>
                <input
                  type="text"
                  className="w-full px-2 py-1 text-lg text-white bg-gray-700 border rounded-lg form-control border-gray-600 font-bold [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none placeholder-gray-400"
                  value={ceTenureMonths}
                  placeholder="Months"
                  disabled={!canEdit}
                  onFocus={e => {
                    // Position cursor at the end of numbers when focusing
                    const input = e.target;
                    const rawValue = input.value.replace(/[^0-9]/g, "");
                    if (rawValue) {
                      setTimeout(() => {
                        input.setSelectionRange(rawValue.length, rawValue.length);
                      }, 0);
                    }
                  }}
                  onChange={canEdit ? handleCeTenureMonthsChange : undefined}
                />
              </div>
              {/* Tenure (Years) */}
              <div className="form-group flex-1 min-w-[180px]">
                <label className="block mb-1 text-base font-bold text-white">TENURE (Years)</label>
                <input
                  type="text"
                  className="w-full px-2 py-1 text-lg text-white bg-black border rounded-lg form-control border-gray-600 font-bold [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none placeholder-gray-400"
                  value={ceTenureYears}
                  placeholder="Years"
                  disabled
                  onFocus={e => {
                    // Position cursor at the end of numbers when focusing
                    const input = e.target;
                    const rawValue = input.value.replace(/[^0-9.]/g, "");
                    if (rawValue) {
                      setTimeout(() => {
                        input.setSelectionRange(rawValue.length, rawValue.length);
                      }, 0);
                    }
                  }}
                  onChange={handleCeTenureYearsChange}
                />
              </div>
              {/* ROI */}
              <div className="form-group flex-1 min-w-[140px]">
                <label className="block mb-1 text-base font-bold text-white">ROI</label>
                <input
                  type="text"
                  className="w-full px-2 py-1 text-lg text-white bg-gray-700 border rounded-lg form-control border-gray-600 font-bold [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none placeholder-gray-400"
                  value={ceRoi}
                  placeholder="%"
                  disabled={!canEdit}
                  onFocus={e => {
                    // Position cursor at the end of numbers when focusing
                    const input = e.target;
                    const rawValue = input.value.replace(/[^0-9.]/g, "");
                    if (rawValue) {
                      setTimeout(() => {
                        input.setSelectionRange(rawValue.length, rawValue.length);
                      }, 0);
                    }
                  }}
                  onChange={canEdit ? handleCeRoiChange : undefined}
                />
              </div>
              {/* TOTAL BT POS */}
              <div className="form-group flex-1 min-w-[180px] max-w-[180px]">
                <label className="block mb-1 text-base font-bold text-white">TOTAL BT POS</label>
                <input
                  type="text"
                  className="w-full px-2 py-1 text-lg font-bold text-black bg-green-400 border border-green-600 rounded-lg form-control"
                  value={eligibility.totalBtPos}
                  readOnly
                />
              </div>
            </div>
            {/* Third Row - Loan Eligibility Results */}
            <div className="flex flex-wrap items-end gap-4 mb-2">
              {/* Loan Eligibility As Per FOIR */}
              <div className="form-group flex-1 min-w-[280px]">
                <label className="block mb-1 text-base font-bold text-white">FOIR Eligibility</label>
                <input
                  type="text"
                  className="w-full px-4 py-4 font-bold text-white bg-black border rounded-lg form-control border-gray-600 text-2xl"
                  value={eligibility.finalEligibility}
                  readOnly
                />
              </div>
              {/* Loan Eligibility As Per Multiplier */}
              <div className="form-group flex-1 min-w-[280px]">
                <div className="flex items-center justify-between mb-1">
                  <label className="block text-base font-bold text-white">Multiplier Eligibility</label>
                  <div className="flex items-center gap-2">
                    <span className="text-xs font-semibold text-white">Multiplier:</span>
                    <input
                      type="text"
                      className="w-16 px-2 py-1 text-black bg-yellow-400 border rounded-lg form-control border-yellow-600 font-bold [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none placeholder-black text-sm"
                      value={ceMultiplier}
                      onChange={canEdit ? handleCeMultiplierChange : undefined}
                      disabled={!canEdit}
                      placeholder="0"
                      inputMode="numeric"
                    />
                  </div>
                </div>
                <input
                  type="text"
                  className="w-full px-4 py-4 font-bold text-white bg-black border rounded-lg form-control border-gray-600 text-2xl"
                  value={eligibility.multiplierEligibility}
                  readOnly
                />
              </div>
            </div>
            
            {/* Balance Transfer Eligibility Message */}
            <div className="mt-6">
              {(() => {
                try {
                  const foirEligibility = parseINR(eligibility?.finalEligibility) || 0;
                  const totalBtPos = parseINR(eligibility?.totalBtPos) || 0;
                  
                  // Only show message if there's meaningful data for calculation
                  // Check if user has provided necessary inputs for a valid calculation
                  const hasRequiredInputs = 
                    (salary && parseINR(salary) > 0 || partnerSalary && parseINR(partnerSalary) > 0) && // Some income
                    (ceFoirPercent !== '' && ceFoirPercent !== null && ceFoirPercent !== undefined) && // FOIR percentage set
                    (ceRoi && parseROI(ceRoi) > 0) && // ROI provided
                    (ceTenureMonths && parseTenure(ceTenureMonths) > 0) && // Tenure provided
                    totalBtPos > 0; // Some BT POS amount exists
                  
                  if (!hasRequiredInputs) {
                    return null; // Don't show message if required inputs are missing
                  }
                  
                  if (foirEligibility >= totalBtPos) {
                    // Success message
                    return (
                      <div className="p-6 rounded-lg text-black text-center" style={{ backgroundColor: '#00FF00' }}>
                        <div className="flex items-center justify-center mb-2">
                          <svg className="w-8 h-8 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                          </svg>
                          <h2 className="text-3xl font-extrabold">Congratulations!</h2>
                        </div>
                        <p className="text-2xl font-bold">Balance Transfer is Eligible</p>
                      </div>
                    );
                  } else {
                    // Failure message with shortfall
                    const shortfall = Math.max(0, totalBtPos - foirEligibility);
                    return (
                      <div className="p-6 rounded-lg text-white text-center" style={{ backgroundColor: '#FF0000' }}>
                        <div className="flex items-center justify-center mb-2">
                          <svg className="w-8 h-8 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                          </svg>
                          <h2 className="text-3xl font-extrabold">Balance Transfer Not Possible</h2>
                        </div>
                        <p className="text-2xl font-bold">There is a shortfall of â‚¹{formatINR(shortfall.toString())}</p>
                      </div>
                    );
                  }
                } catch (error) {
                  console.error('Error in eligibility calculation:', error);
                  return null;
                }
              })()}
            </div>
          </div>
        </div>
      </div>
      
      {/* Floating Dropdown Cards - Positioned outside table container */}
      {(() => {
        try {
          if (!safeProductSearchStates || typeof safeProductSearchStates !== 'object') return null;
          
          const stateKeys = Object.keys(safeProductSearchStates || {});
          if (stateKeys.length === 0) return null;
          
          return stateKeys.map(idx => {
            // Multiple safety checks inside the map function
            if (!safeProductSearchStates || !safeProductSearchStates[idx] || typeof safeProductSearchStates[idx] !== 'object') return null;
            
            const stateForIdx = safeProductSearchStates[idx];
            if (!stateForIdx || !stateForIdx.isOpen) return null;
            
            return (
          <div
            key={`product-dropdown-${idx}`}
            className="fixed z-[9999] bg-white border-2 border-gray-300 rounded-lg shadow-2xl overflow-hidden"
            data-dropdown-container="true"
            style={{
              left: `${(dropdownPositions && dropdownPositions[`product-${idx}`]?.left) || 0}px`,
              top: `${(dropdownPositions && dropdownPositions[`product-${idx}`]?.top) || 0}px`,
              width: `${(dropdownPositions && dropdownPositions[`product-${idx}`]?.width) || 300}px`,
              maxHeight: '250px'
            }}
          >
            <div className="p-3 border-b border-gray-200 bg-gray-50">
              <div className="flex items-center">
                <Search className="h-4 w-4 text-gray-400 mr-2" />
                <input
                  type="text"
                  className="w-full px-3 py-2 text-sm text-black border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
                  placeholder="Search products..."
                  value={(safeProductSearchStates && safeProductSearchStates[idx]?.searchQuery) || ''}
                  onChange={(e) => canEdit && handleProductSearchChange(parseInt(idx), e.target.value)}
                  disabled={!canEdit}
                  onClick={(e) => e.stopPropagation()}
                  data-search-input="product"
                  autoFocus
                />
              </div>
            </div>
            <div className="max-h-48 overflow-y-auto bg-white" data-dropdown-scroll="true">
              {getFilteredProducts(parseInt(idx)).map((product, index) => (
                <div
                  key={product.value}
                  className="px-4 py-3 text-sm text-black cursor-pointer hover:bg-blue-50 font-medium border-b border-gray-100 last:border-b-0 transition-colors"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleProductSelect(parseInt(idx), product);
                  }}
                >
                  <div className="flex items-center justify-between">
                    <span>{product.label}</span>
                    <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">#{index + 1}</span>
                  </div>
                </div>
              ))}
              {getFilteredProducts(parseInt(idx)).length === 0 && (
                <div className="px-4 py-6 text-sm text-gray-500 text-center">
                  <div className="text-gray-400 mb-1">ðŸ”</div>
                  No products found
                </div>
              )}
            </div>
          </div>
            );
          });
        } catch (error) {
          console.warn('Error rendering product dropdowns:', error);
          return null;
        }
      })()}
      
      {(() => {
        try {
          if (!safeBankSearchStates || typeof safeBankSearchStates !== 'object') return null;
          
          const stateKeys = Object.keys(safeBankSearchStates || {});
          if (stateKeys.length === 0) return null;
          
          return stateKeys.map(idx => {
            // Multiple safety checks inside the map function
            if (!safeBankSearchStates || !safeBankSearchStates[idx] || typeof safeBankSearchStates[idx] !== 'object') return null;
            
            const stateForIdx = safeBankSearchStates[idx];
            if (!stateForIdx || !stateForIdx.isOpen) return null;
            
            return (
          <div
            key={`bank-dropdown-${idx}`}
            className="fixed z-[9999] bg-white border-2 border-gray-300 rounded-lg shadow-2xl overflow-hidden"
            data-dropdown-container="true"
            style={{
              left: `${(dropdownPositions && dropdownPositions[`bank-${idx}`]?.left) || 0}px`,
              top: `${(dropdownPositions && dropdownPositions[`bank-${idx}`]?.top) || 0}px`,
              width: `${(dropdownPositions && dropdownPositions[`bank-${idx}`]?.width) || 300}px`,
              maxHeight: '250px'
            }}
          >
            <div className="p-3 border-b border-gray-200 bg-gray-50">
              <div className="flex items-center">
                <Search className="h-4 w-4 text-gray-400 mr-2" />
                <input
                  type="text"
                  className="w-full px-3 py-2 text-sm text-black border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400"
                  placeholder="Search banks..."
                  value={(safeBankSearchStates && safeBankSearchStates[idx]?.searchQuery) || ''}
                  onChange={(e) => canEdit && handleBankSearchChange(parseInt(idx), e.target.value)}
                  disabled={!canEdit}
                  onClick={(e) => e.stopPropagation()}
                  data-search-input="bank"
                  autoFocus
                />
              </div>
            </div>
            <div className="max-h-48 overflow-y-auto bg-white" data-dropdown-scroll="true">
              {getFilteredBanks(parseInt(idx)).map((bank, index) => (
                <div
                  key={`${bank}-${index}`}
                  className="px-4 py-3 text-sm text-black cursor-pointer hover:bg-blue-50 font-medium border-b border-gray-100 last:border-b-0 transition-colors"
                  onClick={(e) => {
                    e.stopPropagation();
                    console.log(`Bank option clicked: "${bank}" for index ${parseInt(idx)}`);
                    handleBankSelect(parseInt(idx), bank);
                  }}
                >
                  <div className="flex items-center justify-between">
                    <span>{bank}</span>
                    <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">#{index + 1}</span>
                  </div>
                </div>
              ))}
              {getFilteredBanks(parseInt(idx)).length === 0 && (
                <div className="px-4 py-6 text-sm text-gray-500 text-center">
                  <div className="text-gray-400 mb-1">ðŸ”</div>
                  No banks found
                </div>
              )}
            </div>
          </div>
            );
          });
        } catch (error) {
          console.warn('Error rendering bank dropdowns:', error);
          return null;
        }
      })()}

      {/* Bank Selection Popup - Updated for multiple selections */}
      {showBankPopup && (
        <BankPopup
          onClose={() => setShowBankPopup(false)}
          onSelect={(bank, isRemove = false) => {
            console.log('BankPopup: Selected bank for processing:', bank, isRemove ? '(removing)' : '(adding)');
            
            if (isRemove) {
              // Remove bank from selection
              setCompanyType(prev => prev.filter(b => b !== bank));
              console.log('Bank removed from selection:', bank);
            } else {
              // Add bank to selection
              handleAddBank(bank);
            }
            
            // Don't close popup automatically - allow multiple selections
            
            // Mark as having unsaved changes, but don't auto-save
            // User needs to click the save button to trigger API save
            setHasUnsavedChanges(true);
            
            // Notification for user to save changes
            console.log('Bank selection updated. Click "SAVE CHANGES" to save data to API.');
          }}
          multiSelect={true}
          companyTypes={companyTypes}
          selectedInitial={companyType}
        />
      )}

      {/* Category Selection Popup */}
      {showCategoryPopup && (
        <CategoryPopup
        className="text-lg"
          initialCompanyName={companyName} // Pass current company name to pre-populate search
          onClose={() => setShowCategoryPopup(false)}
          onSelect={(category, isRemove = false) => {
            console.log('CategoryPopup: Selected category for immediate feedback:', category, isRemove ? '(removing)' : '(adding)');
            console.log('ðŸ”’ PARENT onSelect: This should NOT close the popup in multi-select mode');
            
            // For real-time visual feedback, immediately update the display in the main field
            // This makes selections visible instantly without waiting for Done button
            if (isRemove) {
              // Remove category from main state for immediate visual feedback
              setCompanyCategory(prev => {
                const getUniqueKey = (cat) => {
                  if (typeof cat === 'string') return cat;
                  if (cat.company_name && cat.bank_name && cat.category_name) {
                    return `${cat.company_name}_${cat.bank_name}_${cat.category_name}`;
                  }
                  if (cat.company_name && cat.category_name && !cat.bank_name) {
                    return `${cat.company_name}_${cat.category_name}`;
                  }
                  return cat.display_key || cat.value || cat.display_text || cat.label || cat.category_name || JSON.stringify(cat);
                };
                
                const categoryKey = getUniqueKey(category);
                return prev.filter(cat => getUniqueKey(cat) !== categoryKey);
              });
            } else {
              // Add category to main state for immediate visual feedback
              setCompanyCategory(prev => {
                const getUniqueKey = (cat) => {
                  if (typeof cat === 'string') return cat;
                  if (cat.company_name && cat.bank_name && cat.category_name) {
                    return `${cat.company_name}_${cat.bank_name}_${cat.category_name}`;
                  }
                  if (cat.company_name && cat.category_name && !cat.bank_name) {
                    return `${cat.company_name}_${cat.category_name}`;
                  }
                  return cat.display_key || cat.value || cat.display_text || cat.label || cat.category_name || JSON.stringify(cat);
                };
                
                const categoryKey = getUniqueKey(category);
                // Check if already exists to avoid duplicates
                if (prev.some(cat => getUniqueKey(cat) === categoryKey)) {
                  return prev;
                }
                return [...prev, category];
              });
            }
            
            console.log('âœ… Immediate visual feedback applied to main field - popup should stay open');
            // DO NOT close the popup here - let the CategoryPopup handle its own state
          }}
          onSave={() => {
            // This is called when Done button is clicked
            console.log('CategoryPopup Done button clicked, popup will handle category processing');
            setShowCategoryPopup(false);
          }}
          multiSelect={true}
          companyCategories={dynamicCompanyCategories.length > 0 ? dynamicCompanyCategories : companyCategories}
          selectedInitial={companyCategory} // Pass the current selections
          // Add onAddCategory callback to handle final category additions
          onAddCategory={(categories) => {
            console.log('=== MAIN COMPONENT: onAddCategory CALLED ===');
            console.log('Received categories from popup:', categories);
            console.log('Categories count:', categories.length);
            console.log('Current companyCategory state before processing:', companyCategory);
            
            // Since we're already providing immediate feedback through onSelect,
            // the onAddCategory is mainly for final confirmation
            // Just ensure the final state matches what was selected
            setCompanyCategory(categories || []);
            
            // Notify parent component of changes immediately for unsaved changes detection
            if (handleChangeFunc) {
              const categoryObjects = (categories || []).map(cat => ({
                company_name: cat.company_name || companyName || '',
                bank_name: cat.bank_name || '',
                category_name: cat.category_name || cat.key || cat.display || '',
                display_text: cat.display_text || cat.display || cat.label || '',
                ...cat
              }));
              console.log('Sending complete category objects to backend:', categoryObjects);
              handleChangeFunc('company_category', categoryObjects);
            }
            
            console.log('Final category update completed');
            // Mark as having unsaved changes
            setHasUnsavedChanges(true);
          }}
        />
      )}
      
      {/* Save Changes Button (Moved to the Bottom) */}
      <div className="flex justify-center gap-4 p-6 mt-8 mb-8 bg-black border-2 border-gray-600 rounded-lg shadow-lg">
        <button
          className={`px-8 py-4 font-bold text-xl text-white ${hasUnsavedChanges || hasUserInteraction ? 'bg-green-600 border-2 border-green-700 hover:bg-green-700 hover:border-green-800' : 'bg-gray-600 border-2 border-gray-700'} rounded-lg transition-all duration-200`}
          onClick={handleSaveObligationsWithChangeTracking}
          disabled={isSaving}
          type="button"
        >
          {isSaving ? 'SAVING...' : (hasUnsavedChanges || hasUserInteraction) ? 'SAVE CHANGES' : 'SAVED'}
        </button>
      </div>

      {/* Unsaved Changes Modal */}
      {showUnsavedChangesModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
          <div className="bg-white rounded-lg p-6 m-4 max-w-md w-full">
            <div className="text-center">
              <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                <svg className="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.268 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
              </div>
              <h3 className="text-lg font-bold text-gray-900 mb-2">Unsaved Changes</h3>
              <p className="text-sm text-gray-600 mb-6">
                You have unsaved changes in the obligation section. Do you want to save your changes before leaving?
              </p>
              <div className="flex gap-3">
                <button
                  onClick={() => setShowUnsavedChangesModal(false)}
                  className="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium"
                >
                  Stay Here
                </button>
                <button
                  onClick={() => {
                    setShowUnsavedChangesModal(false);
                    setHasUnsavedChanges(false);
                    // Allow navigation to continue
                    window.location.reload();
                  }}
                  className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium"
                >
                  Continue Without Saving
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// BankPopup component
function BankPopup({ onClose, onSelect, onSave, companyTypes, multiSelect = true, selectedInitial = [] }) {
  const [bankName, setBankName] = useState("");
  const [filteredBanks, setFilteredBanks] = useState([]);
  const [bankList, setBankList] = useState([]);
  const [isLoadingBanks, setIsLoadingBanks] = useState(true);
  const [selectedBanks, setSelectedBanks] = useState(selectedInitial || []);
  const [popularBanks, setPopularBanks] = useState([
    'AXIS BANK', 'HDFC BANK', 'ICICI BANK', 'SBI', 'YES BANK',
    'KOTAK BANK', 'IDFC FIRST BANK', 'BAJAJ FINANCE'
  ]);

  // Fetch bank names on component mount
  useEffect(() => {
    const loadBanks = async () => {
      setIsLoadingBanks(true);
      try {
        const banks = await fetchBankNames();
        if (banks && banks.length > 0) {
          // Convert to the format expected by the component
          const formattedBanks = banks.map(bank => ({
            value: typeof bank === 'string' ? bank : (bank.name || bank.label || String(bank)),
            label: typeof bank === 'string' ? bank : (bank.name || bank.label || String(bank))
          }));
          
          // Ensure popular banks are at the top
          const allBanks = [...formattedBanks];
          const uniqueBanks = [];
          
          // Add popular banks first (if they're in the list)
          popularBanks.forEach(popularBank => {
            const foundBank = allBanks.find(bank => 
              bank.label.toUpperCase().includes(popularBank) || 
              popularBank.includes(bank.label.toUpperCase())
            );
            
            if (foundBank) {
              uniqueBanks.push(foundBank);
            }
          });
          
          // Then add all other banks that aren't already in the list
          allBanks.forEach(bank => {
            if (!uniqueBanks.some(b => b.value === bank.value)) {
              uniqueBanks.push(bank);
            }
          });
          
          setBankList(uniqueBanks);
          setFilteredBanks(uniqueBanks);
        } else {
          // Fallback to companyTypes if API call fails
          setFilteredBanks(companyTypes);
        }
      } catch (error) {
        console.error('Error loading banks:', error);
        setFilteredBanks(companyTypes);
      } finally {
        setIsLoadingBanks(false);
      }
    };

    loadBanks();
  }, [companyTypes, popularBanks]);

  // Filter banks based on search input
  useEffect(() => {
    // If bankName is empty, show all banks
    if (bankName.trim() === "") {
      setFilteredBanks(bankList.length > 0 ? bankList : companyTypes);
    } else {
      // Otherwise, filter based on input
      const banksToFilter = bankList.length > 0 ? bankList : companyTypes;
      setFilteredBanks(
        banksToFilter.filter((bank) =>
          bank.label.toLowerCase().includes(bankName.toLowerCase())
        )
      );
    }
  }, [bankName, bankList, companyTypes]);

  const handleAssign = () => {
    if (bankName.trim()) {
      console.log('Bank assigned via Add Bank button:', bankName);
      
      // For multi-select mode, use the selected banks
      if (multiSelect) {
        // Add the current typed bank if needed
        if (bankName.trim() && !selectedBanks.includes(bankName.trim())) {
          onSelect(bankName.trim(), false);
          
          // Also add to local selection state
          setSelectedBanks(prev => [...prev, bankName.trim()]);
        }
      } 
      // For single-select mode, just use the current input
      else {
        onSelect(bankName.trim(), false);
        onClose(); // Only close in single-select mode
      }
      
      // Clear the input after assigning but keep popup open in multi-select mode
      setBankName("");
      
      // Never close the popup in multi-select mode from this function
      // The user must explicitly click "Done" or "Cancel"
    }
  };

  const selectBank = (selectedBank) => {
    // Ensure label is a string
    const labelValue = typeof selectedBank.label === 'string' 
      ? selectedBank.label 
      : String(selectedBank.label || selectedBank.value || '');
    
    // Check if the bank is already selected
    const isAlreadySelected = selectedBanks.includes(labelValue);
    
    if (isAlreadySelected) {
      // Remove from selected banks if already selected
      setSelectedBanks(prev => prev.filter(bank => bank !== labelValue));
      
      // Always notify parent that item was removed, regardless of multi-select mode
      // This ensures changes show up in the main field immediately
      if (typeof onSelect === 'function') {
        onSelect(labelValue, true); // true indicates removal
      }
    } else {
      // Add to selected banks
      setSelectedBanks(prev => [...prev, labelValue]);
      
      // Always notify parent when a bank is selected, regardless of multi-select mode
      // This ensures changes show up in the main field immediately
      if (typeof onSelect === 'function') {
        onSelect(labelValue, false); // false indicates addition
      }
    }
    
    // Don't set search field to the selected bank name
    // Keep search field empty to allow manual searching
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-transparent"
    >
      <div className="bg-transparent backdrop-blur-sm p-6 rounded-2xl shadow-2xl w-[95%] max-w-2xl mx-auto relative">
        <div className="flex items-center mb-4 bg-white bg-opacity-90 p-3 rounded-t-xl">
          <div className="w-10 h-10 rounded-full bg-[#03B0F5] text-white text-lg flex items-center justify-center mr-3">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h3M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 8h1m-1-4h1m4 4h1m-1-4h1" />
            </svg>
          </div>
          <h3 className="font-bold text-lg text-black">{multiSelect ? "Select Multiple Banks" : "Select Bank"}</h3>
          {multiSelect && <span className="ml-2 text-sm text-gray-600">(Click multiple items to select)</span>}
        </div>

        <div className="mb-4 bg-white bg-opacity-90 p-3 rounded-md">
          <label className="block font-bold text-gray-700 mb-2 text-lg">
            Search Banks {multiSelect && "(Select Multiple)"}
          </label>
          
          <div className="relative">
            <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            <input
              type="text"
              className="w-full pl-10 pr-3 py-2 border border-cyan-400 rounded text-black font-bold text-lg"
              value={bankName}
              onChange={(e) => setBankName(e.target.value)}
              placeholder="Search or enter bank name"
            />
            {bankName && (
              <button
                className="absolute inset-y-0 right-0 flex items-center pr-3 text-lg text-gray-400 hover:text-gray-600"
                onClick={() => setBankName("")}
                type="button"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            )}
          </div>
        </div>

        {/* Show loading or the bank list */}
        <div className="space-y-2 max-h-60 overflow-y-auto mb-4 border rounded-lg bg-white bg-opacity-90">
          {isLoadingBanks ? (
            <div className="p-5 flex items-center justify-center">
              <div className="animate-spin rounded-full h-8 w-8 text-lg border-t-2 border-b-2 border-cyan-500"></div>
              <span className="ml-3 text-gray-600 text-lg">Loading banks...</span>
            </div>
          ) : filteredBanks.length > 0 ? (
            filteredBanks.map((bank) => {
              // Get label value for consistency
              const labelValue = typeof bank.label === 'string' 
                ? bank.label 
                : String(bank.label || bank.value || '');
                
              // Check if this bank is selected (using more robust check)
              const isSelected = selectedBanks.some(b => 
                b === labelValue || 
                (typeof b === 'object' && b?.label === labelValue)
              );
              
              return (
                <div
                  key={bank.value || labelValue}
                  className={`p-3 border-b last:border-b-0 cursor-pointer text-lg text-black transition flex items-center ${isSelected ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                  onClick={() => selectBank(bank)}
                >
                  {/* Profile icon with initials */}
                  <div className={`w-8 h-8 rounded-full ${isSelected ? 'bg-cyan-600' : 'bg-[#03B0F5]'} text-white flex items-center justify-center mr-3 flex-shrink-0`}>
                    {typeof labelValue === 'string' 
                      ? labelValue.split(' ')
                          .map(part => part[0] || '')
                          .slice(0, 2)
                          .join('')
                          .toUpperCase()
                      : 'BK'}
                  </div>
                  <div className="flex-1">
                    <div className="font-medium text-lg">{labelValue}</div>
                  </div>
                  {/* Show checkmark if selected */}
                  {isSelected && (
                    <div className="ml-2 text-cyan-600">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                  )}
                </div>
              );
            })
          ) : (
            bankName.trim() !== "" && ( // Only show "No results" if user typed something and no results
              <div className="p-3 text-gray-500 text-center text-lg">No matching banks found.</div>
            )
          )}
        </div>

        <div className="flex justify-end gap-4 mt-4 bg-white bg-opacity-90 p-3 rounded-b-xl">
          {bankName.trim() && (
            <button
              className="px-6 py-3 bg-cyan-600 text-white rounded-xl shadow text-lg hover:bg-cyan-700 transition"
              onClick={handleAssign}
            >
              {multiSelect ? "Add Bank" : "Add Bank"}
            </button>
          )}
          {multiSelect && (
            <button
              className="px-6 py-3 bg-blue-600 text-white rounded-xl shadow text-lg hover:bg-blue-700 transition"
              onClick={() => {
                // Keep all selections and close the popup
                onClose();
              }}
            >
              Done
            </button>
          )}
          <button
            className="px-6 py-3 bg-gray-400 text-white text-lg rounded-xl shadow hover:bg-gray-500 transition"
            onClick={onClose}
          >
            Cancel
          </button>
        </div>

        <button
          className="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl font-bold"
          onClick={onClose}
        >
          Ã—
        </button>
      </div>
    </div>
  );
}

// CategoryPopup component - Enhanced company category search with API integration
function CategoryPopup({ initialCompanyName = '', onClose, onSelect, onSave, onAddCategory, companyCategories, multiSelect = true, selectedInitial = [] }) {
  const [companySearchInput, setCompanySearchInput] = useState(initialCompanyName || ""); // Use passed company name as initial search
  const [filteredCategories, setFilteredCategories] = useState([]);
  const [loading, setLoading] = useState(false);
  const [selectedCategories, setSelectedCategories] = useState(selectedInitial || []);
  const [searchTimeout, setSearchTimeout] = useState(null);
  const [searchResults, setSearchResults] = useState([]);
  const [hasSearched, setHasSearched] = useState(false);
  const [errorMessage, setErrorMessage] = useState('');
  
  // Debug log
  console.log('CategoryPopup rendered with multiSelect:', multiSelect, 'Initial selections:', selectedInitial, 'Initial company name:', initialCompanyName);

  // Initialize selected categories from props
  useEffect(() => {
    if (selectedInitial && Array.isArray(selectedInitial) && selectedInitial.length > 0) {
      console.log('Initializing selected categories from props:', selectedInitial);
      setSelectedCategories(selectedInitial);
    } else {
      console.log('No initial selections provided or empty array');
      setSelectedCategories([]);
    }
  }, [selectedInitial]);

  // Auto-search when popup opens with initial company name
  useEffect(() => {
    if (initialCompanyName && initialCompanyName.trim().length >= 2) {
      console.log('Auto-searching for initial company name:', initialCompanyName);
      // Delay the search slightly to allow the component to fully mount
      setTimeout(() => {
        handleSearch();
      }, 100);
    }
  }, [initialCompanyName]); // Only run when component mounts with initial company name
  
  // Auto-search when user types
  useEffect(() => {
    // Clear existing timeout
    if (searchTimeout) {
      clearTimeout(searchTimeout);
    }
    
    // Only set timeout if there's input to search
    if (companySearchInput.trim() !== "" && companySearchInput.trim().length >= 2) {
      // Set new timeout for debounced search
      const timeout = setTimeout(() => {
        handleSearch();
      }, 500); // Increased delay for better performance
      
      setSearchTimeout(timeout);
      
      // Cleanup function
      return () => {
        if (timeout) {
          clearTimeout(timeout);
        }
      };
    } else {
      // Clear search results when input is empty or too short
      setSearchResults([]);
      setFilteredCategories([]);
      setHasSearched(false);
      setErrorMessage('');
    }
  }, [companySearchInput]);

  // Enhanced search function for company categories
  const handleSearch = async () => {
    const searchQuery = companySearchInput.trim();
    
    if (!searchQuery || searchQuery.length < 2) {
      console.log('Search query too short, skipping search');
      setErrorMessage('Please enter at least 2 characters to search');
      return;
    }

    setLoading(true);
    setErrorMessage('');
    setHasSearched(true);
    
    try {
      const userId = getUserId();
      
      if (!userId) {
        throw new Error('No user ID found. Please log in again.');
      }

      console.log('ðŸ” Searching for company:', searchQuery);

      const requestPayload = {
        company_name: searchQuery,
        similarity_threshold: 0.6
      };

      const response = await fetch(`${API_BASE_URL}/settings/search-companies?user_id=${userId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestPayload)
      });

      if (!response.ok) {
        if (response.status === 422) {
          throw new Error('Invalid search query. Please check your input.');
        } else if (response.status === 404) {
          throw new Error('No companies found matching your search.');
        } else {
          throw new Error(`Search failed with status ${response.status}`);
        }
      }

      const data = await response.json();
      console.log('âœ… Search results received:', data);

      if (Array.isArray(data) && data.length > 0) {
        setSearchResults(data);
        
        // Transform data for display
        const transformedCategories = data.map((company, index) => {
          const companyName = company.company_name || 'Unknown Company';
          const categories = company.categories || [];
          const bankNames = company.bank_names || [];
          const similarity = company.similarity_percentage || 0;
          
          return categories.map((categoryName, catIndex) => ({
            id: `${companyName}-${categoryName}-${bankNames[0] || 'Unknown'}-${index}-${catIndex}`,
            company_name: companyName,
            category_name: categoryName,
            bank_name: bankNames[0] || 'No Bank Info',
            bank_names: bankNames,
            categories: categories,
            similarity_percentage: similarity,
            display_text: `${companyName} â†’ ${bankNames[0] || 'No Bank'} â†’ ${categoryName}`,
            display_key: `${companyName}-${bankNames[0] || 'Unknown'}-${categoryName}`,
            label: `${companyName} â†’ ${bankNames[0] || 'No Bank'} â†’ ${categoryName}`,
            value: `${companyName}-${bankNames[0] || 'Unknown'}-${categoryName}`
          }));
        }).flat();
        
        setFilteredCategories(transformedCategories);
        console.log('ðŸ“Š Transformed categories:', transformedCategories.length, 'categories found');
        
      } else {
        setSearchResults([]);
        setFilteredCategories([]);
        setErrorMessage(`No companies found matching "${searchQuery}". Try a different search term.`);
      }
    } catch (error) {
      console.error('âŒ Search error:', error);
      setSearchResults([]);
      setFilteredCategories([]);
      setErrorMessage(error.message || 'Failed to search companies. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  // Handle category selection/deselection
  const handleCategoryClick = (category) => {
    console.log('ðŸ”¥ CATEGORY CLICKED:', category);
    
    if (!multiSelect) {
      // Single select mode
      setSelectedCategories([category]);
    } else {
      // Multi select mode
      let newSelection = [...selectedCategories];
      const categoryKey = category.display_key || category.value || category.display_text || category.category_name || JSON.stringify(category);
      
      // Check if category is already selected
      const existingIndex = newSelection.findIndex(selected => {
        const selectedKey = selected.display_key || selected.value || selected.display_text || selected.category_name || JSON.stringify(selected);
        return selectedKey === categoryKey;
      });
      
      if (existingIndex >= 0) {
        // Remove from selection
        newSelection.splice(existingIndex, 1);
      } else {
        // Add to selection
        newSelection.push(category);
      }
      
      setSelectedCategories(newSelection);
    }
  };

  // Check if a category is selected
  const isCategorySelected = (category) => {
    const categoryKey = category.display_key || category.value || category.display_text || category.category_name || JSON.stringify(category);
    return selectedCategories.some(selected => {
      const selectedKey = selected.display_key || selected.value || selected.display_text || selected.category_name || JSON.stringify(selected);
      return selectedKey === categoryKey;
    });
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-transparent"
      data-category-popup-backdrop="true"
      onClick={(e) => {
        // Only close if clicking EXACTLY on the backdrop, not on the popup content
        console.log('Backdrop clicked, checking if should close popup');
        console.log('Event target:', e.target);
        console.log('Current target:', e.currentTarget);
        console.log('Are they the same?', e.target === e.currentTarget);
        
        if (e.target === e.currentTarget) {
          console.log('âœ… Clicked on backdrop - closing popup');
          onClose();
        } else {
          console.log('âŒ Clicked inside popup content - NOT closing');
        }
      }}
    >
      <div 
        className="bg-transparent backdrop-blur-sm p-6 rounded-2xl shadow-2xl w-[95%] max-w-2xl mx-auto relative"
        data-category-popup-container="true"
        onClick={(e) => {
          // Prevent clicks inside the popup from bubbling up and closing it
          e.stopPropagation();
        }}
      >
        <div className="flex items-center mb-4 bg-white bg-opacity-90 p-3 rounded-t-xl">
          <div className="w-10 h-10 rounded-full bg-[#10B981] text-white flex items-center justify-center mr-3">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
          </div>
          <h3 className="font-bold text-lg text-black">{multiSelect ? "Select Multiple Categories" : "Select Category"}</h3>
          {multiSelect && <span className="ml-2 text-sm text-gray-600">(Select multiple, options stay open)</span>}
        </div>

        <div className="mb-4 bg-white bg-opacity-90 p-3 rounded-md">
          <label className="block font-bold text-gray-700 mb-2 text-lg">
            Search Categories {multiSelect && "(Options stay open for multiple selection)"}
          </label>
          
          <div className="relative">
            <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            <input
              type="text"
              className="w-full pl-10 pr-3 py-2 border border-green-400 rounded text-black font-bold text-lg"
              value={companySearchInput}
              onChange={(e) => {
                setCompanySearchInput(e.target.value);
                // Search will be triggered automatically by useEffect
              }}
              placeholder="Search by company name"
              onKeyPress={(e) => {
                if (e.key === 'Enter') {
                  handleSearch();
                }
              }}
            />
            {companySearchInput && (
              <div className="absolute inset-y-0 right-0 flex items-center pr-3">
                <button
                  className="text-gray-400 hover:text-gray-600"
                  onClick={() => setCompanySearchInput("")}
                  type="button"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            )}
          </div>
        </div>

        {/* Categories list */}
        <div 
          className="space-y-2 max-h-60 overflow-y-auto mb-4 border rounded-lg bg-white bg-opacity-90"
          data-category-list="true"
          onClick={(e) => {
            // Prevent clicks in the categories list from bubbling up
            e.stopPropagation();
          }}
        >
          {loading ? (
            <div className="p-5 flex items-center justify-center">
              <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-green-500"></div>
              <span className="ml-3 text-gray-600">Loading categories...</span>
            </div>
          ) : (
            // Show different content based on search input
            companySearchInput.trim() === "" ? (
              // No search input - show instruction message
              <div className="p-5 text-center">
                <div className="text-gray-500 text-lg mb-2">
                  <svg className="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                  Search company name to choose Company Category
                </div>
                <div className="text-sm text-gray-400">
                  Type a company name above to see available categories
                </div>
              </div>
            ) : (
              // Has search input - show results or no results message
              filteredCategories.length > 0 ? (
                filteredCategories.map((category, index) => {
                  // Handle both string and object formats
                  let labelValue, displayText;
                  
                  if (typeof category === 'string') {
                    labelValue = category;
                    displayText = category;
                  } else {
                    labelValue = category.label || category.display_text || category.category_name || '';
                    displayText = category.display_text || category.label || `${category.company_name || ''} â†’ ${category.bank_name || ''} â†’ ${category.category_name || ''}`;
                  }

                  // Check if this category is selected using our helper function
                  const isSelected = isCategorySelected(category);
                  
                  // Generate a unique key for React
                  const categoryKey = category.display_key || category.value || category.display_text || category.category_name || JSON.stringify(category);

                  console.log(`ðŸŽ¨ Rendering "${displayText}" - isSelected: ${isSelected}, key: ${categoryKey}, total selected: ${selectedCategories.length}`);

                  // MANUAL SELECTION ONLY - Users select options manually by clicking
                  const shouldShowSelected = isSelected; // Only show selected if actually selected by user
                  console.log(`ðŸ–Œï¸ Visual Debug - shouldShowSelected: ${shouldShowSelected} for "${displayText}" (manual selection only)`);
                  
                  // DIRECT STYLE TEST - Let's try a different approach
                  const itemStyles = shouldShowSelected ? {
                    backgroundColor: '#dcfce7',
                    borderColor: '#86efac',
                    borderWidth: '3px',
                    borderStyle: 'solid',
                    boxShadow: '0 0 10px rgba(134, 239, 172, 0.5)'
                  } : {
                    backgroundColor: '#ffffff',
                    borderColor: '#e5e7eb',
                    borderWidth: '1px',
                    borderStyle: 'solid',
                    boxShadow: 'none'
                  };
                  
                  console.log(`ðŸŽ¨ ITEM STYLES for "${displayText}":`, itemStyles);
                  
                  return (
                    <div
                      key={`category-${categoryKey}-${index}`}
                      className="p-3 border-b last:border-b-0 cursor-pointer text-lg text-black transition flex items-center"
                      style={itemStyles}
                      onClick={(e) => {
                        // Prevent ALL event propagation
                        e.preventDefault();
                        e.stopPropagation();
                        if (e.stopImmediatePropagation) {
                          e.stopImmediatePropagation();
                        }
                        
                        console.log('ðŸ–±ï¸ ========== CATEGORY CLICKED ==========');
                        console.log('ðŸ–±ï¸ Display Text:', displayText);
                        console.log('ðŸ–±ï¸ Current isSelected BEFORE click:', isSelected);
                        console.log('ðŸ–±ï¸ shouldShowSelected BEFORE click:', shouldShowSelected);
                        console.log('ðŸ–±ï¸ Category object:', category);
                        console.log('ðŸ–±ï¸ Current selectedCategories BEFORE:', selectedCategories);
                        console.log('ðŸ–±ï¸ selectedCategories length:', selectedCategories.length);
                        
                        handleCategoryClick(category);
                        
                        console.log('ðŸ–±ï¸ ========== CLICK COMPLETE ==========');
                      }}
                      onMouseDown={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (e.stopImmediatePropagation) {
                          e.stopImmediatePropagation();
                        }
                      }}
                      onMouseUp={(e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (e.stopImmediatePropagation) {
                          e.stopImmediatePropagation();
                        }
                      }}
                      data-category-popup-item="true"
                    >
                      {/* Profile icon with initials */}
                      <div 
                        className="w-8 h-8 rounded-full text-white flex items-center justify-center mr-3 flex-shrink-0"
                        style={{
                          backgroundColor: shouldShowSelected ? '#16a34a' : '#10B981',
                          border: shouldShowSelected ? '2px solid #059669' : 'none'
                        }}>
                        {labelValue
                          ? labelValue.split(' ')
                              .map(part => part[0] || '')
                              .slice(0, 2)
                              .join('')
                              .toUpperCase()
                          : 'CA'}
                      </div>
                      <div className="flex-1">
                        <div 
                          style={{
                            color: shouldShowSelected ? '#166534' : '#111827',
                            fontWeight: shouldShowSelected ? 'bold' : 'normal'
                          }}
                          className="font-medium text-lg">{displayText}</div>
                      </div>
                      {/* Show checkmark if selected */}
                      {shouldShowSelected && (
                        <div className="ml-2" style={{ color: '#16a34a' }}>
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" style={{ stroke: '#16a34a', strokeWidth: '3' }}>
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                      )}
                    </div>
                  );
                })
              ) : (
                // Search input provided but no results found
                <div className="p-5 text-center">
                  <div className="text-red-500 text-lg mb-2">
                    <svg className="w-12 h-12 mx-auto mb-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.47-.881-6.08-2.33"></path>
                    </svg>
                    No search company found
                  </div>
                  <div className="text-sm text-gray-500">
                    Try searching with a different company name
                  </div>
                </div>
              )
            )
          )}
        </div>

        <div className="flex justify-end gap-4 mt-4 bg-white bg-opacity-90 p-3 rounded-b-xl">
          {/* DEBUG: Show selected count */}
          <div className="px-4 py-2 bg-gray-100 rounded text-sm">
            Selected: {selectedCategories.length} categories
          </div>
          
          {multiSelect && (
            <button
              className="px-6 py-3 bg-blue-600 text-white rounded-xl shadow text-lg hover:bg-blue-700 transition"
              onClick={() => {
                console.log('=== DONE BUTTON CLICKED ===');
                console.log('selectedCategories to send:', selectedCategories);
                console.log('onAddCategory function available:', typeof onAddCategory === 'function');
                console.log('onSelect function available:', typeof onSelect === 'function');
                
                // Send all selected categories to parent when Done is clicked
                
                // Use onAddCategory callback if available (new approach)
                if (onAddCategory && typeof onAddCategory === 'function') {
                  console.log('Using onAddCategory callback to process categories');
                  onAddCategory(selectedCategories);
                } else {
                  console.log('Fallback: Using onSelect for each category');
                  // Fallback to old approach
                  selectedCategories.forEach(category => {
                    console.log('Adding category via onSelect:', category);
                    onSelect(category, false); // false indicates addition
                  });
                }
                
                console.log('=== CLOSING POPUP ===');
                // Close the popup after sending categories
                if (onSave) onSave();
                else onClose();
              }}
            >
              Done
            </button>
          )}
          <button
            className="px-6 py-3 bg-gray-400 text-white text-lg rounded-xl shadow hover:bg-gray-500 transition"
            onClick={onClose}
          >
            Cancel
          </button>
        </div>

        <button
          className="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl font-bold"
          onClick={onClose}
        >
          Ã—
        </button>
      </div>
    </div>
  );
}