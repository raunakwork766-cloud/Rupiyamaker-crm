import React, { useRef, useState, useEffect } from "react";

// --- Helper for formatting currency with commas (Indian style) ---
function formatINR(value) {
  // Ensure value is a string before attempting replace
  const stringValue = String(value);
  // Remove all commas, non-digit and non-dot characters for clean parsing
  const cleaned = stringValue.replace(/,/g, "").replace(/[^0-9.]/g, "");
  if (cleaned === "") return "";

  // Handle possible multiple dots (only keep the first for decimals)
  let [intPart, decPart] = cleaned.split(".");
  // Remove leading zeros from integer part unless it's just "0"
  if (intPart.length > 1 && intPart.startsWith("0")) intPart = intPart.replace(/^0+/, "") || "0";

  // Insert commas Indian style
  let lastThree = intPart.slice(-3);
  let otherNumbers = intPart.slice(0, -3);
  otherNumbers = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",");
  let formatted = otherNumbers ? otherNumbers + "," + lastThree : lastThree;

  // Append decimal part if it exists, limited to two digits
  if (decPart !== undefined) formatted += "." + decPart.slice(0, 2);
  return formatted;
}
// --- Modified parseINR to return integer values without decimals ---
function parseINR(formatted) {
  if (typeof formatted !== 'string') {
    formatted = String(formatted); // Ensure input is a string
  }
  // Remove all commas from the formatted string
  const withoutCommas = formatted.replace(/,/g, "");
  // Get the part before the decimal point (integer part)
  const integerPartString = withoutCommas.split(".")[0];
  // Parse as an integer. Use 10 for radix to ensure base-10 parsing.
  // If parsing results in NaN (e.g., empty string or non-numeric input), default to 0.
  return parseInt(integerPartString, 10) || 0;
}



// --- Logic and State Hook ---
function useCreateLeadLogic() {


  // Simulate backend for banks
  const [bankList, setBankList] = useState([]);
  useEffect(() => {
    setTimeout(() => {
      setBankList([
        "State Bank of India",
        "HDFC Bank",
        "ICICI Bank",
        "Axis Bank",
        "Punjab National Bank",
        "Kotak Mahindra Bank",
        "Bank of Baroda",
        "IDFC FIRST Bank",
        "IndusInd Bank",
        "Yes Bank",
        "Union Bank of India",
        "Canara Bank",
      ]);
    }, 500);
  }, []);

  // --- Customer Obligation summary from backend (simulate) ---
  const [totalBtPos, setTotalBtPos] = useState("0");
  const [totalObligation, setTotalObligation] = useState("0");
  useEffect(() => {
    setTimeout(() => {
      setTotalBtPos("");
      setTotalObligation("");
    }, 800);
  }, []);

  // Product types for obligation table
  const productTypes = [
    { value: "pl", label: "PL (Personal Loan)" },
    { value: "od", label: "OD (Overdraft)" },
    { value: "cc", label: "CC (Credit Card)" },
    { value: "bl", label: "BL (Business Loan)" },
    { value: "hl", label: "HL (Home Loan)" },
    { value: "lap", label: "LAP (Loan Against Property)" },
    { value: "al", label: "AL (Auto Loan)" },
    { value: "el", label: "EL (Education Loan)" },
    { value: "gl", label: "GL (Gold Loan)" },
    { value: "loc", label: "LOC (Loan On Credit Card)" },
    { value: "cd", label: "CD (Consumer Durable Loan)" },
    { value: "app_loan", label: "App Loan" },
    { value: "insurance", label: "Insurance" },
  ];

  // --- Action types for table ---
  const actionTypes = [
    { value: "bt", label: "BT" },
    { value: "obligate", label: "Obligate" },
    { value: "co-pay", label: "CO-Pay" },
    { value: "no-pay", label: "No-Pay" },
    { value: "closed", label: "Closed" },
  ];
  const campaignNames = [
    { value: "", label: "Select Campaign" },
    { value: "crm_data", label: "CRM Data" },
    { value: "personal_reference", label: "Personal Reference" },
    { value: "rupiya_maker", label: "Rupiya Maker" },
  ];
  const dataCodes = [
    { value: "", label: "Select Data Code" },
    { value: "mm1", label: "Money Maker 1" },
    { value: "mm2", label: "Money Maker 2" },
    { value: "mm3", label: "Money Maker 3" },
  ];
  const companyCategories = [
    { value: "", label: "Select Company Category" },
    { value: "cat_a", label: "Category A" },
    { value: "cat_b", label: "Category B" },
    { value: "cat_c", label: "Category C" },
  ];
  const companyTypes = [
    { value: "", label: "Select Type" },
    { value: "private", label: "Private" },
    { value: "public", label: "Public" },
    { value: "government", label: "Government" },
    { value: "startup", label: "Startup" },
    { value: "mnc", label: "MNC" },
  ];
  const assigneeList = [
    { value: "", label: "Select Assignee" },
    { value: "john_doe", label: "John Doe" },
    { value: "jane_smith", label: "Jane Smith" },
    { value: "robert_brown", label: "Robert Brown" },
    { value: "priya_sharma", label: "Priya Sharma" },
    { value: "amit_kumar", label: "Amit Kumar" },
  ];
  const statusOptions = [
    { value: "not_a_lead", label: "Not A Lead" },
    { 
      value: "lead", 
      label: "Lead",
      subOptions: [
        { value: "active_lead", label: "Active Lead" },
        { value: "dormant_lead", label: "Dormant Lead" },
        { value: "converted_lead", label: "Converted Lead" },
        { value: "disqualified_lead", label: "Disqualified Lead" }
      ]
    }
  ];
  const bonusDivisions = [
    { value: "3", label: "3" },
    { value: "6", label: "6" },
    { value: "12", label: "12" },
    { value: "24", label: "24" },
  ];
  const foirPercents = [
    { value: "50", label: "50%" },
    { value: "55", label: "55%" },
    { value: "60", label: "60%" },
    { value: "65", label: "65%" },
    { value: "70", label: "70%" },
  ];

  // Check Eligibility Section - Company Category Dropdown
  const checkEligibilityCompanyCategories = [
    { value: "super_cat_a", label: "Super CAT A" },
    { value: "cat_a", label: "CAT A" },
    { value: "cat_b", label: "CAT B" },
    { value: "cat_c", label: "CAT C" },
    { value: "unlisted", label: "UNLISTED or MANNUAL FILE" },
  ];

  // State
  const [currentDateTime, setCurrentDateTime] = useState(
    new Date().toISOString().replace("T", " ").slice(0, 19)
  );
  const [productType, setProductType] = useState("");
  const [mobileNumber, setMobileNumber] = useState("");
  const [showLeadForm, setShowLeadForm] = useState(false);
  const [campaignName, setCampaignName] = useState("");
  const [dataCode, setDataCode] = useState("");
  const [companyCategory, setCompanyCategory] = useState("");
  const [assignedTo, setAssignedTo] = useState([]);
  const [showAssignPopup, setShowAssignPopup] = useState(false);
  const [status, setStatus] = useState("not_a_lead");
  const [customerName, setCustomerName] = useState("");
  const [alternateNumber, setAlternateNumber] = useState("");
  const [pincode, setPincode] = useState("");
  const [city, setCity] = useState("");
  const [companyName, setCompanyName] = useState("");
  const [companyType, setCompanyType] = useState("");
  const [salary, setSalary] = useState("");
  const [partnerSalary, setPartnerSalary] = useState("");
  const [yearlyBonus, setYearlyBonus] = useState("");
  const [bonusDivision, setBonusDivision] = useState("12");
  const [loanRequired, setLoanRequired] = useState("");
  const [foirPercent, setFoirPercent] = useState("60");
  const [eligibility, setEligibility] = useState({
    totalIncome: 0,
    foirAmount: 0,
    totalObligations: 0,
    totalBtPos: 0,
    foirEligibility: 0,
    multiplierEligibility: 0,
    finalEligibility: 0,
  });

  // --- Check Eligibility Section State ---
  const [ceCompanyCategory, setCeCompanyCategory] = useState("");
  const [ceFoirPercent, setCeFoirPercent] = useState("");
  const [ceTenureMonths, setCeTenureMonths] = useState("");
  const [ceTenureYears, setCeTenureYears] = useState("");
  const [ceRoi, setCeRoi] = useState("");
  const [ceMonthlyEmiCanPay, setCeMonthlyEmiCanPay] = useState("");
  const [ceMultiplier, setCeMultiplier] = useState("");
  const [loanEligibilityStatus, setLoanEligibilityStatus] = useState("");

  // Obligations Table State
  const [obligations, setObligations] = useState([
    {
      product: "",
      bankName: "",
      tenure: "",
      roi: "",
      totalLoan: "",
      outstanding: "",
      emi: "",
      action: "",
    },
  ]);
  const [bankDropdowns, setBankDropdowns] = useState([false]);
  const [bankFilters, setBankFilters] = useState([""]);
  const [productDropdowns, setProductDropdowns] = useState([false]);

  // Company search
  const [companySearch, setCompanySearch] = useState("");
  const [companySuggestions, setCompanySuggestions] = useState([]);
  const [showCompanySuggestions, setShowCompanySuggestions] = useState(false);
  const [isCompanyLoading, setIsCompanyLoading] = useState(false);

  const leadFormRef = useRef(null);


  useEffect(() => {
    // Use parseINR directly as it now returns a number
    const s = parseINR(salary);
    const ps = parseINR(partnerSalary);
    const yb = parseINR(yearlyBonus);
    const bd = parseInt(bonusDivision) || 12;
    const monthlyBonus = yb / bd;
    const totalIncome = s + ps + monthlyBonus;
    const fp = parseInt(foirPercent) || 60;
    const foirAmount = totalIncome * (fp / 100);

    let totalObligations = 0;
    let totalBtPos = 0;
    for (const row of obligations) {
      totalObligations += parseINR(row.emi); // Use parseINR directly
      totalBtPos += parseINR(row.outstanding); // Use parseINR directly
    }

    const foirEligibility = foirAmount - totalObligations;
    const multiplierEligibility = totalIncome * 20;

    let finalEligibility = 0;
    if (totalBtPos < foirEligibility) {
      finalEligibility = Math.min(foirEligibility, multiplierEligibility);
    } else {
      finalEligibility = multiplierEligibility - totalBtPos;
    }
    finalEligibility = Math.max(finalEligibility, 0);

    setEligibility({
      totalIncome,
      foirAmount,
      totalObligations,
      totalBtPos,
      foirEligibility,
      multiplierEligibility,
      finalEligibility,
    });
    setLoanEligibilityStatus(finalEligibility > 0 ? "Eligible" : "Not Eligible");
  }, [
    salary,
    partnerSalary,
    yearlyBonus,
    bonusDivision,
    foirPercent,
    obligations,
  ]);

  // Obligations Table Handlers
  const handleObligationChange = (idx, field, value) => {
    setObligations((prev) => {
      const next = [...prev];
      next[idx] = { ...next[idx], [field]: value };
      
      // When outstanding field is updated and not empty, automatically set BTPOS (action to "bt")
      if (field === "outstanding" && value) {
        // If action is not yet set or is empty, set it to "bt" (Balance Transfer)
        if (!next[idx].action) {
          next[idx].action = "bt";
        }
      }
      
      return next;
    });
  };

  const handleAddObligation = () => {
    setObligations((prev) => [
      ...prev,
      {
        product: "",
        bankName: "",
        tenure: "",
        roi: "",
        totalLoan: "",
        outstanding: "",
        emi: "",
        action: "",
      },
    ]);
    setBankDropdowns((prev) => [...prev, false]);
    setBankFilters((prev) => [...prev, ""]);
    setProductDropdowns((prev) => [...prev, false]);
  };

  const handleDeleteObligation = (idx) => {
    setObligations((prev) => {
      const next = prev.filter((_, i) => i !== idx);
      return next.length === 0
        ? [
          {
            product: "",
            bankName: "",
            tenure: "",
            roi: "",
            totalLoan: "",
            outstanding: "",
            emi: "",
            action: "",
          },
        ]
        : next;
    });
    setBankDropdowns((prev) => prev.filter((_, i) => i !== idx));
    setBankFilters((prev) => prev.filter((_, i) => i !== idx));
    setProductDropdowns((prev) => prev.filter((_, i) => i !== idx));
  };




  // Bank filter handlers for each row
  const handleBankDropdown = (idx, isOpen) => {
    setBankDropdowns((prev) =>
      prev.map((v, i) => (i === idx ? isOpen : false))
    );
  };
  const handleBankFilterChange = (idx, value) => {
    setBankFilters((prev) =>
      prev.map((v, i) => (i === idx ? value : v))
    );
    handleObligationChange(idx, "bankName", value);
  };
  const handleBankSelect = (idx, value) => {
    handleObligationChange(idx, "bankName", value);
    setBankDropdowns((prev) => prev.map((v, i) => (i === idx ? false : v)));
    setBankFilters((prev) => prev.map((v, i) => (i === idx ? value : v)));
  };

  // Product dropdown handlers for each row
  const handleProductDropdown = (idx, isOpen) => {
    setProductDropdowns((prev) =>
      prev.map((v, i) => (i === idx ? isOpen : false))
    );
  };
  const handleProductSelect = (idx, value) => {
    handleObligationChange(idx, "product", value);
    setProductDropdowns((prev) => prev.map((v, i) => (i === idx ? false : v)));
  };

  // Company search handlers
  const fetchCompanySuggestions = async (search) => {
    setIsCompanyLoading(true);
    setCompanySuggestions([]);
    setShowCompanySuggestions(false);
    await new Promise((r) => setTimeout(r, 500));
    const demo = [
      "Tata Consultancy Services",
      "Infosys",
      "Wipro",
      "HCL Technologies",
      "Reliance Industries"
    ].filter(name => name.toLowerCase().includes(search.toLowerCase()));
    setCompanySuggestions(demo);
    setShowCompanySuggestions(demo.length > 0);
    setIsCompanyLoading(false);
  };
  const handleCompanyInputChange = (e) => {
    setCompanyName(e.target.value);
    setCompanySearch(e.target.value);
    setShowCompanySuggestions(false);
  };
  const handleCompanySearchClick = () => {
    if (companySearch.trim().length > 0) {
      fetchCompanySuggestions(companySearch.trim());
    }
  };
  const handleCompanySuggestionClick = (name) => {
    setCompanyName(name);
    setCompanySearch(name);
    setShowCompanySuggestions(false);
  };

  // --- Check Eligibility Handlers ---
  const handleCeCompanyCategoryChange = (e) => setCeCompanyCategory(e.target.value);
  const handleCeFoirPercentChange = (e) => setCeFoirPercent(e.target.value);
  const handleCeTenureMonthsChange = (e) => {
    setCeTenureMonths(e.target.value.replace(/[^0-9]/g, ""));
    setCeTenureYears(e.target.value ? (parseInt(e.target.value) / 12).toFixed(2) : "");
  };
  const handleCeTenureYearsChange = (e) => {
    setCeTenureYears(e.target.value.replace(/[^0-9.]/g, ""));
    setCeTenureMonths(e.target.value ? Math.round(parseFloat(e.target.value) * 12).toString() : "");
  };
  const handleCeRoiChange = (e) => setCeRoi(e.target.value.replace(/[^0-9.]/g, ""));
  const handleCeMonthlyEmiCanPayChange = (e) => setCeMonthlyEmiCanPay(e.target.value.replace(/[^0-9.]/g, ""));
  const handleCeMultiplierChange = (e) => {
    let value = e.target.value.replace(/[^0-9]/g, "");
    if (value === "") value = "";
    else if (parseInt(value) > 35) value = "35";
    setCeMultiplier(value);
  };

  // --- HERE: handleCheckMobile function ---
  function handleCheckMobile() {
    if (!productType) {
      alert("Please select a Product Type");
      return;
    }
    if (
      !mobileNumber ||
      mobileNumber.length !== 10 ||
      !/^\d+$/.test(mobileNumber)
    ) {
      alert("Please enter a valid 10-digit Mobile Number");
      return;
    }
    setShowLeadForm(true);
    setTimeout(() => {
      if (leadFormRef && leadFormRef.current) {
        leadFormRef.current.scrollIntoView({ behavior: "smooth" });
      }
    }, 100);
  }

  // Shortfall check
  // let shortfall = null;
  // const parsedTotalBtPos = parseINR(totalBtPos); // Use parseINR directly
  // if (parsedTotalBtPos > effectiveFinalEligibility && effectiveFinalEligibility > 0) {
  //   shortfall = parsedTotalBtPos - effectiveFinalEligibility;
  // }

  // Function to remove an assignee
  const handleRemoveAssignee = (nameToRemove) => {
    setAssignedTo((prev) => prev.filter((name) => name !== nameToRemove));
  };

  // Function to add an assignee from the popup
  const handleAddAssignee = (newAssigneeName) => {
    setAssignedTo((prevAssignedTo) => {
      if (!prevAssignedTo.includes(newAssigneeName)) {
        return [...prevAssignedTo, newAssigneeName];
      }
      return prevAssignedTo;
    });
  };

  return {
    // Basic info
    currentDateTime, productType, setProductType,
    mobileNumber, setMobileNumber, showLeadForm,
    campaignName, setCampaignName, dataCode, setDataCode,
    companyCategory, setCompanyCategory, assignedTo, setAssignedTo, handleRemoveAssignee, handleAddAssignee,
    showAssignPopup, setShowAssignPopup,
    status, setStatus, customerName, setCustomerName,
    alternateNumber, setAlternateNumber, pincode, setPincode,
    city, setCity, companyName, setCompanyName, companyType, setCompanyType,
    salary, setSalary, partnerSalary, setPartnerSalary, yearlyBonus, setYearlyBonus,
    bonusDivision, setBonusDivision, loanRequired, setLoanRequired,
    foirPercent, setFoirPercent, eligibility, leadFormRef, handleCheckMobile,
    // Obligations
    obligations, handleObligationChange, handleAddObligation, handleDeleteObligation,
    // Bank dropdown/filter
    bankList, bankDropdowns, setBankDropdowns, bankFilters, handleBankDropdown,
    handleBankFilterChange, handleBankSelect,
    // Product dropdown
    productTypes, productDropdowns, setProductDropdowns, handleProductDropdown, handleProductSelect,
    // Customer Obligation summary
    totalBtPos, totalObligation,
    // Action types
    actionTypes,
    // Company search
    companySearch, companySuggestions, showCompanySuggestions,
    handleCompanyInputChange, handleCompanySearchClick, handleCompanySuggestionClick,
    setShowCompanySuggestions, isCompanyLoading,
    campaignNames, dataCodes, companyCategories, companyTypes, assigneeList, statusOptions, bonusDivisions, foirPercents,
    // Check Eligibility Section
    ceCompanyCategory, handleCeCompanyCategoryChange,
    ceFoirPercent, handleCeFoirPercentChange,
    ceTenureMonths, handleCeTenureMonthsChange,
    ceTenureYears, handleCeTenureYearsChange,
    ceRoi, handleCeRoiChange,
    ceMonthlyEmiCanPay, handleCeMonthlyEmiCanPayChange,
    ceMultiplier, handleCeMultiplierChange,
    loanEligibilityStatus,
    checkEligibilityCompanyCategories, formatINR, parseINR
  };
}

// --- Dummy Data for Reassignment Table ---
const dummyLeads = [
  {
    id: 1,
    name: "John Doe",
    mobile: "9876543210",
    productType: "Personal Loan",
    assignedTo: "Agent 1",
    status: "Open",
  },
  {
    id: 2,
    name: "Jane Smith",
    mobile: "9123456789",
    productType: "Home Loan",
    assignedTo: "Agent 2",
    status: "Open",
  },
  {
    id: 3,
    name: "Amit Patel",
    mobile: "9001234567",
    productType: "Overdraft",
    assignedTo: "Agent 3",
    status: "Closed",
  },
];

function ReassignmentTable() {
  const [leads, setLeads] = useState(dummyLeads);
  const [editId, setEditId] = useState(null);
  const [assignedTo, setAssignedTo] = useState({});
  const agents = ["Agent 1", "Agent 2", "Agent 3", "Agent 4"];
  const handleEdit = (id, currentAssigned) => {
    setEditId(id);
    setAssignedTo((prev) => ({ ...prev, [id]: currentAssigned }));
  };
  const handleChange = (id, value) => {
    setAssignedTo((prev) => ({ ...prev, [id]: value }));
  };
  const handleSave = (id) => {
    setLeads((prev) =>
      prev.map((lead) =>
        lead.id === id ? { ...lead, assignedTo: assignedTo[id] } : lead
      )
    );
    setEditId(null);
  };

  const [inputValue, setInputValue] = useState('');
  const caretPositionRef = useRef(null);
  const handleFocus = (event) => {
    let currentValue = event.target.value;
    const suffix = ' Months';

    // If the current value ends with the suffix, remove it for editing
    if (currentValue.endsWith(suffix)) {
      setInputValue(currentValue.substring(0, currentValue.length - suffix.length));
    }
  };
  const handleBlur = (event) => {
    let currentValue = event.target.value;
    const suffix = ' Months';

    // Temporarily remove suffix if it's already there to process the pure number
    if (currentValue.endsWith(suffix)) {
      currentValue = currentValue.substring(0, currentValue.length - suffix.length);
    }

    // Remove any non-numeric characters (except for the decimal point)
    const numericValue = currentValue.replace(/[^0-9.]/g, '');

    // Convert to a number to validate
    const number = parseFloat(numericValue);

    // If input is empty or not a valid number, clear the field.
    if (numericValue.trim() === '' || isNaN(number)) {
      setInputValue(''); // Clear the input if not a valid number or empty
      return;
    }

    // Format the number (integer or two decimal places)
    const formattedNumber = Number.isInteger(number) ? number.toString() : number.toFixed(2);

    // Update the state with the formatted number and the suffix
    setInputValue(`${formattedNumber}${suffix}`);
  };


  return (
    <div className="p-6 mb-6 rounded-lg shadow-md bg-zinc-900">
      <div className="mb-6 text-lg font-semibold text-sky-400">Lead Reassignment</div>
      <div className="overflow-x-auto">
        <table className="w-full border-collapse">
          <thead>
            <tr>
              <th className="px-3 py-2 font-semibold text-gray-300 border-b border-neutral-800">Lead ID</th>
              <th className="px-3 py-2 font-semibold text-gray-300 border-b border-neutral-800">Customer Name</th>
              <th className="px-3 py-2 font-semibold text-gray-300 border-b border-neutral-800">Mobile</th>
              <th className="px-3 py-2 font-semibold text-gray-300 border-b border-neutral-800">Product Type</th>
              <th className="px-3 py-2 font-semibold text-gray-300 border-b border-neutral-800">Assigned To</th>
              <th className="px-3 py-2 font-semibold text-gray-300 border-b border-neutral-800">Status</th>
              <th className="px-3 py-2 font-semibold text-gray-300 border-b border-neutral-800">Action</th>
            </tr>
          </thead>
          <tbody>
            {leads.map((lead) => (
              <tr key={lead.id}>
                <td className="px-3 py-2">{lead.id}</td>
                <td className="px-3 py-2">{lead.name}</td>
                <td className="px-3 py-2">{lead.mobile}</td>
                <td className="px-3 py-2">{lead.productType}</td>
                <td className="px-3 py-2">
                  {editId === lead.id ? (
                    <select
                      className="w-full px-2 py-1 text-white border rounded-lg form-select border-neutral-800 bg-neutral-800"
                      value={assignedTo[lead.id] || lead.assignedTo}
                      onChange={(e) => handleChange(lead.id, e.target.value)}
                    >
                      {agents.map((agent) => (
                        <option key={agent} value={agent}>{agent}</option>
                      ))}
                    </select>
                  ) : (
                    lead.assignedTo
                  )}
                </td>
                <td className="px-3 py-2">{lead.status}</td>
                <td className="px-3 py-2">
                  {editId === lead.id ? (
                    <button
                      className="px-3 py-1 text-white rounded bg-sky-400 hover:bg-sky-500"
                      onClick={() => handleSave(lead.id)}
                    >
                      Save
                    </button>
                  ) : (
                    <button
                      className="px-3 py-1 text-white rounded bg-neutral-700 hover:bg-neutral-600"
                      onClick={() => handleEdit(lead.id, lead.assignedTo)}
                    >
                      Reassign
                    </button>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function LoanEligibilitySection({
  salary,
  partnerSalary,
  yearlyBonus,
  bonusDivision,
  obligations,
  totalBtPos,
}) {
  const [foirPercent, setFoirPercent] = useState(60);
  const [tenureMonths, setTenureMonths] = useState(60);
  const [roi, setRoi] = useState(11);
  const [multiplier, setMultiplier] = useState(20);

  // Calculation helpers
  const parseCurrency = (str) =>
    Math.round(parseFloat(String(str).replace(/[^\d.]/g, ""))) || 0;
  const formatCurrency = (amt) => {
    if (isNaN(amt) || amt === 0) return "₹0";
    amt = Math.round(amt);
    let s = amt.toString();
    let out = "";
    let i = s.length - 3;
    while (i > 0) {
      out = "," + s.slice(i, i + 2) + out;
      i -= 2;
    }
    out = s.slice(0, i + 2) + out + s.slice(-3);
    if (out.startsWith(",")) out = out.slice(1);
    return "₹" + out;
  };

  // Derived values
  const totalIncome =
    (parseFloat(salary) || 0) +
    (parseFloat(partnerSalary) || 0) +
    ((parseFloat(yearlyBonus) || 0) / (parseInt(bonusDivision) || 12));
  const totalObligation = obligations.reduce(
    (acc, row) => acc + (parseFloat(row.emi) || 0),
    0
  );
  const foirAmount = totalIncome * (parseInt(foirPercent) / 100);
  const monthlyEmiCanPay = Math.max(0, foirAmount - totalObligation);

  // FOIR-based eligibility
  const tMonths = parseInt(tenureMonths) || 0;
  const tRoi = parseFloat(roi) || 0;
  const monthlyRate = tRoi / 1200;
  let loanAmountFOIR = 0;
  if (tMonths && tRoi) {
    if (monthlyRate === 0) loanAmountFOIR = monthlyEmiCanPay * tMonths;
    else {
      const powerTerm = Math.pow(1 + monthlyRate, tMonths);
      if (powerTerm !== 1)
        loanAmountFOIR = (monthlyEmiCanPay * (powerTerm - 1)) / (monthlyRate * powerTerm);
      else loanAmountFOIR = monthlyEmiCanPay * tMonths;
    }
  }

  // Multiplier-based eligibility
  const multiplierEligibility = Math.max(0, totalIncome - totalObligation) * multiplier;

  // Final eligibility (lower of two)
  const finalEligibility =
    loanAmountFOIR > 0 && multiplierEligibility > 0
      ? Math.min(loanAmountFOIR, multiplierEligibility)
      : loanAmountFOIR > 0
        ? loanAmountFOIR
        : multiplierEligibility;

  // Shortfall check
  let shortfall = null;
  if (parseCurrency(totalBtPos) > finalEligibility && finalEligibility > 0) {
    shortfall = parseCurrency(totalBtPos) - finalEligibility;
  }

  return (
    <div>
      <h2 style={{ marginBottom: 12 }}>Loan Eligibility Calculator</h2>
      <div style={{ marginBottom: 12 }}>
        <label>
          FOIR %:{" "}
          <input
            type="number"
            min={1}
            max={100}
            value={foirPercent}
            onChange={(e) => setFoirPercent(e.target.value)}
            style={{ width: 60, marginRight: 20 }}
          />
        </label>
        <label>
          Tenure (Months):{" "}
          <input
            type="number"
            min={1}
            value={tenureMonths}
            onChange={(e) => setTenureMonths(e.target.value)}
            style={{ width: 60, marginRight: 20 }}
          />
        </label>
        <label>
          ROI (%):{" "}
          <input
            type="number"
            min={1}
            value={roi}
            step="0.01"
            onChange={(e) => setRoi(e.target.value)}
            style={{ width: 60, marginRight: 20 }}
          />
        </label>
        <label>
          Multiplier:{" "}
          <input
            type="number"
            min={1}
            max={35}
            value={multiplier}
            onChange={(e) => setMultiplier(e.target.value)}
            style={{ width: 60 }}
          />
        </label>
      </div>
      <div>
        <table style={{ width: "100%", maxWidth: 600, marginBottom: 16 }}>
          <tbody>
            <tr>
              <td>Total Income:</td>
              <td>{formatCurrency(totalIncome)}</td>
            </tr>
            <tr>
              <td>Total Obligation:</td>
              <td>{formatCurrency(totalObligation)}</td>
            </tr>
            <tr>
              <td>Monthly EMI Can Pay:</td>
              <td>{formatCurrency(monthlyEmiCanPay)}</td>
            </tr>
            <tr>
              <td>Loan Eligibility (FOIR):</td>
              <td>{formatCurrency(loanAmountFOIR)}</td>
            </tr>
            <tr>
              <td>Loan Eligibility (Multiplier):</td>
              <td>{formatCurrency(multiplierEligibility)}</td>
            </tr>
            <tr>
              <td>
                <strong>Final Loan Eligibility:</strong>
              </td>
              <td>
                <strong>{formatCurrency(finalEligibility)}</strong>
              </td>
            </tr>
            <tr>
              <td>Total BT POS:</td>
              <td>{formatCurrency(totalBtPos)}</td>
            </tr>
          </tbody>
        </table>
        {finalEligibility > 0 && shortfall ? (
          <div style={{ color: "red", fontWeight: "bold" }}>
            Balance Transfer Not Possible. Shortfall of {formatCurrency(shortfall)}.
          </div>
        ) : finalEligibility > 0 ? (
          <div style={{ color: "green", fontWeight: "bold" }}>
            Eligible for Balance Transfer.
          </div>
        ) : (
          <div style={{ color: "red", fontWeight: "bold" }}>
            Not eligible for any loan.
          </div>
        )}
      </div>
    </div>
  );
}


// --- Main Component ---
export default function CreateLead() {
  const [activeTab, setActiveTab] = useState("all");
  const [leadSection, setLeadSection] = useState("leadinfo");
  const [pincode, setPincode] = useState('');
  const [city, setCity] = useState('');
  const [state, setState] = useState(''); // Added for completeness, though your snippet only asked for city
  const [pincodeError, setPincodeError] = useState(''); // For displaying pincode validation errors
  const lastChanged = useRef(null); // Assuming this ref is used elsewhere for form tracking

  // useEffect to fetch city/state when pincode changes and is valid
  useEffect(() => {
    // Clear previous city/state when pincode is typed
    setCity('');
    setState('');
    setPincodeError(''); // Clear pincode error on change

    if (pincode.length === 6 && /^\d{6}$/.test(pincode)) {
      // Valid 6-digit pincode, now fetch data
      fetchPincodeDetails(pincode);
    } else if (pincode.length > 0 && pincode.length < 6) {
      setPincodeError("Pincode must be 6 digits.");
    } else if (pincode.length > 6) {
      setPincodeError("Pincode cannot be more than 6 digits.");
    }
    // If pincode is empty, clear error as well (handled by initial setPincodeError(''))
  }, [pincode]); // Dependency array: run this effect whenever 'pincode' state changes

  const fetchPincodeDetails = async (pin) => {
    try {
      // Replace with your actual API endpoint
      // Example for India Post API (this is often a public API or a wrapper over it)
      // A common pattern is to use the Post Office search API, which returns an array
      // You might need to adjust the URL and parsing based on the API you use.
      // Example placeholder:
      const response = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
      // For a simpler API that returns directly, like:
      // const response = await fetch(`https://api.example.com/pincode-lookup?pincode=${pin}`);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();

      // --- IMPORTANT: PARSING THE API RESPONSE ---
      // The structure of the 'data' object depends entirely on the API you use.
      // Below is a common structure for India Post like APIs,
      // where it returns an array of PostOffice objects under 'PostOffice'.
      // You'll need to adapt this based on your chosen API's response.

      if (data && data.length > 0 && data[0].Status === "Success") {
        const postOfficeDetails = data[0].PostOffice;
        if (postOfficeDetails && postOfficeDetails.length > 0) {
          // Take the first post office's details (or choose based on your logic)
          const firstPostOffice = postOfficeDetails[0];
          setCity(firstPostOffice.District); // Often District is the city name
          setState(firstPostOffice.State);
          setPincodeError(''); // Clear any previous error
        } else {
          // No post office found for this pincode
          setCity('');
          setState('');
          setPincodeError('No city found for this pincode.');
        }
      } else {
        // API returned an error or no data for the pincode
        setCity('');
        setState('');
        setPincodeError('Invalid Pincode or no data available.');
      }

    } catch (error) {
      console.error("Error fetching pincode details:", error);
      setCity('');
      setState('');
      setPincodeError('Failed to fetch pincode details. Please try again.');
    }
  };




  // --- Custom onChange handlers for money fields ---
  const handleSalaryChange = (e) => {
    const raw = e.target.value.replace(/[^0-9.]/g, "");
    setSalary(formatINR(raw));
  };
  const handlePartnerSalaryChange = (e) => {
    const raw = e.target.value.replace(/[^0-9.]/g, "");
    setPartnerSalary(formatINR(raw));
  };
  const handleYearlyBonusChange = (e) => {
    const raw = e.target.value.replace(/[^0-9.]/g, "");
    setYearlyBonus(formatINR(raw));
  };
  const handleLoanRequiredChange = (e) => {
    const raw = e.target.value.replace(/[^0-9.]/g, "");
    setLoanRequired(formatINR(raw));
  };

  // For Obligation Table fields (Total Loan, Outstanding, EMI)
  const handleObligationMoneyChange = (idx, field, value) => {
    const raw = value.replace(/[^0-9.]/g, "");
    handleObligationChange(idx, field, formatINR(raw));
  };


  const {
    currentDateTime, productType, setProductType,
    mobileNumber, setMobileNumber, showLeadForm,
    campaignName, setCampaignName, dataCode, setDataCode,
    companyCategory, setCompanyCategory, assignedTo, setAssignedTo, handleRemoveAssignee, handleAddAssignee,
    showAssignPopup, setShowAssignPopup,
    status, setStatus, customerName, setCustomerName,
    alternateNumber, setAlternateNumber, companyName, setCompanyName, companyType, setCompanyType,
    salary, setSalary, partnerSalary, setPartnerSalary, yearlyBonus, setYearlyBonus,
    bonusDivision, setBonusDivision, loanRequired, setLoanRequired,
    foirPercent, setFoirPercent, eligibility, leadFormRef, handleCheckMobile,
    obligations, handleObligationChange, handleAddObligation, handleDeleteObligation,
    bankList, bankDropdowns, setBankDropdowns, bankFilters, handleBankDropdown,
    handleBankFilterChange, handleBankSelect,
    productTypes, productDropdowns, setProductDropdowns, handleProductDropdown, handleProductSelect,
    totalBtPos, totalObligation, actionTypes,
    companySearch, companySuggestions, showCompanySuggestions,
    handleCompanyInputChange, handleCompanySearchClick, handleCompanySuggestionClick,
    setShowCompanySuggestions, isCompanyLoading,
    campaignNames, dataCodes, companyCategories, companyTypes, assigneeList, statusOptions, bonusDivisions, foirPercents,
    ceCompanyCategory, handleCeCompanyCategoryChange,
    ceFoirPercent, handleCeFoirPercentChange,
    ceTenureMonths, handleCeTenureMonthsChange,
    ceTenureYears, handleCeTenureYearsChange,
    ceRoi, handleCeRoiChange,
    ceMonthlyEmiCanPay, handleCeMonthlyEmiCanPayChange,
    ceMultiplier, handleCeMultiplierChange,
    loanEligibilityStatus,
    checkEligibilityCompanyCategories, formatINR, parseINR
  } = useCreateLeadLogic();



  return (
    <>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
      <div className="flex-1 p-6 mx-auto main-content max-w-8xl">
        {/* Tab Selector */}
        <div className="flex items-center mb-8 space-x-2">
          <button
            className={`px-6 py-2 rounded-t-md font-extrabold text-xl transition ${activeTab === "all"
              ? "bg-sky-400 text-white"
              : "bg-neutral-800 text-gray-300 hover:bg-neutral-700"
              }`}
            onClick={() => setActiveTab("all")}
          >
            All
          </button>
          <button
            className={`px-6 py-2 rounded-t-md font-extrabold text-xl transition ${activeTab === "reassignment"
              ? "bg-sky-400 text-white"
              : "bg-neutral-800 text-gray-300 hover:bg-neutral-700"
              }`}
            onClick={() => setActiveTab("reassignment")}
          >
            Reassignment
          </button>
        </div>

        {activeTab === "all" && (
          <>

            {/* Product selector */}
            <div className="p-6 mb-6 bg-white rounded-lg shadow-md card">
              <div className="mb-6 text-xl font-bold card-title text-[#03B0F5]">Select Product Type</div>
              <div className="form-section">
                <div className="form-group">
                  <div className="flex flex-wrap gap-4 form-row">
                    <div className="form-group flex-1 min-w-[220px]">
                      <label className="block mb-2 text-md  font-bold text-black form-label required-field">
                        Product Type<span className="ml-1 text-red-400">*</span>
                      </label>
                      <select
                        className="w-full px-3 py-2 text-white border rounded-lg form-select border-neutral-800 bg-neutral-800 focus:outline-none focus:border-sky-400"
                        id="productType"
                        value={productType}
                        onChange={(e) => setProductType(e.target.value)}
                      >
                        <option value="">Select Product</option>
                        <option value="pl">Personal Loan (PL)</option>
                        <option value="od">Overdraft (OD)</option>
                        <option value="hl">Home Loan</option>
                      </select>
                    </div>
                    <div className="form-group flex-1 min-w-[220px]">
                      <label className="block mb-2 text-md font-bold text-black form-label required-field">
                        Mobile Number<span className="ml-1 text-red-400">*</span>
                      </label>
                      <input
                        type="text"
                        className="w-full px-3 py-2 text-white border rounded-lg form-control border-neutral-800 bg-neutral-800 focus:outline-none focus:border-sky-400"
                        maxLength={10}
                        placeholder="Enter 10-digit Mobile Number"
                        value={mobileNumber}
                        onChange={(e) =>
                          setMobileNumber(
                            e.target.value.replace(/[^0-9]/g, "").slice(0, 10)
                          )
                        }
                      />
                    </div>
                    <div className="form-group flex-1 min-w-[150px] flex items-end mt-10">
                      <button
                        type="button"
                        className="w-full px-4 py-2 font-bold text-white rounded-lg btn btn-primary bg-sky-400 hover:bg-sky-500"
                        id="checkMobile"
                        onClick={handleCheckMobile}
                      >
                        Check &amp; Load Form
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* LEAD FORM */}
            {showLeadForm && (
              <div className="p-6 mb-6 bg-white rounded-lg shadow-md card" id="leadForm" ref={leadFormRef}>
                {/* Section Selector */}
                <div className="flex gap-4 mb-8">
                  <button
                    className={`flex-1 px-6 py-3 text-lg font-bold uppercase rounded-t-md border-b-4 transition ${leadSection === "leadinfo"
                      ? "border-sky-400 text-[#03B0F5] bg-neutral-900"
                      : "border-transparent text-[#03B0F5] bg-neutral-800 hover:text-sky-300"
                      }`}
                    onClick={() => setLeadSection("leadinfo")}
                  >
                    Lead Information
                  </button>
                  <button
                    className={`flex-1 px-6 py-3 text-lg font-bold uppercase rounded-t-md border-b-4 transition ${leadSection === "obligation"
                      ? "border-sky-400 text-sky-400 bg-neutral-900"
                      : "border-transparent text-[#03B0F5] bg-neutral-800 hover:text-sky-300"
                      }`}
                    onClick={() => setLeadSection("obligation")}
                  >
                    Obligation
                  </button>
                </div>

                {/* Lead Information Section */}
                {leadSection === "leadinfo" && (
                  <>
                    {/* Card 1: Lead Info */}
                    <div className="mb-8 bg-white rounded-xl shadow-lg p-6 border border-neutral-200 card">
                      <div className="mb-2 text-lg font-extrabold text-[#03B0F5]">Lead Information</div>
                      <div className="form-section">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 form-row">
                          {/* Column 1 */}
                          <div className="form-group">
                            <label className="block mb-2 text-md font-bold text-black form-label required-field">
                              Campaign Name<span className="ml-1 text-red-400">*</span>
                            </label>
                            <select
                              className="w-full px-3 py-2 text-white border rounded-lg form-select border-neutral-800 bg-neutral-800 focus:outline-none focus:border-sky-400"
                              value={campaignName}
                              onChange={(e) => setCampaignName(e.target.value)}
                            >
                              {campaignNames.map((opt) => (
                                <option key={opt.value} value={opt.value}>
                                  {opt.label}
                                </option>
                              ))}
                            </select>
                          </div>
                          {/* Column 2 */}
                          <div className="form-group">
                            <label className="block mb-2 text-md font-bold text-black form-label">Data Code</label>
                            <select
                              className="w-full px-3 py-2 text-white border rounded-lg form-select border-neutral-800 bg-neutral-800 focus:outline-none focus:border-sky-400"
                              value={dataCode}
                              onChange={(e) => setDataCode(e.target.value)}
                            >
                              {dataCodes.map((opt) => (
                                <option key={opt.value} value={opt.value}>
                                  {opt.label}
                                </option>
                              ))}
                            </select>
                          </div>
                          {/* Column 3 */}
                          <div className="form-group">
                            <label className="block mb-2 text-md font-bold text-black form-label required-field">
                              Company Category<span className="ml-1 text-red-400">*</span>
                            </label>
                            <select
                              className="w-full px-3 py-2 text-white border rounded-lg form-select border-neutral-800 bg-neutral-800 focus:outline-none focus:border-sky-400"
                              value={companyCategory}
                              onChange={(e) => setCompanyCategory(e.target.value)}
                            >
                              {companyCategories.map((opt) => (
                                <option key={opt.value} value={opt.value}>
                                  {opt.label}
                                </option>
                              ))}
                            </select>
                          </div>
                        </div>
                        {/* New Row for Assigned To */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 form-row mt-4">
                          {/* Column 1 - Assignee with Multi-Select */}
                          <div className="form-group">
                            <label className="block mb-2 text-md font-bold text-black form-label required-field">
                              Assigned To<span className="ml-1 text-red-400">*</span>
                            </label>
                            <div className="relative">
                              <div 
                                className="w-full px-3 py-2 text-white border rounded-lg border-neutral-800 bg-neutral-800 focus:outline-none focus:border-sky-400 min-h-[40px] flex flex-wrap gap-2 items-center cursor-pointer"
                                onClick={() => setShowAssignPopup(true)}
                              >
                                {assignedTo.length === 0 && (
                                  <span className="text-gray-400">Click to select assignees</span>
                                )}
                                
                                {assignedTo.map((assignee) => (
                                  <div 
                                    key={assignee}
                                    className="flex items-center gap-2 bg-gray-700 pl-2 pr-1 py-1 rounded-md text-sm"
                                  >
                                    {/* Profile icon with initials */}
                                    <div className="w-6 h-6 rounded-full bg-[#03B0F5] text-white flex items-center justify-center flex-shrink-0">
                                      {assignee.split(' ')
                                        .map(part => part[0])
                                        .slice(0, 2)
                                        .join('')
                                        .toUpperCase()}
                                    </div>
                                    <span>{assignee}</span>
                                    <button
                                      type="button"
                                      className="text-gray-300 hover:text-white ml-1"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleRemoveAssignee(assignee);
                                      }}
                                    >
                                      ×
                                    </button>
                                  </div>
                                ))}
                                
                                {/* Add button */}
                                {assignedTo.length > 0 && (
                                  <button
                                    type="button"
                                    className="w-6 h-6 rounded-full bg-cyan-600 hover:bg-cyan-700 text-white flex items-center justify-center"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      setShowAssignPopup(true);
                                    }}
                                  >
                                    +
                                  </button>
                                )}
                              </div>
                            </div>
                          </div>
                          
                          {/* Column 2 */}
                          <div className="form-group">
                            <label className="block mb-2 text-md font-bold text-black form-label required-field">
                              Status<span className="ml-1 text-red-400">*</span>
                            </label>
                            <select
                              className="w-full px-3 py-2 text-white border rounded-lg form-select border-neutral-800 bg-neutral-800 focus:outline-none focus:border-sky-400"
                              value={status}
                              onChange={(e) => setStatus(e.target.value)}
                            >
                              {statusOptions.map((opt) => (
                                <>
                                  <option key={opt.value} value={opt.value}>
                                    {opt.label}
                                  </option>
                                  {opt.subOptions && status === 'lead' && opt.subOptions.map((subOpt) => (
                                    <option key={subOpt.value} value={subOpt.value}>
                                      &nbsp;&nbsp;{subOpt.label}
                                    </option>
                                  ))}
                                </>
                              ))}
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Card 2: Personal */}
                    <div className="mb-8 bg-white rounded-xl shadow-lg p-6 border border-neutral-200 card">
                      <div className="mb-2 text-lg font-extrabold text-[#03B0F5]">Personal</div>
                      <div className="form-section">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 form-row">
                          {/* Column 1 */}
                          <div className="form-group">
                            <label className="block mb-2 text-md font-bold text-black form-label required-field">
                              Customer Name<span className="ml-1 text-red-400">*</span>
                            </label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg form-control border-neutral-800 text-semibold focus:outline-none focus:border-sky-400"
                              placeholder="Full Name"
                              value={customerName}
                              onChange={(e) => setCustomerName(e.target.value)}
                            />
                          </div>
                          {/* Column 2 */}
                          <div className="form-group">
                            <label className="block mb-2 text-md font-bold text-black form-label">Alternate Number</label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg form-control border-neutral-80 focus:outline-none focus:border-sky-400"
                              placeholder="Alternate Mobile Number"
                              value={alternateNumber}
                              onChange={(e) =>
                                setAlternateNumber(
                                  e.target.value.replace(/[^0-9]/g, "").slice(0, 10)
                                )
                              }
                            />
                          </div>
                          {/* Column 3 */}
                          <div className="form-group">
                            <label className="block mb-2 text-md font-bold text-black form-label required-field">
                              Pincode<span className="ml-1 text-red-400">*</span>
                            </label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg form-control border-neutral-800 focus:outline-none focus:border-sky-400"
                              id="pincode"
                              maxLength={6}
                              placeholder="6-digit Pincode"
                              value={pincode}
                              onChange={(e) => {
                                const inputVal = e.target.value;
                                if (/^\d*$/.test(inputVal)) {
                                  setPincode(inputVal);
                                }
                              }}
                            />
                            {pincodeError && <p style={{ color: 'red', fontSize: '0.8em' }} className="text-red-600 text-sm mt-1">{pincodeError}</p>}
                          </div>


                          {/* Column 1 */}
                          <div className="form-group">
                            <label className="block mb-2 text-md font-bold text-black form-label required-field">
                              City<span className="ml-1 text-red-400">*</span>
                            </label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg form-control border-neutral-800 focus:outline-none"
                              id="city"
                              placeholder="City"
                              value={city}
                              onChange={e => {
                                lastChanged.current = "city";
                                setCity(e.target.value);
                              }}
                              readOnly
                            />
                          </div>
                          {/* State input can go here if you decide to add it */}

                          {/* <div className="form-group">
          <label className="block mb-2 text-md font-bold text-black form-label required-field">
            State<span className="ml-1 text-red-400">*</span>
          </label>
          <input
            type="text"
            className="w-full px-3 py-2 text-black border rounded-lg form-control border-neutral-800 focus:outline-none"
            id="state"
            placeholder="State"
            value={state}
            readOnly
          />
        </div> */}
                          {/* Column 2 */}
                          <div className="form-group relative">
                            <label className="block mb-2 text-md font-bold text-black form-label required-field">
                              Company Name<span className="ml-1 text-red-400">*</span>
                            </label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg form-control border-neutral-800 focus:outline-none focus:border-sky-400"
                              placeholder="Company Name"
                              value={companyName}
                              onChange={handleCompanyInputChange}
                              autoComplete="off"
                              onFocus={() => setShowCompanySuggestions(companySuggestions.length > 0)}
                              onBlur={() => setTimeout(() => setShowCompanySuggestions(false), 100)}
                            />
                            {showCompanySuggestions && (
                              <div className="absolute z-10 w-full mt-1 border rounded shadow-lg bg-neutral-900 border-neutral-700">
                                {companySuggestions.map((name) => (
                                  <div
                                    key={name}
                                    className="px-3 py-2 text-gray-300 cursor-pointer hover:bg-sky-400/10"
                                    onMouseDown={() => handleCompanySuggestionClick(name)}
                                  >
                                    {name}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                          {/* Column 3 */}
                          <div className="form-group">
                            <label className="block mb-2 text-md font-bold text-black form-label required-field">
                              Company Type<span className="ml-1 text-red-400">*</span>
                            </label>
                            <select
                              className="w-full px-3 py-2 text-black border rounded-lg form-select border-neutral-800 focus:outline-none focus:border-sky-400"
                              value={companyType}
                              onChange={(e) => setCompanyType(e.target.value)}
                            >
                              {companyTypes.map((opt) => (
                                <option key={opt.value} value={opt.value}>
                                  {opt.label}
                                </option>
                              ))}
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>


                  </>
                )}

                {/* OBLIGATION SECTION */}
                {leadSection === "obligation" && (
                  <div className="mb-8 form-section">
                    {/* Customer Details Section */}
                    <div className="mb-6">
                      <div className="mb-2 text-2xl font-bold text-sky-400">Customer Details</div>
                      <div className="p-4 mb-4 border rounded-lg bg-grey/50 border-neutral-700">
                        {/* Row 1: Salary, Partner's Salary, Bonus */}
                        <div className="flex flex-wrap items-end gap-4 mb-6">
                          {/* Salary */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Salary</label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={salary}
                              onChange={handleSalaryChange}
                              placeholder="In Rupees"
                              inputMode="numeric"
                            />
                          </div>
                          {/* Partner's Salary */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Partner's Salary</label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={partnerSalary}
                              onChange={handlePartnerSalaryChange}
                              placeholder="In Rupees"
                              inputMode="numeric"
                            />
                          </div>
                          {/* Bonus with Divide By options that appear below without shifting */}
                          <div className="form-group flex-1 min-w-[140px] relative" style={{ zIndex: 40 }}>
                            <label htmlFor="yearlyBonus" className="block mb-2 text-lg font-bold text-black">Bonus</label>
                            <div className="relative">
                              <input
                                type="text"
                                id="yearlyBonus"
                                className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                                value={yearlyBonus}
                                onChange={handleYearlyBonusChange}
                                placeholder="In Rupees"
                                inputMode="numeric"
                              />
                              {yearlyBonus && parseINR(yearlyBonus) > 0 && (
                                <div className="absolute top-full left-0 mt-1 z-50 w-[250px] bg-white border border-neutral-200 rounded-lg shadow-md p-2">
                                  <div className="flex flex-wrap items-center gap-2">
                                    <label className="text-xs font-bold text-black whitespace-nowrap">Divide By:</label>
                                    <div className="flex flex-wrap gap-1 items-center">
                                      {bonusDivisions.map((opt) => (
                                        <button
                                          key={opt.value}
                                          type="button"
                                          className={`px-2 py-1 rounded-md text-xs font-semibold transition ${bonusDivision === opt.value ? 'bg-sky-600 text-white' : 'bg-neutral-700 text-gray-300 hover:bg-neutral-600'}`}
                                          onClick={() => setBonusDivision(opt.value)}
                                        >
                                          {opt.label}
                                        </button>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                        
                        {/* Row 2: Loan Amount Required, Company Name */}
                        <div className="flex flex-wrap items-end gap-4 mb-4">
                          {/* Loan Amount Required */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Loan Amount Required</label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={loanRequired}
                              onChange={(e) => setLoanRequired(e.target.value)}
                              placeholder="In Rupees"
                              inputMode="numeric"
                            />
                          </div>
                          
                          {/* Company Name with search */}
                          <div className="form-group flex-1 min-w-[250px] relative">
                            <label className="block mb-2 text-lg font-bold text-black">Company Name</label>
                            <div className="relative flex items-center">
                              <input
                                type="text"
                                className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                                value={companyName}
                                onChange={handleCompanyInputChange}
                                placeholder="Company Name"
                                autoComplete="off"
                                onFocus={() => setShowCompanySuggestions(false)}
                              />
                              <button
                                type="button"
                                className="flex items-center px-3 py-2 ml-2 font-bold text-white rounded bg-sky-400 hover:bg-sky-500"
                                onClick={handleCompanySearchClick}
                                disabled={isCompanyLoading}
                                tabIndex={-1}
                              >
                                {isCompanyLoading ? (
                                  <i className="fas fa-spinner fa-spin"></i>
                                ) : (
                                  <i className="fas fa-search"></i>
                                )}
                              </button>
                            </div>
                            {showCompanySuggestions && (
                              <div className="absolute z-10 w-full mt-1 border rounded shadow-lg bg-neutral-900 border-neutral-700">
                                {companySuggestions.map((name) => (
                                  <div
                                    key={name}
                                    className="px-3 py-2 text-gray-300 cursor-pointer hover:bg-sky-400/10"
                                    onMouseDown={() => handleCompanySuggestionClick(name)}
                                  >
                                    {name}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Row 3: Company Type, Company Category */}
                        <div className="flex flex-wrap items-end gap-4">
                          {/* Company Type */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Company Type</label>
                            <select
                              className="w-full px-3 py-2 text-black border rounded-lg form-select border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={companyType}
                              onChange={(e) => setCompanyType(e.target.value)}
                            >
                              <option value="" disabled>Select Company Type</option>
                              {companyTypes.map((opt) => (
                                <option key={opt.value} value={opt.value}>
                                  {opt.label}
                                </option>
                              ))}
                            </select>
                          </div>
                          
                          {/* Company Category */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Company Category</label>
                            <select
                              className="w-full px-3 py-2 text-black border rounded-lg form-select border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={companyCategory}
                              onChange={(e) => setCompanyCategory(e.target.value)}
                            >
                              <option value="" disabled>Select Company Category</option>
                              {companyCategories.map((opt) => (
                                <option key={opt.value} value={opt.value}>
                                  {opt.label}
                                </option>
                              ))}
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>

                  </>
                )}

                {/* OBLIGATION SECTION */}
                {leadSection === "obligation" && (
                  <div className="mb-8 form-section">
                    {/* Customer Details Section */}
                    <div className="mb-6">
                      <div className="mb-2 text-2xl font-bold text-sky-400">Customer Details</div>
                      <div className="p-4 mb-4 border rounded-lg bg-grey/50 border-neutral-700">
                        {/* Row 1: Salary, Partner's Salary, Bonus */}
                        <div className="flex flex-wrap items-end gap-4 mb-6">
                          {/* Salary */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Salary</label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={salary}
                              onChange={handleSalaryChange}
                              placeholder="In Rupees"
                              inputMode="numeric"
                            />
                          </div>
                          {/* Partner's Salary */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Partner's Salary</label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={partnerSalary}
                              onChange={handlePartnerSalaryChange}
                              placeholder="In Rupees"
                              inputMode="numeric"
                            />
                          </div>
                          {/* Bonus with Divide By options that appear below without shifting */}
                          <div className="form-group flex-1 min-w-[140px] relative" style={{ zIndex: 40 }}>
                            <label htmlFor="yearlyBonus" className="block mb-2 text-lg font-bold text-black">Bonus</label>
                            <div className="relative">
                              <input
                                type="text"
                                id="yearlyBonus"
                                className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                                value={yearlyBonus}
                                onChange={handleYearlyBonusChange}
                                placeholder="In Rupees"
                                inputMode="numeric"
                              />
                              {yearlyBonus && parseINR(yearlyBonus) > 0 && (
                                <div className="absolute top-full left-0 mt-1 z-50 w-[250px] bg-white border border-neutral-200 rounded-lg shadow-md p-2">
                                  <div className="flex flex-wrap items-center gap-2">
                                    <label className="text-xs font-bold text-black whitespace-nowrap">Divide By:</label>
                                    <div className="flex flex-wrap gap-1 items-center">
                                      {bonusDivisions.map((opt) => (
                                        <button
                                          key={opt.value}
                                          type="button"
                                          className={`px-2 py-1 rounded-md text-xs font-semibold transition ${bonusDivision === opt.value ? 'bg-sky-600 text-white' : 'bg-neutral-700 text-gray-300 hover:bg-neutral-600'}`}
                                          onClick={() => setBonusDivision(opt.value)}
                                        >
                                          {opt.label}
                                        </button>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                        
                        {/* Row 2: Loan Amount Required, Company Name */}
                        <div className="flex flex-wrap items-end gap-4 mb-4">
                          {/* Loan Amount Required */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Loan Amount Required</label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={loanRequired}
                              onChange={(e) => setLoanRequired(e.target.value)}
                              placeholder="In Rupees"
                              inputMode="numeric"
                            />
                          </div>
                          
                          {/* Company Name with search */}
                          <div className="form-group flex-1 min-w-[250px] relative">
                            <label className="block mb-2 text-lg font-bold text-black">Company Name</label>
                            <div className="relative flex items-center">
                              <input
                                type="text"
                                className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                                value={companyName}
                                onChange={handleCompanyInputChange}
                                placeholder="Company Name"
                                autoComplete="off"
                                onFocus={() => setShowCompanySuggestions(false)}
                              />
                              <button
                                type="button"
                                className="flex items-center px-3 py-2 ml-2 font-bold text-white rounded bg-sky-400 hover:bg-sky-500"
                                onClick={handleCompanySearchClick}
                                disabled={isCompanyLoading}
                                tabIndex={-1}
                              >
                                {isCompanyLoading ? (
                                  <i className="fas fa-spinner fa-spin"></i>
                                ) : (
                                  <i className="fas fa-search"></i>
                                )}
                              </button>
                            </div>
                            {showCompanySuggestions && (
                              <div className="absolute z-10 w-full mt-1 border rounded shadow-lg bg-neutral-900 border-neutral-700">
                                {companySuggestions.map((name) => (
                                  <div
                                    key={name}
                                    className="px-3 py-2 text-gray-300 cursor-pointer hover:bg-sky-400/10"
                                    onMouseDown={() => handleCompanySuggestionClick(name)}
                                  >
                                    {name}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Row 3: Company Type, Company Category */}
                        <div className="flex flex-wrap items-end gap-4">
                          {/* Company Type */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Company Type</label>
                            <select
                              className="w-full px-3 py-2 text-black border rounded-lg form-select border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={companyType}
                              onChange={(e) => setCompanyType(e.target.value)}
                            >
                              <option value="" disabled>Select Company Type</option>
                              {companyTypes.map((opt) => (
                                <option key={opt.value} value={opt.value}>
                                  {opt.label}
                                </option>
                              ))}
                            </select>
                          </div>
                          
                          {/* Company Category */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Company Category</label>
                            <select
                              className="w-full px-3 py-2 text-black border rounded-lg form-select border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={companyCategory}
                              onChange={(e) => setCompanyCategory(e.target.value)}
                            >
                              <option value="" disabled>Select Company Category</option>
                              {companyCategories.map((opt) => (
                                <option key={opt.value} value={opt.value}>
                                  {opt.label}
                                </option>
                              ))}
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>


                  </>
                )}

                {/* OBLIGATION SECTION */}
                {leadSection === "obligation" && (
                  <div className="mb-8 form-section">
                    {/* Customer Details Section */}
                    <div className="mb-6">
                      <div className="mb-2 text-2xl font-bold text-sky-400">Customer Details</div>
                      <div className="p-4 mb-4 border rounded-lg bg-grey/50 border-neutral-700">
                        {/* Row 1: Salary, Partner's Salary, Bonus */}
                                               <div className="flex flex-wrap items-end gap-4 mb-6">
                          {/* Salary */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Salary</label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={salary}
                              onChange={handleSalaryChange}
                              placeholder="In Rupees"
                              inputMode="numeric"
                            />
                          </div>
                          {/* Partner's Salary */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Partner's Salary</label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={partnerSalary}
                              onChange={handlePartnerSalaryChange}
                              placeholder="In Rupees"
                              inputMode="numeric"
                            />
                          </div>
                          {/* Bonus with Divide By options that appear below without shifting */}
                          <div className="form-group flex-1 min-w-[140px] relative" style={{ zIndex: 40 }}>
                            <label htmlFor="yearlyBonus" className="block mb-2 text-lg font-bold text-black">Bonus</label>
                            <div className="relative">
                              <input
                                type="text"
                                id="yearlyBonus"
                                className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                                value={yearlyBonus}
                                onChange={handleYearlyBonusChange}
                                placeholder="In Rupees"
                                inputMode="numeric"
                              />
                              {yearlyBonus && parseINR(yearlyBonus) > 0 && (
                                <div className="absolute top-full left-0 mt-1 z-50 w-[250px] bg-white border border-neutral-200 rounded-lg shadow-md p-2">
                                  <div className="flex flex-wrap items-center gap-2">
                                    <label className="text-xs font-bold text-black whitespace-nowrap">Divide By:</label>
                                    <div className="flex flex-wrap gap-1 items-center">
                                      {bonusDivisions.map((opt) => (
                                        <button
                                          key={opt.value}
                                          type="button"
                                          className={`px-2 py-1 rounded-md text-xs font-semibold transition ${bonusDivision === opt.value ? 'bg-sky-600 text-white' : 'bg-neutral-700 text-gray-300 hover:bg-neutral-600'}`}
                                          onClick={() => setBonusDivision(opt.value)}
                                        >
                                          {opt.label}
                                        </button>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                        
                        {/* Row 2: Loan Amount Required, Company Name */}
                        <div className="flex flex-wrap items-end gap-4 mb-4">
                          {/* Loan Amount Required */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Loan Amount Required</label>
                            <input
                              type="text"
                              className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={loanRequired}
                              onChange={(e) => setLoanRequired(e.target.value)}
                              placeholder="In Rupees"
                              inputMode="numeric"
                            />
                          </div>
                          
                          {/* Company Name with search */}
                          <div className="form-group flex-1 min-w-[250px] relative">
                            <label className="block mb-2 text-lg font-bold text-black">Company Name</label>
                            <div className="relative flex items-center">
                              <input
                                type="text"
                                className="w-full px-3 py-2 text-black border rounded-lg border-neutral-700 focus:outline-none focus:border-sky-400"
                                value={companyName}
                                onChange={handleCompanyInputChange}
                                placeholder="Company Name"
                                autoComplete="off"
                                onFocus={() => setShowCompanySuggestions(false)}
                              />
                              <button
                                type="button"
                                className="flex items-center px-3 py-2 ml-2 font-bold text-white rounded bg-sky-400 hover:bg-sky-500"
                                onClick={handleCompanySearchClick}
                                disabled={isCompanyLoading}
                                tabIndex={-1}
                              >
                                {isCompanyLoading ? (
                                  <i className="fas fa-spinner fa-spin"></i>
                                ) : (
                                  <i className="fas fa-search"></i>
                                )}
                              </button>
                            </div>
                            {showCompanySuggestions && (
                              <div className="absolute z-10 w-full mt-1 border rounded shadow-lg bg-neutral-900 border-neutral-700">
                                {companySuggestions.map((name) => (
                                  <div
                                    key={name}
                                    className="px-3 py-2 text-gray-300 cursor-pointer hover:bg-sky-400/10"
                                    onMouseDown={() => handleCompanySuggestionClick(name)}
                                  >
                                    {name}
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Row 3: Company Type, Company Category */}
                        <div className="flex flex-wrap items-end gap-4">
                          {/* Company Type */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Company Type</label>
                            <select
                              className="w-full px-3 py-2 text-black border rounded-lg form-select border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={companyType}
                              onChange={(e) => setCompanyType(e.target.value)}
                            >
                              <option value="" disabled>Select Company Type</option>
                              {companyTypes.map((opt) => (
                                <option key={opt.value} value={opt.value}>
                                  {opt.label}
                                </option>
                              ))}
                            </select>
                          </div>
                          
                          {/* Company Category */}
                          <div className="form-group flex-1 min-w-[140px]">
                            <label className="block mb-2 text-lg font-bold text-black">Company Category</label>
                            <select
                              className="w-full px-3 py-2 text-black border rounded-lg form-select border-neutral-700 focus:outline-none focus:border-sky-400"
                              value={companyCategory}
                              onChange={(e) => setCompanyCategory(e.target.value)}
                            >
                              <option value="" disabled>Select Company Category</option>
                              {companyCategories.map((opt) => (
                                <option key={opt.value} value={opt.value}>
                                  {opt.label}
                                </option>
                              ))}
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>
                    {/* Customer Obligation Section - with glass effect */}
                    <div className="mb-4">
                      <div className="mb-2 text-2xl font-bold text-[#03B0F5]">Customer Obligation</div>
                      <div className="flex flex-wrap items-center gap-4 p-4 mb-2 glass-effect">
                        <div className="form-group flex-1 min-w-[220px]">
                          <label className="block mb-1 text-lg font-bold text-black">Total BT POS</label>
                          <input
                            type="text"
                            className="w-full px-3 py-2 font-bold text-[#000] bg-gray-200 border rounded-lg form-control border-neutral-800"
                            value={totalBtPos}
                            readOnly
                          />
                        </div>
                        <div className="form-group flex-1 min-w-[220px]">
                          <label className="block mb-1 text-lg font-bold text-black">Total Obligation</label>
                          <input
                            type="text"
                            className="w-full px-3 py-2 font-bold text-[#000] bg-gray-200 border rounded-lg form-control border-neutral-800"
                            value={totalObligation}
                            readOnly
                          />
                        </div>
                      </div>
                    </div>
                    {/* Product selection dropdowns above obligation table (one for each row) */}
                    <div className="mb-2 overflow-x-auto table-container">
                      <table id="obligationTable" className="w-full border-collapse">
                        <thead>
                          <tr>
                            <th className="px-3 py-2 text-lg font-bold text-black border-b border-neutral-800">#</th>
                            <th className="px-3 py-2 text-xl text-black border-b font-bol border-neutral-800">Product</th>
                            <th className="px-3 py-2 text-xl text-black border-b font-bol border-neutral-800 whitespace-nowrap">Bank Name</th>
                            <th className="px-3 py-2 text-xl text-black border-b font-bol border-neutral-800">Tenure</th>
                            <th className="px-3 py-2 text-xl text-black border-b font-bol border-neutral-800">ROI%</th>
                            <th className="px-3 py-2 text-xl text-black border-b font-bol border-neutral-800 whitespace-nowrap">Total Loan</th>
                            <th className="px-3 py-2 text-xl text-black border-b font-bol border-neutral-800">Outstanding</th>
                            <th className="px-3 py-2 text-xl text-black border-b font-bol border-neutral-800">EMI</th>
                            <th className="px-3 py-2 text-xl text-black border-b font-bol border-neutral-800">Action</th>
                            <th className="px-3 py-2 text-xl text-black border-b font-bol border-neutral-800"></th>
                          </tr>
                        </thead>
                        <tbody>
                          {obligations.map((row, idx) => (
                            <tr key={idx}>
                              <td className="px-3 py-2 text-black">{idx + 1}</td>

                              {/* Product Select Menu */}
                              <td className="px-1 py-2">
                                <select
                                  className="w-full px-2 py-1 text-black bg-white border rounded-lg border-neutral-800 focus:outline-none focus:ring-2 focus:ring-sky-400 hover:bg-sky-50 transition"
                                  value={row.product}
                                  onChange={e => handleObligationChange(idx, "product", e.target.value)}
                                >
                                  <option value="" disabled>Select Product</option>
                                  {productTypes.map(opt => (
                                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                                  ))}
                                </select>
                              </td>

                              {/* Bank Name Select Menu */}
                              <td className="px-3 py-2">
                                <select
                                  className="w-full px-2 py-1 text-black bg-white border rounded-lg border-neutral-800 focus:outline-none focus:ring-2 focus:ring-sky-400 hover:bg-sky-50 transition"
                                  value={row.bankName}
                                  onChange={e => handleObligationChange(idx, "bankName", e.target.value)}
                                >
                                  <option value="" disabled>Select Bank</option>
                                  {bankList.map(bank => (
                                    <option key={bank} value={bank}>{bank}</option>
                                  ))}
                                </select>
                              </td>

                              {/* Tenure */}
                              <td className="px-3 py-2">
                                <input
                                  type="number"
                                  className="w-full px-2 py-1 text-black bg-white border rounded-lg border-neutral-800 placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-sky-400 hover:bg-sky-50 transition"
                                  placeholder="Months"
                                  value={row.tenure}
                                  onChange={e =>
                                    handleObligationChange(idx, "tenure", e.target.value.replace(/[^0-9]/g, ""))
                                  }
                                />
                              </td>

                              {/* ROI */}
                              <td className="px-3 py-2">
                                <input
                                  type="number"
                                  className="w-full px-2 py-1 text-black bg-white border rounded-lg border-neutral-800 placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-sky-400 hover:bg-sky-50 transition"
                                  placeholder="%"
                                  step="0.01"
                                  value={row.roi}
                                  onChange={e =>
                                    handleObligationChange(idx, "roi", e.target.value.replace(/[^0-9.]/g, ""))
                                  }
                                />
                              </td>

                              {/* Total Loan */}
                              <td className="px-3 py-2">
                                <input
                                  type="number"
                                  className="w-full px-2 py-1 text-black bg-white border rounded-lg border-neutral-800 placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-sky-400 hover:bg-sky-50 transition"
                                  placeholder="Loan"
                                  value={row.totalLoan}
                                  onChange={e =>
                                    handleObligationChange(idx, "totalLoan", e.target.value.replace(/[^0-9.]/g, ""))
                                  }
                                />
                              </td>

                              {/* Outstanding */}
                              <td className="px-3 py-2">
                                <input
                                  type="text"
                                  className="w-full px-2 py-1 text-black bg-white border rounded-lg border-neutral-800 placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-sky-400 hover:bg-sky-50 transition"
                                  placeholder="Outstanding"
                                  value={row.outstanding}
                                  onChange={e =>
                                    handleObligationChange(idx, "outstanding", e.target.value.replace(/[^0-9.]/g, ""))
                                  }
                                  inputMode="numeric"
                                  pattern="[0-9]*"
                                />
                              </td>

                              {/* EMI */}
                              <td className="px-3 py-2">
                                <input
                                  type="number"
                                  className="w-full px-2 py-1 text-black bg-white border rounded-lg border-neutral-800 placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-sky-400 hover:bg-sky-50 transition"
                                  placeholder="EMI"
                                  value={row.emi}
                                  onChange={e =>
                                    handleObligationChange(idx, "emi", e.target.value.replace(/[^0-9.]/g, ""))
                                  }
                                />
                              </td>

                              {/* Action */}
                              <td className="px-3 py-2">
                                <select
                                  className="w-full px-2 py-1 text-black bg-white border rounded-lg border-neutral-800 focus:outline-none focus:ring-2 focus:ring-sky-400 hover:bg-sky-50 transition"
                                  value={row.action}
                                  onChange={e => handleObligationChange(idx, "action", e.target.value)}
                                >
                                  <option value="" disabled>Select</option>
                                  {actionTypes.map(opt =>
                                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                                  )}
                                </select>
                              </td>

                              {/* Delete */}
                              <td className="px-3 py-2">
                                <i
                                  className="mr-2 cursor-pointer fas fa-trash table-action text-sky-400 hover:text-yellow-400"
                                  onClick={() => handleDeleteObligation(idx)}
                                ></i>
                              </td>
                            </tr>
                          ))}
                        </tbody>

                      </table>
                    </div>
                    <div className="flex justify-center mt-4">
                      <button
                        className="px-5 py-2 font-bold transition border-2 rounded-lg text-sky-400 border-sky-400 hover:bg-sky-400/20"
                        id="addObligationRow"
                        onClick={handleAddObligation}
                        type="button"
                      >
                        <i className="mr-2 fas fa-plus"></i> Add Another Obligation
                      </button>
                    </div>

                    {/* --- CHECK ELIGIBILITY SECTION --- */}
                    <div className="p-4 mt-6 mb-4 border rounded-lg border-sky-400 bg-sky-50/50">
                      <div className="mb-3 text-2xl font-bold text-sky-500">Check Eligibility</div>
                      {/* First Row */}
                      <div className="flex flex-wrap gap-4 mb-4">
                        {/* Total Income */}
                        <div className="form-group flex-1 min-w-[180px]">
                          <label className="block mb-1 text-base font-bold text-black">Total Income</label>
                          <input
                            type="text"
                            className="w-full px-2 py-1 font-bold text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={eligibility.totalIncome}
                            readOnly
                          />
                        </div>
                        {/* Company Category Dropdown */}
                        <div className="form-group flex-1 min-w-[200px]">
                          <label className="block mb-1 text-base font-bold text-black">
                            Company Category
                          </label>
                          <select
                            className="w-full px-2 py-1 text-black bg-gray-100 border rounded-lg form-select border-neutral-300"
                            value={ceCompanyCategory}
                            onChange={handleCeCompanyCategoryChange}
                          >
                            <option value="">Select Category</option>
                            {checkEligibilityCompanyCategories.map((opt) => (
                              <option key={opt.value} value={opt.value}>{opt.label}</option>
                            ))}
                          </select>
                        </div>
                        {/* FOIR % */}
                        <div className="form-group flex-1 min-w-[120px]">
                          <label className="block mb-1 text-base font-bold text-black">FOIR %</label>
                          <input
                            type="number"
                            className="w-full px-2 py-1 text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={ceFoirPercent}
                            onChange={handleCeFoirPercentChange}
                            min={0}
                            max={100}
                          />
                        </div>
                        {/* FOIR Amount */}
                        <div className="form-group flex-1 min-w-[160px]">
                          <label className="block mb-1 text-base font-bold text-black">FOIR Amount</label>
                          <input
                            type="text"
                            className="w-full px-2 py-1 font-bold text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={eligibility.foirAmount}
                            readOnly
                          />
                        </div>
                        {/* Total Obligation */}
                        <div className="form-group flex-1 min-w-[160px]">
                          <label className="block mb-1 text-base font-bold text-black">Total Obligation</label>
                          <input
                            type="text"
                            className="w-full px-2 py-1 font-bold text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={eligibility.totalObligations}
                            readOnly
                          />
                        </div>
                      </div>
                      {/* Second Row */}
                      <div className="flex flex-wrap gap-4 mb-4">
                        {/* Monthly EMI Can Pay */}
                        <div className="form-group flex-1 min-w-[180px]">
                          <label className="block mb-1 text-base font-bold text-black">Monthly EMI Can Pay</label>
                          <input
                            type="number"
                            className="w-full px-2 py-1 text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={ceMonthlyEmiCanPay}
                            onChange={handleCeMonthlyEmiCanPayChange}
                          />
                        </div>
                        {/* Tenure (Months) */}
                        <div className="form-group flex-1 min-w-[180px]">
                          <label className="block mb-1 text-base font-bold text-black">TENURE (Months)</label>
                          <input
                            type="number"
                            className="w-full px-2 py-1 text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={ceTenureMonths}
                            onChange={handleCeTenureMonthsChange}
                          />
                        </div>
                        {/* Tenure (Years) */}
                        <div className="form-group flex-1 min-w-[180px]">
                          <label className="block mb-1 text-base font-bold text-black">TENURE (Years)</label>
                          <input
                            type="number"
                            step="0.01"
                            className="w-full px-2 py-1 text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={ceTenureYears}
                            onChange={handleCeTenureYearsChange}
                          />
                        </div>
                        {/* ROI */}
                        <div className="form-group flex-1 min-w-[140px]">
                          <label className="block mb-1 text-base font-bold text-black">ROI</label>
                          <input
                            type="number"
                            className="w-full px-2 py-1 text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={ceRoi}
                            onChange={handleCeRoiChange}
                          />
                        </div>
                      </div>
                      {/* Third Row */}
                      <div className="flex flex-wrap items-end gap-4 mb-2">
                        {/* TOTAL BT POS */}
                        <div className="form-group flex-1 min-w-[180px]">
                          <label className="block mb-1 text-base font-bold text-black">TOTAL BT POS</label>
                          <input
                            type="text"
                            className="w-full px-2 py-1 font-bold text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={eligibility.totalBtPos}
                            readOnly
                          />
                        </div>
                        {/* Loan Eligibility as per Hour */}
                        <div className="form-group flex-1 min-w-[220px]">
                          <label className="block mb-1 text-base font-bold text-black">Loan Eligibility as per Foir</label>
                          <input
                            type="text"
                            className="w-full px-2 py-1 font-bold text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={eligibility.finalEligibility}
                            readOnly
                          />
                          <span className={`block mt-1 text-xs font-semibold ${loanEligibilityStatus === "Eligible" ? "text-green-600" : "text-red-600"}`}>
                            {loanEligibilityStatus === "Eligible" ? "You are eligible for this loan" : "You are NOT eligible for this loan"}
                          </span>
                        </div>
                        {/* Loan Eligibility as per Multiplier */}
                        <div className="form-group flex-1 min-w-[220px]">
                          <label className="block mb-1 text-base font-bold text-black">Loan Eligibility as per Multiplier</label>
                          <input
                            type="text"
                            className="w-full px-2 py-1 font-bold text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                            value={eligibility.multiplierEligibility}
                            readOnly
                          />
                          <div className="flex items-center gap-2 mt-1">
                            <span className="block text-xs font-semibold text-black">Multiplier</span>
                            <input
                              type="number"
                              className="w-20 px-2 py-1 text-black bg-gray-100 border rounded-lg form-control border-neutral-300"
                              max={35}
                              min={1}
                              value={ceMultiplier}
                              onChange={handleCeMultiplierChange}
                              placeholder="Max 35"
                            />
                          </div>
                        </div>
                      </div>
                    </div>


                  </div>


                )}

                <div className="flex justify-end gap-4 mt-8 form-actions">
                  <button type="button" className="px-5 py-2 font-semibold text-white rounded-lg btn btn-secondary bg-neutral-800 hover:bg-neutral-700">
                    Cancel
                  </button>
                  <button type="button" className="px-5 py-2 font-bold text-white rounded-lg btn btn-primary bg-sky-400 hover:bg-sky-500">
                    Create Lead
                  </button>
                </div>
              </div>
            )}
          </>
        )}
        
        {activeTab === "reassignment" && <ReassignmentTable />}
      </div>

      {/* AssignPopup component */}
      {showAssignPopup && (
        <AssignPopup
          onClose={() => setShowAssignPopup(false)}
          onSelect={(user) => {
            handleAddAssignee(user);
            setShowAssignPopup(false);
          }}
        />
      )}
    </>
  );
}

// AssignPopup component
function AssignPopup({ onClose, onSelect }) {
  const [assigneeName, setAssigneeName] = useState("");

  // Using the same assignee list from the parent component
  const dummyAssignees = [
    "TL",
    "Manager",
    "Employee",
    "Vishal Singh",
    "Muhammad Soyeb",
    "Sohail Khan",
    "John Doe",
    "Jane Smith",
    "Robert Brown",
    "Priya Sharma",
    "Amit Kumar",
  ];

  const [filteredAssignees, setFilteredAssignees] = useState(dummyAssignees);

  useEffect(() => {
    // If assigneeName is empty, show all dummyAssignees
    if (assigneeName.trim() === "") {
      setFilteredAssignees(dummyAssignees);
    } else {
      // Otherwise, filter based on input
      setFilteredAssignees(
        dummyAssignees.filter((name) =>
          name.toLowerCase().includes(assigneeName.toLowerCase())
        )
      );
    }
  }, [assigneeName]); // Depend on assigneeName to re-filter

  const handleAssign = () => {
    if (assigneeName) {
      onSelect(assigneeName);
    }
    // Optionally, clear the input after assigning
    setAssigneeName("");
    onClose(); // Close the popup after assigning
  };

  const selectAssignee = (selectedName) => {
    setAssigneeName(selectedName); // Set the selected name in the input
    onSelect(selectedName); // Pass the selected name to the parent
    onClose(); // Close the popup
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-transparent"
    >
      <div className="bg-transparent backdrop-blur-sm p-6 rounded-2xl shadow-2xl w-[90%] max-w-md mx-auto relative">
        <div className="flex items-center mb-4 bg-white bg-opacity-90 p-3 rounded-t-xl">
          <div className="w-10 h-10 rounded-full bg-[#03B0F5] text-white flex items-center justify-center mr-3">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          </div>
          <h3 className="font-bold text-lg text-black">Assign Lead</h3>
        </div>

        <div className="mb-4 bg-white bg-opacity-90 p-3 rounded-md">
          <label className="block font-bold text-gray-700 mb-2">
            Assign to
          </label>
          <div className="relative">
            <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            <input
              type="text"
              className="w-full pl-10 pr-3 py-2 border border-cyan-400 rounded text-black font-bold"
              value={assigneeName}
              onChange={(e) => setAssigneeName(e.target.value)}
              placeholder="Search or enter assignee name"
            />
            {assigneeName && (
              <button
                className="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600"
                onClick={() => setAssigneeName("")}
                type="button"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            )}
          </div>
        </div>

        {/* Always show the list, filtered or full */}
        <ul className="space-y-2 max-h-60 overflow-y-auto mb-4 border rounded-lg bg-white bg-opacity-90">
          {filteredAssignees.length > 0 ? (
            filteredAssignees.map((name) => (
              <li
                key={name}
                className="p-3 border-b last:border-b-0 cursor-pointer text-black transition hover:bg-gray-100 flex items-center"
                onClick={() => selectAssignee(name)}
              >
                {/* Profile icon with initials or avatar */}
                <div className="w-8 h-8 rounded-full bg-[#03B0F5] text-white flex items-center justify-center mr-3 flex-shrink-0">
                  {name.split(' ')
                    .map(part => part[0])
                    .slice(0, 2)
                    .join('')
                    .toUpperCase()}
                </div>
                <span>{name}</span>
              </li>
            ))
          ) : (
            assigneeName.trim() !== "" && ( // Only show "No results" if user typed something and no results
              <li className="p-3 text-gray-500 text-center">No matching assignees found.</li>
            )
          )}
        </ul>

        <div className="flex justify-end gap-4 mt-4 bg-white bg-opacity-90 p-3 rounded-b-xl">
          <button
            className="px-6 py-3 bg-cyan-600 text-white rounded-xl shadow hover:bg-cyan-700 transition"
            onClick={handleAssign}
          >
            Assign
          </button>
          <button
            className="px-6 py-3 bg-gray-400 text-white rounded-xl shadow hover:bg-gray-500 transition"
            onClick={onClose}
          >
            Cancel
          </button>
        </div>

        <button
          className="absolute top-4 right-4 text-gray-500 hover:text-red-500 text-2xl font-bold"
          onClick={onClose}
        >
          ×
        </button>
      </div>
    </div>
  );
}