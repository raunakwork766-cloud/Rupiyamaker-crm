const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["chunks/task-components-CM05VL7u.js","chunks/lead-components-DjdRUJ-t.js","chunks/vendor-mui-C1GmDdcn.js","chunks/vendor-react-EzoxUMNY.js","chunks/vendor-utils-QXd9EeNt.js","chunks/vendor-antd-BB3a0mYC.js","chunks/employee-components-B8JBcnzi.js","chunks/vendor-office-CbbGW2MO.js","styles/employee-components-CAryrO_Y.css","styles/task-components-DguWJUkH.css"])))=>i.map(i=>d[i]);
import{aW as e,s as t,aV as s,_ as a}from"./lead-components-DjdRUJ-t.js";import{j as n}from"./vendor-mui-C1GmDdcn.js";import{r}from"./vendor-react-EzoxUMNY.js";import{s as o}from"./vendor-antd-BB3a0mYC.js";import"./vendor-utils-QXd9EeNt.js";const l=r.lazy(()=>a(()=>import("./task-components-CM05VL7u.js").then(e=>e.C),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]))),i=r.lazy(()=>a(()=>import("./task-components-CM05VL7u.js").then(e=>e.E),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]))),c="/api";function d({leadData:a}){const[d,p]=r.useState([]),[m,x]=r.useState(!1),[u,h]=r.useState(null),[g,y]=r.useState(null),[f,_]=r.useState(!1),[j,w]=r.useState(null),b=localStorage.getItem("userId")||"";r.useEffect(()=>{(async()=>{if(a?._id){_(!0),w(null);try{const e=localStorage.getItem("userId");if(!e)return void w("User authentication required");const t=a&&(a.original_lead_id||a.login_created_at)?`/api/lead-login/login-leads/${a._id}/tasks?user_id=${e}`:`/api/tasks/lead/${a._id}?user_id=${e}`,s=await fetch(t,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const n=(await s.json()).tasks.map(e=>({id:e.id,createdBy:e.creator_name||e.created_by||"Unknown",status:e.status,subject:e.subject,notes:e.notes||e.details||e.message||"",message:e.notes||e.details||e.message||"",typeTask:e.task_type||e.type||"TO DO",leadLogin:a.lead_number||"",customerName:a.full_name||`${a.first_name||""} ${a.last_name||""}`.trim()||"Customer",date:new Date(e.due_date||e.created_at).toISOString().split("T")[0],time:e.due_time||"12:00 PM",assign:e.assigned_users&&e.assigned_users.length>0?e.assigned_users.map(e=>e.name||e.username||"Unknown").join(", "):"Unassigned",assigned_to:e.assigned_to||[]}));p(n)}catch(e){w("Failed to load tasks")}finally{_(!1)}}})()},[a]);const N=async e=>{if(a?._id)try{const n=localStorage.getItem("userId");if(!n)return;if(e.id){const t=`/api/tasks/${e.id}?user_id=${n}`,s={PENDING:"Pending",IN_PROGRESS:"In Progress",COMPLETED:"Completed",CANCELLED:"Cancelled",Pending:"Pending","In Progress":"In Progress",Completed:"Completed",Cancelled:"Cancelled"},a={"TO DO":"To-Do","To-Do":"To-Do",Call:"Call",Pendency:"Pendency",Processing:"Processing",Completed:"Completed"},r={subject:e.subject,task_details:e.message||e.notes||e.description,status:s[e.status]||"Pending",task_type:a[e.typeTask||e.task_type]||"To-Do",due_date:e.date||e.due_date,due_time:e.time||e.due_time,assigned_to:e.assigned_to||[n]};r.assigned_to&&Array.isArray(r.assigned_to)&&(r.assigned_to=r.assigned_to.filter(e=>e&&"string"==typeof e&&e.length>=12&&/^[0-9a-fA-F]+$/.test(e)));const l=localStorage.getItem("token"),i={Accept:"application/json","Content-Type":"application/json",Authorization:l?`Bearer ${l}`:""},c=await fetch(t,{method:"PUT",headers:i,mode:"cors",body:JSON.stringify(r)});if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);await c.json(),o.success(`Task Updated: ${e.subject||"Untitled"}`)}else{const r=a&&(a.original_lead_id||a.login_created_at)?`/api/lead-login/login-leads/${a._id}/tasks/create?user_id=${n}`:`/api/tasks/lead/${a._id}/create?user_id=${n}`,l={subject:e.subject,task_details:e.message||e.notes||"",status:"Pending",task_type:e.typeTask||"To-Do",due_date:e.date,due_time:e.time,lead_id:a._id,assigned_to:[n],created_by:n};let i=e.attachment;const c=localStorage.getItem("token"),d={Accept:"application/json","Content-Type":"application/json",Authorization:c?`Bearer ${c}`:""},p=await fetch(r,{method:"POST",headers:d,mode:"cors",body:JSON.stringify(l)});if(!p.ok){let e=`HTTP error! status: ${p.status}`;try{const t=await p.json();t.detail&&(e+=` - ${"string"==typeof t.detail?t.detail:JSON.stringify(t.detail)}`)}catch(t){}throw new Error(e)}let m;o.success(`Task Created: ${e.subject||"Untitled"}`);try{const e=await p.json();m=e.id||e.task_id,i&&m&&await k(m,i,n)}catch(s){}}const r=a&&(a.original_lead_id||a.login_created_at)?`${c}/lead-login/login-leads/${a._id}/tasks?user_id=${n}`:`${c}/tasks/lead/${a._id}?user_id=${n}`,l=await fetch(r,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(l.ok){const e=(await l.json()).tasks.map(e=>({id:e.id,createdBy:e.creator_name||e.created_by||"Unknown",status:e.status,subject:e.subject,notes:e.notes||e.details||e.message||"",message:e.notes||e.details||e.message||"",typeTask:e.task_type||e.type||"TO DO",leadLogin:a.lead_number||"",customerName:a.full_name||`${a.first_name||""} ${a.last_name||""}`.trim()||"Customer",date:new Date(e.due_date||e.created_at).toISOString().split("T")[0],time:e.due_time||"12:00 PM",assign:e.assigned_users&&e.assigned_users.length>0?e.assigned_users.map(e=>e.name||e.username||"Unknown").join(", "):"Unassigned",assigned_to:e.assigned_to||[]}));p(e)}}catch(n){}},k=async(e,t,s)=>{if(e&&t&&s)try{const a=new FormData;a.append("file",t);const n=`/api/tasks/${e}/attachments?user_id=${s}`,r=await fetch(n,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`},body:a});if(!r.ok)throw await r.text().catch(()=>"No error details available"),new Error(`Attachment upload failed: ${r.status}`);return await r.json().catch(()=>null)}catch(a){}};function $(e){switch(e){case"Completed":case"COMPLETED":return n.jsx("span",{className:"bg-green-900 text-green-300 px-3 py-1 rounded-full text-xs font-bold",children:"Completed"});case"Cancelled":return n.jsx("span",{className:"bg-red-900 text-red-300 px-3 py-1 rounded-full text-xs font-bold",children:"Cancelled"});case"Pending":case"OPEN":case"UPCOMING":return n.jsx("span",{className:"bg-blue-900 text-blue-300 px-3 py-1 rounded-full text-xs font-bold",children:"Pending"});case"In Progress":return n.jsx("span",{className:"bg-yellow-900 text-yellow-300 px-3 py-1 rounded-full text-xs font-bold",children:"In Progress"});case"OVERDUE":return n.jsx("span",{className:"bg-red-900 text-red-300 px-3 py-1 rounded-full text-xs font-bold",children:"Overdue"});case"DUE TODAY":return n.jsx("span",{className:"bg-yellow-900 text-yellow-300 px-3 py-1 rounded-full text-xs font-bold",children:"Due Today"});default:return n.jsx("span",{className:"bg-gray-800 text-gray-300 px-3 py-1 rounded-full text-xs font-bold",children:e})}}function T(e,t=30){return e?e.length>t?e.slice(0,t)+"...":e:""}return n.jsx("div",{className:"min-h-screen bg-black text-[#e4eaf5] py-10 px-4",children:n.jsxs("div",{className:"max-w-9xl mx-auto",children:[n.jsxs("div",{className:"flex items-center justify-between mb-8",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("span",{className:"text-3xl text-[#08B8EA]",children:n.jsx(e,{size:32})}),n.jsx("h1",{className:"text-2xl font-bold",children:"Task Management"})]}),n.jsxs("button",{className:"bg-[#08B8EA] hover:bg-[#12d8fa] text-white text-xl font-bold px-7 py-2 rounded-2xl shadow-lg transition transform hover:scale-105 flex items-center gap-2",onClick:()=>{x(!0)},children:[n.jsx(t,{size:24}),"Create Task"]})]}),n.jsx("div",{className:"overflow-auto rounded-xl shadow-2xl",children:n.jsxs("table",{className:"min-w-[1000px] w-full",children:[n.jsx("thead",{className:"bg-white",children:n.jsxs("tr",{children:[n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"#"}),n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"Subject"}),n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"Status"}),n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"Created By"}),n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"Lead/Login"}),n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"Customer"}),n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"Assigned"}),n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"Date"}),n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"Time"}),n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"Task Type"}),n.jsx("th",{className:"py-3 px-4 text-lg font-extrabold text-[#03B0F5] text-center whitespace-nowrap",children:"Message"})]})}),n.jsx("tbody",{children:f?n.jsx("tr",{children:n.jsx("td",{colSpan:11,className:"bg-[#181e29] rounded-xl shadow p-8 text-center",children:n.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[n.jsx(s,{size:24,className:"animate-spin text-[#08B8EA]"}),n.jsx("span",{className:"text-lg font-bold text-[#08B8EA]",children:"Loading tasks..."})]})})}):j?n.jsx("tr",{children:n.jsx("td",{colSpan:11,className:"bg-[#181e29] rounded-xl shadow p-8 text-center",children:n.jsx("div",{className:"text-lg font-bold text-red-400",children:j})})}):0===d.length?n.jsx("tr",{children:n.jsx("td",{colSpan:11,className:"bg-[#181e29] rounded-xl shadow p-8 text-center text-lg font-bold text-[#08B8EA]",children:"No Tasks Found"})}):d.map((e,t)=>n.jsxs("tr",{className:"border-b-4 border-white bg-[#181e29] hover:bg-gray-800 transition cursor-pointer",onClick:()=>(async e=>{h(null);try{const s=localStorage.getItem("userId")||"";let n={...e,attachments:e.attachments||[],notes:e.notes||e.message||"",message:e.notes||e.message||"",associateWithRecords:a?[`${a.full_name||""} - ${a.company_name||"N/A"} (${a.status||"Active"})`]:[]};try{const t=localStorage.getItem("token"),a={Accept:"application/json","Content-Type":"application/json"};t&&(a.Authorization=`Bearer ${t}`);const r=await fetch(`${c}/tasks/${e.id}?user_id=${s}`,{headers:a,mode:"cors",signal:AbortSignal.timeout(1e4)});if(r.ok){const e=await r.json();n={...n,notes:e.notes||e.details||n.notes||"",message:e.notes||e.details||n.message||"",associateWithRecords:n.associateWithRecords}}const o=await(async(e,t)=>{if(!e||!t)return[];try{const s=localStorage.getItem("token"),a={Accept:"application/json","Content-Type":"application/json"};s&&(a.Authorization=`Bearer ${s}`);const n=`/api/tasks/${e}/attachments?user_id=${t}`,r=await fetch(n,{method:"GET",headers:a,mode:"cors"});if(!r.ok)return[];const o=await r.json();let l=[];return Array.isArray(o)?l=o:o.attachments&&Array.isArray(o.attachments)?l=o.attachments:"object"==typeof o&&(l=[o]),l}catch(s){return[]}})(e.id,s);o&&o.length>0&&(n.attachments=o)}catch(t){}a&&(n.leadData={id:a._id,name:a.full_name||`${a.first_name||""} ${a.last_name||""}`.trim(),companyName:a.company_name||"N/A",status:a.status||"Active"},n.associateWithLead=a),setTimeout(()=>h(n),0)}catch(s){const t={...e,notes:e.notes||e.message||"",message:e.notes||e.message||"",attachments:e.attachments||[],associateWithRecords:a?[`${a.full_name||""} - ${a.company_name||"N/A"} (${a.status||"Active"})`]:[]};setTimeout(()=>h(t),0)}})(e),children:[n.jsx("td",{className:"text-lg text-bold py-3 px-4 whitespace-nowrap text-center",children:t+1}),n.jsx("td",{className:"text-lg py-3 px-4 whitespace-nowrap font-bold uppercase",children:e.subject}),n.jsx("td",{className:"text-lg font-semibold py-3 px-4 whitespace-nowrap text-center",children:$(e.status)}),n.jsx("td",{className:"text-lg font-semibold py-3 px-4 whitespace-nowrap text-center uppercase",children:e.createdBy}),n.jsx("td",{className:"text-lg font-semibold py-3 px-4 whitespace-nowrap text-center uppercase",children:e.leadLogin}),n.jsx("td",{className:"text-lg font-semibold py-3 px-4 whitespace-nowrap uppercase",children:e.customerName}),n.jsx("td",{className:"text-lg font-semibold py-3 px-4 whitespace-nowrap text-center uppercase",children:e.assign}),n.jsx("td",{className:"text-lg font-semibold py-3 px-4 whitespace-nowrap text-center",children:e.date}),n.jsx("td",{className:"text-lg font-semibold py-3 px-4 whitespace-nowrap text-center",children:e.time}),n.jsx("td",{className:"text-lg font-semibold py-3 px-4 whitespace-nowrap text-center uppercase",children:e.typeTask}),n.jsx("td",{className:"text-lg font-semibold py-3 px-4 whitespace-nowrap uppercase",children:T(e.notes||e.message||"",30)})]},e.id))})]})}),u&&n.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-transparent",style:{backdropFilter:"blur(3px)"},children:n.jsx("div",{className:"w-full max-w-2xl mx-auto relative z-[9999]",children:n.jsx(r.Suspense,{fallback:n.jsx("div",{className:"text-center p-4",children:"Loading..."}),children:n.jsx(i,{taskData:u,onClose:()=>{h(null)},onSave:async e=>{try{const s=e.taskData||e,a=s.attachment||s.newAttachment||e.attachment||null,n={...s,subject:s.subject||s.title,message:s.description||s.message||s.task_details,typeTask:s.task_type||s.typeTask,date:s.due_date||s.date,time:s.due_time||s.time,status:s.status};if(await N(n),a){const e=localStorage.getItem("userId")||"";if(e&&s.id)try{await k(s.id,a,e)}catch(t){}}h(null)}catch(s){}},preselectedLead:a})})})}),m&&n.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-transparent",style:{backdropFilter:"blur(3px)"},children:n.jsx("div",{className:"w-full max-w-2xl mx-auto relative z-[9999]",children:n.jsx(r.Suspense,{fallback:n.jsx("div",{className:"text-center p-4",children:"Loading..."}),children:n.jsx(l,{onClose:()=>{x(!1)},onSave:async e=>{const{taskData:t}=e,s=e.attachment||t.attachment||t.newAttachment||null,n={subject:t.subject,notes:t.message||t.notes||t.task_details||t.details||"",typeTask:t.task_type||t.typeTask,leadLogin:a.lead_number||"",customerName:a.full_name||`${a.first_name||""} ${a.last_name||""}`.trim(),date:t.due_date||t.date||(new Date).toISOString().split("T")[0],time:t.due_time||t.time||"12:00 PM",assigned_to:[b],status:"Pending",attachment:s};try{await N(n),x(!1)}catch(r){}},preselectedLead:a})})})})]})})}export{d as default};
