import{j as e}from"./vendor-mui-C1GmDdcn.js";import{r as t}from"./vendor-react-EzoxUMNY.js";import{aO as a,D as r,v as s,aP as o,t as i,F as n,C as l,w as c,x as d,y as u,z as m,d as x,T as g}from"./lead-components-CRPAALZm.js";import"./vendor-utils-QXd9EeNt.js";import"./vendor-antd-BB3a0mYC.js";const h="/api",p=()=>{const[p,b]=t.useState([]),[f,y]=t.useState(!1),[j,w]=t.useState(0),[N,v]=t.useState("all"),[k,_]=t.useState(""),[S,C]=t.useState("all"),$=()=>{try{const e=localStorage.getItem("userId");if(e)return e;const t=localStorage.getItem("user");if(t){const e=JSON.parse(t);return e.id||e._id||e.user_id}return null}catch(e){return null}},I=()=>{try{const e=$();if(!e)return new Set;const t=localStorage.getItem(`readNotifications_${e}`);return t?new Set(JSON.parse(t)):new Set}catch(e){return new Set}},A=e=>{try{const t=$();if(!t)return;localStorage.setItem(`readNotifications_${t}`,JSON.stringify([...e]))}catch(t){}},O=async()=>{const e=$();if(e){y(!0);try{const t=I(),a=(()=>{try{const e=$();if(!e)return new Set;const t=localStorage.getItem(`removedNotifications_${e}`);return t?new Set(JSON.parse(t)):new Set}catch(e){return new Set}})(),r=fetch(`${h}/notifications?user_id=${e}&limit=100`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")||""}`,"Content-Type":"application/json"}}).then(e=>e.ok?e.json():[]),s=fetch(`${h}/notifications/count?user_id=${e}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")||""}`,"Content-Type":"application/json"}}).then(e=>e.ok?e.json():{unread_count:0}),[o,i]=await Promise.all([r,s]),n=[];Array.isArray(o)&&o.forEach(e=>{const r=e._id||e.id;if(a.has(r))return;const s=e.read||t.has(r);n.push({_id:r,type:e.type||"general",title:e.title||"Notification",message:e.message||e.body||"",created_at:e.created_at||e.timestamp||(new Date).toISOString(),priority:e.priority||"medium",read:s,data:e.data||e})}),n.sort((e,t)=>"high"===e.priority&&"high"!==t.priority?-1:"high"===t.priority&&"high"!==e.priority?1:new Date(t.created_at)-new Date(e.created_at)),b(n),w(n.filter(e=>!e.read).length)}catch(t){b([]),w(0)}finally{y(!1)}}},T=async e=>{try{(await fetch(`${h}/notifications/read/${e}`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")||""}`,"Content-Type":"application/json"}})).ok}catch(a){}b(t=>t.map(t=>t._id===e?{...t,read:!0}:t)),w(e=>Math.max(0,e-1));const t=I();t.add(e),A(t)},D=p.filter(e=>{if("unread"===N&&e.read)return!1;if("read"===N&&!e.read)return!1;if("all"!==S&&e.type!==S)return!1;if(k){const t=k.toLowerCase();return e.title?.toLowerCase().includes(t)||e.message?.toLowerCase().includes(t)}return!0}),P=e=>{try{return new Date(e).toLocaleDateString("en-IN",{timeZone:"Asia/Kolkata",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return"Invalid date"}},z=["all",...new Set(p.map(e=>e.type).filter(Boolean))];return t.useEffect(()=>{O()},[]),e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white shadow-sm border-b",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-16",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>window.history.back(),className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(a,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"w-6 h-6 text-blue-600"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"All Notifications"}),j>0&&e.jsx("span",{className:"bg-red-500 text-white text-sm px-2 py-1 rounded-full",children:j})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:O,disabled:f,className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50",title:"Refresh",children:e.jsx(s,{className:"w-5 h-5 "+(f?"animate-spin":"")})}),j>0&&e.jsxs("button",{onClick:async()=>{const e=$();if(e){try{(await fetch(`${h}/notifications/read-all?user_id=${e}`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")||""}`,"Content-Type":"application/json"}})).ok}catch(t){}b(e=>{const t=e.map(e=>({...e,read:!0})),a=I();return t.forEach(e=>{a.add(e._id)}),A(a),t}),w(0)}},className:"px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors",children:[e.jsx(o,{className:"w-4 h-4 inline mr-2"}),"Mark all as read"]})]})]})})}),e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"bg-white rounded-lg shadow",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("div",{className:"flex space-x-1 bg-gray-100 rounded-lg p-1 mb-4",children:[{key:"all",label:"All",count:p.length},{key:"unread",label:"Unread",count:j},{key:"read",label:"Read",count:p.length-j}].map(t=>e.jsxs("button",{onClick:()=>v(t.key),className:"flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors "+(N===t.key?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"),children:[t.label,t.count>0&&e.jsx("span",{className:"ml-2 px-2 py-0.5 rounded-full text-xs "+(N===t.key?"bg-blue-100 text-blue-600":"bg-gray-200 text-gray-600"),children:t.count})]},t.key))}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(i,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search notifications...",value:k,onChange:e=>_(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),z.length>2&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(n,{className:"w-4 h-4 text-gray-500"}),e.jsx("select",{value:S,onChange:e=>C(e.target.value),className:"border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:z.map(t=>e.jsx("option",{value:t,children:"all"===t?"All Categories":t.charAt(0).toUpperCase()+t.slice(1)},t))})]})]})]}),e.jsx("div",{className:"divide-y divide-gray-100",children:f?e.jsxs("div",{className:"p-8 text-center text-gray-500",children:[e.jsx(s,{className:"w-8 h-8 animate-spin mx-auto mb-3 text-blue-500"}),e.jsx("p",{children:"Loading notifications..."})]}):0===D.length?e.jsxs("div",{className:"p-8 text-center text-gray-500",children:[e.jsx(r,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No notifications"}),e.jsx("p",{className:"text-sm",children:"unread"===N?"All caught up!":k||"all"!==S?"No notifications match your filters.":"You have no notifications yet."})]}):D.map(t=>{const{icon:a,color:r,bgColor:s}=(e=>{switch(e){case"task_overdue":return{icon:g,color:"text-red-600",bgColor:"bg-red-100"};case"task_pending":return{icon:x,color:"text-orange-500",bgColor:"bg-orange-100"};case"ticket_open":return{icon:m,color:"text-blue-500",bgColor:"bg-blue-100"};case"warning":return{icon:u,color:"text-red-500",bgColor:"bg-red-100"};case"leave_status":return{icon:d,color:"text-green-500",bgColor:"bg-green-100"};case"lead_submission":return{icon:c,color:"text-purple-500",bgColor:"bg-purple-100"};default:return{icon:l,color:"text-gray-500",bgColor:"bg-gray-100"}}})(t.type);return e.jsx("div",{className:`p-6 hover:bg-gray-50 transition-colors group cursor-pointer ${t.read?"":"bg-blue-50 border-l-4 border-l-blue-500"} ${"task_overdue"!==t.type||t.read?"":"bg-red-50 border-l-4 border-l-red-500"}`,onClick:()=>{t.read||T(t._id),(e=>{const t=e.data;if(t)try{switch(e.type){case"task_overdue":case"task_pending":window.location.href=`/tasks?task_id=${t._id||t.id}`;break;case"ticket_open":window.location.href=`/tickets?ticket_id=${t._id||t.id}`;break;case"warning":window.location.href=`/warnings?warning_id=${t.id}`;break;case"leave_status":window.location.href=`/leaves?leave_id=${t._id||t.id}`;break;case"lead_submission":t.reference_id?window.location.href=`/lead-crm?lead_id=${t.reference_id}`:t.link&&(window.location.href=t.link);break;default:t.link&&(window.location.href=t.link)}}catch(a){}})(t)},children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:`p-2 rounded-full ${s} flex-shrink-0 ${"task_overdue"!==t.type||t.read?"":"animate-pulse"}`,children:e.jsx(a,{className:`w-5 h-5 ${r}`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"text-base font-medium text-gray-900 "+(t.read?"":"font-semibold"),children:t.title}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:t.message}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:P(t.created_at)})]}),e.jsx("div",{className:"flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity",children:t.read?e.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{b(t=>t.map(t=>t._id===e?{...t,read:!1}:t)),w(e=>e+1);const t=I();t.delete(e),A(t)})(t._id)},className:"px-3 py-1 text-xs text-orange-600 hover:bg-orange-100 rounded-lg transition-colors font-medium",title:"Mark as unread",children:"Unread"}):e.jsx("button",{onClick:e=>{e.stopPropagation(),T(t._id)},className:"px-3 py-1 text-xs text-blue-600 hover:bg-blue-100 rounded-lg transition-colors font-medium",title:"Mark as read",children:"Read"})})]})},t._id)})}),D.length>0&&e.jsxs("div",{className:"p-4 border-t border-gray-200 bg-gray-50",children:[e.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["Showing ",D.length," of ",p.length," notifications",k&&` matching "${k}"`,"all"!==S&&` in ${S}`]}),(k||"all"!==S)&&e.jsx("div",{className:"text-center mt-2",children:e.jsx("button",{onClick:()=>{_(""),C("all")},className:"text-sm text-blue-600 hover:text-blue-800",children:"Clear filters"})})]})]})})]})};export{p as default};
