import{j as e}from"./vendor-mui-C1GmDdcn.js";import{r as t}from"./vendor-react-EzoxUMNY.js";import{g as s,aV as a,S as n,C as i,f as r}from"./lead-components-BqJ0uj9n.js";import"./vendor-utils-QXd9EeNt.js";import"./vendor-antd-BB3a0mYC.js";const o="/api";function l({leadData:l,onUpdate:d,currentUserRole:c,canEdit:m=!0}){const[p,u]=t.useState([]),[g,h]=t.useState({}),[x,f]=t.useState(!1),[y,j]=t.useState(!1),[b,_]=t.useState(""),[w,N]=t.useState(!1);c?.permissions||s();const v=localStorage.getItem("userDepartment")||"sales",q=c?._id||localStorage.getItem("userId");t.useEffect(()=>{if(S(),l?.question_responses){const e={};Object.keys(l.question_responses).forEach(t=>{const s=l.question_responses[t];e[t]=!0===s||"true"===s||"yes"===s||"Yes"===s}),h(e)}else if(l?.importantquestion){const e={};Object.keys(l.importantquestion).forEach(t=>{const s=l.importantquestion[t];e[t]=!0===s||"true"===s||"yes"===s||"Yes"===s}),h(e)}else if(l?.dynamic_fields?.important_questions){const e=l.dynamic_fields.important_questions,t={};Object.keys(e).forEach(s=>{const a=e[s];t[s]=!0===a||"true"===a||"yes"===a||"Yes"===a}),h(t)}},[l]);const S=async()=>{f(!0),_("");try{const e=await fetch(`${o}/lead-login/important-questions?user_id=${q}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}});if(e.ok){const t=await e.json();u(t.questions||[])}else _("Failed to fetch important questions")}catch(e){_("Error fetching important questions")}finally{f(!1)}},k=()=>{if(0===p.length)return!1;const e=p.filter(e=>e.mandatory);return 0===e.length||e.every(e=>!0===g[e.id])},$=()=>"sales"===v&&"FILE COMPLETED"===l?.sub_status&&!l?.file_sent_to_login&&p.length>0&&k(),I=(()=>{if(0===p.length)return{completed:0,total:0,percentage:0};const e=p.filter(e=>!0===g[e.id]).length,t=p.length;return{completed:e,total:t,percentage:t>0?Math.round(e/t*100):0}})();return x?e.jsx("div",{className:"bg-gray-800 p-6 rounded-lg border border-gray-700",children:e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(a,{className:"w-6 h-6 animate-spin text-blue-400 mr-2"}),e.jsx("span",{className:"text-gray-300",children:"Loading important questions..."})]})}):e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"flex items-center",children:p.length>0&&e.jsxs("span",{className:"text-sm bg-blue-100 text-[#03b0f5] px-2 py-1 rounded",children:[I.completed,"/",I.total," completed (",I.percentage,"%)"]})}),$()&&e.jsx("button",{onClick:async()=>{if($()){j(!0);try{const e=await fetch(`${o}/lead-login/send-to-login-department/${l._id}?user_id=${q}`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"}});if(e.ok)alert("File sent to login department successfully!"),d&&d({file_sent_to_login:!0,login_department_sent_date:(new Date).toISOString()});else{const t=await e.json();alert(`Failed to send file: ${t.detail||"Unknown error"}`)}}catch(e){alert("Error sending file to login department")}finally{j(!1)}}},disabled:y,className:"bg-purple-600 hover:bg-purple-700 disabled:bg-purple-800 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg flex items-center font-medium transition-colors",children:y?e.jsxs(e.Fragment,{children:[e.jsx(a,{className:"w-4 h-4 mr-2 animate-spin"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(n,{className:"w-4 h-4 mr-2"}),"Send File to Login Department"]})})]}),b&&e.jsx("div",{className:"mb-4 p-3 bg-red-100 border border-red-400 rounded-lg",children:e.jsxs("div",{className:"flex items-center text-red-700",children:[e.jsx(i,{className:"w-4 h-4 mr-2"}),b]})}),0===p.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(i,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No important questions configured yet."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-[#03b0f5] h-2 rounded-full transition-all duration-300",style:{width:`${I.percentage}%`}})}),e.jsx("div",{className:"space-y-3",children:p.map(t=>e.jsx("div",{className:"p-4 rounded-lg border transition-colors "+(g[t.id]?"bg-green-100 border-green-400":"bg-gray-100 border-gray-300"),children:e.jsxs("label",{className:"flex items-start cursor-pointer gap-3",children:[e.jsx("input",{type:"checkbox",checked:!!g[t.id],onChange:e=>m&&(async(e,t)=>{const s={...g,[e]:t};h(s),d&&d({question_responses:s,importantquestion:s,important_questions_validated:!1}),l&&(window.importantQuestionsTimeout&&clearTimeout(window.importantQuestionsTimeout),window.importantQuestionsTimeout=setTimeout(async()=>{try{const e=p.filter(e=>e.mandatory).every(e=>!0===s[e.id]),t={activity_type:"question_validation",description:e?"Important questions automatically validated":"Important questions updated",created_by:localStorage.getItem("userName")||"Unknown User",user_id:q,created_at:(new Date).toISOString(),details:{questions_validated:Object.keys(s).length,question_ids:Object.keys(s),auto_validated:e}},a={responses:s,activity:t};let n;e?(n=await fetch(`${o}/lead-login/validate-questions/${l._id}?user_id=${q}`,{method:"PATCH",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"},body:JSON.stringify(a)}),n.ok?d&&d({question_responses:s,importantquestion:s,important_questions_validated:!0}):await n.json()):(n=await fetch(`${o}/leads/${l._id}?user_id=${q}`,{method:"PUT",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`,"Content-Type":"application/json"},body:JSON.stringify({question_responses:s,importantquestion:s,updated_by:q})}),n.ok||await n.json())}catch(e){}},500))})(t.id,e.target.checked),disabled:!m,className:"mt-0.5 w-4 h-4 text-[#03b0f5] bg-white border-gray-400 rounded focus:ring-[#03b0f5] focus:ring-2 accent-[#03b0f5] flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-black font-medium leading-5 whitespace-pre-wrap",style:{whiteSpace:"pre-wrap"},children:t.question}),t.mandatory&&e.jsx("span",{className:"bg-red-600 text-white text-xs px-2 py-1 rounded flex-shrink-0",children:"Required"})]}),t.description&&e.jsx("p",{className:"text-gray-600 text-sm mt-1 leading-5 whitespace-pre-wrap",style:{whiteSpace:"pre-wrap"},children:t.description})]}),g[t.id]&&e.jsx(r,{className:"w-5 h-5 text-green-500 flex-shrink-0 mt-0.5"})]})},t.id))}),p.length>0&&e.jsx("div",{className:"mt-4 p-3 rounded-lg border border-gray-300 bg-gray-100",children:k()?e.jsxs("div",{className:"flex items-center text-green-700",children:[e.jsx(r,{className:"w-4 h-4 mr-2"}),"All mandatory questions completed!","FILE COMPLETED"===l?.sub_status&&!l?.file_sent_to_login&&e.jsx("span",{className:"ml-2 text-purple-700",children:"Ready to send to login department."})]}):e.jsxs("div",{className:"flex items-center text-yellow-700",children:[e.jsx(i,{className:"w-4 h-4 mr-2"}),"Please complete all mandatory questions before proceeding."]})})]})]})}export{l as default};
