import{j as e,P as t,T as n,B as a,a as r,d as s,h as i,R as o,i as l,k as u,G as d,l as c,b as p,e as h,A as m,f,m as g,n as x,g as b,o as y,L as w,p as v}from"./vendor-mui-C1GmDdcn.js";import{r as k,R as N}from"./vendor-react-EzoxUMNY.js";import{a7 as S}from"./vendor-utils-QXd9EeNt.js";import{r as I,a as _,ab as C,X as T,B as E,ac as A,W as $,p as R,ad as F,ae as D,n as M,af as O,g as j,i as L,q as z,C as P,ag as B,ah as W,ai as V,aj as U,ak as G,al as H,M as q,e as K,c as X,am as Y,an as Z,ao as J,s as Q}from"./lead-components-CxEP6yWP.js";import{h as ee}from"./employee-components-CPwJv_R0.js";import{T as te,e as ne,I as ae,s as re}from"./vendor-antd-BB3a0mYC.js";import"./vendor-office-CbbGW2MO.js";const se=({statuses:t,selectedDepartment:n,setSelectedDepartment:a,showStatusModal:r,setShowStatusModal:s,showSubStatusModal:i,setShowSubStatusModal:o,statusModalType:l,setStatusModalType:u,subStatusModalType:d,setSubStatusModalType:c,editingStatus:p,setEditingStatus:h,editingSubStatus:m,setEditingSubStatus:f,selectedStatus:g,setSelectedStatus:x,createStatus:b,updateStatus:y,deleteStatus:w,deleteSubStatusFromArray:v,createSubStatus:N,updateSubStatus:S,deleteSubStatus:E})=>{const[A,$]=k.useState(!1),[R,F]=k.useState(!1),D=Array.isArray(t)?t:[];return e.jsxs("div",{className:"p-6 bg-gray-900 text-white",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4 text-white",children:"Status Management"}),e.jsxs("div",{className:"flex gap-4 mb-4",children:[e.jsxs("select",{value:n,onChange:e=>a(e.target.value),className:"px-3 py-2 rounded border border-gray-600 bg-black text-white",children:[e.jsx("option",{value:"",children:"Select Department"}),e.jsx("option",{value:"leads",children:"Leads"}),e.jsx("option",{value:"login",children:"Login"})]}),e.jsxs("button",{className:"bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 flex items-center gap-2",onClick:()=>{u("add"),h(null),s(!0)},children:[e.jsx(I,{size:18})," Add Status"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-black text-white border border-gray-700 rounded",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-800",children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Status Name"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Department"}),e.jsx("th",{className:"px-4 py-2 text-center",children:"Order"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Color"}),e.jsx("th",{className:"px-4 py-2 text-center",children:"Reassign (days)"}),e.jsx("th",{className:"px-4 py-2 text-center",children:"Manager Approval"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Sub-Options"}),e.jsx("th",{className:"px-4 py-2 text-center",children:"Actions"})]})}),e.jsx("tbody",{children:D.filter(e=>""===n||(e.department?e.department===n:!e.department_ids||(Array.isArray(e.department_ids)?e.department_ids.includes(n):e.department_ids===n))).map(t=>e.jsxs("tr",{className:"border-b border-gray-700 hover:bg-gray-800",children:[e.jsx("td",{className:"px-4 py-3 font-semibold",children:t.name}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"px-2 py-1 rounded text-xs bg-blue-600 text-white",children:t.department||(t.department_ids?Array.isArray(t.department_ids)?t.department_ids.join(", "):t.department_ids:"All Departments")})}),e.jsx("td",{className:"px-4 py-3 text-center",children:t.order||0}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 rounded",style:{backgroundColor:t.color||"#6B7280"}}),e.jsx("span",{className:"text-xs",children:t.color||"#6B7280"})]})}),e.jsx("td",{className:"px-4 py-3 text-center",children:t.reassignment_period||0}),e.jsx("td",{className:"px-4 py-3 text-center",children:t.is_manager_permission_required?e.jsx("span",{className:"px-2 py-1 rounded text-xs bg-green-600 text-white",children:"Required"}):e.jsx("span",{className:"px-2 py-1 rounded text-xs bg-gray-600 text-white",children:"Not Required"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"max-w-xs",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-300",children:["Sub-Options (",(t.sub_statuses||[]).length,")"]}),e.jsxs("button",{className:"bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs flex items-center gap-1 transition-colors",onClick:()=>{x(t),c("add"),f(null),o(!0)},title:"Add Sub-Option",children:[e.jsx(I,{size:12})," Add"]})]}),(t.sub_statuses||[]).length>0?e.jsx("div",{className:"space-y-1 border border-gray-600 rounded p-2 bg-gray-800",children:(t.sub_statuses||[]).map((n,a)=>e.jsxs("div",{className:"flex items-center justify-between p-1 hover:bg-gray-700 rounded",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("span",{className:"text-sm text-white",children:"string"==typeof n?n:n.name}),e.jsxs("div",{className:"flex gap-1",children:["object"==typeof n&&n.reassignment_period>0&&e.jsxs("span",{className:"text-xs px-1 py-0.5 bg-blue-700 text-white rounded",title:"Reassignment Period",children:[n.reassignment_period,"d"]}),"object"==typeof n&&n.is_manager_permission_required&&e.jsx("span",{className:"text-xs px-1 py-0.5 bg-green-700 text-white rounded",title:"Manager Permission Required",children:"M"})]})]}),e.jsxs("div",{className:"flex gap-1",children:["object"==typeof n&&e.jsx("button",{className:"text-blue-400 hover:text-blue-300 p-1",onClick:()=>{x(t),f(n),c("edit"),o(!0)},title:"Edit Sub-Option",children:e.jsx(_,{size:12})}),e.jsx("button",{className:"text-red-400 hover:text-red-300 p-1",onClick:async()=>{window.confirm("Are you sure you want to delete this sub-option?")&&("object"==typeof n&&n._id?await E(n._id):await v(t._id||t.id,n,a))},title:"Delete Sub-Option",children:e.jsx(C,{size:12})})]})]},a))}):e.jsx("div",{className:"text-gray-400 text-sm text-center py-2 border border-gray-600 rounded bg-gray-800",children:"No sub-options"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsx("button",{className:"text-blue-400 hover:text-blue-300 p-1",onClick:()=>{h(t),u("edit"),s(!0)},title:"Edit Status",children:e.jsx(_,{size:16})}),e.jsx("button",{className:"text-red-400 hover:text-red-300 p-1",onClick:async()=>{window.confirm("Are you sure you want to delete this status? This will also delete all its sub-options.")&&await w(t._id||t.id)},title:"Delete Status",children:e.jsx(C,{size:16})})]})})]},t._id||t.id))})]})}),r&&e.jsx("div",{className:"fixed inset-0 bg-transparent flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-[#1b2230] border border-gray-600 rounded-lg w-[500px] max-w-[90vw] max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b border-gray-600",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"add"===l?"Add Status":"Edit Status"}),e.jsx("button",{onClick:()=>s(!1),className:"text-gray-400 hover:text-white hover:bg-gray-700 rounded-full p-1 transition-colors",children:e.jsx(T,{size:20})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsxs("form",{id:"statusForm",onSubmit:async e=>{e.preventDefault(),$(!0);try{const t=e.target.statusName.value.trim(),a=e.target.color.value.trim(),r=e.target.order.value.trim(),i=e.target.reassignmentPeriod.value.trim(),o=""===r?1:parseInt(r,10),u=""===i?0:parseInt(i,10),d=e.target.isManagerPermissionRequired?.checked||!1;if(!t)return;const c={name:t,department_ids:"all"===n?null:[n],order:o,color:a||"#6B7280",is_active:!0,reassignment_period:u,is_manager_permission_required:d,description:null};let h=!1;"add"===l?h=await b(c):"edit"===l&&p&&(h=await y(p._id||p.id,c)),h&&s(!1)}finally{$(!1)}},children:[e.jsx("input",{name:"statusName",defaultValue:p?.name||"",placeholder:"Status Name",required:!0,className:"w-full mb-4 px-3 py-2 rounded border border-gray-600 bg-black text-white"}),e.jsx("input",{name:"color",type:"color",defaultValue:p?.color||"#6B7280",className:"w-full mb-4 px-3 py-2 rounded border border-gray-600 bg-black text-white"}),e.jsx("input",{name:"order",type:"number",defaultValue:p?.order||"",placeholder:"Order",min:"1",className:"w-full mb-4 px-3 py-2 rounded border border-gray-600 bg-black text-white"}),e.jsx("input",{name:"reassignmentPeriod",type:"number",defaultValue:p?.reassignment_period||"",placeholder:"Reassignment Period (in days)",min:"0",className:"w-full mb-4 px-3 py-2 rounded border border-gray-600 bg-black text-white"}),e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("input",{name:"isManagerPermissionRequired",type:"checkbox",id:"isManagerPermissionRequired",defaultChecked:p?.is_manager_permission_required||!1,className:"mr-2 h-4 w-4"}),e.jsx("label",{htmlFor:"isManagerPermissionRequired",className:"text-white",children:"Manager approval required"})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2 p-6 border-t border-gray-600",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors",onClick:()=>s(!1),children:"Cancel"}),e.jsx("button",{type:"submit",form:"statusForm",disabled:A,className:"px-4 py-2 text-white rounded transition-colors "+(A?"bg-gray-500 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"),children:A?"Saving...":"add"===l?"Add":"Update"})]})]})}),i&&e.jsx("div",{className:"fixed inset-0 bg-transparent flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-[#1b2230] border border-gray-600 rounded-lg w-[500px] max-w-[90vw] max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b border-gray-600",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"add"===d?"Add Sub-Status":"Edit Sub-Status"}),e.jsx("button",{onClick:()=>o(!1),className:"text-gray-400 hover:text-white hover:bg-gray-700 rounded-full p-1 transition-colors",children:e.jsx(T,{size:20})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsxs("form",{id:"subStatusForm",onSubmit:async e=>{e.preventDefault(),F(!0);try{const t=e.target.subStatusName.value.trim(),n=e.target.reassignmentPeriod.value.trim(),a=""===n?0:parseInt(n,10),r=e.target.isManagerPermissionRequired?.checked||!1;if(!t)return;if("add"===d){const e=[...g.sub_statuses||[]];t.split("\n").filter(e=>""!==e.trim()).forEach(t=>{const n=t.trim();if(n){const t={name:n,reassignment_period:a,is_manager_permission_required:r};e.push(t)}}),await y(g._id||g.id,{sub_statuses:e})&&o(!1)}else{const e=[...g.sub_statuses||[]],n=e.findIndex(e=>("string"==typeof e?e:e.name)===("string"==typeof m?m:m.name));if(-1!==n){const s=e[n];e[n]="object"==typeof s?{...s,name:t,reassignment_period:a,is_manager_permission_required:r}:{name:t,reassignment_period:a,is_manager_permission_required:r},await y(g._id||g.id,{sub_statuses:e})&&o(!1)}}}finally{F(!1)}},children:["add"===d?e.jsx("textarea",{name:"subStatusName",placeholder:"Enter sub-status names (one per line)",required:!0,rows:"5",className:"w-full mb-4 px-3 py-2 rounded border border-gray-600 bg-black text-white"}):e.jsx("input",{name:"subStatusName",defaultValue:"string"==typeof m?m:m?.name||"",placeholder:"Sub-Status Name",required:!0,className:"w-full mb-4 px-3 py-2 rounded border border-gray-600 bg-black text-white"}),e.jsx("input",{name:"reassignmentPeriod",type:"number",defaultValue:"object"==typeof m&&m?.reassignment_period||"",placeholder:"Reassignment Period (in days)",min:"0",className:"w-full mb-4 px-3 py-2 rounded border border-gray-600 bg-black text-white"}),e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("input",{name:"isManagerPermissionRequired",type:"checkbox",id:"subStatusManagerPermissionRequired",defaultChecked:"object"==typeof m&&m?.is_manager_permission_required||!1,className:"mr-2 h-4 w-4"}),e.jsx("label",{htmlFor:"subStatusManagerPermissionRequired",className:"text-white",children:"Manager approval required"})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2 p-6 border-t border-gray-600",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors",onClick:()=>o(!1),children:"Cancel"}),e.jsx("button",{type:"submit",form:"subStatusForm",disabled:R,className:"px-4 py-2 text-white rounded transition-colors "+(R?"bg-gray-500 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"),children:R?"Saving...":"add"===d?"Add":"Update"})]})]})})]})};var ie,oe=Object.defineProperty,le=(ie=function(e){if("undefined"!=typeof require)return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')},"undefined"!=typeof require?require:"undefined"!=typeof Proxy?new Proxy(ie,{get:(e,t)=>("undefined"!=typeof require?require:e)[t]}):ie),ue=(e,t)=>{for(var n in t)oe(e,n,{get:t[n],enumerable:!0})};ue({},{Abs:()=>Gt,Acos:()=>Ht,Acosh:()=>qt,AdadeltaOptimizer:()=>Em,AdagradOptimizer:()=>Am,AdamOptimizer:()=>$m,AdamaxOptimizer:()=>Rm,Add:()=>Kt,AddN:()=>Xt,All:()=>Yt,Any:()=>Zt,ArgMax:()=>Jt,ArgMin:()=>Qt,Asin:()=>en,Asinh:()=>tn,Atan:()=>nn,Atan2:()=>rn,Atanh:()=>an,AvgPool:()=>sn,AvgPool3D:()=>ln,AvgPool3DGrad:()=>un,AvgPoolGrad:()=>on,BackendWasm:()=>JZ,BatchMatMul:()=>dn,BatchToSpaceND:()=>cn,Bincount:()=>pn,BitwiseAnd:()=>hn,BroadcastArgs:()=>fn,BroadcastTo:()=>mn,Callback:()=>aC,CallbackList:()=>Wv,Cast:()=>gn,Ceil:()=>xn,ClipByValue:()=>bn,Complex:()=>yn,ComplexAbs:()=>wn,Concat:()=>vn,Conv2D:()=>kn,Conv2DBackpropFilter:()=>Nn,Conv2DBackpropInput:()=>Sn,Conv3D:()=>In,Conv3DBackpropFilterV2:()=>_n,Conv3DBackpropInputV2:()=>Cn,Cos:()=>Tn,Cosh:()=>En,CropAndResize:()=>Rn,Cumprod:()=>An,Cumsum:()=>$n,CustomCallback:()=>Gv,DataStorage:()=>Pe,DenseBincount:()=>Fn,DepthToSpace:()=>Dn,DepthwiseConv2dNative:()=>Mn,DepthwiseConv2dNativeBackpropFilter:()=>On,DepthwiseConv2dNativeBackpropInput:()=>jn,Diag:()=>Ln,Dilation2D:()=>zn,Dilation2DBackpropFilter:()=>Bn,Dilation2DBackpropInput:()=>Pn,Draw:()=>Wn,ENV:()=>Wt,EarlyStopping:()=>lC,Einsum:()=>Un,Elu:()=>Gn,EluGrad:()=>Hn,Environment:()=>Lt,Equal:()=>Kn,Erf:()=>qn,Exp:()=>Xn,ExpandDims:()=>Yn,Expm1:()=>Zn,FFT:()=>Jn,Fill:()=>Qn,FlipLeftRight:()=>ea,Floor:()=>ta,FloorDiv:()=>na,FromPixels:()=>ss,FusedBatchNorm:()=>aa,FusedConv2D:()=>ls,FusedDepthwiseConv2D:()=>us,GPGPUContext:()=>JL,GatherNd:()=>sa,GatherV2:()=>ra,GraphModel:()=>HT,Greater:()=>ia,GreaterEqual:()=>oa,History:()=>Uv,IFFT:()=>ua,Identity:()=>la,Imag:()=>da,InputSpec:()=>Uw,IsFinite:()=>ca,IsInf:()=>pa,IsNan:()=>ha,KernelBackend:()=>Be,LRN:()=>_a,LRNGrad:()=>Ca,LayerVariable:()=>Bw,LayersModel:()=>Vk,LeakyRelu:()=>ma,Less:()=>fa,LessEqual:()=>ga,LinSpace:()=>xa,Log:()=>ba,Log1p:()=>ya,LogSoftmax:()=>Sa,LogicalAnd:()=>wa,LogicalNot:()=>va,LogicalOr:()=>ka,LogicalXor:()=>Na,LowerBound:()=>Ia,MathBackendCPU:()=>dA,MathBackendWebGL:()=>hP,MatrixBandPart:()=>Ta,Max:()=>Ea,MaxPool:()=>$a,MaxPool3D:()=>Fa,MaxPool3DGrad:()=>Da,MaxPoolGrad:()=>Ra,MaxPoolWithArgmax:()=>Ma,Maximum:()=>Aa,Mean:()=>Oa,Min:()=>ja,Minimum:()=>La,MirrorPad:()=>za,Mod:()=>Pa,MomentumOptimizer:()=>Dm,Multinomial:()=>Ba,Multiply:()=>Wa,Neg:()=>Va,NonMaxSuppressionV3:()=>Ga,NonMaxSuppressionV4:()=>Ha,NonMaxSuppressionV5:()=>qa,NotEqual:()=>Ua,OP_SCOPE_SUFFIX:()=>Pi,OneHot:()=>Xa,OnesLike:()=>Ka,Optimizer:()=>Tm,OptimizerConstructors:()=>zf,Pack:()=>Ya,PadV2:()=>Za,Pool:()=>Ja,Pow:()=>Qa,Prelu:()=>er,Prod:()=>tr,RMSPropOptimizer:()=>Mm,RNN:()=>ZN,RaggedGather:()=>nr,RaggedRange:()=>ar,RaggedTensorToTensor:()=>rr,Range:()=>sr,Rank:()=>oi,Real:()=>ir,RealDiv:()=>Vn,Reciprocal:()=>or,Reduction:()=>Xh,Relu:()=>lr,Relu6:()=>mr,Reshape:()=>ur,ResizeBilinear:()=>pr,ResizeBilinearGrad:()=>hr,ResizeNearestNeighbor:()=>dr,ResizeNearestNeighborGrad:()=>cr,Reverse:()=>fr,RotateWithOffset:()=>is,Round:()=>gr,Rsqrt:()=>xr,SGDOptimizer:()=>Fm,ScatterNd:()=>br,SearchSorted:()=>wr,Select:()=>vr,Selu:()=>kr,Sequential:()=>qk,Sigmoid:()=>Cr,Sign:()=>_r,Sin:()=>Sr,Sinh:()=>Ir,Slice:()=>Nr,Softmax:()=>Fr,Softplus:()=>Tr,SpaceToBatchND:()=>$r,SparseFillEmptyRows:()=>Dr,SparseReshape:()=>Mr,SparseSegmentMean:()=>Or,SparseSegmentSum:()=>jr,SparseToDense:()=>Lr,SplitV:()=>Rr,Sqrt:()=>Er,Square:()=>Pr,SquaredDifference:()=>zr,StaticRegexReplace:()=>Br,Step:()=>rs,StridedSlice:()=>Wr,StringNGrams:()=>Vr,StringSplit:()=>Ur,StringToHashBucketFast:()=>Gr,Sub:()=>Hr,Sum:()=>Ar,SymbolicTensor:()=>Gw,Tan:()=>qr,Tanh:()=>Kr,Tensor:()=>ri,TensorBuffer:()=>ti,TensorScatterUpdate:()=>yr,Tile:()=>Xr,TopK:()=>Yr,Transform:()=>Zr,Transpose:()=>Jr,Unique:()=>Qr,Unpack:()=>es,UnsortedSegmentSum:()=>ts,UpperBound:()=>ns,Variable:()=>ii,ZerosLike:()=>as,_FusedMatMul:()=>os,abs:()=>yl,acos:()=>wl,acosh:()=>vl,add:()=>fl,addN:()=>kl,all:()=>Nl,any:()=>Sl,argMax:()=>Il,argMin:()=>_l,asin:()=>Cl,asinh:()=>Tl,atan:()=>El,atan2:()=>Al,atanh:()=>$l,avgPool:()=>Kl,avgPool3d:()=>Xl,backend:()=>ho,backend_util:()=>Uf,basicLSTMCell:()=>tu,batchNorm:()=>ru,batchNorm2d:()=>su,batchNorm3d:()=>iu,batchNorm4d:()=>ou,batchToSpaceND:()=>nu,bincount:()=>lu,bitwiseAnd:()=>uu,booleanMaskAsync:()=>Qp,broadcastArgs:()=>du,broadcastTo:()=>cu,broadcast_util:()=>Mu,browser:()=>of,buffer:()=>cl,callbacks:()=>uC,cast:()=>pl,ceil:()=>pu,clipByValue:()=>mu,clone:()=>hl,complex:()=>Wi,concat:()=>Yl,concat1d:()=>fu,concat2d:()=>gu,concat3d:()=>xu,concat4d:()=>bu,constraints:()=>iv,conv1d:()=>wu,conv2d:()=>yu,conv2dTranspose:()=>ku,conv3d:()=>Nu,conv3dTranspose:()=>Iu,copyRegisteredKernels:()=>vs,cos:()=>_u,cosh:()=>Cu,cosineWindow:()=>oh,cumprod:()=>Tu,cumsum:()=>Eu,customGrad:()=>jd,data:()=>YT,denseBincount:()=>Au,deprecationWarn:()=>Yi,depthToSpace:()=>$u,depthwiseConv2d:()=>Ru,deregisterOp:()=>hC,device_util:()=>Ai,diag:()=>Fu,dilation2d:()=>Du,disableDeprecationWarnings:()=>Xi,dispose:()=>no,disposeVariables:()=>Zi,div:()=>xl,divNoNan:()=>Wu,dot:()=>Vu,dropout:()=>sh,einsum:()=>Uu,elu:()=>Gu,enableDebugMode:()=>Ki,enableProdMode:()=>qi,enclosingPowerOfTwo:()=>ih,engine:()=>Ji,ensureShape:()=>Hu,env:()=>Pt,equal:()=>zu,erf:()=>qu,euclideanNorm:()=>cd,exp:()=>pd,expandDims:()=>hd,expm1:()=>md,eye:()=>gd,fft:()=>kp,fill:()=>hu,findBackend:()=>uo,findBackendFactory:()=>co,floor:()=>xd,floorDiv:()=>gl,forceHalfFloat:()=>fP,fused:()=>uh,gather:()=>bd,gatherND:()=>rh,gather_util:()=>gf,getBackend:()=>oo,getGradient:()=>fs,getKernel:()=>ms,getKernelsForBackend:()=>gs,getThreadsCount:()=>cJ,gpgpu_util:()=>EL,grad:()=>Rd,grads:()=>Fd,greater:()=>yd,greaterEqual:()=>wd,ifft:()=>Np,imag:()=>vd,image:()=>gm,inTopKAsync:()=>lh,initializers:()=>vv,input:()=>Yk,io:()=>jm,irfft:()=>Sp,isFinite:()=>kd,isInf:()=>Nd,isNaN:()=>Sd,keep:()=>ao,kernel_impls:()=>Yg,layers:()=>Lv,leakyRelu:()=>Id,less:()=>_d,lessEqual:()=>Cd,linalg:()=>xm,linspace:()=>Td,loadGraphModel:()=>qT,loadGraphModelSync:()=>KT,loadLayersModel:()=>Hk,localResponseNormalization:()=>Ed,log:()=>Ad,log1p:()=>$d,logSigmoid:()=>Bd,logSoftmax:()=>Vd,logSumExp:()=>Ud,logicalAnd:()=>Gd,logicalNot:()=>Hd,logicalOr:()=>qd,logicalXor:()=>Kd,losses:()=>bm,lowerBound:()=>Zd,matMul:()=>Zl,math:()=>rf,max:()=>nd,maxPool:()=>Jd,maxPool3d:()=>Qd,maxPoolWithArgmax:()=>ec,maximum:()=>tc,mean:()=>nc,memory:()=>Qi,meshgrid:()=>sc,metrics:()=>M_,min:()=>ad,minimum:()=>ic,mirrorPad:()=>oc,mod:()=>lc,model:()=>Kk,models:()=>J_,moments:()=>uc,movingAverage:()=>th,mul:()=>bl,multiRNNCell:()=>dc,multinomial:()=>cc,neg:()=>zd,nextFrame:()=>Wf,norm:()=>dd,notEqual:()=>pc,oneHot:()=>hc,ones:()=>rc,onesLike:()=>mc,op:()=>Bi,outerProduct:()=>fc,pad:()=>gc,pad1d:()=>xc,pad2d:()=>bc,pad3d:()=>yc,pad4d:()=>wc,pool:()=>kc,pow:()=>rd,prelu:()=>Nc,print:()=>ml,prod:()=>Sc,profile:()=>eo,raggedGather:()=>Ic,raggedRange:()=>_c,raggedTensorToTensor:()=>Cc,rand:()=>Tc,randomGamma:()=>Kc,randomNormal:()=>Xc,randomStandardNormal:()=>Yc,randomUniform:()=>Zc,randomUniformInt:()=>Jc,range:()=>Qc,ready:()=>io,real:()=>ep,reciprocal:()=>tp,registerBackend:()=>po,registerCallbackConstructor:()=>Zk,registerGradient:()=>bs,registerKernel:()=>xs,registerOp:()=>cC,regularizers:()=>Q_,relu:()=>np,relu6:()=>ap,removeBackend:()=>lo,reshape:()=>ql,reverse:()=>rp,reverse1d:()=>sp,reverse2d:()=>ip,reverse3d:()=>op,reverse4d:()=>lp,rfft:()=>_p,round:()=>up,rsqrt:()=>dp,scalar:()=>sd,scatterND:()=>nh,scatter_util:()=>zp,searchSorted:()=>Yd,selu:()=>cp,separableConv2d:()=>pp,sequential:()=>Xk,serialization:()=>vm,setBackend:()=>so,setPlatform:()=>mo,setThreadsCount:()=>dJ,setWasmPath:()=>iJ,setWasmPaths:()=>oJ,setWebGLContext:()=>XO,setdiff1dAsync:()=>hp,shared:()=>cA,sigmoid:()=>Jl,sign:()=>mp,signal:()=>fm,sin:()=>fp,sinh:()=>gp,slice:()=>Ql,slice1d:()=>xp,slice2d:()=>bp,slice3d:()=>yp,slice4d:()=>wp,slice_util:()=>bf,softmax:()=>vp,softplus:()=>Pd,spaceToBatchND:()=>vc,sparse:()=>ym,sparseToDense:()=>ah,spectral:()=>mm,split:()=>Ip,sqrt:()=>id,square:()=>od,squaredDifference:()=>Cp,squeeze:()=>Tp,stack:()=>Ep,step:()=>Ap,stridedSlice:()=>$p,string:()=>wm,sub:()=>Wd,sum:()=>ld,sumOutType:()=>fi,tan:()=>Rp,tanh:()=>eu,tensor:()=>Ui,tensor1d:()=>Fp,tensor2d:()=>Dp,tensor3d:()=>Mp,tensor4d:()=>Op,tensor5d:()=>jp,tensor6d:()=>Lp,tensorScatterUpdate:()=>Vp,tensor_util:()=>pi,test_util:()=>Ac,tidy:()=>to,tile:()=>fd,time:()=>ro,topk:()=>Up,train:()=>Pf,transpose:()=>eh,truncatedNormal:()=>Gp,unique:()=>Hp,unregisterGradient:()=>ws,unregisterKernel:()=>ys,unsortedSegmentSum:()=>qp,unstack:()=>Kp,upcastType:()=>mi,upperBound:()=>Xp,util:()=>Ns,valueAndGrad:()=>Dd,valueAndGrads:()=>Md,variable:()=>Yp,variableGrads:()=>Od,version:()=>mJ,version_converter:()=>XT,version_core:()=>Lf,version_cpu:()=>OR,version_layers:()=>Ik,version_wasm:()=>pJ,version_webgl:()=>mP,webgl:()=>gP,webgl_util:()=>VO,where:()=>Pu,whereAsync:()=>Jp,zeros:()=>ac,zerosLike:()=>Bu});var de=Object.create,ce=Object.defineProperty,pe=Object.getOwnPropertyDescriptor,he=Object.getOwnPropertyNames,me=Object.getPrototypeOf,fe=Object.prototype.hasOwnProperty,ge=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),xe=(e,t)=>{for(var n in t)ce(e,n,{get:t[n],enumerable:!0})},be=(e,t,n)=>(n=null!=e?de(me(e)):{},((e,t,n,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of he(t))!fe.call(e,r)&&undefined!==r&&ce(e,r,{get:()=>t[r],enumerable:!(a=pe(t,r))||a.enumerable});return e})(e&&e.__esModule?n:ce(n,"default",{value:e,enumerable:!0}),e)),ye=ge((e,t)=>{t.exports=a;var n=null;try{n=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(_){}function a(e,t,n){this.low=0|e,this.high=0|t,this.unsigned=!!n}function r(e){return!0===(e&&e.__isLong__)}a.prototype.__isLong__,Object.defineProperty(a.prototype,"__isLong__",{value:!0}),a.isLong=r;var s={},i={};function o(e,t){var n,a,r;return t?(r=0<=(e>>>=0)&&e<256)&&(a=i[e])?a:(n=u(e,(0|e)<0?-1:0,!0),r&&(i[e]=n),n):(r=-128<=(e|=0)&&e<128)&&(a=s[e])?a:(n=u(e,e<0?-1:0,!1),r&&(s[e]=n),n)}function l(e,t){if(isNaN(e))return t?b:x;if(t){if(e<0)return b;if(e>=m)return N}else{if(e<=-f)return S;if(e+1>=f)return k}return e<0?l(-e,t).neg():u(e%h|0,e/h|0,t)}function u(e,t,n){return new a(e,t,n)}a.fromInt=o,a.fromNumber=l,a.fromBits=u;var d=Math.pow;function c(e,t,n){if(0===e.length)throw Error("empty string");if("NaN"===e||"Infinity"===e||"+Infinity"===e||"-Infinity"===e)return x;if("number"==typeof t?(n=t,t=!1):t=!!t,(n=n||10)<2||36<n)throw RangeError("radix");var a;if((a=e.indexOf("-"))>0)throw Error("interior hyphen");if(0===a)return c(e.substring(1),t,n).neg();for(var r=l(d(n,8)),s=x,i=0;i<e.length;i+=8){var o=Math.min(8,e.length-i),u=parseInt(e.substring(i,i+o),n);if(o<8){var p=l(d(n,o));s=s.mul(p).add(l(u))}else s=(s=s.mul(r)).add(l(u))}return s.unsigned=t,s}function p(e,t){return"number"==typeof e?l(e,t):"string"==typeof e?c(e,t):u(e.low,e.high,"boolean"==typeof t?t:e.unsigned)}a.fromString=c,a.fromValue=p;var h=4294967296,m=h*h,f=m/2,g=o(1<<24),x=o(0);a.ZERO=x;var b=o(0,!0);a.UZERO=b;var y=o(1);a.ONE=y;var w=o(1,!0);a.UONE=w;var v=o(-1);a.NEG_ONE=v;var k=u(-1,2147483647,!1);a.MAX_VALUE=k;var N=u(-1,-1,!0);a.MAX_UNSIGNED_VALUE=N;var S=u(0,-2147483648,!1);a.MIN_VALUE=S;var I=a.prototype;I.toInt=function(){return this.unsigned?this.low>>>0:this.low},I.toNumber=function(){return this.unsigned?(this.high>>>0)*h+(this.low>>>0):this.high*h+(this.low>>>0)},I.toString=function(e){if((e=e||10)<2||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(S)){var t=l(e),n=this.div(t),a=n.mul(t).sub(this);return n.toString(e)+a.toInt().toString(e)}return"-"+this.neg().toString(e)}for(var r=l(d(e,6),this.unsigned),s=this,i="";;){var o=s.div(r),u=(s.sub(o.mul(r)).toInt()>>>0).toString(e);if((s=o).isZero())return u+i;for(;u.length<6;)u="0"+u;i=""+u+i}},I.getHighBits=function(){return this.high},I.getHighBitsUnsigned=function(){return this.high>>>0},I.getLowBits=function(){return this.low},I.getLowBitsUnsigned=function(){return this.low>>>0},I.getNumBitsAbs=function(){if(this.isNegative())return this.eq(S)?64:this.neg().getNumBitsAbs();for(var e=0!=this.high?this.high:this.low,t=31;t>0&&!(e&1<<t);t--);return 0!=this.high?t+33:t+1},I.isZero=function(){return 0===this.high&&0===this.low},I.eqz=I.isZero,I.isNegative=function(){return!this.unsigned&&this.high<0},I.isPositive=function(){return this.unsigned||this.high>=0},I.isOdd=function(){return!(1&~this.low)},I.isEven=function(){return!(1&this.low)},I.equals=function(e){return r(e)||(e=p(e)),(this.unsigned===e.unsigned||this.high>>>31!=1||e.high>>>31!=1)&&this.high===e.high&&this.low===e.low},I.eq=I.equals,I.notEquals=function(e){return!this.eq(e)},I.neq=I.notEquals,I.ne=I.notEquals,I.lessThan=function(e){return this.comp(e)<0},I.lt=I.lessThan,I.lessThanOrEqual=function(e){return this.comp(e)<=0},I.lte=I.lessThanOrEqual,I.le=I.lessThanOrEqual,I.greaterThan=function(e){return this.comp(e)>0},I.gt=I.greaterThan,I.greaterThanOrEqual=function(e){return this.comp(e)>=0},I.gte=I.greaterThanOrEqual,I.ge=I.greaterThanOrEqual,I.compare=function(e){if(r(e)||(e=p(e)),this.eq(e))return 0;var t=this.isNegative(),n=e.isNegative();return t&&!n?-1:!t&&n?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1},I.comp=I.compare,I.negate=function(){return!this.unsigned&&this.eq(S)?S:this.not().add(y)},I.neg=I.negate,I.add=function(e){r(e)||(e=p(e));var t=this.high>>>16,n=65535&this.high,a=this.low>>>16,s=65535&this.low,i=e.high>>>16,o=65535&e.high,l=e.low>>>16,d=0,c=0,h=0,m=0;return h+=(m+=s+(65535&e.low))>>>16,c+=(h+=a+l)>>>16,d+=(c+=n+o)>>>16,d+=t+i,u((h&=65535)<<16|(m&=65535),(d&=65535)<<16|(c&=65535),this.unsigned)},I.subtract=function(e){return r(e)||(e=p(e)),this.add(e.neg())},I.sub=I.subtract,I.multiply=function(e){if(this.isZero())return x;if(r(e)||(e=p(e)),n)return u(n.mul(this.low,this.high,e.low,e.high),n.get_high(),this.unsigned);if(e.isZero())return x;if(this.eq(S))return e.isOdd()?S:x;if(e.eq(S))return this.isOdd()?S:x;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(g)&&e.lt(g))return l(this.toNumber()*e.toNumber(),this.unsigned);var t=this.high>>>16,a=65535&this.high,s=this.low>>>16,i=65535&this.low,o=e.high>>>16,d=65535&e.high,c=e.low>>>16,h=65535&e.low,m=0,f=0,b=0,y=0;return b+=(y+=i*h)>>>16,f+=(b+=s*h)>>>16,b&=65535,f+=(b+=i*c)>>>16,m+=(f+=a*h)>>>16,f&=65535,m+=(f+=s*c)>>>16,f&=65535,m+=(f+=i*d)>>>16,m+=t*h+a*c+s*d+i*o,u((b&=65535)<<16|(y&=65535),(m&=65535)<<16|(f&=65535),this.unsigned)},I.mul=I.multiply,I.divide=function(e){if(r(e)||(e=p(e)),e.isZero())throw Error("division by zero");var t,a,s;if(n)return this.unsigned||-2147483648!==this.high||-1!==e.low||-1!==e.high?u((this.unsigned?n.div_u:n.div_s)(this.low,this.high,e.low,e.high),n.get_high(),this.unsigned):this;if(this.isZero())return this.unsigned?b:x;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return b;if(e.gt(this.shru(1)))return w;s=b}else{if(this.eq(S))return e.eq(y)||e.eq(v)?S:e.eq(S)?y:(t=this.shr(1).div(e).shl(1)).eq(x)?e.isNegative()?y:v:(a=this.sub(e.mul(t)),s=t.add(a.div(e)));if(e.eq(S))return this.unsigned?b:x;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();s=x}for(a=this;a.gte(e);){t=Math.max(1,Math.floor(a.toNumber()/e.toNumber()));for(var i=Math.ceil(Math.log(t)/Math.LN2),o=i<=48?1:d(2,i-48),c=l(t),h=c.mul(e);h.isNegative()||h.gt(a);)h=(c=l(t-=o,this.unsigned)).mul(e);c.isZero()&&(c=y),s=s.add(c),a=a.sub(h)}return s},I.div=I.divide,I.modulo=function(e){return r(e)||(e=p(e)),n?u((this.unsigned?n.rem_u:n.rem_s)(this.low,this.high,e.low,e.high),n.get_high(),this.unsigned):this.sub(this.div(e).mul(e))},I.mod=I.modulo,I.rem=I.modulo,I.not=function(){return u(~this.low,~this.high,this.unsigned)},I.and=function(e){return r(e)||(e=p(e)),u(this.low&e.low,this.high&e.high,this.unsigned)},I.or=function(e){return r(e)||(e=p(e)),u(this.low|e.low,this.high|e.high,this.unsigned)},I.xor=function(e){return r(e)||(e=p(e)),u(this.low^e.low,this.high^e.high,this.unsigned)},I.shiftLeft=function(e){return r(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?u(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):u(0,this.low<<e-32,this.unsigned)},I.shl=I.shiftLeft,I.shiftRight=function(e){return r(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?u(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):u(this.high>>e-32,this.high>=0?0:-1,this.unsigned)},I.shr=I.shiftRight,I.shiftRightUnsigned=function(e){if(r(e)&&(e=e.toInt()),0==(e&=63))return this;var t=this.high;return e<32?u(this.low>>>e|t<<32-e,t>>>e,this.unsigned):u(32===e?t:t>>>e-32,0,this.unsigned)},I.shru=I.shiftRightUnsigned,I.shr_u=I.shiftRightUnsigned,I.toSigned=function(){return this.unsigned?u(this.low,this.high,!1):this},I.toUnsigned=function(){return this.unsigned?this:u(this.low,this.high,!0)},I.toBytes=function(e){return e?this.toBytesLE():this.toBytesBE()},I.toBytesLE=function(){var e=this.high,t=this.low;return[255&t,t>>>8&255,t>>>16&255,t>>>24,255&e,e>>>8&255,e>>>16&255,e>>>24]},I.toBytesBE=function(){var e=this.high,t=this.low;return[e>>>24,e>>>16&255,e>>>8&255,255&e,t>>>24,t>>>16&255,t>>>8&255,255&t]},a.fromBytes=function(e,t,n){return n?a.fromBytesLE(e,t):a.fromBytesBE(e,t)},a.fromBytesLE=function(e,t){return new a(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24,t)},a.fromBytesBE=function(e,t){return new a(e[4]<<24|e[5]<<16|e[6]<<8|e[7],e[0]<<24|e[1]<<16|e[2]<<8|e[3],t)}}),we=ge(()=>{}),ve=ge(()=>{}),ke=ge((e,t)=>{!function(e,t,n){function a(e){var t=this,n=function(){var e=4022871197;return function(t){t=String(t);for(var n=0;n<t.length;n++){var a=.02519603282416938*(e+=t.charCodeAt(n));a-=e=a>>>0,e=(a*=e)>>>0,e+=4294967296*(a-=e)}return 2.3283064365386963e-10*(e>>>0)}}();t.next=function(){var e=2091639*t.s0+2.3283064365386963e-10*t.c;return t.s0=t.s1,t.s1=t.s2,t.s2=e-(t.c=0|e)},t.c=1,t.s0=n(" "),t.s1=n(" "),t.s2=n(" "),t.s0-=n(e),t.s0<0&&(t.s0+=1),t.s1-=n(e),t.s1<0&&(t.s1+=1),t.s2-=n(e),t.s2<0&&(t.s2+=1),n=null}function r(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function s(e,t){var n=new a(e),s=t&&t.state,i=n.next;return i.int32=function(){return 4294967296*n.next()|0},i.double=function(){return i()+11102230246251565e-32*(2097152*i()|0)},i.quick=i,s&&("object"==typeof s&&r(s,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=s:n&&n.amd?n(function(){return s}):this.alea=s}(0,"object"==typeof t&&t,"function"==typeof define&&define)}),Ne=ge((e,t)=>{!function(e,t,n){function a(e){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:n+=e;for(var a=0;a<n.length+64;a++)t.x^=0|n.charCodeAt(a),t.next()}function r(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function s(e,t){var n=new a(e),s=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},i.int32=n.next,i.quick=i,s&&("object"==typeof s&&r(s,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=s:n&&n.amd?n(function(){return s}):this.xor128=s}(0,"object"==typeof t&&t,"function"==typeof define&&define)}),Se=ge((e,t)=>{!function(e,t,n){function a(e){var t=this,n="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^e^e<<1)|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:n+=e;for(var a=0;a<n.length+64;a++)t.x^=0|n.charCodeAt(a),a==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function r(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function s(e,t){var n=new a(e),s=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},i.int32=n.next,i.quick=i,s&&("object"==typeof s&&r(s,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=s:n&&n.amd?n(function(){return s}):this.xorwow=s}(0,"object"==typeof t&&t,"function"==typeof define&&define)}),Ie=ge((e,t)=>{!function(e,t,n){function a(e){var t=this;t.next=function(){var e,n,a=t.x,r=t.i;return e=a[r],n=(e^=e>>>7)^e<<24,n^=(e=a[r+1&7])^e>>>10,n^=(e=a[r+3&7])^e>>>3,n^=(e=a[r+4&7])^e<<7,e=a[r+7&7],n^=(e^=e<<13)^e<<9,a[r]=n,t.i=r+1&7,n},function(e,t){var n,a=[];if(t===(0|t))a[0]=t;else for(t=""+t,n=0;n<t.length;++n)a[7&n]=a[7&n]<<15^t.charCodeAt(n)+a[n+1&7]<<13;for(;a.length<8;)a.push(0);for(n=0;n<8&&0===a[n];++n);for(8==n?a[7]=-1:a[n],e.x=a,e.i=0,n=256;n>0;--n)e.next()}(t,e)}function r(e,t){return t.x=e.x.slice(),t.i=e.i,t}function s(e,t){null==e&&(e=+new Date);var n=new a(e),s=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},i.int32=n.next,i.quick=i,s&&(s.x&&r(s,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=s:n&&n.amd?n(function(){return s}):this.xorshift7=s}(0,"object"==typeof t&&t,"function"==typeof define&&define)}),_e=ge((e,t)=>{!function(e,t,n){function a(e){var t=this;t.next=function(){var e,n,a=t.w,r=t.X,s=t.i;return t.w=a=a+1640531527|0,n=r[s+34&127],e=r[s=s+1&127],n^=n<<13,e^=e<<17,n^=n>>>15,e^=e>>>12,n=r[s]=n^e,t.i=s,n+(a^a>>>16)|0},function(e,t){var n,a,r,s,i,o=[],l=128;for(t===(0|t)?(a=t,t=null):(t+="\0",a=0,l=Math.max(l,t.length)),r=0,s=-32;s<l;++s)t&&(a^=t.charCodeAt((s+32)%t.length)),0===s&&(i=a),a^=a<<10,a^=a>>>15,a^=a<<4,a^=a>>>13,s>=0&&(i=i+1640531527|0,r=0==(n=o[127&s]^=a+i)?r+1:0);for(r>=128&&(o[127&(t&&t.length||0)]=-1),r=127,s=512;s>0;--s)a=o[r+34&127],n=o[r=r+1&127],a^=a<<13,n^=n<<17,a^=a>>>15,n^=n>>>12,o[r]=a^n;e.w=i,e.X=o,e.i=r}(t,e)}function r(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function s(e,t){null==e&&(e=+new Date);var n=new a(e),s=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},i.int32=n.next,i.quick=i,s&&(s.X&&r(s,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=s:n&&n.amd?n(function(){return s}):this.xor4096=s}(0,"object"==typeof t&&t,"function"==typeof define&&define)}),Ce=ge((e,t)=>{!function(e,t,n){function a(e){var t=this,n="";t.next=function(){var e=t.b,n=t.c,a=t.d,r=t.a;return e=e<<25^e>>>7^n,n=n-a|0,a=a<<24^a>>>8^r,r=r-e|0,t.b=e=e<<20^e>>>12^n,t.c=n=n-a|0,t.d=a<<16^n>>>16^r,t.a=r-e|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,e===Math.floor(e)?(t.a=e/4294967296|0,t.b=0|e):n+=e;for(var a=0;a<n.length+20;a++)t.b^=0|n.charCodeAt(a),t.next()}function r(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function s(e,t){var n=new a(e),s=t&&t.state,i=function(){return(n.next()>>>0)/4294967296};return i.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},i.int32=n.next,i.quick=i,s&&("object"==typeof s&&r(s,n),i.state=function(){return r(n,{})}),i}t&&t.exports?t.exports=s:n&&n.amd?n(function(){return s}):this.tychei=s}(0,"object"==typeof t&&t,"function"==typeof define&&define)}),Te=ge(()=>{}),Ee=ge((e,t)=>{!function(e,n,a){var r,s=256,i="random",o=a.pow(s,6),l=a.pow(2,52),u=2*l,d=255;function c(t,d,c){var x=[],b=f(m((d=1==d?{entropy:!0}:d||{}).entropy?[t,g(n)]:null==t?function(){try{var t;return r&&(t=r.randomBytes)?t=t(s):(t=new Uint8Array(s),(e.crypto||e.msCrypto).getRandomValues(t)),g(t)}catch(x){var a=e.navigator,i=a&&a.plugins;return[+new Date,e,i,e.screen,g(n)]}}():t,3),x),y=new p(x),w=function(){for(var e=y.g(6),t=o,n=0;e<l;)e=(e+n)*s,t*=s,n=y.g(1);for(;e>=u;)e/=2,t/=2,n>>>=1;return(e+n)/t};return w.int32=function(){return 0|y.g(4)},w.quick=function(){return y.g(4)/4294967296},w.double=w,f(g(y.S),n),(d.pass||c||function(e,t,n,r){return r&&(r.S&&h(r,y),e.state=function(){return h(y,{})}),n?(a[i]=e,t):e})(w,b,"global"in d?d.global:this==a,d.state)}function p(e){var t,n=e.length,a=this,r=0,i=a.i=a.j=0,o=a.S=[];for(n||(e=[n++]);r<s;)o[r]=r++;for(r=0;r<s;r++)o[r]=o[i=d&i+e[r%n]+(t=o[r])],o[i]=t;(a.g=function(e){for(var t,n=0,r=a.i,i=a.j,o=a.S;e--;)t=o[r=d&r+1],n=n*s+o[d&(o[r]=o[i=d&i+t])+(o[i]=t)];return a.i=r,a.j=i,n})(s)}function h(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function m(e,t){var n,a=[],r=typeof e;if(t&&"object"==r)for(n in e)try{a.push(m(e[n],t-1))}catch(s){}return a.length?a:"string"==r?e:e+"\0"}function f(e,t){for(var n,a=e+"",r=0;r<a.length;)t[d&r]=d&(n^=19*t[d&r])+a.charCodeAt(r++);return g(t)}function g(e){return String.fromCharCode.apply(0,e)}if(f(a.random(),n),"object"==typeof t&&t.exports){t.exports=c;try{r=Te()}catch(x){}}else"function"==typeof define&&define.amd?define(function(){return c}):a["seed"+i]=c}("undefined"!=typeof self?self:e,[],Math)}),Ae=ge((e,t)=>{var n=ke(),a=Ne(),r=Se(),s=Ie(),i=_e(),o=Ce(),l=Ee();l.alea=n,l.xor128=a,l.xorwow=r,l.xorshift7=s,l.xor4096=i,l.tychei=o,t.exports=l}),$e=ge(()=>{}),Re=ge(()=>{}),Fe=ge(()=>{}),De=ge(()=>{}),Me=ge(()=>{}),Oe=ge(()=>{}),je=ge((e,t)=>{var n,a=(n="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,"undefined"!=typeof __filename&&(n=n||__filename),function(e){function t(){return E.buffer!=R&&B(E.buffer),D}function a(){return E.buffer!=R&&B(E.buffer),M}function r(){return E.buffer!=R&&B(E.buffer),O}function s(){return E.buffer!=R&&B(E.buffer),j}var i,o,l,u=void 0!==(e=e||{})?e:{};u.ready=new Promise(function(e,t){i=e,o=t}),"undefined"!=typeof process&&process.listeners&&(l={uncaughtException:process.listeners("uncaughtException"),unhandledRejection:process.listeners("unhandledRejection")});var d,c,p,h=Object.assign({},u),m=(e,t)=>{throw t},f="object"==typeof window,g="function"==typeof importScripts,x="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node,b=u.ENVIRONMENT_IS_PTHREAD||!1,y="";function w(e){return u.locateFile?u.locateFile(e,y):y+e}if(x){var v=Re(),k=Fe();let e;y=g?k.dirname(y)+"/":__dirname+"/",d=(e,t)=>(e=ne(e)?new URL(e):k.normalize(e),v.readFileSync(e,t?void 0:"utf8")),p=e=>{var t=d(e,!0);return t.buffer||(t=new Uint8Array(t)),t},c=(e,t,n)=>{e=ne(e)?new URL(e):k.normalize(e),v.readFile(e,function(e,a){e?n(e):t(a.buffer)})},process.argv.length>1&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(e){if(!(e instanceof se))throw e}),process.on("unhandledRejection",function(e){throw e}),m=(e,t)=>{if(q())throw process.exitCode=e,t;(function(e){e instanceof se||C("exiting due to exception: "+e)})(t),process.exit(e)},u.inspect=function(){return"[Emscripten Module object]"};try{e=De()}catch(Ze){throw Ze}global.Worker=e.Worker}else(f||g)&&(g?y=self.location.href:"undefined"!=typeof document&&document.currentScript&&(y=document.currentScript.src),void 0!==n&&n&&(y=n),y=0!==y.indexOf("blob:")?y.substr(0,y.replace(/[?#].*/,"").lastIndexOf("/")+1):"",x||(d=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},g&&(p=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),c=(e,t,n)=>{var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.onload=()=>{200==a.status||0==a.status&&a.response?t(a.response):n()},a.onerror=n,a.send(null)}));x&&"undefined"==typeof performance&&(global.performance=Me().performance);var N=function(){}.bind(),S=function(){}.bind();x&&(N=e=>v.writeSync(1,e+"\n"),S=e=>v.writeSync(2,e+"\n"));var I,_=u.print||N,C=u.printErr||S;Object.assign(u,h),h=null,u.arguments&&u.arguments,u.thisProgram&&u.thisProgram,u.quit&&(m=u.quit),u.wasmBinary&&(I=u.wasmBinary);var T=u.noExitRuntime||!0;"object"!=typeof WebAssembly&&ee("no native wasm support detected");var E,A,$,R,F,D,M,O,j,L=!1,z="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function P(e,t,n){for(var a=(t>>>=0)+n,r=t;e[r]&&!(r>=a);)++r;if(r-t>16&&e.buffer&&z)return z.decode(e.buffer instanceof SharedArrayBuffer?e.slice(t,r):e.subarray(t,r));for(var s="";t<r;){var i=e[t++];if(128&i){var o=63&e[t++];if(192!=(224&i)){var l=63&e[t++];if((i=224==(240&i)?(15&i)<<12|o<<6|l:(7&i)<<18|o<<12|l<<6|63&e[t++])<65536)s+=String.fromCharCode(i);else{var u=i-65536;s+=String.fromCharCode(55296|u>>10,56320|1023&u)}}else s+=String.fromCharCode((31&i)<<6|o)}else s+=String.fromCharCode(i)}return s}function B(e){R=e,u.HEAP8=F=new Int8Array(e),u.HEAP16=new Int16Array(e),u.HEAP32=M=new Int32Array(e),u.HEAPU8=D=new Uint8Array(e),u.HEAPU16=new Uint16Array(e),u.HEAPU32=O=new Uint32Array(e),u.HEAPF32=new Float32Array(e),u.HEAPF64=j=new Float64Array(e)}b&&(R=u.buffer);var W=u.INITIAL_MEMORY||16777216;if(b)E=u.wasmMemory,R=u.buffer;else if(u.wasmMemory)E=u.wasmMemory;else if(!((E=new WebAssembly.Memory({initial:W/65536,maximum:65536,shared:!0})).buffer instanceof SharedArrayBuffer))throw C("requested a shared WebAssembly.Memory but the returned buffer is not a SharedArrayBuffer, indicating that while the browser has SharedArrayBuffer it does not have WebAssembly threads support - you may need to set a flag"),x&&C("(on node you may need: --experimental-wasm-threads --experimental-wasm-bulk-memory and/or recent version)"),Error("bad memory");E&&(R=E.buffer),W=R.byteLength,B(R);var V,U=[],G=[],H=[];function q(){return T}function K(){!b&&ce(G)}function X(e){U.unshift(e)}function Y(e){H.unshift(e)}var Z,J=0,Q=null;function ee(e){u.onAbort&&u.onAbort(e),C(e="Aborted("+e+")"),L=!0,$=1,e+=". Build with -sASSERTIONS for more info.";var t=new WebAssembly.RuntimeError(e);throw o(t),t}function te(e){return e.startsWith("data:application/octet-stream;base64,")}function ne(e){return e.startsWith("file://")}function ae(e){try{if(e==Z&&I)return new Uint8Array(I);if(p)return p(e);throw"both async and sync fetching of the wasm failed"}catch(Ze){ee(Ze)}}te(Z="tfjs-backend-wasm-threaded-simd.wasm")||(Z=w(Z));var re={};function se(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function ie(e){var t=de.pthreads[e];(function(e){e||ee(void 0)})(t),de.returnWorkerToPool(t)}function oe(e){var t=de.getNewWorker();if(!t)return 6;de.runningWorkers.push(t),de.pthreads[e.pthread_ptr]=t,t.pthread_ptr=e.pthread_ptr;var n={cmd:"run",start_routine:e.startRoutine,arg:e.arg,pthread_ptr:e.pthread_ptr};return t.runPthread=()=>{x&&t.ref(),t.postMessage(n,e.transferList),delete t.runPthread},t.loaded&&t.runPthread(),0}function le(e){if(b)return ye(1,1,e);$=e,q()||(de.terminateAllThreads(),u.onExit&&u.onExit(e),L=!0),m(e,new se(e))}var ue=function(e,t){if($=e,!t&&b)throw pe(e),"unwind";le(e)},de={unusedWorkers:[],runningWorkers:[],tlsInitFunctions:[],pthreads:{},init:function(){b?de.initWorker():de.initMainThread()},initMainThread:function(){for(var e=8;e--;)de.allocateUnusedWorker()},initWorker:function(){T=!1},setExitStatus:function(e){$=e},terminateAllThreads:function(){for(var e of Object.values(de.pthreads))de.returnWorkerToPool(e);for(var e of de.unusedWorkers)e.terminate();de.unusedWorkers=[]},returnWorkerToPool:function(e){var t=e.pthread_ptr;delete de.pthreads[t],de.unusedWorkers.push(e),de.runningWorkers.splice(de.runningWorkers.indexOf(e),1),e.pthread_ptr=0,x&&e.unref(),Ve(t)},receiveObjectTransfer:function(e){},threadInitTLS:function(){de.tlsInitFunctions.forEach(e=>e())},loadWasmModuleToWorker:function(e,t){e.onmessage=n=>{var a=n.data,r=a.cmd;if(e.pthread_ptr&&(de.currentProxiedOperationCallerThread=e.pthread_ptr),a.targetThread&&a.targetThread!=$e()){var s=de.pthreads[a.targetThread];return s?s.postMessage(a,a.transferList):C('Internal error! Worker sent a message "'+r+'" to target pthread '+a.targetThread+", but that thread no longer exists!"),void(de.currentProxiedOperationCallerThread=void 0)}"processProxyingQueue"===r?xe(a.queue):"spawnThread"===r?oe(a):"cleanupThread"===r?ie(a.thread):"killThread"===r?function(e){var t=de.pthreads[e];delete de.pthreads[e],t.terminate(),Ve(e),de.runningWorkers.splice(de.runningWorkers.indexOf(t),1),t.pthread_ptr=0}(a.thread):"cancelThread"===r?function(e){de.pthreads[e].postMessage({cmd:"cancel"})}(a.thread):"loaded"===r?(e.loaded=!0,x&&e.unref(),t&&t(e),e.runPthread&&e.runPthread()):"print"===r?_("Thread "+a.threadId+": "+a.text):"printErr"===r?C("Thread "+a.threadId+": "+a.text):"alert"===r?alert("Thread "+a.threadId+": "+a.text):"setimmediate"===a.target?e.postMessage(a):"callHandler"===r?u[a.handler](...a.args):r&&C("worker sent an unknown command "+r),de.currentProxiedOperationCallerThread=void 0},e.onerror=e=>{throw C("worker sent an error! "+e.filename+":"+e.lineno+": "+e.message),e},x&&(e.on("message",function(t){e.onmessage({data:t})}),e.on("error",function(t){e.onerror(t)}),e.on("detachedExit",function(){}));var a=[];for(var r of["onExit","onAbort","print","printErr"])u.hasOwnProperty(r)&&a.push(r);e.postMessage({cmd:"load",handlers:a,urlOrBlob:u.mainScriptUrlOrBlob||n,wasmMemory:E,wasmModule:A})},allocateUnusedWorker:function(){var e,t=w("tfjs-backend-wasm-threaded-simd.worker.js");e=new Worker(t),de.unusedWorkers.push(e)},getNewWorker:function(){return 0==de.unusedWorkers.length&&(de.allocateUnusedWorker(),de.loadWasmModuleToWorker(de.unusedWorkers[0])),de.unusedWorkers.pop()}};function ce(e){for(;e.length>0;)e.shift()(u)}function pe(e){if(b)return ye(2,0,e);try{ue(e)}catch(Ze){!function(e){if(e instanceof se||"unwind"==e)return $;m(1,e)}(Ze)}}u.PThread=de,u.establishStackSpace=function(){var e=$e(),t=a()[e+52>>>2],n=a()[e+56>>>2];Ge(t,t-n),qe(t)};var he,me=[];function fe(e,t,n,a){return b?ye(3,1,e,t,n,a):ge(e,t,n,a)}function ge(e,t,n,a){if("undefined"==typeof SharedArrayBuffer)return C("Current environment does not support SharedArrayBuffer, pthreads are not available!"),6;var r=[];if(b&&0===r.length)return fe(e,t,n,a);var s={startRoutine:n,pthread_ptr:e,arg:a,transferList:r};return b?(s.cmd="spawnThread",postMessage(s,r),0):oe(s)}function xe(e){Atomics.store(a(),e>>2,1),$e()&&We(e),Atomics.compareExchange(a(),e>>2,1,0)}function be(e){be.shown||(be.shown={}),be.shown[e]||(be.shown[e]=1,x&&(e="warning: "+e),C(e))}function ye(e,t){var n=arguments.length-2,a=arguments;return function(e){var t=He(),n=e();return qe(t),n}(()=>{for(var r=n,i=Ke(8*r),o=i>>3,l=0;l<n;l++){var u=a[2+l];s()[o+l>>>0]=u}return Le(e,r,i,t)})}u.invokeEntryPoint=function(e,t){var n=function(e){var t=me[e];return t||(e>=me.length&&(me.length=e+1),me[e]=t=V.get(e)),t}(e)(t);q()?de.setExitStatus(n):Ue(n)},u.executeNotifiedProxyingQueue=xe,he=x?()=>{var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:()=>performance.timeOrigin+performance.now();var we=[];function ve(e){try{return E.grow(e-R.byteLength+65535>>>16),B(E.buffer),1}catch(Ze){}}function ke(e){return b?ye(4,1,e):52}function Ne(e,t,n,a,r){return b?ye(5,1,e,t,n,a,r):70}var Se=[null,[],[]];function Ie(e,t){var n=Se[e];0===t||10===t?((1===e?_:C)(P(n,0)),n.length=0):n.push(t)}function _e(e,n,a,s){if(b)return ye(6,1,e,n,a,s);for(var i=0,o=0;o<a;o++){var l=r()[n>>>2],u=r()[n+4>>>2];n+=8;for(var d=0;d<u;d++)Ie(e,t()[l+d>>>0]);i+=u}return r()[s>>>2]=i,0}function Ce(e){return u["_"+e]}function Te(e,n,a,r,s){var i={string:e=>{var n=0;if(null!=e&&0!==e){var a=1+(e.length<<2);!function(e,n,a){!function(e,t,n,a){if(!(a>0))return 0;for(var r=(n>>>=0)+a-1,s=0;s<e.length;++s){var i=e.charCodeAt(s);if(i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++s)),i<=127){if(n>=r)break;t[n++>>>0]=i}else if(i<=2047){if(n+1>=r)break;t[n++>>>0]=192|i>>6,t[n++>>>0]=128|63&i}else if(i<=65535){if(n+2>=r)break;t[n++>>>0]=224|i>>12,t[n++>>>0]=128|i>>6&63,t[n++>>>0]=128|63&i}else{if(n+3>=r)break;t[n++>>>0]=240|i>>18,t[n++>>>0]=128|i>>12&63,t[n++>>>0]=128|i>>6&63,t[n++>>>0]=128|63&i}}t[n>>>0]=0}(e,t(),n,a)}(e,n=Ke(a),a)}return n},array:e=>{var t=Ke(e.length);return function(e,t){(E.buffer!=R&&B(E.buffer),F).set(e,t>>>0)}(e,t),t}};var o=Ce(e),l=[],u=0;if(r)for(var d=0;d<r.length;d++){var c=i[a[d]];c?(0===u&&(u=He()),l[d]=c(r[d])):l[d]=r[d]}var p,h=o.apply(null,l);return p=h,0!==u&&qe(u),function(e){return"string"===n?function(e){return(e>>>=0)?P(t(),e,void 0):""}(e):"boolean"===n?!!e:e}(p)}de.init();var Ee=[null,le,pe,fe,ke,Ne,_e],Ae={__emscripten_init_main_thread_js:function(e){je(e,!g,1,!f),de.threadInitTLS()},__emscripten_thread_cleanup:function(e){b?postMessage({cmd:"cleanupThread",thread:e}):ie(e)},__pthread_create_js:ge,_emscripten_default_pthread_stack_size:function(){return 65536},_emscripten_get_now_is_monotonic:function(){return!0},_emscripten_notify_task_queue:function(e,t,n,a){if(e==t)setTimeout(()=>xe(a));else if(b)postMessage({targetThread:e,cmd:"processProxyingQueue",queue:a});else{var r=de.pthreads[e];if(!r)return;r.postMessage({cmd:"processProxyingQueue",queue:a})}return 1},_emscripten_set_offscreencanvas_size:function(e,t,n){return-1},abort:function(){ee("")},emscripten_check_blocking_allowed:function(){x||g||be("Blocking on the main thread is very dangerous, see https://emscripten.org/docs/porting/pthreads.html#blocking-on-the-main-browser-thread")},emscripten_date_now:function(){return Date.now()},emscripten_get_heap_max:function(){return 4294901760},emscripten_get_now:he,emscripten_memcpy_big:function(e,n,a){t().copyWithin(e>>>0,n>>>0,n+a>>>0)},emscripten_num_logical_cores:function(){return x?Oe().cpus().length:navigator.hardwareConcurrency},emscripten_receive_on_main_thread_js:function(e,t,n){we.length=t;for(var a=n>>3,r=0;r<t;r++)we[r]=s()[a+r>>>0];return(e<0?re[-e-1]:Ee[e]).apply(null,we)},emscripten_resize_heap:function(e){var n=t().length;if((e>>>=0)<=n)return!1;var a=4294901760;if(e>a)return!1;let r=(e,t)=>e+(t-e%t)%t;for(var s=1;s<=4;s*=2){var i=n*(1+.2/s);if(i=Math.min(i,e+100663296),ve(Math.min(a,r(Math.max(e,i),65536))))return!0}return!1},emscripten_unwind_to_js_event_loop:function(){throw"unwind"},exit:ue,fd_close:ke,fd_seek:Ne,fd_write:_e,memory:E||u.wasmMemory};!function(){var e={env:Ae,wasi_snapshot_preview1:Ae};function t(e,t){var n=e.exports;if(u.asm=n,function(e){de.tlsInitFunctions.push(e)}(u.asm._emscripten_tls_init),V=u.asm.__indirect_function_table,function(e){G.unshift(e)}(u.asm.__wasm_call_ctors),A=t,!b){var a=de.unusedWorkers.length;de.unusedWorkers.forEach(function(e){de.loadWasmModuleToWorker(e,function(){--a||function(){if(J--,u.monitorRunDependencies&&u.monitorRunDependencies(J),0==J&&Q){var e=Q;Q=null,e()}}()})})}}function n(e){t(e.instance,e.module)}function a(t){return function(){if(!I&&(f||g)){if("function"==typeof fetch&&!ne(Z))return fetch(Z,{credentials:"same-origin"}).then(function(e){if(!e.ok)throw"failed to load wasm binary file at '"+Z+"'";return e.arrayBuffer()}).catch(function(){return ae(Z)});if(c)return new Promise(function(e,t){c(Z,function(t){e(new Uint8Array(t))},t)})}return Promise.resolve().then(function(){return ae(Z)})}().then(function(t){return WebAssembly.instantiate(t,e)}).then(function(e){return e}).then(t,function(e){C("failed to asynchronously prepare wasm: "+e),ee(e)})}if(b||(J++,u.monitorRunDependencies&&u.monitorRunDependencies(J)),u.instantiateWasm)try{return u.instantiateWasm(e,t)}catch(r){C("Module.instantiateWasm callback failed with error: "+r),o(r)}(I||"function"!=typeof WebAssembly.instantiateStreaming||te(Z)||ne(Z)||x||"function"!=typeof fetch?a(n):fetch(Z,{credentials:"same-origin"}).then(function(t){return WebAssembly.instantiateStreaming(t,e).then(n,function(e){return C("wasm streaming compile failed: "+e),C("falling back to ArrayBuffer instantiation"),a(n)})})).catch(o)}(),u.___wasm_call_ctors=function(){return(u.___wasm_call_ctors=u.asm.__wasm_call_ctors).apply(null,arguments)},u._init=function(){return(u._init=u.asm.init).apply(null,arguments)},u._init_with_threads_count=function(){return(u._init_with_threads_count=u.asm.init_with_threads_count).apply(null,arguments)},u._get_threads_count=function(){return(u._get_threads_count=u.asm.get_threads_count).apply(null,arguments)},u._register_tensor=function(){return(u._register_tensor=u.asm.register_tensor).apply(null,arguments)},u._dispose_data=function(){return(u._dispose_data=u.asm.dispose_data).apply(null,arguments)},u._dispose=function(){return(u._dispose=u.asm.dispose).apply(null,arguments)},u._Abs=function(){return(u._Abs=u.asm.Abs).apply(null,arguments)},u._Acos=function(){return(u._Acos=u.asm.Acos).apply(null,arguments)},u._Acosh=function(){return(u._Acosh=u.asm.Acosh).apply(null,arguments)},u._Add=function(){return(u._Add=u.asm.Add).apply(null,arguments)},u._AddN=function(){return(u._AddN=u.asm.AddN).apply(null,arguments)},u._All=function(){return(u._All=u.asm.All).apply(null,arguments)},u._Any=function(){return(u._Any=u.asm.Any).apply(null,arguments)},u._ArgMax=function(){return(u._ArgMax=u.asm.ArgMax).apply(null,arguments)},u._ArgMin=function(){return(u._ArgMin=u.asm.ArgMin).apply(null,arguments)},u._Asin=function(){return(u._Asin=u.asm.Asin).apply(null,arguments)},u._Asinh=function(){return(u._Asinh=u.asm.Asinh).apply(null,arguments)},u._Atan=function(){return(u._Atan=u.asm.Atan).apply(null,arguments)},u._Atan2=function(){return(u._Atan2=u.asm.Atan2).apply(null,arguments)},u._Atanh=function(){return(u._Atanh=u.asm.Atanh).apply(null,arguments)},u._AvgPool=function(){return(u._AvgPool=u.asm.AvgPool).apply(null,arguments)},u._AvgPool3D=function(){return(u._AvgPool3D=u.asm.AvgPool3D).apply(null,arguments)},u._AvgPool3DGrad=function(){return(u._AvgPool3DGrad=u.asm.AvgPool3DGrad).apply(null,arguments)},u._AvgPoolGrad=function(){return(u._AvgPoolGrad=u.asm.AvgPoolGrad).apply(null,arguments)},u._BatchMatMul=function(){return(u._BatchMatMul=u.asm.BatchMatMul).apply(null,arguments)},u._Bincount=function(){return(u._Bincount=u.asm.Bincount).apply(null,arguments)},u._BitwiseAnd=function(){return(u._BitwiseAnd=u.asm.BitwiseAnd).apply(null,arguments)},u._Ceil=function(){return(u._Ceil=u.asm.Ceil).apply(null,arguments)},u._ClipByValue=function(){return(u._ClipByValue=u.asm.ClipByValue).apply(null,arguments)},u._Conv2D=function(){return(u._Conv2D=u.asm.Conv2D).apply(null,arguments)},u._Conv2DBackpropInput=function(){return(u._Conv2DBackpropInput=u.asm.Conv2DBackpropInput).apply(null,arguments)},u._Conv3D=function(){return(u._Conv3D=u.asm.Conv3D).apply(null,arguments)},u._Conv3DBackpropFilterV2=function(){return(u._Conv3DBackpropFilterV2=u.asm.Conv3DBackpropFilterV2).apply(null,arguments)},u._Conv3DBackpropInputV2=function(){return(u._Conv3DBackpropInputV2=u.asm.Conv3DBackpropInputV2).apply(null,arguments)},u._Cos=function(){return(u._Cos=u.asm.Cos).apply(null,arguments)},u._Cosh=function(){return(u._Cosh=u.asm.Cosh).apply(null,arguments)},u._CropAndResize=function(){return(u._CropAndResize=u.asm.CropAndResize).apply(null,arguments)},u._Cumprod=function(){return(u._Cumprod=u.asm.Cumprod).apply(null,arguments)},u._Cumsum=function(){return(u._Cumsum=u.asm.Cumsum).apply(null,arguments)},u._DenseBincount=function(){return(u._DenseBincount=u.asm.DenseBincount).apply(null,arguments)},u._DepthToSpace=function(){return(u._DepthToSpace=u.asm.DepthToSpace).apply(null,arguments)},u._DepthwiseConv2dNative=function(){return(u._DepthwiseConv2dNative=u.asm.DepthwiseConv2dNative).apply(null,arguments)},u._Diag=function(){return(u._Diag=u.asm.Diag).apply(null,arguments)},u._Dilation2D=function(){return(u._Dilation2D=u.asm.Dilation2D).apply(null,arguments)},u._Dilation2DBackpropFilter=function(){return(u._Dilation2DBackpropFilter=u.asm.Dilation2DBackpropFilter).apply(null,arguments)},u._Dilation2DBackpropInput=function(){return(u._Dilation2DBackpropInput=u.asm.Dilation2DBackpropInput).apply(null,arguments)},u._Elu=function(){return(u._Elu=u.asm.Elu).apply(null,arguments)},u._EluGrad=function(){return(u._EluGrad=u.asm.EluGrad).apply(null,arguments)},u._Equal=function(){return(u._Equal=u.asm.Equal).apply(null,arguments)},u._Erf=function(){return(u._Erf=u.asm.Erf).apply(null,arguments)},u._Exp=function(){return(u._Exp=u.asm.Exp).apply(null,arguments)},u._Expm1=function(){return(u._Expm1=u.asm.Expm1).apply(null,arguments)},u._FlipLeftRight=function(){return(u._FlipLeftRight=u.asm.FlipLeftRight).apply(null,arguments)},u._Floor=function(){return(u._Floor=u.asm.Floor).apply(null,arguments)},u._FloorDiv=function(){return(u._FloorDiv=u.asm.FloorDiv).apply(null,arguments)},u._FusedBatchNorm=function(){return(u._FusedBatchNorm=u.asm.FusedBatchNorm).apply(null,arguments)},u._FusedConv2D=function(){return(u._FusedConv2D=u.asm.FusedConv2D).apply(null,arguments)},u._FusedDepthwiseConv2D=function(){return(u._FusedDepthwiseConv2D=u.asm.FusedDepthwiseConv2D).apply(null,arguments)},u._Gather=function(){return(u._Gather=u.asm.Gather).apply(null,arguments)},u._GatherNd=function(){return(u._GatherNd=u.asm.GatherNd).apply(null,arguments)},u._Greater=function(){return(u._Greater=u.asm.Greater).apply(null,arguments)},u._GreaterEqual=function(){return(u._GreaterEqual=u.asm.GreaterEqual).apply(null,arguments)},u._IsFinite=function(){return(u._IsFinite=u.asm.IsFinite).apply(null,arguments)},u._IsInf=function(){return(u._IsInf=u.asm.IsInf).apply(null,arguments)},u._IsNan=function(){return(u._IsNan=u.asm.IsNan).apply(null,arguments)},u._LRN=function(){return(u._LRN=u.asm.LRN).apply(null,arguments)},u._LRNGrad=function(){return(u._LRNGrad=u.asm.LRNGrad).apply(null,arguments)},u._LeakyRelu=function(){return(u._LeakyRelu=u.asm.LeakyRelu).apply(null,arguments)},u._Less=function(){return(u._Less=u.asm.Less).apply(null,arguments)},u._LessEqual=function(){return(u._LessEqual=u.asm.LessEqual).apply(null,arguments)},u._LinSpace=function(){return(u._LinSpace=u.asm.LinSpace).apply(null,arguments)},u._Log=function(){return(u._Log=u.asm.Log).apply(null,arguments)},u._Log1p=function(){return(u._Log1p=u.asm.Log1p).apply(null,arguments)},u._LogicalAnd=function(){return(u._LogicalAnd=u.asm.LogicalAnd).apply(null,arguments)},u._LogicalNot=function(){return(u._LogicalNot=u.asm.LogicalNot).apply(null,arguments)},u._LogicalOr=function(){return(u._LogicalOr=u.asm.LogicalOr).apply(null,arguments)},u._LogicalXor=function(){return(u._LogicalXor=u.asm.LogicalXor).apply(null,arguments)},u._Max=function(){return(u._Max=u.asm.Max).apply(null,arguments)},u._MaxPool=function(){return(u._MaxPool=u.asm.MaxPool).apply(null,arguments)},u._MaxPool3D=function(){return(u._MaxPool3D=u.asm.MaxPool3D).apply(null,arguments)},u._MaxPool3DGrad=function(){return(u._MaxPool3DGrad=u.asm.MaxPool3DGrad).apply(null,arguments)},u._MaxPoolGrad=function(){return(u._MaxPoolGrad=u.asm.MaxPoolGrad).apply(null,arguments)},u._MaxPoolWithArgmax=function(){return(u._MaxPoolWithArgmax=u.asm.MaxPoolWithArgmax).apply(null,arguments)},u._Maximum=function(){return(u._Maximum=u.asm.Maximum).apply(null,arguments)},u._Mean=function(){return(u._Mean=u.asm.Mean).apply(null,arguments)},u._Min=function(){return(u._Min=u.asm.Min).apply(null,arguments)},u._Minimum=function(){return(u._Minimum=u.asm.Minimum).apply(null,arguments)},u._MirrorPad=function(){return(u._MirrorPad=u.asm.MirrorPad).apply(null,arguments)},u._Mod=function(){return(u._Mod=u.asm.Mod).apply(null,arguments)},u._Multinomial=function(){return(u._Multinomial=u.asm.Multinomial).apply(null,arguments)},u._Multiply=function(){return(u._Multiply=u.asm.Multiply).apply(null,arguments)},u._Neg=function(){return(u._Neg=u.asm.Neg).apply(null,arguments)},u._NonMaxSuppressionV3=function(){return(u._NonMaxSuppressionV3=u.asm.NonMaxSuppressionV3).apply(null,arguments)},u._NonMaxSuppressionV4=function(){return(u._NonMaxSuppressionV4=u.asm.NonMaxSuppressionV4).apply(null,arguments)},u._NonMaxSuppressionV5=function(){return(u._NonMaxSuppressionV5=u.asm.NonMaxSuppressionV5).apply(null,arguments)},u._NotEqual=function(){return(u._NotEqual=u.asm.NotEqual).apply(null,arguments)},u._OneHot=function(){return(u._OneHot=u.asm.OneHot).apply(null,arguments)},u._PadV2=function(){return(u._PadV2=u.asm.PadV2).apply(null,arguments)},u._Pow=function(){return(u._Pow=u.asm.Pow).apply(null,arguments)},u._Prelu=function(){return(u._Prelu=u.asm.Prelu).apply(null,arguments)},u._Prod=function(){return(u._Prod=u.asm.Prod).apply(null,arguments)},u._RealDiv=function(){return(u._RealDiv=u.asm.RealDiv).apply(null,arguments)},u._Reciprocal=function(){return(u._Reciprocal=u.asm.Reciprocal).apply(null,arguments)},u._Relu=function(){return(u._Relu=u.asm.Relu).apply(null,arguments)},u._Relu6=function(){return(u._Relu6=u.asm.Relu6).apply(null,arguments)},u._ResizeBilinear=function(){return(u._ResizeBilinear=u.asm.ResizeBilinear).apply(null,arguments)},u._ResizeBilinearGrad=function(){return(u._ResizeBilinearGrad=u.asm.ResizeBilinearGrad).apply(null,arguments)},u._ResizeNearestNeighbor=function(){return(u._ResizeNearestNeighbor=u.asm.ResizeNearestNeighbor).apply(null,arguments)},u._ResizeNearestNeighborGrad=function(){return(u._ResizeNearestNeighborGrad=u.asm.ResizeNearestNeighborGrad).apply(null,arguments)},u._Reverse=function(){return(u._Reverse=u.asm.Reverse).apply(null,arguments)},u._RotateWithOffset=function(){return(u._RotateWithOffset=u.asm.RotateWithOffset).apply(null,arguments)},u._Round=function(){return(u._Round=u.asm.Round).apply(null,arguments)},u._Rsqrt=function(){return(u._Rsqrt=u.asm.Rsqrt).apply(null,arguments)},u._ScatterNd=function(){return(u._ScatterNd=u.asm.ScatterNd).apply(null,arguments)},u._SearchSorted=function(){return(u._SearchSorted=u.asm.SearchSorted).apply(null,arguments)},u._SelectV2=function(){return(u._SelectV2=u.asm.SelectV2).apply(null,arguments)},u._Selu=function(){return(u._Selu=u.asm.Selu).apply(null,arguments)},u._Sigmoid=function(){return(u._Sigmoid=u.asm.Sigmoid).apply(null,arguments)},u._Sign=function(){return(u._Sign=u.asm.Sign).apply(null,arguments)},u._Sin=function(){return(u._Sin=u.asm.Sin).apply(null,arguments)},u._Sinh=function(){return(u._Sinh=u.asm.Sinh).apply(null,arguments)},u._Softmax=function(){return(u._Softmax=u.asm.Softmax).apply(null,arguments)},u._Softplus=function(){return(u._Softplus=u.asm.Softplus).apply(null,arguments)},u._SparseFillEmptyRows=function(){return(u._SparseFillEmptyRows=u.asm.SparseFillEmptyRows).apply(null,arguments)},u._SparseReshape=function(){return(u._SparseReshape=u.asm.SparseReshape).apply(null,arguments)},u._SparseSegmentReduction=function(){return(u._SparseSegmentReduction=u.asm.SparseSegmentReduction).apply(null,arguments)},u._SparseToDense=function(){return(u._SparseToDense=u.asm.SparseToDense).apply(null,arguments)},u._Sqrt=function(){return(u._Sqrt=u.asm.Sqrt).apply(null,arguments)},u._Square=function(){return(u._Square=u.asm.Square).apply(null,arguments)},u._SquaredDifference=function(){return(u._SquaredDifference=u.asm.SquaredDifference).apply(null,arguments)},u._Step=function(){return(u._Step=u.asm.Step).apply(null,arguments)},u._StridedSlice=function(){return(u._StridedSlice=u.asm.StridedSlice).apply(null,arguments)},u._Sub=function(){return(u._Sub=u.asm.Sub).apply(null,arguments)},u._Sum=function(){return(u._Sum=u.asm.Sum).apply(null,arguments)},u._Tan=function(){return(u._Tan=u.asm.Tan).apply(null,arguments)},u._Tanh=function(){return(u._Tanh=u.asm.Tanh).apply(null,arguments)},u._TensorScatterUpdate=function(){return(u._TensorScatterUpdate=u.asm.TensorScatterUpdate).apply(null,arguments)},u._Tile=function(){return(u._Tile=u.asm.Tile).apply(null,arguments)},u._TopK=function(){return(u._TopK=u.asm.TopK).apply(null,arguments)},u._Transform=function(){return(u._Transform=u.asm.Transform).apply(null,arguments)},u._Transpose=function(){return(u._Transpose=u.asm.Transpose).apply(null,arguments)},u.__FusedMatMul=function(){return(u.__FusedMatMul=u.asm._FusedMatMul).apply(null,arguments)},u._malloc=function(){return(u._malloc=u.asm.malloc).apply(null,arguments)},u._free=function(){return(u._free=u.asm.free).apply(null,arguments)},u.__emscripten_tls_init=function(){return(u.__emscripten_tls_init=u.asm._emscripten_tls_init).apply(null,arguments)};var $e=u._pthread_self=function(){return($e=u._pthread_self=u.asm.pthread_self).apply(null,arguments)};u.___errno_location=function(){return(u.___errno_location=u.asm.__errno_location).apply(null,arguments)};var je=u.__emscripten_thread_init=function(){return(je=u.__emscripten_thread_init=u.asm._emscripten_thread_init).apply(null,arguments)};u.__emscripten_thread_crashed=function(){return(u.__emscripten_thread_crashed=u.asm._emscripten_thread_crashed).apply(null,arguments)},u._emscripten_main_thread_process_queued_calls=function(){return(u._emscripten_main_thread_process_queued_calls=u.asm.emscripten_main_thread_process_queued_calls).apply(null,arguments)},u._emscripten_main_browser_thread_id=function(){return(u._emscripten_main_browser_thread_id=u.asm.emscripten_main_browser_thread_id).apply(null,arguments)};var Le=u._emscripten_run_in_main_runtime_thread_js=function(){return(Le=u._emscripten_run_in_main_runtime_thread_js=u.asm.emscripten_run_in_main_runtime_thread_js).apply(null,arguments)};u._emscripten_dispatch_to_thread_=function(){return(u._emscripten_dispatch_to_thread_=u.asm.emscripten_dispatch_to_thread_).apply(null,arguments)};var ze,Pe,Be,We=u.__emscripten_proxy_execute_task_queue=function(){return(We=u.__emscripten_proxy_execute_task_queue=u.asm._emscripten_proxy_execute_task_queue).apply(null,arguments)},Ve=u.__emscripten_thread_free_data=function(){return(Ve=u.__emscripten_thread_free_data=u.asm._emscripten_thread_free_data).apply(null,arguments)},Ue=u.__emscripten_thread_exit=function(){return(Ue=u.__emscripten_thread_exit=u.asm._emscripten_thread_exit).apply(null,arguments)},Ge=u._emscripten_stack_set_limits=function(){return(Ge=u._emscripten_stack_set_limits=u.asm.emscripten_stack_set_limits).apply(null,arguments)},He=u.stackSave=function(){return(He=u.stackSave=u.asm.stackSave).apply(null,arguments)},qe=u.stackRestore=function(){return(qe=u.stackRestore=u.asm.stackRestore).apply(null,arguments)},Ke=u.stackAlloc=function(){return(Ke=u.stackAlloc=u.asm.stackAlloc).apply(null,arguments)};function Xe(e){if(!(J>0)){if(b)return i(u),K(),void startWorker(u);(function(){if(u.preRun)for("function"==typeof u.preRun&&(u.preRun=[u.preRun]);u.preRun.length;)X(u.preRun.shift());ce(U)})(),J>0||(u.setStatus?(u.setStatus("Running..."),setTimeout(function(){setTimeout(function(){u.setStatus("")},1),t()},1)):t())}function t(){ze||(ze=!0,u.calledRun=!0,!L&&(K(),i(u),u.onRuntimeInitialized&&u.onRuntimeInitialized(),function(){if(!b){if(u.postRun)for("function"==typeof u.postRun&&(u.postRun=[u.postRun]);u.postRun.length;)Y(u.postRun.shift());ce(H)}}()))}}if(u.dynCall_iijjiiii=function(){return(u.dynCall_iijjiiii=u.asm.dynCall_iijjiiii).apply(null,arguments)},u.dynCall_jiji=function(){return(u.dynCall_jiji=u.asm.dynCall_jiji).apply(null,arguments)},u.keepRuntimeAlive=q,u.wasmMemory=E,u.cwrap=function(e,t,n,a){var r=(n=n||[]).every(e=>"number"===e||"boolean"===e);return"string"!==t&&r&&!a?Ce(e):function(){return Te(e,t,n,arguments)}},u.ExitStatus=se,u.PThread=de,Q=function e(){ze||Xe(),ze||(Q=e)},u.preInit)for("function"==typeof u.preInit&&(u.preInit=[u.preInit]);u.preInit.length>0;)u.preInit.pop()();if(Xe(),l&&(Pe={uncaughtException:process.listeners("uncaughtException").filter(function(e){return!l.uncaughtException.indexOf(e)>-1}),unhandledRejection:process.listeners("unhandledRejection").filter(function(e){return!l.unhandledRejection.indexOf(e)>-1})}),"undefined"!=typeof WasmBackendModule)Be=WasmBackendModule;else{if(void 0===e)throw new Error("Could not find wasm module in post.js");Be=e}if(Pe){var Ye=Be._dispose;Be._dispose=function(){Ye(),Pe.uncaughtException.forEach(function(e){process.removeListener("uncaughtException",e)}),Pe.unhandledRejection.forEach(function(e){process.removeListener("unhandledRejection",e)})}}return e.ready});"object"==typeof e&&"object"==typeof t?t.exports=a:"function"==typeof define&&define.amd?define([],function(){return a}):"object"==typeof e&&(e.WasmBackendModuleThreadedSimd=a)}),Le=ge((e,t)=>{t.exports.wasmWorkerContents='"use strict";var Module={};var ENVIRONMENT_IS_NODE=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string";if(ENVIRONMENT_IS_NODE){var nodeWorkerThreads=require("worker_threads");var parentPort=nodeWorkerThreads.parentPort;parentPort.on("message",data=>onmessage({data:data}));var fs=require("fs");Object.assign(global,{self:global,require:require,Module:Module,location:{href:__filename},Worker:nodeWorkerThreads.Worker,importScripts:function(f){(0,eval)(fs.readFileSync(f,"utf8")+"//# sourceURL="+f)},postMessage:function(msg){parentPort.postMessage(msg)},performance:global.performance||{now:function(){return Date.now()}}})}var initializedJS=false;var pendingNotifiedProxyingQueues=[];function threadPrintErr(){var text=Array.prototype.slice.call(arguments).join(" ");if(ENVIRONMENT_IS_NODE){fs.writeSync(2,text+"\n");return}console.error(text)}function threadAlert(){var text=Array.prototype.slice.call(arguments).join(" ");postMessage({cmd:"alert",text:text,threadId:Module["_pthread_self"]()})}var err=threadPrintErr;self.alert=threadAlert;Module["instantiateWasm"]=(info,receiveInstance)=>{var instance=new WebAssembly.Instance(Module["wasmModule"],info);receiveInstance(instance);Module["wasmModule"]=null;return instance.exports};self.onunhandledrejection=e=>{throw e.reason??e};self.startWorker=instance=>{Module=instance;postMessage({"cmd":"loaded"})};self.onmessage=e=>{try{if(e.data.cmd==="load"){Module["wasmModule"]=e.data.wasmModule;for(const handler of e.data.handlers){Module[handler]=function(){postMessage({cmd:"callHandler",handler:handler,args:[...arguments]})}}Module["wasmMemory"]=e.data.wasmMemory;Module["buffer"]=Module["wasmMemory"].buffer;Module["ENVIRONMENT_IS_PTHREAD"]=true;if(typeof e.data.urlOrBlob=="string"){importScripts(e.data.urlOrBlob)}else{var objectUrl=URL.createObjectURL(e.data.urlOrBlob);importScripts(objectUrl);URL.revokeObjectURL(objectUrl)}WasmBackendModuleThreadedSimd(Module)}else if(e.data.cmd==="run"){Module["__emscripten_thread_init"](e.data.pthread_ptr,0,0,1);Module["establishStackSpace"]();Module["PThread"].receiveObjectTransfer(e.data);Module["PThread"].threadInitTLS();if(!initializedJS){pendingNotifiedProxyingQueues.forEach(queue=>{Module["executeNotifiedProxyingQueue"](queue)});pendingNotifiedProxyingQueues=[];initializedJS=true}try{Module["invokeEntryPoint"](e.data.start_routine,e.data.arg)}catch(ex){if(ex!="unwind"){if(ex instanceof Module["ExitStatus"]){if(Module["keepRuntimeAlive"]()){}else{Module["__emscripten_thread_exit"](ex.status)}}else{throw ex}}}}else if(e.data.cmd==="cancel"){if(Module["_pthread_self"]()){Module["__emscripten_thread_exit"](-1)}}else if(e.data.target==="setimmediate"){}else if(e.data.cmd==="processProxyingQueue"){if(initializedJS){Module["executeNotifiedProxyingQueue"](e.data.queue)}else{pendingNotifiedProxyingQueues.push(e.data.queue)}}else if(e.data.cmd){err("worker.js received unknown command "+e.data.cmd);err(e.data)}}catch(ex){if(Module["__emscripten_thread_crashed"]){Module["__emscripten_thread_crashed"]()}throw ex}};'}),ze=ge((e,t)=>{var n,a=(n="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,"undefined"!=typeof __filename&&(n=n||__filename),function(e){var t,a,r,s=void 0!==(e=e||{})?e:{};s.ready=new Promise(function(e,n){t=e,a=n}),"undefined"!=typeof process&&process.listeners&&(r={uncaughtException:process.listeners("uncaughtException"),unhandledRejection:process.listeners("unhandledRejection")});var i,o,l,u=Object.assign({},s),d="object"==typeof window,c="function"==typeof importScripts,p="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node,h="";if(p){var m=Re(),f=Fe();h=c?f.dirname(h)+"/":__dirname+"/",i=(e,t)=>(e=z(e)?new URL(e):f.normalize(e),m.readFileSync(e,t?void 0:"utf8")),l=e=>{var t=i(e,!0);return t.buffer||(t=new Uint8Array(t)),t},o=(e,t,n)=>{e=z(e)?new URL(e):f.normalize(e),m.readFile(e,function(e,a){e?n(e):t(a.buffer)})},process.argv.length>1&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),process.on("uncaughtException",function(e){if(!(e instanceof B))throw e}),process.on("unhandledRejection",function(e){throw e}),s.inspect=function(){return"[Emscripten Module object]"}}else(d||c)&&(c?h=self.location.href:"undefined"!=typeof document&&document.currentScript&&(h=document.currentScript.src),n&&(h=n),h=0!==h.indexOf("blob:")?h.substr(0,h.replace(/[?#].*/,"").lastIndexOf("/")+1):"",i=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},c&&(l=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),o=(e,t,n)=>{var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.onload=()=>{200==a.status||0==a.status&&a.response?t(a.response):n()},a.onerror=n,a.send(null)});var g,x=s.print||function(){}.bind(),b=s.printErr||function(){}.bind();Object.assign(s,u),u=null,s.arguments&&s.arguments,s.thisProgram&&s.thisProgram,s.quit&&s.quit,s.wasmBinary&&(g=s.wasmBinary),s.noExitRuntime,"object"!=typeof WebAssembly&&j("no native wasm support detected");var y,w,v,k,N,S=!1,I="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function _(e,t,n){for(var a=(t>>>=0)+n,r=t;e[r]&&!(r>=a);)++r;if(r-t>16&&e.buffer&&I)return I.decode(e.subarray(t,r));for(var s="";t<r;){var i=e[t++];if(128&i){var o=63&e[t++];if(192!=(224&i)){var l=63&e[t++];if((i=224==(240&i)?(15&i)<<12|o<<6|l:(7&i)<<18|o<<12|l<<6|63&e[t++])<65536)s+=String.fromCharCode(i);else{var u=i-65536;s+=String.fromCharCode(55296|u>>10,56320|1023&u)}}else s+=String.fromCharCode((31&i)<<6|o)}else s+=String.fromCharCode(i)}return s}function C(e){w=e,s.HEAP8=v=new Int8Array(e),s.HEAP16=new Int16Array(e),s.HEAP32=new Int32Array(e),s.HEAPU8=k=new Uint8Array(e),s.HEAPU16=new Uint16Array(e),s.HEAPU32=N=new Uint32Array(e),s.HEAPF32=new Float32Array(e),s.HEAPF64=new Float64Array(e)}s.INITIAL_MEMORY;var T=[],E=[],A=[];function $(e){T.unshift(e)}function R(e){A.unshift(e)}var F,D,M=0,O=null;function j(e){s.onAbort&&s.onAbort(e),b(e="Aborted("+e+")"),S=!0,e+=". Build with -sASSERTIONS for more info.";var t=new WebAssembly.RuntimeError(e);throw a(t),t}function L(e){return e.startsWith("data:application/octet-stream;base64,")}function z(e){return e.startsWith("file://")}function P(e){try{if(e==F&&g)return new Uint8Array(g);if(l)return l(e);throw"both async and sync fetching of the wasm failed"}catch(t){j(t)}}function B(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function W(e){for(;e.length>0;)e.shift()(s)}function V(e){try{return y.grow(e-w.byteLength+65535>>>16),C(y.buffer),1}catch(t){}}L(F="tfjs-backend-wasm.wasm")||(D=F,F=s.locateFile?s.locateFile(D,h):h+D);var U=[null,[],[]];function G(e,t){var n=U[e];0===t||10===t?((1===e?x:b)(_(n,0)),n.length=0):n.push(t)}function H(e){return s["_"+e]}var q={abort:function(){j("")},emscripten_get_heap_max:function(){return 4294901760},emscripten_memcpy_big:function(e,t,n){k.copyWithin(e>>>0,t>>>0,t+n>>>0)},emscripten_resize_heap:function(e){var t=k.length,n=4294901760;if((e>>>=0)>n)return!1;let a=(e,t)=>e+(t-e%t)%t;for(var r=1;r<=4;r*=2){var s=t*(1+.2/r);if(s=Math.min(s,e+100663296),V(Math.min(n,a(Math.max(e,s),65536))))return!0}return!1},fd_close:function(e){return 52},fd_seek:function(e,t,n,a,r){return 70},fd_write:function(e,t,n,a){for(var r=0,s=0;s<n;s++){var i=N[t>>>2],o=N[t+4>>>2];t+=8;for(var l=0;l<o;l++)G(e,k[i+l>>>0]);r+=o}return N[a>>>2]=r,0}};!function(){var e={env:q,wasi_snapshot_preview1:q};function t(e,t){var n=e.exports;s.asm=n,C((y=s.asm.memory).buffer),s.asm.__indirect_function_table,function(e){E.unshift(e)}(s.asm.__wasm_call_ctors),function(){if(M--,s.monitorRunDependencies&&s.monitorRunDependencies(M),0==M&&O){var e=O;O=null,e()}}()}function n(e){t(e.instance)}function r(t){return function(){if(!g&&(d||c)){if("function"==typeof fetch&&!z(F))return fetch(F,{credentials:"same-origin"}).then(function(e){if(!e.ok)throw"failed to load wasm binary file at '"+F+"'";return e.arrayBuffer()}).catch(function(){return P(F)});if(o)return new Promise(function(e,t){o(F,function(t){e(new Uint8Array(t))},t)})}return Promise.resolve().then(function(){return P(F)})}().then(function(t){return WebAssembly.instantiate(t,e)}).then(function(e){return e}).then(t,function(e){b("failed to asynchronously prepare wasm: "+e),j(e)})}if(M++,s.monitorRunDependencies&&s.monitorRunDependencies(M),s.instantiateWasm)try{return s.instantiateWasm(e,t)}catch(i){b("Module.instantiateWasm callback failed with error: "+i),a(i)}(g||"function"!=typeof WebAssembly.instantiateStreaming||L(F)||z(F)||p||"function"!=typeof fetch?r(n):fetch(F,{credentials:"same-origin"}).then(function(t){return WebAssembly.instantiateStreaming(t,e).then(n,function(e){return b("wasm streaming compile failed: "+e),b("falling back to ArrayBuffer instantiation"),r(n)})})).catch(a)}(),s.___wasm_call_ctors=function(){return(s.___wasm_call_ctors=s.asm.__wasm_call_ctors).apply(null,arguments)},s._init=function(){return(s._init=s.asm.init).apply(null,arguments)},s._init_with_threads_count=function(){return(s._init_with_threads_count=s.asm.init_with_threads_count).apply(null,arguments)},s._get_threads_count=function(){return(s._get_threads_count=s.asm.get_threads_count).apply(null,arguments)},s._register_tensor=function(){return(s._register_tensor=s.asm.register_tensor).apply(null,arguments)},s._dispose_data=function(){return(s._dispose_data=s.asm.dispose_data).apply(null,arguments)},s._dispose=function(){return(s._dispose=s.asm.dispose).apply(null,arguments)},s._Abs=function(){return(s._Abs=s.asm.Abs).apply(null,arguments)},s._Acos=function(){return(s._Acos=s.asm.Acos).apply(null,arguments)},s._Acosh=function(){return(s._Acosh=s.asm.Acosh).apply(null,arguments)},s._Add=function(){return(s._Add=s.asm.Add).apply(null,arguments)},s._AddN=function(){return(s._AddN=s.asm.AddN).apply(null,arguments)},s._All=function(){return(s._All=s.asm.All).apply(null,arguments)},s._Any=function(){return(s._Any=s.asm.Any).apply(null,arguments)},s._ArgMax=function(){return(s._ArgMax=s.asm.ArgMax).apply(null,arguments)},s._ArgMin=function(){return(s._ArgMin=s.asm.ArgMin).apply(null,arguments)},s._Asin=function(){return(s._Asin=s.asm.Asin).apply(null,arguments)},s._Asinh=function(){return(s._Asinh=s.asm.Asinh).apply(null,arguments)},s._Atan=function(){return(s._Atan=s.asm.Atan).apply(null,arguments)},s._Atan2=function(){return(s._Atan2=s.asm.Atan2).apply(null,arguments)},s._Atanh=function(){return(s._Atanh=s.asm.Atanh).apply(null,arguments)},s._AvgPool=function(){return(s._AvgPool=s.asm.AvgPool).apply(null,arguments)},s._AvgPool3D=function(){return(s._AvgPool3D=s.asm.AvgPool3D).apply(null,arguments)},s._AvgPool3DGrad=function(){return(s._AvgPool3DGrad=s.asm.AvgPool3DGrad).apply(null,arguments)},s._AvgPoolGrad=function(){return(s._AvgPoolGrad=s.asm.AvgPoolGrad).apply(null,arguments)},s._BatchMatMul=function(){return(s._BatchMatMul=s.asm.BatchMatMul).apply(null,arguments)},s._Bincount=function(){return(s._Bincount=s.asm.Bincount).apply(null,arguments)},s._BitwiseAnd=function(){return(s._BitwiseAnd=s.asm.BitwiseAnd).apply(null,arguments)},s._Ceil=function(){return(s._Ceil=s.asm.Ceil).apply(null,arguments)},s._ClipByValue=function(){return(s._ClipByValue=s.asm.ClipByValue).apply(null,arguments)},s._Conv2D=function(){return(s._Conv2D=s.asm.Conv2D).apply(null,arguments)},s._Conv2DBackpropInput=function(){return(s._Conv2DBackpropInput=s.asm.Conv2DBackpropInput).apply(null,arguments)},s._Conv3D=function(){return(s._Conv3D=s.asm.Conv3D).apply(null,arguments)},s._Conv3DBackpropFilterV2=function(){return(s._Conv3DBackpropFilterV2=s.asm.Conv3DBackpropFilterV2).apply(null,arguments)},s._Conv3DBackpropInputV2=function(){return(s._Conv3DBackpropInputV2=s.asm.Conv3DBackpropInputV2).apply(null,arguments)},s._Cos=function(){return(s._Cos=s.asm.Cos).apply(null,arguments)},s._Cosh=function(){return(s._Cosh=s.asm.Cosh).apply(null,arguments)},s._CropAndResize=function(){return(s._CropAndResize=s.asm.CropAndResize).apply(null,arguments)},s._Cumprod=function(){return(s._Cumprod=s.asm.Cumprod).apply(null,arguments)},s._Cumsum=function(){return(s._Cumsum=s.asm.Cumsum).apply(null,arguments)},s._DenseBincount=function(){return(s._DenseBincount=s.asm.DenseBincount).apply(null,arguments)},s._DepthToSpace=function(){return(s._DepthToSpace=s.asm.DepthToSpace).apply(null,arguments)},s._DepthwiseConv2dNative=function(){return(s._DepthwiseConv2dNative=s.asm.DepthwiseConv2dNative).apply(null,arguments)},s._Diag=function(){return(s._Diag=s.asm.Diag).apply(null,arguments)},s._Dilation2D=function(){return(s._Dilation2D=s.asm.Dilation2D).apply(null,arguments)},s._Dilation2DBackpropFilter=function(){return(s._Dilation2DBackpropFilter=s.asm.Dilation2DBackpropFilter).apply(null,arguments)},s._Dilation2DBackpropInput=function(){return(s._Dilation2DBackpropInput=s.asm.Dilation2DBackpropInput).apply(null,arguments)},s._Elu=function(){return(s._Elu=s.asm.Elu).apply(null,arguments)},s._EluGrad=function(){return(s._EluGrad=s.asm.EluGrad).apply(null,arguments)},s._Equal=function(){return(s._Equal=s.asm.Equal).apply(null,arguments)},s._Erf=function(){return(s._Erf=s.asm.Erf).apply(null,arguments)},s._Exp=function(){return(s._Exp=s.asm.Exp).apply(null,arguments)},s._Expm1=function(){return(s._Expm1=s.asm.Expm1).apply(null,arguments)},s._FlipLeftRight=function(){return(s._FlipLeftRight=s.asm.FlipLeftRight).apply(null,arguments)},s._Floor=function(){return(s._Floor=s.asm.Floor).apply(null,arguments)},s._FloorDiv=function(){return(s._FloorDiv=s.asm.FloorDiv).apply(null,arguments)},s._FusedBatchNorm=function(){return(s._FusedBatchNorm=s.asm.FusedBatchNorm).apply(null,arguments)},s._FusedConv2D=function(){return(s._FusedConv2D=s.asm.FusedConv2D).apply(null,arguments)},s._FusedDepthwiseConv2D=function(){return(s._FusedDepthwiseConv2D=s.asm.FusedDepthwiseConv2D).apply(null,arguments)},s._Gather=function(){return(s._Gather=s.asm.Gather).apply(null,arguments)},s._GatherNd=function(){return(s._GatherNd=s.asm.GatherNd).apply(null,arguments)},s._Greater=function(){return(s._Greater=s.asm.Greater).apply(null,arguments)},s._GreaterEqual=function(){return(s._GreaterEqual=s.asm.GreaterEqual).apply(null,arguments)},s._IsFinite=function(){return(s._IsFinite=s.asm.IsFinite).apply(null,arguments)},s._IsInf=function(){return(s._IsInf=s.asm.IsInf).apply(null,arguments)},s._IsNan=function(){return(s._IsNan=s.asm.IsNan).apply(null,arguments)},s._LRN=function(){return(s._LRN=s.asm.LRN).apply(null,arguments)},s._LRNGrad=function(){return(s._LRNGrad=s.asm.LRNGrad).apply(null,arguments)},s._LeakyRelu=function(){return(s._LeakyRelu=s.asm.LeakyRelu).apply(null,arguments)},s._Less=function(){return(s._Less=s.asm.Less).apply(null,arguments)},s._LessEqual=function(){return(s._LessEqual=s.asm.LessEqual).apply(null,arguments)},s._LinSpace=function(){return(s._LinSpace=s.asm.LinSpace).apply(null,arguments)},s._Log=function(){return(s._Log=s.asm.Log).apply(null,arguments)},s._Log1p=function(){return(s._Log1p=s.asm.Log1p).apply(null,arguments)},s._LogicalAnd=function(){return(s._LogicalAnd=s.asm.LogicalAnd).apply(null,arguments)},s._LogicalNot=function(){return(s._LogicalNot=s.asm.LogicalNot).apply(null,arguments)},s._LogicalOr=function(){return(s._LogicalOr=s.asm.LogicalOr).apply(null,arguments)},s._LogicalXor=function(){return(s._LogicalXor=s.asm.LogicalXor).apply(null,arguments)},s._Max=function(){return(s._Max=s.asm.Max).apply(null,arguments)},s._MaxPool=function(){return(s._MaxPool=s.asm.MaxPool).apply(null,arguments)},s._MaxPool3D=function(){return(s._MaxPool3D=s.asm.MaxPool3D).apply(null,arguments)},s._MaxPool3DGrad=function(){return(s._MaxPool3DGrad=s.asm.MaxPool3DGrad).apply(null,arguments)},s._MaxPoolGrad=function(){return(s._MaxPoolGrad=s.asm.MaxPoolGrad).apply(null,arguments)},s._MaxPoolWithArgmax=function(){return(s._MaxPoolWithArgmax=s.asm.MaxPoolWithArgmax).apply(null,arguments)},s._Maximum=function(){return(s._Maximum=s.asm.Maximum).apply(null,arguments)},s._Mean=function(){return(s._Mean=s.asm.Mean).apply(null,arguments)},s._Min=function(){return(s._Min=s.asm.Min).apply(null,arguments)},s._Minimum=function(){return(s._Minimum=s.asm.Minimum).apply(null,arguments)},s._MirrorPad=function(){return(s._MirrorPad=s.asm.MirrorPad).apply(null,arguments)},s._Mod=function(){return(s._Mod=s.asm.Mod).apply(null,arguments)},s._Multinomial=function(){return(s._Multinomial=s.asm.Multinomial).apply(null,arguments)},s._Multiply=function(){return(s._Multiply=s.asm.Multiply).apply(null,arguments)},s._Neg=function(){return(s._Neg=s.asm.Neg).apply(null,arguments)},s._NonMaxSuppressionV3=function(){return(s._NonMaxSuppressionV3=s.asm.NonMaxSuppressionV3).apply(null,arguments)},s._NonMaxSuppressionV4=function(){return(s._NonMaxSuppressionV4=s.asm.NonMaxSuppressionV4).apply(null,arguments)},s._NonMaxSuppressionV5=function(){return(s._NonMaxSuppressionV5=s.asm.NonMaxSuppressionV5).apply(null,arguments)},s._NotEqual=function(){return(s._NotEqual=s.asm.NotEqual).apply(null,arguments)},s._OneHot=function(){return(s._OneHot=s.asm.OneHot).apply(null,arguments)},s._PadV2=function(){return(s._PadV2=s.asm.PadV2).apply(null,arguments)},s._Pow=function(){return(s._Pow=s.asm.Pow).apply(null,arguments)},s._Prelu=function(){return(s._Prelu=s.asm.Prelu).apply(null,arguments)},s._Prod=function(){return(s._Prod=s.asm.Prod).apply(null,arguments)},s._RealDiv=function(){return(s._RealDiv=s.asm.RealDiv).apply(null,arguments)},s._Reciprocal=function(){return(s._Reciprocal=s.asm.Reciprocal).apply(null,arguments)},s._Relu=function(){return(s._Relu=s.asm.Relu).apply(null,arguments)},s._Relu6=function(){return(s._Relu6=s.asm.Relu6).apply(null,arguments)},s._ResizeBilinear=function(){return(s._ResizeBilinear=s.asm.ResizeBilinear).apply(null,arguments)},s._ResizeBilinearGrad=function(){return(s._ResizeBilinearGrad=s.asm.ResizeBilinearGrad).apply(null,arguments)},s._ResizeNearestNeighbor=function(){return(s._ResizeNearestNeighbor=s.asm.ResizeNearestNeighbor).apply(null,arguments)},s._ResizeNearestNeighborGrad=function(){return(s._ResizeNearestNeighborGrad=s.asm.ResizeNearestNeighborGrad).apply(null,arguments)},s._Reverse=function(){return(s._Reverse=s.asm.Reverse).apply(null,arguments)},s._RotateWithOffset=function(){return(s._RotateWithOffset=s.asm.RotateWithOffset).apply(null,arguments)},s._Round=function(){return(s._Round=s.asm.Round).apply(null,arguments)},s._Rsqrt=function(){return(s._Rsqrt=s.asm.Rsqrt).apply(null,arguments)},s._ScatterNd=function(){return(s._ScatterNd=s.asm.ScatterNd).apply(null,arguments)},s._SearchSorted=function(){return(s._SearchSorted=s.asm.SearchSorted).apply(null,arguments)},s._SelectV2=function(){return(s._SelectV2=s.asm.SelectV2).apply(null,arguments)},s._Selu=function(){return(s._Selu=s.asm.Selu).apply(null,arguments)},s._Sigmoid=function(){return(s._Sigmoid=s.asm.Sigmoid).apply(null,arguments)},s._Sign=function(){return(s._Sign=s.asm.Sign).apply(null,arguments)},s._Sin=function(){return(s._Sin=s.asm.Sin).apply(null,arguments)},s._Sinh=function(){return(s._Sinh=s.asm.Sinh).apply(null,arguments)},s._Softmax=function(){return(s._Softmax=s.asm.Softmax).apply(null,arguments)},s._Softplus=function(){return(s._Softplus=s.asm.Softplus).apply(null,arguments)},s._SparseFillEmptyRows=function(){return(s._SparseFillEmptyRows=s.asm.SparseFillEmptyRows).apply(null,arguments)},s._SparseReshape=function(){return(s._SparseReshape=s.asm.SparseReshape).apply(null,arguments)},s._SparseSegmentReduction=function(){return(s._SparseSegmentReduction=s.asm.SparseSegmentReduction).apply(null,arguments)},s._SparseToDense=function(){return(s._SparseToDense=s.asm.SparseToDense).apply(null,arguments)},s._Sqrt=function(){return(s._Sqrt=s.asm.Sqrt).apply(null,arguments)},s._Square=function(){return(s._Square=s.asm.Square).apply(null,arguments)},s._SquaredDifference=function(){return(s._SquaredDifference=s.asm.SquaredDifference).apply(null,arguments)},s._Step=function(){return(s._Step=s.asm.Step).apply(null,arguments)},s._StridedSlice=function(){return(s._StridedSlice=s.asm.StridedSlice).apply(null,arguments)},s._Sub=function(){return(s._Sub=s.asm.Sub).apply(null,arguments)},s._Sum=function(){return(s._Sum=s.asm.Sum).apply(null,arguments)},s._Tan=function(){return(s._Tan=s.asm.Tan).apply(null,arguments)},s._Tanh=function(){return(s._Tanh=s.asm.Tanh).apply(null,arguments)},s._TensorScatterUpdate=function(){return(s._TensorScatterUpdate=s.asm.TensorScatterUpdate).apply(null,arguments)},s._Tile=function(){return(s._Tile=s.asm.Tile).apply(null,arguments)},s._TopK=function(){return(s._TopK=s.asm.TopK).apply(null,arguments)},s._Transform=function(){return(s._Transform=s.asm.Transform).apply(null,arguments)},s._Transpose=function(){return(s._Transpose=s.asm.Transpose).apply(null,arguments)},s.__FusedMatMul=function(){return(s.__FusedMatMul=s.asm._FusedMatMul).apply(null,arguments)},s._malloc=function(){return(s._malloc=s.asm.malloc).apply(null,arguments)},s._free=function(){return(s._free=s.asm.free).apply(null,arguments)},s.___errno_location=function(){return(s.___errno_location=s.asm.__errno_location).apply(null,arguments)};var K,X,Y,Z=s.stackSave=function(){return(Z=s.stackSave=s.asm.stackSave).apply(null,arguments)},J=s.stackRestore=function(){return(J=s.stackRestore=s.asm.stackRestore).apply(null,arguments)},Q=s.stackAlloc=function(){return(Q=s.stackAlloc=s.asm.stackAlloc).apply(null,arguments)};function ee(e){function n(){K||(K=!0,s.calledRun=!0,!S&&(W(E),t(s),s.onRuntimeInitialized&&s.onRuntimeInitialized(),function(){if(s.postRun)for("function"==typeof s.postRun&&(s.postRun=[s.postRun]);s.postRun.length;)R(s.postRun.shift());W(A)}()))}M>0||(function(){if(s.preRun)for("function"==typeof s.preRun&&(s.preRun=[s.preRun]);s.preRun.length;)$(s.preRun.shift());W(T)}(),M>0)||(s.setStatus?(s.setStatus("Running..."),setTimeout(function(){setTimeout(function(){s.setStatus("")},1),n()},1)):n())}if(s.dynCall_iijjiiii=function(){return(s.dynCall_iijjiiii=s.asm.dynCall_iijjiiii).apply(null,arguments)},s.dynCall_jiji=function(){return(s.dynCall_jiji=s.asm.dynCall_jiji).apply(null,arguments)},s.cwrap=function(e,t,n,a){var r=(n=n||[]).every(e=>"number"===e||"boolean"===e);return"string"!==t&&r&&!a?H(e):function(){return function(e,t,n,a){var r={string:e=>{var t=0;if(null!=e&&0!==e){var n=1+(e.length<<2);!function(e,t,n){!function(e,t,n,a){if(!(a>0))return 0;for(var r=(n>>>=0)+a-1,s=0;s<e.length;++s){var i=e.charCodeAt(s);if(i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++s)),i<=127){if(n>=r)break;t[n++>>>0]=i}else if(i<=2047){if(n+1>=r)break;t[n++>>>0]=192|i>>6,t[n++>>>0]=128|63&i}else if(i<=65535){if(n+2>=r)break;t[n++>>>0]=224|i>>12,t[n++>>>0]=128|i>>6&63,t[n++>>>0]=128|63&i}else{if(n+3>=r)break;t[n++>>>0]=240|i>>18,t[n++>>>0]=128|i>>12&63,t[n++>>>0]=128|i>>6&63,t[n++>>>0]=128|63&i}}t[n>>>0]=0}(e,k,t,n)}(e,t=Q(n),n)}return t},array:e=>{var t=Q(e.length);return function(e,t){v.set(e,t>>>0)}(e,t),t}},s=H(e),i=[],o=0;if(a)for(var l=0;l<a.length;l++){var u=r[n[l]];u?(0===o&&(o=Z()),i[l]=u(a[l])):i[l]=a[l]}var d,c=s.apply(null,i);return d=c,0!==o&&J(o),function(e){return"string"===t?function(e){return(e>>>=0)?_(k,e,void 0):""}(e):"boolean"===t?!!e:e}(d)}(e,t,n,arguments)}},O=function e(){K||ee(),K||(O=e)},s.preInit)for("function"==typeof s.preInit&&(s.preInit=[s.preInit]);s.preInit.length>0;)s.preInit.pop()();if(ee(),r&&(X={uncaughtException:process.listeners("uncaughtException").filter(function(e){return!r.uncaughtException.indexOf(e)>-1}),unhandledRejection:process.listeners("unhandledRejection").filter(function(e){return!r.unhandledRejection.indexOf(e)>-1})}),void 0!==e)Y=e;else{if("undefined"==typeof WasmBackendModuleThreadedSimd)throw new Error("Could not find wasm module in post.js");Y=WasmBackendModuleThreadedSimd}if(X){var te=Y._dispose;Y._dispose=function(){te(),X.uncaughtException.forEach(function(e){process.removeListener("uncaughtException",e)}),X.unhandledRejection.forEach(function(e){process.removeListener("unhandledRejection",e)})}}return e.ready});"object"==typeof e&&"object"==typeof t?t.exports=a:"function"==typeof define&&define.amd?define([],function(){return a}):"object"==typeof e&&(e.WasmBackendModule=a)}),Pe=class{constructor(e,t){this.backend=e,this.dataMover=t,this.data=new WeakMap,this.dataIdsCount=0}get(e){return this.data.has(e)||this.dataMover.moveData(this.backend,e),this.data.get(e)}set(e,t){this.dataIdsCount++,this.data.set(e,t)}has(e){return this.data.has(e)}delete(e){return this.dataIdsCount--,this.data.delete(e)}numDataIds(){return this.dataIdsCount}},Be=class{refCount(e){return We("refCount")}incRef(e){return We("incRef")}timerAvailable(){return!0}time(e){return We("time")}read(e){return We("read")}readSync(e){return We("readSync")}readToGPU(e,t){return We("readToGPU")}numDataIds(){return We("numDataIds")}disposeData(e,t){return We("disposeData")}write(e,t,n){return We("write")}move(e,t,n,a,r){return We("move")}createTensorFromGPUData(e,t,n){return We("createTensorFromGPUData")}memory(){return We("memory")}floatPrecision(){return We("floatPrecision")}epsilon(){return 32===this.floatPrecision()?1e-7:1e-4}dispose(){return We("dispose")}};function We(e){throw new Error(`'${e}' not yet implemented or not found in the registry. This kernel may not be supported by the tfjs backend you have chosen`)}function Ve(e){let t=e.length,n=0;for(;t>0;)n=Math.random()*t|0,t--,qe(e,t,n)}function Ue(e,t){if(e.length!==t.length)throw new Error(`Array sizes must match to be shuffled together First array length was ${e.length}Second array length was ${t.length}`);let n=e.length,a=0;for(;n>0;)a=Math.random()*n|0,n--,qe(e,n,a),qe(t,n,a)}function Ge(e,t,n){return Math.max(e,Math.min(t,n))}function He(e){return e%2==0?e:e+1}function qe(e,t,n){let a=e[t];e[t]=e[n],e[n]=a}function Ke(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n];return t}function Xe(e,t){let n=Math.random();return t*n+(1-n)*e}function Ye(e,t){let n=0;for(let a=0;a<e.length;a++){let r=Number(e[a])-Number(t[a]);n+=r*r}return n}function Ze(e,t){if(!e)throw new Error("string"==typeof t?t:t())}function Je(e,t,n=""){Ze(at(e,t),()=>n+` Shapes ${e} and ${t} must match`)}function Qe(e){Ze(null!=e,()=>"The input to the tensor constructor must be a non-null value.")}function et(e){if(0===e.length)return 1;let t=e[0];for(let n=1;n<e.length;n++)t*=e[n];return t}function tt(e){return 0===e.length}function nt(e,t){if(e===t)return!0;if(null==e||null==t||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(null!==e[n]&&null!==t[n]&&e[n]!==t[n])return!1;return!0}function at(e,t){if(e===t)return!0;if(null==e||null==t||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function rt(e){return e%1==0}function st(e){if(null!=Math.tanh)return Math.tanh(e);if(e===1/0)return 1;if(e===-1/0)return-1;{let t=Math.exp(2*e);return(t-1)/(t+1)}}function it(e){let t=Math.ceil(Math.sqrt(e));return[t,Math.ceil(e/t)]}function ot(e){let t=new Uint32Array(e);for(let n=0;n<e;++n)t[n]=n;return Ve(t),t}function lt(e,t){return t<=e.length?e:e+" ".repeat(t-e.length)}function ut(e,t=e=>0,n,a){return new Promise((r,s)=>{let i=0,o=()=>{if(e())return void r();i++;let l=t(i);null!=n&&i>=n?s():null!=a?a(o,l):setTimeout(o,l)};o()})}function dt(e,t){let n=1,a=-1;for(let s=0;s<e.length;++s)if(e[s]>=0)n*=e[s];else if(-1===e[s]){if(-1!==a)throw Error(`Shapes can only have 1 implicit size. Found -1 at dim ${a} and dim ${s}`);a=s}else if(e[s]<0)throw Error(`Shapes can not be < 0. Found ${e[s]} at dim ${s}`);if(-1===a){if(t>0&&t!==n)throw Error(`Size(${t}) must match the product of shape ${e}`);return e}if(0===n)throw Error(`Cannot infer the missing size in [${e}] when there are 0 elements`);if(t%n!==0)throw Error(`The implicit shape can't be a fractional number. Got ${t} / ${n}`);let r=e.slice();return r[a]=t/n,r}function ct(e,t){let n=t.length;return Ze((e=null==e?t.map((e,t)=>t):[].concat(e)).every(e=>e>=-n&&e<n),()=>`All values in axis param must be in range [-${n}, ${n}) but got axis ${e}`),Ze(e.every(e=>rt(e)),()=>`All values in axis param must be integers but got axis ${e}`),e.map(e=>e<0?n+e:e)}function pt(e,t){let n=[],a=[],r=null!=t&&Array.isArray(t)&&0===t.length,s=null==t||r?null:ct(t,e).sort(),i=0;for(let o=0;o<e.length;++o){if(null!=s){if(s[i]===o&&1!==e[o])throw new Error(`Can't squeeze axis ${o} since its dim '${e[o]}' is not 1`);(null==s[i]||s[i]>o)&&1===e[o]&&(n.push(e[o]),a.push(o)),s[i]<=o&&i++}1!==e[o]&&(n.push(e[o]),a.push(o))}return{newShape:n,keptDims:a}}function ht(e,t){return mt(e,t)}function mt(e,t){let n=null;if(null==e||"float32"===e)n=new Float32Array(t);else if("int32"===e)n=new Int32Array(t);else if("bool"===e)n=new Uint8Array(t);else{if("string"!==e)throw new Error(`Unknown data type ${e}`);n=new Array(t)}return n}function ft(e,t){for(let n=0;n<e.length;n++){let a=e[n];if(isNaN(a)||!isFinite(a))throw Error(`A tensor of type ${t} being uploaded contains ${a}.`)}}function gt(e){return"bool"===e||"complex64"===e||"float32"===e||"int32"===e||"string"===e}function xt(e,t){return!("complex64"===t||"float32"===t&&"complex64"!==e||"int32"===t&&"float32"!==e&&"complex64"!==e||"bool"===t&&"bool"===e)}function bt(e){if("float32"===e||"int32"===e)return 4;if("complex64"===e)return 8;if("bool"===e)return 1;throw new Error(`Unknown dtype ${e}`)}function yt(e){if(null==e)return 0;let t=0;return e.forEach(e=>t+=e.length),t}function wt(e){return"string"==typeof e||e instanceof String}function vt(e){return"boolean"==typeof e}function kt(e){return"number"==typeof e}function Nt(e){return Array.isArray(e)?Nt(e[0]):e instanceof Float32Array?"float32":e instanceof Int32Array||e instanceof Uint8Array||e instanceof Uint8ClampedArray?"int32":kt(e)?"float32":wt(e)?"string":vt(e)?"bool":"float32"}function St(e){return!!(e&&e.constructor&&e.call&&e.apply)}function It(e,t){for(let n=t;n<e;++n)if(e%n===0)return n;return e}function _t(e){let t=e.length;if(t<2)return[];let n=new Array(t-1);n[t-2]=e[t-1];for(let a=t-3;a>=0;--a)n[a]=n[a+1]*e[a+1];return n}function Ct(e,t,n,a=!1){let r=new Array;if(1===t.length){let s=t[0]*(a?2:1);for(let t=0;t<s;t++)r[t]=n[e+t]}else{let s=t[0],i=t.slice(1),o=i.reduce((e,t)=>e*t)*(a?2:1);for(let t=0;t<s;t++)r[t]=Ct(e+t*o,i,n,a)}return r}function Tt(e,t,n=!1){if(0===e.length)return t[0];let a=e.reduce((e,t)=>e*t)*(n?2:1);if(0===a)return[];if(a!==t.length)throw new Error(`[${e}] does not match the input size ${t.length}${n?" for a complex tensor":""}.`);return Ct(0,e,t,n)}function Et(e,t){if(Array.isArray(e))return e;if("float32"===t)return e instanceof Float32Array?e:new Float32Array(e);if("int32"===t)return e instanceof Int32Array?e:new Int32Array(e);if("bool"===t||"string"===t)return Uint8Array.from(new Int32Array(e));throw new Error(`Unknown dtype ${t}`)}function At(e,t){let n=$t(e,t);for(let a=0;a<n.length;a++)n[a]=1;return n}function $t(e,t){if(null==t||"float32"===t||"complex64"===t)return new Float32Array(e);if("int32"===t)return new Int32Array(e);if("bool"===t)return new Uint8Array(e);throw new Error(`Unknown data type ${t}`)}function Rt(e,t){let n=e.reduce((e,t)=>e*t,1);if(null==t||"float32"===t)return Tt(e,new Float32Array(n));if("int32"===t)return Tt(e,new Int32Array(n));if("bool"===t)return Tt(e,new Uint8Array(n));throw new Error(`Unknown data type ${t}`)}function Ft(e){e.forEach(t=>{Ze(Number.isInteger(t)&&t>=0,()=>`Tensor must have a shape comprised of positive integers but got shape [${e}].`)})}function Dt(e,t,n){if(0===t)return 0;if(1===t)return e[0];let a=e[e.length-1];for(let r=0;r<e.length-1;++r)a+=n[r]*e[r];return a}function Mt(e,t,n){if(0===t)return[];if(1===t)return[e];let a=new Array(t);for(let r=0;r<a.length-1;++r)a[r]=Math.floor(e/n[r]),e-=a[r]*n[r];return a[a.length-1]=e,a}function Ot(e){return e&&e.then&&"function"==typeof e.then}var jt="tfjsflags",Lt=class{constructor(e){this.global=e,this.flags={},this.flagRegistry={},this.urlFlags={},this.getQueryParams=zt,this.populateURLFlags()}setPlatform(e,t){null!=this.platform&&(Pt().getBool("IS_TEST")||Pt().getBool("PROD")),this.platformName=e,this.platform=t}registerFlag(e,t,n){if(this.flagRegistry[e]={evaluationFn:t,setHook:n},null!=this.urlFlags[e]){let t=this.urlFlags[e];Pt().getBool("IS_TEST")||Pt().getBool("PROD"),this.set(e,t)}}async getAsync(e){return e in this.flags||(this.flags[e]=await this.evaluateFlag(e)),this.flags[e]}get(e){if(e in this.flags)return this.flags[e];let t=this.evaluateFlag(e);if(Ot(t))throw new Error(`Flag ${e} cannot be synchronously evaluated. Please use getAsync() instead.`);return this.flags[e]=t,this.flags[e]}getNumber(e){return this.get(e)}getBool(e){return this.get(e)}getString(e){return this.get(e)}getFlags(){return this.flags}get features(){return this.flags}set(e,t){if(null==this.flagRegistry[e])throw new Error(`Cannot set flag ${e} as it has not been registered.`);this.flags[e]=t,null!=this.flagRegistry[e].setHook&&this.flagRegistry[e].setHook(t)}evaluateFlag(e){if(null==this.flagRegistry[e])throw new Error(`Cannot evaluate flag '${e}': no evaluation function found.`);return this.flagRegistry[e].evaluationFn()}setFlags(e){this.flags=Object.assign({},e)}reset(){this.flags={},this.urlFlags={},this.populateURLFlags()}populateURLFlags(){if(void 0===this.global||void 0===this.global.location||void 0===this.global.location.search)return;let e=this.getQueryParams(this.global.location.search);jt in e&&e[jt].split(",").forEach(e=>{let[t,n]=e.split(":");this.urlFlags[t]=function(e,t){let n=t.toLowerCase();return"true"===n||"false"===n?"true"===n:""+ +n===n?+n:t}(0,n)})}};function zt(e){let t={};return e.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,(e,...n)=>(function(e,t,n){e[decodeURIComponent(t)]=decodeURIComponent(n||"")}(t,n[0],n[1]),n.join("="))),t}function Pt(){return Wt}var Bt,Wt=null;function Vt(){if(null==Bt){let e;if("undefined"!=typeof window)e=window;else if("undefined"!=typeof global)e=global;else if("undefined"!=typeof process)e=process;else{if("undefined"==typeof self)throw new Error("Could not find a global object");e=self}Bt=e}return Bt}function Ut(e,t){let n=function(){let e=Vt();return null==e._tfGlobals&&(e._tfGlobals=new Map),e._tfGlobals}();if(n.has(e))return n.get(e);{let a=t();return n.set(e,a),n.get(e)}}var Gt="Abs",Ht="Acos",qt="Acosh",Kt="Add",Xt="AddN",Yt="All",Zt="Any",Jt="ArgMax",Qt="ArgMin",en="Asin",tn="Asinh",nn="Atan",an="Atanh",rn="Atan2",sn="AvgPool",on="AvgPoolGrad",ln="AvgPool3D",un="AvgPool3DGrad",dn="BatchMatMul",cn="BatchToSpaceND",pn="Bincount",hn="BitwiseAnd",mn="BroadcastTo",fn="BroadcastArgs",gn="Cast",xn="Ceil",bn="ClipByValue",yn="Complex",wn="ComplexAbs",vn="Concat",kn="Conv2D",Nn="Conv2DBackpropFilter",Sn="Conv2DBackpropInput",In="Conv3D",_n="Conv3DBackpropFilterV2",Cn="Conv3DBackpropInputV2",Tn="Cos",En="Cosh",An="Cumprod",$n="Cumsum",Rn="CropAndResize",Fn="DenseBincount",Dn="DepthToSpace",Mn="DepthwiseConv2dNative",On="DepthwiseConv2dNativeBackpropFilter",jn="DepthwiseConv2dNativeBackpropInput",Ln="Diag",zn="Dilation2D",Pn="Dilation2DBackpropInput",Bn="Dilation2DBackpropFilter",Wn="Draw",Vn="RealDiv",Un="Einsum",Gn="Elu",Hn="EluGrad",qn="Erf",Kn="Equal",Xn="Exp",Yn="ExpandDims",Zn="Expm1",Jn="FFT",Qn="Fill",ea="FlipLeftRight",ta="Floor",na="FloorDiv",aa="FusedBatchNorm",ra="GatherV2",sa="GatherNd",ia="Greater",oa="GreaterEqual",la="Identity",ua="IFFT",da="Imag",ca="IsFinite",pa="IsInf",ha="IsNan",ma="LeakyRelu",fa="Less",ga="LessEqual",xa="LinSpace",ba="Log",ya="Log1p",wa="LogicalAnd",va="LogicalNot",ka="LogicalOr",Na="LogicalXor",Sa="LogSoftmax",Ia="LowerBound",_a="LRN",Ca="LRNGrad",Ta="MatrixBandPart",Ea="Max",Aa="Maximum",$a="MaxPool",Ra="MaxPoolGrad",Fa="MaxPool3D",Da="MaxPool3DGrad",Ma="MaxPoolWithArgmax",Oa="Mean",ja="Min",La="Minimum",za="MirrorPad",Pa="Mod",Ba="Multinomial",Wa="Multiply",Va="Neg",Ua="NotEqual",Ga="NonMaxSuppressionV3",Ha="NonMaxSuppressionV4",qa="NonMaxSuppressionV5",Ka="OnesLike",Xa="OneHot",Ya="Pack",Za="PadV2",Ja="Pool",Qa="Pow",er="Prelu",tr="Prod",nr="RaggedGather",ar="RaggedRange",rr="RaggedTensorToTensor",sr="Range",ir="Real",or="Reciprocal",lr="Relu",ur="Reshape",dr="ResizeNearestNeighbor",cr="ResizeNearestNeighborGrad",pr="ResizeBilinear",hr="ResizeBilinearGrad",mr="Relu6",fr="Reverse",gr="Round",xr="Rsqrt",br="ScatterNd",yr="TensorScatterUpdate",wr="SearchSorted",vr="Select",kr="Selu",Nr="Slice",Sr="Sin",Ir="Sinh",_r="Sign",Cr="Sigmoid",Tr="Softplus",Er="Sqrt",Ar="Sum",$r="SpaceToBatchND",Rr="SplitV",Fr="Softmax",Dr="SparseFillEmptyRows",Mr="SparseReshape",Or="SparseSegmentMean",jr="SparseSegmentSum",Lr="SparseToDense",zr="SquaredDifference",Pr="Square",Br="StaticRegexReplace",Wr="StridedSlice",Vr="StringNGrams",Ur="StringSplit",Gr="StringToHashBucketFast",Hr="Sub",qr="Tan",Kr="Tanh",Xr="Tile",Yr="TopK",Zr="Transform",Jr="Transpose",Qr="Unique",es="Unpack",ts="UnsortedSegmentSum",ns="UpperBound",as="ZerosLike",rs="Step",ss="FromPixels",is="RotateWithOffset",os="_FusedMatMul",ls="FusedConv2D",us="FusedDepthwiseConv2D";function ds(...e){Pt().getBool("IS_TEST")||Pt().getBool("PROD")}function cs(...e){Pt().getBool("IS_TEST")||Pt().getBool("PROD")}var ps=Ut("kernelRegistry",()=>new Map),hs=Ut("gradRegistry",()=>new Map);function ms(e,t){let n=ks(e,t);return ps.get(n)}function fs(e){return hs.get(e)}function gs(e){let t=ps.entries(),n=[];for(;;){let{done:a,value:r}=t.next();if(a)break;let[s,i]=r,[o]=s.split("_");o===e&&n.push(i)}return n}function xs(e){let{kernelName:t,backendName:n}=e,a=ks(t,n);ps.has(a)&&ds(),ps.set(a,e)}function bs(e){let{kernelName:t}=e;hs.has(t)&&Pt().getBool("DEBUG")&&ds(),hs.set(t,e)}function ys(e,t){let n=ks(e,t);if(!ps.has(n))throw new Error(`The kernel '${e}' for backend '${t}' is not registered`);ps.delete(n)}function ws(e){if(!hs.has(e))throw new Error(`The gradient '${e}' for backend is not registered`);hs.delete(e)}function vs(e,t){gs(e).forEach(e=>{xs(Object.assign({},e,{backendName:t}))})}function ks(e,t){return`${t}_${e}`}var Ns={};function Ss(e){return e instanceof Float32Array||e instanceof Int32Array||e instanceof Uint8Array||e instanceof Uint8ClampedArray}xe(Ns,{arraysEqual:()=>at,arraysEqualWithNull:()=>nt,assert:()=>Ze,assertNonNegativeIntegerDimensions:()=>Ft,assertNonNull:()=>Qe,assertShapesMatch:()=>Je,bytesFromStringArray:()=>yt,bytesPerElement:()=>bt,checkConversionForErrors:()=>ft,clamp:()=>Ge,computeStrides:()=>_t,convertBackendValuesAndArrayBuffer:()=>Et,createScalarValue:()=>zs,createShuffledIndices:()=>ot,decodeString:()=>Us,distSquared:()=>Ye,encodeString:()=>Vs,fetch:()=>Ws,fingerPrint64:()=>Ls,flatten:()=>Hs,getArrayFromDType:()=>mt,getTypedArrayFromDType:()=>ht,hasEncodingLoss:()=>xt,hexToLong:()=>Cs,indexToLoc:()=>Mt,inferDtype:()=>Nt,inferFromImplicitShape:()=>dt,isBoolean:()=>vt,isFunction:()=>St,isInt:()=>rt,isNumber:()=>kt,isPromise:()=>Ot,isScalarShape:()=>tt,isString:()=>wt,isTypedArray:()=>Gs,isValidDtype:()=>gt,locToIndex:()=>Dt,makeOnesTypedArray:()=>At,makeZerosNestedTypedArray:()=>Rt,makeZerosTypedArray:()=>$t,nearestDivisor:()=>It,nearestLargerEven:()=>He,now:()=>Bs,parseAxisParam:()=>ct,randUniform:()=>Xe,repeatedTry:()=>ut,rightPad:()=>lt,shuffle:()=>Ve,shuffleCombo:()=>Ue,sizeFromShape:()=>et,sizeToSquarishShape:()=>it,squeezeShape:()=>pt,sum:()=>Ke,swap:()=>qe,tanh:()=>st,toNestedArray:()=>Tt,toTypedArray:()=>Ps});var Is=be(ye()),_s=Is.default||Is;function Cs(e){return _s.fromString(e,!0,16)}var Ts=Cs("c3a5c85c97cb3127"),Es=Cs("b492b66fbe98f273"),As=Cs("9ae16a3b2f90404f");function $s(e){return e.xor(e.shru(47))}function Rs(e,t,n){let a=e.slice(t,t+n);return _s.fromBytes(Array.from(a),!0,!0)}function Fs(e,t){return Rs(e,t,8)}function Ds(e,t){return Rs(e,t,4)}function Ms(e,t){return 0===t?e:e.shru(t).or(e.shl(64-t))}function Os(e,t,n=Cs("9ddfea08eb382d69")){let a=e.xor(t).mul(n);a=a.xor(a.shru(47));let r=t.xor(a).mul(n);return r=r.xor(r.shru(47)),r=r.mul(n),r}function js(e,t,n,a){return function(e,t,n,a,r,s){r=r.add(e),s=Ms(s.add(r).add(a),21);let i=r;return r=(r=r.add(t)).add(n),s=s.add(Ms(r,44)),[r.add(a),s.add(i)]}(Fs(e,t),Fs(e,t+8),Fs(e,t+16),Fs(e,t+24),n,a)}function Ls(e,t=e.length){let n=_s.fromNumber(81,!0);if(t<=32)return t<=16?function(e,t=e.length){if(t>=8){let n=As.add(2*t),a=Fs(e,0).add(As),r=Fs(e,t-8);return Os(Ms(r,37).mul(n).add(a),Ms(a,25).add(r).mul(n),n)}if(t>=4){let n=As.add(2*t);return Os(Ds(e,0).shl(3).add(t),Ds(e,t-4),n)}if(t>0){let n=e[0]+(e[t>>1]<<8),a=t+(e[t-1]<<2);return $s(As.mul(n).xor(Ts.mul(a))).mul(As)}return As}(e,t):function(e,t=e.length){let n=As.add(2*t),a=Fs(e,0).mul(Es),r=Fs(e,8),s=Fs(e,t-8).mul(n),i=Fs(e,t-16).mul(As);return Os(Ms(a.add(r),43).add(Ms(s,30)).add(i),a.add(Ms(r.add(As),18)).add(s),n)}(e,t);if(t<=64)return function(e,t=e.length){let n=As.add(2*t),a=Fs(e,0).mul(As),r=Fs(e,8),s=Fs(e,t-8).mul(n),i=Fs(e,t-16).mul(As),o=Ms(a.add(r),43).add(Ms(s,30)).add(i),l=Os(o,a.add(Ms(r.add(As),18)).add(s),n),u=Fs(e,16).mul(n),d=Fs(e,24),c=o.add(Fs(e,t-32)).mul(n),p=l.add(Fs(e,t-24)).mul(n);return Os(Ms(u.add(d),43).add(Ms(c,30)).add(p),u.add(Ms(d.add(a),18)).add(c),n)}(e,t);let a=n,r=n.mul(Es).add(113),s=$s(r.mul(As).add(113)).mul(As),i=[_s.UZERO,_s.UZERO],o=[_s.UZERO,_s.UZERO];a=a.mul(As).add(Fs(e,0));let l=0,u=64*(t-1>>6),d=u+(t-1&63)-63;do{a=Ms(a.add(r).add(i[0]).add(Fs(e,l+8)),37).mul(Es),r=Ms(r.add(i[1]).add(Fs(e,l+48)),42).mul(Es),a=a.xor(o[1]),r=r.add(i[0]).add(Fs(e,l+40)),s=Ms(s.add(o[0]),33).mul(Es),i=js(e,l,i[1].mul(Es),a.add(o[0])),o=js(e,l+32,s.add(o[1]),r.add(Fs(e,l+16))),[s,a]=[a,s],l+=64}while(l!==u);let c=Es.add(s.and(255).shl(1));return l=d,o[0]=o[0].add(t-1&63),i[0]=i[0].add(o[0]),o[0]=o[0].add(i[0]),a=Ms(a.add(r).add(i[0]).add(Fs(e,l+8)),37).mul(c),r=Ms(r.add(i[1]).add(Fs(e,l+48)),42).mul(c),a=a.xor(o[1].mul(9)),r=r.add(i[0].mul(9).add(Fs(e,l+40))),s=Ms(s.add(o[0]),33).mul(c),i=js(e,l,i[1].mul(c),a.add(o[0])),o=js(e,l+32,s.add(o[1]),r.add(Fs(e,l+16))),[s,a]=[a,s],Os(Os(i[0],o[0],c).add($s(r).mul(Ts)).add(s),Os(i[1],o[1],c).add(a),c)}function zs(e,t){return"string"===t?Vs(e):Ps([e],t)}function Ps(e,t){if("string"===t)throw new Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(e)&&(e=Hs(e)),Pt().getBool("DEBUG")&&ft(e,t),function(e,t){return e instanceof Float32Array&&"float32"===t||e instanceof Int32Array&&"int32"===t||e instanceof Uint8Array&&"bool"===t}(e,t))return e;if(null==t||"float32"===t||"complex64"===t)return new Float32Array(e);if("int32"===t)return new Int32Array(e);if("bool"===t){let t=new Uint8Array(e.length);for(let n=0;n<t.length;++n)0!==Math.round(e[n])&&(t[n]=1);return t}throw new Error(`Unknown data type ${t}`)}function Bs(){return Pt().platform.now()}function Ws(e,t){return Pt().platform.fetch(e,t)}function Vs(e,t="utf-8"){return t=t||"utf-8",Pt().platform.encode(e,t)}function Us(e,t="utf-8"){return t=t||"utf-8",Pt().platform.decode(e,t)}function Gs(e){return null!=Pt().platform.isTypedArray?Pt().platform.isTypedArray(e):Ss(e)}function Hs(e,t=[],n=!1){if(null==t&&(t=[]),"boolean"==typeof e||"number"==typeof e||"string"==typeof e||Ot(e)||null==e||Gs(e)&&n)t.push(e);else if(Array.isArray(e)||Gs(e))for(let a=0;a<e.length;++a)Hs(e[a],t,n);else{let a=-1;for(let t of Object.keys(e))/^([1-9]+[0-9]*|0)$/.test(t)&&(a=Math.max(a,Number(t)));for(let r=0;r<=a;r++)Hs(e[r],t,n)}return t}var qs=class{constructor(e,t){this.backendTimer=e,this.logger=t,null==t&&(this.logger=new Xs)}profileKernel(e,t,n){let a,r,s=()=>{a=n()},i=Bs();if(this.backendTimer.timerAvailable())r=this.backendTimer.time(s);else{s();for(let e of a)e.dataSync();r=Promise.resolve({kernelMs:Bs()-i})}if(Pt().getBool("CHECK_COMPUTATION_FOR_ERRORS"))for(let o=0;o<a.length;o++){let e=a[o];e.data().then(t=>{Ks(t,e.dtype)})}return{kernelName:e,outputs:a,inputs:t,timeMs:r.then(e=>e.kernelMs),extraInfo:r.then(e=>null!=e.getExtraProfileInfo?e.getExtraProfileInfo():"")}}logKernelProfile(e){let{kernelName:t,outputs:n,timeMs:a,inputs:r,extraInfo:s}=e;n.forEach(e=>{Promise.all([e.data(),a,s]).then(n=>{this.logger.logKernelProfile(t,e,n[0],n[1],r,n[2])})})}};function Ks(e,t,n){if("float32"!==t)return!1;for(let a=0;a<e.length;a++){let t=e[a];if(isNaN(t)||!isFinite(t))return!0}return!1}var Xs=class{logKernelProfile(e,t,n,a,r,s){"number"==typeof a?lt(`${a}ms`,9):a.error,lt(e,25),t.rank,t.size,lt(t.shape.toString(),14);let i="";for(let o in r){let e=r[o];if(null!=e){let n=e.shape||t.shape,a=n.length;i+=`${o}: ${a}D ${a>0?n:""} `}}}};function Ys(e,t,n,a){let r=_t(t),s=function(e,t,n,a){let r=et(t),s=a[a.length-1],i=new Array(s).fill(0),o=t.length,l="complex64"===n?ei(e):e;if(o>1)for(let u=0;u<r/s;u++){let e=u*s;for(let t=0;t<s;t++)i[t]=Math.max(i[t],Zs(l[e+t],0,n).length)}return i}(e,t,n,r),i=t.length,o=Qs(e,t,n,r,s),l=["Tensor"];return a&&(l.push(`  dtype: ${n}`),l.push(`  rank: ${i}`),l.push(`  shape: [${t}]`),l.push("  values:")),l.push(o.map(e=>"    "+e).join("\n")),l.join("\n")}function Zs(e,t,n){let a;return a=Array.isArray(e)?`${parseFloat(e[0].toFixed(7))} + ${parseFloat(e[1].toFixed(7))}j`:wt(e)?`'${e}'`:"bool"===n?Js(e):parseFloat(e.toFixed(7)).toString(),lt(a,t)}function Js(e){return 0===e?"false":"true"}function Qs(e,t,n,a,r,s=!0){let i="complex64"===n?2:1,o=t[0],l=t.length;if(0===l)return"complex64"===n?[Zs(ei(e)[0],0,n)]:"bool"===n?[Js(e[0])]:[e[0].toString()];if(1===l){if(o>20){let t=3*i,a=Array.from(e.slice(0,t)),s=Array.from(e.slice((o-3)*i,o*i));return"complex64"===n&&(a=ei(a),s=ei(s)),["["+a.map((e,t)=>Zs(e,r[t],n)).join(", ")+", ..., "+s.map((e,t)=>Zs(e,r[o-3+t],n)).join(", ")+"]"]}return["["+("complex64"===n?ei(e):Array.from(e)).map((e,t)=>Zs(e,r[t],n)).join(", ")+"]"]}let u=t.slice(1),d=a.slice(1),c=a[0]*i,p=[];if(o>20){for(let t=0;t<3;t++){let a=t*c,s=a+c;p.push(...Qs(e.slice(a,s),u,n,d,r,!1))}p.push("...");for(let t=o-3;t<o;t++){let a=t*c,s=a+c;p.push(...Qs(e.slice(a,s),u,n,d,r,t===o-1))}}else for(let f=0;f<o;f++){let t=f*c,a=t+c;p.push(...Qs(e.slice(t,a),u,n,d,r,f===o-1))}let h=2===l?",":"";p[0]="["+(o>0?p[0]+h:"");for(let f=1;f<p.length-1;f++)p[f]=" "+p[f]+h;let m=",\n";for(let f=2;f<l;f++)m+="\n";return p[p.length-1]=" "+p[p.length-1]+"]"+(s?"":m),p}function ei(e){let t=[];for(let n=0;n<e.length;n+=2)t.push([e[n],e[n+1]]);return t}var ti=class{constructor(e,t,n){if(this.dtype=t,this.shape=e.slice(),this.size=et(e),null!=n){let e=n.length;Ze(e===this.size,()=>`Length of values '${e}' does not match the size inferred by the shape '${this.size}'.`)}if("complex64"===t)throw new Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=n||mt(t,this.size),this.strides=_t(e)}set(e,...t){0===t.length&&(t=[0]),Ze(t.length===this.rank,()=>`The number of provided coordinates (${t.length}) must match the rank (${this.rank})`);let n=this.locToIndex(t);this.values[n]=e}get(...e){0===e.length&&(e=[0]);let t=0;for(let a of e){if(a<0||a>=this.shape[t]){let t=`Requested out of range element at ${e}.   Buffer shape=${this.shape}`;throw new Error(t)}t++}let n=e[e.length-1];for(let a=0;a<e.length-1;++a)n+=this.strides[a]*e[a];return this.values[n]}locToIndex(e){if(0===this.rank)return 0;if(1===this.rank)return e[0];let t=e[e.length-1];for(let n=0;n<e.length-1;++n)t+=this.strides[n]*e[n];return t}indexToLoc(e){if(0===this.rank)return[];if(1===this.rank)return[e];let t=new Array(this.shape.length);for(let n=0;n<t.length-1;++n)t[n]=Math.floor(e/this.strides[n]),e-=t[n]*this.strides[n];return t[t.length-1]=e,t}get rank(){return this.shape.length}toTensor(){return ni().makeTensor(this.values,this.shape,this.dtype)}},ni=null,ai=null,ri=class{constructor(e,t,n,a){this.kept=!1,this.isDisposedInternal=!1,this.shape=e.slice(),this.dtype=t||"float32",this.size=et(e),this.strides=_t(e),this.dataId=n,this.id=a,this.rankType=this.rank<5?this.rank.toString():"higher"}get rank(){return this.shape.length}async buffer(){let e=await this.data();return ai.buffer(this.shape,this.dtype,e)}bufferSync(){return ai.buffer(this.shape,this.dtype,this.dataSync())}async array(){let e=await this.data();return Tt(this.shape,e,"complex64"===this.dtype)}arraySync(){return Tt(this.shape,this.dataSync(),"complex64"===this.dtype)}async data(){this.throwIfDisposed();let e=ni().read(this.dataId);if("string"===this.dtype){let t=await e;try{return t.map(e=>Us(e))}catch(XQ){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}}return e}dataToGPU(e){return this.throwIfDisposed(),ni().readToGPU(this.dataId,e)}dataSync(){this.throwIfDisposed();let e=ni().readSync(this.dataId);if("string"===this.dtype)try{return e.map(e=>Us(e))}catch(t){throw new Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return e}async bytes(){this.throwIfDisposed();let e=await ni().read(this.dataId);return"string"===this.dtype?e:new Uint8Array(e.buffer)}dispose(){this.isDisposed||(this.kerasMask&&this.kerasMask.dispose(),ni().disposeTensor(this),this.isDisposedInternal=!0)}get isDisposed(){return this.isDisposedInternal}throwIfDisposed(){if(this.isDisposed)throw new Error("Tensor is disposed.")}print(e=!1){return ai.print(this,e)}clone(){return this.throwIfDisposed(),ai.clone(this)}toString(e=!1){return Ys(this.dataSync(),this.shape,this.dtype,e)}cast(e){return this.throwIfDisposed(),ai.cast(this,e)}variable(e=!0,t,n){return this.throwIfDisposed(),ni().makeVariable(this,e,t,n)}};function si(){return Ut("Tensor",()=>ri)}Object.defineProperty(ri,Symbol.hasInstance,{value:e=>!!e&&null!=e.data&&null!=e.dataSync&&null!=e.throwIfDisposed}),si();var ii=class extends ri{constructor(e,t,n,a){super(e.shape,e.dtype,e.dataId,a),this.trainable=t,this.name=n}assign(e){if(e.dtype!==this.dtype)throw new Error(`dtype of the new value (${e.dtype}) and previous value (${this.dtype}) must match`);if(!at(e.shape,this.shape))throw new Error(`shape of the new value (${e.shape}) and previous value (${this.shape}) must match`);ni().disposeTensor(this),this.dataId=e.dataId,ni().incRef(this,null)}dispose(){ni().disposeVariable(this),this.isDisposedInternal=!0}};Object.defineProperty(ii,Symbol.hasInstance,{value:e=>e instanceof ri&&null!=e.assign&&e.assign instanceof Function});var oi,li,ui,di,ci,pi={};xe(pi,{assertTypesMatch:()=>yi,getTensorsInContainer:()=>vi,isTensorInList:()=>wi,makeTypesMatch:()=>bi}),function(e){e.R0="R0",e.R1="R1",e.R2="R2",e.R3="R3",e.R4="R4",e.R5="R5",e.R6="R6"}(oi||(oi={})),function(e){e.float32="float32",e.int32="int32",e.bool="int32",e.complex64="complex64"}(li||(li={})),function(e){e.float32="float32",e.int32="int32",e.bool="bool",e.complex64="complex64"}(ui||(ui={})),function(e){e.float32="float32",e.int32="float32",e.bool="float32",e.complex64="complex64"}(di||(di={})),function(e){e.float32="complex64",e.int32="complex64",e.bool="complex64",e.complex64="complex64"}(ci||(ci={}));var hi={float32:di,int32:li,bool:ui,complex64:ci};function mi(e,t){if("string"===e||"string"===t){if("string"===e&&"string"===t)return"string";throw new Error(`Can not upcast ${e} with ${t}`)}return hi[e][t]}function fi(e){return mi(e,"int32")}function gi(e){return null!=e&&"object"==typeof e&&"texture"in e&&e.texture instanceof WebGLTexture}function xi(e){return"undefined"!=typeof GPUBuffer&&null!=e&&"object"==typeof e&&"buffer"in e&&e.buffer instanceof GPUBuffer}function bi(e,t){if(e.dtype===t.dtype)return[e,t];let n=mi(e.dtype,t.dtype);return[e.cast(n),t.cast(n)]}function yi(e,t){Ze(e.dtype===t.dtype,()=>`The dtypes of the first(${e.dtype}) and second(${t.dtype}) input must match`)}function wi(e,t){return t.some(t=>t.id===e.id)}function vi(e){let t=[];return ki(e,t,new Set),t}function ki(e,t,n){if(null==e)return;if(e instanceof ri)return void t.push(e);if(!function(e){return Array.isArray(e)||"object"==typeof e}(e))return;let a=e;for(let r in a){let e=a[r];n.has(e)||(n.add(e),ki(e,t,n))}}function Ni(e){return null!=e.kernelName}var Si=class{constructor(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.numDataMovesStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null,get kernelNames(){return Array.from(new Set(this.kernels.map(e=>e.name)))}}}dispose(){for(let e in this.registeredVariables)this.registeredVariables[e].dispose()}},Ii=class e{constructor(e){this.ENV=e,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new Si}async ready(){if(null!=this.pendingBackendInit)return this.pendingBackendInit.then(()=>{});if(null!=this.backendInstance)return;let e=this.getSortedBackends();for(let t=0;t<e.length;t++){let n=e[t];if(await this.initializeBackend(n).success)return void(await this.setBackend(n))}throw new Error("Could not initialize any backends, all backend initializations failed.")}get backend(){if(null!=this.pendingBackendInit)throw new Error(`Backend '${this.backendName}' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods`);if(null==this.backendInstance){let{name:e,asyncInit:t}=this.initializeBackendsAndReturnBest();if(t)throw new Error(`The highest priority backend '${e}' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods`);this.setBackend(e)}return this.backendInstance}backendNames(){return Object.keys(this.registryFactory)}findBackend(e){if(!(e in this.registry)){if(!(e in this.registryFactory))return null;{let{asyncInit:t}=this.initializeBackend(e);if(t)return null}}return this.registry[e]}findBackendFactory(e){return e in this.registryFactory?this.registryFactory[e].factory:null}registerBackend(e,t,n=1){return e in this.registryFactory?(ds(),!1):(this.registryFactory[e]={factory:t,priority:n},!0)}async setBackend(e){if(null==this.registryFactory[e])throw new Error(`Backend name '${e}' not found in registry`);if(this.backendName=e,null==this.registry[e]){this.backendInstance=null;let{success:t,asyncInit:n}=this.initializeBackend(e);if(!(n?await t:t))return!1}return this.backendInstance=this.registry[e],this.setupRegisteredKernels(),this.profiler=new qs(this.backendInstance),!0}setupRegisteredKernels(){gs(this.backendName).forEach(e=>{null!=e.setupFunc&&e.setupFunc(this.backendInstance)})}disposeRegisteredKernels(e){gs(e).forEach(t=>{null!=t.disposeFunc&&t.disposeFunc(this.registry[e])})}initializeBackend(e){let t=this.registryFactory[e];if(null==t)throw new Error(`Cannot initialize backend ${e}, no registration found.`);try{let n=t.factory();if(!n||n instanceof Be||"function"!=typeof n.then)return this.registry[e]=n,{success:!0,asyncInit:!1};{let t=++this.pendingBackendInitId,a=n.then(n=>!(t<this.pendingBackendInitId||(this.registry[e]=n,this.pendingBackendInit=null,0))).catch(e=>(t<this.pendingBackendInitId||(this.pendingBackendInit=null,ds(),ds(e.stack||e.message)),!1));return this.pendingBackendInit=a,{success:a,asyncInit:!0}}}catch(n){return ds(),ds(n.stack||n.message),{success:!1,asyncInit:!1}}}removeBackend(e){if(!(e in this.registryFactory))throw new Error(`${e} backend not found in registry`);this.backendName===e&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,e in this.registry&&(this.disposeRegisteredKernels(e),this.registry[e].dispose(),delete this.registry[e]),delete this.registryFactory[e],this.backendName===e&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)}getSortedBackends(){if(0===Object.keys(this.registryFactory).length)throw new Error("No backend found in registry.");return Object.keys(this.registryFactory).sort((e,t)=>this.registryFactory[t].priority-this.registryFactory[e].priority)}initializeBackendsAndReturnBest(){let e=this.getSortedBackends();for(let t=0;t<e.length;t++){let n=e[t],{success:a,asyncInit:r}=this.initializeBackend(n);if(r||a)return{name:n,asyncInit:r}}throw new Error("Could not initialize any backends, all backend initializations failed.")}moveData(e,t){let n=this.state.tensorInfo.get(t),a=n.backend,r=this.readSync(t),s=a.refCount(t);a.disposeData(t,!0),n.backend=e,e.move(t,r,n.shape,n.dtype,s),this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack[this.state.numDataMovesStack.length-1]++}tidy(e,t){let n,a=null;if(null==t){if("function"!=typeof e)throw new Error("Please provide a function to tidy()");t=e}else{if("string"!=typeof e&&!(e instanceof String))throw new Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof t)throw new Error("When calling with two arguments, the 2nd argument to tidy() must be a function");a=e}return this.scopedRun(()=>this.startScope(a),()=>this.endScope(n),()=>(n=t(),n))}scopedRun(e,t,n){e();try{let e=n();return t(),e}catch(tQ){throw t(),tQ}}nextTensorId(){return e.nextTensorId++}nextVariableId(){return e.nextVariableId++}clone(e){let t=Ci.runKernel(la,{x:e}),n={x:e};return this.addTapeNode(this.state.activeScope.name,n,[t],e=>({x:()=>{let t={x:e};return Ci.runKernel(gn,t,{dtype:"float32"})}}),[],{}),t}runKernel(e,t,n){if(null==this.backendName&&this.backend,null==ms(e,this.backendName))throw new Error(`Kernel '${e}' not registered for backend '${this.backendName}'`);return this.runKernelFunc({kernelName:e,inputs:t,attrs:n})}shouldCheckForMemLeaks(){return this.ENV.getBool("IS_TEST")}checkKernelForMemLeak(e,t,n){let a=this.backend.numDataIds(),r=0;n.forEach(e=>{r+="complex64"===e.dtype?3:1});let s=this.state.numDataMovesStack[this.state.numDataMovesStack.length-1],i=a-t-r-s;if(i>0)throw new Error(`Backend '${this.backendName}' has an internal memory leak (${i} data ids) after running '${e}'`)}runKernelFunc(e){let t,n,a=[],r=this.isTapeOn(),s=this.state.numBytes,i=this.state.numTensors;this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack.push(0),null==this.backendName&&this.backend;let o,l=Ni(e)?e.kernelName:null!=this.state.activeScope?this.state.activeScope.name:"";if(Ni(e)){let{kernelName:t,inputs:s,attrs:i}=e;null==this.backendName&&this.backend;let l=ms(t,this.backendName);Ze(null!=l,()=>`Cannot find registered kernel '${t}' for backend '${this.backendName}'`),n=()=>{let e=this.backend.numDataIds();o=l.kernelFunc({inputs:s,attrs:i,backend:this.backend});let n=Array.isArray(o)?o:[o];this.shouldCheckForMemLeaks()&&this.checkKernelForMemLeak(t,e,n);let u=n.map(e=>null!=e.rank?e:this.makeTensorFromTensorInfo(e));if(r){let e=this.getTensorsForGradient(t,s,u);a=this.saveTensorsForBackwardMode(e)}return u}}else{let{forwardFunc:t}=e,s=e=>{r&&(a=e.map(e=>this.keep(this.clone(e))))};n=()=>{let e=this.backend.numDataIds();o=this.tidy(()=>t(this.backend,s));let n=Array.isArray(o)?o:[o];return this.shouldCheckForMemLeaks()&&this.checkKernelForMemLeak(l,e,n),n}}let u,{inputs:d,attrs:c}=e,p=Ni(e)?null:e.backwardsFunc;return this.scopedRun(()=>this.state.kernelDepth++,()=>this.state.kernelDepth--,()=>{this.ENV.getBool("DEBUG")||this.state.profiling?(u=this.profiler.profileKernel(l,d,()=>n()),this.ENV.getBool("DEBUG")&&this.profiler.logKernelProfile(u),t=u.outputs):t=n()}),r&&this.addTapeNode(l,d,t,p,a,c),this.state.profiling&&this.state.activeProfile.kernels.push({name:l,bytesAdded:this.state.numBytes-s,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-i,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(d).map(e=>null!=d[e]?d[e].shape:null),outputShapes:t.map(e=>e.shape),kernelTimeMs:u.timeMs,extraInfo:u.extraInfo}),Array.isArray(o)?t:t[0]}saveTensorsForBackwardMode(e){return e.map(e=>this.keep(this.clone(e)))}getTensorsForGradient(e,t,n){let a=fs(e);if(null!=a){let e,r=a.inputsToSave||[],s=a.outputsToSave||[];a.saveAllInputs?(Ze(Array.isArray(t),()=>"saveAllInputs is true, expected inputs to be an array."),e=Object.keys(t).map(e=>t[e])):e=r.map(e=>t[e]);let i=n.filter((e,t)=>s[t]);return e.concat(i)}return[]}makeTensor(e,t,n,a){if(null==e)throw new Error("Values passed to engine.makeTensor() are null");n=n||"float32",a=a||this.backend;let r=e;"string"===n&&wt(e[0])&&(r=e.map(e=>Vs(e)));let s=a.write(r,t,n),i=new ri(t,n,s,this.nextTensorId());if(this.trackTensor(i,a),"string"===n){let e=this.state.tensorInfo.get(s),t=yt(r);this.state.numBytes+=t-e.bytes,e.bytes=t}return i}makeTensorFromDataId(e,t,n,a){let r={dataId:e,shape:t,dtype:n=n||"float32"};return this.makeTensorFromTensorInfo(r,a)}makeTensorFromTensorInfo(e,t){let{dataId:n,shape:a,dtype:r}=e,s=new ri(a,r,n,this.nextTensorId());return this.trackTensor(s,t),s}makeVariable(e,t=!0,n,a){n=n||this.nextVariableId().toString(),null!=a&&a!==e.dtype&&(e=e.cast(a));let r=new ii(e,t,n,this.nextTensorId());if(null!=this.state.registeredVariables[r.name])throw new Error(`Variable with name ${r.name} was already registered`);return this.state.registeredVariables[r.name]=r,this.incRef(r,this.backend),r}trackTensor(e,t){this.state.numTensors++,"string"===e.dtype&&this.state.numStringTensors++;let n=0;"complex64"!==e.dtype&&"string"!==e.dtype&&(n=e.size*bt(e.dtype)),this.state.numBytes+=n,this.state.tensorInfo.has(e.dataId)||(this.state.numDataBuffers++,this.state.tensorInfo.set(e.dataId,{backend:t||this.backend,dtype:e.dtype,shape:e.shape,bytes:n})),e instanceof ii||this.track(e)}incRef(e,t){this.trackTensor(e,t),this.backend.incRef(e.dataId)}removeDataId(e,t){this.state.tensorInfo.has(e)&&this.state.tensorInfo.get(e).backend===t&&(this.state.tensorInfo.delete(e),this.state.numDataBuffers--)}disposeTensor(e){if(!this.state.tensorInfo.has(e.dataId))return;let t=this.state.tensorInfo.get(e.dataId);if(this.state.numTensors--,"string"===e.dtype&&(this.state.numStringTensors--,this.state.numBytes-=t.bytes),"complex64"!==e.dtype&&"string"!==e.dtype){let t=e.size*bt(e.dtype);this.state.numBytes-=t}t.backend.disposeData(e.dataId)&&this.removeDataId(e.dataId,t.backend)}disposeVariables(){for(let e in this.state.registeredVariables){let t=this.state.registeredVariables[e];this.disposeVariable(t)}}disposeVariable(e){this.disposeTensor(e),null!=this.state.registeredVariables[e.name]&&delete this.state.registeredVariables[e.name]}memory(){let e=this.backend.memory();return e.numTensors=this.state.numTensors,e.numDataBuffers=this.state.numDataBuffers,e.numBytes=this.state.numBytes,this.state.numStringTensors>0&&(e.unreliable=!0,null==e.reasons&&(e.reasons=[]),e.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),e}async profile(e){this.state.profiling=!0;let t=this.state.numBytes,n=this.state.numTensors;this.state.activeProfile.kernels=[],this.state.activeProfile.result=await e(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max(...this.state.activeProfile.kernels.map(e=>e.totalBytesSnapshot)),this.state.activeProfile.newBytes=this.state.numBytes-t,this.state.activeProfile.newTensors=this.state.numTensors-n;for(let a of this.state.activeProfile.kernels)a.kernelTimeMs=await a.kernelTimeMs,a.extraInfo=await a.extraInfo;return this.state.activeProfile}isTapeOn(){return this.state.gradientDepth>0&&0===this.state.kernelDepth}addTapeNode(e,t,n,a,r,s){let i={id:this.state.nextTapeNodeId++,kernelName:e,inputs:t,outputs:n,saved:r},o=fs(e);null!=o&&(a=o.gradFunc),null!=a&&(i.gradient=e=>(e=e.map((e,t)=>{if(null==e){let e=n[t],a=$t(e.size,e.dtype);return this.makeTensor(a,e.shape,e.dtype)}return e}),a(e.length>1?e:e[0],r,s))),this.state.activeTape.push(i)}keep(e){return e.kept=!0,e}startTape(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++}endTape(){this.state.gradientDepth--}startScope(e){let t={track:[],name:"unnamed scope",id:this.state.nextScopeId++};e&&(t.name=e),this.state.scopeStack.push(t),this.state.activeScope=t}endScope(e){let t=vi(e),n=new Set(t.map(e=>e.id));for(let r=0;r<this.state.activeScope.track.length;r++){let e=this.state.activeScope.track[r];!e.kept&&!n.has(e.id)&&e.dispose()}let a=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],t.forEach(e=>{!e.kept&&e.scopeId===a.id&&this.track(e)})}gradients(e,t,n,a=!1){if(Ze(t.length>0,()=>"gradients() received an empty list of xs."),null!=n&&"float32"!==n.dtype)throw new Error(`dy must have 'float32' dtype, but has '${n.dtype}'`);let r=this.scopedRun(()=>this.startTape(),()=>this.endTape(),()=>this.tidy("forward",e));Ze(r instanceof ri,()=>"The result y returned by f() must be a tensor.");let s=function(e,t,n){let a={},r={};for(let l=0;l<t.length;l++)a[t[l].id]=!0;for(let l=0;l<e.length;l++){let n=e[l],s=n.inputs;for(let e in s){let i=s[e],o=!1;for(let e=0;e<t.length;e++)if(a[i.id]){n.outputs.forEach(e=>a[e.id]=!0),o=!0,r[n.id]=!0;break}if(o)break}}let s={};s[n.id]=!0;let i={};for(let l=e.length-1;l>=0;l--){let t=e[l],n=t.inputs;for(let e=0;e<t.outputs.length;e++)if(s[t.outputs[e].id]){for(let e in n)s[n[e].id]=!0,i[t.id]=!0;break}}let o=[];for(let l=0;l<e.length;l++){let t=e[l];if(r[t.id]&&i[t.id]){let e={};for(let r in t.inputs){let n=t.inputs[r];a[n.id]&&(e[r]=n)}let n=Object.assign({},t);n.inputs=e,n.outputs=t.outputs,o.push(n)}}return o}(this.state.activeTape,t,r);if(!a&&0===s.length&&t.length>0)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",()=>{let e={};e[r.id]=null==n?function(e){let t=At(et(e),"float32");return Ci.makeTensor(t,e,"float32")}(r.shape):n,function(e,t,n,a){for(let r=t.length-1;r>=0;r--){let s=t[r],i=[];if(s.outputs.forEach(t=>{let n=e[t.id];null!=n?i.push(n):i.push(null)}),null==s.gradient)throw new Error(`Cannot compute gradient: gradient function not found for ${s.kernelName}.`);let o=s.gradient(i);for(let t in s.inputs){if(!(t in o))throw new Error(`Cannot backprop through input ${t}. Available gradients found: ${Object.keys(o)}.`);let r=n(()=>o[t]());if("float32"!==r.dtype)throw new Error(`Error in gradient for op ${s.kernelName}. The gradient of input ${t} must have 'float32' dtype, but has '${r.dtype}'`);let i=s.inputs[t];if(!at(r.shape,i.shape))throw new Error(`Error in gradient for op ${s.kernelName}. The gradient of input '${t}' has shape '${r.shape}', which does not match the shape of the input '${i.shape}'`);if(null==e[i.id])e[i.id]=r;else{let t=e[i.id];e[i.id]=a(t,r),t.dispose()}}}}(e,s,e=>this.tidy(e),Ti);let a=t.map(t=>e[t.id]);return 0===this.state.gradientDepth&&(this.state.activeTape.forEach(e=>{for(let t of e.saved)t.dispose()}),this.state.activeTape=null),{value:r,grads:a}})}customGrad(e){return Ze(St(e),()=>"The f passed in customGrad(f) must be a function."),(...t)=>{Ze(t.every(e=>e instanceof ri),()=>"The args passed in customGrad(f)(x1, x2,...) must all be tensors");let n,a={};return t.forEach((e,t)=>{a[t]=e}),this.runKernelFunc({forwardFunc:(a,r)=>(n=e(...t,r),Ze(n.value instanceof ri,()=>"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"),Ze(St(n.gradFunc),()=>"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."),n.value),backwardsFunc:(e,a)=>{let r=n.gradFunc(e,a),s=Array.isArray(r)?r:[r];Ze(s.length===t.length,()=>"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."),Ze(s.every(e=>e instanceof ri),()=>"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors.");let i={};return s.forEach((e,t)=>{i[t]=()=>e}),i},inputs:a})}}readSync(e){return this.state.tensorInfo.get(e).backend.readSync(e)}read(e){return this.state.tensorInfo.get(e).backend.read(e)}readToGPU(e,t){return this.state.tensorInfo.get(e).backend.readToGPU(e,t)}async time(e){let t=Bs(),n=await this.backend.time(e);return n.wallMs=Bs()-t,n}track(e){return null!=this.state.activeScope&&(e.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(e)),e}get registeredVariables(){return this.state.registeredVariables}reset(){this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new Si;for(let e in this.registry)this.disposeRegisteredKernels(e),this.registry[e].dispose(),delete this.registry[e];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null}};function _i(){let e=Vt();if(null==e._tfengine){let t=new Lt(e);e._tfengine=new Ii(t)}return function(e){Wt=e}(e._tfengine.ENV),function(e){ni=e}(()=>e._tfengine),e._tfengine}Ii.nextTensorId=0,Ii.nextVariableId=0;var Ci=_i();function Ti(e,t){let n={a:e,b:t};return Ci.runKernel(Kt,n)}var Ei,Ai={};function $i(e){Ei=e}function Ri(e){if(void 0!==Ei)return Ei;if(e||"undefined"!=typeof navigator&&null!=navigator){if(e||(e=navigator),"ReactNative"===e.product)return!0;let t=e.userAgent||e.vendor||("undefined"!=typeof window?window.opera:"");if(!t){let t=e;return t.userAgentData&&t.userAgentData.mobile}return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4))}return!1}function Fi(){return"undefined"!=typeof window&&null!=window.document||"undefined"!=typeof WorkerGlobalScope}xe(Ai,{isBrowser:()=>Fi,isMobile:()=>Ri,mockIsMobile:()=>$i});var Di=Pt();function Mi(e,t){let n=e;if(Gs(e))return"string"===t?[]:[e.length];if(gi(e)){let t=e.channels||"RGBA";return[e.height,e.width*t.length]}if(xi(e))return[e.buffer.size/(null==t?4:bt(t))];if(!Array.isArray(e))return[];let a=[];for(;Array.isArray(n)||Gs(n)&&"string"!==t;)a.push(n.length),n=n[0];return Array.isArray(e)&&Pt().getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&Oi(e,a,[]),a}function Oi(e,t,n){if(n=n||[],!Array.isArray(e)&&!Gs(e))return void Ze(0===t.length,()=>`Element arr[${n.join("][")}] is a primitive, but should be an array/TypedArray of ${t[0]} elements`);Ze(t.length>0,()=>`Element arr[${n.join("][")}] should be a primitive, but is an array of ${e.length} elements`),Ze(e.length===t[0],()=>`Element arr[${n.join("][")}] should have ${t[0]} elements, but has ${e.length} elements`);let a=t.slice(1);for(let r=0;r<e.length;++r)Oi(e[r],a,n.concat(r))}function ji(e,t,n,a){if("string_or_numeric"!==e){if(null==e)throw new Error("Expected dtype cannot be null.");if("numeric"!==e&&e!==t||"numeric"===e&&"string"===t)throw new Error(`Argument '${n}' passed to '${a}' must be ${e} tensor, but got ${t} tensor`)}}function Li(e,t,n,a="numeric"){if(e instanceof si())return ji(a,e.dtype,t,n),e;let r=Nt(e);if("string"!==r&&["bool","int32","float32"].indexOf(a)>=0&&(r=a),ji(a,r,t,n),null==e||!Gs(e)&&!Array.isArray(e)&&"number"!=typeof e&&"boolean"!=typeof e&&"string"!=typeof e){let a=null==e?"null":e.constructor.name;throw new Error(`Argument '${t}' passed to '${n}' must be a Tensor or TensorLike, but got '${a}'`)}let s=Mi(e,r);!Gs(e)&&!Array.isArray(e)&&(e=[e]);let i="string"!==r?Ps(e,r):Hs(e,[],!0);return Ci.makeTensor(i,s,r)}function zi(e,t,n,a="numeric"){if(!Array.isArray(e))throw new Error(`Argument ${t} passed to ${n} must be a \`Tensor[]\` or \`TensorLike[]\``);return e.map((e,r)=>Li(e,`${t}[${r}]`,n,a))}Di.registerFlag("DEBUG",()=>!1,e=>{}),Di.registerFlag("IS_BROWSER",()=>Fi()),Di.registerFlag("IS_NODE",()=>"undefined"!=typeof process&&void 0!==process.versions&&void 0!==process.versions.node),Di.registerFlag("IS_CHROME",()=>"undefined"!=typeof navigator&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)),Di.registerFlag("IS_SAFARI",()=>"undefined"!=typeof navigator&&null!=navigator&&null!=navigator.userAgent&&/Safari/.test(navigator.userAgent)&&/Apple/.test(navigator.vendor)),Di.registerFlag("PROD",()=>!1),Di.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",()=>Di.getBool("DEBUG")),Di.registerFlag("DEPRECATION_WARNINGS_ENABLED",()=>!0),Di.registerFlag("IS_TEST",()=>!1),Di.registerFlag("CHECK_COMPUTATION_FOR_ERRORS",()=>Di.getBool("DEBUG")),Di.registerFlag("WRAP_TO_IMAGEBITMAP",()=>!1),Di.registerFlag("CANVAS2D_WILL_READ_FREQUENTLY_FOR_GPU",()=>!1),Di.registerFlag("USE_SETTIMEOUTCUSTOM",()=>!1);var Pi="__op";function Bi(e){let t=Object.keys(e);if(1!==t.length)throw new Error(`Please provide an object with a single key (operation name) mapping to a function. Got an object with ${t.length} keys.`);let n=t[0],a=e[n];n.endsWith("_")&&(n=n.substring(0,n.length-1)),n+=Pi;let r=(...e)=>{Ci.startScope(n);try{let t=a(...e);return Ot(t),Ci.endScope(t),t}catch(t){throw Ci.endScope(null),t}};return Object.defineProperty(r,"name",{value:n,configurable:!0}),r}var Wi=Bi({complex_:function(e,t){let n=Li(e,"real","complex"),a=Li(t,"imag","complex");Je(n.shape,a.shape,`real and imag shapes, ${n.shape} and ${a.shape}, must match in call to tf.complex().`);let r={real:n,imag:a};return Ci.runKernel(yn,r)}});function Vi(e,t,n,a){if(null==a)a=Nt(e);else if("complex64"===a)throw new Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(xi(e)||gi(e)){if("float32"!==a&&"int32"!==a)throw new Error(`Creating tensor from GPU data only supports 'float32'|'int32' dtype, while the dtype is ${a}.`);return Ci.backend.createTensorFromGPUData(e,t||n,a)}if(!Gs(e)&&!Array.isArray(e)&&"number"!=typeof e&&"boolean"!=typeof e&&"string"!=typeof e)throw new Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=t){Ft(t);let e=et(t),a=et(n);Ze(e===a,()=>`Based on the provided shape, [${t}], the tensor should have ${e} values but has ${a}`);for(let r=0;r<n.length;++r){let e=n[r],a=r!==n.length-1||e!==et(t.slice(r));Ze(n[r]===t[r]||!a,()=>`Error creating a new Tensor. Inferred shape (${n}) does not match the provided shape (${t}). `)}}return!Gs(e)&&!Array.isArray(e)&&(e=[e]),t=t||n,e="string"!==a?Ps(e,a):Hs(e,[],!0),Ci.makeTensor(e,t,a)}function Ui(e,t,n){return Vi(e,t,Mi(e,n),n)}var Gi={float32:4,float16:2,int32:4,uint16:2,uint8:1,bool:1,complex64:8},Hi=class e{static join(t){return new e(t).slice()}constructor(e){if(this.shards=[],this.previousShardIndex=0,null==e||(e instanceof Array||(e=[e]),0===(e=e.map(e=>Gs(e)?e.buffer:e)).length))return;this.bufferUniformSize=e[0].byteLength;let t=0;for(let n=0;n<e.length;n++){let a=e[n];n!==e.length-1&&a.byteLength!==this.bufferUniformSize&&(this.bufferUniformSize=void 0);let r=t+a.byteLength;this.shards.push({buffer:a,start:t,end:r}),t=r}0===this.shards.length&&(this.byteLength=0),this.byteLength=this.shards[this.shards.length-1].end}slice(e=0,t=this.byteLength){if(0===this.shards.length)return new ArrayBuffer(0);if(e=isNaN(Number(e))?0:e,t=isNaN(Number(t))?0:t,e=Math.max(0,e),(t=Math.min(this.byteLength,t))<=e)return new ArrayBuffer(0);let n=this.findShardForByte(e);if(-1===n)throw new Error(`Could not find start shard for byte ${e}`);let a=new ArrayBuffer(t-e),r=new Uint8Array(a),s=0;for(let i=n;i<this.shards.length;i++){let n=this.shards[i],a=e+s-n.start,o=s,l=Math.min(t,n.end)-n.start,u=new Uint8Array(n.buffer,a,l-a);if(r.set(u,o),s+=u.length,t<n.end)break}return a}findShardForByte(e){if(0===this.shards.length||e<0||e>=this.byteLength)return-1;if(null!=this.bufferUniformSize)return this.previousShardIndex=Math.floor(e/this.bufferUniformSize),this.previousShardIndex;function t(t){return e<t.start?-1:e>=t.end?1:0}if(0===t(this.shards[this.previousShardIndex]))return this.previousShardIndex;let n=function(e,t){let n=0,a=e.length;for(;n<=a;){let r=Math.floor((a-n)/2)+n,s=t(e[r]);if(0===s)return r;s<0?a=r:n=r+1}return-1}(this.shards,t);return-1===n?-1:(this.previousShardIndex=n,this.previousShardIndex)}};function qi(){Pt().set("PROD",!0)}function Ki(){Pt().set("DEBUG",!0)}function Xi(){Pt().set("DEPRECATION_WARNINGS_ENABLED",!1)}function Yi(e){Pt().getBool("DEPRECATION_WARNINGS_ENABLED")}function Zi(){Ci.disposeVariables()}function Ji(){return Ci}function Qi(){return Ci.memory()}function eo(e){return Ci.profile(e)}function to(e,t){return Ci.tidy(e,t)}function no(e){vi(e).forEach(e=>e.dispose())}function ao(e){return Ci.keep(e)}function ro(e){return Ci.time(e)}function so(e){return Ci.setBackend(e)}function io(){return Ci.ready()}function oo(){return Ci.backendName}function lo(e){Ci.removeBackend(e)}function uo(e){return Ci.findBackend(e)}function co(e){return Ci.findBackendFactory(e)}function po(e,t,n=1){return Ci.registerBackend(e,t,n)}function ho(){return Ci.backend}function mo(e,t){Pt().setPlatform(e,t)}async function fo(e,t){let n=[],a=[],r=Array.isArray(e)?e.map(e=>e.name):Object.keys(e);for(let s=0;s<r.length;++s){let i=r[s],o=Array.isArray(e)?e[s].tensor:e[i];if("float32"!==o.dtype&&"int32"!==o.dtype&&"bool"!==o.dtype&&"string"!==o.dtype&&"complex64"!==o.dtype)throw new Error(`Unsupported dtype in weight '${i}': ${o.dtype}`);let l={name:i,shape:o.shape,dtype:o.dtype};if("string"===o.dtype){let e=new Promise(async e=>{let t=await o.bytes(),n=t.reduce((e,t)=>e+t.length,0)+4*t.length,a=new Uint8Array(n),r=0;for(let s=0;s<t.length;s++){let e=t[s],n=new Uint8Array(new Uint32Array([e.length]).buffer);a.set(n,r),r+=4,a.set(e,r),r+=e.length}e(a)});a.push(e)}else a.push(o.data());null!=t&&(l.group=t),n.push(l)}return{data:ko(await Promise.all(a)),specs:n}}function go(e,t){let n=new Hi(e),a={},r=0;for(let s of t){let e=xo(s,(e,t)=>n.slice(r+e,r+t));a[s.name]=yo(s,n.slice(r,r+e)),r+=e}return a}function xo(e,t){let n,a=et(e.shape);if("quantization"in e){let t=e.quantization;n=Gi[t.dtype]}else{if("string"===e.dtype){let e=0;for(let n=0;n<a;n++)e+=4+new Uint32Array(t(e,e+4))[0];return e}n=Gi[e.dtype]}return a*n}async function bo(e,t){let n,a=et(e.shape);if("quantization"in e){let t=e.quantization;n=Gi[t.dtype]}else{if("string"===e.dtype){let e=0;for(let n=0;n<a;n++)e+=4+new Uint32Array(await t(e,e+4))[0];return e}n=Gi[e.dtype]}return a*n}function yo(e,t){let n,a=e.name,r=e.dtype,s=e.shape,i=et(s),o=0;if("quantization"in e){let s=e.quantization;if("uint8"===s.dtype||"uint16"===s.dtype){if(!("min"in s)||!("scale"in s))throw new Error(`Weight ${e.name} with quantization ${s.dtype} doesn't have corresponding metadata min and scale.`)}else{if("float16"!==s.dtype)throw new Error(`Weight ${e.name} has unknown quantization dtype ${s.dtype}. Supported quantization dtypes are: 'uint8', 'uint16', and 'float16'.`);if("float32"!==r)throw new Error(`Weight ${e.name} is quantized with ${s.dtype} which only supports weights of type float32 not ${r}.`)}let l=Gi[s.dtype],u="uint8"===s.dtype?new Uint8Array(t):new Uint16Array(t);if("float32"===r)if("uint8"===s.dtype||"uint16"===s.dtype){n=new Float32Array(u.length);for(let e=0;e<u.length;e++){let t=u[e];n[e]=t*s.scale+s.min}}else{if("float16"!==s.dtype)throw new Error(`Unsupported quantization type ${s.dtype} for weight type float32.`);n=function(){let e=function(){let e=e=>{let t=e<<13,n=0;for(;!(8388608&t);)n-=8388608,t<<=1;return t&=-8388609,n+=947912704,t|n},t=new Uint32Array(2048);t[0]=0;for(let n=1;n<1024;n++)t[n]=e(n);for(let n=1024;n<2048;n++)t[n]=939524096+(n-1024<<13);return t}(),t=function(){let e=new Uint32Array(64);e[0]=0,e[31]=1199570944,e[32]=2147483648,e[63]=3347054592;for(let t=1;t<31;t++)e[t]=t<<23;for(let t=33;t<63;t++)e[t]=2147483648+(t-32<<23);return e}(),n=function(){let e=new Uint32Array(64);for(let t=0;t<64;t++)e[t]=1024;return e[0]=e[32]=0,e}();return a=>{let r=new ArrayBuffer(4*a.length),s=new Uint32Array(r);for(let i=0;i<a.length;i++){let r=a[i],o=e[n[r>>10]+(1023&r)]+t[r>>10];s[i]=o}return new Float32Array(r)}}()(u)}else{if("int32"!==r)throw new Error(`Unsupported dtype in weight '${a}': ${r}`);if("uint8"!==s.dtype&&"uint16"!==s.dtype)throw new Error(`Unsupported quantization type ${s.dtype} for weight type int32.`);n=new Int32Array(u.length);for(let e=0;e<u.length;e++){let t=u[e];n[e]=Math.round(t*s.scale+s.min)}}o+=i*l}else if("string"===r){let a=et(e.shape);n=[];for(let e=0;e<a;e++){let e=new Uint32Array(t.slice(o,o+4))[0];o+=4;let a=new Uint8Array(t.slice(o,o+e));n.push(a),o+=e}}else{let e=Gi[r];if("float32"===r)n=new Float32Array(t);else if("int32"===r)n=new Int32Array(t);else{if("bool"!==r){if("complex64"===r){n=new Float32Array(t);let e=new Float32Array(n.length/2),a=new Float32Array(n.length/2);for(let t=0;t<e.length;t++)e[t]=n[2*t],a[t]=n[2*t+1];let r=Ui(e,s,"float32"),i=Ui(a,s,"float32"),o=Wi(r,i);return r.dispose(),i.dispose(),o}throw new Error(`Unsupported dtype in weight '${a}': ${r}`)}n=new Uint8Array(t)}o+=i*e}return Ui(n,s,r)}async function wo(e,t,n){let a=new Uint8Array(t);for(;a.byteLength<n;){let{done:t,value:r}=await e.read();if(t&&null==r){let e=n-a.byteLength;throw new Error(`Reader is done but ${e} bytes are still expected`)}let s=new Uint8Array(a.length+r.byteLength);s.set(a,0),s.set(new Uint8Array(r),a.length),a=s}return a.buffer}async function vo(e,t){let n={},a=e.getReader(),r=new ArrayBuffer(0);for(let s of t){let e=await bo(s,async(e,t)=>(r=await wo(a,r,t),r.slice(e,t)));r=await wo(a,r,e);let t=r.slice(0,e);r=r.slice(e);let i=yo(s,t);if(n[s.name]=i,"webgpu"===oo()){let e=ho();"uploadToGPU"in e&&et(i.shape)>=Pt().get("WEBGPU_CPU_HANDOFF_SIZE_THRESHOLD")&&e.uploadToGPU(i.dataId)}}return n}function ko(e){if(null===e)throw new Error(`Invalid input value: ${JSON.stringify(e)}`);let t=0,n=[];e.forEach(e=>{if(t+=e.byteLength,n.push(e.byteLength===e.buffer.byteLength?e:new e.constructor(e)),!(e instanceof Float32Array||e instanceof Int32Array||e instanceof Uint8Array))throw new Error(`Unsupported TypedArray subtype: ${e.constructor.name}`)});let a=new Uint8Array(t),r=0;return n.forEach(e=>{a.set(new Uint8Array(e.buffer),r),r+=e.byteLength}),a.buffer}var No="undefined"!=typeof Buffer&&("undefined"==typeof Blob||"undefined"==typeof atob||"undefined"==typeof btoa);function So(e){return No?Buffer.byteLength(e,"utf8"):new Blob([e]).size}function Io(e){return Hi.join(e)}function _o(e){for(e=e.trim();e.endsWith("/");)e=e.slice(0,e.length-1);let t=e.split("/");return t[t.length-1]}function Co(e,t){let n={modelTopology:e.modelTopology,format:e.format,generatedBy:e.generatedBy,convertedBy:e.convertedBy,weightsManifest:t};return null!=e.signature&&(n.signature=e.signature),null!=e.userDefinedMetadata&&(n.userDefinedMetadata=e.userDefinedMetadata),null!=e.modelInitializer&&(n.modelInitializer=e.modelInitializer),null!=e.initializerSignature&&(n.initializerSignature=e.initializerSignature),null!=e.trainingConfig&&(n.trainingConfig=e.trainingConfig),n}function To(e,t,n){let a={modelTopology:e.modelTopology,format:e.format,generatedBy:e.generatedBy,convertedBy:e.convertedBy};if(null!=e.trainingConfig&&(a.trainingConfig=e.trainingConfig),null!=e.weightsManifest){if(!t)throw new Error("modelJSON has weightsManifest but weightSpecs is null");if(!n)throw new Error("modelJSON has weightsManifest but weightData is null");a.weightSpecs=t,a.weightData=n}return null!=e.signature&&(a.signature=e.signature),null!=e.userDefinedMetadata&&(a.userDefinedMetadata=e.userDefinedMetadata),null!=e.modelInitializer&&(a.modelInitializer=e.modelInitializer),null!=e.initializerSignature&&(a.initializerSignature=e.initializerSignature),a}async function Eo(e,t){let n,a;return null!=e.weightsManifest&&([n,a]=await t(e.weightsManifest)),To(e,n,a)}function Ao(e){if(e.modelTopology instanceof ArrayBuffer)throw new Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==e.modelTopology?0:So(JSON.stringify(e.modelTopology)),weightSpecsBytes:null==e.weightSpecs?0:So(JSON.stringify(e.weightSpecs)),weightDataBytes:null==e.weightData?0:new Hi(e.weightData).byteLength}}function $o(e){let t=[];for(let n of e)t.push(...n.weights);return t}var Ro=class e{constructor(){this.saveRouters=[],this.loadRouters=[]}static getInstance(){return null==e.instance&&(e.instance=new e),e.instance}static registerSaveRouter(t){e.getInstance().saveRouters.push(t)}static registerLoadRouter(t){e.getInstance().loadRouters.push(t)}static getSaveHandlers(t){return e.getHandlers(t,"save")}static getLoadHandlers(t,n){return e.getHandlers(t,"load",n)}static getHandlers(t,n,a){let r=[];return("load"===n?e.getInstance().loadRouters:e.getInstance().saveRouters).forEach(e=>{let n=e(t,a);null!==n&&r.push(n)}),r}},Fo=e=>Ro.registerSaveRouter(e),Do=e=>Ro.registerLoadRouter(e),Mo=e=>Ro.getSaveHandlers(e),Oo=(e,t)=>Ro.getLoadHandlers(e,t),jo="tensorflowjs",Lo="models_store",zo="model_info_store";function Po(){if(!Pt().getBool("IS_BROWSER"))throw new Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");let e="undefined"==typeof window?self:window,t=e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB||e.shimIndexedDB;if(null==t)throw new Error("The current browser does not appear to support IndexedDB.");return t}function Bo(e){let t=e.result;t.createObjectStore(Lo,{keyPath:"modelPath"}),t.createObjectStore(zo,{keyPath:"modelPath"})}var Wo=class{constructor(e){if(this.indexedDB=Po(),null==e||!e)throw new Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=e}async save(e){if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return this.databaseAction(this.modelPath,e)}async load(){return this.databaseAction(this.modelPath)}databaseAction(e,t){return new Promise((e,n)=>{let a=this.indexedDB.open(jo,1);a.onupgradeneeded=()=>Bo(a),a.onsuccess=()=>{let r=a.result;if(null==t){let t=r.transaction(Lo,"readonly"),a=t.objectStore(Lo).get(this.modelPath);a.onsuccess=()=>{if(null==a.result)return r.close(),n(new Error(`Cannot find model with path '${this.modelPath}' in IndexedDB.`));e(a.result.modelArtifacts)},a.onerror=e=>(r.close(),n(a.error)),t.oncomplete=()=>r.close()}else{t.weightData=Hi.join(t.weightData);let a,i,o=Ao(t),l=r.transaction(zo,"readwrite"),u=l.objectStore(zo);try{a=u.put({modelPath:this.modelPath,modelArtifactsInfo:o})}catch(s){return n(s)}a.onsuccess=()=>{i=r.transaction(Lo,"readwrite");let a,s=i.objectStore(Lo);try{a=s.put({modelPath:this.modelPath,modelArtifacts:t,modelArtifactsInfo:o})}catch(d){return n(d)}a.onsuccess=()=>e({modelArtifactsInfo:o}),a.onerror=e=>{u=l.objectStore(zo);let t=u.delete(this.modelPath);t.onsuccess=()=>(r.close(),n(a.error)),t.onerror=e=>(r.close(),n(a.error))}},a.onerror=e=>(r.close(),n(a.error)),l.oncomplete=()=>{null==i?r.close():i.oncomplete=()=>r.close()}}},a.onerror=e=>n(a.error)})}};Wo.URL_SCHEME="indexeddb://";var Vo=e=>Pt().getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(Wo.URL_SCHEME)?function(e){return new Wo(e)}(e.slice(Wo.URL_SCHEME.length)):null;Ro.registerSaveRouter(Vo),Ro.registerLoadRouter(Vo);var Uo="/",Go="tensorflowjs_models",Ho="info",qo="model_topology",Ko="weight_specs",Xo="weight_data",Yo="model_metadata";function Zo(e){return{info:[Go,e,Ho].join(Uo),topology:[Go,e,qo].join(Uo),weightSpecs:[Go,e,Ko].join(Uo),weightData:[Go,e,Xo].join(Uo),modelMetadata:[Go,e,Yo].join(Uo)}}function Jo(e){for(let t of Object.values(e))window.localStorage.removeItem(t)}function Qo(e){let t=e.split(Uo);if(t.length<3)throw new Error(`Invalid key format: ${e}`);return t.slice(1,t.length-1).join(Uo)}var el=class{constructor(e){if(!Pt().getBool("IS_BROWSER")||"undefined"==typeof window||void 0===window.localStorage)throw new Error("The current environment does not support local storage.");if(this.LS=window.localStorage,null==e||!e)throw new Error("For local storage, modelPath must not be null, undefined or empty.");this.modelPath=e,this.keys=Zo(this.modelPath)}async save(e){if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");{let n=JSON.stringify(e.modelTopology),a=JSON.stringify(e.weightSpecs),r=Ao(e),s=Hi.join(e.weightData);try{this.LS.setItem(this.keys.info,JSON.stringify(r)),this.LS.setItem(this.keys.topology,n),this.LS.setItem(this.keys.weightSpecs,a),this.LS.setItem(this.keys.weightData,function(e){if(No)return Buffer.from(e).toString("base64");let t=new Uint8Array(e),n="";for(let a=0,r=t.length;a<r;a++)n+=String.fromCharCode(t[a]);return btoa(n)}(s));let t={format:e.format,generatedBy:e.generatedBy,convertedBy:e.convertedBy,signature:null!=e.signature?e.signature:void 0,userDefinedMetadata:null!=e.userDefinedMetadata?e.userDefinedMetadata:void 0,modelInitializer:null!=e.modelInitializer?e.modelInitializer:void 0,initializerSignature:null!=e.initializerSignature?e.initializerSignature:void 0,trainingConfig:null!=e.trainingConfig?e.trainingConfig:void 0};return this.LS.setItem(this.keys.modelMetadata,JSON.stringify(t)),{modelArtifactsInfo:r}}catch(t){throw Jo(this.keys),new Error(`Failed to save model '${this.modelPath}' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes=${r.modelTopologyBytes}, weightSpecsBytes=${r.weightSpecsBytes}, weightDataBytes=${r.weightDataBytes}.`)}}}async load(){let e=JSON.parse(this.LS.getItem(this.keys.info));if(null==e)throw new Error(`In local storage, there is no model with name '${this.modelPath}'`);if("JSON"!==e.modelTopologyType)throw new Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");let t={},n=JSON.parse(this.LS.getItem(this.keys.topology));if(null==n)throw new Error(`In local storage, the topology of model '${this.modelPath}' is missing.`);t.modelTopology=n;let a=JSON.parse(this.LS.getItem(this.keys.weightSpecs));if(null==a)throw new Error(`In local storage, the weight specs of model '${this.modelPath}' are missing.`);t.weightSpecs=a;let r=this.LS.getItem(this.keys.modelMetadata);if(null!=r){let e=JSON.parse(r);t.format=e.format,t.generatedBy=e.generatedBy,t.convertedBy=e.convertedBy,null!=e.signature&&(t.signature=e.signature),null!=e.userDefinedMetadata&&(t.userDefinedMetadata=e.userDefinedMetadata),null!=e.modelInitializer&&(t.modelInitializer=e.modelInitializer),null!=e.initializerSignature&&(t.initializerSignature=e.initializerSignature),null!=e.trainingConfig&&(t.trainingConfig=e.trainingConfig)}let s=this.LS.getItem(this.keys.weightData);if(null==s)throw new Error(`In local storage, the binary weight values of model '${this.modelPath}' are missing.`);return t.weightData=function(e){if(No){let t=Buffer.from(e,"base64");return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}let t=atob(e),n=new Uint8Array(t.length);for(let a=0;a<t.length;++a)n.set([t.charCodeAt(a)],a);return n.buffer}(s),t}};el.URL_SCHEME="localstorage://";var tl=e=>Pt().getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(el.URL_SCHEME)?function(e){return new el(e)}(e.slice(el.URL_SCHEME.length)):null;Ro.registerSaveRouter(tl),Ro.registerLoadRouter(tl);var nl="://",al=class e{constructor(){this.managers={}}static getInstance(){return null==e.instance&&(e.instance=new e),e.instance}static registerManager(t,n){Ze(null!=t,()=>"scheme must not be undefined or null."),t.endsWith(nl)&&(t=t.slice(0,t.indexOf(nl))),Ze(t.length>0,()=>"scheme must not be an empty string.");let a=e.getInstance();Ze(null==a.managers[t],()=>`A model store manager is already registered for scheme '${t}'.`),a.managers[t]=n}static getManager(t){let n=e.getInstance().managers[t];if(null==n)throw new Error(`Cannot find model manager for scheme '${t}'`);return n}static getSchemes(){return Object.keys(e.getInstance().managers)}};function rl(e){if(-1===e.indexOf(nl))throw new Error(`The url string provided does not contain a scheme. Supported schemes are: ${al.getSchemes().join(",")}`);return{scheme:e.split(nl)[0],path:e.split(nl)[1]}}async function sl(e,t,n=!1){Ze(e!==t,()=>`Old path and new path are the same: '${e}'`);let a=Ro.getLoadHandlers(e);Ze(a.length>0,()=>`Copying failed because no load handler is found for source URL ${e}.`),Ze(a.length<2,()=>`Copying failed because more than one (${a.length}) load handlers for source URL ${e}.`);let r=a[0],s=Ro.getSaveHandlers(t);Ze(s.length>0,()=>`Copying failed because no save handler is found for destination URL ${t}.`),Ze(s.length<2,()=>`Copying failed because more than one (${a.length}) save handlers for destination URL ${t}.`);let i=s[0],o=rl(e).scheme,l=rl(e).path,u=o===rl(e).scheme,d=await r.load();n&&u&&await al.getManager(o).removeModel(l);let c=await i.save(d);return n&&!u&&await al.getManager(o).removeModel(l),c.modelArtifactsInfo}async function il(){let e=al.getSchemes(),t={};for(let n of e){let e=await al.getManager(n).listModels();for(let a in e)t[n+nl+a]=e[a]}return t}async function ol(e){let t=rl(e);return al.getManager(t.scheme).removeModel(t.path)}async function ll(e,t){return sl(e,t,!1)}async function ul(e,t){return sl(e,t,!0)}if(Pt().get("IS_BROWSER")){Pt().setPlatform("browser",new class{constructor(){this.messageName="setTimeoutCustom",this.functionRefs=[],this.handledMessageCount=0,this.hasEventListener=!1}fetch(e,t){return fetch(e,t)}now(){return performance.now()}encode(e,t){if("utf-8"!==t&&"utf8"!==t)throw new Error(`Browser's encoder only supports utf-8, but got ${t}`);return null==this.textEncoder&&(this.textEncoder=new TextEncoder),this.textEncoder.encode(e)}decode(e,t){return new TextDecoder(t).decode(e)}setTimeoutCustom(e,t){"undefined"!=typeof window&&Pt().getBool("USE_SETTIMEOUTCUSTOM")?(this.functionRefs.push(e),setTimeout(()=>{window.postMessage({name:this.messageName,index:this.functionRefs.length-1},"*")},t),this.hasEventListener||(this.hasEventListener=!0,window.addEventListener("message",e=>{e.source===window&&e.data.name===this.messageName&&(e.stopPropagation(),(0,this.functionRefs[e.data.index])(),this.handledMessageCount++,this.handledMessageCount===this.functionRefs.length&&(this.functionRefs=[],this.handledMessageCount=0))},!0))):setTimeout(e,t)}isTypedArray(e){return Ss(e)}});try{al.registerManager(el.URL_SCHEME,new class{constructor(){Ze(Pt().getBool("IS_BROWSER"),()=>"Current environment is not a web browser"),Ze("undefined"==typeof window||void 0!==window.localStorage,()=>"Current browser does not appear to support localStorage"),this.LS=window.localStorage}async listModels(){let e={},t=Go+Uo,n=Uo+Ho;for(let a=0;a<this.LS.length;++a){let r=this.LS.key(a);r.startsWith(t)&&r.endsWith(n)&&(e[Qo(r)]=JSON.parse(this.LS.getItem(r)))}return e}async removeModel(e){let t=Zo(e=function(e){return e.startsWith(el.URL_SCHEME)?e.slice(el.URL_SCHEME.length):e}(e));if(null==this.LS.getItem(t.info))throw new Error(`Cannot find model at path '${e}'`);let n=JSON.parse(this.LS.getItem(t.info));return Jo(t),n}})}catch(ie){}try{al.registerManager(Wo.URL_SCHEME,new class{constructor(){this.indexedDB=Po()}async listModels(){return new Promise((e,t)=>{let n=this.indexedDB.open(jo,1);n.onupgradeneeded=()=>Bo(n),n.onsuccess=()=>{let a=n.result,r=a.transaction(zo,"readonly"),s=r.objectStore(zo).getAll();s.onsuccess=()=>{let t={};for(let e of s.result)t[e.modelPath]=e.modelArtifactsInfo;e(t)},s.onerror=e=>(a.close(),t(s.error)),r.oncomplete=()=>a.close()},n.onerror=e=>t(n.error)})}async removeModel(e){return e=function(e){return e.startsWith(Wo.URL_SCHEME)?e.slice(Wo.URL_SCHEME.length):e}(e),new Promise((t,n)=>{let a=this.indexedDB.open(jo,1);a.onupgradeneeded=()=>Bo(a),a.onsuccess=()=>{let r,s=a.result,i=s.transaction(zo,"readwrite"),o=i.objectStore(zo),l=o.get(e);l.onsuccess=()=>{if(null==l.result)return s.close(),n(new Error(`Cannot find model with path '${e}' in IndexedDB.`));{let a=o.delete(e),i=()=>{r=s.transaction(Lo,"readwrite");let a=r.objectStore(Lo).delete(e);a.onsuccess=()=>t(l.result.modelArtifactsInfo),a.onerror=e=>n(l.error)};a.onsuccess=i,a.onerror=e=>(i(),s.close(),n(l.error))}},l.onerror=e=>(s.close(),n(l.error)),i.oncomplete=()=>{null==r?s.close():r.oncomplete=()=>s.close()}},a.onerror=e=>n(a.error)})}})}catch(ie){}}var dl;function cl(e,t="float32",n){return t=t||"float32",Ft(e),new ti(e,t,n)}Pt().get("IS_NODE")&&!Pt().get("IS_BROWSER")&&Pt().setPlatform("node",new class{constructor(){this.util=ve(),this.textEncoder=new this.util.TextEncoder}fetch(e,t){return null!=Pt().global.fetch?Pt().global.fetch(e,t):(null==dl&&(dl=we()),dl(e,t))}now(){let e=process.hrtime();return 1e3*e[0]+e[1]/1e6}encode(e,t){if("utf-8"!==t&&"utf8"!==t)throw new Error(`Node built-in encoder only supports utf-8, but got ${t}`);return this.textEncoder.encode(e)}decode(e,t){return 0===e.length?"":new this.util.TextDecoder(t).decode(e)}isTypedArray(e){return this.util.types.isFloat32Array(e)||this.util.types.isInt32Array(e)||this.util.types.isUint8Array(e)||this.util.types.isUint8ClampedArray(e)}});var pl=Bi({cast_:function(e,t){let n=Li(e,"x","cast");if(!gt(t))throw new Error(`Failed to cast to unknown dtype ${t}`);if("string"===t&&"string"!==n.dtype||"string"!==t&&"string"===n.dtype)throw new Error("Only strings can be casted to strings");let a={x:n},r={dtype:t};return Ci.runKernel(gn,a,r)}}),hl=Bi({clone_:function(e){let t={x:Li(e,"x","clone","string_or_numeric")};return Ci.runKernel(la,t)}});function ml(e,t=!1){}_i(),ai={buffer:cl,cast:pl,clone:hl,print:ml};var fl=Bi({add_:function(e,t){let n=Li(e,"a","add"),a=Li(t,"b","add");[n,a]=bi(n,a);let r={a:n,b:a};return Ci.runKernel(Kt,r)}}),gl=Bi({floorDiv_:function(e,t){let n=Li(e,"a","floorDiv"),a=Li(t,"b","floorDiv");[n,a]=bi(n,a);let r={a:n,b:a};return Ci.runKernel(na,r)}}),xl=Bi({div_:function(e,t){let n=Li(e,"a","div"),a=Li(t,"b","div");if([n,a]=bi(n,a),"int32"===n.dtype&&"int32"===a.dtype)return gl(n,a);let r={a:n,b:a};return Ci.runKernel(Vn,r,{})}}),bl=Bi({mul_:function(e,t){let n=Li(e,"a","mul"),a=Li(t,"b","mul");[n,a]=bi(n,a);let r={a:n,b:a};return Ci.runKernel(Wa,r)}}),yl=Bi({abs_:function(e){let t=Li(e,"x","abs");if("complex64"===t.dtype){let e={x:t};return Ci.runKernel(wn,e)}{let e={x:t};return Ci.runKernel(Gt,e)}}}),wl=Bi({acos_:function(e){let t={x:Li(e,"x","acos")};return Ci.runKernel(Ht,t)}}),vl=Bi({acosh_:function(e){let t={x:Li(e,"x","acosh")};return Ci.runKernel(qt,t)}}),kl=Bi({addN_:function(e){Ze(Array.isArray(e),()=>"The argument passed to tf.addN() must be a list of tensors"),Ze(e.length>=1,()=>`Must pass at least one tensor to tf.addN(), but got ${e.length}`);let t=e.map((e,t)=>Li(e,`tensors${t}`,"addN")),n=t[0];t.forEach(e=>{if(e.dtype!==n.dtype)throw new Error("All tensors passed to tf.addN() must have the same dtype")}),t.forEach(e=>{if(!at(e.shape,n.shape))throw new Error("All tensors passed to tf.addN() must have the same shape")});let a=t;return Ci.runKernel(Xt,a)}}),Nl=Bi({all_:function(e,t=null,n=!1){let a={x:Li(e,"x","all","bool")},r={axis:t,keepDims:n};return Ci.runKernel(Yt,a,r)}}),Sl=Bi({any_:function(e,t=null,n=!1){let a={x:Li(e,"x","any","bool")},r={axis:t,keepDims:n};return Ci.runKernel(Zt,a,r)}}),Il=Bi({argMax_:function(e,t=0){let n={x:Li(e,"x","argMax")},a={axis:t};return Ci.runKernel(Jt,n,a)}}),_l=Bi({argMin_:function(e,t=0){let n={x:Li(e,"x","argMin")},a={axis:t};return Ci.runKernel(Qt,n,a)}}),Cl=Bi({asin_:function(e){let t={x:Li(e,"x","asin")};return Ci.runKernel(en,t)}}),Tl=Bi({asinh_:function(e){let t={x:Li(e,"x","asinh")};return Ci.runKernel(tn,t)}}),El=Bi({atan_:function(e){let t={x:Li(e,"x","atan")};return Ci.runKernel(nn,t)}}),Al=Bi({atan2_:function(e,t){let n=Li(e,"a","atan2"),a=Li(t,"b","atan2");[n,a]=bi(n,a);let r={a:n,b:a};return Ci.runKernel(rn,r)}}),$l=Bi({atanh_:function(e){let t={x:Li(e,"x","atanh")};return Ci.runKernel(an,t)}});function Rl(e,t,n,a,r="NHWC",s){return Ml(e,[...t,e[3]],n,s,a,null,null,Gl(r))}function Fl(e,t,n,a,r,s,i="channelsLast"){let o,[l,u]=Ll(t);if("channelsLast"===i)o=[l,u,e[3],e[3]];else{if("channelsFirst"!==i)throw new Error(`Unknown dataFormat ${i}`);o=[l,u,e[1],e[1]]}return Ml(e,o,n,a,r,s,!1,i)}function Dl(e,t,n,a,r,s,i="NDHWC"){let o,l,[u,d,c]=zl(t);if("NDHWC"===i)l="channelsLast",o=[u,d,c,e[4],e[4]];else{if("NCDHW"!==i)throw new Error(`Unknown dataFormat ${i}`);l="channelsFirst",o=[u,d,c,e[1],e[1]]}return Ol(e,o,n,a,r,!1,l,s)}function Ml(e,t,n,a,r,s,i=!1,o="channelsLast"){let[l,u,d,c]=[-1,-1,-1,-1];if("channelsLast"===o)[l,u,d,c]=e;else{if("channelsFirst"!==o)throw new Error(`Unknown dataFormat ${o}`);[l,c,u,d]=e}let p,[h,m,,f]=t,[g,x]=Ll(n),[b,y]=Ll(a),w=Pl(h,b),v=Pl(m,y),{padInfo:k,outHeight:N,outWidth:S}=function(e,t,n,a,r,s,i,o,l){let u,d,c;if("number"==typeof e){u={top:e,bottom:e,left:e,right:e,type:0===e?"VALID":"NUMBER"};let r=function(e,t,n,a,r){null==a&&(a=jl(e,t,n));let s=e[1];return[Bl((e[0]-t+2*a)/n+1,r),Bl((s-t+2*a)/n+1,r)]}([t,n],s,a,e,o);d=r[0],c=r[1]}else if("same"===e){d=Math.ceil(t/a),c=Math.ceil(n/r);let e=Math.max(0,(d-1)*a+s-t),o=Math.max(0,(c-1)*r+i-n),l=Math.floor(e/2),p=e-l,h=Math.floor(o/2);u={top:l,bottom:p,left:h,right:o-h,type:"SAME"}}else if("valid"===e)u={top:0,bottom:0,left:0,right:0,type:"VALID"},d=Math.ceil((t-s+1)/a),c=Math.ceil((n-i+1)/r);else{if("object"!=typeof e)throw Error(`Unknown padding parameter: ${e}`);{let p="channelsLast"===l?e[1][0]:e[2][0],h="channelsLast"===l?e[1][1]:e[2][1],m="channelsLast"===l?e[2][0]:e[3][0],f="channelsLast"===l?e[2][1]:e[3][1];u={top:p,bottom:h,left:m,right:f,type:0===p&&0===h&&0===m&&0===f?"VALID":"EXPLICIT"},d=Bl((t-s+p+h)/a+1,o),c=Bl((n-i+m+f)/r+1,o)}}return{padInfo:u,outHeight:d,outWidth:c}}(r,u,d,g,x,w,v,s,o),I=i?f*c:f;return"channelsFirst"===o?p=[l,I,N,S]:"channelsLast"===o&&(p=[l,N,S,I]),{batchSize:l,dataFormat:o,inHeight:u,inWidth:d,inChannels:c,outHeight:N,outWidth:S,outChannels:I,padInfo:k,strideHeight:g,strideWidth:x,filterHeight:h,filterWidth:m,effectiveFilterHeight:w,effectiveFilterWidth:v,dilationHeight:b,dilationWidth:y,inShape:e,outShape:p,filterShape:t}}function Ol(e,t,n,a,r,s=!1,i="channelsLast",o){let[l,u,d,c,p]=[-1,-1,-1,-1,-1];if("channelsLast"===i)[l,u,d,c,p]=e;else{if("channelsFirst"!==i)throw new Error(`Unknown dataFormat ${i}`);[l,p,u,d,c]=e}let h,[m,f,g,,x]=t,[b,y,w]=zl(n),[v,k,N]=zl(a),S=Pl(m,v),I=Pl(f,k),_=Pl(g,N),{padInfo:C,outDepth:T,outHeight:E,outWidth:A}=function(e,t,n,a,r,s,i,o,l,u,d){let c,p,h,m;if("valid"===e&&(e=0),"number"==typeof e){c={top:e,bottom:e,left:e,right:e,front:e,back:e,type:0===e?"VALID":"NUMBER"};let f=function(e,t,n,a,r,s){null==r&&(r=jl(e,t[0],a[0]));let i=[0,0,0,1];for(let o=0;o<3;o++)e[o]+2*r>=t[o]&&(i[o]=Bl((e[o]-t[o]+2*r)/a[o]+1,s));return i}([t,n,a,1],[o,l,u],0,[r,s,i],e,d);p=f[0],h=f[1],m=f[2]}else{if("same"!==e)throw Error(`Unknown padding parameter: ${e}`);{p=Math.ceil(t/r),h=Math.ceil(n/s),m=Math.ceil(a/i);let e=(p-1)*r+o-t,d=(h-1)*s+l-n,f=(m-1)*i+u-a,g=Math.floor(e/2),x=e-g,b=Math.floor(d/2),y=d-b,w=Math.floor(f/2);c={top:b,bottom:y,left:w,right:f-w,front:g,back:x,type:"SAME"}}}return{padInfo:c,outDepth:p,outHeight:h,outWidth:m}}(r,u,d,c,b,y,w,S,I,_,o),$=s?x*p:x;return"channelsFirst"===i?h=[l,$,T,E,A]:"channelsLast"===i&&(h=[l,T,E,A,$]),{batchSize:l,dataFormat:i,inDepth:u,inHeight:d,inWidth:c,inChannels:p,outDepth:T,outHeight:E,outWidth:A,outChannels:$,padInfo:C,strideDepth:b,strideHeight:y,strideWidth:w,filterDepth:m,filterHeight:f,filterWidth:g,effectiveFilterDepth:S,effectiveFilterHeight:I,effectiveFilterWidth:_,dilationDepth:v,dilationHeight:k,dilationWidth:N,inShape:e,outShape:h,filterShape:t}}function jl(e,t,n,a=1){let r=Pl(t,a);return Math.floor((e[0]*(n-1)-n+r)/2)}function Ll(e){return"number"==typeof e?[e,e,e]:2===e.length?[e[0],e[1],1]:e}function zl(e){return"number"==typeof e?[e,e,e]:e}function Pl(e,t){return t<=1?e:e+(e-1)*(t-1)}function Bl(e,t){if(!t)return Math.trunc(e);switch(t){case"round":return Math.round(e);case"ceil":return Math.ceil(e);case"floor":return Math.floor(e);default:throw new Error(`Unknown roundingMode ${t}`)}}function Wl(e){let[t,n,a]=Ll(e);return 1===t&&1===n&&1===a}function Vl(e,t){return Wl(e)||Wl(t)}function Ul(e){return Ll(e).every(e=>e>0)}function Gl(e){if("NHWC"===e)return"channelsLast";if("NCHW"===e)return"channelsFirst";throw new Error(`Unknown dataFormat ${e}`)}function Hl(e,t,n){if(null!=n){if("string"==typeof t)throw Error(`Error in ${e}: pad must be an integer when using dimRoundingMode ${n} but got pad ${t}.`);if("number"==typeof t)Ze(rt(t),()=>`Error in ${e}: pad must be an integer when using dimRoundingMode ${n} but got pad ${t}.`);else{if("object"!=typeof t)throw Error(`Error in ${e}: Unknown padding parameter: ${t}`);t.forEach(t=>{t.forEach(t=>{Ze(rt(t),()=>`Error in ${e}: pad must be an integer when using dimRoundingMode ${n} but got pad ${t}.`)})})}}}var ql=Bi({reshape_:function(e,t){let n={x:Li(e,"x","reshape","string_or_numeric")},a={shape:t};return Ci.runKernel(ur,n,a)}}),Kl=Bi({avgPool_:function(e,t,n,a,r){let s=Li(e,"x","avgPool","float32");Ze(Vl(n,1),()=>`Error in avgPool: Either strides or dilations must be 1. Got strides ${n} and dilations '1'`);let i=s,o=!1;3===s.rank&&(o=!0,i=ql(s,[1,s.shape[0],s.shape[1],s.shape[2]])),Ze(4===i.rank,()=>`Error in avgPool: x must be rank 4 but got rank ${i.rank}.`),Hl("avgPool",a,r);let l={x:i},u={filterSize:t,strides:n,pad:a,dimRoundingMode:r},d=Ci.runKernel(sn,l,u);return d=pl(d,s.dtype),o?ql(d,[d.shape[1],d.shape[2],d.shape[3]]):d}}),Xl=Bi({avgPool3d_:function(e,t,n,a,r,s="NDHWC"){let i=Li(e,"x","avgPool3d","float32"),o=i,l=!1;4===i.rank&&(l=!0,o=ql(i,[1,i.shape[0],i.shape[1],i.shape[2],i.shape[3]])),Ze(5===o.rank,()=>`Error in avgPool3d: x must be rank 5 but got rank ${o.rank}.`),Ze("NDHWC"===s,()=>`Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of ${s}`),Ze("number"==typeof n&&n>0||Array.isArray(n)&&n[0]>0&&n[1]>0&&n[2]>0,()=>`Error in avgPool3d: Stride must be > 0, but got '${n}'`),Hl("avgPool3d",a,r);let u={x:o},d={filterSize:t,strides:n,pad:a,dimRoundingMode:r,dataFormat:s},c=Ci.runKernel(ln,u,d);return c=pl(c,o.dtype),l?ql(c,[c.shape[1],c.shape[2],c.shape[3],c.shape[4]]):c}}),Yl=Bi({concat_:function(e,t=0){Ze(e.length>=1,()=>"Pass at least one tensor to concat");let n=zi(e,"tensors","concat","string_or_numeric");if("complex64"===n[0].dtype&&n.forEach(e=>{if("complex64"!==e.dtype)throw new Error(`Cannot concatenate complex64 tensors with a tensor\n          with dtype ${e.dtype}. `)}),1===n.length)return hl(n[0]);let a=n,r={axis:t};return Ci.runKernel(vn,a,r)}}),Zl=Bi({matMul_:function(e,t,n=!1,a=!1){let r=Li(e,"a","matMul"),s=Li(t,"b","matMul");[r,s]=bi(r,s);let i={a:r,b:s},o={transposeA:n,transposeB:a};return Ci.runKernel(dn,i,o)}}),Jl=Bi({sigmoid_:function(e){let t={x:Li(e,"x","sigmoid","float32")};return Ci.runKernel(Cr,t)}}),Ql=Bi({slice_:function(e,t,n){let a=Li(e,"x","slice","string_or_numeric");if(0===a.rank)throw new Error("Slicing scalar is not possible");let r={x:a},s={begin:t,size:n};return Ci.runKernel(Nr,r,s)}}),eu=Bi({tanh_:function(e){let t={x:Li(e,"x","tanh","float32")};return Ci.runKernel(Kr,t)}}),tu=Bi({basicLSTMCell_:function(e,t,n,a,r,s){let i=Li(e,"forgetBias","basicLSTMCell"),o=Li(t,"lstmKernel","basicLSTMCell"),l=Li(n,"lstmBias","basicLSTMCell"),u=Li(a,"data","basicLSTMCell"),d=Li(r,"c","basicLSTMCell"),c=Li(s,"h","basicLSTMCell"),p=Yl([u,c],1),h=Zl(p,o),m=fl(h,l),f=m.shape[0],g=m.shape[1]/4,x=[f,g],b=Ql(m,[0,0],x),y=Ql(m,[0,g],x),w=Ql(m,[0,2*g],x),v=Ql(m,[0,3*g],x),k=fl(bl(Jl(b),eu(y)),bl(d,Jl(fl(i,w))));return[k,bl(eu(k),Jl(v))]}}),nu=Bi({batchToSpaceND_:function(e,t,n){let a=Li(e,"x","batchToSpaceND"),r=t.reduce((e,t)=>e*t);Ze(a.rank>=1+t.length,()=>`input rank is ${a.rank} but should be > than blockShape.length ${t.length}`),Ze(n.length===t.length,()=>`crops.length is ${n.length} but should be equal to blockShape.length  ${t.length}`),Ze(a.shape[0]%r===0,()=>`input tensor batch is ${a.shape[0]} but is not divisible by the product of the elements of blockShape ${t.join(" * ")} === ${r}`);let s={x:a},i={blockShape:t,crops:n};return Ci.runKernel(cn,s,i)}});function au(e){let t;return t=0===e.rank||1===e.rank?ql(e,[1,1,1,e.size]):2===e.rank?ql(e,[1,1,e.shape[0],e.shape[1]]):3===e.rank?ql(e,[1,e.shape[0],e.shape[1],e.shape[2]]):e,t}var ru=Bi({batchNorm_:function(e,t,n,a,r,s){null==s&&(s=.001);let i,o,l=Li(e,"x","batchNorm"),u=Li(t,"mean","batchNorm"),d=Li(n,"variance","batchNorm");null!=r&&(i=Li(r,"scale","batchNorm")),null!=a&&(o=Li(a,"offset","batchNorm")),Ze(u.rank===d.rank,()=>"Batch normalization gradient requires mean and variance to have equal ranks."),Ze(null==o||u.rank===o.rank,()=>"Batch normalization gradient requires mean and offset to have equal ranks."),Ze(null==i||u.rank===i.rank,()=>"Batch normalization gradient requires mean and scale to have equal ranks.");let c={x:au(l),scale:i,offset:o,mean:u,variance:d},p={varianceEpsilon:s},h=Ci.runKernel(aa,c,p);return ql(h,l.shape)}}),su=Bi({batchNorm2d_:function(e,t,n,a,r,s){let i,o,l=Li(e,"x","batchNorm"),u=Li(t,"mean","batchNorm"),d=Li(n,"variance","batchNorm");return null!=r&&(i=Li(r,"scale","batchNorm")),null!=a&&(o=Li(a,"offset","batchNorm")),Ze(2===l.rank,()=>`Error in batchNorm2D: x must be rank 2 but got rank ${l.rank}.`),Ze(2===u.rank||1===u.rank,()=>`Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank ${u.rank}.`),Ze(2===d.rank||1===d.rank,()=>`Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank ${d.rank}.`),null!=i&&Ze(2===i.rank||1===i.rank,()=>`Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank ${i.rank}.`),null!=o&&Ze(2===o.rank||1===o.rank,()=>`Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank ${o.rank}.`),ru(l,u,d,o,i,s)}}),iu=Bi({batchNorm3d_:function(e,t,n,a,r,s){let i,o,l=Li(e,"x","batchNorm"),u=Li(t,"mean","batchNorm"),d=Li(n,"variance","batchNorm");return null!=r&&(i=Li(r,"scale","batchNorm")),null!=a&&(o=Li(a,"offset","batchNorm")),Ze(3===l.rank,()=>`Error in batchNorm3D: x must be rank 3 but got rank ${l.rank}.`),Ze(3===u.rank||1===u.rank,()=>`Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank ${u.rank}.`),Ze(3===d.rank||1===d.rank,()=>`Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank ${d.rank}.`),null!=i&&Ze(3===i.rank||1===i.rank,()=>`Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank ${i.rank}.`),null!=o&&Ze(3===o.rank||1===o.rank,()=>`Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank ${o.rank}.`),ru(l,u,d,o,i,s)}}),ou=Bi({batchNorm4d_:function(e,t,n,a,r,s){let i,o,l=Li(e,"x","batchNorm"),u=Li(t,"mean","batchNorm"),d=Li(n,"variance","batchNorm");return null!=r&&(i=Li(r,"scale","batchNorm")),null!=a&&(o=Li(a,"offset","batchNorm")),Ze(4===l.rank,()=>`Error in batchNorm4D: x must be rank 4 but got rank ${l.rank}.`),Ze(4===u.rank||1===u.rank,()=>`Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank ${u.rank}.`),Ze(4===d.rank||1===d.rank,()=>`Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank ${d.rank}.`),null!=i&&Ze(4===i.rank||1===i.rank,()=>`Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank ${i.rank}.`),null!=o&&Ze(4===o.rank||1===o.rank,()=>`Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank ${o.rank}.`),ru(l,u,d,o,i,s)}}),lu=Bi({bincount_:function(e,t,n){let a=Li(e,"x","bincount"),r=Li(t,"weights","bincount");Ze("int32"===a.dtype,()=>`Error in bincount: input dtype must be int32, but got ${a.dtype}`),Ze(n>=0,()=>`size must be non-negative, but got ${n}.`),Ze(r.size===a.size||0===r.size,()=>`Error in bincount: weights must have the same size as input or0-length, but got input shape: ${a.shape}, weights shape: ${r.shape}.`);let s={x:a,weights:r},i={size:n};return Ci.runKernel(pn,s,i)}}),uu=Bi({bitwiseAnd_:function(e,t){let n=Li(e,"x","bitwiseAnd"),a=Li(t,"y","bitwiseAnd");if(!at(n.shape,a.shape))throw new Error(`BitwiseAnd: Tensors must have the same shape. x: ${n.shape}, y: ${a.shape}`);if("int32"!==n.dtype||"int32"!==a.dtype)throw new Error(`BitwiseAnd: Only supports 'int32' values in tensor, found type of x: ${n.dtype} and type of y: ${a.dtype}`);let r={a:n,b:a};return Ci.runKernel(hn,r)}}),du=Bi({broadcastArgs_:function(e,t){let n=Li(e,"s0","broadcastArgs","int32"),a=Li(t,"s1","broadcastArgs","int32");if(1!==n.rank)throw new Error(`broadcastArgs(): first input must be a vector (rank=1). Has rank ${n.rank}`);if(1!==a.rank)throw new Error(`broadcastArgs(): second input must be a vector (rank=1). Has rank ${a.rank}`);let r={s0:n,s1:a};return Ci.runKernel(fn,r)}}),cu=Bi({broadcastTo_:function(e,t){let n=Li(e,"broadcastTo","x"),a=n.shape;if(Ft(t),t.length<n.rank)throw new Error(`broadcastTo(): shape.length=${t.length} < input.rank=${n.rank}.`);if(t.length>n.rank){let e=n.shape.slice();for(;e.length<t.length;)e.unshift(1);n=ql(n,e)}let r=n.shape,s=Array.from(t);for(let l=t.length-1;l>=0;l--)if(r[l]===t[l])s[l]=1;else if(1!==n.shape[l])throw new Error(`broadcastTo(): [${a}] cannot be broadcast to [${t}].`);if(0===s.map((e,t)=>e>1?t:-1).filter(e=>e>=0).length)return hl(n);let i={x:n},o={reps:s};return Ci.runKernel(Xr,i,o)}}),pu=Bi({ceil_:function(e){let t={x:Li(e,"x","ceil","float32")};return Ci.runKernel(xn,t)}});function hu(e,t,n){Ft(e);let a={shape:e,value:t,dtype:n=n||Nt(t)};return Ci.runKernel(Qn,{},a)}var mu=Bi({clipByValue_:function(e,t,n){let a=Li(e,"x","clipByValue");if(Ze(t<=n,()=>`Error in clip: min (${t}) must be less than or equal to max (${n}).`),t===n)return hu(a.shape,t,a.dtype);let r={x:a},s={clipValueMin:t,clipValueMax:n};return Ci.runKernel(bn,r,s)}}),fu=Bi({concat1d_:function(e){return Yl(e,0)}}),gu=Bi({concat2d_:function(e,t){return Yl(e,t)}}),xu=Bi({concat3d_:function(e,t){return Yl(e,t)}}),bu=Bi({concat4d_:function(e,t){return Yl(e,t)}}),yu=Bi({conv2d_:function(e,t,n,a,r="NHWC",s=[1,1],i){let o=Li(e,"x","conv2d","float32"),l=Li(t,"filter","conv2d","float32"),u=o,d=!1;3===o.rank&&(d=!0,u=ql(o,[1,o.shape[0],o.shape[1],o.shape[2]])),Ze(4===u.rank,()=>`Error in conv2d: input must be rank 4, but got rank ${u.rank}.`),Ze(4===l.rank,()=>`Error in conv2d: filter must be rank 4, but got rank ${l.rank}.`),Hl("conv2d",a,i);let c="NHWC"===r?u.shape[3]:u.shape[1];Ze(c===l.shape[2],()=>`Error in conv2d: depth of input (${c}) must match input depth for filter ${l.shape[2]}.`),Ze(Vl(n,s),()=>`Error in conv2D: Either strides or dilations must be 1. Got strides ${n} and dilations '${s}'`),Ze(Ul(s),()=>"Error in conv2D: Dilated rates should be larger than 0."),Ze(Ul(n),()=>"Error in conv2D: Strides should be larger than 0.");let p={x:u,filter:l},h={strides:n,pad:a,dataFormat:r,dilations:s,dimRoundingMode:i},m=Ci.runKernel(kn,p,h);return d?ql(m,[m.shape[1],m.shape[2],m.shape[3]]):m}}),wu=Bi({conv1d_:function(e,t,n,a,r="NWC",s=1,i){let o=Li(e,"x","conv1d"),l=Li(t,"filter","conv1d"),u=o,d=!1;2===o.rank&&(d=!0,u=ql(o,[1,o.shape[0],o.shape[1]])),Ze(3===u.rank,()=>`Error in conv1d: input must be rank 3, but got rank ${u.rank}.`),Ze(3===l.rank,()=>`Error in conv1d: filter must be rank 3, but got rank ${l.rank}.`),Hl("conv1d",a,i),Ze(u.shape[2]===l.shape[1],()=>`Error in conv1d: depth of input (${u.shape[2]}) must match input depth for filter ${l.shape[1]}.`),Ze(Vl(n,s),()=>`Error in conv1D: Either stride or dilation must be 1. Got stride ${n} and dilation '${s}'`),Ze(Ul(s),()=>"Error in conv1D: Dilated rates should be larger than 0."),Ze(Ul(n),()=>"Error in conv1D: Stride should be larger than 0."),Ze("NWC"===r,()=>`Error in conv1d: got dataFormat of ${r} but only NWC is currently supported.`);let c=ql(l,[1,l.shape[0],l.shape[1],l.shape[2]]),p=ql(u,[u.shape[0],1,u.shape[1],u.shape[2]]),h=yu(p,c,[1,n],a,"NHWC",[1,s],i);return ql(h,d?[h.shape[2],h.shape[3]]:[h.shape[0],h.shape[2],h.shape[3]])}}),vu=Bi({conv2DBackpropInput_:function(e,t,n,a,r,s="NHWC",i){Ze(e.length===t.rank,()=>`Length of inShape (${e.length}) and rank of dy (${t.rank}) must match`);let o=e,l=t,u=!1;3===t.rank&&(u=!0,l=ql(t,[1,t.shape[0],t.shape[1],t.shape[2]]),o=[1,e[0],e[1],e[2]]),Ze(4===o.length,()=>`Error in conv2dDerInput: inShape must be length 4, but got length ${o.length}.`),Ze(4===l.rank,()=>`Error in conv2dDerInput: dy must be rank 4, but got rank ${l.rank}`),Ze(4===n.rank,()=>`Error in conv2dDerInput: filter must be rank 4, but got rank ${n.rank}`);let d="NHWC"===s?o[3]:o[1],c="NHWC"===s?l.shape[3]:l.shape[1];Ze(d===n.shape[2],()=>`Error in conv2dDerInput: depth of input (${d}) must match input depth for filter ${n.shape[2]}.`),Ze(c===n.shape[3],()=>`Error in conv2dDerInput: depth of output (${c}) must match output depth for filter ${n.shape[3]}.`),Hl("conv2dDerInput",r,i);let p={dy:l,filter:n},h={strides:a,pad:r,dataFormat:s,dimRoundingMode:i,inputShape:o},m=Ci.runKernel(Sn,p,h);return u?ql(m,[m.shape[1],m.shape[2],m.shape[3]]):m}}),ku=Bi({conv2dTranspose_:function(e,t,n,a,r,s){let i=Li(e,"x","conv2dTranspose"),o=Li(t,"filter","conv2dTranspose");return vu(n,i,o,a,r,"NHWC",s)}}),Nu=Bi({conv3d_:function(e,t,n,a,r="NDHWC",s=[1,1,1]){let i=Li(e,"x","conv3d"),o=Li(t,"filter","conv3d"),l=i,u=!1;4===i.rank&&(u=!0,l=ql(i,[1,i.shape[0],i.shape[1],i.shape[2],i.shape[3]])),Ze(5===l.rank,()=>`Error in conv3d: input must be rank 5, but got rank ${l.rank}.`),Ze(5===o.rank,()=>`Error in conv3d: filter must be rank 5, but got rank ${o.rank}.`),Ze(l.shape[4]===o.shape[3],()=>`Error in conv3d: depth of input (${l.shape[4]}) must match input depth for filter ${o.shape[3]}.`),Ze(Vl(n,s),()=>`Error in conv3D: Either strides or dilations must be 1. Got strides ${n} and dilations '${s}'`),Ze("NDHWC"===r,()=>`Error in conv3d: got dataFormat of ${r} but only NDHWC is currently supported.`),Ze(Ul(s),()=>"Error in conv3D: Dilated rates should be larger than 0."),Ze(Ul(n),()=>"Error in conv3D: Strides should be larger than 0.");let d={x:l,filter:o},c={strides:n,pad:a,dataFormat:r,dilations:s},p=Ci.runKernel(In,d,c);return u?ql(p,[p.shape[1],p.shape[2],p.shape[3],p.shape[4]]):p}}),Su=Bi({conv3DBackpropInput_:function(e,t,n,a,r){Ze(e.length===t.rank,()=>`Length of inShape (${e.length}) and rank of dy (${t.rank}) must match`);let s=e,i=t,o=!1;4===t.rank&&(o=!0,i=ql(t,[1,t.shape[0],t.shape[1],t.shape[2],t.shape[3]]),s=[1,e[0],e[1],e[2],e[3]]);let l=s[4],u=i.shape[4];Ze(5===s.length,()=>`Error in conv3dDerInput: inShape must be length 5, but got length ${s.length}.`),Ze(5===i.rank,()=>`Error in conv3dDerInput: dy must be rank 5, but got rank ${i.rank}`),Ze(5===n.rank,()=>`Error in conv3dDerInput: filter must be rank 5, but got rank ${n.rank}`),Ze(l===n.shape[3],()=>`Error in conv3dDerInput: depth of input (${l}) must match input depth for filter ${n.shape[3]}.`),Ze(u===n.shape[4],()=>`Error in conv3dDerInput: depth of output (${u}) must match output depth for filter ${n.shape[4]}.`);let d={dy:i,filter:n},c={pad:r,strides:a,inputShape:s},p=Ci.runKernel(Cn,d,c);return o?ql(p,[p.shape[1],p.shape[2],p.shape[3],p.shape[4]]):p}}),Iu=Bi({conv3dTranspose_:function(e,t,n,a,r){let s=Li(e,"x","conv3dTranspose"),i=Li(t,"filter","conv3dTranspose");return Su(n,s,i,a,r)}}),_u=Bi({cos_:function(e){let t={x:Li(e,"x","cos","float32")};return Ci.runKernel(Tn,t)}}),Cu=Bi({cosh_:function(e){let t={x:Li(e,"x","cosh","float32")};return Ci.runKernel(En,t)}}),Tu=Bi({cumprod_:function(e,t=0,n=!1,a=!1){let r={x:Li(e,"x","cumprod")},s={axis:t,exclusive:n,reverse:a};return Ci.runKernel(An,r,s)}}),Eu=Bi({cumsum_:function(e,t=0,n=!1,a=!1){let r={x:Li(e,"x","cumsum")},s={axis:t,exclusive:n,reverse:a};return Ci.runKernel($n,r,s)}}),Au=Bi({denseBincount_:function(e,t,n,a=!1){let r=Li(e,"x","denseBincount"),s=Li(t,"weights","denseBincount");Ze("int32"===r.dtype,()=>`Error in denseBincount: input dtype must be int32, but got ${r.dtype}`),Ze(r.rank<=2,()=>`Error in denseBincount: input must be at most rank 2, but got rank ${r.rank}.`),Ze(n>=0,()=>`size must be non-negative, but got ${n}.`),Ze(s.size===r.size||0===s.size,()=>`Error in denseBincount: weights must have the same shape as x or 0-length, but got x shape: ${r.shape}, weights shape: ${s.shape}.`);let i={x:r,weights:s},o={size:n,binaryOutput:a};return Ci.runKernel(Fn,i,o)}}),$u=Bi({depthToSpace_:function(e,t,n="NHWC"){let a=Li(e,"x","depthToSpace","float32"),r="NHWC"===n?a.shape[1]:a.shape[2],s="NHWC"===n?a.shape[2]:a.shape[3],i="NHWC"===n?a.shape[3]:a.shape[1];Ze(t>1,()=>`blockSize should be > 1 for depthToSpace, but was: ${t}`),Ze(r*t>=0,()=>`Negative dimension size caused by overflow when multiplying\n    ${r} and ${t}  for depthToSpace with input shape\n    ${a.shape}`),Ze(s*t>=0,()=>`Negative dimension size caused by overflow when multiplying\n    ${s} and ${t} for depthToSpace with input shape\n        ${a.shape}`),Ze(i%(t*t)===0,()=>`Dimension size must be evenly divisible by ${t*t} but is ${i} for depthToSpace with input shape ${a.shape}`);let o={x:a},l={blockSize:t,dataFormat:n};return Ci.runKernel(Dn,o,l)}}),Ru=Bi({depthwiseConv2d_:function(e,t,n,a,r="NHWC",s=[1,1],i){let o=Li(e,"x","depthwiseConv2d","float32"),l=Li(t,"filter","depthwiseConv2d","float32"),u=o,d=!1;3===o.rank&&(d=!0,u=ql(o,[1,o.shape[0],o.shape[1],o.shape[2]])),Ze(4===u.rank,()=>`Error in depthwiseConv2d: input must be rank 4, but got rank ${u.rank}.`),Ze(4===l.rank,()=>`Error in depthwiseConv2d: filter must be rank 4, but got rank ${l.rank}.`);let c="NHWC"===r?u.shape[3]:u.shape[1];Ze(c===l.shape[2],()=>`Error in depthwiseConv2d: number of input channels (${c}) must match the inChannels dimension in filter ${l.shape[2]}.`),Hl("depthwiseConv2d",a,i);let p={x:u,filter:l},h={strides:n,pad:a,dataFormat:r,dilations:s,dimRoundingMode:i},m=Ci.runKernel(Mn,p,h);return d?ql(m,[m.shape[1],m.shape[2],m.shape[3]]):m}}),Fu=Bi({diag_:function(e){let t={x:Li(e,"x","diag")};return Ci.runKernel(Ln,t)}}),Du=Bi({dilation2d_:function(e,t,n,a,r=[1,1],s="NHWC"){let i=Li(e,"x","dilation2d"),o=Li(t,"filter","dilation2d");Ze(3===i.rank||4===i.rank,()=>`Error in dilation2d: input must be rank 3 or 4, but got rank ${i.rank}.`),Ze(3===o.rank,()=>`Error in dilation2d: filter must be rank 3, but got rank ${o.rank}.`),Ze("NHWC"===s,()=>`Error in dilation2d: Only NHWC is currently supported, but got dataFormat of ${s}`);let l=i,u=!1;3===i.rank&&(l=ql(i,[1,i.shape[0],i.shape[1],i.shape[2]]),u=!0),Ze(l.shape[3]===o.shape[2],()=>`Error in dilation2d:  input and filter must have the same depth: ${l.shape[3]} vs ${o.shape[2]}`);let d={x:l,filter:o},c={strides:n,pad:a,dilations:r},p=Ci.runKernel(zn,d,c);return u?ql(p,[p.shape[1],p.shape[2],p.shape[3]]):p}}),Mu={};function Ou(e,t){let n=e.length,a=[];for(let r=0;r<n;r++){let s=n-1-r,i=e[s]||1;(t[t.length-1-r]||1)>1&&1===i&&a.unshift(s)}return a}function ju(e,t){let n=[];for(let a=0;a<t.length;a++){let r=e[e.length-a-1],s=t.length-a-1,i=t[s];(null==r||1===r&&i>1)&&n.unshift(s)}return n}function Lu(e,t){let n=Math.max(e.length,t.length),a=new Array(n);for(let r=0;r<n;r++){let s=e[e.length-r-1];null==s&&(s=1);let i=t[t.length-r-1];if(null==i&&(i=1),1===s)a[n-r-1]=i;else if(1===i)a[n-r-1]=s;else{if(s!==i)throw Error(`Operands could not be broadcast together with shapes ${e} and ${t}.`);a[n-r-1]=s}}return a}xe(Mu,{assertAndGetBroadcastShape:()=>Lu,getBroadcastDims:()=>Ou,getReductionAxes:()=>ju});var zu=Bi({equal_:function(e,t){let n=Li(e,"a","equal","string_or_numeric"),a=Li(t,"b","equal","string_or_numeric");[n,a]=bi(n,a),Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(Kn,r)}}),Pu=Bi({where_:function(e,t,n){let a=Li(t,"a","where"),r=Li(n,"b","where"),s=Li(e,"condition","where","bool"),i=Lu(Lu(s.shape,a.shape),r.shape),o={condition:cu(s,i),t:cu(a,i),e:cu(r,i)};return Ci.runKernel(vr,o)}}),Bu=Bi({zerosLike_:function(e){let t={x:Li(e,"x","zerosLike")};return Ci.runKernel(as,t)}}),Wu=Bi({divNoNan_:function(e,t){let n=Li(e,"a","div"),a=Li(t,"b","div");[n,a]=bi(n,a);let r=xl(n,a),s=Bu(r),i=zu(a,s);return Pu(i,s,r)}}),Vu=Bi({dot_:function(e,t){let n=Li(e,"t1","dot"),a=Li(t,"t2","dot");Ze(!(1!==n.rank&&2!==n.rank||1!==a.rank&&2!==a.rank),()=>`Error in dot: inputs must all be rank 1 or 2, but got ranks ${n.rank} and ${a.rank}.`);let r=1===n.rank?n.size:n.shape[1],s=1===a.rank?a.size:a.shape[0];if(Ze(r===s,()=>`Error in dot: inner dimensions of inputs must match, but got ${r} and ${s}.`),1===n.rank&&1===a.rank){let e=ql(n,[1,-1]),t=ql(a,[-1,1]),r=Zl(e,t);return ql(r,[])}if(1===n.rank&&2===a.rank){let e=ql(n,[1,-1]),t=ql(a,[a.shape[0],a.shape[1]]),r=Zl(e,t);return ql(r,[r.size])}if(2===n.rank&&1===a.rank){let e=ql(a,[-1,1]),t=Zl(n,e);return ql(t,[t.size])}{let e=ql(a,[a.shape[0],a.shape[1]]);return Zl(n,e)}}}),Uu=Bi({einsum_:function(e,...t){let n=t.map((e,t)=>Li(e,`tensors${t}`,"einsum")),a={equation:e};return Ci.runKernel(Un,n,a)}}),Gu=Bi({elu_:function(e){let t={x:Li(e,"x","elu","float32")};return Ci.runKernel(Gn,t)}}),Hu=Bi({ensureShape_:function(e,t){let n=Li(e,"x","ensureShape","string_or_numeric");if(!nt(n.shape,t))throw new Error(`EnsureShape: Shape of tensor ${n.shape} is not compatible with expected shape ${t}`);return e}}),qu=Bi({erf_:function(e){let t=Li(e,"x","erf");Ze("int32"===t.dtype||"float32"===t.dtype,()=>"Input dtype must be `int32` or `float32`."),"int32"===t.dtype&&(t=pl(t,"float32"));let n={x:t};return Ci.runKernel(qn,n)}});function Ku(e,t){for(let n=0;n<e.length;++n)if(e[e.length-n-1]!==t-1-n)return!1;return!0}function Xu(e,t,n){let a=e.length+t.length,r=[],s=0,i=0;for(let o=0;o<a;o++)-1===n.indexOf(o)?r.push(e[s++]):r.push(t[i++]);return r}function Yu(e,t){let n=[],a=e.length;for(let r=0;r<a;r++)-1===t.indexOf(r)&&n.push(e[r]);return[n,t.map(t=>e[t])]}function Zu(e,t){return Xu(e,t.map(e=>1),t)}function Ju(e,t,n){Ze(Ku(t,n),()=>`${e} supports only inner-most axes for now. Got axes ${t} and rank-${n} input.`)}function Qu(e,t){if(Ku(e,t))return null;let n=[];for(let a=0;a<t;++a)-1===e.indexOf(a)&&n.push(a);return e.forEach(e=>n.push(e)),n}function ed(e){return e.map((e,t)=>[t,e]).sort((e,t)=>e[1]-t[1]).map(e=>e[0])}function td(e,t){let n=[];for(let a=t-e;a<t;++a)n.push(a);return n}var nd=Bi({max_:function(e,t=null,n=!1){let a={x:Li(e,"x","max")},r={reductionIndices:t,keepDims:n};return Ci.runKernel(Ea,a,r)}}),ad=Bi({min_:function(e,t=null,n=!1){let a={x:Li(e,"x","min")},r={axis:t,keepDims:n};return Ci.runKernel(ja,a,r)}}),rd=Bi({pow_:function(e,t){let n=Li(e,"base","pow"),a=Li(t,"exp","pow");[n,a]=bi(n,a);let r={a:n,b:a};return Ci.runKernel(Qa,r)}});function sd(e,t){if((Gs(e)&&"string"!==t||Array.isArray(e))&&"complex64"!==t)throw new Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===t&&Gs(e)&&!(e instanceof Uint8Array))throw new Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return Vi(e,[],[],t)}var id=Bi({sqrt_:function(e){let t={x:Li(e,"x","sqrt","float32")};return Ci.runKernel(Er,t)}}),od=Bi({square_:function(e){let t=Li(e,"x","square");return Ci.runKernel("Square",{x:t},{})}}),ld=Bi({sum_:function(e,t=null,n=!1){let a=Li(e,"x","sum");"bool"===a.dtype&&(a=pl(a,"int32"));let r={x:a},s={axis:t,keepDims:n};return Ci.runKernel(Ar,r,s)}});function ud(e,t,n=null){if(0===e.rank)return yl(e);if(1!==e.rank&&null===n)return ud(ql(e,[-1]),t,n);if(1===e.rank||"number"==typeof n||Array.isArray(n)&&1===n.length){if(1===t)return ld(yl(e),n);if(t===1/0)return nd(yl(e),n);if(t===-1/0)return ad(yl(e),n);if("euclidean"===t||2===t)return id(ld(rd(yl(e),sd(2,"int32")),n));throw new Error(`Error in norm: invalid ord value: ${t}`)}if(Array.isArray(n)&&2===n.length){if(1===t)return nd(ld(yl(e),n[0]),n[1]-1);if(t===1/0)return nd(ld(yl(e),n[1]),n[0]);if(t===-1/0)return ad(ld(yl(e),n[1]),n[0]);if("fro"===t||"euclidean"===t)return id(ld(od(e),n));throw new Error(`Error in norm: invalid ord value: ${t}`)}throw new Error(`Error in norm: invalid axis: ${n}`)}var dd=Bi({norm_:function(e,t="euclidean",n=null,a=!1){let r=ud(e=Li(e,"x","norm"),t,n),s=r.shape;if(a){let t=ct(n,e.shape);s=Zu(r.shape,t)}return ql(r,s)}}),cd=Bi({euclideanNorm_:function(e,t=null,n=!1){return dd(e,"euclidean",t,n)}}),pd=Bi({exp_:function(e){let t={x:Li(e,"x","exp")};return Ci.runKernel(Xn,t)}}),hd=Bi({expandDims_:function(e,t=0){let n=Li(e,"x","expandDims","string_or_numeric");Ze(t<=n.rank,()=>"Axis must be <= rank of the tensor");let a={input:n},r={dim:t};return Ci.runKernel(Yn,a,r)}}),md=Bi({expm1_:function(e){let t={x:Li(e,"x","expm1")};return Ci.runKernel(Zn,t)}}),fd=Bi({tile_:function(e,t){let n=Li(e,"x","tile","string_or_numeric");Ze(n.rank===t.length,()=>`Error in transpose: rank of input ${n.rank} must match length of reps ${t}.`);let a={x:n},r={reps:t};return Ci.runKernel(Xr,a,r)}}),gd=Bi({eye_:function(e,t,n,a="float32"){null==t&&(t=e);let r=cl([e,t],a),s=e<=t?e:t;for(let o=0;o<s;++o)r.set(1,o,o);let i=ql(r.toTensor(),[e,t]);if(null==n)return i;if(1===n.length)return fd(hd(i,0),[n[0],1,1]);if(2===n.length)return fd(hd(hd(i,0),0),[n[0],n[1],1,1]);if(3===n.length)return fd(hd(hd(hd(i,0),0),0),[n[0],n[1],n[2],1,1]);throw new Error(`eye() currently supports only 1D and 2D batchShapes, but received ${n.length}D.`)}}),xd=Bi({floor_:function(e){let t={x:Li(e,"x","floor","float32")};return Ci.runKernel(ta,t)}}),bd=Bi({gather_:function(e,t,n=0,a=0){let r={x:Li(e,"x","gather"),indices:Li(t,"indices","gather","int32")},s={axis:n,batchDims:a};return Ci.runKernel(ra,r,s)}}),yd=Bi({greater_:function(e,t){let n=Li(e,"a","greater","string_or_numeric"),a=Li(t,"b","greater","string_or_numeric");[n,a]=bi(n,a),Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(ia,r)}}),wd=Bi({greaterEqual_:function(e,t){let n=Li(e,"a","greaterEqual","string_or_numeric"),a=Li(t,"b","greaterEqual","string_or_numeric");[n,a]=bi(n,a),Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(oa,r)}}),vd=Bi({imag_:function(e){let t={input:Li(e,"input","imag")};return Ci.runKernel(da,t)}}),kd=Bi({isFinite_:function(e){let t={x:Li(e,"x","isFinite")};return Ci.runKernel(ca,t)}}),Nd=Bi({isInf_:function(e){let t={x:Li(e,"x","isInf")};return Ci.runKernel(pa,t)}}),Sd=Bi({isNaN_:function(e){let t={x:Li(e,"x","isNaN")};return Ci.runKernel(ha,t)}}),Id=Bi({leakyRelu_:function(e,t=.2){let n={x:Li(e,"x","leakyRelu")},a={alpha:t};return Ci.runKernel(ma,n,a)}}),_d=Bi({less_:function(e,t){let n=Li(e,"a","less","string_or_numeric"),a=Li(t,"b","less","string_or_numeric");[n,a]=bi(n,a),Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(fa,r)}}),Cd=Bi({lessEqual_:function(e,t){let n=Li(e,"a","lessEqual","string_or_numeric"),a=Li(t,"b","lessEqual","string_or_numeric");[n,a]=bi(n,a),Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(ga,r)}});function Td(e,t,n){if(n<=0)throw new Error("The number of values should be positive.");let a={start:e,stop:t,num:n};return Ci.runKernel(xa,{},a)}var Ed=Bi({localResponseNormalization_:function(e,t=5,n=1,a=1,r=.5){let s=Li(e,"x","localResponseNormalization");Ze(4===s.rank||3===s.rank,()=>`Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank ${s.rank}.`),Ze(rt(t),()=>`Error in localResponseNormalization: depthRadius must be an integer but got depthRadius ${t}.`);let i=s,o=!1;3===s.rank&&(o=!0,i=ql(s,[1,s.shape[0],s.shape[1],s.shape[2]]));let l={x:i},u={depthRadius:t,bias:n,alpha:a,beta:r},d=Ci.runKernel(_a,l,u);return o?ql(d,[d.shape[1],d.shape[2],d.shape[3]]):d}}),Ad=Bi({log_:function(e){let t={x:Li(e,"x","log","float32")};return Ci.runKernel(ba,t)}}),$d=Bi({log1p_:function(e){let t={x:Li(e,"x","log1p")};return Ci.runKernel(ya,t)}});function Rd(e){return Ze(St(e),()=>"The f passed in grad(f) must be a function"),(t,n)=>{let a=Li(t,"x","tf.grad","string_or_numeric"),r=null!=n?Li(n,"dy","tf.grad"):null;return Ci.tidy(()=>{let{value:t,grads:n}=Ci.gradients(()=>e(a),[a],r);return null!=r&&Je(t.shape,r.shape,"The shape of dy passed in grad(f)(x, dy) must match the shape returned by f(x)"),Ld(n),n[0]})}}function Fd(e){return Ze(St(e),()=>"The f passed in grads(f) must be a function"),(t,n)=>{Ze(Array.isArray(t),()=>"The args passed in grads(f)(args) must be an array of `Tensor`s or `TensorLike`s");let a=zi(t,"args","tf.grads","string_or_numeric"),r=null!=n?Li(n,"dy","tf.grads"):null;return Ci.tidy(()=>{let{value:t,grads:n}=Ci.gradients(()=>e(...a),a,r);return null!=r&&Je(t.shape,r.shape,"The shape of dy passed in grads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),Ld(n),n})}}function Dd(e){return Ze(St(e),()=>"The f passed in valueAndGrad(f) must be a function"),(t,n)=>{Ze(t instanceof ri,()=>"The x passed in valueAndGrad(f)(x) must be a tensor"),Ze(null==n||n instanceof ri,()=>"The dy passed in valueAndGrad(f)(x, dy) must be a tensor");let{grads:a,value:r}=Ci.gradients(()=>e(t),[t],n);return Ld(a),{grad:a[0],value:r}}}function Md(e){return Ze(St(e),()=>"The f passed in valueAndGrads(f) must be a function"),(t,n)=>{Ze(Array.isArray(t)&&t.every(e=>e instanceof ri),()=>"The args passed in valueAndGrads(f)(args) must be array of tensors"),Ze(null==n||n instanceof ri,()=>"The dy passed in valueAndGrads(f)(args, dy) must be a tensor");let a=Ci.gradients(()=>e(...t),t,n);return null!=n&&Je(a.value.shape,n.shape,"The shape of dy passed in valueAndGrads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),Ld(a.grads),a}}function Od(e,t){Ze(St(e),()=>"The f passed in variableGrads(f) must be a function"),Ze(null==t||Array.isArray(t)&&t.every(e=>e instanceof ii),()=>"The varList passed in variableGrads(f, varList) must be an array of variables");let n=null!=t;if(!n){t=[];for(let e in Ci.registeredVariables)t.push(Ci.registeredVariables[e])}let a=n?t.filter(e=>!e.trainable):null,r=t.length;Ze((t=t.filter(e=>e.trainable)).length>0,()=>`variableGrads() expects at least one of the input variables to be trainable, but none of the ${r} variables is trainable.`);let{value:s,grads:i}=Ci.gradients(e,t,null,!0);Ze(i.some(e=>null!=e),()=>"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."),Ze(0===s.rank,()=>`The f passed in variableGrads(f) must return a scalar, but it returned a rank-${s.rank} tensor`);let o={};return t.forEach((e,t)=>{null!=i[t]&&(o[e.name]=i[t])}),null!=a&&a.forEach(e=>o[e.name]=null),{value:s,grads:o}}function jd(e){return Ci.customGrad(e)}function Ld(e){if(e.filter(e=>null==e).length>0)throw new Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that\n    the f you passed encloses all operations that lead from x to y.")}var zd=Bi({neg_:function(e){let t={x:Li(e,"x","neg")};return Ci.runKernel(Va,t)}}),Pd=Bi({softplus_:function(e){let t={x:Li(e,"x","softplus")};return Ci.runKernel(Tr,t)}}),Bd=Bi({logSigmoid_:function(e){let t=Li(e,"x","logSigmoid");return jd(e=>({value:zd(Pd(zd(e))),gradFunc:t=>bl(t,Jl(zd(e)))}))(t)}}),Wd=Bi({sub_:function(e,t){let n=Li(e,"a","sub"),a=Li(t,"b","sub");[n,a]=bi(n,a);let r={a:n,b:a};return Ci.runKernel(Hr,r)}}),Vd=Bi({logSoftmax_:function(e,t=-1){let n=Li(e,"logits","logSoftmax");if(-1===t&&(t=n.rank-1),t!==n.rank-1)throw Error(`Log Softmax along a non-last dimension is not yet supported. Logits was rank ${n.rank} and axis was ${t}`);return jd((e,n)=>{let a=nd(e,t,!0),r=Wd(e,a),s=Wd(pl(r,"float32"),Ad(ld(pd(r),t,!0)));return n([s]),{value:s,gradFunc:(e,n)=>{let[a]=n,r=pd(a);return Wd(e,bl(ld(e,t,!0),r))}}})(n)}}),Ud=Bi({logSumExp_:function(e,t=null,n=!1){let a=Li(e,"x","logSumExp"),r=ct(t,a.shape),s=nd(a,r,!0),i=Wd(a,s),o=pd(i),l=ld(o,r),u=Ad(l),d=fl(ql(s,u.shape),u);if(n){let e=Zu(d.shape,r);return ql(d,e)}return d}}),Gd=Bi({logicalAnd_:function(e,t){let n=Li(e,"a","logicalAnd","bool"),a=Li(t,"b","logicalAnd","bool");Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(wa,r)}}),Hd=Bi({logicalNot_:function(e){let t={x:Li(e,"x","logicalNot","bool")};return Ci.runKernel(va,t)}}),qd=Bi({logicalOr_:function(e,t){let n=Li(e,"a","logicalOr","bool"),a=Li(t,"b","logicalOr","bool");Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(ka,r)}}),Kd=Bi({logicalXor_:function(e,t){let n=Li(e,"a","logicalXor","bool"),a=Li(t,"b","logicalXor","bool");return Lu(n.shape,a.shape),Gd(qd(e,t),Hd(Gd(e,t)))}}),Xd=2147483648,Yd=Bi({searchSorted_:function(e,t,n="left"){let a=Li(e,"sortedSequence","searchSorted"),r=Li(t,"values","searchSorted"),s=a.shape[a.shape.length-1],i=r.shape[r.shape.length-1],o=ql(a,[-1,s]),l=ql(r,[-1,i]);if(o.rank<2)throw new Error("Sorted input argument must be at least 2-dimensional");if(o.shape[0]!==l.shape[0])throw new Error("Leading dimension of 'sortedSequence' and 'values' must match.");if(et(l.shape)>=Xd)throw new Error(`values tensor size must less than ${Xd}`);if(o.shape[1]>=Xd)throw new Error(`trailing dim_size must less than ${Xd} for int32 output type, was ${o.shape[1]}`);let u={sortedSequence:o,values:l},d={side:n};return Ci.runKernel(wr,u,d)}});function Zd(e,t){return Yd(e,t,"left")}var Jd=Bi({maxPool_:function(e,t,n,a,r){let s=Li(e,"x","maxPool"),i=s,o=!1;3===s.rank&&(o=!0,i=ql(s,[1,s.shape[0],s.shape[1],s.shape[2]])),Ze(4===i.rank,()=>`Error in maxPool: input must be rank 4 but got rank ${i.rank}.`),Ze(Vl(n,1),()=>`Error in maxPool: Either strides or dilations must be 1. Got strides ${n} and dilations '1'`),Hl("maxPool",a,r);let l={x:i},u={filterSize:t,strides:n,pad:a,dimRoundingMode:r},d=Ci.runKernel($a,l,u);return o?ql(d,[d.shape[1],d.shape[2],d.shape[3]]):d}}),Qd=Bi({maxPool3d_:function(e,t=[1,1,1],n,a,r,s="NDHWC"){let i=Li(e,"x","maxPool3d"),o=i,l=!1;4===i.rank&&(l=!0,o=ql(i,[1,i.shape[0],i.shape[1],i.shape[2],i.shape[3]])),Ze(5===o.rank,()=>`Error in maxPool3d: x must be rank 5 but got rank ${o.rank}.`),Ze("NDHWC"===s,()=>`Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of ${s}`),Hl("maxPool3d",a,r);let u={x:o},d={filterSize:t,strides:n,pad:a,dimRoundingMode:r,dataFormat:s},c=Ci.runKernel(Fa,u,d);return l?ql(c,[c.shape[1],c.shape[2],c.shape[3],c.shape[4]]):c}}),ec=Bi({maxPoolWithArgmax_:function(e,t,n,a,r=!1){let s={x:Li(e,"x","maxPoolWithArgmax")},i={filterSize:t,strides:n,pad:a,includeBatchInIndex:r},o=Ci.runKernel(Ma,s,i);return{result:o[0],indexes:o[1]}}}),tc=Bi({maximum_:function(e,t){let n=Li(e,"a","maximum"),a=Li(t,"b","maximum");[n,a]=bi(n,a),"bool"===n.dtype&&(n=pl(n,"int32"),a=pl(a,"int32")),Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(Aa,r)}}),nc=Bi({mean_:function(e,t=null,n=!1){let a={x:Li(e,"x","mean")},r={axis:t,keepDims:n};return Ci.runKernel(Oa,a,r)}});function ac(e,t="float32"){if(Ft(e),"complex64"===t){let t=ac(e,"float32"),n=ac(e,"float32");return Wi(t,n)}let n=$t(et(e),t);return Ci.makeTensor(n,e,t)}function rc(e,t="float32"){if(Ft(e),"complex64"===t){let t=rc(e,"float32"),n=ac(e,"float32");return Wi(t,n)}let n=At(et(e),t);return Ci.makeTensor(n,e,t)}function sc(e,t,{indexing:n="xy"}={}){if("xy"!==n&&"ij"!==n)throw new TypeError(`${n} is not a valid third argument to meshgrid`);if(void 0===e)return[];let a=Li(e,"x","meshgrid",e instanceof ri?e.dtype:"float32");if(void 0===t)return[a];let r=Li(t,"y","meshgrid",t instanceof ri?t.dtype:"float32"),s=et(a.shape),i=et(r.shape);return"xy"===n?(a=ql(a,[1,-1]),r=ql(r,[-1,1]),[Zl(rc([i,1],a.dtype),a),Zl(r,rc([1,s],r.dtype))]):(a=ql(a,[-1,1]),r=ql(r,[1,-1]),[Zl(a,rc([1,i],a.dtype)),Zl(rc([s,1],r.dtype),r)])}var ic=Bi({minimum_:function(e,t){let n=Li(e,"a","minimum"),a=Li(t,"b","minimum");[n,a]=bi(n,a),"bool"===n.dtype&&(n=pl(n,"int32"),a=pl(a,"int32")),Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(La,r)}}),oc=Bi({mirrorPad_:function(e,t,n){Ze("reflect"===n||"symmetric"===n,()=>`Invalid mode. Mode must be either reflect or symmetric. Got ${n}.`);let a=Li(e,"x","mirrorPad");if(0===a.rank)throw new Error("mirrorPad(scalar) is not defined. Pass non-scalar to mirrorPad");Ze(t.length===a.rank,()=>`Padding doesn't match input. Must be ${a.rank}. Got ${t.length}.`);let r="reflect"===n?1:0;for(let o=0;o<a.rank;o++)Ze(2===t[o].length,()=>"Invalid number of paddings. Must be length of 2 each."),Ze(t[o][0]>=0&&t[o][0]<=a.shape[o]-r&&t[o][1]>=0&&t[o][1]<=a.shape[o]-r,()=>`Padding in dimension ${o} cannot be greater than or equal to ${a.shape[o]-r} or less than 0 for input of shape ${a.shape}`);let s={paddings:t,mode:n},i={x:a};return Ci.runKernel(za,i,s)}}),lc=Bi({mod_:function(e,t){let n=Li(e,"a","mod"),a=Li(t,"b","mod");[n,a]=bi(n,a);let r={a:n,b:a};return Ci.runKernel(Pa,r)}}),uc=Bi({moments_:function(e,t=null,n=!1){let a=ct(t,(e=Li(e,"x","moments")).shape),r=nc(e,a,n),s=r.shape;n||(s=Zu(r.shape,a));let i=od(Wd(pl(e,"float32"),ql(r,s)));return{mean:r,variance:nc(i,a,n)}}}),dc=Bi({multiRNNCell_:function(e,t,n,a){let r=Li(t,"data","multiRNNCell"),s=zi(n,"c","multiRNNCell"),i=zi(a,"h","multiRNNCell"),o=r,l=[];for(let c=0;c<e.length;c++){let t=e[c](o,s[c],i[c]);l.push(t[0]),l.push(t[1]),o=t[1]}let u=[],d=[];for(let c=0;c<l.length;c+=2)u.push(l[c]),d.push(l[c+1]);return[u,d]}}),cc=Bi({multinomial_:function(e,t,n,a=!1){let r=Li(e,"logits","multinomial"),s=r.size,i=r.rank;if(s<2)throw new Error(`Error in multinomial: you need at least 2 outcomes, but got ${s}.`);if(i>2)throw new Error(`Rank of probabilities must be 1 or 2, but is ${i}`);n=n||Math.random();let o={logits:1===i?ql(r,[1,-1]):r},l={numSamples:t,seed:n,normalized:a},u=Ci.runKernel(Ba,o,l);return 1===i?ql(u,[u.size]):u}}),pc=Bi({notEqual_:function(e,t){let n=Li(e,"a","notEqual","string_or_numeric"),a=Li(t,"b","notEqual","string_or_numeric");[n,a]=bi(n,a),Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(Ua,r)}}),hc=Bi({oneHot_:function(e,t,n=1,a=0,r="int32"){if(t<2)throw new Error(`Error in oneHot: depth must be >=2, but it is ${t}`);let s={indices:Li(e,"indices","oneHot","int32")},i={dtype:r,depth:t,onValue:n,offValue:a};return Ci.runKernel(Xa,s,i)}}),mc=Bi({onesLike_:function(e){let t={x:Li(e,"x","onesLike")};return Ci.runKernel(Ka,t)}}),fc=Bi({outerProduct_:function(e,t){let n=Li(e,"v1","outerProduct"),a=Li(t,"v2","outerProduct");Ze(1===n.rank&&1===a.rank,()=>`Error in outerProduct: inputs must be rank 1, but got ranks ${n.rank} and ${a.rank}.`);let r=ql(n,[-1,1]),s=ql(a,[1,-1]);return Zl(r,s)}}),gc=Bi({pad_:function(e,t,n=0){let a=Li(e,"x","pad");if(0===a.rank)throw new Error("pad(scalar) is not defined. Pass non-scalar to pad");let r={paddings:t,constantValue:n},s={x:a};return Ci.runKernel(Za,s,r)}}),xc=Bi({pad1d_:function(e,t,n=0){return Ze(2===t.length,()=>"Invalid number of paddings. Must be length of 2."),gc(e,[t],n)}}),bc=Bi({pad2d_:function(e,t,n=0){return Ze(2===t.length&&2===t[0].length&&2===t[1].length,()=>"Invalid number of paddings. Must be length of 2 each."),gc(e,t,n)}}),yc=Bi({pad3d_:function(e,t,n=0){return Ze(3===t.length&&2===t[0].length&&2===t[1].length&&2===t[2].length,()=>"Invalid number of paddings. Must be length of 2 each."),gc(e,t,n)}}),wc=Bi({pad4d_:function(e,t,n=0){return Ze(4===t.length&&2===t[0].length&&2===t[1].length&&2===t[2].length&&2===t[3].length,()=>"Invalid number of paddings. Must be length of 2 each."),gc(e,t,n)}}),vc=Bi({spaceToBatchND_:function(e,t,n){let a=Li(e,"x","spaceToBatchND");Ze(a.rank>=1+t.length,()=>`input rank ${a.rank} should be > than [blockShape] ${t.length}`),Ze(n.length===t.length,()=>`paddings.shape[0] ${n.length} must be equal to [blockShape] ${t.length}`),Ze(a.shape.reduce((e,a,r)=>r>0&&r<=t.length?e&&(a+n[r-1][0]+n[r-1][1])%t[r-1]===0:e,!0),()=>`input spatial dimensions ${a.shape.slice(1)} with paddings ${n.toString()} must be divisible by blockShapes ${t.toString()}`);let r={x:a},s={blockShape:t,paddings:n};return Ci.runKernel($r,r,s)}}),kc=Bi({pool_:function(e,t,n,a,r,s,i){null==r&&(r=[1,1]),null==s&&(s=1),0===a&&(a="valid");let o=Li(e,"x","maxPool"),l=o,u=!1;3===o.rank&&(u=!0,l=ql(o,[1,o.shape[0],o.shape[1],o.shape[2]])),Ze(Vl(s,r),()=>`Error in pool: Either strides or dilations must be 1. Got strides ${s} and dilations '${r}'`);let d,c=Fl(l.shape,t,s,r,a),p=[c.dilationHeight,c.dilationWidth];d="same"===a?function(e,t){let n=e.map((e,n)=>e+(e-1)*(t[n]-1)).map(e=>e-1),a=n.map(e=>Math.floor(e/2)),r=n.map((e,t)=>e-a[t]);return n.map((e,t)=>[a[t],r[t]])}([c.filterHeight,c.filterWidth],p):[[0,0],[0,0]];let h=1===p[0]&&1===p[1],[m,f]=function(e,t,n){let a=n.map(e=>e[0]),r=n.map(e=>e[1]),s=e.concat(a,r),i=t.map((e,t)=>(e-s[t]%e)%e),o=r.map((e,t)=>e+i[t]),l=t.map((e,t)=>[a[t],o[t]]),u=t.map((e,t)=>[0,i[t]]);return[l,u]}([c.inHeight,c.inWidth],p,d),g=h?a:"valid",x=h?l:vc(l,p,m),b=("avg"===n?()=>Kl(x,t,s,g,i):()=>Jd(x,t,s,g,i))(),y=h?b:nu(b,p,f);return u?ql(y,[y.shape[1],y.shape[2],y.shape[3]]):y}}),Nc=Bi({prelu_:function(e,t){let n={x:Li(e,"x","prelu"),alpha:Li(t,"alpha","prelu")};return Ci.runKernel(er,n)}}),Sc=Bi({prod_:function(e,t=null,n=!1){let a=Li(e,"x","prod");"bool"===a.dtype&&(a=pl(a,"int32"));let r={x:a},s={axis:t,keepDims:n};return Ci.runKernel(tr,r,s)}}),Ic=Bi({raggedGather_:function(e,t,n,a){let r={paramsNestedSplits:e.map((e,t)=>Li(e,`tensors${t}`,"raggedGather","int32")),paramsDenseValues:Li(t,"paramsDenseValues","raggedGather"),indices:Li(n,"indices","raggedGather","int32")},s={outputRaggedRank:a},i=Ci.runKernel(nr,r,s);return{outputNestedSplits:i.slice(0,i.length-1),outputDenseValues:i[i.length-1]}}}),_c=Bi({raggedRange_:function(e,t,n){let a=Li(e,"starts","raggedRange"),r={starts:a,limits:Li(t,"limits","raggedRange",a.dtype),deltas:Li(n,"deltas","raggedRange",a.dtype)},s=Ci.runKernel(ar,r);return{rtNestedSplits:s[0],rtDenseValues:s[1]}}}),Cc=Bi({raggedTensorToTensor_:function(e,t,n,a,r){let s=Li(e,"shape","raggedTensorToTensor","int32"),i=Li(t,"values","raggedTensorToTensor"),o={shape:s,values:i,defaultValue:Li(n,"defaultValue","raggedTensorToTensor",i.dtype),rowPartitionTensors:a.map((e,t)=>Li(e,`tensors${t}`,"raggedTensorToTensor","int32"))},l={rowPartitionTypes:r};return Ci.runKernel(rr,o,l)}}),Tc=Bi({rand_:function(e,t,n){Ft(e);let a=et(e),r=null;if(null==n||"float32"===n)r=new Float32Array(a);else if("int32"===n)r=new Int32Array(a);else{if("bool"!==n)throw new Error(`Unknown data type ${n}`);r=new Uint8Array(a)}for(let s=0;s<a;s++)r[s]=t();return Ci.makeTensor(r,e,n)}}),Ec=be(Ae()),Ac={};xe(Ac,{TEST_EPSILON_FLOAT16:()=>Rc,createVideoElement:()=>Vc,encodeStrings:()=>Wc,expectArrayBuffersEqual:()=>Bc,expectArraysClose:()=>Fc,expectArraysEqual:()=>jc,expectNumbersClose:()=>Lc,expectPromiseToFail:()=>Oc,expectValuesInRange:()=>Pc,play:()=>Uc,testEpsilon:()=>Dc});var $c=.001,Rc=.1;function Fc(e,t,n){return null==n&&(n=Dc()),Mc(e,t,(e,t)=>zc(e,t,n))}function Dc(){return 32===Ci.backend.floatPrecision()?$c:Rc}function Mc(e,t,n){let a=!0;if((Gs(e)||Gs(t))&&(a=!1),Gs(e)&&Gs(t)&&(a=!0),a){let n=e.constructor.name,a=t.constructor.name;if(n!==a)throw new Error(`Arrays are of different type. Actual: ${n}. Expected: ${a}`)}if(Array.isArray(e)&&Array.isArray(t)){let n=Mi(e),a=Mi(t);if(!at(n,a))throw new Error(`Arrays have different shapes. Actual: [${n}]. Expected: [${a}]`)}let r=Gs(e)?e:Hs(e),s=Gs(t)?t:Hs(t);if(r.length!==s.length)throw new Error(`Arrays have different lengths actual: ${r.length} vs expected: ${s.length}.\nActual:   ${r}.\nExpected: ${s}.`);for(let i=0;i<s.length;++i){let e=r[i],t=s[i];if(!n(e,t))throw new Error(`Arrays differ: actual[${i}] = ${e}, expected[${i}] = ${t}.\nActual:   ${r}.\nExpected: ${s}.`)}"undefined"!=typeof expect&&expect().nothing()}function Oc(e,t){e().then(()=>t.fail(),()=>t()),"undefined"!=typeof expect&&expect().nothing()}function jc(e,t){let n="string"==typeof t||"number"==typeof t||"boolean"==typeof t?[t]:t;return wt(e)||wt(e[0])||wt(t)||wt(t[0])?Mc(e,n,(e,t)=>e==t):Mc(e,t,(e,t)=>zc(e,t,0))}function Lc(e,t,n){if(null==n&&(n=Dc()),!zc(e,t,n))throw new Error(`Numbers differ: actual === ${e}, expected === ${t}`);"undefined"!=typeof expect&&expect().nothing()}function zc(e,t,n){return!isFinite(e)&&!isFinite(t)||!(isNaN(e)||isNaN(t)||Math.abs(e-t)>n)}function Pc(e,t,n){for(let a=0;a<e.length;a++)if(e[a]<t||e[a]>n)throw new Error(`Value out of range:${e[a]} low: ${t}, high: ${n}`)}function Bc(e,t){let n=new Float32Array(e),a=new Float32Array(t);if(n.length!==a.length)throw new Error(`Expected ArrayBuffer to be of length ${a.length}, but it was ${n.length}`);for(let r=0;r<a.length;r++)if(n[r]!==a[r])throw new Error(`Expected ArrayBuffer value at ${r} to be ${a[r]} but got ${n[r]} instead`)}function Wc(e){for(let t=0;t<e.length;t++){let n=e[t];Array.isArray(n)?Wc(n):e[t]=Vs(n)}return e}function Vc(e){let t=document.createElement("video");return"playsInline"in t&&(t.playsInline=!0),t.muted=!0,t.loop=!0,t.style.position="fixed",t.style.left="0px",t.style.top="0px",t.preload="auto",t.appendChild(e),new Promise(e=>{t.addEventListener("loadeddata",n=>e(t)),t.load()})}async function Uc(e){await e.play(),"requestVideoFrameCallback"in e&&await new Promise(t=>{e.requestVideoFrameCallback(t)})}var Gc=class{constructor(e,t,n,a,r){this.mean=e,this.stdDev=t,this.dtype=n,this.nextVal=NaN,this.truncated=a,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);let s=r||Math.random();this.random=Ec.alea(s.toString())}nextValue(){if(!isNaN(this.nextVal)){let e=this.nextVal;return this.nextVal=NaN,e}let e,t,n=!1;for(;!n;){let a,r,s;do{a=2*this.random()-1,r=2*this.random()-1,s=a*a+r*r}while(s>=1||0===s);let i=Math.sqrt(-2*Math.log(s)/s);e=this.mean+this.stdDev*a*i,t=this.mean+this.stdDev*r*i,(!this.truncated||this.isValidTruncated(e))&&(n=!0)}return(!this.truncated||this.isValidTruncated(t))&&(this.nextVal=this.convertValue(t)),this.convertValue(e)}convertValue(e){return null==this.dtype||"float32"===this.dtype?e:Math.round(e)}isValidTruncated(e){return e<=this.upper&&e>=this.lower}},Hc=class{constructor(e,t,n,a){this.alpha=e,this.beta=1/t,this.dtype=n;let r=a||Math.random();this.randu=Ec.alea(r.toString()),this.randn=new Gc(0,1,n,!1,this.randu()),this.d=e<1?e+2/3:e-1/3,this.c=1/Math.sqrt(9*this.d)}nextValue(){let e,t,n,a,r,s;for(;;){do{a=this.randn.nextValue(),s=1+this.c*a}while(s<=0);if(s*=s*s,e=a*a,t=1-.331*e*e,n=.5*e+this.d*(1-s+Math.log(s)),r=this.randu(),r<t||Math.log(r)<n)break}return s=1/this.beta*this.d*s,this.alpha<1&&(s*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(s)}convertValue(e){return"float32"===this.dtype?e:Math.round(e)}},qc=class{constructor(e=0,t=1,n,a){if(this.canReturnFloat=()=>null==this.dtype||"float32"===this.dtype,this.min=e,this.range=t-e,this.dtype=n,null==a&&(a=Math.random()),"number"==typeof a&&(a=a.toString()),!this.canReturnFloat()&&this.range<=1)throw new Error(`The difference between ${e} - ${t} <= 1 and dtype is not float`);this.random=Ec.alea(a)}convertValue(e){return this.canReturnFloat()?e:Math.round(e)}nextValue(){return this.convertValue(this.min+this.range*this.random())}},Kc=Bi({randomGamma_:function(e,t,n=1,a="float32",r){if(Ft(e),null==n&&(n=1),null==a&&(a="float32"),"float32"!==a&&"int32"!==a)throw new Error(`Unsupported data type ${a}`);let s=new Hc(t,n,a,r),i=cl(e,a);for(let o=0;o<i.values.length;o++)i.values[o]=s.nextValue();return i.toTensor()}}),Xc=Bi({randomNormal_:function(e,t=0,n=1,a,r){if(Ft(e),null!=a&&"bool"===a)throw new Error(`Unsupported data type ${a}`);let s=new Gc(t,n,a,!1,r),i=cl(e,a);for(let o=0;o<i.values.length;o++)i.values[o]=s.nextValue();return i.toTensor()}}),Yc=Bi({randomStandardNormal_:function(e,t,n){if(null!=t&&"bool"===t)throw new Error(`Unsupported data type ${t}`);return Xc(e,0,1,t,n)}}),Zc=Bi({randomUniform_:function(e,t=0,n=1,a="float32",r){Ft(e);let s=cl(e,a),i=new qc(t,n,null,r);for(let o=0;o<s.values.length;o++)s.values[o]=i.nextValue();return s.toTensor()}}),Jc=Bi({randomUniformInt_:function(e,t,n,a){return Zc(e,t,n,"int32",a)}});function Qc(e,t,n=1,a="float32"){if(0===n)throw new Error("Cannot have a step of zero");let r={start:e,stop:t,step:n,dtype:a};return Ci.runKernel(sr,{},r)}var ep=Bi({real_:function(e){let t={input:Li(e,"input","real")};return Ci.runKernel(ir,t)}}),tp=Bi({reciprocal_:function(e){let t={x:Li(e,"x","reciprocal")};return Ci.runKernel(or,t)}}),np=Bi({relu_:function(e){let t={x:Li(e,"x","relu")};return Ci.runKernel(lr,t)}}),ap=Bi({relu6_:function(e){let t={x:Li(e,"x","relu6")};return Ci.runKernel(mr,t)}}),rp=Bi({reverse_:function(e,t){let n={x:Li(e,"x","reverse")},a={dims:t};return Ci.runKernel(fr,n,a)}}),sp=Bi({reverse1d_:function(e){let t=Li(e,"x","reverse");return Ze(1===t.rank,()=>`Error in reverse1D: x must be rank 1 but got rank ${t.rank}.`),rp(t,0)}}),ip=Bi({reverse2d_:function(e,t){let n=Li(e,"x","reverse");return Ze(2===n.rank,()=>`Error in reverse2D: x must be rank 2 but got rank ${n.rank}.`),rp(n,t)}}),op=Bi({reverse3d_:function(e,t){let n=Li(e,"x","reverse");return Ze(3===n.rank,()=>`Error in reverse3D: x must be rank 3 but got rank ${n.rank}.`),rp(n,t)}}),lp=Bi({reverse4d_:function(e,t){let n=Li(e,"x","reverse");return Ze(4===n.rank,()=>`Error in reverse4D: x must be rank 4 but got rank ${n.rank}.`),rp(n,t)}}),up=Bi({round_:function(e){let t={x:Li(e,"x","round")};return Ci.runKernel(gr,t)}}),dp=Bi({rsqrt_:function(e){let t={x:Li(e,"x","rsqrt","float32")};return Ci.runKernel(xr,t)}}),cp=Bi({selu_:function(e){let t={x:Li(e,"x","selu")};return Ci.runKernel(kr,t)}}),pp=Bi({separableConv2d_:function(e,t,n,a,r,s=[1,1],i="NHWC"){let o=Li(e,"x","separableConv2d"),l=Li(t,"depthwiseFilter","separableConv2d"),u=Li(n,"pointwiseFilter","separableConv2d"),d=o,c=!1;if(3===o.rank&&(c=!0,d=ql(o,[1,o.shape[0],o.shape[1],o.shape[2]])),"NCHW"===i)throw new Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");Ze(4===d.rank,()=>`Error in separableConv2d: input must be rank 4, but got rank ${d.rank}.`),Ze(4===l.rank,()=>`Error in separableConv2d: depthwise filter must be rank 4, but got rank ${l.rank}.`),Ze(4===u.rank,()=>`Error in separableConv2d: pointwise filter must be rank 4, but got rank ${l.rank}.`),Ze(1===u.shape[0],()=>`Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got ${u.shape[0]}.`),Ze(1===u.shape[1],()=>`Error in separableConv2d: the second dimension of pointwise filter must be 1, but got ${u.shape[1]}.`);let p=l.shape[2],h=l.shape[3];Ze(u.shape[2]===p*h,()=>`Error in separableConv2d: the third dimension of pointwise filter must be ${p*h}, but got ${u.shape[2]}.`);let m=Ru(d,l,a,r,i,s),f=yu(m,u,1,"valid",i);return c?ql(f,[f.shape[1],f.shape[2],f.shape[3]]):f}}),hp=async function(e,t){let n=Li(e,"x","setdiff1d"),a=Li(t,"y","setdiff1d");Ze(n.dtype===a.dtype,()=>`x and y should have the same dtype, but got x (${n.dtype}) and y (${a.dtype}).`),Ze(1===n.rank,()=>`x should be 1D tensor, but got x (${n.shape}).`),Ze(1===a.rank,()=>`y should be 1D tensor, but got y (${a.shape}).`);let r=await n.data(),s=await a.data(),i=new Set(s),o=0;for(let d=0;d<r.length;d++)i.has(r[d])||o++;let l=new ti([o],n.dtype),u=new ti([o],"int32");for(let d=0,c=0;d<r.length;d++)i.has(r[d])||(l.values[c]=r[d],u.values[c]=d,c++);return[l.toTensor(),u.toTensor()]},mp=Bi({sign_:function(e){let t={x:Li(e,"x","sign")};return Ci.runKernel(_r,t)}}),fp=Bi({sin_:function(e){let t={x:Li(e,"x","sin","float32")};return Ci.runKernel(Sr,t)}}),gp=Bi({sinh_:function(e){let t={x:Li(e,"x","sinh")};return Ci.runKernel(Ir,t)}}),xp=Bi({slice1d_:function(e,t,n){let a=Li(e,"x","slice1d");return Ze(1===a.rank,()=>`slice1d expects a rank-1 tensor, but got a rank-${a.rank} tensor`),Ql(a,[t],[n])}}),bp=Bi({slice2d_:function(e,t,n){let a=Li(e,"x","slice2d");return Ze(2===a.rank,()=>`slice2d expects a rank-2 tensor, but got a rank-${a.rank} tensor`),Ql(a,t,n)}}),yp=Bi({slice3d_:function(e,t,n){let a=Li(e,"x","slice3d");return Ze(3===a.rank,()=>`slice3d expects a rank-3 tensor, but got a rank-${a.rank} tensor`),Ql(a,t,n)}}),wp=Bi({slice4d_:function(e,t,n){let a=Li(e,"x","slice4d");return Ze(4===a.rank,()=>`slice4d expects a rank-4 tensor, but got a rank-${a.rank} tensor`),Ql(a,t,n)}}),vp=Bi({softmax_:function(e,t=-1){let n=Li(e,"logits","softmax","float32");if(-1===t&&(t=n.rank-1),t!==n.rank-1)throw Error(`Softmax along a non-last dimension is not yet supported. Logits was rank ${n.rank} and dim was ${t}`);let a={logits:n},r={dim:t};return Ci.runKernel(Fr,a,r)}}),kp=Bi({fft_:function(e){Ze("complex64"===e.dtype,()=>`The dtype for tf.spectral.fft() must be complex64 but got ${e.dtype}.`);let t={input:e};return Ci.runKernel(Jn,t)}}),Np=Bi({ifft_:function(e){Ze("complex64"===e.dtype,()=>`The dtype for tf.spectral.ifft() must be complex64 but got ${e.dtype}.`);let t={input:e};return Ci.runKernel(ua,t)}}),Sp=Bi({irfft_:function(e){let t,n=e.shape[e.shape.length-1],a=e.size/n;if(n<=2){let r=ql(e,[a,n]);t=Np(r)}else{let r=[a,2*(n-1)],s=ql(ep(e),[a,n]),i=ql(vd(e),[a,n]),o=rp(Ql(s,[0,1],[a,n-2]),1),l=bl(rp(Ql(i,[0,1],[a,n-2]),1),sd(-1)),u=Yl([s,o],1),d=Yl([i,l],1),c=ql(Wi(u,d),[r[0],r[1]]);t=Np(c)}if(t=ep(t),3===e.rank&&0!==e.shape[0]){let n=t,a=e.shape[0];t=ql(t,[a,t.shape[0]/a,t.shape[1]]),n.dispose()}return t}}),Ip=Bi({split_:function(e,t,n=0){let a={x:Li(e,"x","split")},r={numOrSizeSplits:t,axis:n};return Ci.runKernel(Rr,a,r)}}),_p=Bi({rfft_:function(e,t){Ze("float32"===e.dtype,()=>`The dtype for rfft() must be real value but got ${e.dtype}`);let n,a=e.shape[e.shape.length-1],r=e.size/a;if(null!=t&&t<a){let r=e.shape.map(e=>0),s=e.shape.map(e=>e);s[e.shape.length-1]=t,n=Ql(e,r,s),a=t}else if(null!=t&&t>a){let r=e.shape.map(e=>e);r[e.shape.length-1]=t-a,n=Yl([e,ac(r)],e.shape.length-1),a=t}else n=e;let s=Bu(n),i=ql(Wi(n,s),[r,a]),o=kp(i),l=Math.floor(a/2)+1,u=ep(o),d=vd(o),c=Ip(u,[l,a-l],u.shape.length-1),p=Ip(d,[l,a-l],d.shape.length-1),h=n.shape.slice();return h[n.shape.length-1]=l,ql(Wi(c[0],p[0]),h)}}),Cp=Bi({squaredDifference_:function(e,t){let n=Li(e,"a","squaredDifference"),a=Li(t,"b","squaredDifference");[n,a]=bi(n,a),Lu(n.shape,a.shape);let r={a:n,b:a};return Ci.runKernel(zr,r,{})}}),Tp=Bi({squeeze_:function(e,t){let n=Li(e,"x","squeeze","string_or_numeric");return ql(n,pt(n.shape,t).newShape)}}),Ep=Bi({stack_:function(e,t=0){let n=zi(e,"tensors","stack","string_or_numeric");Ze(n.length>=1,()=>"Pass at least one tensor to tf.stack"),n.length>0&&Ze(t<=n[0].rank,()=>"Axis must be <= rank of the tensor");let a=n,r={axis:t};return Ci.runKernel(Ya,a,r)}}),Ap=Bi({step_:function(e,t=0){let n={x:Li(e,"x","step")},a={alpha:t};return Ci.runKernel(rs,n,a)}}),$p=Bi({stridedSlice_:function(e,t,n,a,r=0,s=0,i=0,o=0,l=0){let u={x:Li(e,"x","stridedSlice","string_or_numeric")},d={begin:t,end:n,strides:a,beginMask:r,endMask:s,ellipsisMask:i,newAxisMask:o,shrinkAxisMask:l};return Ci.runKernel(Wr,u,d)}}),Rp=Bi({tan_:function(e){let t={x:Li(e,"x","tan","float32")};return Ci.runKernel(qr,t)}});function Fp(e,t){Qe(e);let n=Mi(e,t);if(1!==n.length)throw new Error("tensor1d() requires values to be a flat/TypedArray");return Vi(e,null,n,t)}function Dp(e,t,n){if(Qe(e),null!=t&&2!==t.length)throw new Error("tensor2d() requires shape to have two numbers");let a=Mi(e,n);if(2!==a.length&&1!==a.length)throw new Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===a.length&&null==t)throw new Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return Vi(e,t,a,n)}function Mp(e,t,n){if(Qe(e),null!=t&&3!==t.length)throw new Error("tensor3d() requires shape to have three numbers");let a=Mi(e,n);if(3!==a.length&&1!==a.length)throw new Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===a.length&&null==t)throw new Error("tensor3d() requires shape to be provided when `values` are a flat array");return Vi(e,t,a,n)}function Op(e,t,n){if(Qe(e),null!=t&&4!==t.length)throw new Error("tensor4d() requires shape to have four numbers");let a=Mi(e,n);if(4!==a.length&&1!==a.length)throw new Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===a.length&&null==t)throw new Error("tensor4d() requires shape to be provided when `values` are a flat array");return Vi(e,t,a,n)}function jp(e,t,n){if(Qe(e),null!=t&&5!==t.length)throw new Error("tensor5d() requires shape to have five numbers");let a=Mi(e,n);if(5!==a.length&&1!==a.length)throw new Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===a.length&&null==t)throw new Error("tensor5d() requires shape to be provided when `values` are a flat array");return Vi(e,t,a,n)}function Lp(e,t,n){if(Qe(e),null!=t&&6!==t.length)throw new Error("tensor6d() requires shape to have six numbers");let a=Mi(e,n);if(6!==a.length&&1!==a.length)throw new Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===a.length&&null==t)throw new Error("tensor6d() requires shape to be provided when `values` are a flat array");return Vi(e,t=t||a,a,n)}var zp={};function Pp(e,t,n){let a=t.rank>1?t.shape[t.rank-1]:1,r=t.rank>1?t.rank-1:1,s=`Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: ${n.shape}, indices.shape: ${t.shape}, shape: ${e}, sliceDim: ${a}, and batchDim: ${r}.`;if(n.rank<r)throw new Error(s+` update.rank < ${r}. `);if(e.length<a+(n.rank-r))throw new Error(s+` Output shape length < ${a+(n.rank-r)}`);if(n.rank!==r+e.length-a)throw new Error(s+" update.rank != "+(r+e.length-a));for(let i=0;i<r;++i)if(n.shape[i]!==t.shape[i])throw new Error(s+` updates.shape[${i}] (${n.shape[i]}) != indices.shape[${i}] (${t.shape[i]}).`);for(let i=0;i<n.rank-r;++i)if(n.shape[i+r]!==e[i+a])throw new Error(s+` updates.shape[${i+r}] (${n.shape[i+r]}) != shape[${i+r}] (${e[i+r]})`)}function Bp(e,t,n){if(t.rank<1)throw new Error(`tf.scatterND() expects the indices to be rank 1 or higher, but the rank was ${t.rank}.`);if(e.rank<1)throw new Error(`tf.scatterND() expects the updates to be rank 1 or higher, but the rank was ${e.rank}.`);if("int32"!==t.dtype)throw new Error(`The dtype of 'indices' should be int32, but got dtype: ${t.dtype}`);if(n.length<1)throw new Error(`Output rank must be greater or equal to 1, but got shape: ${n}`);if(0===n.length){if(0===t.size)throw new Error(`Indices specified for empty output. indices shape: ${t.shape}`);if(0===e.size)throw new Error(`Updates specified for empty output. updates shape: ${e.shape}`)}Pp(n,t,e)}function Wp(e,t,n){let a=t.shape.length,r=a>1?t.shape[a-1]:1,s=n.length,i=1;for(let l=r;l<s;++l)i*=n[l];let o=r<1?1:r;return{sliceRank:r,numUpdates:et(t.shape)/o,sliceSize:i,strides:[..._t(n.slice(0,r)),1],outputSize:et(n)}}xe(zp,{calculateShapes:()=>Wp,validateInput:()=>Bp,validateUpdateShape:()=>Pp});var Vp=Bi({tensorScatterUpdate_:function(e,t,n){let a=Li(e,"tensor","tensorScatterupdate"),r=Li(t,"indices","tensorScatterupdate","int32"),s=Li(n,"updates","tensorScatterupdate");if(Bp(s,r,a.shape),a.dtype!==s.dtype)throw new Error(`tensor and updates must have the same dtype, instead they are ${a.dtype} and ${s.dtype}.`);let i={tensor:a,indices:r,updates:s};return Ci.runKernel(yr,i,{})}}),Up=Bi({topk_:function(e,t=1,n=!0){let a=Li(e,"x","topk");if(0===a.rank)throw new Error("topk() expects the input to be of rank 1 or higher");let r=a.shape[a.shape.length-1];if(t<0)throw new Error(`'k' passed to topk() must be >= 0 but got ${t}`);if(t>r)throw new Error(`'k' passed to topk() must be <= the last dimension (${r}) but got ${t}`);let s={x:a},i={k:t,sorted:n},[o,l]=Ci.runKernel(Yr,s,i);return{values:o,indices:l}}}),Gp=Bi({truncatedNormal_:function(e,t=0,n=1,a,r){if(Ft(e),null!=a&&"bool"===a)throw new Error("Unsupported data type $ { dtype }");let s=new Gc(t,n,a,!0,r),i=cl(e,a);for(let o=0;o<i.values.length;o++)i.values[o]=s.nextValue();return i.toTensor()}}),Hp=Bi({unique_:function(e,t=0){let n=Li(e,"x","unique","string_or_numeric");Ze(n.rank>0,()=>"The input tensor must be at least 1D");let a={x:n},r={axis:t},[s,i]=Ci.runKernel(Qr,a,r);return{values:s,indices:i}}}),qp=Bi({unsortedSegmentSum_:function(e,t,n){let a=Li(e,"x","unsortedSegmentSum"),r=Li(t,"segmentIds","unsortedSegmentSum","int32");Ze(rt(n),()=>"numSegments must be of dtype int");let s={x:a,segmentIds:r},i={numSegments:n};return Ci.runKernel(ts,s,i)}}),Kp=Bi({unstack_:function(e,t=0){let n=Li(e,"x","unstack","string_or_numeric");Ze(t>=-n.shape.length&&t<n.shape.length,()=>`Axis = ${t} is not in [-${n.shape.length}, ${n.shape.length})`);let a={value:n},r={axis:t};return Ci.runKernel(es,a,r)}});function Xp(e,t){return Yd(e,t,"right")}function Yp(e,t=!0,n,a){return Ci.makeVariable(e,t,n,a)}function Zp(e,t){let n=[];for(let s=0;s<t.length;s++)t[s]&&n.push(s);let a=cl(e,"int32"),r=cl([n.length,e.length],"int32");for(let s=0;s<n.length;s++){let t=a.indexToLoc(n[s]),i=s*e.length;r.values.set(t,i)}return r.toTensor()}var Jp=async function(e){let t=Li(e,"condition","whereAsync","bool"),n=await t.data(),a=Zp(t.shape,n);return e!==t&&t.dispose(),a},Qp=async function(e,t,n){let a=Li(e,"tensor","boolMask"),r=Li(t,"mask","boolMask","bool"),s=null==n?0:n,i=r.rank,o=a.shape;Ze(i>0,()=>"mask cannot be scalar"),Je(o.slice(s,s+i),r.shape,"mask's shape must match the first K dimensions of tensor's shape,");let l=1;for(let f=s;f<s+i;f++)l*=o[f];let u=o.slice(0,s).concat([l],o.slice(s+i)),d=ql(a,u),c=ql(r,[-1]),p=await Jp(c),h=Tp(p,[1]),m=bd(d,h,s);return e!==a&&a.dispose(),t!==r&&r.dispose(),h.dispose(),d.dispose(),c.dispose(),p.dispose(),m},eh=Bi({transpose_:function(e,t,n){let a=Li(e,"x","transpose");if(null==t&&(t=a.shape.map((e,t)=>t).reverse()),Ze(a.rank===t.length,()=>`Error in transpose: rank of input ${a.rank} must match length of perm ${t}.`),t.forEach(e=>{Ze(e>=0&&e<a.rank,()=>`All entries in 'perm' must be between 0 and ${a.rank-1} but got ${t}`)}),a.rank<=1)return a.clone();let r={x:a},s={perm:t};return"complex64"===a.dtype?to(()=>{let e=ep(a),t=vd(a);return e=Ci.runKernel(Jr,{x:e},s),t=Ci.runKernel(Jr,{x:t},s),n&&(t=zd(t)),Wi(e,t)}):Ci.runKernel(Jr,r,s)}}),th=Bi({movingAverage_:function(e,t,n,a,r=!0){let s=Li(e,"v","movingAverage"),i=Li(t,"x","movingAverage"),o=Li(n,"decay","movingAverage");yi(s,i),Ze(at(s.shape,i.shape),()=>"Shape mismatch in v and x");let l=sd(1),u=Wd(l,o),d=bl(Wd(i,s),u);if(r){Ze(null!=a,()=>"When using zeroDebias: true, step is required.");let e=Li(a,"step","movingAverage");d=xl(d,Wd(l,rd(o,e)))}return fl(s,d)}}),nh=Bi({scatterND_:function(e,t,n){Ft(n);let a=Li(e,"indices","scatterND","int32"),r=Li(t,"updates","scatterND");Bp(r,a,n);let s={indices:a,updates:r},i={shape:n};return Ci.runKernel(br,s,i)}}),ah=Bi({sparseToDense_:function(e,t,n,a=0){Ft(n);let r=Li(e,"sparseIndices","sparseToDense","int32"),s=Li(t,"sparseValues","sparseToDense","string_or_numeric"),i=Li(a,"defaultValue","sparseToDense",s.dtype);!function(e,t,n,a){if("int32"!==e.dtype)throw new Error(`tf.sparseToDense() expects the indices to be int32 type, but the dtype was ${e.dtype}.`);if(e.rank>2)throw new Error(`sparseIndices should be a scalar, vector, or matrix, but got shape ${e.shape}.`);let r=e.rank>0?e.shape[0]:1,s=e.rank>1?e.shape[1]:1;if(n.length!==s)throw new Error(`outputShape has incorrect number of elements:, ${n.length}, should be: ${s}.`);let i=t.size;if(0!==t.rank&&(1!==t.rank||i!==r))throw new Error(`sparseValues has incorrect shape ${t.shape}, should be [] or [${r}]`);if(t.dtype!==a.dtype)throw new Error("sparseValues.dtype must match defaultValues.dtype")}(r,s,n,i);let o={sparseIndices:r,sparseValues:s,defaultValue:i},l={outputShape:n};return Ci.runKernel(Lr,o,l)}}),rh=Bi({gatherND_:function(e,t){let n=Li(t,"indices","gatherND","int32"),a={params:Li(e,"x","gatherND","string_or_numeric"),indices:n};return Ci.runKernel(sa,a)}}),sh=Bi({dropout_:function(e,t,n,a){let r=Li(e,"x","dropout");if(Ze("float32"===r.dtype,()=>`x has to be a floating point tensor since it's going to be scaled, but got a ${r.dtype} tensor instead.`),Ze(t>=0&&t<1,()=>`rate must be a float in the range [0, 1), but got ${t}.`),0===t)return e instanceof ri?r.clone():r;let s=function(e,t){if(null==t)return e.shape.slice();if(at(e.shape,t))return t;if(e.shape.length===t.length){let n=[];for(let a=0;a<e.shape.length;a++)null==t[a]&&null!=e.shape[a]?n.push(e.shape[a]):n.push(t[a]);return n}return t}(r,n),i=1-t,o=xl(xd(fl(Zc(s,0,1,"float32",a),i)),i);return bl(r,o)}});function ih(e){return Math.floor(Math.pow(2,Math.ceil(Math.log(e)/Math.log(2))))}function oh(e,t,n){let a=1-e%2,r=new Float32Array(e);for(let s=0;s<e;++s){let i=2*Math.PI*s/(e+a-1);r[s]=t-n*Math.cos(i)}return Fp(r,"float32")}var lh=async function(e,t,n=1){let a=Li(e,"predictions","inTopK"),r=Li(t,"targets","inTopK");Ze(a.rank>1,()=>`inTopK() expects the predictions to be of rank 2 or higher, but got ${a.rank}`),Ze(a.rank-1===r.rank,()=>`predictions rank should be 1 larger than targets rank, but got predictions rank ${a.rank} and targets rank ${r.rank}`),Je(a.shape.slice(0,a.shape.length-1),r.shape,"predictions's shape should be align with the targets' shape, except the last dimension.");let s=a.shape[a.shape.length-1];Ze(n>0&&n<=s,()=>`'k' passed to inTopK() must be > 0 && <= the predictions last dimension (${s}), but got ${n}`);let i=await a.data(),o=await r.data(),[l,u]=[i.length/s,s],d=ht("bool",l);for(let c=0;c<l;c++){let e=c*u,t=i.subarray(e,e+u),a=[];for(let n=0;n<t.length;n++)a.push({value:t[n],index:n});a.sort((e,t)=>t.value-e.value),d[c]=0;for(let r=0;r<n;r++)if(a[r].index===o[c]){d[c]=1;break}}return e!==a&&a.dispose(),t!==r&&r.dispose(),Ui(d,r.shape,"bool")},uh={};xe(uh,{conv2d:()=>fh,depthwiseConv2d:()=>bh,matMul:()=>yh});var dh=Bi({conv2DBackpropFilter_:function(e,t,n,a,r,s="NHWC",i){let o=e;3===e.rank&&(o=ql(e,[1,e.shape[0],e.shape[1],e.shape[2]]));let l=t;3===l.rank&&(l=ql(t,[1,t.shape[0],t.shape[1],t.shape[2]])),Ze(4===o.rank,()=>`Error in conv2dDerFilter: input must be rank 4, but got shape ${o.shape}.`),Ze(4===l.rank,()=>`Error in conv2dDerFilter: dy must be rank 4, but got shape ${l.shape}.`),Ze(4===n.length,()=>`Error in conv2dDerFilter: filterShape must be length 4, but got ${n}.`);let u="NHWC"===s?o.shape[3]:o.shape[1],d="NHWC"===s?l.shape[3]:l.shape[1];Ze(u===n[2],()=>`Error in conv2dDerFilter: depth of input ${u}) must match input depth in filter (${n[2]}.`),Ze(d===n[3],()=>`Error in conv2dDerFilter: depth of dy (${d}) must match output depth for filter (${n[3]}).`),Hl("conv2dDerFilter",r,i);let c={x:o,dy:l},p={strides:a,pad:r,dataFormat:s,dimRoundingMode:i,filterShape:n};return Ci.runKernel(Nn,c,p)}});function ch(e,t,n){if(null==n||"linear"===n)return e;if("relu"===n)return bl(e,Ap(t));throw new Error(`Cannot compute gradient for fused activation ${n}.`)}function ph(e,t){let n=t,a=ju(e.shape,t.shape);return a.length>0&&(n=ld(n,a)),ql(n,e.shape)}function hh(e,t,n,a){if("linear"===t)return e;if("relu"===t)return np(e);if("elu"===t)return Gu(e);if("relu6"===t)return ap(e);if("prelu"===t)return Nc(e,n);if("leakyrelu"===t)return Id(e,a);if("sigmoid"===t)return Jl(e);throw new Error(`Unknown fused activation ${t}.`)}var mh=(e,t)=>!(e>0)||"linear"===t,fh=Bi({fusedConv2d_:function({x:e,filter:t,strides:n,pad:a,dataFormat:r="NHWC",dilations:s=[1,1],dimRoundingMode:i,bias:o,activation:l="linear",preluActivationWeights:u,leakyreluAlpha:d}){if(l=l||"linear",!1===mh(Ci.state.gradientDepth,l)){Ze("NHWC"===r,()=>`Error in fused conv2d: got dataFormat of ${r} but only NHWC is currently supported for the case of gradient depth is 0 and the activation is not linear.`);let c=yu(e,t,n,a,r,s,i);return null!=o&&(c=fl(c,o)),hh(c,l,u,d)}let c=Li(e,"x","conv2d","float32"),p=Li(t,"filter","conv2d","float32"),h=c,m=!1;3===c.rank&&(m=!0,h=ql(c,[1,c.shape[0],c.shape[1],c.shape[2]])),Ze(4===h.rank,()=>`Error in fused conv2d: input must be rank 4, but got rank ${h.rank}.`),Ze(4===p.rank,()=>`Error in fused conv2d: filter must be rank 4, but got rank ${p.rank}.`),Hl("fused conv2d",a,i);let f="NHWC"===r?h.shape[3]:h.shape[1];Ze(p.shape[2]===f,()=>`Error in conv2d: depth of input (${f}) must match input depth for filter ${p.shape[2]}.`),Ze(Vl(n,s),()=>`Error in conv2D: Either strides or dilations must be 1. Got strides ${n} and dilations '${s}'`);let g,x,b=Ml(h.shape,p.shape,n,s,a,i);if(null!=o&&(g=Li(o,"bias","fused conv2d"),[g]=bi(g,c),"NHWC"===r?Lu(b.outShape,g.shape):(Ze(g.shape.length<=1,()=>`Error in fused conv2d: only supports scalar or 1-D Tensor bias for NCHW format but got the bias of rank-${g.shape.length}.`),Ze(0===g.shape.length||g.shape[0]===b.outChannels||1===g.shape[0],()=>`Error in fused conv2d: bias shape (${g.shape}) is not compatible with the number of output channels (${b.outChannels})`))),null!=u){let e=u.shape;if(Ze(e.length<=1||3===e.length,()=>`Error in fused conv2d: only supports scalar, 1-D Tensor or 3-D Tensor PReLU activation weights but got a tensor of rank-${e.length}.`),1===e.length)Ze(1===e[0]||e[0]===b.outChannels,()=>`Error in fused conv2d: PReLU activation weights (${e}) is not compatible with the number of output channels (${b.outChannels}).`);else if(3===e.length)try{Lu(e,b.outShape)}catch(k){let t=`Error in fused conv2d: PReLU activation weights (${e}) is not compatible with the output shape of the conv2d (${b.outShape}).`;throw Error(t)}x=Li(u,"prelu weights","fused conv2d")}let y=(e,t)=>{Ze("NHWC"===r,()=>`Error in gradient of fused conv2D: got dataFormat of ${r} but only NHWC is currently supported.`);let[i,o,u,d]=t,c=ch(e,u,l);Ze(Wl(s),()=>`Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '${s}'`);let p=[vu(o.shape,c,i,n,a),dh(o,c,i.shape,n,a)];if(null!=d){let e=ph(d,c);p.push(e)}return p},w={x:h,filter:p,bias:g,preluActivationWeights:x},v={strides:n,pad:a,dataFormat:r,dilations:s,dimRoundingMode:i,activation:l,leakyreluAlpha:d};return null==o?jd((e,t,n)=>{let a=Ci.runKernel(ls,w,v);return n([t,e,a]),m&&(a=ql(a,[a.shape[1],a.shape[2],a.shape[3]])),{value:a,gradFunc:y}})(h,p):jd((e,t,n,a)=>{let r=Ci.runKernel(ls,w,v);return a([t,e,r,n]),m&&(r=ql(r,[r.shape[1],r.shape[2],r.shape[3]])),{value:r,gradFunc:y}})(h,p,g)}}),gh=Bi({depthwiseConv2dNativeBackpropFilter_:function(e,t,n,a,r,s=[1,1],i){let o=e;3===e.rank&&(o=ql(e,[1,e.shape[0],e.shape[1],e.shape[2]]));let l=t;3===l.rank&&(l=ql(t,[1,t.shape[0],t.shape[1],t.shape[2]]));let u={x:o,dy:l},d={strides:a,pad:r,dimRoundingMode:i,dilations:s,filterShape:n};return Ci.runKernel(On,u,d)}}),xh=Bi({depthwiseConv2dNativeBackpropInput_:function(e,t,n,a,r,s=[1,1],i){let o=t,l=!1;3===t.rank&&(l=!0,o=ql(t,[1,t.shape[0],t.shape[1],t.shape[2]]));let u={dy:o,filter:n},d={strides:a,pad:r,dimRoundingMode:i,dilations:s,inputShape:e},c=Ci.runKernel(jn,u,d);return l?ql(c,[c.shape[1],c.shape[2],c.shape[3]]):c}}),bh=Bi({fusedDepthwiseConv2d_:function({x:e,filter:t,strides:n,pad:a,dataFormat:r="NHWC",dilations:s=[1,1],dimRoundingMode:i,bias:o,activation:l="linear",preluActivationWeights:u,leakyreluAlpha:d}){if(!1===mh(Ci.state.gradientDepth,l)){let c=Ru(e,t,n,a,r,s,i);return null!=o&&(c=fl(c,o)),hh(c,l,u,d)}let c=Li(e,"x","depthwiseConv2d","float32"),p=Li(t,"filter","depthwiseConv2d","float32"),h=c,m=!1;3===c.rank&&(m=!0,h=ql(c,[1,c.shape[0],c.shape[1],c.shape[2]])),Ze(4===h.rank,()=>`Error in fused depthwiseConv2d: input must be rank 4, but got rank ${h.rank}.`),Ze(4===p.rank,()=>`Error in fused depthwiseConv2d: filter must be rank 4, but got rank ${p.rank}.`),Ze(h.shape[3]===p.shape[2],()=>`Error in fused depthwiseConv2d: number of input channels (${h.shape[3]}) must match the inChannels dimension in filter ${p.shape[2]}.`),null==s&&(s=[1,1]),Ze(Vl(n,s),()=>`Error in fused depthwiseConv2d: Either strides or dilations must be 1. Got strides ${n} and dilations '${s}'`),Hl("fused depthwiseConv2d",a,i);let f,g,x=Ml(h.shape,p.shape,n,s,a,i,!0);null!=o&&(f=Li(o,"bias","fused conv2d"),[f]=bi(f,c),Lu(x.outShape,f.shape)),null!=u&&(g=Li(u,"prelu weights","fused depthwiseConv2d"));let b=(e,t)=>{Ze(Wl(s),()=>`Error in gradient of fused depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '${s}'`);let[r,o,u,d]=t,c=ch(e,u,l),p=xh(o.shape,c,r,n,a,s,i),h=gh(o,c,r.shape,n,a,s,i);return null!=d?[p,h,ph(f,c)]:[p,h]},y={x:h,filter:p,bias:f,preluActivationWeights:g},w={strides:n,pad:a,dataFormat:r,dilations:s,dimRoundingMode:i,activation:l,leakyreluAlpha:d};return null==o?jd((e,t,n)=>{let a=Ci.runKernel(us,y,w);return n([t,e,a]),m&&(a=ql(a,[a.shape[1],a.shape[2],a.shape[3]])),{value:a,gradFunc:b}})(h,p):jd((e,t,n,a)=>{let r=Ci.runKernel(us,y,w);return a([t,e,r,n]),m&&(r=ql(r,[r.shape[1],r.shape[2],r.shape[3]])),{value:r,gradFunc:b}})(h,p,f)}}),yh=Bi({fusedMatMul_:function({a:e,b:t,transposeA:n=!1,transposeB:a=!1,bias:r,activation:s="linear",preluActivationWeights:i,leakyreluAlpha:o=.2}){if(!1===mh(Ci.state.gradientDepth,s)){let l=Zl(e,t,n,a);return null!=r&&(l=fl(l,r)),hh(l,s,i,o)}let l=Li(e,"a","fused matMul"),u=Li(t,"b","fused matMul");[l,u]=bi(l,u);let d=n?l.shape[l.rank-2]:l.shape[l.rank-1],c=a?u.shape[u.rank-1]:u.shape[u.rank-2],p=n?l.shape[l.rank-1]:l.shape[l.rank-2],h=a?u.shape[u.rank-2]:u.shape[u.rank-1],m=l.shape.slice(0,-2),f=u.shape.slice(0,-2),g=et(m),x=et(f);Ze(d===c,()=>`Error in fused matMul: inner shapes (${d}) and (${c}) of Tensors with shapes ${l.shape} and ${u.shape} and transposeA=${n} and transposeB=${a} must match.`);let b,y,w=Lu(l.shape.slice(0,-2),u.shape.slice(0,-2)).concat([p,h]),v=ql(l,n?[g,d,p]:[g,p,d]),k=ql(u,a?[x,h,c]:[x,c,h]);null!=r&&(b=Li(r,"bias","fused matMul"),[b]=bi(b,l),Lu(w,b.shape)),null!=i&&(y=Li(i,"prelu weights","fused matMul"));let N=(e,t)=>{let i,o,[l,u,d,c]=t,p=ch(ql(e,d.shape),d,s);return n||a?!n&&a?(i=Zl(p,u,!1,!1),o=Zl(p,l,!0,!1)):n&&!a?(i=Zl(u,p,!1,!0),o=Zl(l,p,!1,!1)):(i=Zl(u,p,!0,!0),o=Zl(p,l,!0,!0)):(i=Zl(p,u,!1,!0),o=Zl(l,p,!0,!1)),null!=r?[i,o,ph(c,p)]:[i,o]},S={a:v,b:k,bias:b,preluActivationWeights:y},I={transposeA:n,transposeB:a,activation:s,leakyreluAlpha:o};return null==r?jd((e,t,n)=>{let a=Ci.runKernel(os,S,I);return n([e,t,a]),{value:ql(a,w),gradFunc:N}})(v,k):jd((e,t,n,a)=>{let r=Ci.runKernel(os,S,I);return a([e,t,r,n]),{value:ql(r,w),gradFunc:N}})(v,k,b)}}),wh=Bi({hammingWindow_:function(e){return oh(e,.54,.46)}}),vh=Bi({hannWindow_:function(e){return oh(e,.5,.5)}}),kh=Bi({frame_:function(e,t,n,a=!1,r=0){let s=0,i=[];for(;s+t<=e.size;)i.push(Ql(e,s,t)),s+=n;if(a)for(;s<e.size;){let a=s+t-e.size,o=Yl([Ql(e,s,t-a),hu([a],r)]);i.push(o),s+=n}return 0===i.length?Dp([],[0,t]):ql(Yl(i),[i.length,t])}}),Nh=Bi({stft_:function(e,t,n,a,r=vh){null==a&&(a=ih(t));let s=kh(e,t,n),i=bl(s,r(t));return _p(i,a)}}),Sh=Bi({cropAndResize_:function(e,t,n,a,r="bilinear",s=0){let i=Li(e,"image","cropAndResize"),o=Li(t,"boxes","cropAndResize","float32"),l=Li(n,"boxInd","cropAndResize","int32"),u=o.shape[0];Ze(4===i.rank,()=>`Error in cropAndResize: image must be rank 4,but got rank ${i.rank}.`),Ze(2===o.rank&&4===o.shape[1],()=>`Error in cropAndResize: boxes must be have size [${u},4] but had shape ${o.shape}.`),Ze(1===l.rank&&l.shape[0]===u,()=>`Error in cropAndResize: boxInd must be have size [${u}] but had shape ${o.shape}.`),Ze(2===a.length,()=>`Error in cropAndResize: cropSize must be of length 2, but got length ${a.length}.`),Ze(a[0]>=1&&a[1]>=1,()=>`cropSize must be atleast [1,1], but was ${a}`),Ze("bilinear"===r||"nearest"===r,()=>`method must be bilinear or nearest, but was ${r}`);let d={image:i,boxes:o,boxInd:l},c={method:r,extrapolationValue:s,cropSize:a};return Ci.runKernel(Rn,d,c)}}),Ih=Bi({flipLeftRight_:function(e){let t=Li(e,"image","flipLeftRight","float32");Ze(4===t.rank,()=>`Error in flipLeftRight: image must be rank 4,but got rank ${t.rank}.`);let n={image:t};return Ci.runKernel(ea,n,{})}}),_h=Bi({grayscaleToRGB_:function(e){let t=Li(e,"image","grayscaleToRGB"),n=t.rank-1,a=t.shape[n];Ze(t.rank>=2,()=>`Error in grayscaleToRGB: images must be at least rank 2, but got rank ${t.rank}.`),Ze(1===a,()=>`Error in grayscaleToRGB: last dimension of a grayscale image should be size 1, but got size ${a}.`);let r=new Array(t.rank);return r.fill(1,0,n),r[n]=3,fd(t,r)}}),Ch=Bi({rgbToGrayscale_:function(e){let t=Li(e,"image","RGBToGrayscale"),n=t.rank-1,a=t.shape[n];Ze(t.rank>=2,()=>`Error in RGBToGrayscale: images must be at least rank 2, but got rank ${t.rank}.`),Ze(3===a,()=>`Error in RGBToGrayscale: last dimension of an RGB image should be size 3, but got size ${a}.`);let r,s=t.dtype,i=pl(t,"float32"),o=Fp([.2989,.587,.114]);switch(t.rank){case 2:r=Uu("ij,j->i",i,o);break;case 3:r=Uu("ijk,k->ij",i,o);break;case 4:r=Uu("ijkl,l->ijk",i,o);break;case 5:r=Uu("ijklm,m->ijkl",i,o);break;case 6:r=Uu("ijklmn,n->ijklm",i,o);break;default:throw new Error("Not a valid tensor rank.")}return r=hd(r,-1),pl(r,s)}}),Th=Bi({rotateWithOffset_:function(e,t,n=0,a=.5){let r=Li(e,"image","rotateWithOffset","float32");Ze(4===r.rank,()=>`Error in rotateWithOffset: image must be rank 4,but got rank ${r.rank}.`);let s={image:r},i={radians:t,fillValue:n,center:a};return Ci.runKernel(is,s,i)}});function Eh(e,t,n,a,r,s){null==a&&(a=.5),null==r&&(r=Number.NEGATIVE_INFINITY),null==s&&(s=0);let i=e.shape[0];return n=Math.min(n,i),Ze(0<=a&&a<=1,()=>`iouThreshold must be in [0, 1], but was '${a}'`),Ze(2===e.rank,()=>`boxes must be a 2D tensor, but was of rank '${e.rank}'`),Ze(4===e.shape[1],()=>`boxes must have 4 columns, but 2nd dimension was ${e.shape[1]}`),Ze(1===t.rank,()=>"scores must be a 1D tensor"),Ze(t.shape[0]===i,()=>`scores has incompatible shape with boxes. Expected ${i}, but was ${t.shape[0]}`),Ze(0<=s&&s<=1,()=>`softNmsSigma must be in [0, 1], but was '${s}'`),{maxOutputSize:n,iouThreshold:a,scoreThreshold:r,softNmsSigma:s}}var Ah=Bi({nonMaxSuppression_:function(e,t,n,a=.5,r=Number.NEGATIVE_INFINITY){let s=Li(e,"boxes","nonMaxSuppression","float32"),i=Li(t,"scores","nonMaxSuppression","float32"),o=Eh(s,i,n,a,r),l={maxOutputSize:n=o.maxOutputSize,iouThreshold:a=o.iouThreshold,scoreThreshold:r=o.scoreThreshold};return Ci.runKernel(Ga,{boxes:s,scores:i},l)}});function $h(e,t,n){let a=function(e,t,n){return function(e,t,n){let a=0,r=e.length,s=0,i=!1;for(;a<r;){s=a+(r-a>>>1);let o=n(t,e[s]);o>0?a=s+1:(r=s,i=!o)}return i?a:-a-1}(e,t,n||Rh)}(e,t,n),r=a<0?-(a+1):a;e.splice(r,0,t)}function Rh(e,t){return e>t?1:e<t?-1:0}function Fh(e,t,n,a,r){return Oh(e,t,n,a,r,0)}function Dh(e,t,n,a,r,s){return Oh(e,t,n,a,r,0,!1,s,!0)}function Mh(e,t,n,a,r,s){return Oh(e,t,n,a,r,s,!0)}function Oh(e,t,n,a,r,s,i=!1,o=!1,l=!1){let u=[];for(let g=0;g<t.length;g++)t[g]>r&&u.push({score:t[g],boxIndex:g,suppressBeginIndex:0});u.sort(zh);let d=s>0?-.5/s:0,c=[],p=[];for(;c.length<n&&u.length>0;){let t=u.pop(),{score:n,boxIndex:s,suppressBeginIndex:i}=t;if(n<r)break;let o=!1;for(let l=c.length-1;l>=i;--l){let n=jh(e,s,c[l]);if(n>=a){o=!0;break}if(t.score=t.score*Lh(a,d,n),t.score<=r)break}t.suppressBeginIndex=c.length,o||(t.score===n?(c.push(s),p.push(t.score)):t.score>r&&$h(u,t,zh))}let h=c.length,m=n-h;o&&m>0&&(c.push(...new Array(m).fill(0)),p.push(...new Array(m).fill(0)));let f={selectedIndices:c};return i&&(f.selectedScores=p),l&&(f.validOutputs=h),f}function jh(e,t,n){let a=e.subarray(4*t,4*t+4),r=e.subarray(4*n,4*n+4),s=Math.min(a[0],a[2]),i=Math.min(a[1],a[3]),o=Math.max(a[0],a[2]),l=Math.max(a[1],a[3]),u=Math.min(r[0],r[2]),d=Math.min(r[1],r[3]),c=Math.max(r[0],r[2]),p=Math.max(r[1],r[3]),h=(o-s)*(l-i),m=(c-u)*(p-d);if(h<=0||m<=0)return 0;let f=Math.max(s,u),g=Math.max(i,d),x=Math.min(o,c),b=Math.min(l,p),y=Math.max(x-f,0)*Math.max(b-g,0);return y/(h+m-y)}function Lh(e,t,n){let a=Math.exp(t*n*n);return n<=e?a:0}function zh(e,t){return e.score-t.score||e.score===t.score&&t.boxIndex-e.boxIndex}var Ph=Bi({nonMaxSuppressionWithScore_:function(e,t,n,a=.5,r=Number.NEGATIVE_INFINITY,s=0){let i=Li(e,"boxes","nonMaxSuppression"),o=Li(t,"scores","nonMaxSuppression"),l=Eh(i,o,n,a,r,s),u={boxes:i,scores:o},d={maxOutputSize:n=l.maxOutputSize,iouThreshold:a=l.iouThreshold,scoreThreshold:r=l.scoreThreshold,softNmsSigma:s=l.softNmsSigma},c=Ci.runKernel(qa,u,d);return{selectedIndices:c[0],selectedScores:c[1]}}}),Bh=Bi({nonMaxSuppressionPadded_:function(e,t,n,a=.5,r=Number.NEGATIVE_INFINITY,s=!1){let i=Li(e,"boxes","nonMaxSuppression"),o=Li(t,"scores","nonMaxSuppression"),l=Eh(i,o,n,a,r,null),u={boxes:i,scores:o},d={maxOutputSize:l.maxOutputSize,iouThreshold:l.iouThreshold,scoreThreshold:l.scoreThreshold,padToMaxOutputSize:s},c=Ci.runKernel(Ha,u,d);return{selectedIndices:c[0],validOutputs:c[1]}}}),Wh=Bi({resizeBilinear_:function(e,t,n=!1,a=!1){let r=Li(e,"images","resizeBilinear");Ze(3===r.rank||4===r.rank,()=>`Error in resizeBilinear: x must be rank 3 or 4, but got rank ${r.rank}.`),Ze(2===t.length,()=>`Error in resizeBilinear: new shape must 2D, but got shape ${t}.`),Ze(!1===a||!1===n,()=>"Error in resizeBilinear: If halfPixelCenters is true, alignCorners must be false.");let s=r,i=!1;3===r.rank&&(i=!0,s=ql(r,[1,r.shape[0],r.shape[1],r.shape[2]]));let o={images:s},l={alignCorners:n,halfPixelCenters:a,size:t},u=Ci.runKernel(pr,o,l);return i?ql(u,[u.shape[1],u.shape[2],u.shape[3]]):u}}),Vh=Bi({resizeNearestNeighbor_:function(e,t,n=!1,a=!1){let r=Li(e,"images","resizeNearestNeighbor");Ze(3===r.rank||4===r.rank,()=>`Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank ${r.rank}.`),Ze(2===t.length,()=>`Error in resizeNearestNeighbor: new shape must 2D, but got shape ${t}.`),Ze("float32"===r.dtype||"int32"===r.dtype,()=>"`images` must have `int32` or `float32` as dtype"),Ze(!1===a||!1===n,()=>"Error in resizeNearestNeighbor: If halfPixelCenters is true, alignCorners must be false.");let s=r,i=!1;3===r.rank&&(i=!0,s=ql(r,[1,r.shape[0],r.shape[1],r.shape[2]]));let o={images:s},l={alignCorners:n,halfPixelCenters:a,size:t},u=Ci.runKernel(dr,o,l);return i?ql(u,[u.shape[1],u.shape[2],u.shape[3]]):u}}),Uh=Bi({threshold_:function(e,t="binary",n=!1,a=.5){let r,s,i,o,l=Li(e,"image","threshold"),u=l.shape[0]*l.shape[1],d=bl(Fp([a]),255);if(Ze(3===l.rank,()=>`Error in threshold: image must be rank 3,but got rank ${l.rank}.`),Ze(3===l.shape[2]||1===l.shape[2],()=>`Error in threshold: image color channel must be equal to 3 or 1but got ${l.shape[2]}.`),Ze("int32"===l.dtype||"float32"===l.dtype,()=>`Error in dtype: image dtype must be int32 or float32,but got dtype ${l.dtype}.`),Ze("otsu"===t||"binary"===t,()=>`Method must be binary or otsu, but was ${t}`),3===l.shape[2]){[r,s,i]=Ip(l,[1,1,1],-1);let e=bl(r,.2989),t=bl(s,.587),n=bl(i,.114);o=fl(fl(e,t),n)}else o=e;"otsu"===t&&(d=function(e,t){let n,a,r,s,i,o,l=Fp([-1]),u=Fp([0]),d=Fp([0]);for(let c=0;c<e.size-1;c++){n=Ql(e,0,c+1),a=Ql(e,c+1),i=xl(ld(n),t),o=xl(ld(a),t);let p=ld(bl(n,Qc(0,n.size)));r=xl(p,ld(n));let h=hu(a.shape,n.size),m=fl(Qc(0,a.size),h),f=bl(a,m);s=xl(ld(f),ld(a));let g=Wd(r,s),x=Wd(r,s),b=bl(i,o);d=bl(bl(b,g),x);let y=yd(d,u);u=Pu(y,d,u),l=Pu(y,Fp([c]),l)}return l}(lu(pl(up(o),"int32"),Ui([]),256),u));let c=n?Cd(o,d):yd(o,d);return pl(bl(c,255),"int32")}}),Gh=Bi({transform_:function(e,t,n="nearest",a="constant",r=0,s){let i=Li(e,"image","transform","float32"),o=Li(t,"transforms","transform","float32");Ze(4===i.rank,()=>`Error in transform: image must be rank 4,but got rank ${i.rank}.`),Ze(2===o.rank&&(o.shape[0]===i.shape[0]||1===o.shape[0])&&8===o.shape[1],()=>"Error in transform: Input transform should be batch x 8 or 1 x 8"),Ze(null==s||2===s.length,()=>`Error in transform: outputShape must be [height, width] or null, but got ${s}.`);let l={image:i,transforms:o},u={interpolation:n,fillMode:a,fillValue:r,outputShape:s};return Ci.runKernel(Zr,l,u)}}),Hh=Bi({bandPart_:function(e,t,n){let a=Li(e,"a","bandPart");Ze(a.rank>=2,()=>`bandPart(): Rank must be at least 2, got ${a.rank}.`);let r,s,i=a.shape,[o,l]=a.shape.slice(-2);"number"==typeof t?(Ze(t%1==0,()=>`bandPart(): numLower must be an integer, got ${t}.`),Ze(t<=o,()=>`bandPart(): numLower (${t}) must not be greater than the number of rows (${o}).`),r=Li(t<0?o:t,"numLower","bandPart")):(Ze("int32"===t.dtype,()=>"bandPart(): numLower's dtype must be an int32."),r=Pu(_d(t,0),o,ic(t,o))),"number"==typeof n?(Ze(n%1==0,()=>`bandPart(): numUpper must be an integer, got ${n}.`),Ze(n<=l,()=>`bandPart(): numUpper (${n}) must not be greater than the number of columns (${l}).`),s=Li(n<0?l:n,"numUpper","bandPart")):(Ze("int32"===n.dtype,()=>"bandPart(): numUpper's dtype must be an int32."),s=Pu(_d(n,0),l,ic(n,l)));let u=ql(Qc(0,o,1,"int32"),[-1,1]),d=Qc(0,l,1,"int32"),c=Wd(u,d),p=Gd(Cd(c,r),wd(c,zd(s))),h=ac([o,l],a.dtype);return ql(Ep(Kp(ql(a,[-1,o,l])).map(e=>Pu(p,e,h))),i)}}),qh=Bi({gramSchmidt_:function(e){let t;if(Array.isArray(e)){t=!1,Ze(null!=e&&e.length>0,()=>"Gram-Schmidt process: input must not be null, undefined, or empty");let n=e[0].shape[0];for(let t=1;t<e.length;++t)Ze(e[t].shape[0]===n,()=>`Gram-Schmidt: Non-unique lengths found in the input vectors: (${e[t].shape[0]} vs. ${n})`)}else t=!0,e=Ip(e,e.shape[0],0).map(e=>Tp(e,[0]));Ze(e.length<=e[0].shape[0],()=>`Gram-Schmidt: Number of vectors (${e.length}) exceeds number of dimensions (${e[0].shape[0]}).`);let n=[],a=e;for(let r=0;r<e.length;++r)n.push(Ci.tidy(()=>{let e=a[r];if(r>0)for(let t=0;t<r;++t){let a=bl(ld(bl(n[t],e)),n[t]);e=Wd(e,a)}return xl(e,dd(e,"euclidean"))}));return t?Ep(n,0):n}});function Kh(e,t=!1){return Ci.tidy(()=>{Ze(2===e.shape.length,()=>`qr2d() requires a 2D Tensor, but got a ${e.shape.length}D Tensor.`);let n=e.shape[0],a=e.shape[1],r=gd(n),s=hl(e),i=Dp([[1]],[1,1]),o=hl(i),l=n>=a?a:n;for(let e=0;e<l;++e){let t=s,l=o,u=r;[o,s,r]=Ci.tidy(()=>{let t=Ql(s,[e,e],[n-e,1]),l=dd(t),u=Ql(s,[e,e],[1,1]),d=Pu(yd(u,0),Dp([[-1]]),Dp([[1]])),c=Wd(u,bl(d,l)),p=xl(t,c);o=1===p.shape[0]?hl(i):Yl([i,Ql(p,[1,0],[p.shape[0]-1,p.shape[1]])],0);let h=zd(xl(Zl(d,c),l)),m=Ql(s,[e,0],[n-e,a]),f=bl(h,o),g=eh(o);if(0===e)s=Wd(m,Zl(f,Zl(g,m)));else{let t=Wd(m,Zl(f,Zl(g,m)));s=Yl([Ql(s,[0,0],[e,a]),t],0)}let x=eh(f),b=Ql(r,[0,e],[n,r.shape[1]-e]);if(0===e)r=Wd(b,Zl(Zl(b,o),x));else{let t=Wd(b,Zl(Zl(b,o),x));r=Yl([Ql(r,[0,0],[n,e]),t],1)}return[o,s,r]}),no([t,l,u])}return!t&&n>a&&(r=Ql(r,[0,0],[n,a]),s=Ql(s,[0,0],[a,a])),[r,s]})}var Xh,Yh=Bi({qr_:function(e,t=!1){if(Ze(e.rank>=2,()=>`qr() requires input tensor to have a rank >= 2, but got rank ${e.rank}`),2===e.rank)return Kh(e,t);{let n=e.shape.slice(0,e.shape.length-2).reduce((e,t)=>e*t),a=Kp(ql(e,[n,e.shape[e.shape.length-2],e.shape[e.shape.length-1]]),0),r=[],s=[];return a.forEach(e=>{let[n,a]=Kh(e,t);r.push(n),s.push(a)}),[ql(Ep(r,0),e.shape),ql(Ep(s,0),e.shape)]}}});!function(e){e[e.NONE=0]="NONE",e[e.MEAN=1]="MEAN",e[e.SUM=2]="SUM",e[e.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS"}(Xh||(Xh={}));var Zh=Bi({computeWeightedLoss_:function(e,t,n=Xh.SUM_BY_NONZERO_WEIGHTS){let a=Li(e,"losses","computeWeightedLoss"),r=null;null!=t&&(r=Li(t,"weights","computeWeightedLoss"));let s=null==r?a:bl(a,r);if(n===Xh.NONE)return s;if(n===Xh.SUM)return ld(s);if(n===Xh.MEAN){if(null==r)return nc(s);{let e=a.size/r.size,t=xl(ld(s),ld(r));return e>1?xl(t,sd(e)):t}}if(n===Xh.SUM_BY_NONZERO_WEIGHTS){if(null==r)return xl(ld(s),sd(a.size));{let e=bl(r,rc(a.shape)),t=pl(ld(pc(e,sd(0))),"float32");return xl(ld(s),t)}}throw Error(`Unknown reduction: ${n}`)}}),Jh=Bi({absoluteDifference_:function(e,t,n,a=Xh.SUM_BY_NONZERO_WEIGHTS){let r=Li(e,"labels","absoluteDifference"),s=Li(t,"predictions","absoluteDifference"),i=null;null!=n&&(i=Li(n,"weights","absoluteDifference")),Je(r.shape,s.shape,"Error in absoluteDifference: ");let o=yl(Wd(r,s));return Zh(o,i,a)}}),Qh=Bi({cosineDistance_:function(e,t,n,a,r=Xh.SUM_BY_NONZERO_WEIGHTS){let s=Li(e,"labels","cosineDistance"),i=Li(t,"predictions","cosineDistance"),o=null;null!=a&&(o=Li(a,"weights","cosineDistance")),Je(s.shape,i.shape,"Error in cosineDistance: ");let l=sd(1),u=Wd(l,ld(bl(s,i),n,!0));return Zh(u,o,r)}}),em=Bi({hingeLoss_:function(e,t,n,a=Xh.SUM_BY_NONZERO_WEIGHTS){let r=Li(e,"labels","hingeLoss"),s=Li(t,"predictions","hingeLoss"),i=null;null!=n&&(i=Li(n,"weights","hingeLoss")),Je(r.shape,s.shape,"Error in hingeLoss: ");let o=sd(1);r=Wd(bl(sd(2),r),o);let l=np(Wd(o,bl(r,s)));return Zh(l,i,a)}}),tm=Bi({huberLoss_:function(e,t,n,a=1,r=Xh.SUM_BY_NONZERO_WEIGHTS){let s=Li(e,"labels","huberLoss"),i=Li(t,"predictions","huberLoss"),o=null;null!=n&&(o=Li(n,"weights","huberLoss")),Je(s.shape,i.shape,"Error in huberLoss: ");let l=sd(a),u=yl(Wd(i,s)),d=ic(u,l),c=Wd(u,d),p=fl(bl(sd(.5),od(d)),bl(l,c));return Zh(p,o,r)}}),nm=Bi({logLoss_:function(e,t,n,a=1e-7,r=Xh.SUM_BY_NONZERO_WEIGHTS){let s=Li(e,"labels","logLoss"),i=Li(t,"predictions","logLoss"),o=null;null!=n&&(o=Li(n,"weights","logLoss")),Je(s.shape,i.shape,"Error in logLoss: ");let l=sd(1),u=sd(a),d=zd(bl(s,Ad(fl(i,u)))),c=bl(Wd(l,s),Ad(fl(Wd(l,i),u))),p=Wd(d,c);return Zh(p,o,r)}}),am=Bi({meanSquaredError_:function(e,t,n,a=Xh.SUM_BY_NONZERO_WEIGHTS){let r=Li(e,"labels","meanSquaredError"),s=Li(t,"predictions","meanSquaredError"),i=null;null!=n&&(i=Li(n,"weights","meanSquaredError")),Je(r.shape,s.shape,"Error in meanSquaredError: ");let o=Cp(r,s);return Zh(o,i,a)}}),rm=Bi({sigmoidCrossEntropy_:function(e,t,n,a=0,r=Xh.SUM_BY_NONZERO_WEIGHTS){let s=Li(e,"multiClassLabels","sigmoidCrossEntropy"),i=Li(t,"logits","sigmoidCrossEntropy"),o=null;if(null!=n&&(o=Li(n,"weights","sigmoidCrossEntropy")),Je(s.shape,i.shape,"Error in sigmoidCrossEntropy: "),a>0){let e=sd(a),t=sd(1),n=sd(.5);s=fl(bl(s,Wd(t,e)),bl(n,e))}let l=function(e,t){let n=Li(e,"labels","sigmoidCrossEntropyWithLogits"),a=Li(t,"logits","sigmoidCrossEntropyWithLogits");Je(n.shape,a.shape,"Error in sigmoidCrossEntropyWithLogits: ");let r=np(a),s=bl(a,n),i=$d(pd(zd(yl(a))));return fl(Wd(r,s),i)}(s,i);return Zh(l,o,r)}}),sm=Bi({softmaxCrossEntropy_:function(e,t,n,a=0,r=Xh.SUM_BY_NONZERO_WEIGHTS){let s=Li(e,"onehotLabels","softmaxCrossEntropy"),i=Li(t,"logits","softmaxCrossEntropy"),o=null;if(null!=n&&(o=Li(n,"weights","softmaxCrossEntropy")),Je(s.shape,i.shape,"Error in softmaxCrossEntropy: "),a>0){let e=sd(a),t=sd(1),n=sd(s.shape[1]);s=fl(bl(s,Wd(t,e)),xl(e,n))}let l=function(e,t,n=-1){if(-1===n&&(n=t.rank-1),n!==t.rank-1)throw Error(`Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank ${t.rank} and dim was ${n}`);return jd((e,t,a)=>{let r=Ud(t,[n],!0),s=Wd(pl(t,"float32"),r);a([e,s]);let i=zd(bl(s,e));return{value:ld(i,[n]),gradFunc:(e,t)=>{let[a,r]=t,s=Zu(e.shape,[n]);return[bl(ql(e,s),Wd(pl(a,"float32"),pd(r))),bl(ql(e,s),Wd(pd(r),pl(a,"float32")))]}}})(e,t)}(s,i);return Zh(l,o,r)}}),im=Bi({sparseFillEmptyRows_:function(e,t,n,a){let r=Li(e,"indices","sparseFillEmptyRows","int32"),s=Li(t,"values","sparseFillEmptyRows"),i=Li(n,"denseShape","sparseFillEmptyRows","int32"),o=Li(a,"defaultValue","sparseFillEmptyRows",s.dtype);if(2!==r.rank)throw new Error(`Indices should be Tensor2D but received shape\n        ${r.shape}`);if(1!==s.rank)throw new Error(`Values should be Tensor1D but received shape ${s.shape}`);if(1!==i.rank)throw new Error(`Dense shape should be Tensor1D but received shape ${i.shape}`);if(0!==o.rank)throw new Error(`Default value should be a scalar but received shape ${o.shape}`);let l={indices:r,values:s,denseShape:i,defaultValue:o},u=Ci.runKernel(Dr,l);return{outputIndices:u[0],outputValues:u[1],emptyRowIndicator:u[2],reverseIndexMap:u[3]}}}),om=Bi({sparseReshape_:function(e,t,n){let a=Li(e,"inputIndices","sparseReshape","int32"),r=Li(t,"inputShape","sparseReshape","int32"),s=Li(n,"newShape","sparseReshape","int32");if(2!==a.rank)throw new Error(`Input indices should be Tensor2D but received shape\n        ${a.shape}`);if(1!==r.rank)throw new Error(`Input shape should be Tensor1D but received shape ${r.shape}`);if(1!==s.rank)throw new Error(`New shape should be Tensor1D but received shape ${s.shape}`);let i={inputIndices:a,inputShape:r,newShape:s},o=Ci.runKernel(Mr,i);return{outputIndices:o[0],outputShape:o[1]}}}),lm=Bi({sparseSegmentMean_:function(e,t,n){let a=Li(e,"data","sparseSegmentMean"),r=Li(t,"indices","sparseSegmentMean","int32"),s=Li(n,"segmentIds","sparseSegmentMean","int32");if(a.rank<1)throw new Error("Data should be at least 1 dimensional but received scalar");if(1!==r.rank)throw new Error(`Indices should be Tensor1D but received shape\n          ${r.shape}`);if(1!==s.rank)throw new Error(`Segment ids should be Tensor1D but received shape\n          ${s.shape}`);let i={data:a,indices:r,segmentIds:s};return Ci.runKernel(Or,i)}}),um=Bi({sparseSegmentSum_:function(e,t,n){let a=Li(e,"data","sparseSegmentSum"),r=Li(t,"indices","sparseSegmentSum","int32"),s=Li(n,"segmentIds","sparseSegmentSum","int32");if(a.rank<1)throw new Error("Data should be at least 1 dimensional but received scalar");if(1!==r.rank)throw new Error(`Indices should be Tensor1D but received shape\n         ${r.shape}`);if(1!==s.rank)throw new Error(`Segment ids should be Tensor1D but received shape\n         ${s.shape}`);let i={data:a,indices:r,segmentIds:s};return Ci.runKernel(jr,i)}}),dm=Bi({stringNGrams_:function(e,t,n,a,r,s,i,o){let l=Li(e,"data","stringNGrams","string");if("string"!==l.dtype)throw new Error("Data must be of datatype string");if(1!==l.shape.length)throw new Error(`Data must be a vector, saw: ${l.shape}`);let u=Li(t,"dataSplits","stringNGrams");if("int32"!==u.dtype)throw new Error("Data splits must be of datatype int32");let d={separator:n,nGramWidths:a,leftPad:r,rightPad:s,padWidth:i,preserveShortSequences:o},c={data:l,dataSplits:u},p=Ci.runKernel(Vr,c,d);return{nGrams:p[0],nGramsSplits:p[1]}}}),cm=Bi({stringSplit_:function(e,t,n=!0){let a=Li(e,"input","stringSplit","string"),r=Li(t,"delimiter","stringSplit","string");if(1!==a.rank)throw new Error(`Input should be Tensor1D but received shape ${a.shape}`);if(0!==r.rank)throw new Error(`Delimiter should be a scalar but received shape ${r.shape}`);let s={skipEmpty:n},i={input:a,delimiter:r},o=Ci.runKernel(Ur,i,s);return{indices:o[0],values:o[1],shape:o[2]}}}),pm=Bi({stringToHashBucketFast_:function(e,t){let n=Li(e,"input","stringToHashBucketFast","string"),a={numBuckets:t};if(t<=0)throw new Error("Number of buckets must be at least 1");let r={input:n};return Ci.runKernel(Gr,r,a)}}),hm=Bi({staticRegexReplace_:function(e,t,n,a=!0){let r=Li(e,"input","staticRegexReplace","string"),s={pattern:t,rewrite:n,replaceGlobal:a};return Ci.runKernel(Br,{x:r},s)}}),mm={fft:kp,ifft:Np,rfft:_p,irfft:Sp},fm={hammingWindow:wh,hannWindow:vh,frame:kh,stft:Nh},gm={flipLeftRight:Ih,grayscaleToRGB:_h,resizeNearestNeighbor:Vh,resizeBilinear:Wh,rgbToGrayscale:Ch,rotateWithOffset:Th,cropAndResize:Sh,nonMaxSuppression:Ah,nonMaxSuppressionAsync:async function(e,t,n,a=.5,r=Number.NEGATIVE_INFINITY){let s=Li(e,"boxes","nonMaxSuppressionAsync"),i=Li(t,"scores","nonMaxSuppressionAsync"),o=Eh(s,i,n,a,r);n=o.maxOutputSize,a=o.iouThreshold,r=o.scoreThreshold;let l=await Promise.all([s.data(),i.data()]),u=l[0],d=l[1],{selectedIndices:c}=Fh(u,d,n,a,r);return s!==e&&s.dispose(),i!==t&&i.dispose(),Fp(c,"int32")},nonMaxSuppressionWithScore:Ph,nonMaxSuppressionWithScoreAsync:async function(e,t,n,a=.5,r=Number.NEGATIVE_INFINITY,s=0){let i=Li(e,"boxes","nonMaxSuppressionAsync"),o=Li(t,"scores","nonMaxSuppressionAsync"),l=Eh(i,o,n,a,r,s);n=l.maxOutputSize,a=l.iouThreshold,r=l.scoreThreshold,s=l.softNmsSigma;let u=await Promise.all([i.data(),o.data()]),d=u[0],c=u[1],{selectedIndices:p,selectedScores:h}=Mh(d,c,n,a,r,s);return i!==e&&i.dispose(),o!==t&&o.dispose(),{selectedIndices:Fp(p,"int32"),selectedScores:Fp(h)}},nonMaxSuppressionPadded:Bh,nonMaxSuppressionPaddedAsync:async function(e,t,n,a=.5,r=Number.NEGATIVE_INFINITY,s=!1){let i=Li(e,"boxes","nonMaxSuppressionAsync"),o=Li(t,"scores","nonMaxSuppressionAsync"),l=Eh(i,o,n,a,r,null),u=l.maxOutputSize,d=l.iouThreshold,c=l.scoreThreshold,[p,h]=await Promise.all([i.data(),o.data()]),{selectedIndices:m,validOutputs:f}=Dh(p,h,u,d,c,s);return i!==e&&i.dispose(),o!==t&&o.dispose(),{selectedIndices:Fp(m,"int32"),validOutputs:sd(f,"int32")}},threshold:Uh,transform:Gh},xm={bandPart:Hh,gramSchmidt:qh,qr:Yh},bm={absoluteDifference:Jh,computeWeightedLoss:Zh,cosineDistance:Qh,hingeLoss:em,huberLoss:tm,logLoss:nm,meanSquaredError:am,sigmoidCrossEntropy:rm,softmaxCrossEntropy:sm},ym={sparseFillEmptyRows:im,sparseReshape:om,sparseSegmentMean:lm,sparseSegmentSum:um},wm={stringNGrams:dm,stringSplit:cm,stringToHashBucketFast:pm,staticRegexReplace:hm},vm={};xe(vm,{Serializable:()=>Sm,SerializationMap:()=>Im,getRegisteredName:()=>Cm,registerClass:()=>_m});var km=new Map,Nm=new Map,Sm=class{getClassName(){return this.constructor.className}static fromConfig(e,t){return new e(t)}},Im=class e{constructor(){this.classNameMap={}}static getMap(){return null==e.instance&&(e.instance=new e),e.instance}static register(t){e.getMap().classNameMap[t.className]=[t,t.fromConfig]}};function _m(e,t,n){Ze(null!=e.className,()=>"Class being registered does not have the static className property defined."),Ze("string"==typeof e.className,()=>"className is required to be a string, but got type "+typeof e.className),Ze(e.className.length>0,()=>"Class being registered has an empty-string as its className, which is disallowed."),void 0===t&&(t="Custom"),void 0===n&&(n=e.className);let a=t+">"+n;return Im.register(e),km.set(a,e),Nm.set(e,a),e}function Cm(e){return Nm.has(e)?Nm.get(e):e.className}var Tm=class extends Sm{minimize(e,t=!1,n){let{value:a,grads:r}=this.computeGradients(e,n);if(null!=n){let e=n.map(e=>({name:e.name,tensor:r[e.name]}));this.applyGradients(e)}else this.applyGradients(r);return no(r),t?a:(a.dispose(),null)}get iterations(){return null==this.iterations_&&(this.iterations_=0),this.iterations_}incrementIterations(){this.iterations_=this.iterations+1}computeGradients(e,t){return Od(e,t)}dispose(){null!=this.iterations_&&no(this.iterations_)}async saveIterations(){return null==this.iterations_&&(this.iterations_=0),{name:"iter",tensor:sd(this.iterations_,"int32")}}async getWeights(){throw new Error("getWeights() is not implemented for this optimizer yet.")}async setWeights(e){throw new Error(`setWeights() is not implemented for this optimizer class ${this.getClassName()}`)}async extractIterations(e){return this.iterations_=(await e[0].tensor.data())[0],e.slice(1)}};Object.defineProperty(Tm,Symbol.hasInstance,{value:e=>null!=e.minimize&&null!=e.computeGradients&&null!=e.applyGradients});var Em=class extends Tm{static get className(){return"Adadelta"}constructor(e,t,n=null){super(),this.learningRate=e,this.rho=t,this.epsilon=n,this.accumulatedGrads=[],this.accumulatedUpdates=[],null==n&&(this.epsilon=Ci.backend.epsilon())}applyGradients(e){(Array.isArray(e)?e.map(e=>e.name):Object.keys(e)).forEach((t,n)=>{let a=Ci.registeredVariables[t],r=!1;null==this.accumulatedGrads[n]&&(this.accumulatedGrads[n]={originalName:`${t}/accum_grad`,variable:to(()=>Bu(a).variable(r))}),null==this.accumulatedUpdates[n]&&(this.accumulatedUpdates[n]={originalName:`${t}/accum_var`,variable:to(()=>Bu(a).variable(r))});let s=Array.isArray(e)?e[n].tensor:e[t];if(null==s)return;let i=this.accumulatedGrads[n].variable,o=this.accumulatedUpdates[n].variable;to(()=>{let e=fl(bl(i,this.rho),bl(od(s),1-this.rho)),t=bl(xl(id(fl(o,this.epsilon)),id(fl(i,this.epsilon))),s),n=fl(bl(o,this.rho),bl(od(t),1-this.rho));i.assign(e),o.assign(n);let r=fl(bl(t,-this.learningRate),a);a.assign(r)})}),this.incrementIterations()}dispose(){null!=this.accumulatedUpdates&&(no(this.accumulatedGrads.map(e=>e.variable)),no(this.accumulatedUpdates.map(e=>e.variable)))}async getWeights(){let e=[...this.accumulatedGrads,...this.accumulatedUpdates];return[await this.saveIterations()].concat(e.map(e=>({name:e.originalName,tensor:e.variable})))}async setWeights(e){let t=(e=await this.extractIterations(e)).length/2,n=!1;this.accumulatedGrads=e.slice(0,t).map(e=>({originalName:e.name,variable:e.tensor.variable(n)})),this.accumulatedUpdates=e.slice(t,2*t).map(e=>({originalName:e.name,variable:e.tensor.variable(n)}))}getConfig(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}}static fromConfig(e,t){return new e(t.learningRate,t.rho,t.epsilon)}},Am=class extends Tm{static get className(){return"Adagrad"}constructor(e,t=.1){super(),this.learningRate=e,this.initialAccumulatorValue=t,this.accumulatedGrads=[]}applyGradients(e){(Array.isArray(e)?e.map(e=>e.name):Object.keys(e)).forEach((t,n)=>{let a=Ci.registeredVariables[t];null==this.accumulatedGrads[n]&&(this.accumulatedGrads[n]={originalName:`${t}/accumulator`,variable:to(()=>hu(a.shape,this.initialAccumulatorValue).variable(!1))});let r=Array.isArray(e)?e[n].tensor:e[t];if(null==r)return;let s=this.accumulatedGrads[n].variable;to(()=>{let e=fl(s,od(r));s.assign(e);let t=fl(bl(xl(r,id(fl(e,Ci.backend.epsilon()))),-this.learningRate),a);a.assign(t)})}),this.incrementIterations()}dispose(){null!=this.accumulatedGrads&&no(this.accumulatedGrads.map(e=>e.variable))}async getWeights(){return[await this.saveIterations()].concat(this.accumulatedGrads.map(e=>({name:e.originalName,tensor:e.variable})))}async setWeights(e){e=await this.extractIterations(e),this.accumulatedGrads=e.map(e=>({originalName:e.name,variable:e.tensor.variable(!1)}))}getConfig(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}}static fromConfig(e,t){return new e(t.learningRate,t.initialAccumulatorValue)}},$m=class extends Tm{static get className(){return"Adam"}constructor(e,t,n,a=null){super(),this.learningRate=e,this.beta1=t,this.beta2=n,this.epsilon=a,this.accumulatedFirstMoment=[],this.accumulatedSecondMoment=[],to(()=>{this.accBeta1=sd(t).variable(),this.accBeta2=sd(n).variable()}),null==a&&(this.epsilon=Ci.backend.epsilon())}applyGradients(e){let t=Array.isArray(e)?e.map(e=>e.name):Object.keys(e);to(()=>{let n=Wd(1,this.accBeta1),a=Wd(1,this.accBeta2);t.forEach((t,r)=>{let s=Ci.registeredVariables[t],i=!1;null==this.accumulatedFirstMoment[r]&&(this.accumulatedFirstMoment[r]={originalName:`${t}/m`,variable:to(()=>Bu(s).variable(i))}),null==this.accumulatedSecondMoment[r]&&(this.accumulatedSecondMoment[r]={originalName:`${t}/v`,variable:to(()=>Bu(s).variable(i))});let o=Array.isArray(e)?e[r].tensor:e[t];if(null==o)return;let l=this.accumulatedFirstMoment[r].variable,u=this.accumulatedSecondMoment[r].variable,d=fl(bl(l,this.beta1),bl(o,1-this.beta1)),c=fl(bl(u,this.beta2),bl(od(o),1-this.beta2)),p=xl(d,n),h=xl(c,a);l.assign(d),u.assign(c);let m=fl(bl(xl(p,fl(id(h),this.epsilon)),-this.learningRate),s);s.assign(m)}),this.accBeta1.assign(bl(this.accBeta1,this.beta1)),this.accBeta2.assign(bl(this.accBeta2,this.beta2))}),this.incrementIterations()}dispose(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&no(this.accumulatedFirstMoment.map(e=>e.variable)),null!=this.accumulatedSecondMoment&&no(this.accumulatedSecondMoment.map(e=>e.variable))}async getWeights(){let e=[...this.accumulatedFirstMoment,...this.accumulatedSecondMoment];return[await this.saveIterations()].concat(e.map(e=>({name:e.originalName,tensor:e.variable})))}async setWeights(e){e=await this.extractIterations(e),to(()=>{this.accBeta1.assign(rd(this.beta1,this.iterations_+1)),this.accBeta2.assign(rd(this.beta2,this.iterations_+1))});let t=e.length/2,n=!1;this.accumulatedFirstMoment=e.slice(0,t).map(e=>({originalName:e.name,variable:e.tensor.variable(n)})),this.accumulatedSecondMoment=e.slice(t,2*t).map(e=>({originalName:e.name,variable:e.tensor.variable(n)}))}getConfig(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}}static fromConfig(e,t){return new e(t.learningRate,t.beta1,t.beta2,t.epsilon)}},Rm=class extends Tm{static get className(){return"Adamax"}constructor(e,t,n,a=null,r=0){super(),this.learningRate=e,this.beta1=t,this.beta2=n,this.epsilon=a,this.decay=r,this.accumulatedFirstMoment=[],this.accumulatedWeightedInfNorm=[],to(()=>{this.iteration=sd(0).variable(),this.accBeta1=sd(t).variable()}),null==a&&(this.epsilon=Ci.backend.epsilon())}applyGradients(e){let t=Array.isArray(e)?e.map(e=>e.name):Object.keys(e);to(()=>{let n=Wd(1,this.accBeta1),a=xl(-this.learningRate,fl(bl(this.iteration,this.decay),1));t.forEach((t,r)=>{let s=Ci.registeredVariables[t],i=!1;null==this.accumulatedFirstMoment[r]&&(this.accumulatedFirstMoment[r]={originalName:`${t}/m`,variable:Bu(s).variable(i)}),null==this.accumulatedWeightedInfNorm[r]&&(this.accumulatedWeightedInfNorm[r]={originalName:`${t}/v`,variable:Bu(s).variable(i)});let o=Array.isArray(e)?e[r].tensor:e[t];if(null==o)return;let l=this.accumulatedFirstMoment[r].variable,u=this.accumulatedWeightedInfNorm[r].variable,d=fl(bl(l,this.beta1),bl(o,1-this.beta1)),c=bl(u,this.beta2),p=yl(o),h=tc(c,p);l.assign(d),u.assign(h);let m=fl(bl(xl(a,n),xl(d,fl(h,this.epsilon))),s);s.assign(m)}),this.iteration.assign(fl(this.iteration,1)),this.accBeta1.assign(bl(this.accBeta1,this.beta1))}),this.incrementIterations()}dispose(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&no(this.accumulatedFirstMoment.map(e=>e.variable)),null!=this.accumulatedWeightedInfNorm&&no(this.accumulatedWeightedInfNorm.map(e=>e.variable))}async getWeights(){throw new Error("getWeights() is not implemented for Adamax yet.")}async setWeights(e){throw new Error("setWeights() is not implemented for Adamax yet.")}getConfig(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}}static fromConfig(e,t){return new e(t.learningRate,t.beta1,t.beta2,t.epsilon,t.decay)}},Fm=class extends Tm{static get className(){return"SGD"}constructor(e){super(),this.learningRate=e,this.setLearningRate(e)}applyGradients(e){(Array.isArray(e)?e.map(e=>e.name):Object.keys(e)).forEach((t,n)=>{let a=Array.isArray(e)?e[n].tensor:e[t];if(null==a)return;let r=Ci.registeredVariables[t];to(()=>{let e=fl(bl(this.c,a),r);r.assign(e)})}),this.incrementIterations()}setLearningRate(e){this.learningRate=e,null!=this.c&&this.c.dispose(),this.c=ao(sd(-e))}dispose(){this.c.dispose()}async getWeights(){return[await this.saveIterations()]}async setWeights(e){if(0!==(e=await this.extractIterations(e)).length)throw new Error("SGD optimizer does not have settable weights.")}getConfig(){return{learningRate:this.learningRate}}static fromConfig(e,t){return new e(t.learningRate)}},Dm=class extends Fm{static get className(){return"Momentum"}constructor(e,t,n=!1){super(e),this.learningRate=e,this.momentum=t,this.useNesterov=n,this.accumulations=[],this.m=sd(this.momentum)}applyGradients(e){(Array.isArray(e)?e.map(e=>e.name):Object.keys(e)).forEach((t,n)=>{let a=Ci.registeredVariables[t];null==this.accumulations[n]&&(this.accumulations[n]={originalName:`${t}/momentum`,variable:to(()=>Bu(a).variable(!1))});let r=this.accumulations[n].variable,s=Array.isArray(e)?e[n].tensor:e[t];null!=s&&to(()=>{let e,t=fl(bl(this.m,r),s);e=this.useNesterov?fl(bl(this.c,fl(s,bl(t,this.m))),a):fl(bl(this.c,t),a),r.assign(t),a.assign(e)})}),this.incrementIterations()}dispose(){this.m.dispose(),null!=this.accumulations&&no(this.accumulations.map(e=>e.variable))}setMomentum(e){this.momentum=e}async getWeights(){return[await this.saveIterations()].concat(this.accumulations.map(e=>({name:e.originalName,tensor:e.variable})))}async setWeights(e){e=await this.extractIterations(e),this.accumulations=e.map(e=>({originalName:e.name,variable:e.tensor.variable(!1)}))}getConfig(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}}static fromConfig(e,t){return new e(t.learningRate,t.momentum,t.useNesterov)}},Mm=class extends Tm{static get className(){return"RMSProp"}constructor(e,t=.9,n=0,a=null,r=!1){if(super(),this.learningRate=e,this.decay=t,this.momentum=n,this.epsilon=a,this.accumulatedMeanSquares=[],this.accumulatedMoments=[],this.accumulatedMeanGrads=[],this.centered=r,null==a&&(this.epsilon=Ci.backend.epsilon()),null==e)throw new Error("learningRate for RMSPropOptimizer must be defined.")}applyGradients(e){(Array.isArray(e)?e.map(e=>e.name):Object.keys(e)).forEach((t,n)=>{let a=Ci.registeredVariables[t],r=!1;null==this.accumulatedMeanSquares[n]&&(this.accumulatedMeanSquares[n]={originalName:`${t}/rms`,variable:to(()=>Bu(a).variable(r))}),null==this.accumulatedMoments[n]&&(this.accumulatedMoments[n]={originalName:`${t}/momentum`,variable:to(()=>Bu(a).variable(r))}),null==this.accumulatedMeanGrads[n]&&this.centered&&(this.accumulatedMeanGrads[n]={originalName:`${t}/mg`,variable:to(()=>Bu(a).variable(r))});let s=Array.isArray(e)?e[n].tensor:e[t];if(null==s)return;let i=this.accumulatedMeanSquares[n].variable,o=this.accumulatedMoments[n].variable;to(()=>{let e=fl(bl(i,this.decay),bl(od(s),1-this.decay));if(this.centered){let t=this.accumulatedMeanGrads[n].variable,r=fl(bl(t,this.decay),bl(s,1-this.decay)),l=xl(bl(s,this.learningRate),id(Wd(e,fl(od(r),this.epsilon)))),u=fl(bl(o,this.momentum),l);i.assign(e),t.assign(r),o.assign(u);let d=Wd(a,u);a.assign(d)}else{let e=fl(bl(i,this.decay),bl(od(s),1-this.decay)),t=fl(bl(o,this.momentum),xl(bl(s,this.learningRate),id(fl(e,this.epsilon))));i.assign(e),o.assign(t);let n=Wd(a,t);a.assign(n)}})}),this.incrementIterations()}dispose(){null!=this.accumulatedMeanSquares&&no(this.accumulatedMeanSquares.map(e=>e.variable)),null!=this.accumulatedMeanGrads&&this.centered&&no(this.accumulatedMeanGrads.map(e=>e.variable)),null!=this.accumulatedMoments&&no(this.accumulatedMoments.map(e=>e.variable))}async getWeights(){let e=[...this.accumulatedMeanSquares,...this.accumulatedMoments];return this.centered&&e.push(...this.accumulatedMeanGrads),[await this.saveIterations()].concat(e.map(e=>({name:e.originalName,tensor:e.variable})))}async setWeights(e){e=await this.extractIterations(e);let t=this.centered?e.length/3:e.length/2,n=!1;this.accumulatedMeanSquares=e.slice(0,t).map(e=>({originalName:e.name,variable:e.tensor.variable(n)})),this.accumulatedMoments=e.slice(t,2*t).map(e=>({originalName:e.name,variable:e.tensor.variable(n)})),this.centered&&(this.accumulatedMeanGrads=e.slice(2*t,3*t).map(e=>({originalName:e.name,variable:e.tensor.variable(n)})))}getConfig(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}}static fromConfig(e,t){return new e(t.learningRate,t.decay,t.momentum,t.epsilon,t.centered)}},Om=[Em,Am,$m,Rm,Dm,Mm,Fm],jm={};function Lm(e){return new Promise(e=>setTimeout(e)).then(e)}xe(jm,{CompositeArrayBuffer:()=>Hi,browserFiles:()=>Bm,browserHTTPRequest:()=>Ym,concatenateArrayBuffers:()=>Io,copyModel:()=>ll,decodeWeights:()=>go,decodeWeightsStream:()=>vo,encodeWeights:()=>fo,fromMemory:()=>ef,fromMemorySync:()=>tf,getLoadHandlers:()=>Oo,getModelArtifactsForJSON:()=>Eo,getModelArtifactsForJSONSync:()=>To,getModelArtifactsInfoForJSON:()=>Ao,getSaveHandlers:()=>Mo,getWeightSpecs:()=>$o,http:()=>Xm,isHTTPScheme:()=>qm,listModels:()=>il,loadWeights:()=>Um,moveModel:()=>ul,registerLoadRouter:()=>Do,registerSaveRouter:()=>Fo,removeModel:()=>ol,weightsLoaderFactory:()=>Gm,withSaveHandler:()=>nf,withSaveHandlerSync:()=>af});var zm=class e{constructor(t){if(!Pt().getBool("IS_BROWSER"))throw new Error("browserDownloads() cannot proceed because the current environment is not a browser.");t.startsWith(e.URL_SCHEME)&&(t=t.slice(e.URL_SCHEME.length)),(null==t||0===t.length)&&(t="model"),this.modelJsonFileName=t+".json",this.weightDataFileName=t+".weights.bin"}async save(e){if("undefined"==typeof document)throw new Error("Browser downloads are not supported in this environment since `document` is not present");let t=Hi.join(e.weightData),n=window.URL.createObjectURL(new Blob([t],{type:"application/octet-stream"}));if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");{let t=Co(e,[{paths:["./"+this.weightDataFileName],weights:e.weightSpecs}]),a=window.URL.createObjectURL(new Blob([JSON.stringify(t)],{type:"application/json"})),r=null==this.modelJsonAnchor?document.createElement("a"):this.modelJsonAnchor;if(r.download=this.modelJsonFileName,r.href=a,await Lm(()=>r.dispatchEvent(new MouseEvent("click"))),null!=e.weightData){let e=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor;e.download=this.weightDataFileName,e.href=n,await Lm(()=>e.dispatchEvent(new MouseEvent("click")))}return{modelArtifactsInfo:Ao(e)}}}};zm.URL_SCHEME="downloads://";var Pm=class{constructor(e){if(null==e||e.length<1)throw new Error(`When calling browserFiles, at least 1 file is required, but received ${e}`);this.jsonFile=e[0],this.weightsFiles=e.slice(1)}async load(){return new Promise((e,t)=>{let n=new FileReader;n.onload=n=>{let a=JSON.parse(n.target.result),r=a.modelTopology;if(null==r)return void t(new Error(`modelTopology field is missing from file ${this.jsonFile.name}`));if(null==a.weightsManifest)return void t(new Error(`weightManifest field is missing from file ${this.jsonFile.name}`));if(0===this.weightsFiles.length)return void e({modelTopology:r});let s=Eo(a,e=>this.loadWeights(e));e(s)},n.onerror=e=>t(`Failed to read model topology and weights manifest JSON from file '${this.jsonFile.name}'. BrowserFiles supports loading Keras-style tf.Model artifacts only.`),n.readAsText(this.jsonFile)})}loadWeights(e){let t=[],n=[];for(let s of e)t.push(...s.weights),n.push(...s.paths);let a=this.checkManifestAndWeightFiles(e),r=n.map(e=>this.loadWeightsFile(e,a[e]));return Promise.all(r).then(e=>[t,e])}loadWeightsFile(e,t){return new Promise((n,a)=>{let r=new FileReader;r.onload=e=>{let t=e.target.result;n(t)},r.onerror=t=>a(`Failed to weights data from file of path '${e}'.`),r.readAsArrayBuffer(t)})}checkManifestAndWeightFiles(e){let t=[],n=this.weightsFiles.map(e=>_o(e.name)),a={};for(let r of e)r.paths.forEach(e=>{let r=_o(e);if(-1!==t.indexOf(r))throw new Error(`Duplicate file basename found in weights manifest: '${r}'`);if(t.push(r),-1===n.indexOf(r))throw new Error(`Weight file with basename '${r}' is not provided.`);a[e]=this.weightsFiles[n.indexOf(r)]});if(t.length!==this.weightsFiles.length)throw new Error(`Mismatch in the number of files in weights manifest (${t.length}) and the number of weight files provided (${this.weightsFiles.length}).`);return a}};function Bm(e){return new Pm(e)}function Wm(e,t,n,a){var r;Ze(null!=(r=e)&&Array.isArray(r)&&r.length>0,()=>"promises must be a none empty array"),function(e,t){Ze(e>=0&&e<=1,()=>`Progress fraction must be in range [0, 1], but got startFraction ${e}`),Ze(t>=0&&t<=1,()=>`Progress fraction must be in range [0, 1], but got endFraction ${t}`),Ze(t>=e,()=>`startFraction must be no more than endFraction, but got startFraction ${e} and endFraction ${t}`)}(n=null==n?0:n,a=null==a?1:a);let s=0;return Promise.all(e.map(r=>(r.then(r=>{let i=n+ ++s/e.length*(a-n);return t(i),r}),r)))}async function Vm(e,t){null==t&&(t={});let n=null==t.fetchFunc?Pt().platform.fetch:t.fetchFunc,a=e.map(e=>n(e,t.requestInit,{isBinary:!0})),r=(null==t.onProgress?await Promise.all(a):await Wm(a,t.onProgress,0,.5)).map(e=>e.arrayBuffer());return null==t.onProgress?await Promise.all(r):await Wm(r,t.onProgress,.5,1)}async function Um(e,t="",n,a){return Gm(e=>Vm(e,{requestInit:a}))(e,t,n)}function Gm(e){return async(t,n="",a)=>{let r=t.map(()=>!1),s={},i=null!=a?a.map(()=>!1):[],o=[];if(t.forEach((e,t)=>{let n=0;e.weights.forEach(e=>{let l="quantization"in e?e.quantization.dtype:e.dtype,u=Gi[l]*et(e.shape),d=()=>{r[t]=!0,null==s[t]&&(s[t]=[]),s[t].push({manifestEntry:e,groupOffset:n,sizeBytes:u})};null!=a?a.forEach((t,n)=>{t===e.name&&(d(),i[n]=!0)}):d(),o.push(e.name),n+=u})}),!i.every(e=>e)){let e=a.filter((e,t)=>!i[t]);throw new Error(`Could not find weights in manifest with names: ${e.join(", ")}. \nManifest JSON has weights with names: ${o.join(", ")}.`)}let l=r.reduce((e,t,n)=>(t&&e.push(n),e),[]),u=[];l.forEach(e=>{t[e].paths.forEach(e=>{let t=n+(n.endsWith("/")?"":"/")+e;u.push(t)})});let d=await e(u),c={},p=0;return l.forEach(e=>{let n=t[e].paths.length,a=new Hi(d.slice(p,p+n));s[e].forEach(e=>{let t=go(a.slice(e.groupOffset,e.groupOffset+e.sizeBytes),[e.manifestEntry]);for(let n in t)c[n]=t[n]}),p+=n}),c}}Ro.registerSaveRouter(e=>Pt().getBool("IS_BROWSER")&&!Array.isArray(e)&&e.startsWith(zm.URL_SCHEME)?function(e="model"){return new zm(e)}(e.slice(zm.URL_SCHEME.length)):null);var Hm=class{constructor(e,t){if(this.DEFAULT_METHOD="POST",null==t&&(t={}),this.weightPathPrefix=t.weightPathPrefix,this.weightUrlConverter=t.weightUrlConverter,null!=t.fetchFunc?(Ze("function"==typeof t.fetchFunc,()=>"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"),this.fetch=t.fetchFunc):this.fetch=Pt().platform.fetch,Ze(null!=e&&e.length>0,()=>"URL path for http must not be null, undefined or empty."),Array.isArray(e)&&Ze(2===e.length,()=>`URL paths for http must have a length of 2, (actual length is ${e.length}).`),this.path=e,null!=t.requestInit&&null!=t.requestInit.body)throw new Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=t.requestInit||{},this.loadOptions=t}async save(e){if(e.modelTopology instanceof ArrayBuffer)throw new Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");let t=Object.assign({method:this.DEFAULT_METHOD},this.requestInit);t.body=new FormData;let n=Co(e,[{paths:["./model.weights.bin"],weights:e.weightSpecs}]);if(t.body.append("model.json",new Blob([JSON.stringify(n)],{type:"application/json"}),"model.json"),null!=e.weightData){let n=Hi.join(e.weightData);t.body.append("model.weights.bin",new Blob([n],{type:"application/octet-stream"}),"model.weights.bin")}let a=await this.fetch(this.path,t);if(a.ok)return{modelArtifactsInfo:Ao(e),responses:[a]};throw new Error(`BrowserHTTPRequest.save() failed due to HTTP response status ${a.status}.`)}async loadModelJSON(){let e,t=await this.fetch(this.path,this.requestInit);if(!t.ok)throw new Error(`Request to ${this.path} failed with status code ${t.status}. Please verify this URL points to the model JSON of the model to load.`);try{e=await t.json()}catch(tQ){let t=`Failed to parse model JSON of response from ${this.path}.`;throw this.path.endsWith(".pb")?t+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":t+=" Please make sure the server is serving valid JSON for this request.",new Error(t)}let n=e.modelTopology,a=e.weightsManifest;if(null==n&&null==a)throw new Error(`The JSON from HTTP path ${this.path} contains neither model topology or manifest for weights.`);return e}async load(){return this.loadOptions.streamWeights?this.loadStream():Eo(await this.loadModelJSON(),e=>this.loadWeights(e))}async loadStream(){let e=await this.loadModelJSON(),t=await this.getWeightUrls(e.weightsManifest),n=$o(e.weightsManifest);return Object.assign(Object.assign({},e),{weightSpecs:n,getWeightStream:()=>function(e,t){var n;let a,r=null==t.fetchFunc?Pt().platform.fetch:t.fetchFunc,s=0;return null===(n=t.onProgress)||void 0===n||n.call(t,0),new ReadableStream({pull:async n=>{for(var i;s<e.length;){a||(a=(await r(e[s],t.requestInit,{isBinary:!0})).body.getReader());let{done:o,value:l}=await a.read();if(!o)return void n.enqueue(l);s++,a=void 0,null===(i=t.onProgress)||void 0===i||i.call(t,s/e.length)}n.close()}})}(t,this.loadOptions)})}async getWeightUrls(e){let t=Array.isArray(this.path)?this.path[1]:this.path,[n,a]=function(e){let t=e.lastIndexOf("/"),n=e.lastIndexOf("?");return[e.substring(0,t)+"/",n>t?e.substring(n):""]}(t),r=this.weightPathPrefix||n,s=[],i=[];for(let o of e)for(let e of o.paths)null!=this.weightUrlConverter?i.push(this.weightUrlConverter(e)):s.push(r+e+a);return this.weightUrlConverter&&s.push(...await Promise.all(i)),s}async loadWeights(e){let t=await this.getWeightUrls(e);return[$o(e),await Vm(t,this.loadOptions)]}};function qm(e){return null!=e.match(Hm.URL_SCHEME_REGEX)}Hm.URL_SCHEME_REGEX=/^https?:\/\//;var Km=(e,t)=>{if("undefined"==typeof fetch&&(null==t||null==t.fetchFunc))return null;{let n=!0;if(n=Array.isArray(e)?e.every(e=>qm(e)):qm(e),n)return Xm(e,t)}return null};function Xm(e,t){return new Hm(e,t)}function Ym(e,t){return Xm(e,t)}Ro.registerSaveRouter(Km),Ro.registerLoadRouter(Km);var Zm=class{constructor(e){this.modelArtifacts=e}load(){return this.modelArtifacts}},Jm=class{constructor(e){this.saveHandler=e}save(e){return this.saveHandler(e)}},Qm=class{constructor(e){e.load&&(this.load=()=>Promise.resolve(e.load())),e.save&&(this.save=t=>Promise.resolve(e.save(t)))}};function ef(e,t,n,a){return new Qm(tf(...arguments))}function tf(e,t,n,a){return 1===arguments.length?null!=e.modelTopology||null!=e.weightSpecs?new Zm(e):new Zm({modelTopology:e}):new Zm({modelTopology:e,weightSpecs:t,weightData:n,trainingConfig:a})}function nf(e){return new Jm(e)}function af(e){return new Jm(e)}var rf={};xe(rf,{confusionMatrix:()=>sf});var sf=Bi({confusionMatrix_:function(e,t,n){let a=Li(e,"labels","confusionMatrix"),r=Li(t,"predictions","confusionMatrix");Ze(null==n||n>0&&Number.isInteger(n),()=>`If provided, numClasses must be a positive integer, but got ${n}`),Ze(1===a.rank,()=>`Expected the rank of labels to be 1, but got ${a.rank}`),Ze(1===r.rank,()=>`Expected the rank of predictions to be 1, but got ${r.rank}`),Ze(a.shape[0]===r.shape[0],()=>`Mismatch in the number of examples: ${a.shape[0]} vs. ${r.shape[0]}. Labels and predictions should have the same number of elements.`),Ze(n>0&&Number.isInteger(n),()=>`numClasses is required to be a positive integer, but got ${n}`);let s=hc(pl(a,"int32"),n),i=hc(pl(r,"int32"),n),o=eh(s),l=Zl(o,i);return pl(l,"int32")}}),of={};xe(of,{draw:()=>mf,fromPixels:()=>ff,fromPixelsAsync:()=>cf,toPixels:()=>hf});var lf,uf=!1;function df(e,t=3){if(t>4)throw new Error("Cannot construct Tensor with more than 4 channels from pixels.");if(null==e)throw new Error("pixels passed to tf.browser.fromPixels() can not be null");let n=!1,a=!1,r=!1,s=!1,i=!1,o=!1;if(e.data instanceof Uint8Array)n=!0;else if("undefined"!=typeof ImageData&&e instanceof ImageData)a=!0;else if("undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement)r=!0;else if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement)s=!0;else if(null!=e.getContext)i=!0;else{if(!("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap))throw new Error(`pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was ${e.constructor.name}`);o=!0}if(null!=ms(ss,Ci.backendName)){let n={pixels:e},a={numChannels:t};return Ci.runKernel(ss,n,a)}let l,u,[d,c]=r?[e.videoWidth,e.videoHeight]:[e.width,e.height];if(i)l=e.getContext("2d").getImageData(0,0,d,c).data;else if(a||n)l=e.data;else if(s||r||o){if(null==lf)if("undefined"==typeof document){if("undefined"==typeof OffscreenCanvas||"undefined"==typeof OffscreenCanvasRenderingContext2D)throw new Error("Cannot parse input in current context. Reason: OffscreenCanvas Context2D rendering is not supported.");lf=new OffscreenCanvas(1,1).getContext("2d")}else lf=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});lf.canvas.width=d,lf.canvas.height=c,lf.drawImage(e,0,0,d,c),l=lf.getImageData(0,0,d,c).data}if(4===t)u=new Int32Array(l);else{let e=d*c;u=new Int32Array(e*t);for(let n=0;n<e;n++)for(let e=0;e<t;++e)u[n*t+e]=l[4*n+e]}return Mp(u,[c,d,t],"int32")}async function cf(e,t=3){let n=null;if(Pt().getBool("WRAP_TO_IMAGEBITMAP")&&function(e){return"undefined"!=typeof window&&"undefined"!=typeof ImageBitmap&&window.hasOwnProperty("createImageBitmap")&&!(e instanceof ImageBitmap)&&function(e){return null!=e&&0!==e.width&&0!==e.height}(e)&&!function(e){return null!=e&&e.data instanceof Uint8Array}(e)}(e)){let t;try{t=await createImageBitmap(e,{premultiplyAlpha:"none"})}catch(tQ){t=null}n=null!=t&&t.width===e.width&&t.height===e.height?t:e}else n=e;return df(n,t)}function pf(e){if(2!==e.rank&&3!==e.rank)throw new Error(`toPixels only supports rank 2 or 3 tensors, got rank ${e.rank}.`);let t=2===e.rank?1:e.shape[2];if(t>4||2===t)throw new Error(`toPixels only supports depth of size 1, 3 or 4 but got ${t}`);if("float32"!==e.dtype&&"int32"!==e.dtype)throw new Error(`Unsupported type for toPixels: ${e.dtype}. Please use float32 or int32 tensors.`)}async function hf(e,t){let n=Li(e,"img","toPixels");if(!(e instanceof ri)){let e=n;n=pl(e,"int32"),e.dispose()}pf(n);let[a,r]=n.shape.slice(0,2),s=2===n.rank?1:n.shape[2],i=await n.data(),o="float32"===n.dtype?255:1,l=new Uint8ClampedArray(r*a*4);for(let u=0;u<a*r;++u){let e=[0,0,0,255];for(let a=0;a<s;a++){let t=i[u*s+a];if("float32"===n.dtype){if(t<0||t>1)throw new Error(`Tensor values for a float32 Tensor must be in the range [0 - 1] but encountered ${t}.`)}else if("int32"===n.dtype&&(t<0||t>255))throw new Error(`Tensor values for a int32 Tensor must be in the range [0 - 255] but encountered ${t}.`);1===s?(e[0]=t*o,e[1]=t*o,e[2]=t*o):e[a]=t*o}let t=4*u;l[t+0]=Math.round(e[0]),l[t+1]=Math.round(e[1]),l[t+2]=Math.round(e[2]),l[t+3]=Math.round(e[3])}if(null!=t){uf||null!=ms(Wn,Ci.backendName)&&(uf=!0),t.width=r,t.height=a;let e=t.getContext("2d"),n=new ImageData(l,r,a);e.putImageData(n,0,0)}return n!==e&&n.dispose(),l}function mf(e,t,n){let a=Li(e,"img","draw");if(!(e instanceof ri)){let e=a;a=pl(e,"int32"),e.dispose()}pf(a),function(e){let t=(null==e?void 0:e.alpha)||1;if(t>1||t<0)throw new Error(`Alpha value ${t} is suppoed to be in range [0 - 1].`)}(null==n?void 0:n.imageOptions);let r={image:a},s={canvas:t,options:n};Ci.runKernel(Wn,r,s)}var ff=Bi({fromPixels_:df}),gf={};function xf(e,t){let n=e.shape.length,a=t.shape.length;if(n<1)throw new Error(`tf.gatherND() expects the input to be rank 1 or higher, but the rank was ${n}.`);if(a<1)throw new Error(`tf.gatherND() expects the indices to be rank 1 or higher, but the rank was ${a}.`);if("int32"!==t.dtype)throw new Error(`tf.gatherND() expects the indices to be int32 type, but the dtype was ${t.dtype}.`);if(t.shape[a-1]>n)throw new Error(`index innermost dimension length must be <= tensor rank; saw: ${t.shape[a-1]} vs. ${n}`);if(0===et(e.shape))throw new Error(`Requested more than 0 entries, but input is empty. Input shape: ${e.shape}.`);let r=t.shape,s=r[r.length-1],i=1;for(let c=0;c<r.length-1;++c)i*=r[c];let o=e.shape,l=r.slice();l.pop();let u=1;for(let c=s;c<n;++c)u*=o[c],l.push(o[c]);let d=[..._t(e.shape).map(e=>e/u),1].slice(0,s);return[l,i,u,d]}xe(gf,{prepareAndValidate:()=>xf});var bf={};xe(bf,{assertParamsValid:()=>vf,computeFlatOffset:()=>Df,computeOutShape:()=>Nf,getNormalizedAxes:()=>Cf,isSliceContinous:()=>Ff,maskToAxes:()=>kf,parseSliceParams:()=>Mf,sliceInfo:()=>Of,startForAxis:()=>$f,startIndicesWithElidedDims:()=>Tf,stopForAxis:()=>Rf,stopIndicesWithElidedDims:()=>Ef,stridesForAxis:()=>Af,stridesWithElidedDims:()=>Sf});var yf=-2,wf=-1;function vf(e,t,n){let a=e.shape.length;Ze(a===t.length,()=>`Error in slice${a}D: Length of begin ${t} must match the rank of the array (${a}).`),Ze(a===n.length,()=>`Error in slice${a}D: Length of size ${n} must match the rank of the array (${a}).`);for(let r=0;r<a;++r)Ze(t[r]+n[r]<=e.shape[r],()=>`Error in slice${a}D: begin[${r}] + size[${r}] (${t[r]+n[r]}) would overflow input.shape[${r}] (${e.shape[r]})`)}function kf(e){let t=[],n=0;for(;e>0;)1&e&&t.push(n),e/=2,n++;return t}function Nf(e,t,n){let a=[];for(let r=0;r<e.length;r++)a[r]=Math.ceil((t[r]-e[r])/n[r]);return a}function Sf(e,t,n,a){let r=[...e];for(let s=r.length;s<a.length;s++)r.push(1);for(let s=0;s<n;s++)0===s?r[t]=1:(r.splice(t,0,1),r.pop());return r}function If(e,t,n){return n<=e?n:n-(t-1)}function _f(e,t){let n=[];for(let a=0;a<e;a++)n.push(t+a);return n}function Cf(e,t,n,a,r,s,i,o,l){let u=e.length,d=new Array(u),c=new Array(u),p=new Array(u);if(t.length&&n>0){let l=t[0],u=n+1;d=Tf(i,l,u,a,e),c=Ef(o,l,u,r,e),p=Sf(s,l,u,e)}else for(let h=0;h<u;h++)d[h]=$f(i,a,s,e,h,l),c[h]=Rf(o,r,s,e,h,l),p[h]=Af(s,h,l);return{begin:d,end:c,strides:p}}function Tf(e,t,n,a,r){let s=[...r],i=_f(n,t);for(let o=0;o<s.length;o++)if(i.indexOf(o)>-1)s[o]=0;else{let r=If(t,n,o),i=a[r];e&1<<r&&(i=0),s[o]=i}return s}function Ef(e,t,n,a,r){let s=[...r],i=_f(n,t);for(let o=0;o<s.length;o++)if(i.indexOf(o)>-1)s[o]=Number.MAX_SAFE_INTEGER;else{let r=If(t,n,o),i=a[r];e&1<<r&&(i=Number.MAX_SAFE_INTEGER),s[o]=i}for(let o=0;o<s.length;o++){let e=r[o];s[o]<0&&(s[o]+=e),s[o]=Ge(0,s[o],r[o])}return s}function Af(e,t,n){let a=e[t];return(n&1<<t||null==a)&&(a=1),a}function $f(e,t,n,a,r,s){let i=t[r],o=n[r]||1;(e&1<<r||s&1<<r||null==i)&&(i=o>0?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);let l=a[r];return i<0&&(i+=l),i=Ge(0,i,l-1),i}function Rf(e,t,n,a,r,s){let i=t[r],o=n[r]||1;(e&1<<r||s&1<<r||null==i)&&(i=o>0?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);let l=a[r];return i<0&&(i+=l),i=o>0?Ge(0,i,l):Ge(-1,i,l-1),i}function Ff(e,t,n){let a=n.length;for(let r=0;r<n.length;r++)if(n[r]>1){a=r;break}for(let r=a+1;r<n.length;r++)if(t[r]>0||n[r]!==e[r])return!1;return!0}function Df(e,t){let n=e.length>0?e[e.length-1]:1;for(let a=0;a<e.length-1;a++)n+=e[a]*t[a];return n}function Mf(e,t,n){let a,r,s=e.shape.length;return a="number"==typeof t?[t,...new Array(s-1).fill(0)]:t.length<s?t.concat(new Array(s-t.length).fill(0)):t.slice(),a.forEach(e=>{Ze(-1!==e,()=>"slice() does not support negative begin indexing.")}),r=null==n?new Array(s).fill(-1):"number"==typeof n?[n,...new Array(s-1).fill(-1)]:n.length<s?n.concat(new Array(s-n.length).fill(-1)):n,r=r.map((t,n)=>t>=0?t:(Ze(-1===t,()=>`Negative size values should be exactly -1 but got ${t} for the slice() size at index ${n}.`),e.shape[n]-a[n])),[a,r]}function Of(e,t,n,a,r,s,i,o,l){let u;if(null==a?(u=new Array(t.length),u.fill(1)):u=a,null!=i&&i&i-1)throw new Error("Multiple ellipses in slice is not allowed.");let d=!1,c={dims:u.length,numAddAxisAfterEllipsis:0,begin:t.slice(),end:n.slice(),strides:u.slice(),beginMask:r,endMask:s,ellipsisMask:i,newAxisMask:o,shrinkAxisMask:l};for(let b=0;b<c.dims;b++)d&&1<<b&o&&c.numAddAxisAfterEllipsis++,1<<b&i&&(d=!0);d||(c.ellipsisMask|=1<<c.dims,c.dims++);let p={dims:e.length,beginMask:0,endMask:0,beginValid:!1,endValid:!1};!function(e,t){t.beginMask=0,t.endMask=0,t.shrinkAxisMask=0;let n=0;t.beginValid=null!=e.begin,t.endValid=null!=e.end,t.begin=new Array(t.dims),t.end=new Array(t.dims),t.strides=new Array(t.dims),t.finalShapeGatherIndices=[],t.finalShapeGatherIndicesSparse=[],t.inputShapeGatherIndicesSparse=new Array(t.dims);for(let a=0;a<e.dims;a++)if(1<<a&e.ellipsisMask){let r=Math.min(t.dims-(e.dims-a)+1+e.numAddAxisAfterEllipsis,t.dims);for(;n<r;n++)t.begin[n]=0,t.end[n]=0,t.strides[n]=1,t.beginMask|=1<<n,t.endMask|=1<<n,t.finalShapeGatherIndices.push(n),t.finalShapeGatherIndicesSparse.push(-1),t.inputShapeGatherIndicesSparse[n]=a}else if(1<<a&e.newAxisMask)t.finalShapeGatherIndices.push(yf),t.finalShapeGatherIndicesSparse.push(-1);else{if(n===t.begin.length)throw Error(`Index out of range using input dim ${n}; input has only ${t.dims} dims, ${t.begin.length}.`);null!=e.begin&&(t.begin[n]=e.begin[a]),null!=e.end&&(t.end[n]=e.end[a]),t.strides[n]=e.strides[a],e.beginMask&1<<a&&(t.beginMask|=1<<n),e.endMask&1<<a&&(t.endMask|=1<<n),e.shrinkAxisMask&1<<a?(t.finalShapeGatherIndices.push(wf),t.finalShapeGatherIndicesSparse.push(-1),t.shrinkAxisMask|=1<<n):(t.finalShapeGatherIndices.push(n),t.finalShapeGatherIndicesSparse.push(a)),t.inputShapeGatherIndicesSparse[n]=a,n++}}(c,p);let h=!0,m=!0,f=!0,g=[],x=[];for(let b=0;b<e.length;++b){if(0===p.strides[b])throw Error(`strides[${b}] must be non-zero`);let t=!!(p.shrinkAxisMask&1<<b),n=e[b];if(-1===n){g.push(t?1:-1);continue}let a=[p.beginMask&1<<b,p.endMask&1<<b],r=[p.strides[b]>0?0:-1,p.strides[b]>0?n:n-1];if(t&&p.strides[b]<=0)throw Error("only stride 1 allowed on non-range indexing.");f=f&&1===p.strides[b];let s=!!(p.beginMask&1<<b&&p.endMask&1<<b);if(p.beginValid&&p.endValid){if(t){let e=p.begin[b]<0?n+p.begin[b]:p.begin[b];if(p.begin[b]=e,p.end[b]=p.begin[b]+1,e<0||e>=n)throw Error(`slice index ${p.begin[b]} of dimension ${b} out of bounds.`)}else p.begin[b]=jf(p.begin[b],0,p.strides[b],n,a,r),p.end[b]=jf(p.end[b],1,p.strides[b],n,a,r);let e=1===p.strides[b]&&0===p.begin[b]&&p.end[b]===n;h=h&&e,m=m&&(0===b&&1===p.strides[b]||e)}else h=h&&1===p.strides[b]&&s,m=m&&(0===b&&1===p.strides[b]||s);let i,o=!1;if(p.beginValid&&p.endValid?(i=p.end[b]-p.begin[b],o=!0):t?(i=1,o=!0):s&&n>=0&&(i=p.strides[b]<0?-n:n,o=!0),o){let e;e=0===i||i<0!=p.strides[b]<0?0:Math.trunc(i/p.strides[b])+(i%p.strides[b]!==0?1:0),g.push(e)}else g.push(-1)}for(let b=0;b<p.finalShapeGatherIndices.length;++b){let e=p.finalShapeGatherIndices[b];e>=0?x.push(g[e]):e===yf&&x.push(1)}return{finalShapeSparse:x.filter((e,t)=>p.finalShapeGatherIndices[t]!==yf),finalShape:x,isIdentity:h,sliceDim0:m,isSimpleSlice:f,begin:p.begin,end:p.end,strides:p.strides}}function jf(e,t,n,a,r,s){if(r[t])return n>0?s[t]:s[t+1&1];{let t=e<0?a+e:e;return t<s[0]?s[0]:t>s[1]?s[1]:t}}var Lf="4.22.0",zf=class{static sgd(e){return new Fm(e)}static momentum(e,t,n=!1){return new Dm(e,t,n)}static rmsprop(e,t=.9,n=0,a=null,r=!1){return new Mm(e,t,n,a,r)}static adam(e=.001,t=.9,n=.999,a=null){return new $m(e,t,n,a)}static adadelta(e=.001,t=.95,n=null){return new Em(e,t,n)}static adamax(e=.002,t=.9,n=.999,a=null,r=0){return new Rm(e,t,n,a,r)}static adagrad(e,t=.1){return new Am(e,t)}},Pf=zf,Bf="undefined"!=typeof requestAnimationFrame?requestAnimationFrame:"undefined"!=typeof setImmediate?setImmediate:e=>e();function Wf(){return new Promise(e=>Bf(()=>e()))}var Vf,Uf={};function Gf(e,t){let n=e[0].length;e.forEach((e,t)=>{Ze(e.length===n,()=>`Error in concat${n}D: rank of tensors[${t}] must be the same as the rank of the rest (${n})`)}),Ze(t>=0&&t<n,()=>`Error in concat${n}D: axis must be between 0 and ${n-1}.`);let a=e[0];e.forEach((e,r)=>{for(let s=0;s<n;s++)Ze(s===t||e[s]===a[s],()=>`Error in concat${n}D: Shape of tensors[${r}] (${e}) does not match the shape of the rest (${a}) along the non-concatenated axis ${r}.`)})}function Hf(e,t){let n=e[0].slice();for(let a=1;a<e.length;a++)n[t]+=e[a][t];return n}function qf(e,t,n){let a=new Array;if(null==n&&null==t)return a;if(null==t)for(;a.length<e+n.length;)a.push(-1);else a=t.slice();if(null==n)return a;if(e+n.length!==a.length)throw new Error(`rt input.shape and shape=${t} are incompatible: rt input.rank = ${e+n.length}, but shape.rank = ${a.length}`);for(let r=1;r<n.length;++r){let s=n[r],i=a[a.length-n.length+r],o=a[i];if(s>=0)if(o>=0){if(o!==s)throw new Error(`rt input.shape and shape=${t} are incompatible: rt input.shape[${r+e}] = ${s} but shape[${r+e}] = ${o}`)}else a[i]=s}return a}function Kf(e){let t={FIRST_DIM_SIZE:Vf.FIRST_DIM_SIZE,VALUE_ROWIDS:Vf.VALUE_ROWIDS,ROW_LENGTHS:Vf.ROW_LENGTHS,ROW_SPLITS:Vf.ROW_SPLITS,ROW_LIMITS:Vf.ROW_LIMITS,ROW_STARTS:Vf.ROW_STARTS},n=[];for(let a of e){if(!(a in t))break;n.push(t[a])}return n}function Xf(e){return 0===e.length?0:e[0]===Vf.FIRST_DIM_SIZE?e.length-1:e.length}function Yf(e,t){if(null==e||null==t)return;let n=e.length,a=t.length;if(n>=a)throw new Error(`defaultValue.shape=${e} and ragged tensor flatValues.shape=${t}, are incompatible: defaultValue.rank = ${n} must be less than ragged tensor input flatValues.rank = ${a})`);for(let r=0;r<Math.min(n,a-1);++r){let n=e[r],a=t[r+1];if(n>=0&&a>=0&&1!==n&&n!==a)throw new Error(`defaultValue.shape=${e}, and ragged tensor input flatValues.shape=${t} are incompatible: defaultValue.shape[${r-e.length}] = ${n} but ragged tensor input.flatValues.shape[${r-e.length}] = ${a}`)}}xe(Uf,{ERF_A1:()=>lg,ERF_A2:()=>ug,ERF_A3:()=>dg,ERF_A4:()=>cg,ERF_A5:()=>pg,ERF_P:()=>og,PARALLELIZE_THRESHOLD:()=>Zf,RowPartitionType:()=>Vf,SELU_SCALE:()=>ig,SELU_SCALEALPHA:()=>sg,applyActivation:()=>hh,assertAndGetBroadcastShape:()=>Lu,assertAxesAreInnerMostDims:()=>Ju,assertParamsConsistent:()=>Gf,assignToTypedArray:()=>bg,axesAreInnerMostDims:()=>Ku,calculateShapes:()=>Wp,checkEinsumDimSizes:()=>Cg,checkPadOnDimRoundingMode:()=>Hl,combineLocations:()=>Xu,combineRaggedTensorToTensorShapes:()=>qf,complexWithEvenIndex:()=>fg,complexWithOddIndex:()=>gg,computeConv2DInfo:()=>Ml,computeConv3DInfo:()=>Ol,computeDefaultPad:()=>jl,computeDilation2DInfo:()=>Rl,computeOptimalWindowSize:()=>Jf,computeOutAndReduceShapes:()=>Yu,computeOutShape:()=>Hf,computePool2DInfo:()=>Fl,computePool3DInfo:()=>Dl,convertConv2DDataFormat:()=>Gl,decodeEinsumEquation:()=>Ig,eitherStridesOrDilationsAreOne:()=>Vl,expandShapeToKeepDim:()=>Zu,exponent:()=>wg,exponents:()=>yg,fromStringArrayToUint8:()=>Xg,fromUint8ToStringArray:()=>Kg,getAxesPermutation:()=>Qu,getBroadcastDims:()=>Ou,getComplexWithIndex:()=>xg,getEinsumComputePath:()=>Tg,getEinsumPermutation:()=>_g,getFusedBiasGradient:()=>ph,getFusedDyActivation:()=>ch,getImageCenter:()=>Qf,getInnerMostAxes:()=>td,getPermuted:()=>tg,getRaggedRank:()=>Xf,getReductionAxes:()=>ju,getReshaped:()=>eg,getReshapedPermuted:()=>ng,getRowPartitionTypesHelper:()=>Kf,getSliceBeginCoords:()=>ag,getSliceSize:()=>rg,getSparseFillEmptyRowsIndicesDenseShapeMismatch:()=>Rg,getSparseFillEmptyRowsNegativeIndexErrorMessage:()=>Fg,getSparseFillEmptyRowsOutOfRangeIndexErrorMessage:()=>Dg,getSparseReshapeEmptyTensorZeroOutputDimErrorMessage:()=>jg,getSparseReshapeInputOutputMismatchErrorMessage:()=>zg,getSparseReshapeInputOutputMultipleErrorMessage:()=>Lg,getSparseReshapeMultipleNegativeOneOutputDimErrorMessage:()=>Mg,getSparseReshapeNegativeOutputDimErrorMessage:()=>Og,getSparseSegmentReductionIndicesOutOfRangeErrorMessage:()=>Vg,getSparseSegmentReductionNegativeSegmentIdsErrorMessage:()=>Pg,getSparseSegmentReductionNonIncreasingSegmentIdsErrorMessage:()=>Bg,getSparseSegmentReductionSegmentIdOutOfRangeErrorMessage:()=>Wg,getUndoAxesPermutation:()=>ed,isIdentityPermutation:()=>Eg,log:()=>cs,mergeRealAndImagArrays:()=>hg,prepareAndValidate:()=>xf,prepareSplitSize:()=>$g,segment_util:()=>Ug,shouldFuse:()=>mh,slice_util:()=>bf,splitRealAndImagArrays:()=>mg,stridesOrDilationsArePositive:()=>Ul,tupleValuesAreOne:()=>Wl,upcastType:()=>mi,validateDefaultValueShape:()=>Yf,validateInput:()=>Bp,validateUpdateShape:()=>Pp,warn:()=>ds}),function(e){e[e.FIRST_DIM_SIZE=0]="FIRST_DIM_SIZE",e[e.VALUE_ROWIDS=1]="VALUE_ROWIDS",e[e.ROW_LENGTHS=2]="ROW_LENGTHS",e[e.ROW_SPLITS=3]="ROW_SPLITS",e[e.ROW_LIMITS=4]="ROW_LIMITS",e[e.ROW_STARTS=5]="ROW_STARTS"}(Vf||(Vf={}));var Zf=30;function Jf(e){return e<=Zf?e:It(e,Math.floor(Math.sqrt(e)))}function Qf(e,t,n){return[n*("number"==typeof e?e:e[0]),t*("number"==typeof e?e:e[1])]}function eg(e,t,n,a=!0){let r=[];if(a)r=r.concat(t.slice(0)),r.push(e[0]/n),r=r.concat(e.slice(1));else{r=r.concat(e[0]);let n=t.length;for(let a=0;a<n;++a)r=r.concat([e[a+1]/t[a],t[a]]);r=r.concat(e.slice(n+1))}return r}function tg(e,t,n=!0){let a=[];if(n){a.push(t);for(let n=t+1;n<e;++n)n<=2*t?(a.push(n),a.push(n-(t+1))):a.push(n)}else{let n=[],r=[];for(let a=1;a<e;++a)a>=2*t+1||a%2==1?r.push(a):n.push(a);a.push(...n),a.push(0),a.push(...r)}return a}function ng(e,t,n,a=!0){let r=[];a?r.push(e[0]/n):r.push(e[0]*n);for(let s=1;s<e.length;++s)s<=t.length?a?r.push(t[s-1]*e[s]):r.push(e[s]/t[s-1]):r.push(e[s]);return r}function ag(e,t){let n=[0];for(let a=0;a<t;++a)n.push(e[a][0]);return n}function rg(e,t,n){let a=e.slice(0,1);for(let r=0;r<n;++r)a.push(e[r+1]-t[r][0]-t[r][1]);return a}var sg=1.7580993408473768,ig=1.0507009873554805,og=.3275911,lg=.254829592,ug=-.284496736,dg=1.421413741,cg=-1.453152027,pg=1.061405429;function hg(e,t){if(e.length!==t.length)throw new Error(`Cannot merge real and imag arrays of different lengths. real:${e.length}, imag: ${t.length}.`);let n=new Float32Array(2*e.length);for(let a=0;a<n.length;a+=2)n[a]=e[a/2],n[a+1]=t[a/2];return n}function mg(e){let t=new Float32Array(e.length/2),n=new Float32Array(e.length/2);for(let a=0;a<e.length;a+=2)t[a/2]=e[a],n[a/2]=e[a+1];return{real:t,imag:n}}function fg(e){let t=Math.ceil(e.length/4),n=new Float32Array(t),a=new Float32Array(t);for(let r=0;r<e.length;r+=4)n[Math.floor(r/4)]=e[r],a[Math.floor(r/4)]=e[r+1];return{real:n,imag:a}}function gg(e){let t=Math.floor(e.length/4),n=new Float32Array(t),a=new Float32Array(t);for(let r=2;r<e.length;r+=4)n[Math.floor(r/4)]=e[r],a[Math.floor(r/4)]=e[r+1];return{real:n,imag:a}}function xg(e,t){return{real:e[2*t],imag:e[2*t+1]}}function bg(e,t,n,a){e[2*a]=t,e[2*a+1]=n}function yg(e,t){let n=new Float32Array(e/2),a=new Float32Array(e/2);for(let r=0;r<Math.ceil(e/2);r++){let s=(t?2:-2)*Math.PI*(r/e);n[r]=Math.cos(s),a[r]=Math.sin(s)}return{real:n,imag:a}}function wg(e,t,n){let a=(n?2:-2)*Math.PI*(e/t);return{real:Math.cos(a),imag:Math.sin(a)}}var vg="->",kg=/->/g,Ng=",",Sg="...";function Ig(e,t){let n=((e=e.replace(/\s/g,"")).length-e.replace(kg,"").length)/vg.length;if(n<1)throw new Error("Equations without an arrow are not supported.");if(n>1)throw new Error(`Equation must contain exactly one arrow ("${vg}").`);let[a,r]=e.split(vg);Ze(-1===a.indexOf(Sg),()=>`The ellipsis notation ("${Sg}") is not supported yet.`);let s=a.split(Ng),i=s.length;if(t!==i)throw new Error(`Expected ${i} input tensors, received ${t}`);if(i>2)throw new Error("Support for more than 2 input tensors is not implemented yet.");let o=[];for(let c=0;c<r.length;++c){let e=r[c];if(!s.some(t=>-1!==t.indexOf(e)))throw new Error(`Output subscripts contain the label ${e} not present in the input subscripts.`);-1===o.indexOf(e)&&o.push(e)}for(let c=0;c<a.length;++c){let e=a[c];-1===o.indexOf(e)&&e!==Ng&&o.push(e)}let l=new Array(s.length);for(let c=0;c<i;++c){if(new Set(s[c].split("")).size!==s[c].length)throw new Error(`Found duplicate axes in input component ${s[c]}. Support for duplicate axes in input is not implemented yet.`);l[c]=[];for(let e=0;e<s[c].length;++e)l[c].push(o.indexOf(s[c][e]))}let u=o.length,d=[];for(let c=r.length;c<u;++c)d.push(c);return{allDims:o,summedDims:d,idDims:l}}function _g(e,t){let n=new Array(e);n.fill(-1);for(let r=0;r<t.length;++r)n[t[r]]=r;let a=[];for(let r=0;r<e;++r)-1===n[r]&&a.push(r);return n=n.filter(e=>-1!==e),{permutationIndices:n,expandDims:a}}function Cg(e,t,n){let a=new Array(e);for(let r=0;r<n.length;++r){let e=n[r].shape;for(let n=0;n<t[r].length;++n)void 0===a[t[r][n]]?a[t[r][n]]=e[n]:Ze(a[t[r][n]]===e[n],()=>`Expected dimension ${a[t[r][n]]} at axis ${n} of input shaped ${JSON.stringify(e)}, but got dimension ${e[n]}`)}}function Tg(e,t){let n=e,a=[],r=0;0===e.length&&n.push(-1),r=e.length+1;for(let i=0;i<r;++i)a.push([]);let s=[];for(let i=0;i<n.length;++i){let e=Ag(t,n[i]);for(let t of e)-1===s.indexOf(t)&&(a[i].push(t),s.push(t))}return{path:n,steps:a}}function Eg(e){return e.every((e,t)=>e===t)}function Ag(e,t){let n=[];for(let a=0;a<e.length;++a)(0===e[a].length||-1!==e[a].indexOf(t)||-1===t)&&n.push(a);return n}function $g(e,t,n=0){let a=[];if("number"==typeof t)Ze(e.shape[n]%t===0,()=>"Number of splits must evenly divide the axis."),a=new Array(t).fill(e.shape[n]/t);else{Ze(t.reduce((e,t)=>(-1===t&&(e+=1),e),0)<=1,()=>"There should be only one negative value in split array.");let r=t.indexOf(-1);if(-1!==r){let a=t.reduce((e,t)=>t>0?e+t:e);t[r]=e.shape[n]-a}Ze(e.shape[n]===t.reduce((e,t)=>e+t),()=>"The sum of sizes must match the size of the axis dimension."),a=t}return a}function Rg(e){return`Received SparseTensor with denseShape[0] = 0 but\n  indices.shape[0] = ${e}`}function Fg(e,t){return`indices(${e}, 0) is invalid: ${t} < 0`}function Dg(e,t,n){return`indices(${e}, 0) is invalid: ${t} >= ${n}`}function Mg(e,t){return`only one output dimension may be -1, not both ${e} and ${t}`}function Og(e,t){return`size ${e} must be non-negative, not ${t}`}function jg(){return"reshape cannot infer the missing input size for an empty tensor unless all specified input sizes are non-zero"}function Lg(e,t){return`Input to reshape is a SparseTensor with ${et(e)}\n  dense values, but the requested shape requires a multiple of ${et(t)}. inputShape=${e} outputShape= ${t}`}function zg(e,t){return`Input to reshape is a tensor with ${et(e)} dense values, but the requested shape has ${et(t)}. inputShape=${e} outputShape=${t}`}function Pg(){return"segment ids must be >= 0"}function Bg(){return"segment ids are not increasing"}function Wg(e,t){return`Segment id ${e} out of range [0, ${t}), possibly because segmentIds input is not sorted.`}function Vg(e,t,n){return`Bad: indices[${e}] == ${t} out of range [0, ${n})`}var Ug={};function Gg(e,t){let n,a=!1;for(e<=Zf?(n=e,a=!0):n=It(e,Math.floor(Math.sqrt(e)));!a;)n>t||n===e?a=!0:n=It(e,n+1);return n}function Hg(e,t,n){let a=[],r=e.length;for(let s=0;s<r;s++)s!==t?a.push(e[s]):a.push(n);return a}function qg(e,t,n,a){let r=t.shape.length,s=e.shape.length;if(0!==a&&(a<-r||a>r))throw new Error(`Expect batchDims in the range of [-${r}, ${r}], but got ${a}`);if(a<0&&(a+=r),a>s)throw new Error(`batchDims (${a}) must be less than rank(x) (\n    ${s}).`);if(n<a)throw new Error(`batchDims (${a}) must be less than or equal to axis (${n}).`);for(let c=0;c<a;++c)if(e.shape[c]!==t.shape[c])throw new Error(`x.shape[${c}]: ${e.shape[c]} should be equal to indices.shape[${c}]: ${t.shape[c]}.`);let i=e.shape[n],o=[],l=1,u=1,d=1;for(let c=0;c<a;++c)o.push(e.shape[c]),l*=e.shape[c];for(let c=a;c<n;c++)o.push(e.shape[c]),u*=e.shape[c];for(let c=a;c<r;c++)o.push(t.shape[c]);for(let c=n+1;c<s;c++)o.push(e.shape[c]),d*=e.shape[c];return{batchSize:l,sliceSize:d,outerSize:u,dimSize:i,outputShape:o}}function Kg(e){try{return e.map(e=>Us(e))}catch(t){throw new Error(`Failed to decode encoded string bytes into utf-8, error: ${t}`)}}function Xg(e){return e.map(e=>Vs(e))}xe(Ug,{collectGatherOpShapeInfo:()=>qg,computeOutShape:()=>Hg,segOpComputeOptimalWindowSize:()=>Gg});var Yg={};xe(Yg,{nonMaxSuppressionV3Impl:()=>Fh,nonMaxSuppressionV4Impl:()=>Dh,nonMaxSuppressionV5Impl:()=>Mh,whereImpl:()=>Zp}),function(){for(let e of Om)_m(e)}();var Zg={kernelName:Gt,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(e,Ap(pl(n,"float32"),-1))}}},Jg={kernelName:Ht,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>{let t=od(pl(n,"float32")),a=id(Wd(sd(1),t));return zd(xl(e,a))}}}},Qg={kernelName:qt,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>{let t=id(Wd(od(pl(n,"float32")),1));return xl(e,t)}}}},ex={kernelName:Kt,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t,r=Lu(n.shape,a.shape);return{a:()=>{let t=e,a=ju(n.shape,r);return a.length>0&&(t=ld(t,a)),ql(t,n.shape)},b:()=>{let t=e,n=ju(a.shape,r);return n.length>0&&(t=ld(t,n)),ql(t,a.shape)}}}},tx={kernelName:Xt,saveAllInputs:!0,gradFunc:(e,t)=>{let n={};return t.forEach((t,a)=>{n[a]=()=>e.clone()}),n}},nx={kernelName:Jt,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>Bu(n)}}},ax={kernelName:Qt,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>Bu(n)}}},rx={kernelName:en,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>xl(e,id(Wd(sd(1),od(pl(n,"float32")))))}}},sx={kernelName:tn,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>{let t=id(fl(sd(1),od(pl(n,"float32"))));return xl(e,t)}}}},ix={kernelName:rn,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t,r=Lu(n.shape,a.shape);return{a:()=>{let t=fl(od(n),od(a)),s=bl(e,xl(a,t)),i=ju(n.shape,r);return i.length>0&&(s=ld(s,i)),ql(s,n.shape)},b:()=>{let t=fl(od(n),od(a)),s=zd(bl(e,xl(n,t))),i=ju(a.shape,r);return i.length>0&&(s=ld(s,i)),ql(s,a.shape)}}}},ox={kernelName:nn,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>xl(e,fl(od(pl(n,"float32")),1))}}},lx={kernelName:an,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>xl(e,Wd(sd(1),od(pl(n,"float32"))))}}},ux=Bi({avgPool3dGrad_:function(e,t,n,a,r,s){let i=Li(e,"dy","avgPool3dGrad"),o=Li(t,"input","avgPool3dGrad"),l=i,u=o,d=!1;4===o.rank&&(d=!0,l=ql(i,[1,i.shape[0],i.shape[1],i.shape[2],i.shape[3]]),u=ql(o,[1,o.shape[0],o.shape[1],o.shape[2],o.shape[3]])),Ze(5===l.rank,()=>`Error in avgPool3dGrad: dy must be rank 5 but got rank ${l.rank}.`),Ze(5===u.rank,()=>`Error in avgPool3dGrad: input must be rank 5 but got rank ${u.rank}.`),Hl("avgPool3dGrad",r,s);let c={dy:l,input:u},p={filterSize:n,strides:a,pad:r,dimRoundingMode:s},h=Ci.runKernel(un,c,p);return d?ql(h,[h.shape[1],h.shape[2],h.shape[3],h.shape[4]]):h}}),dx={kernelName:ln,inputsToSave:["x"],gradFunc:(e,t,n)=>{let[a]=t,{filterSize:r,strides:s,pad:i,dimRoundingMode:o}=n;return{x:()=>ux(e,a,r,s,i,o)}}},cx=Bi({avgPoolGrad_:function(e,t,n,a,r){let s=Li(e,"dy","avgPoolGrad"),i=Li(t,"input","avgPoolGrad");Ze(i.rank===s.rank,()=>`Rank of input (${i.rank}) does not match rank of dy (${s.rank})`);let o=i,l=s,u=!1;3===i.rank&&(u=!0,o=ql(i,[1,i.shape[0],i.shape[1],i.shape[2]]),l=ql(s,[1,s.shape[0],s.shape[1],s.shape[2]])),Ze(4===l.rank,()=>`Error in avgPoolGrad: dy must be rank 4 but got rank ${l.rank}.`),Ze(4===o.rank,()=>`Error in avgPoolGrad: input must be rank 4 but got rank ${o.rank}.`);let d={dy:l,input:o},c={filterSize:n,strides:a,pad:r},p=Ci.runKernel(on,d,c);return u?ql(p,[p.shape[1],p.shape[2],p.shape[3]]):p}}),px={kernelName:sn,inputsToSave:["x"],gradFunc:(e,t,n)=>{let[a]=t,{filterSize:r,strides:s,pad:i}=n;return{x:()=>cx(e,a,r,s,i)}}},hx={kernelName:dn,inputsToSave:["a","b"],gradFunc:(e,t,n)=>{let[a,r]=t,{transposeA:s,transposeB:i}=n;return s||i?!s&&i?{a:()=>Zl(e,r,!1,!1),b:()=>Zl(e,a,!0,!1)}:s&&!i?{a:()=>Zl(r,e,!1,!0),b:()=>Zl(a,e,!1,!1)}:{a:()=>Zl(r,e,!0,!0),b:()=>Zl(e,a,!0,!0)}:{a:()=>Zl(e,r,!1,!0),b:()=>Zl(a,e,!0,!1)}}},mx={kernelName:cn,gradFunc:(e,t,n)=>{let{blockShape:a,crops:r}=n;return{x:()=>vc(e,a,r)}}},fx={kernelName:mn,gradFunc:(e,t,n)=>{let a=n,r=a.inputShape,s=a.shape,i=Array.from(s);for(let l=r.length-1;l>=0;l--)if(r[l]===s[l])i[l]=1;else if(1!==r[l])throw new Error(`broadcastTo(): [${r}] cannot be broadcast to [${s}].`);let o=[];for(let l=0;l<i.length;l++)i[l]>1&&o.push(l);return{x:()=>ld(e,o,!0)}}},gx={kernelName:gn,gradFunc:e=>({x:()=>e.clone()})},xx={kernelName:xn,gradFunc:e=>({x:()=>Bu(e)})},bx={kernelName:bn,inputsToSave:["x"],gradFunc:(e,t,n)=>{let[a]=t,{clipValueMin:r,clipValueMax:s}=n;return{x:()=>Pu(Gd(wd(a,r),Cd(a,s)),e,Bu(e))}}},yx={kernelName:wn,inputsToSave:["x"],gradFunc:Zg.gradFunc},wx={kernelName:vn,saveAllInputs:!0,gradFunc:(e,t,n)=>{let a=t.map(e=>e.shape),{axis:r}=n,s=ct(r,t[0].shape)[0],i=a.map(e=>e[s]);return Ip(e,i,s).map(e=>()=>e)}},vx={kernelName:kn,inputsToSave:["x","filter"],gradFunc:(e,t,n)=>{let[a,r]=t,{dilations:s,strides:i,pad:o,dataFormat:l}=n;return Ze(Wl(s),()=>`Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '${s}'`),{x:()=>vu(a.shape,e,r,i,o,l),filter:()=>dh(a,e,r.shape,i,o,l)}}},kx={kernelName:Sn,inputsToSave:["dy","filter"],gradFunc:(e,t,n)=>{let[a,r]=t,{strides:s,pad:i,dataFormat:o,dimRoundingMode:l}=n;return{dy:()=>yu(e,r,s,i,o,1,l),filter:()=>dh(e,a,r.shape,s,i,o,l)}}},Nx=Bi({conv3DBackpropFilter_:function(e,t,n,a,r){let s=e;4===e.rank&&(s=ql(e,[1,e.shape[0],e.shape[1],e.shape[2],e.shape[3]]));let i=t;4===i.rank&&(i=ql(t,[1,t.shape[0],t.shape[1],t.shape[2],t.shape[3]])),Ze(5===s.rank,()=>`Error in conv3dDerFilter: input must be rank 5, but got shape ${s.shape}.`),Ze(5===i.rank,()=>`Error in conv3dDerFilter: dy must be rank 5, but got shape ${i.shape}.`),Ze(5===n.length,()=>`Error in conv3dDerFilter: filterShape must be length 5, but got ${n}.`),Ze(s.shape[4]===n[3],()=>`Error in conv3dDerFilter: depth of input ${s.shape[4]}) must match input depth in filter (${n[3]}.`),Ze(i.shape[4]===n[4],()=>`Error in conv3dDerFilter: depth of dy (${i.shape[4]}) must match output depth for filter (${n[4]}).`);let o={x:s,dy:i},l={strides:a,pad:r,filterShape:n};return Ci.runKernel(_n,o,l)}}),Sx={kernelName:In,inputsToSave:["x","filter"],gradFunc:(e,t,n)=>{let{dilations:a,strides:r,pad:s}=n;Ze(Wl(a),()=>`Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '${a}'`);let[i,o]=t;return{x:()=>Su(i.shape,e,o,r,s),filter:()=>Nx(i,e,o.shape,r,s)}}},Ix={kernelName:Tn,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(zd(fp(pl(n,"float32"))),e)}}},_x={kernelName:En,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(gp(pl(n,"float32")),e)}}},Cx={kernelName:$n,inputsToSave:["x"],gradFunc:(e,t,n)=>{let[a]=t,{axis:r,exclusive:s,reverse:i}=n;return{x:()=>{let t=Qu([r],a.rank),n=Eu(e,r,s,!i);return null!=t&&(n=eh(n,t)),n}}}},Tx={kernelName:Mn,inputsToSave:["x","filter"],gradFunc:(e,t,n)=>{let{dilations:a,strides:r,pad:s,dimRoundingMode:i}=n,o=null==a?[1,1]:a;Ze(Wl(o),()=>`Error in gradient of depthwiseConv2dNative: dilation rates greater than 1 are not yet supported. Got dilations '${o}'`);let[l,u]=t;return Ze(4===l.rank,()=>`Error in gradient of depthwiseConv2dNative: input must be rank 4, but got rank ${l.rank}.`),Ze(4===u.rank,()=>`Error in gradient of depthwiseConv2dNative: filter must be rank 4, but got rank ${u.rank}.`),Ze(l.shape[3]===u.shape[2],()=>`Error in gradient of depthwiseConv2d: number of input channels (${l.shape[3]}) must match the inChannels dimension in filter ${u.shape[2]}.`),Ze(Vl(r,o),()=>`Error in gradient of depthwiseConv2d: Either strides or dilations must be  1. Got strides ${r} and dilations '${o}'.`),Hl("depthwiseConv2d",s,i),{x:()=>xh(l.shape,e,u,r,s,o,i),filter:()=>gh(l,e,u.shape,r,s,o,i)}}},Ex={kernelName:zn,inputsToSave:["x","filter"],gradFunc:(e,t,n)=>{let[a,r]=t,s={x:a,filter:r,dy:e},i={x:a,filter:r,dy:e};return{x:()=>Ci.runKernel(Pn,s,n),filter:()=>Ci.runKernel(Bn,i,n)}}},Ax={kernelName:Gn,outputsToSave:[!0],gradFunc:(e,t)=>{let[n]=t,a={dy:e,y:n};return{x:()=>Ci.runKernel(Hn,a)}}},$x={kernelName:qn,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t,a=bl(pd(zd(od(n))),2/Math.sqrt(Math.PI));return{x:()=>bl(e,a)}}},Rx={kernelName:Xn,outputsToSave:[!0],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(e,n)}}},Fx={kernelName:Yn,inputsToSave:["input"],gradFunc:(e,t)=>{let[n]=t;return{input:()=>ql(e,n.shape)}}},Dx={kernelName:Zn,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(e,pd(n))}}},Mx={kernelName:ta,gradFunc:e=>({x:()=>Bu(e)})},Ox={kernelName:na,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t,r=Lu(n.shape,a.shape);return{a:()=>{let t=xl(e,pl(a,"float32")),s=ju(n.shape,r);return s.length>0?ql(ld(t,s),n.shape):t},b:()=>{let t=bl(e,pl(n,"float32")),s=ju(a.shape,r);s.length>0&&(t=ql(ld(t,s),a.shape));let i=od(a);return zd(xl(t,pl(i,"float32")))}}}},jx={kernelName:aa,inputsToSave:["x","mean","variance","scale"],gradFunc:(e,t,n)=>{let{varianceEpsilon:a}=n,[r,s,i,o]=t,l=null==o?sd(1):o,u=ju(s.shape,r.shape),d=[];if(1===s.rank){for(let e=0;e<r.shape.length-1;++e)d.push(r.shape[e]);d.push(1)}let c=Wd(r,s),p=bl(e,l),h=dp(fl(i,sd(a))),m=bl(bl(bl(h,h),h),sd(-.5));return{x:()=>1===s.rank?ql(bl(bl(e,fd(ql(h,[1,1,1,s.shape[0]]),d)),l),r.shape):ql(bl(bl(e,h),l),r.shape),mean:()=>{let e=bl(bl(h,sd(-1)),p);return 1===s.rank&&(e=ld(e,u)),ql(e,s.shape)},variance:()=>{let e=bl(bl(m,c),p);return 1===s.rank&&(e=ld(e,u)),ql(e,s.shape)},scale:()=>{let t=bl(c,h),n=bl(e,t);return 1===s.rank&&(n=ld(n,u)),ql(n,s.shape)},offset:()=>{let t=e;return 1===s.rank&&(t=ld(t,u)),ql(t,s.shape)}}}},Lx={kernelName:ra,inputsToSave:["x","indices"],gradFunc:(e,t,n)=>{let[a,r]=t,{axis:s,batchDims:i}=n,o=ct(s,a.shape)[0],l=(e,t,n)=>()=>{let a=e.shape,r=t.size,i=a.slice(0,o),l=i.length,u=a.slice(s,a.length).slice(1),d=u.length,c=zx(0,l),p=zx(l+1,l+1+d),h=Px([i,[r],u]),m=ql(n,h),f=ql(t,[r]),g=Px([[l],c,p]),x=eh(m,g),b=qp(x,f,e.shape[o]),y=ed(g);return b=eh(b,y),b};if(1===i){let t=a.shape[0],n=a.split(t,0);return{x:()=>Ep(n.map((t,n)=>l(t,r.slice(n,1),e.slice(n,1))())).reshape(a.shape),indices:()=>r}}return{x:l(a,r,e),indices:()=>r}}};function zx(e,t){let n=[];for(let a=e;a<t;++a)n.push(a);return n}function Px(e){let t=[];for(let n=0;n<e.length;++n)for(let a=0;a<e[n].length;++a)t.push(e[n][a]);return t}var Bx={kernelName:oa,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t;return{a:()=>Bu(n),b:()=>Bu(a)}}},Wx={kernelName:la,gradFunc:e=>({x:()=>pl(e,"float32")})},Vx={kernelName:ca,gradFunc:e=>({x:()=>Bu(e)})},Ux={kernelName:pa,gradFunc:e=>({x:()=>Bu(e)})},Gx={kernelName:ha,gradFunc:e=>({x:()=>Bu(e)})},Hx={kernelName:ma,inputsToSave:["x"],gradFunc:(e,t,n)=>{let[a]=t,{alpha:r}=n,s=yd(a,0);return{x:()=>Pu(s,e,bl(e,r))}}},qx={kernelName:ya,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>xl(e,fl(n,1))}}},Kx={kernelName:ba,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>xl(e,pl(n,"float32"))}}},Xx={kernelName:Sa,inputsToSave:[],outputsToSave:[!0],gradFunc:(e,t,n)=>{let[a]=t,{axis:r}=n;return{logits:()=>{let t=pd(a);return Wd(e,bl(ld(e,r,!0),t))}}}},Yx=Bi({localResponseNormalizationBackprop_:function(e,t,n,a=5,r=1,s=1,i=.5){let o={x:e,y:t,dy:n},l={depthRadius:a,bias:r,alpha:s,beta:i};return Ci.runKernel(Ca,o,l)}}),Zx={kernelName:_a,inputsToSave:["x"],outputsToSave:[!0],gradFunc:(e,t,n)=>{let[a,r]=t,{depthRadius:s,bias:i,alpha:o,beta:l}=n;return{x:()=>Yx(a,r,e,s,i,o,l)}}};function Jx(e,t,n,a){return t.rank<n.rank&&(t=ql(t,Zu(t.shape,a))),e.rank<n.rank&&(e=ql(e,Zu(e.shape,a))),{x:()=>bl(e,pl(zu(n,t),e.dtype))}}var Qx={kernelName:Ea,inputsToSave:["x"],outputsToSave:[!0],gradFunc:(e,t,n)=>{let a=n,{reductionIndices:r}=a,s=t[0],i=Jx(e,t[1],s,ct(r,s.shape));return{x:()=>i.x()}}},eb={kernelName:Aa,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t;return{a:()=>bl(e,pl(wd(n,a),"float32")),b:()=>bl(e,pl(_d(n,a),"float32"))}}},tb=Bi({maxPool3dGrad_:function(e,t,n,a,r,s,i){let o=Li(e,"dy","maxPool3dGrad"),l=Li(t,"input","maxPool3dGrad"),u=Li(n,"output","maxPool3dGrad"),d=o,c=l,p=u,h=!1;4===l.rank&&(h=!0,d=ql(o,[1,o.shape[0],o.shape[1],o.shape[2],o.shape[3]]),c=ql(l,[1,l.shape[0],l.shape[1],l.shape[2],l.shape[3]]),p=ql(u,[1,u.shape[0],u.shape[1],u.shape[2],u.shape[3]])),Ze(5===d.rank,()=>`Error in maxPool3dGrad: dy must be rank 5 but got rank ${d.rank}.`),Ze(5===c.rank,()=>`Error in maxPool3dGrad: input must be rank 5 but got rank ${c.rank}.`),Ze(5===p.rank,()=>`Error in maxPool3dGrad: output must be rank 5 but got rank ${p.rank}.`),Hl("maxPool3dGrad",s,i);let m={dy:d,input:c,output:p},f={filterSize:a,strides:r,pad:s,dimRoundingMode:i},g=Ci.runKernel(Da,m,f);return h?ql(g,[g.shape[1],g.shape[2],g.shape[3],g.shape[4]]):g}}),nb={kernelName:Fa,inputsToSave:["x"],outputsToSave:[!0],gradFunc:(e,t,n)=>{let[a,r]=t,{filterSize:s,strides:i,pad:o,dimRoundingMode:l}=n;return{x:()=>tb(e,a,r,s,i,o,l)}}},ab=Bi({maxPoolGrad_:function(e,t,n,a,r,s,i){let o=Li(e,"dy","maxPoolGrad"),l=Li(t,"input","maxPoolGrad"),u=Li(n,"output","maxPoolGrad");Ze(l.rank===o.rank,()=>`Rank of input (${l.rank}) does not match rank of dy (${o.rank})`),Ze(4===o.rank,()=>`Error in maxPoolGrad: dy must be rank 4 but got rank ${o.rank}.`),Ze(4===l.rank,()=>`Error in maxPoolGrad: input must be rank 4 but got rank ${l.rank}.`),Hl("maxPoolGrad",s,i);let d={dy:o,input:l,output:u},c={filterSize:a,strides:r,pad:s,dimRoundingMode:i};return Ci.runKernel(Ra,d,c)}}),rb={kernelName:$a,inputsToSave:["x"],outputsToSave:[!0],gradFunc:(e,t,n)=>{let[a,r]=t,{filterSize:s,strides:i,pad:o}=n;return{x:()=>ab(e,a,r,s,i,o)}}},sb={kernelName:Oa,inputsToSave:["x"],gradFunc:(e,t,n)=>{let[a]=t,{axis:r}=n,s=ct(r,a.shape),i=et(Yu(a.shape,s)[1]);return{x:()=>{let t=a.shape.slice();s.forEach(e=>{t[e]=1});let n=ql(e,t);return xl(bl(n,rc(a.shape,"float32")),i)}}}},ib={kernelName:ja,inputsToSave:["x"],outputsToSave:[!0],gradFunc:(e,t,n)=>{let a=n,{axis:r}=a,[s,i]=t,o=Jx(e,i,s,ct(r,s.shape));return{x:()=>o.x()}}},ob={kernelName:La,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t;return{a:()=>bl(e,pl(Cd(n,a),"float32")),b:()=>bl(e,pl(yd(n,a),"float32"))}}},lb={kernelName:za,inputsToSave:["x"],gradFunc:(e,t,n)=>{let a=t[0],{paddings:r}=n,s=r.map(e=>e[0]);return{x:()=>Ql(e,s,a.shape)}}},ub={kernelName:Pa,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t,r=Lu(n.shape,a.shape);return{a:()=>{let t=ju(n.shape,r);return t.length>0?ql(ld(e,t),n.shape):e},b:()=>{let t=bl(e,zd(xd(xl(n,a)))),s=ju(a.shape,r);return s.length>0?ql(ld(t,s),a.shape):t}}}},db={kernelName:Wa,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t,r=Lu(n.shape,a.shape);return{a:()=>{let t=bl(e,pl(a,"float32")),s=ju(n.shape,r);return s.length>0?ql(ld(t,s),n.shape):t},b:()=>{let t=bl(e,pl(n,"float32")),s=ju(a.shape,r);return s.length>0?ql(ld(t,s),a.shape):t}}}},cb={kernelName:Va,gradFunc:e=>({x:()=>zd(e)})},pb={kernelName:Xa,inputsToSave:["indices"],gradFunc:(e,t)=>{let n=t[0];return{indices:()=>ac(n.shape,"float32")}}},hb={kernelName:Ka,gradFunc:e=>({x:()=>Bu(e)})},mb={kernelName:Ya,saveAllInputs:!0,gradFunc:(e,t,n)=>{let{axis:a}=n;return Kp(e,a).map(e=>()=>e)}},fb={kernelName:Za,inputsToSave:["x"],gradFunc:(e,t,n)=>{let a=t[0],{paddings:r}=n,s=r.map(e=>e[0]);return{x:()=>Ql(e,s,a.shape)}}},gb={kernelName:Qa,inputsToSave:["a","b"],outputsToSave:[!0],gradFunc:(e,t)=>{let[n,a,r]=t,s=n,i=a,o=Lu(s.shape,i.shape);return{a:()=>{let t=pl(i,"float32"),n=bl(e,bl(t,rd(s,Wd(t,sd(1))))),a=ju(s.shape,o);return a.length>0&&(n=ld(n,a)),ql(n,s.shape)},b:()=>{let t=yd(s,0),n=Pu(t,Ad(s),Bu(s)),a=bl(e,bl(r,n)),l=ju(i.shape,o);return l.length>0&&(a=ld(a,l)),ql(a,i.shape)}}}},xb={kernelName:er,inputsToSave:["x","alpha"],gradFunc:(e,t)=>{let[n,a]=t,r=yd(n,0);return{x:()=>Pu(r,e,bl(e,a)),alpha:()=>{let t=Pu(r,Bu(e),bl(e,n)),s=ju(a.shape,e.shape);return s.length>0&&(t=ld(t,s)),ql(t,a.shape)}}}};var bb={kernelName:tr,inputsToSave:["x"],gradFunc:(e,t,n)=>{let[a]=t,{axis:r}=n,s=[];return s=null==r?a.shape.map((e,t)=>t):"number"==typeof r?[r]:r,{x:()=>function(e,t,n){let a=e.shape.length,r=a-n.length,s=Uf.getAxesPermutation(n,a),i=e;null!=s&&(i=eh(e,s));let o=i.shape.slice(),l=o.splice(a-n.length,n.length).reduce((e,t)=>e*t,1);o.push(l);let u=function(e,t,n){let a=e.shape.slice();a[n]=1;let r=ql(t,a),s=Tu(e,n,!0,!1),i=Tu(e,n,!0,!0),o=bl(s,i);return bl(r,o)}(i.reshape(o),t,r);if(u=u.reshape(i.shape),null!=s){let e=Uf.getUndoAxesPermutation(s);u=eh(u,e)}return u}(a,e,s)}}},yb={kernelName:Vn,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t,r=Lu(n.shape,a.shape);return{a:()=>{let t=xl(e,pl(a,"float32")),s=ju(n.shape,r);return s.length>0?ql(ld(t,s),n.shape):t},b:()=>{let t=bl(e,pl(n,"float32")),s=ju(a.shape,r);s.length>0&&(t=ql(ld(t,s),a.shape));let i=od(a);return zd(xl(t,pl(i,"float32")))}}}},wb={kernelName:or,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>xl(e,zd(od(n)))}}},vb={kernelName:mr,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t,a=bl(Cd(n,6),Ap(n));return{x:()=>bl(e,pl(a,"float32"))}}},kb={kernelName:lr,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(e,pl(Ap(n),"float32"))}}},Nb={kernelName:ur,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>ql(e,n.shape)}}},Sb={kernelName:pr,inputsToSave:["images"],gradFunc:(e,t,n)=>{let[a]=t,r={dy:e,images:a};return{images:()=>Ci.runKernel(hr,r,n)}}},Ib={kernelName:dr,inputsToSave:["images"],gradFunc:(e,t,n)=>{let[a]=t,r={dy:e,images:a};return{images:()=>Ci.runKernel(cr,r,n)}}},_b={kernelName:fr,gradFunc:(e,t,n)=>{let{dims:a}=n,r=ct(a,e.shape);return{x:()=>rp(e,r)}}},Cb={kernelName:gr,gradFunc:e=>({x:()=>Bu(e)})},Tb={kernelName:xr,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>zd(xl(e,bl(rd(n,1.5),2)))}}},Eb={kernelName:vr,inputsToSave:["condition"],gradFunc:(e,t)=>{let[n]=t;return{condition:()=>pl(Bu(n),"float32"),t:()=>bl(e,pl(n,e.dtype)),e:()=>bl(e,pl(Hd(n),e.dtype))}}},Ab={kernelName:kr,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>{let t=yd(n,sd(0)),a=sd(sg),r=sd(ig),s=bl(e,r),i=bl(bl(e,a),pd(pl(n,"float32")));return Pu(t,s,i)}}}},$b={kernelName:Cr,outputsToSave:[!0],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(e,bl(n,Wd(sd(1),n)))}}},Rb={kernelName:_r,gradFunc:e=>({x:()=>Bu(e)})},Fb={kernelName:Sr,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(_u(pl(n,"float32")),e)}}},Db={kernelName:Ir,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(Cu(pl(n,"float32")),e)}}},Mb={kernelName:Nr,inputsToSave:["x"],gradFunc:(e,t,n)=>{let[a]=t,{begin:r,size:s}=n,i=a.shape,[o,l]=Mf(a,r,s),u=[];for(let d=0;d<e.rank;d++)u.push([o[d],i[d]-o[d]-l[d]]);return{x:()=>gc(e,u)}}},Ob={kernelName:Fr,outputsToSave:[!0],gradFunc:(e,t,n)=>{let[a]=t,{dim:r}=n,s=bl(e,a);return{logits:()=>Wd(s,bl(ld(s,[r],!0),a))}}},jb={kernelName:Tr,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(e,Jl(n))}}},Lb={kernelName:$r,gradFunc:(e,t,n)=>{let{blockShape:a,paddings:r}=n;return{x:()=>nu(e,a,r)}}},zb={kernelName:Rr,gradFunc:(e,t,n)=>{let{axis:a}=n;return{x:()=>Yl(e,a)}}},Pb={kernelName:Er,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>xl(e,bl(id(pl(n,"float32")),2))}}},Bb={kernelName:Pr,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(e,bl(pl(n,"float32"),2))}}},Wb={kernelName:zr,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t,r=sd(2);return{a:()=>bl(e,bl(r,Wd(n,a))),b:()=>bl(e,bl(r,Wd(a,n)))}}},Vb={kernelName:rs,gradFunc:e=>({x:()=>Bu(e)})},Ub={kernelName:Hr,inputsToSave:["a","b"],gradFunc:(e,t)=>{let[n,a]=t,r=Lu(n.shape,a.shape);return{a:()=>{let t=e,a=ju(n.shape,r);return a.length>0&&(t=ld(t,a)),ql(t,n.shape)},b:()=>{let t=e,n=ju(a.shape,r);return n.length>0&&(t=ld(t,n)),ql(zd(t),a.shape)}}}},Gb={kernelName:Ar,inputsToSave:["x"],gradFunc:(e,t,n)=>{let[a]=t,r=a.shape.slice(),{axis:s}=n;ct(s,a.shape).forEach(e=>{r[e]=1});let i=ql(e,r),o=bl(i,rc(a.shape,"float32"));return{x:()=>o}}},Hb={kernelName:qr,inputsToSave:["x"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>xl(e,od(_u(n)))}}},qb={kernelName:Kr,outputsToSave:[!0],gradFunc:(e,t)=>{let[n]=t;return{x:()=>bl(Wd(sd(1),od(n)),e)}}},Kb={kernelName:Xr,inputsToSave:["x"],gradFunc:(e,t,n)=>{let[a]=t,{reps:r}=n;return{x:()=>{let t=Bu(a);if(1===a.rank)for(let n=0;n<r[0];++n)t=fl(t,Ql(e,[n*a.shape[0]],[a.shape[0]]));else if(2===a.rank)for(let n=0;n<r[0];++n)for(let s=0;s<r[1];++s)t=fl(t,Ql(e,[n*a.shape[0],s*a.shape[1]],[a.shape[0],a.shape[1]]));else if(3===a.rank)for(let n=0;n<r[0];++n)for(let s=0;s<r[1];++s)for(let i=0;i<r[2];++i)t=fl(t,Ql(e,[n*a.shape[0],s*a.shape[1],i*a.shape[2]],[a.shape[0],a.shape[1],a.shape[2]]));else{if(4!==a.rank)throw new Error(`Gradient for tile operation is not implemented for rank-${a.rank} tensors yet.`);for(let n=0;n<r[0];++n)for(let s=0;s<r[1];++s)for(let i=0;i<r[2];++i)for(let o=0;o<r[3];++o)t=fl(t,Ql(e,[n*a.shape[0],s*a.shape[1],i*a.shape[2],o*a.shape[3]],[a.shape[0],a.shape[1],a.shape[2],a.shape[3]]))}return t}}}},Xb={kernelName:Jr,gradFunc:(e,t,n)=>{let a=n,{perm:r}=a,s=ed(r);return{x:()=>eh(e,s)}}},Yb={kernelName:es,gradFunc:(e,t,n)=>{let a=n,{axis:r}=a;return{value:()=>Ep(e,r)}}},Zb={kernelName:ts,inputsToSave:["segmentIds"],gradFunc:(e,t)=>{let[n]=t;return{x:()=>function(e,t){let n=tc(t,Bu(t)),a=bd(e,n),r=wd(t,sd(0,"int32")),s=a.rank-r.rank;for(let o=0;o<s;++o)r=hd(r,o+1);r=Gd(r,rc(a.shape,"bool"));let i=Bu(a);return Pu(r,a,i)}(e,n)}}},Jb={kernelName:as,gradFunc:e=>({x:()=>Bu(e)})},Qb=[Zg,Jg,Qg,ex,tx,nx,ax,rx,sx,ix,ox,lx,dx,px,hx,mx,fx,gx,xx,bx,yx,wx,kx,vx,Sx,Ix,_x,Cx,Tx,Ex,yb,Ax,$x,Rx,Fx,Dx,Ox,Mx,jx,Lx,Bx,Wx,Vx,Ux,Gx,Hx,qx,Kx,Xx,Zx,Qx,Qx,eb,nb,rb,sb,ib,ob,lb,ub,db,cb,pb,hb,mb,fb,fb,gb,xb,bb,wb,vb,kb,Nb,Sb,Ib,_b,Cb,Tb,Eb,Ab,$b,Rb,Fb,Db,Mb,Ob,jb,Lb,Lb,zb,zb,Pb,Wb,Bb,Vb,Ub,Gb,Hb,qb,Kb,Xb,Yb,Zb,Jb];for(let p1 of Qb)bs(p1);si().prototype.abs=function(){return this.throwIfDisposed(),yl(this)},si().prototype.acos=function(){return this.throwIfDisposed(),wl(this)},si().prototype.acosh=function(){return this.throwIfDisposed(),vl(this)},si().prototype.add=function(e){return this.throwIfDisposed(),fl(this,e)},si().prototype.all=function(e,t){return this.throwIfDisposed(),Nl(this,e,t)},si().prototype.any=function(e,t){return this.throwIfDisposed(),Sl(this,e,t)},si().prototype.argMax=function(e){return this.throwIfDisposed(),Il(this,e)},si().prototype.argMin=function(e){return this.throwIfDisposed(),_l(this,e)},si().prototype.asScalar=function(){return this.throwIfDisposed(),Ze(1===this.size,()=>"The array must have only 1 element."),ql(this,[])},si().prototype.asType=function(e){return this.throwIfDisposed(),pl(this,e)},si().prototype.as1D=function(){return this.throwIfDisposed(),ql(this,[this.size])},si().prototype.as2D=function(e,t){return this.throwIfDisposed(),ql(this,[e,t])},si().prototype.as3D=function(e,t,n){return this.throwIfDisposed(),ql(this,[e,t,n])},si().prototype.as4D=function(e,t,n,a){return this.throwIfDisposed(),ql(this,[e,t,n,a])},si().prototype.as5D=function(e,t,n,a,r){return this.throwIfDisposed(),ql(this,[e,t,n,a,r])},si().prototype.asin=function(){return this.throwIfDisposed(),Cl(this)},si().prototype.asinh=function(){return this.throwIfDisposed(),Tl(this)},si().prototype.atan=function(){return this.throwIfDisposed(),El(this)},si().prototype.atan2=function(e){return this.throwIfDisposed(),Al(this,e)},si().prototype.atanh=function(){return this.throwIfDisposed(),$l(this)},si().prototype.avgPool=function(e,t,n,a){return this.throwIfDisposed(),Kl(this,e,t,n,a)},si().prototype.batchToSpaceND=function(e,t){return this.throwIfDisposed(),nu(this,e,t)},si().prototype.batchNorm=function(e,t,n,a,r){return this.throwIfDisposed(),ru(this,e,t,n,a,r)},si().prototype.broadcastTo=function(e){return this.throwIfDisposed(),cu(this,e)},si().prototype.cast=function(e){return this.throwIfDisposed(),pl(this,e)},si().prototype.ceil=function(){return this.throwIfDisposed(),pu(this)},si().prototype.clipByValue=function(e,t){return this.throwIfDisposed(),mu(this,e,t)},si().prototype.concat=function(e,t){return this.throwIfDisposed(),e instanceof ri&&(e=[e]),Yl([this,...e],t)},si().prototype.conv1d=function(e,t,n,a,r,s){return this.throwIfDisposed(),wu(this,e,t,n,a,r,s)},si().prototype.conv2dTranspose=function(e,t,n,a,r){return this.throwIfDisposed(),ku(this,e,t,n,a,r)},si().prototype.conv2d=function(e,t,n,a,r,s){return this.throwIfDisposed(),yu(this,e,t,n,a,r,s)},si().prototype.cos=function(){return this.throwIfDisposed(),_u(this)},si().prototype.cosh=function(){return this.throwIfDisposed(),Cu(this)},si().prototype.cumprod=function(e,t,n){return this.throwIfDisposed(),Tu(this,e,t,n)},si().prototype.cumsum=function(e,t,n){return this.throwIfDisposed(),Eu(this,e,t,n)},si().prototype.depthToSpace=function(e,t){return this.throwIfDisposed(),$u(this,e,t)},si().prototype.depthwiseConv2d=function(e,t,n,a,r,s){return this.throwIfDisposed(),Ru(this,e,t,n,a,r,s)},si().prototype.dilation2d=function(e,t,n,a,r){return this.throwIfDisposed(),Du(this,e,t,n,a,r)},si().prototype.divNoNan=function(e){return this.throwIfDisposed(),Wu(this,e)},si().prototype.div=function(e){return this.throwIfDisposed(),xl(this,e)},si().prototype.dot=function(e){return this.throwIfDisposed(),Vu(this,e)},si().prototype.elu=function(){return this.throwIfDisposed(),Gu(this)},si().prototype.equal=function(e){return this.throwIfDisposed(),zu(this,e)},si().prototype.erf=function(){return this.throwIfDisposed(),qu(this)},si().prototype.euclideanNorm=function(e,t){return this.throwIfDisposed(),cd(this,e,t)},si().prototype.exp=function(){return this.throwIfDisposed(),pd(this)},si().prototype.expandDims=function(e){return this.throwIfDisposed(),hd(this,e)},si().prototype.expm1=function(){return this.throwIfDisposed(),md(this)},si().prototype.fft=function(){return this.throwIfDisposed(),kp(this)},si().prototype.flatten=function(){return this.throwIfDisposed(),ql(this,[this.size])},si().prototype.floor=function(){return this.throwIfDisposed(),xd(this)},si().prototype.floorDiv=function(e){return this.throwIfDisposed(),gl(this,e)},si().prototype.gather=function(e,t,n){return this.throwIfDisposed(),bd(this,e,t,n)},si().prototype.greaterEqual=function(e){return this.throwIfDisposed(),wd(this,e)},si().prototype.greater=function(e){return this.throwIfDisposed(),yd(this,e)},si().prototype.ifft=function(){return this.throwIfDisposed(),Np(this)},si().prototype.irfft=function(){return this.throwIfDisposed(),Sp(this)},si().prototype.isFinite=function(){return this.throwIfDisposed(),kd(this)},si().prototype.isInf=function(){return this.throwIfDisposed(),Nd(this)},si().prototype.isNaN=function(){return this.throwIfDisposed(),Sd(this)},si().prototype.leakyRelu=function(e){return this.throwIfDisposed(),Id(this,e)},si().prototype.lessEqual=function(e){return this.throwIfDisposed(),Cd(this,e)},si().prototype.less=function(e){return this.throwIfDisposed(),_d(this,e)},si().prototype.localResponseNormalization=function(e,t,n,a){return this.throwIfDisposed(),Ed(this,e,t,n,a)},si().prototype.logSigmoid=function(){return this.throwIfDisposed(),Bd(this)},si().prototype.logSoftmax=function(e){return this.throwIfDisposed(),Vd(this,e)},si().prototype.logSumExp=function(e,t){return this.throwIfDisposed(),Ud(this,e,t)},si().prototype.log=function(){return this.throwIfDisposed(),Ad(this)},si().prototype.log1p=function(){return this.throwIfDisposed(),$d(this)},si().prototype.logicalAnd=function(e){return this.throwIfDisposed(),Gd(this,e)},si().prototype.logicalNot=function(){return this.throwIfDisposed(),Hd(this)},si().prototype.logicalOr=function(e){return this.throwIfDisposed(),qd(this,e)},si().prototype.logicalXor=function(e){return this.throwIfDisposed(),Kd(this,e)},si().prototype.matMul=function(e,t,n){return this.throwIfDisposed(),Zl(this,e,t,n)},si().prototype.maxPool=function(e,t,n,a){return this.throwIfDisposed(),Jd(this,e,t,n,a)},si().prototype.max=function(e,t){return this.throwIfDisposed(),nd(this,e,t)},si().prototype.maximum=function(e){return this.throwIfDisposed(),tc(this,e)},si().prototype.mean=function(e,t){return this.throwIfDisposed(),nc(this,e,t)},si().prototype.min=function(e,t){return this.throwIfDisposed(),ad(this,e,t)},si().prototype.minimum=function(e){return this.throwIfDisposed(),ic(this,e)},si().prototype.mirrorPad=function(e,t){return this.throwIfDisposed(),oc(this,e,t)},si().prototype.mod=function(e){return this.throwIfDisposed(),lc(this,e)},si().prototype.mul=function(e){return this.throwIfDisposed(),bl(this,e)},si().prototype.neg=function(){return this.throwIfDisposed(),zd(this)},si().prototype.norm=function(e,t,n){return this.throwIfDisposed(),dd(this,e,t,n)},si().prototype.notEqual=function(e){return this.throwIfDisposed(),pc(this,e)},si().prototype.oneHot=function(e,t=1,n=0){return this.throwIfDisposed(),hc(this,e,t,n)},si().prototype.onesLike=function(){return this.throwIfDisposed(),mc(this)},si().prototype.pad=function(e,t){return this.throwIfDisposed(),gc(this,e,t)},si().prototype.pool=function(e,t,n,a,r,s){return this.throwIfDisposed(),kc(this,e,t,n,a,r,s)},si().prototype.pow=function(e){return this.throwIfDisposed(),rd(this,e)},si().prototype.prelu=function(e){return this.throwIfDisposed(),Nc(this,e)},si().prototype.prod=function(e,t){return this.throwIfDisposed(),Sc(this,e,t)},si().prototype.reciprocal=function(){return this.throwIfDisposed(),tp(this)},si().prototype.relu=function(){return this.throwIfDisposed(),np(this)},si().prototype.relu6=function(){return this.throwIfDisposed(),ap(this)},si().prototype.reshapeAs=function(e){return this.throwIfDisposed(),ql(this,e.shape)},si().prototype.reshape=function(e){return this.throwIfDisposed(),ql(this,e)},si().prototype.resizeBilinear=function(e,t,n){return this.throwIfDisposed(),Wh(this,e,t,n)},si().prototype.resizeNearestNeighbor=function(e,t,n){return this.throwIfDisposed(),Vh(this,e,t,n)},si().prototype.reverse=function(e){return this.throwIfDisposed(),rp(this,e)},si().prototype.rfft=function(){return this.throwIfDisposed(),_p(this)},si().prototype.round=function(){return this.throwIfDisposed(),up(this)},si().prototype.rsqrt=function(){return this.throwIfDisposed(),dp(this)},si().prototype.selu=function(){return this.throwIfDisposed(),cp(this)},si().prototype.separableConv2d=function(e,t,n,a,r,s){return this.throwIfDisposed(),pp(this,e,t,n,a,r,s)},si().prototype.sigmoid=function(){return this.throwIfDisposed(),Jl(this)},si().prototype.sign=function(){return this.throwIfDisposed(),mp(this)},si().prototype.sin=function(){return this.throwIfDisposed(),fp(this)},si().prototype.sinh=function(){return this.throwIfDisposed(),gp(this)},si().prototype.slice=function(e,t){return this.throwIfDisposed(),Ql(this,e,t)},si().prototype.softmax=function(e){return this.throwIfDisposed(),vp(this,e)},si().prototype.softplus=function(){return this.throwIfDisposed(),Pd(this)},si().prototype.spaceToBatchND=function(e,t){return this.throwIfDisposed(),vc(this,e,t)},si().prototype.split=function(e,t){return this.throwIfDisposed(),Ip(this,e,t)},si().prototype.sqrt=function(){return this.throwIfDisposed(),id(this)},si().prototype.square=function(){return this.throwIfDisposed(),od(this)},si().prototype.squaredDifference=function(e){return this.throwIfDisposed(),Cp(this,e)},si().prototype.squeeze=function(e){return this.throwIfDisposed(),Tp(this,e)},si().prototype.stack=function(e,t){this.throwIfDisposed();let n=e instanceof ri?[this,e]:[this,...e];return Ep(n,t)},si().prototype.step=function(e){return this.throwIfDisposed(),Ap(this,e)},si().prototype.stridedSlice=function(e,t,n,a,r,s,i,o){return this.throwIfDisposed(),$p(this,e,t,n,a,r,s,i,o)},si().prototype.sub=function(e){return this.throwIfDisposed(),Wd(this,e)},si().prototype.sum=function(e,t){return this.throwIfDisposed(),ld(this,e,t)},si().prototype.tan=function(){return this.throwIfDisposed(),Rp(this)},si().prototype.tanh=function(){return this.throwIfDisposed(),eu(this)},si().prototype.tile=function(e){return this.throwIfDisposed(),fd(this,e)},si().prototype.toBool=function(){return this.throwIfDisposed(),pl(this,"bool")},si().prototype.toFloat=function(){return this.throwIfDisposed(),pl(this,"float32")},si().prototype.toInt=function(){return this.throwIfDisposed(),pl(this,"int32")},si().prototype.topk=function(e,t){return this.throwIfDisposed(),Up(this,e,t)},si().prototype.transpose=function(e){return this.throwIfDisposed(),eh(this,e)},si().prototype.unique=function(e){return this.throwIfDisposed(),Hp(this,e)},si().prototype.unsortedSegmentSum=function(e,t){return this.throwIfDisposed(),qp(this,e,t)},si().prototype.unstack=function(e){return this.throwIfDisposed(),Kp(this,e)},si().prototype.where=function(e,t){return this.throwIfDisposed(),Pu(e,this,t)},si().prototype.zerosLike=function(){return this.throwIfDisposed(),Bu(this)};var ey=class e extends Error{constructor(t){super(t),Object.setPrototypeOf(this,e.prototype)}},ty=class e extends Error{constructor(t){super(t),Object.setPrototypeOf(this,e.prototype)}},ny=class e extends Error{constructor(t){super(t),Object.setPrototypeOf(this,e.prototype)}},ay=class e extends Error{constructor(t){super(t),Object.setPrototypeOf(this,e.prototype)}},ry=class e extends Error{constructor(t){super(t),Object.setPrototypeOf(this,e.prototype)}},sy=class{constructor(e){this.maxEntries=e||100,this.cache=new Map}get(e){let t;return this.cache.has(e)&&(t=this.cache.get(e),this.cache.delete(e),this.cache.set(e,t)),t}put(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.maxEntries){let e=this.cache.keys().next().value;this.cache.delete(e)}this.cache.set(e,t)}getMaxEntries(){return this.maxEntries}setMaxEntries(e){if(e<0)throw new Error(`The maxEntries of LRU caches must be at least 0, but got ${e}.`);if(this.maxEntries>e)for(let t=0;t<this.maxEntries-e;t++){let e=this.cache.keys().next().value;this.cache.delete(e)}this.maxEntries=e}};function iy(e,t){if(Array.isArray(e)){let n=[];for(let a=0;a<t;a++)n=n.concat(e);return n}{let n=new Array(t);return n.fill(e),n}}function oy(e,t){if(!e)throw new ry(t)}function ly(e,t){let n=0;for(let a of e)a===t&&n++;return n}function uy(e){return 1===e.length?e[0]:e}function dy(e){return Array.isArray(e)?e:[e]}function cy(e){let t=e.replace(/(.)([A-Z][a-z0-9]+)/g,"$1_$2").replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase();return"_"!==t[0]?t:"private"+t}function py(e){return e.length<=1||-1===e.indexOf("_")?e:e.replace(/[_]+(\w|$)/g,(e,t)=>t.toUpperCase())}var hy={};function my(e){if(null==e)return null;let t={};return t.className=e.getClassName(),t.config=e.getConfig(),t}function fy(e){if(null!=e&&"object"==typeof e)if(Array.isArray(e))e.forEach(e=>fy(e));else{let t=Object.keys(e);for(let n of t){let t=e[n];null!=t&&"object"==typeof t&&(Array.isArray(t)||"ndarray"!==t.type||"number"!=typeof t.value?fy(t):e[n]=t.value)}}}function gy(e,t={},n={},a="object",r=!1){if("string"==typeof e){let r,s=e;if(s in n)r=n[s];else if(s in hy)r=hy[s];else if(r=t[s],null==r)throw new ny(`Unknown ${a}: ${e}. This may be due to one of the following reasons:\n1. The ${a} is defined in Python, in which case it needs to be ported to TensorFlow.js or your JavaScript code.\n2. The custom ${a} is defined in JavaScript, but is not registered properly with tf.serialization.registerClass().`);return r}{let s=e;if(null==s.className||null==s.config)throw new ny(`${a}: Improper config format: ${JSON.stringify(s)}.\n'className' and 'config' must set.`);let i,o,l=s.className;if(l in n?[i,o]=n[l]:l in hy?[i,o]=hy.className:l in t&&([i,o]=t[l]),null==i)throw new ny(`Unknown ${a}: ${l}. This may be due to one of the following reasons:\n1. The ${a} is defined in Python, in which case it needs to be ported to TensorFlow.js or your JavaScript code.\n2. The custom ${a} is defined in JavaScript, but is not registered properly with tf.serialization.registerClass().`);if(null!=o){let e={};for(let n of Object.keys(hy))e[n]=hy[n];for(let r of Object.keys(n))e[r]=n[r];s.config.customObjects=e;let t=Object.assign({},hy);for(let r of Object.keys(n))hy[r]=n[r];fy(s.config);let a=o(i,s.config,n,r);return hy=Object.assign({},t),a}{let e=Object.assign({},hy);for(let a of Object.keys(n))hy[a]=n[a];let t=new i(s.config);return hy=Object.assign({},e),t}}}function xy(e,t){return-1*function(e,t){return e<t?-1:e>t?1:0}(e,t)}function by(e){if(null==e)return e;let t=[];for(let n of e)-1===t.indexOf(n)&&t.push(n);return t}function yy(e){if(null==e)throw new ny(`Invalid value in obj: ${JSON.stringify(e)}`);for(let t in e)if(e.hasOwnProperty(t))return!1;return!0}function wy(e,t,n){if(null!=n&&e.indexOf(n)<0)throw new ny(`${n} is not a valid ${t}.  Valid values are ${e} or null/undefined.`)}function vy(e,t,n=0,a=1/0){return oy(n>=0),oy(a>=n),Array.isArray(e)&&e.length>=n&&e.length<=a&&e.every(e=>typeof e===t)}function ky(e,t){Array.isArray(e)?(Ns.assert(e.length>0,()=>`${t} is unexpectedly an empty array.`),e.forEach((e,n)=>ky(e,`element ${n+1} of ${t}`))):Ns.assert(Number.isInteger(e)&&e>0,()=>`Expected ${t} to be a positive integer, but got ${Ny(e)}.`)}function Ny(e){return null===e?"null":Array.isArray(e)?"["+e.map(e=>Ny(e)).join(",")+"]":"string"==typeof e?`"${e}"`:`${e}`}function Sy(e){return"relu"===e?"relu":"linear"===e?"linear":"elu"===e?"elu":null}var Iy=0;function _y(){return Iy++}var Cy={};function Ty(e=""){return e in Cy||(Cy[e]=0),Cy[e]+=1,e+Cy[e].toString()}var Ey=["channelsFirst","channelsLast"],Ay=["nearest","bilinear"],$y=["valid","same","causal"],Ry=["max","avg"],Fy=["sum","mul","concat","ave"],Dy=new Map;function My(e){wy(Ey,"DataFormat",e)}function Oy(e){wy($y,"PaddingMode",e)}function jy(e){wy(Ry,"PoolMode",e)}var Ly=[];function zy(e,t){Ly.push(e);try{let e=t();return Ly.pop(),e}catch(XQ){throw Ly.pop(),XQ}}function Py(e){if(!Uy(e))throw new Error("Not a valid tensor name: '"+e+"'");return(0===Ly.length?"":Ly.join("/")+"/")+e}function By(e){if(!Uy(e))throw new Error("Not a valid tensor name: '"+e+"'");Dy.has(e)||Dy.set(e,0);let t=Dy.get(e);if(Dy.set(e,Dy.get(e)+1),t>0){let n=`${e}_${t}`;return Dy.set(n,1),n}return e}var Wy,Vy=new RegExp(/^[A-Za-z0-9][-A-Za-z0-9\._\/]*$/);function Uy(e){return!!e.match(Vy)}function Gy(e){return e===parseInt(e.toString(),10)}function Hy(e,t,n){null==t&&(t=0),null==n&&(n=e.length);let a=1;for(let r=t;r<n;++r)a*=e[r];return a}function qy(e){if(0===e.length)return Number.NaN;let t=Number.POSITIVE_INFINITY;for(let n=0;n<e.length;n++){let a=e[n];a<t&&(t=a)}return t}function Ky(e){if(0===e.length)return Number.NaN;let t=Number.NEGATIVE_INFINITY;for(let n=0;n<e.length;n++){let a=e[n];a>t&&(t=a)}return t}function Xy(e,t){if(t<e)throw new ny(`end (${t}) < begin (${e}) is forbidden.`);let n=[];for(let a=e;a<t;++a)n.push(a);return n}function Yy(){return null==Wy&&(Wy=ho().epsilon()),Wy}function Zy(e,t){return pl(e,t)}function Jy(e,t=-1){let n=e.shape.slice();return t<0&&(t=n.length+t+1),n.splice(t,0,1),ql(e,n)}function Qy(e,t,n){return to(()=>{switch(e.rank){case 1:return xp(e,t,n);case 2:return bp(e,[t,0],[n,e.shape[1]]);case 3:return yp(e,[t,0,0],[n,e.shape[1],e.shape[2]]);case 4:return wp(e,[t,0,0,0],[n,e.shape[1],e.shape[2],e.shape[3]]);case 5:return Ql(e,[t,0,0,0,0],[n,e.shape[1],e.shape[2],e.shape[3],e.shape[4]]);case 6:return Ql(e,[t,0,0,0,0,0],[n,e.shape[1],e.shape[2],e.shape[3],e.shape[4],e.shape[5]]);default:throw new ny(`sliceAlongFirstAxis() received an unsupported tensor rank: ${e.rank}`)}})}function ew(e,t,n){return to(()=>{switch(e.rank){case 1:return xp(e,t,n);case 2:return bp(e,[0,t],[e.shape[0],n]);case 3:return yp(e,[0,0,t],[e.shape[0],e.shape[1],n]);case 4:return wp(e,[0,0,0,t],[e.shape[0],e.shape[1],e.shape[2],n]);default:throw new ny(`sliceAlongLastAxis() received an unsupported tensor rank: ${e.rank}`)}})}function tw(e,t,n,a){return to(()=>{switch(e.rank){case 1:return xp(e,t,n);case 2:switch(a){case 1:return Qy(e,t,n);case 2:return ew(e,t,n);default:throw new ny(`The axis is not within the rank of the tensor ${a}`)}case 3:switch(a){case 1:return Qy(e,t,n);case 2:return yp(e,[0,t,0],[e.shape[0],n,e.shape[2]]);case 3:return ew(e,t,n);default:throw new ny(`The axis is not within the rank of the tensor ${a}`)}case 4:switch(a){case 1:return Qy(e,t,n);case 2:return wp(e,[0,t,0,0],[e.shape[0],n,e.shape[2],e.shape[3]]);case 3:return wp(e,[0,0,t,0],[e.shape[0],e.shape[1],n,e.shape[3]]);case 4:return ew(e,t,n);default:throw new ny(`The axis is not within the rank of the tensor ${a}`)}default:throw new ny(`sliceAlongLastAxis() received an unsupported tensor rank: ${e.rank}`)}})}function nw(e,t=-1){let n;return t<0&&(n=e[0].rank,t=0!==n?n:0),t===e[0].rank&&(t=-1),Yl(e,t)}function aw(e,t){switch(e.rank){case 1:return fu([e,t]);case 2:return gu([e,t],0);case 3:return xu([e,t],0);case 4:return bu([e,t],0);default:throw new ny(`concatAlongFirstAxis() received an unsupported tensor rank: ${e.rank}`)}}function rw(e,t){if(Array.isArray(t)||(t=[t]),e.rank!==t.length)throw new ny(`The length of input n (${t.length}) does not match the number of dimensions in input x (${e.rank})`);return fd(e,t)}function sw(e,t=0,n=1,a,r){return Xc(e,t,n,a,r)}function iw(e,t,n,a){if(e.rank<2||t.rank<2)throw new ay(`dot requires both inputs to be rank >= 2 but got x shape = ${e.shape} and y shape = ${t.shape}`);if(t.rank>=3&&e.shape.slice(-1)[0]!==t.shape.slice(-2)[0])throw new ay(`If rank y >= 3, then the second last dim of y must equal the last dim of x but got x shape = ${e.shape} and  y shape = ${t.shape}`);if(2===e.rank&&2===t.rank)return uh.matMul({a:e,b:t,transposeA:!1,transposeB:!1,bias:a?uw(e.rank,a,"channelsLast"):null,activation:n});{let r=e.shape.slice(),s=r.pop();e=ql(e,[-1,s]);let i=t.shape.slice(),o=i.pop(),l=i.pop(),u=[...i,o],d=Array.from({length:t.rank},(e,n)=>0===n?t.rank-2:n<=t.rank-2?n-1:n);t=ql(eh(t,d),[l,-1]);let c=[...r,...u];return ql(uh.matMul({a:e,b:t,transposeA:!1,transposeB:!1,bias:a?uw(e.rank,a,"channelsLast"):null,activation:n}),c)}}function ow(e,t,n){return to(()=>(t=Array.isArray(t)?Fp(t,"int32"):pl(t,"int32"),bd(e,t,n)))}function lw(e){return bl(e,e)}function uw(e,t,n){let a=t.shape;if(1!==t.rank&&t.rank!==e)throw new ny(`Unexpected bias dimensions: ${t.rank}; expected it to be 1 or ${e}`);if(5===e){if("channelsFirst"===n)return 1===a.length?ql(t,[1,a[0],1,1,1]):ql(t,[1,a[3],a[0],a[1],a[2]]);if("channelsLast"===n)return 1===a.length?ql(t,[1,1,1,1,a[0]]):ql(t,[1].concat(a))}else if(4===e){if("channelsFirst"===n)return 1===a.length?ql(t,[1,a[0],1,1]):ql(t,[1,a[2],a[0],a[1]]);if("channelsLast"===n)return 1===a.length?ql(t,[1,1,1,a[0]]):ql(t,[1].concat(a))}else if(3===e){if("channelsFirst"===n)return 1===a.length?ql(t,[1,a[0],1]):ql(t,[1,a[1],a[0]]);if("channelsLast"===n)return 1===a.length?ql(t,[1,1,a[0]]):ql(t,[1].concat(a))}else if(e<3)return t;throw new ny(`Unsupported input rank by biasAdd: ${t.rank}`)}function dw(e,t,n){return to(()=>(null==n&&(n="channelsLast"),My(n),fl(e,uw(e.rank,t,n))))}function cw(e,t,n,a){return to(()=>sh(e,t,n,a))}function pw(e,t,n=!1){return n?e():t()}var hw=["fanIn","fanOut","fanAvg"],mw=["normal","uniform","truncatedNormal"],fw=class extends vm.Serializable{fromConfigUsesCustomObjects(){return!1}getConfig(){return{}}},gw=class extends fw{apply(e,t){return ac(e,t)}};gw.className="Zeros",vm.registerClass(gw);var xw=class extends fw{apply(e,t){return rc(e,t)}};xw.className="Ones",vm.registerClass(xw);var bw=class extends fw{constructor(e){if(super(),"object"!=typeof e)throw new ny(`Expected argument of type ConstantConfig but got ${e}`);if(void 0===e.value)throw new ny(`config must have value set but got ${e}`);this.value=e.value}apply(e,t){return to(()=>bl(sd(this.value),rc(e,t)))}getConfig(){return{value:this.value}}};bw.className="Constant",vm.registerClass(bw);var yw=class extends fw{constructor(e){super(),this.DEFAULT_MINVAL=-.05,this.DEFAULT_MAXVAL=.05,this.minval=e.minval||this.DEFAULT_MINVAL,this.maxval=e.maxval||this.DEFAULT_MAXVAL,this.seed=e.seed}apply(e,t){return Zc(e,this.minval,this.maxval,t,this.seed)}getConfig(){return{minval:this.minval,maxval:this.maxval,seed:this.seed}}};yw.className="RandomUniform",vm.registerClass(yw);var ww=class extends fw{constructor(e){super(),this.DEFAULT_MEAN=0,this.DEFAULT_STDDEV=.05,this.mean=e.mean||this.DEFAULT_MEAN,this.stddev=e.stddev||this.DEFAULT_STDDEV,this.seed=e.seed}apply(e,t){if("float32"!==(t=t||"float32")&&"int32"!==t)throw new ay(`randomNormal does not support dType ${t}.`);return sw(e,this.mean,this.stddev,t,this.seed)}getConfig(){return{mean:this.mean,stddev:this.stddev,seed:this.seed}}};ww.className="RandomNormal",vm.registerClass(ww);var vw=class extends fw{constructor(e){super(),this.DEFAULT_MEAN=0,this.DEFAULT_STDDEV=.05,this.mean=e.mean||this.DEFAULT_MEAN,this.stddev=e.stddev||this.DEFAULT_STDDEV,this.seed=e.seed}apply(e,t){if("float32"!==(t=t||"float32")&&"int32"!==t)throw new ay(`truncatedNormal does not support dType ${t}.`);return Gp(e,this.mean,this.stddev,t,this.seed)}getConfig(){return{mean:this.mean,stddev:this.stddev,seed:this.seed}}};vw.className="TruncatedNormal",vm.registerClass(vw);var kw=class extends fw{constructor(e){super(),this.gain=null!=e.gain?e.gain:1}apply(e,t){return to(()=>{if(2!==e.length||e[0]!==e[1])throw new ny("Identity matrix initializer can only be used for 2D square matrices.");return bl(this.gain,gd(e[0]))})}getConfig(){return{gain:this.gain}}};kw.className="Identity",vm.registerClass(kw);var Nw=class extends fw{constructor(e){if(super(),e.scale<0)throw new ny(`scale must be a positive float. Got: ${e.scale}`);this.scale=null==e.scale?1:e.scale,this.mode=null==e.mode?"fanIn":e.mode,function(e){wy(hw,"FanMode",e)}(this.mode),this.distribution=null==e.distribution?"normal":e.distribution,function(e){wy(mw,"Distribution",e)}(this.distribution),this.seed=e.seed}apply(e,t){let n=function(e,t="channelsLast"){let n,a;if(My(t),2===e.length)n=e[0],a=e[1];else if(-1!==[3,4,5].indexOf(e.length)){if("channelsFirst"===t){let t=Hy(e,2);n=e[1]*t,a=e[0]*t}else if("channelsLast"===t){let t=Hy(e,0,e.length-2);n=e[e.length-2]*t,a=e[e.length-1]*t}}else{let t=Hy(e);n=Math.sqrt(t),a=Math.sqrt(t)}return[n,a]}(e),a=n[0],r=n[1],s=this.scale;if("fanIn"===this.mode?s/=Math.max(1,a):"fanOut"===this.mode?s/=Math.max(1,r):s/=Math.max(1,(a+r)/2),"normal"===this.distribution){let n=Math.sqrt(s);if("float32"!==(t=t||"float32")&&"int32"!==t)throw new ay(`${this.getClassName()} does not support dType ${t}.`);return Gp(e,0,n,t,this.seed)}{let n=Math.sqrt(3*s);return Zc(e,-n,n,t,this.seed)}}getConfig(){return{scale:this.scale,mode:this.mode,distribution:this.distribution,seed:this.seed}}};Nw.className="VarianceScaling",vm.registerClass(Nw);var Sw=class extends Nw{constructor(e){super({scale:1,mode:"fanAvg",distribution:"uniform",seed:null==e?null:e.seed})}getClassName(){return Nw.className}};Sw.className="GlorotUniform",vm.registerClass(Sw);var Iw=class extends Nw{constructor(e){super({scale:1,mode:"fanAvg",distribution:"normal",seed:null==e?null:e.seed})}getClassName(){return Nw.className}};Iw.className="GlorotNormal",vm.registerClass(Iw);var _w=class extends Nw{constructor(e){super({scale:2,mode:"fanIn",distribution:"normal",seed:null==e?null:e.seed})}getClassName(){return Nw.className}};_w.className="HeNormal",vm.registerClass(_w);var Cw=class extends Nw{constructor(e){super({scale:2,mode:"fanIn",distribution:"uniform",seed:null==e?null:e.seed})}getClassName(){return Nw.className}};Cw.className="HeUniform",vm.registerClass(Cw);var Tw=class extends Nw{constructor(e){super({scale:1,mode:"fanIn",distribution:"normal",seed:null==e?null:e.seed})}getClassName(){return Nw.className}};Tw.className="LeCunNormal",vm.registerClass(Tw);var Ew=class extends Nw{constructor(e){super({scale:1,mode:"fanIn",distribution:"uniform",seed:null==e?null:e.seed})}getClassName(){return Nw.className}};Ew.className="LeCunUniform",vm.registerClass(Ew);var Aw=class extends fw{constructor(e){super(),this.DEFAULT_GAIN=1,this.ELEMENTS_WARN_SLOW=2e3,this.gain=null==e.gain?this.DEFAULT_GAIN:e.gain,this.seed=e.seed}apply(e,t){return to(()=>{if(e.length<2)throw new ay("Shape must be at least 2D.");if("int32"!==t&&"float32"!==t&&void 0!==t)throw new TypeError(`Unsupported data type ${t}.`);let n=Ns.sizeFromShape(e.slice(0,-1)),a=e[e.length-1];this.ELEMENTS_WARN_SLOW;let r=sw([Math.max(a,n),Math.min(a,n)],0,1,t,this.seed),s=xm.qr(r,!1),i=s[0],o=s[1].flatten().stridedSlice([0],[Math.min(a,n)*Math.min(a,n)],[Math.min(a,n)+1]);return i=bl(i,o.sign()),n<a&&(i=i.transpose()),bl(sd(this.gain),i.reshape(e))})}getConfig(){return{gain:this.gain,seed:this.seed}}};Aw.className="Orthogonal",vm.registerClass(Aw);var $w={constant:"Constant",glorotNormal:"GlorotNormal",glorotUniform:"GlorotUniform",heNormal:"HeNormal",heUniform:"HeUniform",identity:"Identity",leCunNormal:"LeCunNormal",leCunUniform:"LeCunUniform",ones:"Ones",orthogonal:"Orthogonal",randomNormal:"RandomNormal",randomUniform:"RandomUniform",truncatedNormal:"TruncatedNormal",varianceScaling:"VarianceScaling",zeros:"Zeros"};function Rw(e,t={}){return gy(e,vm.SerializationMap.getMap().classNameMap,t,"initializer")}function Fw(e){return my(e)}function Dw(e){if("string"==typeof e){let t=e in $w?$w[e]:e;if("GlorotNormal"===t)return new Iw;if("GlorotUniform"===t)return new Sw;if("HeNormal"===t)return new _w;if("HeUniform"===t)return new Cw;if("LeCunNormal"===t)return new Tw;if("LeCunUniform"===t)return new Ew;{let e={};return e.className=t,e.config={},Rw(e)}}return e instanceof fw?e:Rw(e)}function Mw(e){return Array.isArray(e)&&Array.isArray(e[0])}function Ow(e){return 0===e.length?[]:Array.isArray(e[0])?e:[e]}function jw(e){let t;if(Array.isArray(e)){if(1!==e.length)throw new ny(`Expected Tensor length to be 1; got ${e.length}`);t=e[0]}else t=e;return t}function Lw(e){if(Array.isArray(e)&&Array.isArray(e[0])){if(1===e.length)return e[0];throw new ny(`Expected exactly 1 Shape; got ${e.length}`)}return e}function zw(e){let t=0;for(let n of e)0===n.shape.length?t+=1:t+=n.shape.reduce((e,t)=>e*t);return t}var Pw="Variable",Bw=class{constructor(e,t="float32",n=Pw,a=!0,r=null){this.dtype=null==t?"float32":t,this.shape=e.shape,this.id=_y(),n=null==n?Pw:n,this.originalName=Py(n),this.name=By(this.originalName),this.trainable_=a,this.constraint=r,this.val=Yp(e,this.trainable_,this.name,this.dtype)}read(){return this.assertNotDisposed(),this.val}write(e){return this.assertNotDisposed(),function(e,t){if(e.shape.toString()!==t.shape.toString())throw new Error("Shape mismatch: "+JSON.stringify(e.shape)+" vs. "+JSON.stringify(t.shape))}(this.val,e),this.val.id!==e.id&&(this.val.assign(e),null!=this.constraint&&this.val.assign(this.constraint.apply(this.val))),this}dispose(){this.assertNotDisposed(),this.val.dispose()}assertNotDisposed(){if(this.val.isDisposed)throw new Error(`LayersVariable ${this.name} is already disposed.`)}get trainable(){return this.trainable_}set trainable(e){this.trainable_=e,this.val.trainable=e}};function Ww(e){return e.map(e=>e.read())}function Vw(e){e.forEach(e=>{e[0].write(e[1])})}var Uw=class{constructor(e){this.dtype=e.dtype,this.shape=e.shape,null!=e.shape?this.ndim=e.shape.length:this.ndim=e.ndim,this.maxNDim=e.maxNDim,this.minNDim=e.minNDim,this.axes=e.axes||{}}},Gw=class{constructor(e,t,n,a,r,s,i){this.dtype=e,this.shape=t,this.sourceLayer=n,this.inputs=a,this.callArgs=r,this.outputTensorIndex=i,this.id=_y(),null!=s&&(this.originalName=Py(s),this.name=By(this.originalName)),this.rank=t.length}},Hw=0,qw=class{constructor(e,t){this.callArgs=t,this.id=Hw++,this.outboundLayer=e.outboundLayer,this.inboundLayers=e.inboundLayers,this.nodeIndices=e.nodeIndices,this.tensorIndices=e.tensorIndices,this.inputTensors=e.inputTensors,this.outputTensors=e.outputTensors,this.inputMasks=e.inputMasks,this.outputMasks=e.outputMasks,this.inputShapes=e.inputShapes,this.outputShapes=e.outputShapes;for(let n of e.inboundLayers)null!=n&&n.outboundNodes.push(this);e.outboundLayer.inboundNodes.push(this)}getConfig(){let e=[];for(let t of this.inboundLayers)null!=t?e.push(t.name):e.push(null);return{outboundLayer:this.outboundLayer?this.outboundLayer.name:null,inboundLayers:e,nodeIndices:this.nodeIndices,tensorIndices:this.tensorIndices}}},Kw=0,Xw=class extends vm.Serializable{constructor(e={}){super(),this._callHook=null,this._addedWeightNames=[],this._stateful=!1,this.id=Kw++,this.activityRegularizer=null,this.inputSpec=null,this.supportsMasking=!1,this._trainableWeights=[],this._nonTrainableWeights=[],this._losses=[],this._updates=[],this._built=!1,this.inboundNodes=[],this.outboundNodes=[];let t=e.name;if(!t){let e=this.getClassName();t=cy(e)+"_"+Ty(e)}if(this.name=t,this.trainable_=null==e.trainable||e.trainable,null!=e.inputShape||null!=e.batchInputShape){let t;if(null!=e.batchInputShape)t=e.batchInputShape;else if(null!=e.inputShape){let n=null;null!=e.batchSize&&(n=e.batchSize),t=[n].concat(e.inputShape)}this.batchInputShape=t;let n=e.dtype;null==n&&(n=e.inputDType),null==n&&(n="float32"),this.dtype=n}null!=e.weights?this.initialWeights=e.weights:this.initialWeights=null,this._refCount=null,this.fastWeightInitDuringBuild=!1}static nodeKey(e,t){return e.name+"_ib-"+t.toString()}getNodeAtIndex(e,t){if(0===this.inboundNodes.length)throw new ty(`The layer has never been called and thus has no defined ${t}.`);if(this.inboundNodes.length<=e)throw new ny(`Asked to get ${t} at node ${e}, but the layer has only ${this.inboundNodes.length} inbound nodes.`);return this.inboundNodes[e]}getInputAt(e){return uy(this.getNodeAtIndex(e,"input").inputTensors)}getOutputAt(e){return uy(this.getNodeAtIndex(e,"output").outputTensors)}get input(){if(this.inboundNodes.length>1)throw new ey(`Layer ${this.name} has multiple inbound nodes, hence the notion of "layer input" is ill-defined. Use \`getInputAt(nodeIndex)\` instead.`);if(0===this.inboundNodes.length)throw new ey(`Layer ${this.name} is not connected, no input to return.`);return uy(this.getNodeAtIndex(0,"input").inputTensors)}get output(){if(0===this.inboundNodes.length)throw new ey(`Layer ${this.name} has no inbound nodes.`);if(this.inboundNodes.length>1)throw new ey(`Layer ${this.name} has multiple inbound nodes, hence the notion of "layer output" is ill-defined. Use \`getOutputAt(nodeIndex)\` instead.`);return uy(this.getNodeAtIndex(0,"output").outputTensors)}get losses(){return this._losses}calculateLosses(){return this.losses.map(e=>e())}get updates(){return this._updates}get built(){return this._built}set built(e){this._built=e}get trainable(){return this.trainable_}set trainable(e){this._trainableWeights.forEach(t=>t.trainable=e),this.trainable_=e}get trainableWeights(){return this.trainable_?this._trainableWeights.filter(e=>e.trainable):[]}set trainableWeights(e){this._trainableWeights=e}get nonTrainableWeights(){return this.trainable?this._trainableWeights.filter(e=>!e.trainable).concat(this._nonTrainableWeights):this._trainableWeights.concat(this._nonTrainableWeights)}set nonTrainableWeights(e){this._nonTrainableWeights=e}get weights(){return this.trainableWeights.concat(this.nonTrainableWeights)}get stateful(){return this._stateful}resetStates(){if(!this.stateful)throw new Error("Cannot call the resetStates() method of a non-stateful Layer object.")}assertInputCompatibility(e){let t=dy(e);if(null==this.inputSpec||0===this.inputSpec.length)return;let n=dy(this.inputSpec);if(t.length!==n.length)throw new ny(`Layer ${this.name} expects ${n.length} inputs, but it received ${t.length} input tensors. Input received: ${e}`);for(let a=0;a<t.length;a++){let e=t[a],r=n[a];if(null==r)continue;let s=e.rank;if(null!=r.ndim&&s!==r.ndim)throw new ny(`Input ${a} is incompatible with layer ${this.name}: expected ndim=${r.ndim}, found ndim=${s}`);if(null!=r.maxNDim&&s>r.maxNDim)throw new ny(`Input ${a} is incompatible with layer ${this.name}: expected max_ndim=${r.maxNDim}, found ndim=${s}`);if(null!=r.minNDim&&s<r.minNDim)throw new ny(`Input ${a} is incompatible with layer ${this.name}: expected min_ndim=${r.minNDim}, found ndim=${s}.`);if(null!=r.dtype&&e.dtype!==r.dtype)throw new ny(`Input ${a} is incompatible with layer ${this.name} : expected dtype=${r.dtype}, found dtype=${e.dtype}.`);if(r.axes){let t=e.shape;for(let e in r.axes){let n=Number(e),s=r.axes[e],i=n>=0?t[n]:t[t.length+n];if(null!=s&&-1===[s,null].indexOf(i))throw new ny(`Input ${a} is incompatible with layer ${this.name}: expected axis ${n} of input shape to have value ${s} but got shape ${t}.`)}}if(null!=r.shape)for(let t=0;t<r.shape.length;++t){let n=r.shape[t],s=e.shape[t];if(null!=n&&null!=s&&n!==s)throw new ny(`Input ${a} is incompatible with layer ${this.name}: expected shape=${r.shape}, found shape=${e.shape}.`)}}}call(e,t){return e}invokeCallHook(e,t){null!=this._callHook&&this._callHook(e,t)}setCallHook(e){this._callHook=e}clearCallHook(){this._callHook=null}apply(e,t){t=t||{},this.assertNotDisposed();let n=dy(e),a=function(e){let t=!0;for(let n of dy(e))if(!(n instanceof Gw)){t=!1;break}return t}(e),r=function(e){let t=!0;for(let n of dy(e))if(n instanceof Gw){t=!1;break}return t}(e);if(a===r)throw new ny("Arguments to apply() must be all SymbolicTensors or all Tensors");return zy(this.name,()=>{if(!this.built){this.assertInputCompatibility(e);let t=[];for(let n of dy(e))t.push(n.shape);this.build(uy(t)),this.built=!0,this.initialWeights&&this.setWeights(this.initialWeights),null===this._refCount&&r&&(this._refCount=1)}if(this.assertInputCompatibility(e),r){let a=this.call(e,t);this.supportsMasking&&this.setMaskMetadata(e,a);let r=dy(a),s=[];for(let e of r)-1!==n.indexOf(e)&&(e=e.clone()),s.push(e);if(a=uy(s),null!=this.activityRegularizer)throw new ay("Layer invocation in the presence of activity regularizer(s) is not supported yet.");return a}{let n,a=function(e){e=dy(e);let t=[];for(let n of e)t.push(n.shape);return uy(t)}(e),r=this.computeOutputShape(a),s="float32";if(this.warnOnIncompatibleInputShape(Array.isArray(e)?a[0]:a),n=null!=r&&r.length>0&&Array.isArray(r[0])?r.map((n,a)=>new Gw(s,n,this,dy(e),t,this.name,a)):new Gw(s,r,this,dy(e),t,this.name),this.addInboundNode(e,n,null,null,a,r,t),this._refCount++,null!=this.activityRegularizer)throw new ay("Layer invocation in the presence of activity regularizer(s) is not supported yet.");return n}})}warnOnIncompatibleInputShape(e){if(null!=this.batchInputShape)if(e.length!==this.batchInputShape.length);else{let t=!1;this.batchInputShape.forEach((n,a)=>{null!=n&&null!=e[a]&&e[a]!==n&&(t=!0)})}}get outputShape(){if(null==this.inboundNodes||0===this.inboundNodes.length)throw new ey(`The layer ${this.name} has never been called and thus has no defined output shape.`);let e=[];for(let t of this.inboundNodes){let n=JSON.stringify(t.outputShapes);-1===e.indexOf(n)&&e.push(n)}if(1===e.length){let e=this.inboundNodes[0].outputShapes;return Array.isArray(e)&&Array.isArray(e[0])&&1===e.length?e[0]:e}throw new ey(`The layer ${this.name} has multiple inbound nodes with different output shapes. Hence the notion of "output shape" is ill-defined for the layer.`)}countParams(){if(!this.built)throw new ty(`You tried to call countParams() on ${this.name}, but the layer is not built yet. Build it first by calling build(batchInputShape).`);return zw(this.weights)}build(e){this.built=!0}getWeights(e=!1){return Ww(e?this.trainableWeights:this.weights)}setWeights(e){to(()=>{let t=this.weights;if(t.length!==e.length)throw new ny(`You called setWeights(weights) on layer "${this.name}" with a weight list of length ${e.length}, but the layer was expecting ${t.length} weights. Provided weights: ${e}...`);if(0===t.length)return;let n=[],a=Ww(t);for(let r=0;r<a.length;++r){let s=a[r],i=t[r],o=e[r];if(!Ns.arraysEqual(s.shape,o.shape))throw new ny(`Layer weight shape ${s.shape} not compatible with provided weight shape ${o.shape}`);n.push([i,o])}Vw(n)})}addWeight(e,t,n,a,r,s,i,o){if(-1!==this._addedWeightNames.indexOf(e))throw new ny(`Duplicate weight name ${e} for layer ${this.name}`);this._addedWeightNames.push(e),null==n&&(n="float32"),this.fastWeightInitDuringBuild&&(a=null!=o?o():Dw("zeros"));let l=a.apply(t,n),u=new Bw(l,n,e,s,i);return l.dispose(),null!=r&&this.addLoss(()=>r.apply(u.read())),null==s&&(s=!0),s?this._trainableWeights.push(u):this._nonTrainableWeights.push(u),u}setFastWeightInitDuringBuild(e){this.fastWeightInitDuringBuild=e}addLoss(e){null==e||Array.isArray(e)&&0===e.length||(e=dy(e),void 0!==this._losses&&null!==this._losses&&this.losses.push(...e))}computeOutputShape(e){return e}computeMask(e,t){if(!this.supportsMasking){if(null!=t){if(!Array.isArray(t))throw new TypeError(`Layer ${this.name} does not support masking, but was passed an inputMask.`);t.forEach(e=>{if(null!=e)throw new TypeError(`Layer ${this.name} does not support masking, but was passed an inputMask.`)})}return null}return t}setMaskMetadata(e,t,n){if(!this.supportsMasking)return;let a=this.computeMask(e,n),r=dy(t),s=dy(a);if(r.length!==s.length)throw new Error(`${this.name} outputs ${r.length} tensors but ${r.length} masks for those tensors`);for(let i=0;i<r.length;i++)r[i].kerasMask=s[i]}addInboundNode(e,t,n,a,r,s,i=null){let o=dy(e);t=dy(t),n=dy(n),a=dy(a),r=Ow(r),s=Ow(s);let l=[],u=[],d=[];for(let c of o)l.push(c.sourceLayer),u.push(c.nodeIndex),d.push(c.tensorIndex);new qw({outboundLayer:this,inboundLayers:l,nodeIndices:u,tensorIndices:d,inputTensors:o,outputTensors:t,inputMasks:n,outputMasks:a,inputShapes:r,outputShapes:s},i);for(let c=0;c<t.length;c++)t[c].sourceLayer=this,t[c].nodeIndex=this.inboundNodes.length-1,t[c].tensorIndex=c}getConfig(){let e={name:this.name,trainable:this.trainable};return null!=this.batchInputShape&&(e.batchInputShape=this.batchInputShape),null!=this.dtype&&(e.dtype=this.dtype),e}disposeWeights(){return this.weights.forEach(e=>e.dispose()),this.weights.length}assertNotDisposed(){if(0===this._refCount)throw new Error(`Layer '${this.name}' is already disposed.`)}dispose(){if(!this.built)throw new Error(`Cannot dispose Layer ${this.name} because it has not been built yet.`);if(null===this._refCount)throw new Error(`Cannot dispose Layer ${this.name} because it has not been used yet.`);this.assertNotDisposed();let e=0;return 0===--this._refCount&&(e=this.disposeWeights()),{refCountAfterDispose:this._refCount,numDisposedVariables:e}}};function Yw(e,t,n){if((null==t||null!=n&&n>0)&&(t=e.sourceLayer,n=e.nodeIndex),0===t.inboundNodes.length)return[e];{let e=t.inboundNodes[n];if(0===e.inboundLayers.length)return e.inputTensors;{let t=[];for(let n=0;n<e.inboundLayers.length;n++){let a=Yw(e.inputTensors[n],e.inboundLayers[n],e.nodeIndices[n]);for(let e of a)-1===t.indexOf(e)&&t.push(e)}return t}}}var Zw=class extends Xw{constructor(e){if(super({dtype:e.dtype,name:null!=e.name?e.name:Ty("input").toString()}),null==e.batchSize&&(e.batchSize=null),null==e.sparse&&(e.sparse=!1),this.trainable=!1,this.built=!0,this.sparse=e.sparse,null!=e.inputShape&&null!=e.batchInputShape)throw new ny("Only provide the inputShape OR batchInputShape argument to inputLayer, not both at the same time.");let t=e.batchInputShape;if(null==t){if(null==e.inputShape)throw new ny("An InputLayer should be passed either a `batchInputShape` or an `inputShape`.");t=[e.batchSize].concat(e.inputShape)}else if(null!=e.batchSize)throw new ny("Cannot specify batchSize if batchInputShape is specified when creating an InputLayer.");let n=e.dtype||"float32";this.batchInputShape=t,this.dtype=n,this.inputSpec=[{shape:t}];let a=new Gw(this.dtype,this.batchInputShape,this,[],{},this.name);a.nodeIndex=0,a.tensorIndex=0,new qw({outboundLayer:this,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:[a],outputTensors:[a],inputMasks:[null],outputMasks:[null],inputShapes:[t],outputShapes:[t]})}apply(e,t){throw new ny(`Cannot pass any input to an InputLayer's apply() method. InputLayer name: ${this.name}`)}dispose(){return{refCountAfterDispose:this._refCount,numDisposedVariables:0}}getConfig(){return{batchInputShape:this.batchInputShape,dtype:this.dtype,sparse:this.sparse,name:this.name}}};function Jw(e){if(null==e.batchShape&&null==e.shape)throw new Error("Please provide to Input either a `shape` or a `batchShape` argument. Note that `shape` does not include the batch dimension.");if(null!=e.batchShape&&null!=e.shape)throw new ny("Please provide either a `shape` or `batchShape` argument to Input, but not both.");let t=e.batchShape;null!=e.shape&&null==t&&(t=[null].concat(e.shape));let n=e.dtype;return null==n&&(n="float32"),new Zw({batchInputShape:t,name:e.name,dtype:n,sparse:e.sparse}).inboundNodes[0].outputTensors[0]}Zw.className="InputLayer",vm.registerClass(Zw);var Qw=class e{constructor(t){if(this.id2Value={},this.id2Mask={},this.name2Id={},t instanceof e)for(let e in t.id2Value)this.id2Value[e]=t.id2Value[e],e in t.id2Mask&&(this.id2Mask[e]=t.id2Mask[e]);else{if(null==t)return;for(let e of t)this.add(e.key,e.value)}}add(e,t,n){if(null!=this.id2Value[e.id])throw new ny(`Duplicate key: name=${e.name}, id=${e.id}`);return this.id2Value[e.id]=function(e,n){if(null==e.dtype||e.dtype===n.dtype)return n;try{return pl(n,e.dtype)}catch(t){throw new ny(`The dtype of the feed (${n.dtype}) can not be cast to the dtype of the key '${e.name}' (${e.dtype}).`)}}(e,t),this.name2Id[e.name]=e.id,null!=n&&(this.id2Mask[e.id]=n),this}addFeed(e){this.add(e.key,e.value)}hasKey(e){return null!=this.id2Value[e.id]}names(){return Object.keys(this.name2Id)}getValue(e){if(e instanceof Gw){if(null==this.id2Value[e.id])throw new ny(`Nonexistent key: ${e.name}`);return this.id2Value[e.id]}{let t=this.name2Id[e];if(null==t)throw new ny(`Feed dict has no SymbolicTensor name: ${e}`);return this.id2Value[t]}}getMask(e){if(e instanceof Gw){if(null==this.id2Value[e.id])throw new ny(`Nonexistent key: ${e.name}`);return this.id2Mask[e.id]}{let t=this.name2Id[e];if(null==t)throw new ny(`Feed dict has no SymbolicTensor name: ${e}`);return this.id2Mask[t]}}disposeMasks(){null!=this.id2Mask&&no(this.id2Mask)}},ev=new sy,tv=new sy;function nv(e,t,n,a){let r=null!=n&&n.training,s=Array.isArray(e),i=s?e:[e],o=i.map(e=>e.name),l=[],u=t.names();for(let m of o)-1!==u.indexOf(m)?l.push(t.getValue(m)):l.push(null);let d,c=o.join(",")+"|"+t.names().sort().join(","),p=ev.get(c);if(null==p){let e=function(e,t){Ns.assert(null!=e&&e.length>0,()=>"Expected at least one fetch, got none");let n=[],a={};if(1===e.length){let r=rv(e[0],t);n=r.sorted,a=r.recipientMap}else{let r=new Set;for(let s of e){let{sorted:e,recipientMap:i}=rv(s,t);for(let t of e)r.has(t.name)||(n.push(t),r.add(t.name));for(let t in i)null==a[t]&&(a[t]=new Set),i[t].forEach(e=>a[t].add(e))}}return{sorted:n,recipientCounts:av(a)}}(i,t);p=e.sorted,d=e.recipientCounts,ev.put(c,p),tv.put(c,d)}d={},r||Object.assign(d,tv.get(c));let h=new Qw(t);for(let m=0;m<p.length;++m){let e=p[m],a=e.sourceLayer;if(a instanceof Zw)continue;let s=[],i=[],u=[],c=!1;for(let n of e.inputs){let e=h.getValue(n),a=h.getMask(n);s.push(e),i.push(a),null!=a&&(c=!0),r||(d[n.name]--,0===d[n.name]&&!t.hasKey(n)&&-1===o.indexOf(n.name)&&!e.isDisposed&&!0!==n.sourceLayer.stateful&&u.push(e))}c&&((n=n||{}).mask=i[0]);let f=dy(a.apply(s,n)),g=null;a.supportsMasking&&(g=a.computeMask(s,i));let x=sv(e),b=Array.isArray(x)?x:[x];for(let t=0;t<b.length;++t){h.hasKey(b[t])||h.add(b[t],f[t],Array.isArray(g)?g[0]:g);let e=o.indexOf(b[t].name);-1!==e&&(l[e]=f[t])}r||no(u)}return h.disposeMasks(),s?l:l[0]}function av(e){let t={};for(let n in e)t[n]=e[n].size;return t}function rv(e,t){let n=new Set,a=[],r={};for(let o of t.names())n.add(o);let s=[],i=[];for(s.push(e);s.length>0;){let e=s[s.length-1];if(n.has(e.name)){s.pop();continue}let t=i[i.length-1]===s.length-1;if(0===e.inputs.length||t)s.pop(),a.push(e),n.add(e.name),t&&i.pop();else{i.push(s.length-1);for(let t of e.inputs)null==r[t.name]&&(r[t.name]=new Set),r[t.name].add(e.name),!n.has(t.name)&&s.push(t)}}return{sorted:a,recipientMap:r}}function sv(e){let t;if(1===e.sourceLayer.inboundNodes.length)t=e.sourceLayer.output;else{let n=null;for(let t=0;t<e.sourceLayer.inboundNodes.length;++t)for(let a of e.sourceLayer.inboundNodes[t].outputTensors)if(a.id===e.id){n=t;break}t=e.sourceLayer.getOutputAt(n)}return t}Pt().registerFlag("TOPOLOGICAL_SORT_CACHE_MAX_ENTRIES",()=>100,function(e){null!=ev&&ev.setMaxEntries(e),null!=tv&&tv.setMaxEntries(e)});var iv={};function ov(e,t){return to(()=>id(ld(bl(e,e),t,!0)))}xe(iv,{maxNorm:()=>xv,minMaxNorm:()=>wv,nonNeg:()=>yv,unitNorm:()=>bv});var lv=class extends vm.Serializable{getConfig(){return{}}},uv=class extends lv{constructor(e){super(),this.defaultMaxValue=2,this.defaultAxis=0,this.maxValue=null!=e.maxValue?e.maxValue:this.defaultMaxValue,this.axis=null!=e.axis?e.axis:this.defaultAxis}apply(e){return to(()=>{let t=ov(e,this.axis),n=mu(t,0,this.maxValue);return bl(e,xl(n,fl(Yy(),t)))})}getConfig(){return{maxValue:this.maxValue,axis:this.axis}}};uv.className="MaxNorm",vm.registerClass(uv);var dv=class extends lv{constructor(e){super(),this.defaultAxis=0,this.axis=null!=e.axis?e.axis:this.defaultAxis}apply(e){return to(()=>xl(e,fl(Yy(),ov(e,this.axis))))}getConfig(){return{axis:this.axis}}};dv.className="UnitNorm",vm.registerClass(dv);var cv=class extends lv{apply(e){return np(e)}};cv.className="NonNeg",vm.registerClass(cv);var pv=class extends lv{constructor(e){super(),this.defaultMinValue=0,this.defaultMaxValue=1,this.defaultRate=1,this.defaultAxis=0,this.minValue=null!=e.minValue?e.minValue:this.defaultMinValue,this.maxValue=null!=e.maxValue?e.maxValue:this.defaultMaxValue,this.rate=null!=e.rate?e.rate:this.defaultRate,this.axis=null!=e.axis?e.axis:this.defaultAxis}apply(e){return to(()=>{let t=ov(e,this.axis),n=fl(bl(this.rate,mu(t,this.minValue,this.maxValue)),bl(1-this.rate,t));return bl(e,xl(n,fl(Yy(),t)))})}getConfig(){return{minValue:this.minValue,maxValue:this.maxValue,rate:this.rate,axis:this.axis}}};pv.className="MinMaxNorm",vm.registerClass(pv);var hv={maxNorm:"MaxNorm",minMaxNorm:"MinMaxNorm",nonNeg:"NonNeg",unitNorm:"UnitNorm"};function mv(e){return my(e)}function fv(e,t={}){return gy(e,vm.SerializationMap.getMap().classNameMap,t,"constraint")}function gv(e){return null==e?null:"string"==typeof e?fv({className:e in hv?hv[e]:e,config:{}}):e instanceof lv?e:fv(e)}function xv(e){return new uv(e)}function bv(e){return new dv(e)}function yv(){return new cv}function wv(e){return new pv(e)}var vv={};function kv(){return new gw}function Nv(){return new xw}function Sv(e){return new bw(e)}function Iv(e){return new yw(e)}function _v(e){return new ww(e)}function Cv(e){return new vw(e)}function Tv(e){return new kw(e)}function Ev(e){return new Nw(e)}function Av(e){return new Sw(e)}function $v(e){return new Iw(e)}function Rv(e){return new _w(e)}function Fv(e){return new Cw(e)}function Dv(e){return new Tw(e)}function Mv(e){return new Ew(e)}function Ov(e){return new Aw(e)}xe(vv,{constant:()=>Sv,glorotNormal:()=>$v,glorotUniform:()=>Av,heNormal:()=>Rv,heUniform:()=>Fv,identity:()=>Tv,leCunNormal:()=>Dv,leCunUniform:()=>Mv,ones:()=>Nv,orthogonal:()=>Ov,randomNormal:()=>_v,randomUniform:()=>Iv,truncatedNormal:()=>Cv,varianceScaling:()=>Ev,zeros:()=>kv});var jv,Lv={};async function zv(e){if(null==e)return;let t=[],n=[],a=[];for(let r in e){let s=e[r];if("number"!=typeof s){let e=s;t.push(e.data()),n.push(r),a.push(e)}}if(t.length>0){let r=await Promise.all(t);for(let t=0;t<r.length;++t)e[n[t]]=r[t][0];no(a)}}function Pv(e){if(null!=e)for(let t in e){let n=e[t];"number"!=typeof n&&n.dispose()}}xe(Lv,{Layer:()=>Xw,RNN:()=>ZN,RNNCell:()=>JN,activation:()=>EI,add:()=>LI,alphaDropout:()=>T_,average:()=>zI,averagePooling1d:()=>KI,averagePooling2d:()=>ZI,averagePooling3d:()=>e_,avgPool1d:()=>XI,avgPool2d:()=>JI,avgPool3d:()=>t_,avgPooling1d:()=>YI,avgPooling2d:()=>QI,avgPooling3d:()=>n_,batchNormalization:()=>GI,bidirectional:()=>w_,categoryEncoding:()=>F_,centerCrop:()=>$_,concatenate:()=>PI,conv1d:()=>wI,conv2d:()=>vI,conv2dTranspose:()=>kI,conv3d:()=>NI,conv3dTranspose:()=>SI,convLstm2d:()=>g_,convLstm2dCell:()=>x_,cropping2D:()=>_I,dense:()=>AI,depthwiseConv2d:()=>TI,dot:()=>UI,dropout:()=>$I,elu:()=>mI,embedding:()=>jI,flatten:()=>FI,gaussianDropout:()=>C_,gaussianNoise:()=>__,globalAveragePooling1d:()=>a_,globalAveragePooling2d:()=>r_,globalMaxPool1d:()=>k_,globalMaxPool2d:()=>N_,globalMaxPooling1d:()=>s_,globalMaxPooling2d:()=>i_,gru:()=>d_,gruCell:()=>c_,input:()=>Yk,inputLayer:()=>hI,layerNormalization:()=>HI,leakyReLU:()=>gI,lstm:()=>p_,lstmCell:()=>h_,masking:()=>E_,maxPool1d:()=>S_,maxPool2d:()=>I_,maxPooling1d:()=>o_,maxPooling2d:()=>l_,maxPooling3d:()=>u_,maximum:()=>BI,minimum:()=>WI,multiply:()=>VI,permute:()=>OI,prelu:()=>xI,randomWidth:()=>D_,reLU:()=>fI,repeatVector:()=>DI,rescaling:()=>A_,reshape:()=>MI,resizing:()=>R_,rnn:()=>b_,separableConv2d:()=>II,simpleRNN:()=>m_,simpleRNNCell:()=>f_,softmax:()=>bI,spatialDropout1d:()=>RI,stackedRNNCells:()=>y_,thresholdedReLU:()=>yI,timeDistributed:()=>v_,upSampling2d:()=>CI,zeroPadding2d:()=>qI}),function(e){e[e.SILENT=0]="SILENT",e[e.VERBOSE=1]="VERBOSE"}(jv||(jv={}));var Bv=class{constructor(){this.validationData=null}setParams(e){this.params=e}async onEpochBegin(e,t){}async onEpochEnd(e,t){}async onBatchBegin(e,t){}async onBatchEnd(e,t){}async onTrainBegin(e){}async onTrainEnd(e){}setModel(e){}},Wv=class{constructor(e,t=10){null==e&&(e=[]),this.callbacks=e,this.queueLength=t}append(e){this.callbacks.push(e)}setParams(e){for(let t of this.callbacks)t.setParams(e)}setModel(e){for(let t of this.callbacks)t.setModel(e)}async onEpochBegin(e,t){null==t&&(t={});for(let n of this.callbacks)await n.onEpochBegin(e,t)}async onEpochEnd(e,t){null==t&&(t={});for(let n of this.callbacks)await n.onEpochEnd(e,t)}async onBatchBegin(e,t){null==t&&(t={});for(let n of this.callbacks)await n.onBatchBegin(e,t)}async onBatchEnd(e,t){null==t&&(t={});for(let n of this.callbacks)await n.onBatchEnd(e,t)}async onTrainBegin(e){null==e&&(e={});for(let t of this.callbacks)await t.onTrainBegin(e)}async onTrainEnd(e){null==e&&(e={});for(let t of this.callbacks)await t.onTrainEnd(e)}},Vv=class extends Bv{constructor(){super()}async onEpochBegin(e){this.seen=0,this.totals={}}async onBatchEnd(e,t){null==t&&(t={});let n=null==t.size?0:t.size;this.seen+=n;for(let a in t){let e=t[a];if("number"==typeof e)this.totals.hasOwnProperty(a)||(this.totals[a]=0),this.totals[a]=this.totals[a]+e*n;else{let t;a in this.totals?t=this.totals[a]:this.totals[a]=0;let r=to(()=>fl(this.totals[a],bl(e,n)));this.totals[a]=r,null!=t&&t.dispose()}}}async onEpochEnd(e,t){if(null!=t)for(let n of this.params.metrics)null!=this.totals[n]&&("number"==typeof this.totals[n]?t[n]=this.totals[n]/this.seen:to(()=>{let e=bl(xl(1,this.seen),this.totals[n]);t[n]=e,this.totals[n].dispose(),ao(t[n])}))}},Uv=class extends Bv{async onTrainBegin(e){this.epoch=[],this.history={}}async onEpochEnd(e,t){null==t&&(t={}),this.epoch.push(e);for(let n in t)null==this.history[n]&&(this.history[n]=[]),this.history[n].push(t[n])}async syncData(){let e=[],t=[],n=[];for(let r in this.history){let a=this.history[r];for(let s=0;s<a.length;++s)if("number"!=typeof a[s]){let i=a[s];e.push(i.data()),t.push(r),n.push(s)}}let a=await Promise.all(e);for(let r=0;r<a.length;++r)this.history[t[r]][n[r]].dispose(),this.history[t[r]][n[r]]=a[r][0]}},Gv=class extends Bv{constructor(e,t){if(super(),this.currentEpoch=0,this.nowFunc=e.nowFunc,this.nextFrameFunc=e.nextFrameFunc||Wf,this.yieldEvery=t||"auto","auto"===this.yieldEvery&&(this.yieldEvery=125),"never"===this.yieldEvery&&null!=e.onYield)throw new Error("yieldEvery is `never` but you provided an `onYield` callback. Either change `yieldEvery` or remove the callback");Ns.isNumber(this.yieldEvery)&&(this.maybeWait=function(e,t,n){let a,r=null!=n?n():Ns.now();return(...s)=>{let i=null!=n?n():Ns.now();return i-r<t||(r=i,a=e(...s)),a}}(this.maybeWait.bind(this),this.yieldEvery,this.nowFunc)),this.trainBegin=e.onTrainBegin,this.trainEnd=e.onTrainEnd,this.epochBegin=e.onEpochBegin,this.epochEnd=e.onEpochEnd,this.batchBegin=e.onBatchBegin,this.batchEnd=e.onBatchEnd,this.yield=e.onYield}async maybeWait(e,t,n){let a=[];null!=this.yield&&(await zv(n),a.push(this.yield(e,t,n))),a.push(this.nextFrameFunc()),await Promise.all(a)}async onEpochBegin(e,t){this.currentEpoch=e,null!=this.epochBegin&&(await zv(t),await this.epochBegin(e,t))}async onEpochEnd(e,t){let n=[];null!=this.epochEnd&&(await zv(t),n.push(this.epochEnd(e,t))),"epoch"===this.yieldEvery&&n.push(this.nextFrameFunc()),await Promise.all(n)}async onBatchBegin(e,t){null!=this.batchBegin&&(await zv(t),await this.batchBegin(e,t))}async onBatchEnd(e,t){let n=[];null!=this.batchEnd&&(await zv(t),n.push(this.batchEnd(e,t))),"batch"===this.yieldEvery?n.push(this.nextFrameFunc()):Ns.isNumber(this.yieldEvery)&&n.push(this.maybeWait(this.currentEpoch,e,t)),await Promise.all(n)}async onTrainBegin(e){null!=this.trainBegin&&(await zv(e),await this.trainBegin(e))}async onTrainEnd(e){null!=this.trainEnd&&(await zv(e),await this.trainEnd(e))}};function Hv(e,t){return null==e&&(e={}),e instanceof Bv?[e]:Array.isArray(e)&&e[0]instanceof Bv?e:dy(e).map(e=>new Gv(e,t))}var qv=class e{constructor(){}static registerCallbackConstructor(t,n){Ns.assert(t>=0&&Number.isInteger(t),()=>`Verbosity level is expected to be an integer >= 0, but got ${t}`),e.checkForDuplicate(n),null==e.constructors[t]&&(e.constructors[t]=[]),e.constructors[t].push(n)}static checkForDuplicate(t){for(let n in e.constructors)e.constructors[+n].forEach(e=>{if(e===t)throw new ny("Duplicate callback constructor.")})}static clear(){e.constructors={}}static createCallbacks(t){let n=[];for(let a in e.constructors){let r=+a;t>=r&&n.push(...e.constructors[r])}return n.map(e=>new e)}};function Kv(e,t,n,a,r,s,i,o,l){let u=new Uv,d=[new Vv,...qv.createCallbacks(t)];null!=e&&d.push(...e),d.push(u);let c=new Wv(d);return c.setParams({epochs:n,initialEpoch:a,samples:r,steps:s,batchSize:i,verbose:t,doValidation:o,metrics:l}),{callbackList:c,history:u}}function Xv(e,t={},n=!1){return gy(e,vm.SerializationMap.getMap().classNameMap,t,"layer",n)}function Yv(e,t){return to(()=>{"float32"!==e.dtype&&(e=pl(e,"float32"));let n=ld(lw(e),t,!0),a=hu(n.shape,Yy()),r=id(tc(n,a));return xl(e,r)})}function Zv(e,t){return to(()=>nc(lw(Wd(t,e)),-1))}function Jv(e,t){return to(()=>nc(yl(Wd(t,e)),-1))}function Qv(e,t){return to(()=>{let n=Wd(e,t),a=mu(yl(e),Yy(),Number.MAX_VALUE),r=yl(xl(n,a));return bl(100,nc(r,-1))})}function ek(e,t,n=!1){return to(()=>{if(n)t=vp(t);else{let e=ld(t,t.shape.length-1,!0);t=xl(t,e)}return t=mu(t,Yy(),1-Yy()),zd(ld(bl(pl(e,"float32"),Ad(t)),t.shape.length-1))})}function tk(e,t,n=!1){return to(()=>{let a=pl(xd(function(e){let t=[Hy(e.shape)];return ql(e,t)}(e)),"int32"),r=(t=mu(t,Yy(),1-Yy())).shape;return ek(ql(hc(a,r[r.length-1]),r),t,n)})}function nk(e,t){return to(()=>{let n;return n=mu(t,Yy(),1-Yy()),n=Ad(xl(n,Wd(1,n))),nc(function(e,t){if(!Ns.arraysEqual(e.shape,t.shape))throw new ny(`logits and labels must have the same shape, but got shapes ${JSON.stringify(e.shape)} and ${JSON.stringify(t.shape)}`);return to(()=>{let n=np(t),a=zd(yl(t));return fl(Wd(n,bl(t,e)),$d(pd(a)))})}(e,n),-1)})}function ak(e,t){return to(()=>{let n=Yv(e,-1),a=Yv(t,-1),r=bl(n,a);return zd(ld(r,-1))})}qv.constructors={};var rk={meanSquaredError:Zv,meanAbsoluteError:Jv,meanAbsolutePercentageError:Qv,meanSquaredLogarithmicError:function(e,t){return to(()=>{let n=mu(t,Yy(),Number.MAX_VALUE),a=Ad(fl(1,n)),r=mu(e,Yy(),Number.MAX_VALUE),s=Ad(fl(1,r));return nc(lw(Wd(a,s)),-1)})},squaredHinge:function(e,t){return to(()=>{let n=tc(0,Wd(1,bl(e,t)));return nc(lw(n),-1)})},hinge:function(e,t){return to(()=>{let n=tc(0,Wd(1,bl(e,t)));return nc(n,-1)})},categoricalHinge:function(e,t){return to(()=>{let n=ld(bl(e,t),-1),a=nd(bl(Wd(1,e),t),-1);return tc(0,fl(1,Wd(a,n)))})},logcosh:function(e,t){return to(()=>{let n=Math.log(2),a=Wd(t,e),r=Wd(fl(a,Pd(bl(-2,a))),n);return nc(r,-1)})},categoricalCrossentropy:ek,sparseCategoricalCrossentropy:tk,binaryCrossentropy:nk,kullbackLeiblerDivergence:function(e,t){return to(()=>{let n=mu(e,Yy(),1),a=mu(t,Yy(),1);return ld(bl(e,Ad(xl(n,a))),-1)})},poisson:function(e,t){return to(()=>{let n=Ad(fl(Yy(),t));return nc(Wd(t,bl(e,n)),-1)})},cosineProximity:ak};function sk(e){if("string"==typeof e){if(e in rk)return rk[e];let t=`Unknown loss ${e}`;throw e.toLowerCase().includes("softmaxcrossentropy")&&(t=`Unknown loss ${e}. Use "categoricalCrossentropy" as the string name for tf.losses.softmaxCrossEntropy`),new ny(t)}return e}function ik(e,t){return to(()=>{let n=bl(.5,mc(t)),a=Zy(yd(t,n),e.dtype);return nc(zu(e,a),-1)})}function ok(e,t){return to(()=>Zy(zu(Il(e,-1),Il(t,-1)),"float32"))}function lk(e,t){return to(()=>pl(ld(Gd(zu(e,1),zu(t,1))),"float32"))}function uk(e,t){return to(()=>{let n=lk(e,t),a=function(e,t){return to(()=>pl(ld(Gd(zu(e,0),zu(t,1))),"float32"))}(e,t),r=fl(n,a);return pl(Pu(yd(r,0),xl(n,r),0),"float32")})}function dk(e,t){return nk(e,t)}function ck(e,t){return e.rank===t.rank&&(e=Tp(e,[e.rank-1])),(t=Il(t,-1)).dtype!==e.dtype&&(t=pl(t,e.dtype)),pl(zu(e,t),"float32")}var pk=ek,hk=tk,mk={binaryAccuracy:ik,categoricalAccuracy:ok,precision:uk,categoricalCrossentropy:pk,sparseCategoricalCrossentropy:hk,mse:Zv,MSE:Zv,mae:Jv,MAE:Jv,mape:Qv,MAPE:Qv,cosine:ak};function fk(e){if("string"==typeof e&&e in mk)return mk[e];if("string"!=typeof e&&null!=e)return e;throw new ny(`Unknown metric ${e}`)}function gk(e){if(oy(null!==e,`Unknown LossOrMetricFn ${e}`),"string"==typeof e)return e;{let t;for(let n of Object.keys(rk))if(rk[n]===e){t=n;break}if(void 0!==t)return t;for(let n of Object.keys(mk))if(mk[n]===e){t=n;break}return void 0!==t?t:e.name}}function xk(e,t,n=!1){if(null==e||"object"!=typeof e||Object.getPrototypeOf(e)!==Object.prototype||!bk(e))throw new Error("User-defined metadata is expected to be a JSON object, but is not.");n&&JSON.stringify(e).length}function bk(e){if(null===e)return!0;if("object"==typeof e){if(Object.getPrototypeOf(e)===Object.prototype){let t=Object.keys(e);for(let n of t)if("string"!=typeof n||!bk(e[n]))return!1;return!0}if(Array.isArray(e)){for(let t of e)if(!bk(t))return!1;return!0}return!1}{let t=typeof e;return"string"===t||"number"===t||"boolean"===t}}function yk(e,t,n=console.log){let a="";for(let r=0;r<e.length;++r)r>0&&(a=a.slice(0,a.length-1)+" "),a+=e[r],a=a.slice(0,t[r]),a+=" ".repeat(t[r]-a.length);n(a)}function wk(e,t,n){let a,r;try{r=e.inboundNodes.map(e=>JSON.stringify(e.inputShapes)).join(",")}catch(s){r="multiple"}try{a=JSON.stringify(e.outputShape)}catch(s){a="multiple"}yk([`${e.name} (${e.getClassName()})`,r,a,e.countParams().toString()],t,n)}function vk(e,t,n,a){let r,s;try{s=e.inboundNodes.map(e=>JSON.stringify(e.inputShapes)).join(",")}catch(d){s="multiple"}try{r=JSON.stringify(e.outputShape)}catch(d){r="multiple"}let i=[];for(let c of e.inboundNodes)if(!(null!=n&&n.length>0&&-1===n.indexOf(c)))for(let e=0;e<c.inboundLayers.length;++e){let t=c.inboundLayers[e].name,n=c.nodeIndices[e],a=c.tensorIndices[e];i.push(`${t}[${n}][${a}]`)}let o=e.name,l=e.getClassName(),u=0===i.length?"":i[0];yk([`${o} (${l})`,s,r,e.countParams().toString(),u],t,a);for(let c=1;c<i.length;++c)yk(["","","","",i[c]],t,a)}function kk(e,t,n){return("inboundNodes"===e||"outputLayers"===e||"inputLayers"===e)&&0===t&&"string"==typeof n}function Nk(e,t){if(null===e)return null;if("string"==typeof e)return py(e);if("number"==typeof e||"boolean"==typeof e)return e;if(e instanceof Array){let n=[],a=e.length;for(let r=0;r<a;++r){let a=e[r];kk(t,r,a)?n.push(a):n.push(Nk(a,t))}return n}{let t={};for(let n of Object.keys(e)){let a=e[n];if("name"===n&&"string"==typeof a)t[n]=a;else{let e=py(n);t[e]=Nk(a,e)}}return t}}function Sk(e,t){if(null==e)return null;if("string"==typeof e)return cy(e);if("number"==typeof e||"boolean"==typeof e)return e;if(e instanceof Array){let n=[],a=e.length;for(let r=0;r<a;++r){let a=e[r];kk(t,r,a)?n.push(a):n.push(Sk(a,t))}return n}{let t={};for(let n of Object.keys(e)){let a=e[n];t[cy(n)]="name"!==n&&"className"!==n||"string"!=typeof a?Sk(a,n):a}return t}}var Ik="4.22.0",_k=class e extends Xw{constructor(t){if(super({}),this.containerNodes=new Set,this.name=t.name,null==this.name){let e=this.getClassName().toLowerCase();this.name=Ty(e)}if(this.supportsMasking=!1,this.trainable_=!0,Array.isArray(t.inputs)?this.inputs=t.inputs.slice():this.inputs=[t.inputs],Array.isArray(t.outputs)?this.outputs=t.outputs.slice():this.outputs=[t.outputs],by(this.inputs).length!==this.inputs.length)throw new ny(`The list of inputs passed to the model is redundant. All inputs should only appear once. Found: ${this.inputs.map(e=>e.name)}`);by(this.outputs).length,this.outputs.length,this.inputLayers=[],this.inputLayersNodeIndices=[],this.inputLayersTensorIndices=[],this.outputLayers=[],this.outputLayersNodeIndices=[],this.outputLayersTensorIndices=[],this.layers=[],this.internalContainerRefs=[];for(let e of this.outputs){let t=e.sourceLayer,n=e.nodeIndex,a=e.tensorIndex;this.outputLayers.push(t),this.outputLayersNodeIndices.push(n),this.outputLayersTensorIndices.push(a)}for(let e of this.inputs){let t=e.sourceLayer,n=e.nodeIndex,a=e.tensorIndex;oy(0===n,"input layer has >1 nodes"),oy(0===a,"input layer has >1 tensors"),this.inputLayers.push(t),this.inputLayersNodeIndices.push(n),this.inputLayersTensorIndices.push(a)}this.inputNames=[],this.outputNames=[],this.feedInputShapes=[],this.feedInputNames=[],this.feedOutputNames=[];for(let e=0;e<this.inputLayers.length;e++){let n=this.inputLayers[e];if(!(n instanceof Zw))throw new TypeError(`Input layers to a LayersModel must be InputLayer objects. Received inputs: ${t.inputs}. Input ${e} (0-based) originates from layer type ${n.getClassName()}.`);this.inputNames.push(n.name),this.feedInputShapes.push(n.batchInputShape),this.feedInputNames.push(n.name)}for(let e of this.outputLayers)this.outputNames.push(e.name);this.internalInputShapes=this.inputs.map(e=>e.shape),this.internalOutputShapes=this.outputs.map(e=>e.shape);let n={},a={},r={},s={},i={},o=[],l=(t,n,a,r,s,u)=>{(null==r||null==s||null==u)&&(r=t.sourceLayer,s=t.nodeIndex,u=t.tensorIndex);let d=r.inboundNodes[s];if(-1!==a.indexOf(d))throw new ty(`The tensor ${t.name} at layer "${r.name}" is part of a cycle.`);if(-1!==n.indexOf(d))return;this.containerNodes.add(e.nodeKey(r,s)),r.id in i||(i[r.id]=Object.keys(i).length),-1===a.indexOf(d)&&a.push(d);let c=d.inboundLayers.length;for(let e=0;e<c;e++){let t=d.inputTensors[e],r=d.inboundLayers[e],s=d.nodeIndices[e],i=d.tensorIndices[e];l(t,n,a,r,s,i)}for(n.push(d);a.indexOf(d)>=0;)a.splice(a.indexOf(d),1);o.push(d)},u=[],d=[];for(let e of this.outputs)l(e,u,d);let c=o.slice().reverse();for(let e of c){a[e.id]=e,e.id in n||(n[e.id]=0);let t=n[e.id],i=null==r[e.outboundLayer.id]?0:r[e.outboundLayer.id];t=Math.max(t,i),r[e.outboundLayer.id]=t,s[e.outboundLayer.id]=e.outboundLayer,n[e.id]=t;for(let r=0;r<e.inboundLayers.length;r++){let s=e.inboundLayers[r],i=e.nodeIndices[r],o=s.inboundNodes[i],l=null==n[o.id]?0:n[o.id];n[o.id]=Math.max(t+1,l),a[o.id]=o}}let p={};for(let e in n){let t=n[e];t in p||(p[t]=[]),p[t].push(a[e])}let h={};for(let e in r){let t=r[e];t in h||(h[t]=[]),h[t].push(s[e])}let m=Object.keys(h).map(e=>parseInt(e,10)).sort(xy);this.layers=[];for(let b of m){let t=h[b];t.sort((e,t)=>{let n=i[e.id],a=i[t.id];return n<a?-1:n>a?1:0});for(let n of t)n instanceof e&&this.internalContainerRefs.push(n),this.layers.push(n)}this.layersByDepth=h,m=Object.keys(p).map(e=>parseInt(e,10)).sort(xy);let f=this.inputs.slice(),g=[];for(let e of m)for(let t of p[e]){let e=t.outboundLayer;if(null!=e){for(let n of t.inputTensors)if(-1===f.indexOf(n))throw new ty(`Graph disconnected: cannot obtain value for tensor ${n} at layer "${e.name}". The following previous layers were accessed without issue: ${g}`);for(let e of t.outputTensors)f.push(e);g.push(e.name)}}this.nodesByDepth=p;let x=this.layers.map(e=>e.name);for(let e of x){let t=x.filter(t=>t===e).length;if(1!==t)throw new ty(`The name "${e}" is used ${t} times in the model. All layer names should be unique. Layer names: `+JSON.stringify(x))}this.outboundNodes=[],this.inboundNodes=[],new qw({outboundLayer:this,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:this.inputs,outputTensors:this.outputs,inputMasks:this.inputs.map(e=>null),outputMasks:this.outputs.map(e=>null),inputShapes:this.inputs.map(e=>e.shape),outputShapes:this.outputs.map(e=>e.shape)}),this.built=!0,this._refCount=1}assertNotDisposed(){if(0===this._refCount)throw new Error(`Container '${this.name}' is already disposed.`)}dispose(){this.assertNotDisposed();let e={refCountAfterDispose:null,numDisposedVariables:0};if(0===--this._refCount){for(let t of this.layers)e.numDisposedVariables+=t.dispose().numDisposedVariables;for(let t of this.internalContainerRefs)e.numDisposedVariables+=t.dispose().numDisposedVariables}return e.refCountAfterDispose=this._refCount,e}get trainable(){return this.trainable_}set trainable(e){this.layers.forEach(t=>{t._trainableWeights.forEach(t=>t.trainable=e)}),this.trainable_=e}get trainableWeights(){if(this._trainableWeights.length>0)throw new ny("Container instance unexpectedly contains _trainableWeights.The trainable weights of a Container are a union of the trainable weights of its consituent Layers. Its own _trainableWeights must remain an empty Array.");if(!this.trainable)return[];let e=[];for(let t of this.layers)e=e.concat(t.trainableWeights);return e}get nonTrainableWeights(){let e=[];for(let t of this.layers)e.push(...t.nonTrainableWeights);if(!this.trainable){let t=[];for(let e of this.layers)t.push(...e.trainableWeights);return t.concat(e)}return e}get weights(){return this.trainableWeights.concat(this.nonTrainableWeights)}loadWeights(e,t=!0){let n={},a=0,r=(e=>{let t=Object.keys(e);if(0===t.length)return!1;let n=t[0].split("/");return!isNaN(parseInt(n[n.length-1],10))})(e);r&&this.parseWeights(e);for(let i of this.layers)for(let[e,t]of i.weights.entries()){let s=r?`${t.name.split("/").slice(0,-1).join("/")+"/"}${e}`:t.originalName;if(null!=n[s])throw new ny(`Duplicate weight name: ${s}`);n[s]=t,a++}let s=[];for(let i in e){let a=i;if(null==n[i]){let e=i.split("/");a=e.slice(0,-2).concat([e[e.length-1]]).join("/")}if(null!=n[a])s.push([n[a],e[i]]);else if(t)throw new ny(`Provided weight data has no target variable: ${i}`);delete n[a]}if(t){let e=[];for(let t in n)e.push(t);if(e.length>0)throw new ny(`${e.length} of ${a} weights are not set: ${e}`)}Vw(s)}parseWeights(e){for(let t in Object.keys(e)){let n=t.split("/"),a=["vars","layer_checkpoint_dependencies"],r=n.map(e=>e.startsWith("_")?e.slice(1):e).filter(e=>!a.includes(e)).join("/");r!==t&&(e[r]=e[t],delete e[t])}}updatedConfig(){let e=this.getConfig(),t={};return t.className=this.getClassName(),t.config=e,t.kerasVersion=`tfjs-layers ${Ik}`,t.backend="TensorFlow.js",t}toJSON(e,t=!0){let n=Sk(this.updatedConfig());return t?JSON.stringify(n):n}call(e,t){return to(()=>{e=dy(e);let n=new Qw;for(let t=0;t<this.inputs.length;++t)n.add(this.inputs[t],e[t]);return nv(this.outputs,n,t)})}computeMask(e,t){return to(()=>{let n;return e=dy(e),n=null==t?iy(null,e.length):dy(t),this.runInternalGraph(e,n)[1]})}computeOutputShape(e){let t=Ow(e);if(t.length!==this.inputLayers.length)throw new ny(`Invalid inputShape argument ${e}: model has ${this.inputLayers.length} tensor inputs.`);let n={};for(let i=0;i<t.length;i++){let e=this.inputLayers[i],a=t[i];n[e.name+"_0_0"]=a}let a=Object.keys(this.nodesByDepth).map(e=>parseInt(e,10)).sort(xy);if(a.length>1)for(let i of a){let e=this.nodesByDepth[i];for(let t of e){let e=t.outboundLayer;if(-1!==this.inputLayers.map(e=>e.id).indexOf(e.id))continue;let a=[];for(let i=0;i<t.inboundLayers.length;i++){let e=t.inboundLayers[i],r=t.nodeIndices[i],s=t.tensorIndices[i],o=n[`${e.name}_${r}_${s}`];a.push(o)}let r=Ow(e.computeOutputShape(uy(a))),s=e.inboundNodes.indexOf(t);for(let t=0;t<r.length;t++)n[`${e.name}_${s}_${t}`]=r[t]}}let r=[],s=[];for(let i=0;i<this.outputLayers.length;i++){let e=this.outputLayers[i],t=this.outputLayersNodeIndices[i],n=this.outputLayersTensorIndices[i],a=`${e.name}_${t}_${n}`;s.push(a)}for(let i=0;i<s.length;i++){let e=s[i];oy(e in n),r.push(n[e])}return uy(r)}runInternalGraph(e,t){null==t&&(t=iy(null,e.length));let n={};for(let o=0;o<this.inputs.length;++o){let a=this.inputs[o],r=e[o],s=t[o];n[a.id]=[r,s]}let a=Object.keys(this.nodesByDepth).map(e=>parseInt(e,10)).sort(xy);for(let o of a){let e=this.nodesByDepth[o];for(let t of e){let e=t.outboundLayer,a=t.inputTensors,r=t.outputTensors,s=new Array;for(let t of a)t.id in n&&s.push(n[t.id]);if(s.length===a.length){let a,i,o,l,u={};if(null!=t.callArgs&&(u=t.callArgs),1===s.length){let[t,n]=s[0];null==u.mask&&(u.mask=n),o=dy(e.call(t,u)),l=dy(e.computeMask(t,n)),a=[t],i=[n]}else a=s.map(e=>e[0]),i=s.map(e=>e[1]),null==u.mask&&(u.mask=i),o=dy(e.call(a,u)),l=dy(e.computeMask(a,i));if(e.activityRegularizer)throw new ay("LayersModel invocation with concrete Tensor value(s) in the presence of activity regularizer(s) is not supported yet.");for(let e=0;e<r.length;++e){let t=r[e],a=o[e],s=l[e];n[t.id]=[a,s]}}}}let r=[],s=[],i=[];for(let o of this.outputs){oy(o.id in n,`Could not compute output ${o.name} : ${o.id}`);let[e,t]=n[o.id];i.push(e.shape),r.push(e),s.push(t)}return[r,s,i]}buildNodeConversionMap(t){let n,a={};for(let r of this.layers){n=r instanceof e?1:0;for(let t=0;t<r.inboundNodes.length;t++){let s=e.nodeKey(r,t);this.containerNodes.has(s)&&(a[s]=n,n+=1)}}return a}getLayer(e,t){if(null!=t)return this.findLayer(t);if(null==e)throw new ny("Provide either a layer name or layer index");if("number"==typeof e)return this.findLayer(e);for(let n of this.layers)if(n.name===e)return n;throw new ny(`No such layer: ${e}`)}findLayer(e){if(this.layers.length<=e)throw new ny(`Was asked to retrieve layer at index ${e}, but model only has ${this.layers.length} layer(s).`);return this.layers[e]}calculateLosses(){return to(()=>{let t=[];for(let n of this.layers)for(let a=0;a<n.inboundNodes.length;++a){let r=e.nodeKey(n,a);this.containerNodes.has(r)&&t.push(...n.calculateLosses())}return t})}getConfig(){let t={name:this.name},n=this.buildNodeConversionMap(this.layers),a=[];for(let o of this.layers){let t=o.getClassName(),r=o.getConfig(),s=[];for(let a=0;a<o.inboundNodes.length;a++){let t=o.inboundNodes[a],r=e.nodeKey(o,a),l={};if(this.containerNodes.has(r)){if(t.callArgs)try{JSON.stringify(t.callArgs),l=t.callArgs}catch(i){l={}}if(t.inboundLayers.length>0){let a=[];for(let r=0;r<t.inboundLayers.length;r++){let s=t.inboundLayers[r],i=t.nodeIndices[r],o=t.tensorIndices[r],u=n[e.nodeKey(s,i)];null==u&&(u=0),a.push([s.name,u,o,l])}s.push(a)}}}let l={};l.name=o.name,l.className=t,l.config=r,l.inboundNodes=s,a.push(l)}t.layers=a;let r=[];for(let o=0;o<this.inputLayers.length;o++){let t=this.inputLayers[o],a=this.inputLayersNodeIndices[o],s=e.nodeKey(t,a);if(!this.containerNodes.has(s))continue;let i=n[s];null==i&&(i=0);let l=this.inputLayersTensorIndices[o];r.push([t.name,i,l])}t.inputLayers=r;let s=[];for(let o=0;o<this.outputLayers.length;o++){let t=this.outputLayers[o],a=this.outputLayersNodeIndices[o],r=e.nodeKey(t,a);if(!this.containerNodes.has(r))continue;let i=n[r];null==i&&(i=0);let l=this.outputLayersTensorIndices[o];s.push([t.name,i,l])}return t.outputLayers=s,t}static fromConfig(e,t,n={},a=!1){let r={},s={};function i(e,t){e.name in s?s[e.name].push(t):s[e.name]=[t]}function o(e,t){let n,a=[];for(let s of t){let o=s[0],l=s[1],u=s[2];if(n=null==s[3]?{}:s[3],!(o in r))return void i(e,t);let d=r[o];if(d.inboundNodes.length<=l)return void i(e,t);let c=d.inboundNodes[l];a.push(c.outputTensors[u])}a.length>0&&e.apply(uy(a),n)}function l(e){let n=e.name,s=Xv(e,null!=t.customObjects?t.customObjects:{});s.setFastWeightInitDuringBuild(a),r[n]=s,e.inboundNodes.forEach(e=>{if(!(e instanceof Array))throw new ny(`Corrupted configuration, expected array for nodeData: ${e}`);i(s,e)})}let u=t.name,d=t.layers;for(let f of d)l(f);for(;!yy(s);)for(let e of d){let t=r[e.name];if(t.name in s){let e=s[t.name];delete s[t.name];for(let n of e)o(t,n)}}let c=[],p=[],h=t.inputLayers;for(let f of h){let e=f[0],t=f[1],n=f[2];oy(e in r);let a=r[e].inboundNodes[t].outputTensors;c.push(a[n])}let m=t.outputLayers;for(let f of m){let e=f[0],t=f[1],n=f[2];oy(e in r);let a=r[e].inboundNodes[t].outputTensors;p.push(a[n])}return new e({inputs:c,outputs:p,name:u})}get stateful(){if(this._stateful)throw new ny("Container instance unexpectedly has _stateful = true. The statefulness of a Container is determined by the Layers it contains. Its _stateful property must remain the default false.");for(let e of this.layers)if(e.stateful)return!0;return!1}resetStates(){to(()=>{this.layers.forEach(e=>{e.stateful&&e.resetStates()})})}};function Ck(e,t){return function(e,t,n){let a=t.length;if(null==e||Array.isArray(e)&&0===e.length)return t.map(e=>null);if(1===a)return Array.isArray(e)&&1===e.length?e:"object"==typeof e&&t[0]in e?[e[t[0]]]:[e];if(Array.isArray(e)){if(e.length!==a)throw new Error(`Provided ${n} is an array of ${e.length} element(s), but the model has ${a} outputs. Make sure a set of weights is provided for each model output.`);return e}if("object"==typeof e&&Object.keys(e).length>0&&"object"==typeof e[Object.keys(e)[0]]){let n=[];return t.forEach(t=>{t in e?n.push(e[t]):n.push(null)}),n}throw new Error(`The model has multiple (${a}) outputs, so ${n} must be either an array with ${a} elements or an object with ${t} keys. Provided ${n} not understood: ${JSON.stringify(e)}`)}(e,t,"classWeight")}async function Tk(e,t,n,a){if(null!=n){let t=to(()=>{if(1===e.shape.length)return hl(e);if(2===e.shape.length){if(e.shape[1]>1)return Il(e,1);if(1===e.shape[1])return ql(e,[e.shape[0]]);throw new Error(`Encountered unexpected last-dimension size (${e.shape[1]}) during handling of class weights. The size is expected to be >= 1.`)}throw new Error(`Unexpected rank of target (y) tensor (${e.rank}) during handling of class weights. The rank is expected to be 1 or 2.`)}),a=Array.from(await t.data());no(t);let r=[];return a.forEach(e=>{if(null==n[e])throw new Error(`classWeight must contain all classes in the training data. The class ${e} exists in the data but not in classWeight`);r.push(n[e])}),Fp(r,"float32")}return null}function Ek(e,t){return bl(e,t)}function Ak(e,t){let n,a,r=t;n=r.xs,a=r.ys,Ns.assert(null!=n&&null!=a,()=>`A Dataset iterator for fitDataset() is expected to generate objects of the form \`{xs: xVal, ys: yVal}\`, where the two values may be \`tf.Tensor\`, an array of Tensors, or a map of string to Tensor.  The provided Dataset instead generates ${t}`);let s=$k("input",e.inputNames,n),i=$k("output",e.outputNames,a),o=s[0].shape[0];Ns.assert(s.length===e.inputs.length,()=>`LayersModel has ${e.inputs.length} inputs, but the dataset provides ${s.length} inputs.  (Expected input keys: ${JSON.stringify(e.inputNames)})`),Ns.assert(i.length===e.outputs.length,()=>`LayersModel has ${e.outputs.length} outputs, but the dataset provides ${i.length} outputs.  (Expected output keys: ${JSON.stringify(e.outputNames)})`);for(let l=0;l<s.length;l++)Ns.assert(s[l].shape[0]===o,()=>`Batch size mismatch: input ${e.inputNames[l]} has ${s[l].shape[0]}; expected  ${o} based on input ${e.inputNames[0]}.`);for(let l=0;l<i.length;l++)Ns.assert(i[l].shape[0]===o,()=>`Batch size mismatch: output ${e.outputNames[l]} has ${i[l].shape[0]}; expected  ${o} based on input ${e.inputNames[0]}.`);return{xs:s,ys:i}}function $k(e,t,n){if(n instanceof ri)return[n];if(Array.isArray(n))return Ns.assert(n.length===t.length,()=>`Received an array of ${n.length} Tensors, but expected ${t.length} to match the ${e} keys ${t}.`),n;{let a=[];for(let r of t){if(null==n[r])throw new ny(`The feature data generated by the dataset lacks the required ${e} key '${r}'.`);a.push(n[r])}return a}}function Rk(e){return"function"==typeof e.iterator}function Fk(e){Ns.assert(e>0&&Number.isInteger(e),()=>`batchSize is required to be a positive integer, but got ${e}`)}function Dk(e,t,n){return null==e?[null]:Array.isArray(e)?e.map(e=>Qy(e,t,n-t)):Qy(e,t,n-t)}function Mk(e,t){return to(()=>null==e?null:Array.isArray(e)?e.map(e=>Mk(e,t)):ow(e,"int32"===t.dtype?t:pl(t,"int32")))}function Ok(e,t){let n=[],a=0,r=null;for(;a<e;)r=a+t,r>=e&&(r=e),n.push([a,r]),a=r;return n}function jk(e){let t=[];e instanceof ri&&(e=[e]);for(let n=0;n<e.length;++n){let a=e[n];if(1===a.rank)t.push(Jy(a,1));else{if(0===a.rank)throw new Error("Expected tensor to be at least 1D, but received a 0D tensor (scalar).");t.push(a)}}return t}function Lk(e,t){if(null==e)return;let n=[];if(t instanceof ri)n.push(t.id);else if(Array.isArray(t))t.forEach(e=>n.push(e.id));else if(null!=t)for(let r in t){let e=t[r];n.push(e.id)}let a=[];if(e instanceof ri)-1===n.indexOf(e.id)&&a.push(e);else if(Array.isArray(e))e.forEach(e=>{-1===n.indexOf(e.id)&&a.push(e)});else if(null!=e)for(let r in e){let t=e[r];-1===n.indexOf(t.id)&&a.push(t)}a.forEach(e=>{e.isDisposed||e.dispose()})}function zk(e){return Array.isArray(e)}function Pk(e){return!function(e){return e instanceof ri}(e)&&!zk(e)}function Bk(e,t,n,a=!0,r=""){if(null==t||0===t.length){if(null!=e){let t=!1;if(zk(e)&&e.length>0)t=!0;else if(Pk(e)){for(let n in e)if(e.hasOwnProperty(n)){t=!0;break}}else t=!0;if(t)throw new ny(`Error when checking model ${r} expected no data, but got ${e}`)}return[]}if(null==e)return t.map(e=>null);let s;if(Pk(e)){s=[];for(let n of t){if(null==e[n])throw new ny(`No data provided for "${n}". Need data for each key in: ${t}`);s.push(e[n])}}else if(zk(e)){if(e.length!==t.length)throw new ny(`Error when checking model ${r}: the Array of Tensors that you are passing to your model is not the size the model expected. Expected to see ${t.length} Tensor(s), but instead got the following list of Tensor(s): ${e}`);s=e}else{if(t.length>1)throw new ny(`The model ${r} expects ${t.length} Tensor(s), but only received one Tensor. Found: Tensor with shape ${e.shape}`);s=[e]}if(s=jk(s),null!=n)for(let i=0;i<t.length;++i){if(null==n[i])continue;let e=s[i];if(e.shape.length!==n[i].length)throw new ny(`Error when checking ${r}: expected ${t[i]} to have ${n[i].length} dimension(s). but got array with shape ${e.shape}`);for(let t=0;t<n[i].length;++t){if(0===t&&!a)continue;let s=e.shape[t],o=n[i][t];if(null!=o&&o>=0&&s!==o)throw new ny(`${r} expected a batch of elements where each example has shape [${n[i].slice(1,n[i].length)}] (i.e.,tensor shape [*,${n[i].slice(1,n[i].length)}]) but the ${r} received an input with ${e.shape[0]} examples, each with shape [${e.shape.slice(1,e.shape.length)}] (tensor shape [${e.shape}])`)}}return s}function Wk(e,t,n,a=!0,r=""){let s;if(Array.isArray(e)){if(e.length!==t.length)throw new ny(`Error when checking model ${r}: the Array of Tensors that you are passing to your model is not the size the the model expected. Expected to see ${t.length} Tensor(s), but instead got ${e.length} Tensors(s).`);s=e}else{if(t.length>1)throw new ny(`The model expects ${t.length} ${r} Tensors, but only received one Tensor. Found: array with shape ${JSON.stringify(e.shape)}.`);s=[e]}if(null!=n)for(let i=0;i<t.length;++i){if(null==n[i])continue;let e=s[i];if(e.shape.length!==n[i].length)throw new ny(`Error when checking ${r}: expected ${t[i]} to have ${n[i].length} dimension(s), but got array with shape ${JSON.stringify(e.shape)}`);for(let s=0;s<n[i].length;++s){if(0===s&&!a)continue;let o=e.shape[s],l=n[i][s];if(null!=l&&l!==o)throw new ny(`Error when checking ${r}: expected ${t[i]} to have shape ${JSON.stringify(n[i])} but got array with shape ${JSON.stringify(e.shape)}.`)}}}var Vk=class extends _k{constructor(e){super(e),this.isTraining=!1}summary(e,t,n=console.log){if(!this.built)throw new ny("This model has never been called, thus its weights have not been created yet. So no summary can be displayed. Build the model first (e.g., by calling it on some test data).");!function(e,t,n,a=console.log){let r,s=function(e){let t=!0,n=[],a=[];for(let r in e.nodesByDepth)n.push(e.nodesByDepth[r]);for(let r of n){if(r.length>1||1===r.length&&r[0].inboundLayers.length>1){t=!1;break}a.push(...r)}if(t)for(let r of e.layers){let e=!1;for(let n of r.inboundNodes)if(-1!==a.indexOf(n)){if(e){t=!1;break}e=!0}if(!t)break}return t}(e),i=["Layer (type)","Input Shape","Output shape","Param #"];if(s?(t=t||90,n=n||[.32,.61,.89,1]):(t=t||115,n=n||[.24,.48,.7,.8,1]),n[n.length-1]<=1&&(n=n.map(e=>Math.floor(t*e))),!s){i.push("Receives inputs"),r=[];for(let t in e.nodesByDepth)r.push(...e.nodesByDepth[t])}a("_".repeat(t)),yk(i,n,a),a("=".repeat(t));let o=e.layers;for(let d=0;d<o.length;++d)s?wk(o[d],n,a):vk(o[d],n,r,a),a((d===o.length-1?"=":"_").repeat(t));e.checkTrainableWeightsConsistency();let l=function(e){let t;return t=null!=e.collectedTrainableWeights?zw(e.collectedTrainableWeights):zw(e.trainableWeights),t}(e),u=zw(e.nonTrainableWeights);a(`Total params: ${l+u}`),a(`Trainable params: ${l}`),a(`Non-trainable params: ${u}`),a("_".repeat(t))}(this,e,t,n)}compile(e){if(null==e.loss&&(e.loss=[]),this.loss=e.loss,"string"==typeof e.optimizer)this.optimizer_=function(e){let t={Adagrad:()=>Pf.adagrad(.01),Adadelta:()=>Pf.adadelta(1,.95,Yy()),Adam:()=>Pf.adam(.001,.9,.999,Yy()),Adamax:()=>Pf.adamax(.002,.9,.999,Yy(),0),RMSProp:()=>Pf.rmsprop(.001,.9,0,Yy()),SGD:()=>Pf.sgd(.01)};if(t.adagrad=t.Adagrad,t.adadelta=t.Adadelta,t.adam=t.Adam,t.adamax=t.Adamax,t.rmsprop=t.RMSProp,t.sgd=t.SGD,e in t)return t[e]();throw new ny(`Unknown Optimizer ${e}`)}(e.optimizer),this.isOptimizerOwned=!0;else{if(!(e.optimizer instanceof Tm))throw new ny("User-defined optimizer must be an instance of tf.Optimizer.");this.optimizer_=e.optimizer,this.isOptimizerOwned=!1}let t=[];if(Array.isArray(e.loss)||"string"==typeof e.loss||"function"==typeof e.loss)if(Array.isArray(e.loss)){if(e.loss.length!==this.outputs.length)throw new ny(`When passing an Array as loss, it should have one entry per model output. The model has ${this.outputs.length} output(s), but you passed loss=${e.loss}.`);t=e.loss.map(e=>sk(e))}else{let n=sk(e.loss);this.outputs.forEach(e=>{t.push(n)})}else{e.loss=e.loss;for(let t in e.loss)if(-1===this.outputNames.indexOf(t))throw new ny(`Unknown entry in loss dictionary: "${t}". Only expected the following keys: ${this.outputNames}`);for(let n of this.outputNames)e.loss[n],t.push(sk(e.loss[n]))}this.lossFunctions=t,this.feedOutputNames=[],this.feedOutputShapes=[],this.feedLossFns=[];for(let s=0;s<this.outputs.length;++s){let e=this.internalOutputShapes[s],t=this.outputNames[s];this.feedOutputNames.push(t),this.feedOutputShapes.push(e),this.feedLossFns.push(this.lossFunctions[s])}let n=[];this.metrics=e.metrics,this.metricsNames=["loss"],this.metricsTensors=[],zy("loss",()=>{for(let e=0;e<this.outputs.length;++e){if(-1!==n.indexOf(e))continue;let t=this.lossFunctions[e];this.outputs.length>1&&(this.metricsTensors.push([t,e]),this.metricsNames.push(this.outputNames[e]+"_loss"))}});let a=function(e,t){if(null==e||Array.isArray(e)&&0===e.length)return t.map(e=>[]);let n;if("string"==typeof e||"function"==typeof e)n=[e];else{if(!Array.isArray(e)&&"object"!=typeof e)throw new TypeError(`Type of metrics argument not understood. Expected an string,function, Array, or Object, found: ${e}`);n=e}if(Array.isArray(n))return t.map(e=>n);{let e=[];for(let a of t){let t=n.hasOwnProperty(a)?n[a]:[];Array.isArray(t)||(t=[t]),e.push(t)}return e}}(e.metrics,this.outputNames),r=(e,t,n)=>{this.outputNames.length>1&&(t=this.outputNames[e]+"_"+t),this.metricsNames.push(t),this.metricsTensors.push([n,e])};zy("metric",()=>{for(let e=0;e<this.outputs.length;++e)-1===n.indexOf(e)&&(t=>{let n,a,s;for(let i of t){if("string"==typeof i&&-1!==["accuracy","acc","crossentropy","ce"].indexOf(i)){let t,r=this.internalOutputShapes[e];1===r[r.length-1]||this.lossFunctions[e]===nk?-1!==["accuracy","acc"].indexOf(i)?a=ik:-1!==["crossentropy","ce"].indexOf(i)&&(a=dk):this.lossFunctions[e]===tk?-1!==["accuracy","acc"].indexOf(i)?a=ck:-1!==["crossentropy","ce"].indexOf(i)&&(a=hk):-1!==["accuracy","acc"].indexOf(i)?a=ok:-1!==["crossentropy","ce"].indexOf(i)&&(a=pk),-1!==["accuracy","acc"].indexOf(i)?t="acc":-1!==["crossentropy","ce"].indexOf(i)&&(t="ce"),s=a,n=""+t}else s=fk(i),n=""+gk(i);let t;zy(n,()=>{t=s}),r(e,n,t)}})(a[e])}),this.collectedTrainableWeights=this.trainableWeights}checkTrainableWeightsConsistency(){null!=this.collectedTrainableWeights&&(this.trainableWeights.length,this.collectedTrainableWeights.length)}evaluate(e,t,n={}){let a=null==n.batchSize?32:n.batchSize;Fk(a);let r=this.standardizeUserDataXY(e,t,!0,a);try{let e=r[0].concat(r[1]);this.makeTestFunction();let t=this.testFunction;return uy(this.testLoop(t,e,a,n.verbose,n.steps))}finally{Lk(r[0],e),Lk(r[1],t)}}async evaluateDataset(e,t){return this.makeTestFunction(),async function(e,t,n){let a=null!=(n=n||{}).batches,r=e.testFunction,s=[];if(n.verbose>0)throw new ay("Verbose mode is not implemented yet.");Ns.assert(!a||n.batches>0&&Number.isInteger(n.batches),()=>`Test loop expects \`batches\` to be a positive integer, but received ${JSON.stringify(n.batches)}`);let i=function(e){return"function"==typeof e.next}(t)?t:await t.iterator(),o=0,l=0;for(;!a||l<n.batches;){let t=await i.next();if(s=to(()=>{if(t.value){let{xs:n,ys:a}=Ak(e,t.value),i=n.concat(a),u=to(()=>r(i));if(no(i),0===l)for(let e=0;e<u.length;++e)s.push(sd(0));let d=i[0].shape[0];for(let e=0;e<u.length;++e){let t=u[e],n=s[e];s[e]=to(()=>fl(s[e],bl(d,t))),l>0&&no(n)}no(u),o+=d,++l}return s}),t.done)break}for(let u=0;u<s.length;++u){let e=s[u];s[u]=xl(s[u],o),no(e)}return uy(s)}(this,e,t)}checkNumSamples(e,t,n,a="steps"){let r;if(null!=n){if(r=null,null!=t)throw new ny(`If ${a} is set, batchSize must be null or undefined.Got batchSize = ${t}`)}else{if(null==e)throw new ny(`Either the input data should have a defined shape, or ${a} shoud be specified.`);r=Array.isArray(e)?e[0].shape[0]:e.shape[0]}return r}execute(e,t){if(Array.isArray(t)&&0===t.length)throw new ny("`outputs` is an empty Array, which is not allowed.");let n=Array.isArray(t),a=n?t:[t],r=this.retrieveSymbolicTensors(a),s=new Qw;if(e instanceof ri&&(e=[e]),Array.isArray(e)){if(e.length!==this.inputs.length)throw new ny(`The number of inputs provided (${e.length}) does not match the number of inputs of this model (${this.inputs.length}).`);for(let t=0;t<this.inputs.length;++t)s.add(this.inputs[t],e[t])}else for(let o of this.inputs){let t=e[o.name];if(null==t)throw new ny(`No value is provided for the model's input ${o.name}`);s.add(o,t)}let i=nv(r,s);return n?i:i[0]}retrieveSymbolicTensors(e){let t=iy(null,e.length),n=e.length;for(let a of this.layers){let r=Array.isArray(a.output)?a.output:[a.output],s=r.map(e=>e.name);for(let a=0;a<e.length;++a){let i=s.indexOf(e[a]);if(-1!==i&&(t[a]=r[i],n--),0===n)break}if(0===n)break}if(n>0){let n=[];throw t.forEach((t,a)=>{null==t&&n.push(e[a])}),new ny(`Cannot find SymbolicTensors for output name(s): ${JSON.stringify(n)}`)}return t}predictLoop(e,t=32,n=!1){return to(()=>{let a=this.checkNumSamples(e);if(n)throw new ay("Verbose predictLoop() is not implemented yet.");let r=Ok(a,t),s=this.outputs.map(e=>[]);for(let t=0;t<r.length;++t)to(()=>{let n=r[t][0],a=r[t][1],s=Dk(e,n,a),i=[];if(Array.isArray(s))for(let e=0;e<s.length;++e)i.push({key:this.inputs[e],value:s[e]});else i.push({key:this.inputs[0],value:s});let o=new Qw(i);return nv(this.outputs,o)}).forEach((e,t)=>s[t].push(e));return uy(s.map(e=>Yl(e,0)))})}predict(e,t={}){let n=jk(e);Wk(n,this.inputNames,this.feedInputShapes,!1);try{let e=null==t.batchSize?32:t.batchSize;return Fk(e),this.predictLoop(n,e)}finally{Lk(n,e)}}predictOnBatch(e){Wk(e,this.inputNames,this.feedInputShapes,!0);let t=(Array.isArray(e)?e[0]:e).shape[0];return this.predictLoop(e,t)}standardizeUserDataXY(e,t,n=!0,a){if(null==this.optimizer_)throw new ty("You must compile a model before training/testing. Use LayersModel.compile(modelCompileArgs).");let r=[];for(let s=0;s<this.feedOutputShapes.length;++s){let e=this.feedOutputShapes[s];this.feedLossFns[s]===tk?r.push(e.slice(0,e.length-1).concat([1])):r.push(e)}if(function(e,t){let n=by(e.map(e=>e.shape[0]));n.sort();let a=by(t.map(e=>e.shape[0]));if(a.sort(),n.length>1)throw new ny(`All input Tensors (x) should have the same number of samples. Got array shapes: ${JSON.stringify(e.map(e=>e.shape))}`);if(a.length>1)throw new ny(`All target Tensors (y) should have the same number of samples. Got array shapes: ${JSON.stringify(t.map(e=>e.shape))}`);if(n.length>0&&a.length>0&&!Ns.arraysEqual(n,a))throw new ny(`Input Tensors should have the same number of samples as target Tensors. Found ${n[0]} input sample(s) and ${a[0]} target sample(s).`)}(e=Bk(e,this.feedInputNames,this.feedInputShapes,!1,"input"),t=Bk(t,this.feedOutputNames,r,!1,"target")),function(e,t,n){let a=[Zv,nk,ek];for(let r=0;r<e.length;++r){let s=e[r],i=t[r],o=n[r];if(null!=i){if(i===ek&&1===s.shape[s.shape.length-1])throw new ny(`You are passing a target array of shape ${s.shape} while using a loss 'categorical_crossentropy'. 'categorical_crossentropy'expects targets to be binary matrices (1s and 0s) of shape [samples, classes].`);if(-1!==a.indexOf(i)){let e=s.shape.slice(1),t=o.slice(1);for(let n=0;n<e.length;++n){let a=e[n],r=t[n];if(null!=r&&a!==r)throw new ny(`A target Tensor with shape ${s.shape} was passed for an output of shape ${o}, while using a loss function that expects targets to have the same shape as the output.`)}}}}}(t,this.feedLossFns,this.feedOutputShapes),this.stateful&&null!=a&&a>0&&e[0].shape[0]%a!==0)throw new ny(`In a stateful network, you should only pass inputs with a number of samples that is divisible by the batch size ${a}. Found: ${e[0].shape[0]} sample(s).`);return[e,t]}async standardizeUserData(e,t,n,a,r=!0,s){let[i,o]=this.standardizeUserDataXY(e,t,r,s);if(null!=n)throw new Error("sample weight is not supported yet.");let l=null;if(null!=a){let e=Ck(a,this.outputNames);l=[];for(let t=0;t<e.length;++t)l.push(await Tk(o[t],0,e[t]))}return[i,o,l]}testLoop(e,t,n,a=0,r){return to(()=>{let s=this.checkNumSamples(t,n,r,"steps"),i=[];if(a>0)throw new ay("Verbose mode is not implemented yet.");if(null!=r)throw new ay("steps mode in testLoop() is not implemented yet");{let a=Ok(s,n),r=Fp(Xy(0,s));for(let n=0;n<a.length;++n){let s=a[n][0],o=a[n][1],l=Qy(r,s,o-s),u=Mk(t,l),d=e(u);if(0===n)for(let e=0;e<d.length;++e)i.push(sd(0));for(let e=0;e<d.length;++e){let t=d[e];i[e]=fl(i[e],bl(o-s,t))}}for(let e=0;e<i.length;++e)i[e]=xl(i[e],s)}return i})}getDedupedMetricsNames(){let e=this.metricsNames,t=[];for(let n=0;n<e.length;++n){let a=e[n],r=a;ly(e,a)>1&&(r+=`_${ly(e.slice(0,n),a)}`),t.push(r)}return t}makeTrainFunction(){return e=>{let t=[],n=e.slice(0,this.inputs.length),a=e.slice(this.inputs.length,this.inputs.length+this.outputs.length),r=e.slice(this.inputs.length+this.outputs.length,this.inputs.length+2*this.outputs.length),s=[],i=this.collectedTrainableWeights.map(e=>e.read());return[this.optimizer_.minimize(()=>{let e=[];for(let t=0;t<this.inputs.length;++t)e.push({key:this.inputs[t],value:n[t]});let i,o=new Qw(e),l=nv(this.outputs,o,{training:!0});for(let n=0;n<this.lossFunctions.length;++n){let e=(0,this.lossFunctions[n])(a[n],l[n]);null!=r[n]&&(e=Ek(e,r[n]));let s=nc(e);t.push(s),i=0===n?e:fl(i,e)}for(let n=0;n<this.metricsTensors.length;++n){let e;if(this.outputs.length>1&&n<this.outputs.length)e=t[n];else{let t=this.metricsTensors[n][0],r=this.metricsTensors[n][1];e=nc(t(a[r],l[r]))}ao(e),s.push(e)}return i=nc(i),this.calculateLosses().forEach(e=>{i=fl(i,e)}),i},!0,i)].concat(s)}}makeTestFunction(){this.testFunction=e=>to(()=>{let t,n=[],a=e.slice(0,this.inputs.length),r=e.slice(this.inputs.length,this.inputs.length+this.outputs.length),s=[];for(let e=0;e<this.inputs.length;++e)s.push({key:this.inputs[e],value:a[e]});let i=new Qw(s),o=nv(this.outputs,i);for(let e=0;e<this.lossFunctions.length;++e){let a=this.lossFunctions[e],s=nc(a(r[e],o[e]));t=0===e?s:fl(t,s),n.push(t)}for(let e=0;e<this.metricsTensors.length;++e){let t=this.metricsTensors[e][0],a=this.metricsTensors[e][1],s=nc(t(r[a],o[a]));n.push(s)}return n})}async fit(e,t,n={}){if(this.isTraining)throw new Error("Cannot start training because another fit() call is ongoing.");let a,r,s,i,o,l,u,d,c;this.isTraining=!0;try{let p=null==n.batchSize?32:n.batchSize;Fk(p);let h=await this.standardizeUserData(e,t,n.sampleWeight,n.classWeight,!1,p);a=h[0],r=h[1],c=h[2];let m,f=!1;if(null!=n.validationData&&n.validationData.length>0){if(f=!0,2!==n.validationData.length)throw 3===n.validationData.length?new ay("validationData including sample weights is not supported yet."):new ny(`When passing validation data, it must contain 2 (valX, valY) or 3 (valX, valY, valSampleWeight) items; ${n.validationData} is invalid.`);o=n.validationData[0],l=n.validationData[1];let e=await this.standardizeUserData(o,l,null,null,!0,p);u=e[0],d=e[1],m=u.concat(d)}else if(null!=n.validationSplit&&n.validationSplit>0&&n.validationSplit<1){f=!0;let e=Math.floor(a[0].shape[0]*(1-n.validationSplit)),t=a[0].shape[0];u=Dk(a,e,t),s=a,a=Dk(a,0,e),d=Dk(r,e,t),i=r,r=Dk(r,0,e),m=u.concat(d)}else null!=n.validationSteps&&(f=!0);let g=a.concat(r).concat(c);this.checkTrainableWeightsConsistency();let x,b,y=this.makeTrainFunction(),w=this.getDedupedMetricsNames();f?(this.makeTestFunction(),x=this.testFunction,b=w.slice().concat(w.map(e=>"val_"+e))):(x=null,m=[],b=w.slice());let v=Hv(n.callbacks,n.yieldEvery);return await this.fitLoop(y,g,w,p,n.epochs,n.verbose,v,x,m,n.shuffle,b,n.initialEpoch,null,null)}finally{this.isTraining=!1,Lk(a,e),Lk(r,t),Lk(s,e),Lk(i,t),Lk(u,o),Lk(d,l),null!=c&&no(c)}}async fitLoop(e,t,n,a,r,s,i,o,l,u,d,c,p,h){null==a&&(a=32),null==r&&(r=1),null==u&&(u=!0),null==c&&(c=0);let m=!1;if(null!=o&&null!=l&&(m=!0),null!=h&&(m=!0,null==p))throw new ny("Can only use `validationSteps` when doing step-wise training, i.e., `stepsPerEpoch` must be set.");let f,g=this.checkNumSamples(t,a,p,"steps_per_epoch");null!=g&&(f=Xy(0,g)),null==s&&(s=1);let{callbackList:x,history:b}=Kv(i,s,r,c,g,p,a,m,d);x.setModel(this),this.history=b,await x.onTrainBegin(),this.stopTraining_=!1;for(let y=c;y<r;++y){await x.onEpochBegin(y);let r={};if(null!=p)throw new ay("stepsPerEpoch mode is not implemented yet.");{if("batch"===u)throw new ay("batch shuffling is not implemneted yet");u&&Ns.shuffle(f);let s=Fp(f),i=Ok(g,a);for(let u=0;u<i.length;++u){let d={};if(await x.onBatchBegin(u,d),to(()=>{let c=i[u][0],p=i[u][1],h=Qy(s,c,p-c);d.batch=u,d.size=p-c;let f=Mk(t,h),g=e(f);for(let e=0;e<n.length;++e){let t=n[e],a=g[e];d[t]=a,ao(a)}if(u===i.length-1&&m){let e=this.testLoop(o,l,a);for(let t=0;t<n.length;++t){let a=n[t],s=e[t];ao(s),r["val_"+a]=s}}}),await x.onBatchEnd(u,d),Pv(d),this.stopTraining_)break}s.dispose()}if(await x.onEpochEnd(y,r),this.stopTraining_)break}return await x.onTrainEnd(),await this.history.syncData(),this.history}async fitDataset(e,t){return async function(e,t,n){let a=null!=n.batchesPerEpoch;if(Ns.assert(null!=e.optimizer,()=>"You must compile a model before training/testing. Use LayersModel.compile(modelCompileConfig)."),Ns.assert(null!=n,()=>"For fitDataset(), the 2nd argument (config) is required, but it is not provided in this call."),Ns.assert(null!=n.epochs&&n.epochs>0&&Number.isInteger(n.epochs),()=>`For fitDataset(), config.epochs is expected to be a positive integer, but got ${n.epochs}`),Ns.assert(!a||n.batchesPerEpoch>0&&Number.isInteger(n.batchesPerEpoch),()=>`For fitDataset(), config.batchesPerEpoch is expected to be a positive integer if specified, but got ${n.batchesPerEpoch}`),Ns.assert(null==n.validationSplit,()=>"`validationSplit` is not supported by `fitDataset()`. Use validationData instead."),e.isTraining)throw new Error("Cannot start training because another fit() call is ongoing.");e.isTraining=!0;try{let r,s,i=null!=n.validationData;if(i)if(Rk(n.validationData))Ns.assert(null==n.validationBatches||n.validationBatches>0&&Number.isInteger(n.validationBatches),()=>`For fitDataset() with dataset-based validation, config.validationBatches is expected not to be provided, or to be a positive integer, but got ${n.validationBatches}`);else{let e=function(e){if(3===e.length)throw new ay("Validation with sample weights is not implemented yet.");return{xs:e[0],ys:e[1]}}(n.validationData);r=e.xs,s=e.ys}let o,l=e.makeTrainFunction(),u=e.getDedupedMetricsNames();o=i?u.slice().concat(u.map(e=>"val_"+e)):u.slice();let d=Hv(n.callbacks,n.yieldEvery),c=null==n.verbose?1:n.verbose,{callbackList:p,history:h}=Kv(d,c,n.epochs,null,null,function(e,t){let n=null;return null!=t.batchesPerEpoch?n=t.batchesPerEpoch:Number.isFinite(e.size)&&(n=e.size),n}(t,n),null,i,o);p.setModel(e),e.history=h,await p.onTrainBegin(),e.stopTraining_=!1;let m=null==n.initialEpoch?0:n.initialEpoch,f=await t.iterator();for(;m<n.epochs;){let o={};await p.onEpochBegin(m);let d=0,c=0;for(a||(f=await t.iterator());!a||d<n.batchesPerEpoch;){let t=await f.next();if(a&&t.done)break;if(null!=t.value){let{xs:a,ys:r}=Ak(e,t.value),s={};s.batch=c,s.size=a[0].shape[0],await p.onBatchBegin(c,s);let i=[];if(null!=n.classWeight){let t=Ck(n.classWeight,e.outputNames);for(let e=0;e<t.length;++e)i.push(await Tk(r[e],0,t[e]))}let o=a.concat(r).concat(i),h=l(o);no(o);for(let e=0;e<u.length;++e){let t=u[e],n=h[e];s[t]=n,ao(n)}await p.onBatchEnd(c,s),Pv(s),c++,d++}if(a?d>=n.batchesPerEpoch:t.done){if(i){let t;t=Rk(n.validationData)?dy(await e.evaluateDataset(n.validationData,{batches:n.validationBatches})):dy(e.evaluate(r,s,{batchSize:null==n.validationBatchSize?32:n.validationBatchSize,verbose:0}));for(let n=0;n<e.metricsNames.length;++n)o[`val_${e.metricsNames[n]}`]=t[n]}break}if(e.stopTraining_)break}if(await p.onEpochEnd(m,o),m++,e.stopTraining_)break}return await p.onTrainEnd(),await e.history.syncData(),e.history}finally{e.isTraining=!1}}(this,e,t)}async trainOnBatch(e,t){let n=await this.standardizeUserData(e,t),a=n[0],r=n[1],s=this.makeTrainFunction()(a.concat(r)),i=[];for(let o of s){let e=await o.data();i.push(e[0])}return no(s),Lk(n[0],e),Lk(n[1],t),uy(i)}getNamedWeights(e){let t=[],n=null!=e&&e.trainableOnly,a=n?this.trainableWeights:this.weights,r=this.getWeights(n);for(let s=0;s<a.length;++s)n&&!a[s].trainable||t.push({name:a[s].originalName,tensor:r[s]});return t}set stopTraining(e){this.stopTraining_=e}get stopTraining(){return this.stopTraining_}get optimizer(){return this.optimizer_}set optimizer(e){this.optimizer_!==e&&(this.optimizer_=e,this.isOptimizerOwned=!1)}dispose(){let e=super.dispose();if(0===e.refCountAfterDispose&&null!=this.optimizer&&this.isOptimizerOwned){let t=Qi().numTensors;this.optimizer_.dispose(),e.numDisposedVariables+=t-Qi().numTensors}return e}getLossIdentifiers(){let e;if("string"==typeof this.loss)e=cy(this.loss);else if(Array.isArray(this.loss)){for(let e of this.loss)if("string"!=typeof e)throw new Error("Serialization of non-string loss is not supported.");e=this.loss.map(e=>cy(e))}else{let t=Object.keys(this.loss);e={};let n=this.loss;for(let a of t){if("string"!=typeof n[a])throw new Error("Serialization of non-string loss is not supported.");e[a]=cy(n[a])}}return e}getMetricIdentifiers(){if("string"==typeof this.metrics||"function"==typeof this.metrics)return[cy(gk(this.metrics))];if(Array.isArray(this.metrics))return this.metrics.map(e=>cy(gk(e)));{let e={};for(let t in this.metrics)e[t]=cy(gk(this.metrics[t]));return e}}getTrainingConfig(){return{loss:this.getLossIdentifiers(),metrics:this.getMetricIdentifiers(),optimizer_config:{class_name:this.optimizer.getClassName(),config:this.optimizer.getConfig()}}}loadTrainingConfig(e){if(null!=e.weighted_metrics)throw new Error("Loading weight_metrics is not supported yet.");if(null!=e.loss_weights)throw new Error("Loading loss_weights is not supported yet.");if(null!=e.sample_weight_mode)throw new Error("Loading sample_weight_mode is not supported yet.");let t,n,a=Xv(Nk(e.optimizer_config));if("string"==typeof e.loss)t=py(e.loss);else if(Array.isArray(e.loss))t=e.loss.map(e=>py(e));else if(null!=e.loss){t={};for(let n in e.loss)t[n]=py(e.loss[n])}if(Array.isArray(e.metrics))n=e.metrics.map(e=>py(e));else if(null!=e.metrics){n={};for(let t in e.metrics)n[t]=py(e.metrics[t])}this.compile({loss:t,metrics:n,optimizer:a})}async save(e,t){if("string"==typeof e){let t=jm.getSaveHandlers(e);if(0===t.length)throw new ny(`Cannot find any save handlers for URL '${e}'`);if(t.length>1)throw new ny(`Found more than one (${t.length}) save handlers for URL '${e}'`);e=t[0]}if(null==e.save)throw new ny("LayersModel.save() cannot proceed because the IOHandler provided does not have the `save` attribute defined.");let n=await jm.encodeWeights(this.getNamedWeights(t)),a={modelTopology:this.toJSON(null,!1),format:"layers-model",generatedBy:`TensorFlow.js tfjs-layers v${Ik}`,convertedBy:null};if(null!=t&&t.includeOptimizer&&null!=this.optimizer){a.trainingConfig=this.getTrainingConfig();let e="optimizer",{data:t,specs:r}=await jm.encodeWeights(await this.optimizer.getWeights(),e);n.specs.push(...r),n.data=jm.concatenateArrayBuffers([n.data,t])}return null!=this.userDefinedMetadata&&(xk(this.userDefinedMetadata,this.name,!0),a.userDefinedMetadata=this.userDefinedMetadata),a.weightData=n.data,a.weightSpecs=n.specs,e.save(a)}setUserDefinedMetadata(e){xk(e,this.name),this.userDefinedMetadata=e}getUserDefinedMetadata(){return this.userDefinedMetadata}};Vk.className="Model",vm.registerClass(Vk);var Uk=class extends Vk{};async function Gk(e,t){"modelTopology"in e||(e={modelTopology:e});let n=e.modelTopology;null!=n.model_config&&(n=n.model_config);let a=Xv(Nk(n),t);if(null!=e.weightsManifest){let t=await jm.loadWeights(e.weightsManifest,e.pathPrefix,a.weights.map(e=>e.originalName)),n={};for(let e of a.weights)n[e.originalName]=t[e.originalName];a.loadWeights(n),no(t)}return a}async function Hk(e,t){if(null==t&&(t={}),"string"==typeof e){let n=jm.getLoadHandlers(e,t);if(0===n.length)n.push(jm.browserHTTPRequest(e,t));else if(n.length>1)throw new ny(`Found more than one (${n.length}) load handlers for URL '${e}'`);e=n[0]}return async function(e,t,n){if(null==n&&(n={}),null==e.load)throw new ny("Cannot proceed with model loading because the IOHandler provided does not have the `load` method implemented.");let a=await e.load(),r=a.modelTopology;null!=r.model_config&&(r=r.model_config);let s=null==n.strict||n.strict,i=null!=a.weightData&&null!=a.weightSpecs&&s,o=Xv(Nk(r),void 0,i),l=a.trainingConfig;if(null!=l&&o.loadTrainingConfig(l),null!=a.userDefinedMetadata&&o.setUserDefinedMetadata(a.userDefinedMetadata),null!=a.weightData){if(null==a.weightSpecs)throw new ny("LayersModel artifacts contains weight data, but not weight specs. Therefore loading of weights cannot proceed.");let{modelWeights:e,optimizerWeights:t}=function(e,t){let n=jm.decodeWeights(e,t),a={},r=[];return t.forEach(e=>{"optimizer"===e.group?r.push({name:e.name,tensor:n[e.name]}):a[e.name]=n[e.name]}),{modelWeights:a,optimizerWeights:r}}(a.weightData,a.weightSpecs);o.loadWeights(e,s),null!=o.optimizer&&t.length>0&&await o.optimizer.setWeights(t),no(e),no(t.map(e=>e.tensor))}return o}(e,0,t)}Uk.className="Functional",vm.registerClass(Uk);var qk=class e extends Vk{constructor(e){if(super({inputs:[],outputs:[]}),e=e||{},this.trainable=!0,this.built=!1,this.name=null!=e.name?e.name:Ty("sequential_"),null!=e.layers)for(let t of e.layers)this.add(t)}checkShape(e){if(e.inboundNodes[0].outputTensors[0].shape.some(e=>e<0))throw new ny(`Negative dimension size caused by adding layer ${e.name} with input shape [${e.inboundNodes[0].inputTensors[0].shape}]`)}add(t){let n,a=t instanceof e||t instanceof Vk;if(a){if(n=t,1!==n.outputs.length)throw new ny("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");if(1!==n.inputs.length)throw new ny("All layers in a Sequential model should have a single input tensor. For multi-input layers, use the functional API.")}if(0===this.outputs.length){if(0===t.inboundNodes.length){if(null==t.batchInputShape)throw new ny("The first layer in a Sequential model must get an `inputShape` or `batchInputShape` argument.");let e=Jw({batchShape:t.batchInputShape,dtype:t.dtype,name:t.name+"_input"});t.apply(e)}if(a)this.outputs=n.outputs,this.inputs=n.inputs;else{if(1!==t.inboundNodes.length)throw new ny(`A layer added to a Sequential model must not already be connected somewhere else. LayersModel received layer ${t.name} which has ${t.inboundNodes.length} pre-existing inbound connections.`);if(1!==t.inboundNodes[0].outputTensors.length)throw new ny("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");this.checkShape(t),this.outputs=[t.inboundNodes[0].outputTensors[0]],this.inputs=Yw(this.outputs[0])}this.inboundNodes=[],new qw({outboundLayer:this,inboundLayers:[],nodeIndices:[],tensorIndices:[],inputTensors:this.inputs,outputTensors:this.outputs,inputMasks:iy(null,this.inputs.length),outputMasks:[null],inputShapes:this.inputs.map(e=>e.shape),outputShapes:this.outputs[0].shape})}else{let e=t.apply(this.outputs[0]);if(Array.isArray(e))throw new TypeError("All layers in a Sequential model should have a single output tensor. For multi-output layers, use the functional API.");this.checkShape(t),this.outputs=[e],this.inboundNodes[0].outputTensors=this.outputs,this.inboundNodes[0].outputShapes=[this.outputs[0].shape]}this.layers.push(t),this.built=!1}pop(){if(0===this.layers.length)throw new TypeError("There are no layers in the model.");if(this.layers.pop(),0===this.layers.length)this.outputs=[],this.inboundNodes=[],this.outboundNodes=[];else{let e=this.layers.length-1;this.layers[e].outboundNodes=[],this.outputs=[this.layers[e].output],this.inboundNodes[0].outputTensors=this.outputs,this.inboundNodes[0].outputShapes=[this.outputs[0].shape]}}call(e,t){return null==this.model&&this.build(),this.model.call(e,t)}build(e){if(Lw(e),0===this.inputs.length||0===this.outputs.length)throw new TypeError("Sequential model cannot be built: model is empty. Add some layers first.");this.model=new Vk({inputs:this.inputs,outputs:this.outputs[0],name:this.name+"_model"}),this.model.trainable=this.trainable,this.supportsMasking=this.model.supportsMasking,this.inputLayers=this.model.inputLayers,this.inputLayersNodeIndices=this.model.inputLayersNodeIndices,this.inputLayersTensorIndices=this.model.inputLayersTensorIndices,this.outputLayers=this.model.outputLayers,this.outputLayersNodeIndices=this.model.outputLayersNodeIndices,this.outputLayersTensorIndices=this.model.outputLayersTensorIndices,this.nodesByDepth=this.model.nodesByDepth,this.containerNodes=this.model.containerNodes,this.outputNames=this.model.outputNames,this.inputNames=this.model.inputNames,this.built=!0}countParams(){return this.built||this.build(),super.countParams()}summary(e,t,n=console.log){this.built||this.build(),super.summary(e,t,n)}setWeights(e){null==this.model&&this.build(),this.model.setWeights(e)}evaluate(e,t,n={}){if(!this.built)throw new ty("The model needs to be compiled before being used.");return this.model.evaluate(e,t,n)}async evaluateDataset(e,t){if(!this.built)throw new ty("The model needs to be compiled before being used.");return this.model.evaluateDataset(e,t)}predict(e,t={}){return null==this.model&&this.build(),this.model.predict(e,t)}predictOnBatch(e){return null==this.model&&this.build(),this.model.predictOnBatch(e)}compile(e){this.build(),this.model.compile(e),this.optimizer_=this.model.optimizer,this.isOptimizerOwned=this.model.isOptimizerOwned,this.loss=this.model.loss,this.metrics=this.model.metrics,this.metricsTensors=this.model.metricsTensors,this.metricsNames=this.model.metricsNames}get optimizer(){return null==this.model?void 0:this.model.optimizer}set optimizer(e){this.model.optimizer=e}async fit(e,t,n={}){if(!this.built)throw new ty("The model needs to be compiled before being used.");return this.model.fit(e,t,n)}async fitDataset(e,t){if(!this.built)throw new ty("The model needs to be compiled before being used.");return this.model.fitDataset(e,t)}async trainOnBatch(e,t){return this.model.trainOnBatch(e,t)}static fromConfig(t,n,a={},r=!1){let s,i={};if(n instanceof Array){if(null==n[0].className||"Merge"===n[0].className)throw new ny("Legacy serialization format not supported yet.");s=n}else Ns.assert(null!=n.layers,()=>"When the config data for a Sequential model is not an Array, it must be an Object that contains the 'layers' field."),s=n.layers,delete n.layers,i=n;let o=new t(i);if(!(o instanceof e))throw new ay(`Sequential.fromConfig called on non-Sequential input: ${o}`);for(let e of s){let t=Xv(e,void 0,r);r&&t.setFastWeightInitDuringBuild(!0),o.add(t)}return o}set stopTraining(e){if(null==this.model)throw new ny("Cannot set the stopTraining property of a sequential model before it is compiled.");this.model.stopTraining=e}get stopTraining(){if(null==this.model)throw new ny("Cannot get the stopTraining property of a sequential model before it is compiled.");return this.model.stopTraining}getConfig(){let e=[];for(let t of this.layers){let n={};n.className=t.getClassName(),n.config=t.getConfig(),e.push(n)}return{name:this.name,layers:e}}};function Kk(e){return new Vk(e)}function Xk(e){return new qk(e)}function Yk(e){return Jw(e)}function Zk(e,t){qv.registerCallbackConstructor(e,t)}qk.className="Sequential",vm.registerClass(qk);var Jk=class extends vm.Serializable{getConfig(){return{}}},Qk=class extends Jk{apply(e,t=1){return function(e,t=1){if(1!==t)throw new ay(`Support for alpha values other than 1 (${t}) is not implemented yet.`);return Gu(e)}(e,t)}};Qk.className="elu",vm.registerClass(Qk);var eN=class extends Jk{apply(e){return cp(e)}};eN.className="selu",vm.registerClass(eN);var tN=class extends Jk{apply(e){return np(e)}};tN.className="relu",vm.registerClass(tN);var nN=class extends Jk{apply(e){return to(()=>ic(6,np(e)))}};nN.className="relu6",vm.registerClass(nN);var aN=class extends Jk{apply(e){return e}};aN.className="linear",vm.registerClass(aN);var rN=class extends Jk{apply(e){return Jl(e)}};rN.className="sigmoid",vm.registerClass(rN);var sN=class extends Jk{apply(e){return function(e){return to(()=>{let t=fl(.5,bl(.2,e));return mu(t,0,1)})}(e)}};sN.className="hardSigmoid",vm.registerClass(sN);var iN=class extends Jk{apply(e){return Pd(e)}};iN.className="softplus",vm.registerClass(iN);var oN=class extends Jk{apply(e){return function(e){return to(()=>xl(e,fl(yl(e),1)))}(e)}};oN.className="softsign",vm.registerClass(oN);var lN=class extends Jk{apply(e){return eu(e)}};lN.className="tanh",vm.registerClass(lN);var uN=class extends Jk{apply(e,t=-1){return vp(e,t)}};uN.className="softmax",vm.registerClass(uN);var dN=class extends Jk{apply(e,t=-1){return Vd(e,t)}};dN.className="logSoftmax",vm.registerClass(dN);var cN=class extends Jk{apply(e){return to(()=>to(()=>{let t=Math.sqrt(2),n=bl(.5,fl(1,qu(xl(e,t))));return bl(e,n)}))}};cN.className="gelu",vm.registerClass(cN);var pN=class extends Jk{apply(e){return to(()=>bl(.5,bl(e,fl(1,eu(bl(id(xl(2,Math.PI)),fl(e,bl(.044715,rd(e,3)))))))))}};pN.className="gelu_new",vm.registerClass(pN);var hN=class extends Jk{apply(e){return to(()=>bl(e,eu(Pd(e))))}};hN.className="mish",vm.registerClass(hN);var mN=class extends Jk{apply(e,t=1){return to(()=>bl(Jl(bl(e,t)),e))}};function fN(e){return e.getClassName()}function gN(e,t={}){return gy(e,vm.SerializationMap.getMap().classNameMap,t,"activation")}function xN(e){if(null==e){return gN({className:"linear",config:{}})}if("string"==typeof e){let t={};return t.className=e,t.config={},gN(t)}return e instanceof Jk?e:gN(e)}function bN(e){if(null!=e&&"object"!=typeof e)throw new Error(`Argument to L1L2 regularizer's constructor is expected to be an object, but received: ${e}`)}mN.className="swish",vm.registerClass(mN);var yN=class extends vm.Serializable{},wN=class extends yN{constructor(e){super(),bN(e),this.l1=null==e||null==e.l1?.01:e.l1,this.l2=null==e||null==e.l2?.01:e.l2,this.hasL1=0!==this.l1,this.hasL2=0!==this.l2}apply(e){return to(()=>{let t=ac([1]);return this.hasL1&&(t=fl(t,ld(bl(this.l1,yl(e))))),this.hasL2&&(t=fl(t,ld(bl(this.l2,lw(e))))),ql(t,[])})}getConfig(){return{l1:this.l1,l2:this.l2}}static fromConfig(e,t){return new e({l1:t.l1,l2:t.l2})}};wN.className="L1L2",vm.registerClass(wN);var vN={l1l2:"L1L2"};function kN(e){return my(e)}function NN(e,t={}){return gy(e,vm.SerializationMap.getMap().classNameMap,t,"regularizer")}function SN(e){return null==e?null:"string"==typeof e?NN({className:e in vN?vN[e]:e,config:{}}):e instanceof yN?e:NN(e)}var IN=class extends Xw{constructor(e){super(null==e?{}:e),this.supportsMasking=!0,null!=e&&(this.maxValue=e.maxValue)}call(e,t){e=jw(e);let n=np(e);return null!=this.maxValue&&(n=mu(n,0,this.maxValue)),n}computeOutputShape(e){return e}getConfig(){let e={maxValue:this.maxValue},t=super.getConfig();return Object.assign(e,t),e}};IN.className="ReLU",vm.registerClass(IN);var _N=class extends Xw{constructor(e){super(null==e?{}:e),this.DEFAULT_ALPHA=.3,null==e&&(e={}),this.alpha=null==e.alpha?this.DEFAULT_ALPHA:e.alpha}call(e,t){let n=jw(e);return Id(n,this.alpha)}computeOutputShape(e){return e}getConfig(){let e={alpha:this.alpha},t=super.getConfig();return Object.assign(e,t),e}};_N.className="LeakyReLU",vm.registerClass(_N);var CN=class extends Xw{constructor(e){if(super(null==e?{}:e),this.DEFAULT_ALPHA_INITIALIZER="zeros",null==e&&(e={}),this.supportsMasking=!0,this.alphaInitializer=Dw(e.alphaInitializer||this.DEFAULT_ALPHA_INITIALIZER),this.alphaRegularizer=SN(e.alphaRegularizer),this.alphaConstraint=gv(e.alphaConstraint),null==e.sharedAxes)this.sharedAxes=null;else if(Array.isArray(e.sharedAxes))this.sharedAxes=e.sharedAxes;else{if("number"!=typeof e.sharedAxes)throw new ny(`Expected sharedAxes to be a number or an array of numbers, but got ${e.sharedAxes}`);this.sharedAxes=[e.sharedAxes]}}build(e){let t=(e=Lw(e)).slice(1);if(null!=this.sharedAxes)for(let a of this.sharedAxes)t[a-1]=1;this.alpha=this.addWeight("alpha",t,"float32",this.alphaInitializer,this.alphaRegularizer,!0,this.alphaConstraint);let n={};if(null!=this.sharedAxes)for(let a=1;a<e.length;++a)n[a]=e[a];this.inputSpec=[new Uw({ndim:e.length,axes:n})],this.built=!0}call(e,t){return e=jw(e),Nc(e,this.alpha.read())}getConfig(){let e={alphaInitializer:Fw(this.alphaInitializer),alphaRegularizer:kN(this.alphaRegularizer),alphaConstraint:mv(this.alphaConstraint),sharedAxes:this.sharedAxes},t=super.getConfig();return Object.assign(e,t),e}};CN.className="PReLU",vm.registerClass(CN);var TN=class extends Xw{constructor(e){if(super(null==e?{}:e),this.DEFAULT_ALPHA=1,null==e&&(e={}),null!=e.alpha&&e.alpha!==this.DEFAULT_ALPHA)throw new ay(`Non-default alpha value (${e.alpha}) is not supported by the ELU layer yet.`);this.alpha=null==e.alpha?this.DEFAULT_ALPHA:e.alpha}call(e,t){let n=jw(e);return Gu(n)}computeOutputShape(e){return e}getConfig(){let e={alpha:this.alpha},t=super.getConfig();return Object.assign(e,t),e}};TN.className="ELU",vm.registerClass(TN);var EN=class extends Xw{constructor(e){super(null==e?{}:e),this.DEFAULT_THETA=1,null==e&&(e={}),this.theta=null==e.theta?this.DEFAULT_THETA:e.theta}call(e,t){let n=jw(e);return bl(n,pl(yd(n,this.theta),"float32"))}computeOutputShape(e){return e}getConfig(){let e={theta:this.theta},t=super.getConfig();return Object.assign(e,t),e}};EN.className="ThresholdedReLU",vm.registerClass(EN);var AN=class extends Xw{constructor(e){super(null==e?{}:e),this.DEFAULT_AXIS=1,null==e&&(e={}),this.softmax=(new uN).apply,this.axis=null==e.axis?this.DEFAULT_AXIS:e.axis}call(e,t){return to(()=>{let n=jw(e),a=t.mask;if(null!=a){let e=bl(Wd(rc(n.shape),pl(a,n.dtype)),sd(-1e9));n=fl(n,e)}return this.axis instanceof Array?this.axis.length>1?pd(Wd(n,Ud(n,this.axis,!0))):this.softmax(n,this.axis[0]):this.softmax(n,this.axis)})}computeOutputShape(e){return e}getConfig(){let e={axis:this.axis},t=super.getConfig();return Object.assign(e,t),e}};function $N(e,t,n){if("number"==typeof e)return iy(e,t);if(e.length!==t)throw new ny(`The ${n} argument must be an integer or tuple of ${t} integers. Received: ${e.length} elements.`);for(let a=0;a<t;++a){let r=e[a];if(!Gy(r))throw new ny(`The ${n} argument must be an integer or tuple of ${t} integers. Received: ${JSON.stringify(e)} including a non-integer number ${r}`)}return e}function RN(e,t,n,a,r=1){if(null==e)return e;let s;return s="same"===n?e:e-(t+(t-1)*(r-1))+1,Math.floor((s+a-1)/a)}function FN(e,t,n,a){if(null==e)return null;if("valid"===a)e=e*t+Ky([n-t,0]);else{if("same"!==a)throw new ny(`Unsupport padding mode: ${a}.`);e*=t}return e}function DN(e,t){return to(()=>(My(t),"channelsFirst"===t?eh(e,[0,2,3,1]):e))}function MN(e,t){return to(()=>(My(t),"channelsFirst"===t?eh(e,[0,2,3,4,1]):e))}function ON(e,t,n,a=[1,1],r="valid",s,i,o=null){return to(()=>{if(null==s&&(s="channelsLast"),My(s),3!==e.rank&&4!==e.rank)throw new ny(`conv2dWithBiasActivation expects input to be of rank 3 or 4, but received ${e.rank}.`);if(3!==t.rank&&4!==t.rank)throw new ny(`conv2dWithBiasActivation expects kernel to be of rank 3 or 4, but received ${e.rank}.`);let l=DN(e,s);if("causal"===r)throw new ay("The support for CAUSAL padding mode in conv1dWithBias is not implemented yet.");return l=uh.conv2d({x:l,filter:t,strides:a,pad:"same"===r?"same":"valid",dilations:i,dataFormat:"NHWC",bias:n,activation:o}),"channelsFirst"===s&&(l=eh(l,[0,3,1,2])),l})}AN.className="Softmax",vm.registerClass(AN);var jN=class e extends Xw{constructor(t,n){if(super(n),this.bias=null,this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",this.DEFAULT_BIAS_INITIALIZER="zeros",e.verifyArgs(n),this.rank=t,ky(this.rank,"rank"),1!==this.rank&&2!==this.rank&&3!==this.rank)throw new ay(`Convolution layer for rank other than 1, 2, or 3 (${this.rank}) is not implemented yet.`);if(this.kernelSize=$N(n.kernelSize,t,"kernelSize"),this.strides=$N(null==n.strides?1:n.strides,t,"strides"),this.padding=null==n.padding?"valid":n.padding,Oy(this.padding),this.dataFormat=null==n.dataFormat?"channelsLast":n.dataFormat,My(this.dataFormat),this.activation=xN(n.activation),this.useBias=null==n.useBias||n.useBias,this.biasInitializer=Dw(n.biasInitializer||this.DEFAULT_BIAS_INITIALIZER),this.biasConstraint=gv(n.biasConstraint),this.biasRegularizer=SN(n.biasRegularizer),this.activityRegularizer=SN(n.activityRegularizer),this.dilationRate=$N(null==n.dilationRate?1:n.dilationRate,t,"dilationRate"),1===this.rank&&Array.isArray(this.dilationRate)&&1!==this.dilationRate.length)throw new ny(`dilationRate must be a number or an array of a single number for 1D convolution, but received ${JSON.stringify(this.dilationRate)}`);if(2===this.rank){if("number"==typeof this.dilationRate)this.dilationRate=[this.dilationRate,this.dilationRate];else if(2!==this.dilationRate.length)throw new ny(`dilationRate must be a number or array of two numbers for 2D convolution, but received ${JSON.stringify(this.dilationRate)}`)}else if(3===this.rank)if("number"==typeof this.dilationRate)this.dilationRate=[this.dilationRate,this.dilationRate,this.dilationRate];else if(3!==this.dilationRate.length)throw new ny(`dilationRate must be a number or array of three numbers for 3D convolution, but received ${JSON.stringify(this.dilationRate)}`)}static verifyArgs(e){if(oy("kernelSize"in e,"required key 'kernelSize' not in config"),"number"!=typeof e.kernelSize&&!vy(e.kernelSize,"number",1,3))throw new ny(`BaseConv expects config.kernelSize to be number or number[] with length 1, 2, or 3, but received ${JSON.stringify(e.kernelSize)}.`)}getConfig(){let e={kernelSize:this.kernelSize,strides:this.strides,padding:this.padding,dataFormat:this.dataFormat,dilationRate:this.dilationRate,activation:fN(this.activation),useBias:this.useBias,biasInitializer:Fw(this.biasInitializer),biasRegularizer:kN(this.biasRegularizer),activityRegularizer:kN(this.activityRegularizer),biasConstraint:mv(this.biasConstraint)},t=super.getConfig();return Object.assign(e,t),e}},LN=class e extends jN{constructor(t,n){super(t,n),this.kernel=null,e.verifyArgs(n),this.filters=n.filters,ky(this.filters,"filters"),this.kernelInitializer=Dw(n.kernelInitializer||this.DEFAULT_KERNEL_INITIALIZER),this.kernelConstraint=gv(n.kernelConstraint),this.kernelRegularizer=SN(n.kernelRegularizer)}build(e){e=Lw(e);let t="channelsFirst"===this.dataFormat?1:e.length-1;if(null==e[t])throw new ny(`The channel dimension of the input should be defined. Found ${e[t]}`);let n=e[t],a=this.kernelSize.concat([n,this.filters]);this.kernel=this.addWeight("kernel",a,null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.filters],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint)),this.inputSpec=[{ndim:this.rank+2,axes:{[t]:n}}],this.built=!0}call(e,t){return to(()=>{e=jw(e);let t,n=null==this.bias?null:this.bias.read(),a=Sy(this.activation.getClassName());if(null!=a&&2===this.rank)t=ON(e,this.kernel.read(),n,this.strides,this.padding,this.dataFormat,this.dilationRate,a);else{if(1===this.rank)t=function(e,t,n,a=1,r="valid",s,i=1){return to(()=>{if(null==s&&(s="channelsLast"),My(s),3!==e.shape.length)throw new ny(`The input of a conv1dWithBias operation should be 3, but is ${e.shape.length} instead.`);if(3!==t.shape.length)throw new ny(`The kernel for a conv1dWithBias operation should be 3, but is ${t.shape.length} instead`);if(null!=n&&1!==n.shape.length)throw new ny(`The bias for a conv1dWithBias operation should be 1, but is ${n.shape.length} instead`);if("channelsFirst"===s&&(e=eh(e,[0,2,1])),"causal"===r)throw new ay("The support for CAUSAL padding mode in conv1dWithBias is not implemented yet.");let o=wu(e,t,a,"same"===r?"same":"valid","NWC",i);return null!=n&&(o=dw(o,n)),o})}(e,this.kernel.read(),n,this.strides[0],this.padding,this.dataFormat,this.dilationRate[0]);else if(2===this.rank)t=ON(e,this.kernel.read(),n,this.strides,this.padding,this.dataFormat,this.dilationRate);else{if(3!==this.rank)throw new ay("convolutions greater than 3D are not implemented yet.");t=function(e,t,n,a=[1,1,1],r="valid",s,i){return to(()=>{if(null==s&&(s="channelsLast"),My(s),4!==e.rank&&5!==e.rank)throw new ny(`conv3dWithBias expects input to be of rank 4 or 5, but received ${e.rank}.`);if(4!==t.rank&&5!==t.rank)throw new ny(`conv3dWithBias expects kernel to be of rank 4 or 5, but received ${e.rank}.`);let o=MN(e,s);if("causal"===r)throw new ay("The support for CAUSAL padding mode in conv3dWithBias is not implemented yet.");return o=Nu(o,t,a,"same"===r?"same":"valid","NDHWC",i),null!=n&&(o=dw(o,n)),"channelsFirst"===s&&(o=eh(o,[0,4,1,2,3])),o})}(e,this.kernel.read(),n,this.strides,this.padding,this.dataFormat,this.dilationRate)}null!=this.activation&&(t=this.activation.apply(t))}return t})}computeOutputShape(e){e=Lw(e);let t=[],n="channelsLast"===this.dataFormat?e.slice(1,e.length-1):e.slice(2);for(let r=0;r<n.length;++r){let e=RN(n[r],this.kernelSize[r],this.padding,this.strides[r],"number"==typeof this.dilationRate?this.dilationRate:this.dilationRate[r]);t.push(e)}let a=[e[0]];return"channelsLast"===this.dataFormat?(a=a.concat(t),a.push(this.filters)):(a.push(this.filters),a=a.concat(t)),a}getConfig(){let e={filters:this.filters,kernelInitializer:Fw(this.kernelInitializer),kernelRegularizer:kN(this.kernelRegularizer),kernelConstraint:mv(this.kernelConstraint)},t=super.getConfig();return Object.assign(e,t),e}static verifyArgs(e){if(!("filters"in e)||"number"!=typeof e.filters||e.filters<1)throw new ny(`Convolution layer expected config.filters to be a 'number' > 0 but got ${JSON.stringify(e.filters)}`)}},zN=class e extends LN{constructor(t){super(2,t),e.verifyArgs(t)}getConfig(){let e=super.getConfig();return delete e.rank,e}static verifyArgs(e){if("number"!=typeof e.kernelSize&&!vy(e.kernelSize,"number",1,2))throw new ny(`Conv2D expects config.kernelSize to be number or number[] with length 1 or 2, but received ${JSON.stringify(e.kernelSize)}.`)}};zN.className="Conv2D",vm.registerClass(zN);var PN=class e extends LN{constructor(t){super(3,t),e.verifyArgs(t)}getConfig(){let e=super.getConfig();return delete e.rank,e}static verifyArgs(e){if("number"!=typeof e.kernelSize&&(!Array.isArray(e.kernelSize)||1!==e.kernelSize.length&&3!==e.kernelSize.length))throw new ny(`Conv3D expects config.kernelSize to be number or [number, number, number], but received ${JSON.stringify(e.kernelSize)}.`)}};PN.className="Conv3D",vm.registerClass(PN);var BN=class extends zN{constructor(e){if(super(e),this.inputSpec=[new Uw({ndim:4})],"same"!==this.padding&&"valid"!==this.padding)throw new ny(`Conv2DTranspose currently supports only padding modes 'same' and 'valid', but received padding mode ${this.padding}`)}build(e){if(4!==(e=Lw(e)).length)throw new ny("Input should have rank 4; Received input shape: "+JSON.stringify(e));let t="channelsFirst"===this.dataFormat?1:e.length-1;if(null==e[t])throw new ny("The channel dimension of the inputs should be defined. Found `None`.");let n=e[t],a=this.kernelSize.concat([this.filters,n]);this.kernel=this.addWeight("kernel",a,"float32",this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.filters],"float32",this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint)),this.inputSpec=[new Uw({ndim:4,axes:{[t]:n}})],this.built=!0}call(e,t){return to(()=>{let t=jw(e);if(4!==t.shape.length)throw new ny(`Conv2DTranspose.call() expects input tensor to be rank-4, but received a tensor of rank-${t.shape.length}`);let n,a,r=t.shape,s=r[0];"channelsFirst"===this.dataFormat?(n=2,a=3):(n=1,a=2);let i=r[n],o=r[a],l=this.kernelSize[0],u=this.kernelSize[1],d=this.strides[0],c=this.strides[1],p=[s,FN(i,d,l,this.padding),FN(o,c,u,this.padding),this.filters];"channelsLast"!==this.dataFormat&&(t=eh(t,[0,2,3,1]));let h=ku(t,this.kernel.read(),p,this.strides,this.padding);return"channelsLast"!==this.dataFormat&&(h=eh(h,[0,3,1,2])),null!=this.bias&&(h=dw(h,this.bias.read(),this.dataFormat)),null!=this.activation&&(h=this.activation.apply(h)),h})}computeOutputShape(e){let t,n,a,r=(e=Lw(e)).slice();"channelsFirst"===this.dataFormat?(t=1,n=2,a=3):(t=3,n=1,a=2);let s=this.kernelSize[0],i=this.kernelSize[1],o=this.strides[0],l=this.strides[1];return r[t]=this.filters,r[n]=FN(r[n],o,s,this.padding),r[a]=FN(r[a],l,i,this.padding),r}getConfig(){let e=super.getConfig();return delete e.dilationRate,e}};BN.className="Conv2DTranspose",vm.registerClass(BN);var WN=class extends PN{constructor(e){if(super(e),this.inputSpec=[new Uw({ndim:5})],"same"!==this.padding&&"valid"!==this.padding)throw new ny(`Conv3DTranspose currently supports only padding modes 'same' and 'valid', but received padding mode ${this.padding}`)}build(e){if(5!==(e=Lw(e)).length)throw new ny("Input should have rank 5; Received input shape: "+JSON.stringify(e));let t="channelsFirst"===this.dataFormat?1:e.length-1;if(null==e[t])throw new ny("The channel dimension of the inputs should be defined. Found `None`.");let n=e[t],a=this.kernelSize.concat([this.filters,n]);this.kernel=this.addWeight("kernel",a,"float32",this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.filters],"float32",this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint)),this.inputSpec=[new Uw({ndim:5,axes:{[t]:n}})],this.built=!0}call(e,t){return to(()=>{let t=jw(e);if(5!==t.shape.length)throw new ny(`Conv3DTranspose.call() expects input tensor to be rank-4, but received a tensor of rank-${t.shape.length}`);let n,a,r,s=t.shape,i=s[0];"channelsFirst"===this.dataFormat?(r=2,n=3,a=4):(r=1,n=2,a=3);let o=s[r],l=s[n],u=s[a],d=this.kernelSize[0],c=this.kernelSize[1],p=this.kernelSize[2],h=this.strides[0],m=this.strides[1],f=this.strides[2],g=[i,FN(o,h,d,this.padding),FN(l,m,c,this.padding),FN(u,f,p,this.padding),this.filters];"channelsLast"!==this.dataFormat&&(t=eh(t,[0,2,3,4,1]));let x=Iu(t,this.kernel.read(),g,this.strides,this.padding);return"channelsLast"!==this.dataFormat&&(x=eh(x,[0,4,1,2,3])),null!==this.bias&&(x=dw(x,this.bias.read(),this.dataFormat)),null!==this.activation&&(x=this.activation.apply(x)),x})}computeOutputShape(e){let t,n,a,r,s=(e=Lw(e)).slice();"channelsFirst"===this.dataFormat?(t=1,n=2,a=3,r=4):(t=4,n=1,a=2,r=3);let i=this.kernelSize[0],o=this.kernelSize[1],l=this.kernelSize[2],u=this.strides[0],d=this.strides[1],c=this.strides[2];return s[t]=this.filters,s[n]=FN(s[n],u,i,this.padding),s[a]=FN(s[a],d,o,this.padding),s[r]=FN(s[r],c,l,this.padding),s}getConfig(){let e=super.getConfig();return delete e.dilationRate,e}};WN.className="Conv3DTranspose",vm.registerClass(WN);var VN=class extends LN{constructor(e,t){if(super(e,t),this.DEFAULT_DEPTHWISE_INITIALIZER="glorotUniform",this.DEFAULT_POINTWISE_INITIALIZER="glorotUniform",this.depthwiseKernel=null,this.pointwiseKernel=null,null==t.filters)throw new ny("The `filters` configuration field is required by SeparableConv, but is unspecified.");if(null!=t.kernelInitializer||null!=t.kernelRegularizer||null!=t.kernelConstraint)throw new ny("Fields kernelInitializer, kernelRegularizer and kernelConstraint are invalid for SeparableConv2D. Use depthwiseInitializer, depthwiseRegularizer, depthwiseConstraint, pointwiseInitializer, pointwiseRegularizer and pointwiseConstraint instead.");if(null!=t.padding&&"same"!==t.padding&&"valid"!==t.padding)throw new ny(`SeparableConv${this.rank}D supports only padding modes: 'same' and 'valid', but received ${JSON.stringify(t.padding)}`);this.depthMultiplier=null==t.depthMultiplier?1:t.depthMultiplier,this.depthwiseInitializer=Dw(t.depthwiseInitializer||this.DEFAULT_DEPTHWISE_INITIALIZER),this.depthwiseRegularizer=SN(t.depthwiseRegularizer),this.depthwiseConstraint=gv(t.depthwiseConstraint),this.pointwiseInitializer=Dw(t.depthwiseInitializer||this.DEFAULT_POINTWISE_INITIALIZER),this.pointwiseRegularizer=SN(t.pointwiseRegularizer),this.pointwiseConstraint=gv(t.pointwiseConstraint)}build(e){if((e=Lw(e)).length<this.rank+2)throw new ny(`Inputs to SeparableConv${this.rank}D should have rank ${this.rank+2}, but received input shape: ${JSON.stringify(e)}`);let t="channelsFirst"===this.dataFormat?1:e.length-1;if(null==e[t]||e[t]<0)throw new ny(`The channel dimension of the inputs should be defined, but found ${JSON.stringify(e[t])}`);let n=e[t],a=this.kernelSize.concat([n,this.depthMultiplier]),r=[];for(let i=0;i<this.rank;++i)r.push(1);r.push(n*this.depthMultiplier,this.filters);let s=!0;this.depthwiseKernel=this.addWeight("depthwise_kernel",a,"float32",this.depthwiseInitializer,this.depthwiseRegularizer,s,this.depthwiseConstraint),this.pointwiseKernel=this.addWeight("pointwise_kernel",r,"float32",this.pointwiseInitializer,this.pointwiseRegularizer,s,this.pointwiseConstraint),this.useBias?this.bias=this.addWeight("bias",[this.filters],"float32",this.biasInitializer,this.biasRegularizer,s,this.biasConstraint):this.bias=null,this.inputSpec=[new Uw({ndim:this.rank+2,axes:{[t]:n}})],this.built=!0}call(e,t){return to(()=>{let t;if(e=jw(e),1===this.rank)throw new ay("1D separable convolution is not implemented yet.");return 2===this.rank&&("channelsFirst"===this.dataFormat&&(e=eh(e,[0,2,3,1])),t=pp(e,this.depthwiseKernel.read(),this.pointwiseKernel.read(),this.strides,this.padding,this.dilationRate,"NHWC")),this.useBias&&(t=dw(t,this.bias.read(),this.dataFormat)),null!=this.activation&&(t=this.activation.apply(t)),"channelsFirst"===this.dataFormat&&(t=eh(t,[0,3,1,2])),t})}getConfig(){let e=super.getConfig();return delete e.rank,delete e.kernelInitializer,delete e.kernelRegularizer,delete e.kernelConstraint,e.depthwiseInitializer=Fw(this.depthwiseInitializer),e.pointwiseInitializer=Fw(this.pointwiseInitializer),e.depthwiseRegularizer=kN(this.depthwiseRegularizer),e.pointwiseRegularizer=kN(this.pointwiseRegularizer),e.depthwiseConstraint=mv(this.depthwiseConstraint),e.pointwiseConstraint=mv(this.pointwiseConstraint),e}};VN.className="SeparableConv";var UN=class extends VN{constructor(e){super(2,e)}};UN.className="SeparableConv2D",vm.registerClass(UN);var GN=class e extends LN{constructor(t){super(1,t),e.verifyArgs(t),this.inputSpec=[{ndim:3}]}getConfig(){let e=super.getConfig();return delete e.rank,delete e.dataFormat,e}static verifyArgs(e){if("number"!=typeof e.kernelSize&&!vy(e.kernelSize,"number",1,1))throw new ny(`Conv1D expects config.kernelSize to be number or number[] with length 1, but received ${JSON.stringify(e.kernelSize)}.`)}};GN.className="Conv1D",vm.registerClass(GN);var HN=class extends Xw{constructor(e){super(e),"number"==typeof e.cropping?this.cropping=[[e.cropping,e.cropping],[e.cropping,e.cropping]]:"number"==typeof e.cropping[0]?this.cropping=[[e.cropping[0],e.cropping[0]],[e.cropping[1],e.cropping[1]]]:this.cropping=e.cropping,this.dataFormat=void 0===e.dataFormat?"channelsLast":e.dataFormat,this.inputSpec=[{ndim:4}]}computeOutputShape(e){return"channelsFirst"===this.dataFormat?[e[0],e[1],e[2]-this.cropping[0][0]-this.cropping[0][1],e[3]-this.cropping[1][0]-this.cropping[1][1]]:[e[0],e[1]-this.cropping[0][0]-this.cropping[0][1],e[2]-this.cropping[1][0]-this.cropping[1][1],e[3]]}call(e,t){return to(()=>{if(e=jw(e),"channelsLast"===this.dataFormat){let t=tw(e,this.cropping[0][0],e.shape[1]-this.cropping[0][0]-this.cropping[0][1],2);return tw(t,this.cropping[1][0],e.shape[2]-this.cropping[1][1]-this.cropping[1][0],3)}{let t=tw(e,this.cropping[0][0],e.shape[2]-this.cropping[0][0]-this.cropping[0][1],3);return tw(t,this.cropping[1][0],e.shape[3]-this.cropping[1][1]-this.cropping[1][0],4)}})}getConfig(){let e={cropping:this.cropping,dataFormat:this.dataFormat},t=super.getConfig();return Object.assign(e,t),e}};HN.className="Cropping2D",vm.registerClass(HN);var qN=class extends Xw{constructor(e){super(e),this.DEFAULT_SIZE=[2,2],this.inputSpec=[{ndim:4}],this.size=null==e.size?this.DEFAULT_SIZE:e.size,this.dataFormat=null==e.dataFormat?"channelsLast":e.dataFormat,My(this.dataFormat),this.interpolation=null==e.interpolation?"nearest":e.interpolation,function(e){wy(Ay,"InterpolationFormat",e)}(this.interpolation)}computeOutputShape(e){if("channelsFirst"===this.dataFormat){let t=null==e[2]?null:this.size[0]*e[2],n=null==e[3]?null:this.size[1]*e[3];return[e[0],e[1],t,n]}{let t=null==e[1]?null:this.size[0]*e[1],n=null==e[2]?null:this.size[1]*e[2];return[e[0],t,n,e[3]]}}call(e,t){return to(()=>{let t=jw(e),n=t.shape;if("channelsFirst"===this.dataFormat){t=eh(t,[0,2,3,1]);let e=this.size[0]*n[2],a=this.size[1]*n[3],r="nearest"===this.interpolation?gm.resizeNearestNeighbor(t,[e,a]):gm.resizeBilinear(t,[e,a]);return eh(r,[0,3,1,2])}{let e=this.size[0]*n[1],a=this.size[1]*n[2];return"nearest"===this.interpolation?gm.resizeNearestNeighbor(t,[e,a]):gm.resizeBilinear(t,[e,a])}})}getConfig(){let e={size:this.size,dataFormat:this.dataFormat,interpolation:this.interpolation},t=super.getConfig();return Object.assign(e,t),e}};qN.className="UpSampling2D",vm.registerClass(qN);var KN=class extends jN{constructor(e){super(2,e),this.depthwiseKernel=null,this.depthMultiplier=null==e.depthMultiplier?1:e.depthMultiplier,this.depthwiseInitializer=Dw(e.depthwiseInitializer||this.DEFAULT_KERNEL_INITIALIZER),this.depthwiseConstraint=gv(e.depthwiseConstraint),this.depthwiseRegularizer=SN(e.depthwiseRegularizer)}build(e){if((e=Lw(e)).length<4)throw new ny(`Inputs to DepthwiseConv2D should have rank 4. Received input shape: ${JSON.stringify(e)}.`);let t="channelsFirst"===this.dataFormat?1:3;if(null==e[t]||e[t]<0)throw new ny(`The channel dimension of the inputs to DepthwiseConv2D should be defined, but is not (${e[t]}).`);let n=e[t],a=[this.kernelSize[0],this.kernelSize[1],n,this.depthMultiplier];this.depthwiseKernel=this.addWeight("depthwise_kernel",a,null,this.depthwiseInitializer,this.depthwiseRegularizer,!0,this.depthwiseConstraint),this.useBias?this.bias=this.addWeight("bias",[n*this.depthMultiplier],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0}call(e,t){return to(()=>{let t=function(e,t,n=[1,1],a="valid",r,s){return to(()=>{null==r&&(r="channelsLast"),My(r);let i=DN(e,r);if(4!==e.rank)throw new ny(`Input for depthwiseConv2d is required to be 4-D, but is instead ${e.rank}-D`);if(4!==t.rank)throw new ny(`depthwiseKernel is required to be 4-D, but is instead ${t.rank}-D`);return i=Ru(i,t,n,"same"===a?"same":"valid","NHWC",s),"channelsFirst"===r&&(i=eh(i,[0,3,1,2])),i})}(e=jw(e),this.depthwiseKernel.read(),this.strides,this.padding,this.dataFormat,null);return this.useBias&&(t=dw(t,this.bias.read(),this.dataFormat)),null!=this.activation&&(t=this.activation.apply(t)),t})}computeOutputShape(e){e=Lw(e);let t="channelsFirst"===this.dataFormat?e[2]:e[1],n="channelsFirst"===this.dataFormat?e[3]:e[2],a="channelsFirst"===this.dataFormat?e[1]*this.depthMultiplier:e[3]*this.depthMultiplier,r=RN(t,this.kernelSize[0],this.padding,this.strides[0]),s=RN(n,this.kernelSize[1],this.padding,this.strides[1]);return"channelsFirst"===this.dataFormat?[e[0],a,r,s]:[e[0],r,s,a]}getConfig(){let e=super.getConfig();return e.depthMultiplier=this.depthMultiplier,e.depthwiseInitializer=Fw(this.depthwiseInitializer),e.depthwiseRegularizer=kN(this.depthwiseRegularizer),e.depthwiseConstraint=mv(this.depthwiseRegularizer),e}};function XN(e,t,n,a){if(Array.isArray(e)){if(null!=t||null!=n)throw new ny("When inputs is an array, neither initialState or constants should be provided");null!=a&&(n=e.slice(e.length-a,e.length),e=e.slice(0,e.length-a)),e.length>1&&(t=e.slice(1,e.length)),e=e[0]}function r(e){return null==e||Array.isArray(e)?e:[e]}return{inputs:e,initialState:t=r(t),constants:n=r(n)}}function YN(e,t,n,a=!1,r,s,i=!1,o=!1){return to(()=>{let s=t.shape.length;if(s<3)throw new ny(`Input should be at least 3D, but is ${s}D.`);let i=[1,0].concat(Xy(2,s));t=eh(t,i),null!=r&&((r=pl(pl(r,"bool"),"float32")).rank===s-1&&(r=hd(r,-1)),r=eh(r,i)),a&&(t=rp(t,0),null!=r&&(r=rp(r,0)));let l,u,d,c=[],p=n,h=t.shape[0],m=Kp(t);null!=r&&(u=Kp(r));for(let t=0;t<h;++t){let n=m[t],a=to(()=>e(n,p));if(null==r)l=a[0],p=a[1];else{let e=to(()=>{let e=u[t],n=Wd(mc(e),e);return{output:fl(bl(a[0],e),bl(p[0],n)),newStates:p.map((t,r)=>fl(bl(a[1][r],e),bl(t,n)))}});l=e.output,p=e.newStates}o&&c.push(l)}return o&&(d=Ep(c,1)),[l,d,p]})}KN.className="DepthwiseConv2D",vm.registerClass(KN);var ZN=class e extends Xw{constructor(e){let t;if(super(e),null==e.cell)throw new ny("cell property is missing for the constructor of RNN.");if(t=Array.isArray(e.cell)?new sS({cells:e.cell}):e.cell,null==t.stateSize)throw new ny("The RNN cell should have an attribute `stateSize` (tuple of integers, one integer per RNN state).");this.cell=t,this.returnSequences=null!=e.returnSequences&&e.returnSequences,this.returnState=null!=e.returnState&&e.returnState,this.goBackwards=null!=e.goBackwards&&e.goBackwards,this._stateful=null!=e.stateful&&e.stateful,this.unroll=null!=e.unroll&&e.unroll,this.supportsMasking=!0,this.inputSpec=[new Uw({ndim:3})],this.stateSpec=null,this.states_=null,this.numConstants=null,this.keptStates=[]}getStates(){return null==this.states_?Xy(0,Array.isArray(this.cell.stateSize)?this.cell.stateSize.length:1).map(e=>null):this.states_}setStates(e){this.states_=e}computeOutputShape(e){Mw(e)&&(e=e[0]);let t=this.cell.stateSize;Array.isArray(t)||(t=[t]);let n,a=t[0];if(n=this.returnSequences?[e[0],e[1],a]:[e[0],a],this.returnState){let a=[];for(let n of t)a.push([e[0],n]);return[n].concat(a)}return n}computeMask(e,t){return to(()=>{Array.isArray(t)&&(t=t[0]);let e=this.returnSequences?t:null;if(this.returnState){let t=this.states.map(e=>null);return[e].concat(t)}return e})}get states(){if(null==this.states_){let e=Array.isArray(this.cell.stateSize)?this.cell.stateSize.length:1,t=[];for(let n=0;n<e;++n)t.push(null);return t}return this.states_}set states(e){this.states_=e}build(e){if(null!=this.numConstants)throw new ay("Constants support is not implemented in RNN yet.");Mw(e)&&(e=e[0]);let t=this.stateful?e[0]:null,n=e.slice(2);this.inputSpec[0]=new Uw({shape:[t,null,...n]});let a,r=[e[0]].concat(e.slice(2));if(this.cell.build(r),a=Array.isArray(this.cell.stateSize)?this.cell.stateSize:[this.cell.stateSize],null!=this.stateSpec){if(!Ns.arraysEqual(this.stateSpec.map(e=>e.shape[e.shape.length-1]),a))throw new ny(`An initialState was passed that is not compatible with cell.stateSize. Received stateSpec=${this.stateSpec}; However cell.stateSize is ${this.cell.stateSize}`)}else this.stateSpec=a.map(e=>new Uw({shape:[null,e]}));this.stateful&&this.resetStates()}resetStates(e,t=!1){to(()=>{if(!this.stateful)throw new ey("Cannot call resetStates() on an RNN Layer that is not stateful.");let n=this.inputSpec[0].shape[0];if(null==n)throw new ny("If an RNN is stateful, it needs to know its batch size. Specify the batch size of your input tensors: \n- If using a Sequential model, specify the batch size by passing a `batchInputShape` option to your first layer.\n- If using the functional API, specify the batch size by passing a `batchShape` option to your Input layer.");if(null==this.states_)Array.isArray(this.cell.stateSize)?this.states_=this.cell.stateSize.map(e=>ac([n,e])):this.states_=[ac([n,this.cell.stateSize])];else if(null==e)no(this.states_),null!=this.keptStates&&(no(this.keptStates),this.keptStates=[]),Array.isArray(this.cell.stateSize)?this.states_=this.cell.stateSize.map(e=>ac([n,e])):this.states_[0]=ac([n,this.cell.stateSize]);else{if(Array.isArray(e)||(e=[e]),e.length!==this.states_.length)throw new ny(`Layer ${this.name} expects ${this.states_.length} state(s), but it received ${e.length} state value(s). Input received: ${e}`);!0===t?this.keptStates.push(this.states_.slice()):no(this.states_);for(let t=0;t<this.states_.length;++t){let a=e[t],r=Array.isArray(this.cell.stateSize)?this.cell.stateSize[t]:this.cell.stateSize,s=[n,r];if(!Ns.arraysEqual(a.shape,s))throw new ny(`State ${t} is incompatible with layer ${this.name}: expected shape=${s}, received shape=${a.shape}`);this.states_[t]=a}}this.states_=this.states_.map(e=>ao(e.clone()))})}apply(e,t){let n=null==t?null:t.initialState,a=null==t?null:t.constants;null==t&&(t={});let r=XN(e,n,a,this.numConstants);e=r.inputs,n=r.initialState,a=r.constants;let s=[],i=[];if(null!=n){t.initialState=n,s=s.concat(n),this.stateSpec=[];for(let e of n)this.stateSpec.push(new Uw({shape:e.shape}));i=i.concat(this.stateSpec)}if(null!=a&&(t.constants=a,s=s.concat(a),this.numConstants=a.length),s[0]instanceof Gw){let n=[e].concat(s),a=this.inputSpec.concat(i),r=this.inputSpec;this.inputSpec=a;let o=super.apply(n,t);return this.inputSpec=r,o}return super.apply(e,t)}call(e,t){return to(()=>{let n=null==t?null:t.mask,a=null==t?null:t.training,r=null==t?null:t.initialState;e=jw(e),null==r&&(r=this.stateful?this.states_:this.getInitialState(e));let s=Array.isArray(this.cell.stateSize)?this.cell.stateSize.length:1;if(r.length!==s)throw new ny(`RNN Layer has ${s} state(s) but was passed ${r.length} initial state(s).`);this.unroll;let i={training:a},o=YN((e,t)=>{let n=this.cell.call([e].concat(t),i);return[n[0],n.slice(1)]},e,r,this.goBackwards,n,0,this.unroll,this.returnSequences),l=o[0],u=o[1],d=o[2];this.stateful&&this.resetStates(d,a);let c=this.returnSequences?u:l;return this.returnState?[c].concat(d):c})}getInitialState(e){return to(()=>{let t=ac(e.shape);return t=ld(t,[1,2]),t=Jy(t),Array.isArray(this.cell.stateSize)?this.cell.stateSize.map(e=>e>1?rw(t,[1,e]):t):this.cell.stateSize>1?[rw(t,[1,this.cell.stateSize])]:[t]})}get trainableWeights(){return this.trainable?this.cell.trainableWeights:[]}get nonTrainableWeights(){return this.trainable?this.cell.nonTrainableWeights:this.cell.weights}setFastWeightInitDuringBuild(e){super.setFastWeightInitDuringBuild(e),null!=this.cell&&this.cell.setFastWeightInitDuringBuild(e)}getConfig(){let t=super.getConfig(),n={returnSequences:this.returnSequences,returnState:this.returnState,goBackwards:this.goBackwards,stateful:this.stateful,unroll:this.unroll};null!=this.numConstants&&(n.numConstants=this.numConstants);let a=this.cell.getConfig();return this.getClassName()===e.className&&(n.cell={className:this.cell.getClassName(),config:a}),Object.assign(Object.assign(Object.assign({},a),t),n)}static fromConfig(e,t,n={}){let a=Xv(t.cell,n);return new e(Object.assign(t,{cell:a}))}};ZN.className="RNN",vm.registerClass(ZN);var JN=class extends Xw{},QN=class extends JN{constructor(e){super(e),this.DEFAULT_ACTIVATION="tanh",this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",this.DEFAULT_RECURRENT_INITIALIZER="orthogonal",this.DEFAULT_BIAS_INITIALIZER="zeros",this.units=e.units,ky(this.units,"units"),this.activation=xN(null==e.activation?this.DEFAULT_ACTIVATION:e.activation),this.useBias=null==e.useBias||e.useBias,this.kernelInitializer=Dw(e.kernelInitializer||this.DEFAULT_KERNEL_INITIALIZER),this.recurrentInitializer=Dw(e.recurrentInitializer||this.DEFAULT_RECURRENT_INITIALIZER),this.biasInitializer=Dw(e.biasInitializer||this.DEFAULT_BIAS_INITIALIZER),this.kernelRegularizer=SN(e.kernelRegularizer),this.recurrentRegularizer=SN(e.recurrentRegularizer),this.biasRegularizer=SN(e.biasRegularizer),this.kernelConstraint=gv(e.kernelConstraint),this.recurrentConstraint=gv(e.recurrentConstraint),this.biasConstraint=gv(e.biasConstraint),this.dropout=qy([1,Ky([0,null==e.dropout?0:e.dropout])]),this.recurrentDropout=qy([1,Ky([0,null==e.recurrentDropout?0:e.recurrentDropout])]),this.dropoutFunc=e.dropoutFunc,this.stateSize=this.units,this.dropoutMask=null,this.recurrentDropoutMask=null}build(e){e=Lw(e),this.kernel=this.addWeight("kernel",[e[e.length-1],this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias?this.bias=this.addWeight("bias",[this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0}call(e,t){return to(()=>{if(2!==e.length)throw new ny(`SimpleRNNCell expects 2 input Tensors, got ${e.length}.`);let n=e[1];e=e[0];let a=null!=t.training&&t.training;0<this.dropout&&this.dropout<1&&null==this.dropoutMask&&(this.dropoutMask=iS({ones:()=>mc(e),rate:this.dropout,training:a,dropoutFunc:this.dropoutFunc})),0<this.recurrentDropout&&this.recurrentDropout<1&&null==this.recurrentDropoutMask&&(this.recurrentDropoutMask=iS({ones:()=>mc(n),rate:this.recurrentDropout,training:a,dropoutFunc:this.dropoutFunc}));let r,s=this.dropoutMask,i=this.recurrentDropoutMask;r=iw(null!=s?bl(e,s):e,this.kernel.read()),null!=this.bias&&(r=dw(r,this.bias.read())),null!=i&&(n=bl(n,i));let o=fl(r,iw(n,this.recurrentKernel.read()));return null!=this.activation&&(o=this.activation.apply(o)),[o,o]})}getConfig(){let e=super.getConfig(),t={units:this.units,activation:fN(this.activation),useBias:this.useBias,kernelInitializer:Fw(this.kernelInitializer),recurrentInitializer:Fw(this.recurrentInitializer),biasInitializer:Fw(this.biasInitializer),kernelRegularizer:kN(this.kernelRegularizer),recurrentRegularizer:kN(this.recurrentRegularizer),biasRegularizer:kN(this.biasRegularizer),activityRegularizer:kN(this.activityRegularizer),kernelConstraint:mv(this.kernelConstraint),recurrentConstraint:mv(this.recurrentConstraint),biasConstraint:mv(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout};return Object.assign(Object.assign({},e),t)}};QN.className="SimpleRNNCell",vm.registerClass(QN);var eS=class extends ZN{constructor(e){e.cell=new QN(e),super(e)}call(e,t){return to(()=>{null!=this.cell.dropoutMask&&(no(this.cell.dropoutMask),this.cell.dropoutMask=null),null!=this.cell.recurrentDropoutMask&&(no(this.cell.recurrentDropoutMask),this.cell.recurrentDropoutMask=null);let n=null==t?null:t.mask,a=null==t?null:t.training,r=null==t?null:t.initialState;return super.call(e,{mask:n,training:a,initialState:r})})}static fromConfig(e,t){return new e(t)}};eS.className="SimpleRNN",vm.registerClass(eS);var tS=class extends JN{constructor(e){if(super(e),this.DEFAULT_ACTIVATION="tanh",this.DEFAULT_RECURRENT_ACTIVATION="hardSigmoid",this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",this.DEFAULT_RECURRENT_INITIALIZER="orthogonal",this.DEFAULT_BIAS_INITIALIZER="zeros",e.resetAfter)throw new ny("GRUCell does not support reset_after parameter set to true.");this.units=e.units,ky(this.units,"units"),this.activation=xN(void 0===e.activation?this.DEFAULT_ACTIVATION:e.activation),this.recurrentActivation=xN(void 0===e.recurrentActivation?this.DEFAULT_RECURRENT_ACTIVATION:e.recurrentActivation),this.useBias=null==e.useBias||e.useBias,this.kernelInitializer=Dw(e.kernelInitializer||this.DEFAULT_KERNEL_INITIALIZER),this.recurrentInitializer=Dw(e.recurrentInitializer||this.DEFAULT_RECURRENT_INITIALIZER),this.biasInitializer=Dw(e.biasInitializer||this.DEFAULT_BIAS_INITIALIZER),this.kernelRegularizer=SN(e.kernelRegularizer),this.recurrentRegularizer=SN(e.recurrentRegularizer),this.biasRegularizer=SN(e.biasRegularizer),this.kernelConstraint=gv(e.kernelConstraint),this.recurrentConstraint=gv(e.recurrentConstraint),this.biasConstraint=gv(e.biasConstraint),this.dropout=qy([1,Ky([0,null==e.dropout?0:e.dropout])]),this.recurrentDropout=qy([1,Ky([0,null==e.recurrentDropout?0:e.recurrentDropout])]),this.dropoutFunc=e.dropoutFunc,this.implementation=e.implementation,this.stateSize=this.units,this.dropoutMask=null,this.recurrentDropoutMask=null}build(e){let t=(e=Lw(e))[e.length-1];this.kernel=this.addWeight("kernel",[t,3*this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,3*this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias?this.bias=this.addWeight("bias",[3*this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint):this.bias=null,this.built=!0}call(e,t){return to(()=>{if(2!==e.length)throw new ny(`GRUCell expects 2 input Tensors (inputs, h, c), got ${e.length}.`);let n=null!=t.training&&t.training,a=e[1];e=e[0],0<this.dropout&&this.dropout<1&&null==this.dropoutMask&&(this.dropoutMask=iS({ones:()=>mc(e),rate:this.dropout,training:n,count:3,dropoutFunc:this.dropoutFunc})),0<this.recurrentDropout&&this.recurrentDropout<1&&null==this.recurrentDropoutMask&&(this.recurrentDropoutMask=iS({ones:()=>mc(a),rate:this.recurrentDropout,training:n,count:3,dropoutFunc:this.dropoutFunc}));let r,s,i,o=this.dropoutMask,l=this.recurrentDropoutMask;0<this.dropout&&this.dropout<1&&(e=bl(e,o[0]));let u=iw(e,this.kernel.read());this.useBias&&(u=dw(u,this.bias.read())),0<this.recurrentDropout&&this.recurrentDropout<1&&(a=bl(a,l[0]));let d=this.recurrentKernel.read(),[c,p]=Ip(d,[2*this.units,this.units],d.rank-1),h=iw(a,c),[m,f,g]=Ip(u,3,u.rank-1),[x,b]=Ip(h,2,h.rank-1);r=this.recurrentActivation.apply(fl(m,x)),s=this.recurrentActivation.apply(fl(f,b));let y=iw(bl(s,a),p);i=this.activation.apply(fl(g,y));let w=fl(bl(r,a),bl(fl(1,zd(r)),i));return[w,w]})}getConfig(){let e=super.getConfig(),t={units:this.units,activation:fN(this.activation),recurrentActivation:fN(this.recurrentActivation),useBias:this.useBias,kernelInitializer:Fw(this.kernelInitializer),recurrentInitializer:Fw(this.recurrentInitializer),biasInitializer:Fw(this.biasInitializer),kernelRegularizer:kN(this.kernelRegularizer),recurrentRegularizer:kN(this.recurrentRegularizer),biasRegularizer:kN(this.biasRegularizer),activityRegularizer:kN(this.activityRegularizer),kernelConstraint:mv(this.kernelConstraint),recurrentConstraint:mv(this.recurrentConstraint),biasConstraint:mv(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation,resetAfter:!1};return Object.assign(Object.assign({},e),t)}};tS.className="GRUCell",vm.registerClass(tS);var nS=class extends ZN{constructor(e){e.implementation,e.cell=new tS(e),super(e)}call(e,t){return to(()=>{null!=this.cell.dropoutMask&&(no(this.cell.dropoutMask),this.cell.dropoutMask=null),null!=this.cell.recurrentDropoutMask&&(no(this.cell.recurrentDropoutMask),this.cell.recurrentDropoutMask=null);let n=null==t?null:t.mask,a=null==t?null:t.training,r=null==t?null:t.initialState;return super.call(e,{mask:n,training:a,initialState:r})})}static fromConfig(e,t){return 0===t.implmentation&&(t.implementation=1),new e(t)}};nS.className="GRU",vm.registerClass(nS);var aS=class extends JN{constructor(e){super(e),this.DEFAULT_ACTIVATION="tanh",this.DEFAULT_RECURRENT_ACTIVATION="hardSigmoid",this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",this.DEFAULT_RECURRENT_INITIALIZER="orthogonal",this.DEFAULT_BIAS_INITIALIZER="zeros",this.units=e.units,ky(this.units,"units"),this.activation=xN(void 0===e.activation?this.DEFAULT_ACTIVATION:e.activation),this.recurrentActivation=xN(void 0===e.recurrentActivation?this.DEFAULT_RECURRENT_ACTIVATION:e.recurrentActivation),this.useBias=null==e.useBias||e.useBias,this.kernelInitializer=Dw(e.kernelInitializer||this.DEFAULT_KERNEL_INITIALIZER),this.recurrentInitializer=Dw(e.recurrentInitializer||this.DEFAULT_RECURRENT_INITIALIZER),this.biasInitializer=Dw(e.biasInitializer||this.DEFAULT_BIAS_INITIALIZER),this.unitForgetBias=e.unitForgetBias,this.kernelRegularizer=SN(e.kernelRegularizer),this.recurrentRegularizer=SN(e.recurrentRegularizer),this.biasRegularizer=SN(e.biasRegularizer),this.kernelConstraint=gv(e.kernelConstraint),this.recurrentConstraint=gv(e.recurrentConstraint),this.biasConstraint=gv(e.biasConstraint),this.dropout=qy([1,Ky([0,null==e.dropout?0:e.dropout])]),this.recurrentDropout=qy([1,Ky([0,null==e.recurrentDropout?0:e.recurrentDropout])]),this.dropoutFunc=e.dropoutFunc,this.implementation=e.implementation,this.stateSize=[this.units,this.units],this.dropoutMask=null,this.recurrentDropoutMask=null}build(e){var t;let n,a=(e=Lw(e))[e.length-1];if(this.kernel=this.addWeight("kernel",[a,4*this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.recurrentKernel=this.addWeight("recurrent_kernel",[this.units,4*this.units],null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias){if(this.unitForgetBias){let e=this.biasInitializer,a=this.units;n=new((t=class extends fw{apply(t,n){let r=e.apply([a]),s=(new xw).apply([a]),i=e.apply([2*a]);return aw(aw(r,s),i)}}).className="CustomInit",t)}else n=this.biasInitializer;this.bias=this.addWeight("bias",[4*this.units],null,n,this.biasRegularizer,!0,this.biasConstraint)}else this.bias=null;this.built=!0}call(e,t){return to(()=>{let n=null!=t.training&&t.training;if(3!==e.length)throw new ny(`LSTMCell expects 3 input Tensors (inputs, h, c), got ${e.length}.`);let a=e[1],r=e[2];e=e[0],0<this.dropout&&this.dropout<1&&null==this.dropoutMask&&(this.dropoutMask=iS({ones:()=>mc(e),rate:this.dropout,training:n,count:4,dropoutFunc:this.dropoutFunc})),0<this.recurrentDropout&&this.recurrentDropout<1&&null==this.recurrentDropoutMask&&(this.recurrentDropoutMask=iS({ones:()=>mc(a),rate:this.recurrentDropout,training:n,count:4,dropoutFunc:this.dropoutFunc}));let s,i,o,l,u=this.dropoutMask,d=this.recurrentDropoutMask;0<this.dropout&&this.dropout<1&&(e=bl(e,u[0]));let c=iw(e,this.kernel.read());0<this.recurrentDropout&&this.recurrentDropout<1&&(a=bl(a,d[0])),c=fl(c,iw(a,this.recurrentKernel.read())),this.useBias&&(c=dw(c,this.bias.read()));let[p,h,m,f]=Ip(c,4,c.rank-1);s=this.recurrentActivation.apply(p),i=this.recurrentActivation.apply(h),o=fl(bl(i,r),bl(s,this.activation.apply(m))),l=this.recurrentActivation.apply(f);let g=bl(l,this.activation.apply(o));return[g,g,o]})}getConfig(){let e=super.getConfig(),t={units:this.units,activation:fN(this.activation),recurrentActivation:fN(this.recurrentActivation),useBias:this.useBias,kernelInitializer:Fw(this.kernelInitializer),recurrentInitializer:Fw(this.recurrentInitializer),biasInitializer:Fw(this.biasInitializer),unitForgetBias:this.unitForgetBias,kernelRegularizer:kN(this.kernelRegularizer),recurrentRegularizer:kN(this.recurrentRegularizer),biasRegularizer:kN(this.biasRegularizer),activityRegularizer:kN(this.activityRegularizer),kernelConstraint:mv(this.kernelConstraint),recurrentConstraint:mv(this.recurrentConstraint),biasConstraint:mv(this.biasConstraint),dropout:this.dropout,recurrentDropout:this.recurrentDropout,implementation:this.implementation};return Object.assign(Object.assign({},e),t)}};aS.className="LSTMCell",vm.registerClass(aS);var rS=class extends ZN{constructor(e){e.implementation,e.cell=new aS(e),super(e)}call(e,t){return to(()=>{null!=this.cell.dropoutMask&&(no(this.cell.dropoutMask),this.cell.dropoutMask=null),null!=this.cell.recurrentDropoutMask&&(no(this.cell.recurrentDropoutMask),this.cell.recurrentDropoutMask=null);let n=null==t?null:t.mask,a=null==t?null:t.training,r=null==t?null:t.initialState;return super.call(e,{mask:n,training:a,initialState:r})})}static fromConfig(e,t){return 0===t.implmentation&&(t.implementation=1),new e(t)}};rS.className="LSTM",vm.registerClass(rS);var sS=class extends JN{constructor(e){super(e),this.cells=e.cells}get stateSize(){let e=[];for(let t of this.cells.slice().reverse())Array.isArray(t.stateSize)?e.push(...t.stateSize):e.push(t.stateSize);return e}call(e,t){return to(()=>{let n=e.slice(1),a=[];for(let e of this.cells.slice().reverse())Array.isArray(e.stateSize)?a.push(n.splice(0,e.stateSize.length)):a.push(n.splice(0,1));a.reverse();let r,s=[];for(let i=0;i<this.cells.length;++i){let o=this.cells[i];n=a[i],r=0===i?[e[0]].concat(n):[r[0]].concat(n),r=o.call(r,t),s.push(r.slice(1))}n=[];for(let e of s.slice().reverse())n.push(...e);return[r[0]].concat(n)})}build(e){let t;Mw(e)&&(e=e[0]),this.cells.forEach((n,a)=>{zy(`RNNCell_${a}`,()=>{n.build(e),t=Array.isArray(n.stateSize)?n.stateSize[0]:n.stateSize,e=[e[0],t]})}),this.built=!0}getConfig(){let e=super.getConfig(),t={cells:this.cells.map(e=>({className:e.getClassName(),config:e.getConfig()}))};return Object.assign(Object.assign({},e),t)}static fromConfig(e,t,n={}){let a=[];for(let r of t.cells)a.push(Xv(r,n));return new e({cells:a})}get trainableWeights(){if(!this.trainable)return[];let e=[];for(let t of this.cells)e.push(...t.trainableWeights);return e}get nonTrainableWeights(){let e=[];for(let t of this.cells)e.push(...t.nonTrainableWeights);if(!this.trainable){let t=[];for(let e of this.cells)t.push(...e.trainableWeights);return t.concat(e)}return e}getWeights(){let e=[];for(let t of this.cells)e.push(...t.weights);return Ww(e)}setWeights(e){let t=[];for(let n of this.cells){let a=n.weights.length,r=e.splice(a);for(let e=0;e<n.weights.length;++e)t.push([n.weights[e],r[e]])}Vw(t)}};function iS(e){let{ones:t,rate:n,training:a=!1,count:r=1,dropoutFunc:s}=e,i=()=>null!=s?s(t(),n):cw(t(),n),o=()=>pw(i,t,a);return!r||r<=1?ao(o().clone()):Array(r).fill(void 0).map(o).map(e=>ao(e.clone()))}sS.className="StackedRNNCells",vm.registerClass(sS);var oS=class extends ZN{constructor(e){if(e.unroll)throw new ay("Unrolling is not possible with convolutional RNNs.");if(Array.isArray(e.cell))throw new ay("It is not possible at the moment to stack convolutional cells.");super(e),this.inputSpec=[new Uw({ndim:5})]}call(e,t){return to(()=>{if(null!=this.cell.dropoutMask&&(no(this.cell.dropoutMask),this.cell.dropoutMask=null),null!=this.cell.recurrentDropoutMask&&(no(this.cell.recurrentDropoutMask),this.cell.recurrentDropoutMask=null),t&&t.constants)throw new ny("ConvRNN2D cell does not support constants");let n=null==t?null:t.mask,a=null==t?null:t.training,r=null==t?null:t.initialState;return super.call(e,{mask:n,training:a,initialState:r})})}computeOutputShape(e){let t=this.computeSingleOutputShape(e);return this.returnSequences||(t=[t[0],...t.slice(2)]),this.returnState&&(t=[t,...Array(2).fill([e[0],...t.slice(-3)])]),t}getInitialState(e){return to(()=>{let{stateSize:t}=this.cell,n=e.shape,a=this.computeSingleOutputShape(n),r=ac([a[0],...a.slice(2)]);return Array.isArray(t)?Array(t.length).fill(r):[r]})}resetStates(e,t=!1){to(()=>{if(!this.stateful)throw new ey("Cannot call resetStates() on an RNN Layer that is not stateful.");let n=this.inputSpec[0].shape,a=this.computeSingleOutputShape(n),r=[a[0],...a.slice(2)];if(null==n[0])throw new ny("If an RNN is stateful, it needs to know its batch size. Specify the batch size of your input tensors: \n- If using a Sequential model, specify the batch size by passing a `batchInputShape` option to your first layer.\n- If using the functional API, specify the batch size by passing a `batchShape` option to your Input layer.");if(null==this.getStates())Array.isArray(this.cell.stateSize)?this.states_=this.cell.stateSize.map(()=>ac(r)):this.states_=[ac(r)];else if(null==e)no(this.states_),null!=this.keptStates&&(no(this.keptStates),this.keptStates=[]),Array.isArray(this.cell.stateSize)?this.states_=this.cell.stateSize.map(()=>ac(r)):this.states_[0]=ac(r);else{if(Array.isArray(e)||(e=[e]),e.length!==this.states_.length)throw new ny(`Layer ${this.name} expects ${this.states_.length} state(s), but it received ${e.length} state value(s). Input received: ${e}`);t?this.keptStates.push(this.states_.slice()):no(this.states_);for(let t=0;t<this.states_.length;++t){let n=e[t],a=r;if(!Ns.arraysEqual(n.shape,a))throw new ny(`State ${t} is incompatible with layer ${this.name}: expected shape=${a}, received shape=${n.shape}`);this.states_[t]=n}}this.states_=this.states_.map(e=>ao(e.clone()))})}computeSingleOutputShape(e){let{dataFormat:t,filters:n,kernelSize:a,padding:r,strides:s,dilationRate:i}=this.cell,o="channelsFirst"===t,l=e[o?3:2],u=e[o?4:3],d=RN(l,a[0],r,s[0],i[0]),c=RN(u,a[1],r,s[1],i[1]);return[...e.slice(0,2),...o?[n,d,c]:[d,c,n]]}};oS.className="ConvRNN2D";var lS=class extends aS{constructor(e){let{filters:t,kernelSize:n,strides:a,padding:r,dataFormat:s,dilationRate:i}=e;super(Object.assign(Object.assign({},e),{units:t})),this.filters=t,ky(this.filters,"filters"),this.kernelSize=$N(n,2,"kernelSize"),this.kernelSize.forEach(e=>ky(e,"kernelSize")),this.strides=$N(a||1,2,"strides"),this.strides.forEach(e=>ky(e,"strides")),this.padding=r||"valid",Oy(this.padding),this.dataFormat=s||"channelsLast",My(this.dataFormat),this.dilationRate=$N(i||1,2,"dilationRate"),this.dilationRate.forEach(e=>ky(e,"dilationRate"))}build(e){var t;e=Lw(e);let n="channelsFirst"===this.dataFormat?1:e.length-1;if(null==e[n])throw new ny(`The channel dimension of the input should be defined. Found ${e[n]}`);let a=e[n],r=this.kernelSize.concat([a,4*this.filters]);this.kernel=this.addWeight("kernel",r,null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint);let s=this.kernelSize.concat([this.filters,4*this.filters]);if(this.recurrentKernel=this.addWeight("recurrent_kernel",s,null,this.recurrentInitializer,this.recurrentRegularizer,!0,this.recurrentConstraint),this.useBias){let e;if(this.unitForgetBias){let n=this.biasInitializer,a=this.filters;e=new((t=class extends fw{apply(e,t){return nw([n.apply([a]),rc([a]),n.apply([2*a])])}}).className="CustomInit",t)}else e=this.biasInitializer;this.bias=this.addWeight("bias",[4*this.filters],null,e,this.biasRegularizer,!0,this.biasConstraint)}this.built=!0}call(e,t){return to(()=>{if(3!==e.length)throw new ny(`ConvLSTM2DCell expects 3 input Tensors (inputs, h, c), got ${e.length}.`);let n=t.training||!1,a=e[0],r=e[1],s=e[2];0<this.dropout&&this.dropout<1&&null==this.dropoutMask&&(this.dropoutMask=iS({ones:()=>mc(a),rate:this.dropout,training:n,count:4,dropoutFunc:this.dropoutFunc}));let i=this.dropoutMask,o=(e,t,n)=>t&&t[n]?bl(t[n],e):e,l=o(a,i,0),u=o(a,i,1),d=o(a,i,2),c=o(a,i,3);0<this.recurrentDropout&&this.recurrentDropout<1&&null==this.recurrentDropoutMask&&(this.recurrentDropoutMask=iS({ones:()=>mc(r),rate:this.recurrentDropout,training:n,count:4,dropoutFunc:this.dropoutFunc}));let p=this.recurrentDropoutMask,h=o(r,p,0),m=o(r,p,1),f=o(r,p,2),g=o(r,p,3),[x,b,y,w]=Ip(this.kernel.read(),4,3),[v,k,N,S]=this.useBias?Ip(this.bias.read(),4):[null,null,null,null];l=this.inputConv(l,x,v,this.padding),u=this.inputConv(u,b,k,this.padding),d=this.inputConv(d,y,N,this.padding),c=this.inputConv(c,w,S,this.padding);let[I,_,C,T]=Ip(this.recurrentKernel.read(),4,3);h=this.recurrentConv(h,I),m=this.recurrentConv(m,_),f=this.recurrentConv(f,C),g=this.recurrentConv(g,T);let E=this.recurrentActivation.apply(fl(l,h)),A=this.recurrentActivation.apply(fl(u,m)),$=fl(bl(A,s),bl(E,this.activation.apply(fl(d,f)))),R=bl(this.recurrentActivation.apply(fl(c,g)),this.activation.apply($));return[R,R,$]})}getConfig(){let e=super.getConfig(),{units:t}=e,n=function(e,t){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(a=Object.getOwnPropertySymbols(e);r<a.length;r++)t.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(e,a[r])&&(n[a[r]]=e[a[r]])}return n}(e,["units"]),a={filters:this.filters,kernelSize:this.kernelSize,padding:this.padding,dataFormat:this.dataFormat,dilationRate:this.dilationRate,strides:this.strides};return Object.assign(Object.assign({},n),a)}inputConv(e,t,n,a){let r=yu(e,t,this.strides,a||"valid","channelsFirst"===this.dataFormat?"NCHW":"NHWC",this.dilationRate);return n?dw(r,n,this.dataFormat):r}recurrentConv(e,t){return yu(e,t,1,"same","channelsFirst"===this.dataFormat?"NCHW":"NHWC")}};lS.className="ConvLSTM2DCell",vm.registerClass(lS);var uS=class extends oS{constructor(e){let t=new lS(e);super(Object.assign(Object.assign({},e),{cell:t}))}static fromConfig(e,t){return new e(t)}};uS.className="ConvLSTM2D",vm.registerClass(uS);var dS=class extends Xw{constructor(e){super(e),this.rate=Math.max(Math.min(e.rate,1),0),this.noiseShape=e.noiseShape,this.seed=e.seed,this.supportsMasking=!0}getNoiseShape(e){if(null==this.noiseShape)return this.noiseShape;let t=e.shape,n=[];for(let a=0;a<this.noiseShape.length;++a)n.push(null==this.noiseShape[a]?t[a]:this.noiseShape[a]);return n}call(e,t){return to(()=>{this.invokeCallHook(e,t);let n=jw(e);if(0<this.rate&&this.rate<1){let e=null!=t.training&&t.training,a=this.getNoiseShape(n);return pw(()=>cw(n,this.rate,a,this.seed),()=>n,e)}return e})}getConfig(){let e={rate:this.rate,noiseShape:this.noiseShape,seed:this.seed},t=super.getConfig();return Object.assign(e,t),e}dispose(){return super.dispose()}};dS.className="Dropout",vm.registerClass(dS);var cS=class extends dS{constructor(e){super(e),this.inputSpec=[{ndim:3}]}getNoiseShape(e){let t=e.shape;return[t[0],1,t[2]]}};cS.className="SpatialDropout1D",vm.registerClass(cS);var pS=class extends Xw{constructor(e){if(super(e),this.activation=null,this.useBias=!0,this.kernel=null,this.bias=null,this.DEFAULT_KERNEL_INITIALIZER="glorotNormal",this.DEFAULT_BIAS_INITIALIZER="zeros",null==e.batchInputShape&&null==e.inputShape&&null!=e.inputDim){let t=null;null!=e.batchSize&&(t=e.batchSize),this.batchInputShape=[t,e.inputDim]}this.units=e.units,ky(this.units,"units"),this.activation=xN(e.activation),null!=e.useBias&&(this.useBias=e.useBias),this.kernelInitializer=Dw(e.kernelInitializer||this.DEFAULT_KERNEL_INITIALIZER),this.biasInitializer=Dw(e.biasInitializer||this.DEFAULT_BIAS_INITIALIZER),this.kernelConstraint=gv(e.kernelConstraint),this.biasConstraint=gv(e.biasConstraint),this.kernelRegularizer=SN(e.kernelRegularizer),this.biasRegularizer=SN(e.biasRegularizer),this.activityRegularizer=SN(e.activityRegularizer),this.supportsMasking=!0,this.inputSpec=[{minNDim:2}]}build(e){let t=(e=Lw(e))[e.length-1];null==this.kernel&&(this.kernel=this.addWeight("kernel",[t,this.units],null,this.kernelInitializer,this.kernelRegularizer,!0,this.kernelConstraint),this.useBias&&(this.bias=this.addWeight("bias",[this.units],null,this.biasInitializer,this.biasRegularizer,!0,this.biasConstraint))),this.inputSpec=[{minNDim:2,axes:{[-1]:t}}],this.built=!0}computeOutputShape(e){let t=(e=Lw(e)).slice();return t[t.length-1]=this.units,t}call(e,t){return to(()=>{this.invokeCallHook(e,t);let n,a=jw(e),r=Sy(this.activation.getClassName());return null!=r?n=iw(a,this.kernel.read(),r,this.bias?this.bias.read():null):(n=iw(a,this.kernel.read()),null!=this.bias&&(n=dw(n,this.bias.read())),null!=this.activation&&(n=this.activation.apply(n))),n})}getConfig(){let e={units:this.units,activation:fN(this.activation),useBias:this.useBias,kernelInitializer:Fw(this.kernelInitializer),biasInitializer:Fw(this.biasInitializer),kernelRegularizer:kN(this.kernelRegularizer),biasRegularizer:kN(this.biasRegularizer),activityRegularizer:kN(this.activityRegularizer),kernelConstraint:mv(this.kernelConstraint),biasConstraint:mv(this.biasConstraint)},t=super.getConfig();return Object.assign(e,t),e}};pS.className="Dense",vm.registerClass(pS);var hS=class extends Xw{constructor(e){super(e=e||{}),this.inputSpec=[{minNDim:3}],this.dataFormat=e.dataFormat}computeOutputShape(e){e=Lw(e);for(let t of e.slice(1))if(null==t)throw new ny(`The shape of the input to "Flatten" is not fully defined (got ${e.slice(1)}). Make sure to pass a complete "input_shape" or "batch_input_shape" argument to the first layer in your model.`);return[e[0],Hy(e,1)]}call(e,t){return to(()=>{this.invokeCallHook(e,t);let n=jw(e);if("channelsFirst"===this.dataFormat&&n.rank>1){let e=[0];for(let t=2;t<n.rank;++t)e.push(t);e.push(1),n=eh(n,e)}return function(e){if(e.rank<=1)throw new ny(`batchFlatten requires a minimum rank of 2. Got rank: ${e.rank}.`);let t=[e.shape[0],Hy(e.shape,1)];return ql(e,t)}(n)})}getConfig(){let e={};null!=this.dataFormat&&(e.dataFormat=this.dataFormat);let t=super.getConfig();return Object.assign(e,t),e}};hS.className="Flatten",vm.registerClass(hS);var mS=class extends Xw{constructor(e){super(e),this.supportsMasking=!0,this.activation=xN(e.activation)}call(e,t){return to(()=>{this.invokeCallHook(e,t);let n=jw(e);return this.activation.apply(n)})}getConfig(){let e={activation:fN(this.activation)},t=super.getConfig();return Object.assign(e,t),e}};mS.className="Activation",vm.registerClass(mS);var fS=class extends Xw{constructor(e){super(e),this.n=e.n,this.inputSpec=[{ndim:2}]}computeOutputShape(e){return[e[0],this.n,e[1]]}call(e,t){return to(()=>function(e,t){return to(()=>{if(2!==e.shape.length)throw new ny(`repeat() expects a rank-2 tensor, but received a rank-${e.shape.length} tensor.`);return rw(Jy(e,1),[1,t,1])})}(e=jw(e),this.n))}getConfig(){let e={n:this.n},t=super.getConfig();return Object.assign(e,t),e}};fS.className="RepeatVector",vm.registerClass(fS);var gS=class extends Xw{constructor(e){super(e),this.targetShape=e.targetShape;for(let t=0;t<this.targetShape.length;++t)this.isUnknown(this.targetShape[t])&&(this.targetShape[t]=null)}isUnknown(e){return e<0||null==e}fixUnknownDimension(e,t){let n="Total size of new array must be unchanged.",a=t.slice(),r=1,s=null;for(let o=0;o<a.length;++o){let e=a[o];if(this.isUnknown(e)){if(null!==s)throw new ny("Can only specifiy one unknown dimension.");s=o}else r*=e}let i=Hy(e);if(null!==s){if(0===r||i%r!==0)throw new ny(n);a[s]=i/r}else if(i!==r)throw new ny(n);return a}computeOutputShape(e){let t=!1;for(let n=0;n<e.length;++n)if(this.isUnknown(e[n])){t=!0;break}return t?e.slice(0,1).concat(this.targetShape):e.slice(0,1).concat(this.fixUnknownDimension(e.slice(1),this.targetShape))}call(e,t){return to(()=>{this.invokeCallHook(e,t);let n=jw(e),a=n.shape,r=a.slice(0,1).concat(this.fixUnknownDimension(a.slice(1),this.targetShape));return ql(n,r)})}getConfig(){let e={targetShape:this.targetShape},t=super.getConfig();return Object.assign(e,t),e}};gS.className="Reshape",vm.registerClass(gS);var xS=class extends Xw{constructor(e){if(super(e),null==e.dims)throw new Error("Required configuration field `dims` is missing during Permute constructor call.");if(!Array.isArray(e.dims))throw new Error(`Permute constructor requires \`dims\` to be an Array, but received ${e.dims} instead.`);let t=Xy(1,e.dims.length+1);if(!Ns.arraysEqual(e.dims.slice().sort(),t))throw new Error("Invalid permutation `dims`: "+JSON.stringify(e.dims)+" `dims` must contain consecutive integers starting from 1.");this.dims=e.dims,this.dimsIncludingBatch=[0].concat(this.dims),this.inputSpec=[new Uw({ndim:this.dims.length+1})]}computeOutputShape(e){let t=(e=Lw(e)).slice();return this.dims.forEach((n,a)=>{t[a+1]=e[n]}),t}call(e,t){return eh(jw(e),this.dimsIncludingBatch)}getConfig(){let e={dims:this.dims},t=super.getConfig();return Object.assign(e,t),e}};xS.className="Permute",vm.registerClass(xS);var bS=class extends Xw{constructor(e){super(null==e?{}:e),this.supportsMasking=!0,this.maskValue=null!=e?null==e.maskValue?0:e.maskValue:0}computeOutputShape(e){return e}getConfig(){let e=super.getConfig(),t={maskValue:this.maskValue};return Object.assign(t,e),t}computeMask(e,t){let n=jw(e);return Sl(pc(n,this.maskValue),-1)}call(e,t){return to(()=>{this.invokeCallHook(e,t);let n=jw(e),a=Sl(pc(n,this.maskValue),-1,!0);return bl(n,pl(a,n.dtype))})}};bS.className="Masking",vm.registerClass(bS);var yS=class extends Xw{constructor(e){if(super(e),this.embeddings=null,this.DEFAULT_EMBEDDINGS_INITIALIZER="randomUniform",null==e.batchInputShape&&null==e.inputShape){let t=null;null!=e.batchSize&&(t=e.batchSize),null==e.inputLength?this.batchInputShape=[t,null]:this.batchInputShape=[t].concat(dy(e.inputLength))}this.inputDim=e.inputDim,ky(this.inputDim,"inputDim"),this.outputDim=e.outputDim,ky(this.outputDim,"outputDim"),this.embeddingsInitializer=Dw(e.embeddingsInitializer||this.DEFAULT_EMBEDDINGS_INITIALIZER),this.embeddingsRegularizer=SN(e.embeddingsRegularizer),this.activityRegularizer=SN(e.activityRegularizer),this.embeddingsConstraint=gv(e.embeddingsConstraint),this.maskZero=e.maskZero,this.supportsMasking=e.maskZero,this.inputLength=e.inputLength}build(e){this.embeddings=this.addWeight("embeddings",[this.inputDim,this.outputDim],this.dtype,this.embeddingsInitializer,this.embeddingsRegularizer,!0,this.embeddingsConstraint),this.built=!0}warnOnIncompatibleInputShape(e){}computeMask(e,t){return to(()=>this.maskZero?(e=jw(e),pc(e,Bu(e))):null)}computeOutputShape(e){if(e=Lw(e),null==this.inputLength)return[...e,this.outputDim];let t=dy(this.inputLength);if(t.length!==e.length-1)throw new ny(`"inputLength" is ${this.inputLength}, but received input shape has shape ${e}`);{let n=0;for(let a=0;a<t.length;++a){let r=t[a],s=e[a+1];if(null!=r&&null!=s&&r!==s)throw new ny(`"inputLength" is ${this.inputLength}, but received input shape has shape ${e}`);null==r&&(t[n]=s),n++}}return[e[0],...t,this.outputDim]}call(e,t){return to(()=>{this.invokeCallHook(e,t);let n=jw(e);"int32"!==n.dtype&&(n=Zy(n,"int32"));let a=ow(this.embeddings.read(),ql(n,[n.size]));return ql(a,Lw(this.computeOutputShape(n.shape)))})}getConfig(){let e={inputDim:this.inputDim,outputDim:this.outputDim,embeddingsInitializer:Fw(this.embeddingsInitializer),embeddingsRegularizer:kN(this.embeddingsRegularizer),activityRegularizer:kN(this.activityRegularizer),embeddingsConstraint:mv(this.embeddingsConstraint),maskZero:this.maskZero,inputLength:this.inputLength},t=super.getConfig();return Object.assign(e,t),e}};yS.className="Embedding",vm.registerClass(yS);var wS=class extends Xw{constructor(e){super(e||{}),this.supportsMasking=!0}mergeFunction(e){throw new ay}computeElementwiseOpOutputShape(e,t){if(null==e||null==t)return null;if(e.length<t.length)return this.computeElementwiseOpOutputShape(t,e);if(0===t.length)return e;let n=e.slice(0,e.length-t.length);for(let a=0;a<t.length;++a){let r=e[e.length-t.length+a],s=t[a];if(null==r||null==s||r<0||s<0)n.push(null);else if(1===r)n.push(s);else if(1===s)n.push(r);else{if(r!==s)throw new ny("Operands could not be broadcast together with shapes "+JSON.stringify(e)+" "+JSON.stringify(t));n.push(r)}}return n}build(e){if(Array.isArray(e)&&!Array.isArray(e[0])&&(e=[Lw(e)]),e.length<2)throw new ny(`A merge layer should be called on an Array of at least 2 inputs. Got ${e.length} input(s).`);let t=[];for(let r of e)null!=r&&null!==r[0]&&t.push(r[0]);if(t=by(t),t.length>1)throw new ny(`Can not merge tensors with different batch sizes. Got tensors with shapes: ${JSON.stringify(e)}.`);let n=null==e[0]?null:e[0].slice(1);for(let r=1;r<e.length;++r){let t=null==e[r]?null:e[r].slice(1);n=this.computeElementwiseOpOutputShape(n,t)}let a=e.map(e=>e.length);-1===e.indexOf(null)&&1===by(a).length?this.reshapeRequired=!1:this.reshapeRequired=!0}call(e,t){return to(()=>{if(this.reshapeRequired){let t=[],n=e.map(e=>e.rank);if(-1===n.indexOf(null)){let a=Ky(n);for(let n of e){let e=n.rank;for(let t=0;t<a-e;++t)n=Jy(n,1);t.push(n)}return this.mergeFunction(t)}{let n=!1;for(let s of e){let e=s.rank;if(null==e){let e=s.shape,a=e[0],r=e.slice(1).concat([a]),i=ql(s,[a].concat(Hy(e.slice(1))));i=eh(i,[1,0]),i=ql(i,r),t.push(i),n=!0}else if(e>1){let a=Xy(1,e).concat([0]);t.push(eh(s,a)),n=!0}else t.push(s)}let a=this.mergeFunction(t),r=a.rank;if(n)if(null==r){let e=a.shape,t=e[e.length-1],n=[t].concat(e.slice(0,e.length-1));a=ql(eh(ql(a,[-1,t]),[1,0]),n)}else if(r>1){let e=[r-1].concat(Xy(0,r-1));a=eh(a,e)}return a}}return this.mergeFunction(e)})}computeOutputShape(e){let t;t=null==e[0]?null:e[0].slice(1);for(let a=1;a<e.length;++a){let n=null==e[a]?null:e[a].slice(1);t=this.computeElementwiseOpOutputShape(t,n)}let n=[];for(let a of e)null!=a&&null!==a[0]&&n.push(a[0]);return n=by(n),t=1===n.length?n.concat(t):[null].concat(t),t}computeMask(e,t){return to(()=>{if(null==t)return null;if(!Array.isArray(t))throw new ny("`mask` should be an Array");if(!Array.isArray(e))throw new ny("`inputs` should be an Array");if(t.length!==e.length)throw new ny(`The Array 'inputs' and 'mask' are expected to have the same length, but have different lengths (${e.length} vs ${t.length})`);if(t.every(e=>null==e))return null;let n=(t=t.map(e=>null==e?e:hd(e,0)))[0];for(let e=1;e<t.length-1;++e)n=Gd(n,t[e]);return n})}},vS=class extends wS{constructor(e){super(e)}mergeFunction(e){return to(()=>{let t=e[0].clone();for(let n=1;n<e.length;++n)t=fl(t,e[n]);return t})}};vS.className="Add",vm.registerClass(vS);var kS=class extends wS{constructor(e){super(e)}mergeFunction(e){return to(()=>{let t=e[0].clone();for(let n=1;n<e.length;++n)t=bl(t,e[n]);return t})}};kS.className="Multiply",vm.registerClass(kS);var NS=class extends wS{constructor(e){super(e)}mergeFunction(e){return to(()=>{let t=e[0].clone();for(let n=1;n<e.length;++n)t=fl(t,e[n]);return bl(1/e.length,t)})}};NS.className="Average",vm.registerClass(NS);var SS=class extends wS{constructor(e){super(e)}mergeFunction(e){return to(()=>{let t=e[0];for(let n=1;n<e.length;++n)t=tc(t,e[n]);return t})}};SS.className="Maximum",vm.registerClass(SS);var IS=class extends wS{constructor(e){super(e)}mergeFunction(e){return to(()=>{let t=e[0];for(let n=1;n<e.length;++n)t=ic(t,e[n]);return t})}};IS.className="Minimum",vm.registerClass(IS);var _S=class extends wS{constructor(e){super(e),this.DEFAULT_AXIS=-1,null==e&&(e={}),this.axis=null==e.axis?this.DEFAULT_AXIS:e.axis,this.supportsMasking=!0,this.reshapeRequired=!1}build(e){if(!Array.isArray(e)||!Array.isArray(e[0])||1===e.length)throw new ny("A `Concatenate` layer should be called on a list of at least 2 inputs");let t=!0;for(let a of e)if(null!=a){t=!1;break}if(t)return;let n=[];for(let a=0;a<e.length;++a){let t=e[a].slice();t.splice(this.axis,1);let r=!1;for(let e of n)if(Ns.arraysEqual(e,t)){r=!0;break}r||n.push(t)}if(n.length>1)throw new ny("A `Concatenate` layer requires inputs with matching shapes except for the concat axis. Got input shapes: "+JSON.stringify(e))}mergeFunction(e){return to(()=>nw(e,this.axis))}computeOutputShape(e){if(!Array.isArray(e)||!Array.isArray(e[0]))throw new ny("A `Concatenate` layer should be called on a list of inputs.");let t=e,n=t[0].slice(),a=this.axis<0?n.length+this.axis:this.axis;for(let r of t.slice(1)){if(null==n[a]||null==r[a]){n[a]=null;break}n[a]+=r[a]}return n}computeMask(e,t){if(null==t)return null;if(!Array.isArray(t))throw new ny("`mask` should be an array for Concatenate");if(!Array.isArray(e))throw new ny("`inputs` should be an array for Concatenate");if(t.length!==e.length)throw new ny(`Mismatch in the length of mask (${t.length}) and the legnth of inputs (${e.length})`);return to(()=>{let n=!0;if(t.forEach(e=>{null==e||(n=!1)}),n)return null;let a=[];for(let s=0;s<e.length;++s)null==t[s]?a.push(pl(mc(e[s]),"bool")):t[s].rank<e[s].rank?a.push(hd(t[s],-1)):a.push(t[s]);let r=Yl(a,this.axis);return Nl(r,-1,!1)})}getConfig(){let e={axis:this.axis},t=super.getConfig();return Object.assign(e,t),e}};function CS(e,t){for(;e<0;)e+=t;return e}_S.className="Concatenate",vm.registerClass(_S);var TS=class extends wS{constructor(e){super(e),this.axes=e.axes,this.normalize=null!=e.normalize&&e.normalize,this.supportsMasking=!0,this.reshapeRequired=!1}build(e){Ns.assert(Array.isArray(e)&&2===e.length&&Array.isArray(e[0])&&Array.isArray(e[1]),()=>"A `Dot` layer should be called on a list of exactly 2 inputs.");let t=e[0],n=e[1];if(t.length>3||n.length>3)throw new ay("Dot layer does not support tensors of 4D or higher rank yet.");let a=this.interpretAxes(t,n);if(t[a[0]]!==n[a[1]])throw new ny(`Dimension incompatibility: ${t[a[0]]} !== ${n[a[1]]}`)}mergeFunction(e){if(2!==e.length)throw new ny(`A \`Dot\` layer must be called on exactly 2 inputs, but received ${e.length} input(s).`);let t,n=e[0],a=e[1];return t=Array.isArray(this.axes)?this.axes.map((t,n)=>CS(t,e[n].shape.length)):[CS(this.axes,n.shape.length),CS(this.axes,a.shape.length)],this.normalize&&(n=Yv(n,t[0]),a=Yv(a,t[1])),function(e,t,n){if(e.shape.length>3||t.shape.length>3)throw new ay("batchDot is not implemented for tensors of 4D or higher rank yet");if(Ns.assert(e.shape.length>=2,()=>`batchDot requires the rank of x to be >= 2, but got ${e.shape.length}`),Ns.assert(e.shape.length>=2,()=>`batchDot requires the rank of y to be >= 2, but got ${t.shape.length}`),"number"==typeof n&&(n=[n,n]),"complex64"===e.dtype||"complex64"===t.dtype)throw new ay("batchDot is not implemented for complex64-type Tensors yet.");let a=e.shape.length,r=t.shape.length;null==n&&(n=[a-1,r-2]);let s=n;return to(()=>{let n,i;if(a>r){n=a-r;let e=[];for(let t=0;t<n;++t)e.push(1);t=ql(t,t.shape.concat(e))}else if(r>a){n=r-a;let t=[];for(let e=0;e<n;++e)t.push(1);e=ql(e,e.shape.concat(t))}else n=0;if(2===e.shape.length&&2===t.shape.length)i=s[0]===s[1]?ld(bl(e,t),s[0]):ld(bl(eh(e,[1,0]),t),s[1]);else{let n=s[0]!==e.shape.length-1,a=s[1]===t.shape.length-1;i=Zl(e,t,n,a)}if(n>0){let e;e=a>r?a+r-3:a-1;let t=[];for(let a=e;a<e+n;++a)t.push(a);i=Tp(i,t)}return 1===i.shape.length&&(i=hd(i,1)),i})}(n,a,t)}interpretAxes(e,t){let n;return n=Array.isArray(this.axes)?this.axes:[CS(this.axes,e.length),CS(this.axes,t.length)],n}computeOutputShape(e){Ns.assert(Array.isArray(e)&&2===e.length&&Array.isArray(e[0])&&Array.isArray(e[1]),()=>"A `Dot` layer should be called on a list of exactly 2 inputs.");let t=e[0].slice(),n=e[1].slice();if(t.length>3||n.length>3)throw new ay("Dot layer does not support tensors of 4D or higher rank yet.");let a=this.interpretAxes(t,n);t.splice(a[0],1),n.splice(a[1],1),n.splice(0,1);let r=t.concat(n);return 1===r.length&&r.push(1),r}computeMask(e,t){return null}getConfig(){let e={axes:this.axes,normalize:this.normalize},t=super.getConfig();return Object.assign(e,t),e}};TS.className="Dot",vm.registerClass(TS);var ES=class extends Xw{constructor(e){super(e),this.supportsMasking=!0,this.stddev=e.stddev}computeOutputShape(e){return e}getConfig(){let e=super.getConfig(),t={stddev:this.stddev};return Object.assign(t,e),t}call(e,t){return to(()=>{this.invokeCallHook(e,t);let n=jw(e);return pw(()=>fl(sw(n.shape,0,this.stddev),n),()=>n,t.training||!1)})}};ES.className="GaussianNoise",vm.registerClass(ES);var AS=class extends Xw{constructor(e){super(e),this.supportsMasking=!0,this.rate=e.rate}computeOutputShape(e){return e}getConfig(){let e=super.getConfig(),t={rate:this.rate};return Object.assign(t,e),t}call(e,t){return to(()=>{this.invokeCallHook(e,t);let n=jw(e);return this.rate>0&&this.rate<1?pw(()=>{let e=Math.sqrt(this.rate/(1-this.rate));return bl(n,sw(n.shape,1,e))},()=>n,t.training||!1):n})}};AS.className="GaussianDropout",vm.registerClass(AS);var $S=class extends Xw{constructor(e){super(e),this.supportsMasking=!0,this.rate=e.rate,this.noiseShape=e.noiseShape}_getNoiseShape(e){return this.noiseShape||jw(e).shape}computeOutputShape(e){return e}getConfig(){let e=super.getConfig(),t={rate:this.rate};return Object.assign(t,e),t}call(e,t){return to(()=>{if(this.rate<1&&this.rate>0){let n=this._getNoiseShape(e);return pw(()=>{let t=jw(e),a=-1.7580993408473766,r=wd(Zc(n),this.rate);r=Zy(r,"float32");let s=((1-this.rate)*(1+this.rate*a**2))**-.5,i=-s*a*this.rate,o=fl(bl(t,r),bl(fl(r,-1),a));return fl(bl(o,s),i)},()=>jw(e),t.training||!1)}return e})}};function RS(e,t,n,a,r,s=.001){let i;if(2===e.rank)i=su(e,t,n,a,r,s);else if(3===e.rank)i=iu(e,t,n,a,r,s);else{if(4!==e.rank)throw new ay(`batchNormalization is not implemented for array of rank ${e.rank} yet`);i=ou(e,t,n,a,r,s)}return i}$S.className="AlphaDropout",vm.registerClass($S);var FS=class extends Xw{constructor(e){null==e&&(e={}),super(e),this.supportsMasking=!0,this.axis=null==e.axis?-1:e.axis,this.momentum=null==e.momentum?.99:e.momentum,this.epsilon=null==e.epsilon?.001:e.epsilon,this.center=null==e.center||e.center,this.scale=null==e.scale||e.scale,this.betaInitializer=Dw(e.betaInitializer||"zeros"),this.gammaInitializer=Dw(e.gammaInitializer||"ones"),this.movingMeanInitializer=Dw(e.movingMeanInitializer||"zeros"),this.movingVarianceInitializer=Dw(e.movingVarianceInitializer||"ones"),this.betaConstraint=gv(e.betaConstraint),this.gammaConstraint=gv(e.gammaConstraint),this.betaRegularizer=SN(e.betaRegularizer),this.gammaRegularizer=SN(e.gammaRegularizer)}build(e){e=Lw(e);let t=this.axis>=0?this.axis:this.axis+e.length,n=e[t];if(null==n)throw new ny(`Axis ${t} of input tensor should have a defined dimension but the layer received an input with shape ${JSON.stringify(e)}.`);this.inputSpec=[new Uw({ndim:e.length,axes:{[t]:n}})];let a=[n];this.scale&&(this.gamma=this.addWeight("gamma",a,null,this.gammaInitializer,this.gammaRegularizer,!0,this.gammaConstraint)),this.center&&(this.beta=this.addWeight("beta",a,null,this.betaInitializer,this.betaRegularizer,!0,this.betaConstraint)),this.movingMean=this.addWeight("moving_mean",a,null,this.movingMeanInitializer,null,!1),this.movingVariance=this.addWeight("moving_variance",a,null,this.movingVarianceInitializer,null,!1),this.built=!0}call(e,t){return to(()=>{let n=null!=t.training&&t.training,a=jw(e),r=a.shape,s=r.length,i=Xy(0,s),o=this.axis>=0?this.axis:this.axis+s;i.splice(o,1);let l=iy(1,s);l[o]=r[o];let u=i.slice();u.sort();let d=!Ns.arraysEqual(u,Xy(0,s).slice(0,s-1));if(!n)return(()=>{if(d){let e=ql(this.movingMean.read(),l),t=ql(this.movingVariance.read(),l),n=this.center?ql(this.beta.read(),l):null,r=this.scale?ql(this.gamma.read(),l):null;return RS(a,e,t,n,r,this.epsilon)}return RS(a,this.movingMean.read(),this.movingVariance.read(),null==this.beta?null:this.beta.read(),null==this.gamma?null:this.gamma.read(),this.epsilon)})();let[c,p,h]=function(e,t,n,a,r=.001){return Ns.arraysEqual(a.slice().sort(),Xy(0,e.rank-1))?function(e,t,n,a,r=.001){return to(()=>{let s=uc(e,a),i=s.mean,o=s.variance;return[RS(e,i,o,n,t,r),i,o]})}(e,t,n,a,r):function(e,t,n,a,r=.001){return to(()=>{let s=uc(e,a),i=s.mean,o=s.variance,l=[];for(let t of Xy(0,e.rank))-1!==a.indexOf(t)?l.push(1):l.push(e.shape[t]);let u=ql(i,l),d=ql(o,l),c=null==t?null:ql(t,l),p=null==n?null:ql(n,l);return[RS(e,u,d,p,c,r),i,o]})}(e,t,n,a,r)}(a,this.gamma.read(),this.beta.read(),i,this.epsilon),m=(e,t,n)=>{to(()=>{let a=1-n,r=e.read(),s=bl(Wd(r,t),a);e.write(Wd(r,s))})};return m(this.movingMean,p,this.momentum),m(this.movingVariance,h,this.momentum),c})}getConfig(){let e={axis:this.axis,momentum:this.momentum,epsilon:this.epsilon,center:this.center,scale:this.scale,betaInitializer:Fw(this.betaInitializer),gammaInitializer:Fw(this.gammaInitializer),movingMeanInitializer:Fw(this.movingMeanInitializer),movingVarianceInitializer:Fw(this.movingVarianceInitializer),betaRegularizer:kN(this.betaRegularizer),gammaRegularizer:kN(this.gammaRegularizer),betaConstraint:mv(this.betaConstraint),gammaConstraint:mv(this.gammaConstraint)},t=super.getConfig();return Object.assign(e,t),e}};FS.className="BatchNormalization",vm.registerClass(FS);var DS=class extends Xw{constructor(e){if(null==e&&(e={}),super(e),this.axis=null==e.axis?-1:e.axis,"number"==typeof this.axis){if(!Number.isInteger(this.axis))throw new Error(`Expected axis to be an integer, but received ${this.axis}`)}else{if(!Array.isArray(this.axis))throw new Error(`Expected axis to be an integer or an array of integers, but received ${JSON.stringify(this.axis)}`);for(let e of this.axis)if(!Number.isInteger(e))throw new Error(`Expected axis to be an array of integers, but received ${JSON.stringify(this.axis)}`)}this.epsilon=null==e.epsilon?.001:e.epsilon,this.center=null==e.center||e.center,this.scale=null==e.scale||e.scale,this.betaInitializer=Dw(e.betaInitializer||"zeros"),this.gammaInitializer=Dw(e.gammaInitializer||"ones"),this.betaRegularizer=SN(e.betaRegularizer),this.gammaRegularizer=SN(e.gammaRegularizer),this.supportsMasking=!0}build(e){let t=(e=Lw(e)).length;"number"==typeof this.axis&&(this.axis=[this.axis]);for(let r=0;r<this.axis.length;++r)this.axis[r]<0&&(this.axis[r]+=t);for(let r of this.axis)if(r<0||r>=t)throw new Error(`Invalid axis: ${r}`);if(this.axis.length!==by(this.axis).length)throw new Error(`Found duplicate axes in: ${this.axis}`);let n=this.axis.map(t=>e[t]),a=!0;this.scale?this.gamma=this.addWeight("gamma",n,"float32",this.gammaInitializer,this.gammaRegularizer,a):this.gamma=null,this.center?this.beta=this.addWeight("beta",n,"float32",this.betaInitializer,this.betaRegularizer,a):this.beta=null,this.built=!0}call(e,t){let n=jw(e),a=n.shape,r=a.length;return to(()=>{let{mean:e,variance:t}=uc(n,this.axis,!0),s=iy(1,r);for(let n of this.axis)s[n]=a[n];let i=e=>null!=e&&e.shape.length!==r?ql(e,s):e,o=this.scale?i(this.gamma.read()):null,l=this.center?i(this.beta.read()):null,u=[],d=[];for(let n=0;n<r;++n)-1!==this.axis.indexOf(n)?(u.push(a[n]),d.push(1)):(u.push(1),d.push(a[n]));return e=fd(e,u),t=fd(t,u),null!=o&&(o=fd(o,d)),null!=l&&(l=fd(l,d)),RS(n,e,t,l,o,this.epsilon)})}getConfig(){let e={axis:this.axis,epsilon:this.epsilon,center:this.center,scale:this.scale,betaInitializer:Fw(this.betaInitializer),gammaInitializer:Fw(this.gammaInitializer),betaRegularizer:kN(this.betaRegularizer),gammaRegularizer:kN(this.gammaRegularizer)},t=super.getConfig();return Object.assign(e,t),e}};DS.className="LayerNormalization",vm.registerClass(DS);var MS=class extends Xw{constructor(e){if(null==e&&(e={}),super(e),this.dataFormat=null==e.dataFormat?"channelsLast":e.dataFormat,null==e.padding)this.padding=[[1,1],[1,1]];else if("number"==typeof e.padding)this.padding=[[e.padding,e.padding],[e.padding,e.padding]];else{if(e.padding=e.padding,2!==e.padding.length)throw new ny(`ZeroPadding2D expects padding to be a length-2 array, but received a length-${e.padding.length} array.`);let t,n;if("number"==typeof e.padding[0])t=[e.padding[0],e.padding[0]],n=[e.padding[1],e.padding[1]];else{if(e.padding=e.padding,2!==e.padding[0].length)throw new ny(`ZeroPadding2D expects height padding to be a length-2 array, but received a length-${e.padding[0].length} array.`);if(t=e.padding[0],2!==e.padding[1].length)throw new ny(`ZeroPadding2D expects width padding to be a length-2 array, but received a length-${e.padding[1].length} array.`);n=e.padding[1]}this.padding=[t,n]}this.inputSpec=[new Uw({ndim:4})]}computeOutputShape(e){let t,n;return e=Lw(e),"channelsFirst"===this.dataFormat?(t=null!=e[2]&&e[2]>=0?e[2]+this.padding[0][0]+this.padding[0][1]:null,n=null!=e[3]&&e[3]>=0?e[3]+this.padding[1][0]+this.padding[1][1]:null,[e[0],e[1],t,n]):(t=null!=e[1]&&e[1]>=0?e[1]+this.padding[0][0]+this.padding[0][1]:null,n=null!=e[2]&&e[2]>=0?e[2]+this.padding[1][0]+this.padding[1][1]:null,[e[0],t,n,e[3]])}call(e,t){return to(()=>function(e,t,n){return to(()=>{if(4!==e.rank)throw new ny(`temporalPadding expects input tensor to be 4-D, but received a ${e.rank}-D tensor.`);if(null==t&&(t=[[1,1],[1,1]]),2!==t.length||2!==t[0].length||2!==t[1].length)throw new ny("spatial2dPadding expects `padding` to be an Array of two Arrays, each of which is an Array of two integers.");if(null==n&&(n="channelsLast"),"channelsLast"!==n&&"channelsFirst"!==n)throw new ny(`Unknown data format: ${n}. Supported data formats are 'channelsLast' and 'channelsFirst.`);let a;return a="channelsFirst"===n?[[0,0],[0,0],t[0],t[1]]:[[0,0],t[0],t[1],[0,0]],gc(e,a)})}(jw(e),this.padding,this.dataFormat))}getConfig(){let e={padding:this.padding,dataFormat:this.dataFormat},t=super.getConfig();return Object.assign(e,t),e}};function OS(e,t,n,a,r,s){return to(()=>{My(r),jy(s),Oy(a),null==n&&(n=[1,1]),null==a&&(a="valid"),null==r&&(r="channelsLast"),null==s&&(s="max"),e=DN(e,r);let i,o="same"===a?"same":"valid";return i="max"===s?Jd(e,t,n,o):Kl(e,t,n,o),"channelsFirst"===r&&(i=eh(i,[0,3,1,2])),i})}function jS(e,t,n,a,r,s){return to(()=>{My(r),jy(s),Oy(a),null==n&&(n=[1,1,1]),null==a&&(a="valid"),null==r&&(r="channelsLast"),null==s&&(s="max"),e=MN(e,r);let i,o="same"===a?"same":"valid";return i="max"===s?Qd(e,t,n,o):Xl(e,t,n,o),"channelsFirst"===r&&(i=eh(i,[0,4,1,2,3])),i})}MS.className="ZeroPadding2D",vm.registerClass(MS);var LS=class extends Xw{constructor(e){if(null==e.poolSize&&(e.poolSize=2),super(e),"number"==typeof e.poolSize)this.poolSize=[e.poolSize];else{if(!Array.isArray(e.poolSize)||1!==e.poolSize.length||"number"!=typeof e.poolSize[0])throw new ny(`poolSize for 1D convolutional layer must be a number or an Array of a single number, but received ${JSON.stringify(e.poolSize)}`);this.poolSize=e.poolSize}if(ky(this.poolSize,"poolSize"),null==e.strides)this.strides=this.poolSize;else if("number"==typeof e.strides)this.strides=[e.strides];else{if(!Array.isArray(e.strides)||1!==e.strides.length||"number"!=typeof e.strides[0])throw new ny(`strides for 1D convolutional layer must be a number or an Array of a single number, but received ${JSON.stringify(e.strides)}`);this.strides=e.strides}ky(this.strides,"strides"),this.padding=null==e.padding?"valid":e.padding,Oy(this.padding),this.inputSpec=[new Uw({ndim:3})]}computeOutputShape(e){let t=RN((e=Lw(e))[1],this.poolSize[0],this.padding,this.strides[0]);return[e[0],t,e[2]]}call(e,t){return to(()=>{this.invokeCallHook(e,t),e=Jy(jw(e),2);let n=this.poolingFunction(jw(e),[this.poolSize[0],1],[this.strides[0],1],this.padding,"channelsLast");return Tp(n,[2])})}getConfig(){let e={poolSize:this.poolSize,padding:this.padding,strides:this.strides},t=super.getConfig();return Object.assign(e,t),e}},zS=class extends LS{constructor(e){super(e)}poolingFunction(e,t,n,a,r){return My(r),Oy(a),OS(e,t,n,a,r,"max")}};zS.className="MaxPooling1D",vm.registerClass(zS);var PS=class extends LS{constructor(e){super(e)}poolingFunction(e,t,n,a,r){return My(r),Oy(a),OS(e,t,n,a,r,"avg")}};PS.className="AveragePooling1D",vm.registerClass(PS);var BS=class extends Xw{constructor(e){if(null==e.poolSize&&(e.poolSize=[2,2]),super(e),this.poolSize=Array.isArray(e.poolSize)?e.poolSize:[e.poolSize,e.poolSize],null==e.strides)this.strides=this.poolSize;else if(Array.isArray(e.strides)){if(2!==e.strides.length)throw new ny(`If the strides property of a 2D pooling layer is an Array, it is expected to have a length of 2, but received length ${e.strides.length}.`);this.strides=e.strides}else this.strides=[e.strides,e.strides];ky(this.poolSize,"poolSize"),ky(this.strides,"strides"),this.padding=null==e.padding?"valid":e.padding,this.dataFormat=null==e.dataFormat?"channelsLast":e.dataFormat,My(this.dataFormat),Oy(this.padding),this.inputSpec=[new Uw({ndim:4})]}computeOutputShape(e){e=Lw(e);let t="channelsFirst"===this.dataFormat?e[2]:e[1],n="channelsFirst"===this.dataFormat?e[3]:e[2];return t=RN(t,this.poolSize[0],this.padding,this.strides[0]),n=RN(n,this.poolSize[1],this.padding,this.strides[1]),"channelsFirst"===this.dataFormat?[e[0],e[1],t,n]:[e[0],t,n,e[3]]}call(e,t){return to(()=>(this.invokeCallHook(e,t),this.poolingFunction(jw(e),this.poolSize,this.strides,this.padding,this.dataFormat)))}getConfig(){let e={poolSize:this.poolSize,padding:this.padding,strides:this.strides,dataFormat:this.dataFormat},t=super.getConfig();return Object.assign(e,t),e}},WS=class extends BS{constructor(e){super(e)}poolingFunction(e,t,n,a,r){return My(r),Oy(a),OS(e,t,n,a,r,"max")}};WS.className="MaxPooling2D",vm.registerClass(WS);var VS=class extends BS{constructor(e){super(e)}poolingFunction(e,t,n,a,r){return My(r),Oy(a),OS(e,t,n,a,r,"avg")}};VS.className="AveragePooling2D",vm.registerClass(VS);var US=class extends Xw{constructor(e){if(null==e.poolSize&&(e.poolSize=[2,2,2]),super(e),this.poolSize=Array.isArray(e.poolSize)?e.poolSize:[e.poolSize,e.poolSize,e.poolSize],null==e.strides)this.strides=this.poolSize;else if(Array.isArray(e.strides)){if(3!==e.strides.length)throw new ny(`If the strides property of a 3D pooling layer is an Array, it is expected to have a length of 3, but received length ${e.strides.length}.`);this.strides=e.strides}else this.strides=[e.strides,e.strides,e.strides];ky(this.poolSize,"poolSize"),ky(this.strides,"strides"),this.padding=null==e.padding?"valid":e.padding,this.dataFormat=null==e.dataFormat?"channelsLast":e.dataFormat,My(this.dataFormat),Oy(this.padding),this.inputSpec=[new Uw({ndim:5})]}computeOutputShape(e){e=Lw(e);let t="channelsFirst"===this.dataFormat?e[2]:e[1],n="channelsFirst"===this.dataFormat?e[3]:e[2],a="channelsFirst"===this.dataFormat?e[4]:e[3];return t=RN(t,this.poolSize[0],this.padding,this.strides[0]),n=RN(n,this.poolSize[1],this.padding,this.strides[1]),a=RN(a,this.poolSize[2],this.padding,this.strides[2]),"channelsFirst"===this.dataFormat?[e[0],e[1],t,n,a]:[e[0],t,n,a,e[4]]}call(e,t){return to(()=>(this.invokeCallHook(e,t),this.poolingFunction(jw(e),this.poolSize,this.strides,this.padding,this.dataFormat)))}getConfig(){let e={poolSize:this.poolSize,padding:this.padding,strides:this.strides,dataFormat:this.dataFormat},t=super.getConfig();return Object.assign(e,t),e}},GS=class extends US{constructor(e){super(e)}poolingFunction(e,t,n,a,r){return My(r),Oy(a),jS(e,t,n,a,r,"max")}};GS.className="MaxPooling3D",vm.registerClass(GS);var HS=class extends US{constructor(e){super(e)}poolingFunction(e,t,n,a,r){return My(r),Oy(a),jS(e,t,n,a,r,"avg")}};HS.className="AveragePooling3D",vm.registerClass(HS);var qS=class extends Xw{constructor(e){super(e),this.inputSpec=[new Uw({ndim:3})]}computeOutputShape(e){return[e[0],e[2]]}call(e,t){throw new ay}},KS=class extends qS{constructor(e){super(e||{})}call(e,t){return to(()=>{let t=jw(e);return nc(t,1)})}};KS.className="GlobalAveragePooling1D",vm.registerClass(KS);var XS=class extends qS{constructor(e){super(e||{})}call(e,t){return to(()=>{let t=jw(e);return nd(t,1)})}};XS.className="GlobalMaxPooling1D",vm.registerClass(XS);var YS=class extends Xw{constructor(e){super(e),this.dataFormat=null==e.dataFormat?"channelsLast":e.dataFormat,My(this.dataFormat),this.inputSpec=[new Uw({ndim:4})]}computeOutputShape(e){return"channelsLast"===this.dataFormat?[e[0],e[3]]:[e[0],e[1]]}call(e,t){throw new ay}getConfig(){let e={dataFormat:this.dataFormat},t=super.getConfig();return Object.assign(e,t),e}},ZS=class extends YS{call(e,t){return to(()=>{let t=jw(e);return"channelsLast"===this.dataFormat?nc(t,[1,2]):nc(t,[2,3])})}};ZS.className="GlobalAveragePooling2D",vm.registerClass(ZS);var JS=class extends YS{call(e,t){return to(()=>{let t=jw(e);return"channelsLast"===this.dataFormat?nd(t,[1,2]):nd(t,[2,3])})}};JS.className="GlobalMaxPooling2D",vm.registerClass(JS);var QS=class extends Xw{constructor(e){super(e),this.layer=e.layer}build(e){this.built=!0}get trainable(){return null!=this.layer&&this.layer.trainable}set trainable(e){null!=this.layer&&(this.layer.trainable=e)}get trainableWeights(){return this.layer.trainableWeights}get nonTrainableWeights(){return this.layer.nonTrainableWeights}get updates(){return this.layer._updates}get losses(){return this.layer.losses}getWeights(){return this.layer.getWeights()}setWeights(e){this.layer.setWeights(e)}getConfig(){let e={layer:{className:this.layer.getClassName(),config:this.layer.getConfig()}},t=super.getConfig();return Object.assign(e,t),e}setFastWeightInitDuringBuild(e){super.setFastWeightInitDuringBuild(e),null!=this.layer&&this.layer.setFastWeightInitDuringBuild(e)}static fromConfig(e,t,n={}){let a=Xv(t.layer,n);delete t.layer;let r={layer:a};return Object.assign(r,t),new e(r)}},eI=class extends QS{constructor(e){super(e),this.supportsMasking=!0}build(e){if((e=Lw(e)).length<3)throw new ny(`TimeDistributed layer expects an input shape >= 3D, but received input shape ${JSON.stringify(e)}`);this.inputSpec=[{shape:e}];let t=[e[0]].concat(e.slice(2));this.layer.built||(this.layer.build(t),this.layer.built=!0),super.build(e)}computeOutputShape(e){let t=[(e=Lw(e))[0]].concat(e.slice(2)),n=this.layer.computeOutputShape(t),a=e[1];return[n[0],a].concat(n.slice(1))}call(e,t){return to(()=>YN((e,n)=>[jw(this.layer.call(e,t)),[]],e=jw(e),[],!1,null,0,!1,!0)[1])}};eI.className="TimeDistributed",vm.registerClass(eI);var tI=class extends QS{constructor(e){super(e);let t=e.layer.getConfig(),n={};n.className=e.layer.getClassName(),n.config=t,this.forwardLayer=Xv(n),t.goBackwards=!0!==t.goBackwards;let a={};if(a.className=e.layer.getClassName(),a.config=t,this.backwardLayer=Xv(a),this.forwardLayer.name="forward_"+this.forwardLayer.name,this.backwardLayer.name="backward_"+this.backwardLayer.name,this.mergeMode=void 0===e.mergeMode?"concat":e.mergeMode,function(e){wy(Fy,"BidirectionalMergeMode",e)}(this.mergeMode),e.weights)throw new ay("weights support is not implemented for Bidirectional layer yet.");this._stateful=e.layer.stateful,this.returnSequences=e.layer.returnSequences,this.returnState=e.layer.returnState,this.supportsMasking=!0,this._trainable=!0,this.inputSpec=e.layer.inputSpec,this.numConstants=null}get trainable(){return this._trainable}set trainable(e){this._trainable=e,null!=this.forwardLayer&&(this.forwardLayer.trainable=e),null!=this.backwardLayer&&(this.backwardLayer.trainable=e)}getWeights(){return this.forwardLayer.getWeights().concat(this.backwardLayer.getWeights())}setWeights(e){let t=e.length,n=Math.floor(t/2);this.forwardLayer.setWeights(e.slice(0,n)),this.backwardLayer.setWeights(e.slice(n))}computeOutputShape(e){let t,n,a,r=this.forwardLayer.computeOutputShape(e);return Array.isArray(r)&&Array.isArray(r[0])||(r=[r]),this.returnState&&(a=r.slice(1)),t=r[0],"concat"===this.mergeMode?(t[t.length-1]*=2,n=[t]):n=null==this.mergeMode?[t,t.slice()]:[t],this.returnState?null==this.mergeMode?n.concat(a).concat(a.slice()):[t].concat(a).concat(a.slice()):uy(n)}apply(e,t){let n=null==t?null:t.initialState,a=null==t?null:t.constants;null==t&&(t={});let r=XN(e,n,a,this.numConstants);if(e=r.inputs,n=r.initialState,a=r.constants,Array.isArray(e)&&(n=e.slice(1),e=e[0]),(null==n||0===n.length)&&null==a)return super.apply(e,t);let s=[],i=[];if(null!=n){let e=n.length;if(e%2>0)throw new ny("When passing `initialState` to a Bidrectional RNN, the state should be an Array containing the states of the underlying RNNs.");t.initialState=n,s.push(...n);let a=n.map(e=>new Uw({shape:e.shape}));this.forwardLayer.stateSpec=a.slice(0,e/2),this.backwardLayer.stateSpec=a.slice(e/2),i.push(...a)}if(null!=a)throw new ay("Support for constants in Bidirectional layers is not implemented yet.");let o=s[0]instanceof Gw;for(let l of s)if(l instanceof Gw!==o)throw new ny("The initial state of a Bidirectional layer cannot be specified as a mix of symbolic and non-symbolic tensors");if(o){let n=[e].concat(s),a=this.inputSpec.concat(i),r=this.inputSpec;this.inputSpec=a;let o=super.apply(n,t);return this.inputSpec=r,o}return super.apply(e,t)}call(e,t){return to(()=>{let n,a,r,s,i=t.initialState;if(null==i)n=this.forwardLayer.call(e,t),a=this.backwardLayer.call(e,t);else{let r=i.slice(0,i.length/2),s=i.slice(i.length/2);n=this.forwardLayer.call(e,Object.assign(t,{initialState:r})),a=this.backwardLayer.call(e,Object.assign(t,{initialState:s}))}return this.returnState&&(Array.isArray(n)&&(r=n.slice(1).concat(a.slice(1))),n=n[0],a=a[0]),this.returnSequences&&(a=rp(a,1)),"concat"===this.mergeMode?s=nw([n,a]):"sum"===this.mergeMode?s=fl(n,a):"ave"===this.mergeMode?s=bl(.5,fl(n,a)):"mul"===this.mergeMode?s=bl(n,a):null==this.mergeMode&&(s=[n,a]),this.returnState?null==this.mergeMode?s.concat(r):[s].concat(r):s})}resetStates(e){this.forwardLayer.resetStates(),this.backwardLayer.resetStates()}build(e){zy(this.forwardLayer.name,()=>{this.forwardLayer.build(e)}),zy(this.backwardLayer.name,()=>{this.backwardLayer.build(e)}),this.built=!0}computeMask(e,t){let n;if(Array.isArray(t)&&(t=t[0]),n=this.returnSequences?null==this.mergeMode?[t,t]:t:null==this.mergeMode?[null,null]:null,this.returnState){let e=this.forwardLayer.states.map(e=>null);return Array.isArray(n)?n.concat(e).concat(e):[n].concat(e).concat(e)}return n}get trainableWeights(){return this.forwardLayer.trainableWeights.concat(this.backwardLayer.trainableWeights)}get nonTrainableWeights(){return this.forwardLayer.nonTrainableWeights.concat(this.backwardLayer.nonTrainableWeights)}setFastWeightInitDuringBuild(e){super.setFastWeightInitDuringBuild(e),null!=this.forwardLayer&&this.forwardLayer.setFastWeightInitDuringBuild(e),null!=this.backwardLayer&&this.backwardLayer.setFastWeightInitDuringBuild(e)}getConfig(){let e={mergeMode:this.mergeMode},t=super.getConfig();return Object.assign(e,t),e}static fromConfig(e,t){let n=Xv(t.layer);if(delete t.layer,null!=t.numConstants)throw new ay("Deserialization of a Bidirectional layer with numConstants present is not supported yet.");let a=t;return a.layer=n,new e(a)}};tI.className="Bidirectional",vm.registerClass(tI);var nI=class extends Xw{constructor(e){super(e),this.scale=e.scale,e.offset?this.offset=e.offset:this.offset=0}getConfig(){let e={scale:this.scale,offset:this.offset},t=super.getConfig();return Object.assign(e,t),e}call(e,t){return to(()=>("float32"!==(e=jw(e)).dtype&&(e=Zy(e,"float32")),fl(bl(e,this.scale),this.offset)))}};nI.className="Rescaling",vm.registerClass(nI);var{resizeBilinear:aI,cropAndResize:rI}=gm,sI=class extends Xw{constructor(e){super(e),this.height=e.height,this.width=e.width}centerCrop(e,t,n,a,r,s,i,o){return to(()=>{let l,u=!1,d=[t/s,n/i,(a+t)/s,(r+n)/i],c=[];3===e.rank?(u=!0,l=Ep([e])):l=e;for(let e=0;e<l.shape[0];e++)c.push(d);let p=Ui(c,[c.length,4]),h=Qc(0,c.length,1,"int32"),m=rI(l,p,h,[a,r],"nearest");return Zy(u?jw(Kp(m)):m,o)})}upsize(e,t,n,a){return to(()=>Zy(aI(e,[t,n]),a))}call(e,t){return to(()=>{let t=jw(e),n=t.dtype,a=t.shape,r=a[a.length-3],s=a[a.length-2],i=0;r!==this.height&&(i=Math.floor((r-this.height)/2));let o=0;return s!==this.width&&(o=Math.floor((s-this.width)/2),0===o&&(o=1)),i>=0&&o>=0?this.centerCrop(t,i,o,this.height,this.width,r,s,n):this.upsize(e,this.height,this.width,n)})}getConfig(){let e={height:this.height,width:this.width},t=super.getConfig();return Object.assign(e,t),e}computeOutputShape(e){let t=(e=Lw(e)).length-3,n=e.length-2;return e[t]=this.height,e[n]=this.width,e}};sI.className="CenterCrop",vm.registerClass(sI);var iI=class extends Xw{constructor(e){super(e),this.numTokens=e.numTokens,e.outputMode?this.outputMode=e.outputMode:this.outputMode="multiHot"}getConfig(){let e={numTokens:this.numTokens,outputMode:this.outputMode},t=super.getConfig();return Object.assign(e,t),e}computeOutputShape(e){return null==(e=Lw(e))?[this.numTokens]:"oneHot"===this.outputMode&&1!==e[e.length-1]?(e.push(this.numTokens),e):(e[e.length-1]=this.numTokens,e)}call(e,t){return to(()=>{let n;if("int32"!==(e=jw(e)).dtype&&(e=Zy(e,"int32")),void 0!==t.countWeights){if("count"!==this.outputMode)throw new ny(`countWeights is not used when outputMode !== count.\n              Received countWeights=${t.countWeights}`);n=jw(t.countWeights)}let a=nd(e),r=ad(e),s=yd(this.numTokens,a).bufferSync().get(0),i=wd(r,0).bufferSync().get(0);if(!s||!i)throw new ny(`Input values must be between 0 < values <= numTokens with numTokens=${this.numTokens}`);return function(e,t,n,a){let r=jw(e);if("int32"!==r.dtype&&(r=Zy(r,"int32")),"int"===t)return r;let s=r.shape;if(0===r.rank&&(r=hd(r,-1)),"oneHot"===t&&1!==r.shape[r.shape.length-1]&&(r=hd(r,-1)),r.rank>2)throw new ny(`When outputMode is not int, maximum output rank is 2 Received outputMode ${t} and input shape ${s} which would result in output rank ${r.rank}.`);let i,o=["multiHot","oneHot"].includes(t);if(i=Au(r,void 0!==a&&"count"===t?a:[],n,o),"tfIdf"!==t)return i;if(a)return bl(i,a);throw new ny("When outputMode is 'tfIdf', weights must be provided.")}(e,this.outputMode,this.numTokens,n)})}};iI.className="CategoryEncoding",vm.registerClass(iI);var oI=new Set(["bilinear","nearest"]),lI=class extends Xw{constructor(e){if(super(e),this.height=e.height,this.width=e.width,e.interpolation){if(!oI.has(e.interpolation))throw new ny(`Invalid interpolation parameter: ${e.interpolation} is not implemented`);this.interpolation=e.interpolation}else this.interpolation="bilinear";this.cropToAspectRatio=!!e.cropToAspectRatio}computeOutputShape(e){let t=(e=Lw(e))[2];return[this.height,this.width,t]}getConfig(){let e={height:this.height,width:this.width,interpolation:this.interpolation,cropToAspectRatio:this.cropToAspectRatio},t=super.getConfig();return Object.assign(e,t),e}call(e,t){return to(()=>{let t=[this.height,this.width];if("bilinear"===this.interpolation)return gm.resizeBilinear(e,t,!this.cropToAspectRatio);if("nearest"===this.interpolation)return gm.resizeNearestNeighbor(e,t,!this.cropToAspectRatio);throw new Error(`Interpolation is ${this.interpolation} but only ${[...oI]} are supported`)})}};lI.className="Resizing",vm.registerClass(lI);var uI=class{constructor(e){this.seed=e}next(){if(void 0!==this.seed)return this.seed++}};uI.className="RandomSeed";var dI=class extends Xw{constructor(e){super(e),this.randomGenerator=new uI(e.seed)}getConfig(){let e={seed:this.randomGenerator.seed},t=super.getConfig();return Object.assign(e,t),e}};dI.className="BaseRandomLayer";var cI=new Set(["bilinear","nearest"]),pI=class extends dI{constructor(e){super(e);let{factor:t,interpolation:n="bilinear"}=e;if(this.factor=t,Array.isArray(this.factor)&&2===this.factor.length)this.widthLower=this.factor[0],this.widthUpper=this.factor[1];else{if(Array.isArray(this.factor)||!(this.factor>0))throw new ny(`Invalid factor: ${this.factor}. Must be positive number or tuple of 2 numbers`);this.widthLower=-this.factor,this.widthUpper=this.factor}if(this.widthLower<-1||this.widthUpper<-1)throw new ny(`factor must have values larger than -1. Got: ${this.factor}`);if(this.widthUpper<this.widthLower)throw new ny(`factor cannot have upper bound less than lower bound.\n        Got upper bound: ${this.widthUpper}.\n        Got lower bound: ${this.widthLower}\n      `);if(n){if(!cI.has(n))throw new ny(`Invalid interpolation parameter: ${n} is not implemented`);this.interpolation=n}}getConfig(){let e={factor:this.factor,interpolation:this.interpolation},t=super.getConfig();return Object.assign(e,t),e}computeOutputShape(e){let t=(e=Lw(e))[2];return[this.imgHeight,-1,t]}call(e,t){return to(()=>{let t=jw(e);this.imgHeight=t.shape[t.shape.length-3];let n=t.shape[t.shape.length-2];this.widthFactor=Zc([1],1+this.widthLower,1+this.widthUpper,"float32",this.randomGenerator.next());let a=this.widthFactor.dataSync()[0]*n;a=Math.round(a);let r=[this.imgHeight,a];switch(this.interpolation){case"bilinear":return gm.resizeBilinear(e,r);case"nearest":return gm.resizeNearestNeighbor(e,r);default:throw new Error(`Interpolation is ${this.interpolation}\n          but only ${[...cI]} are supported`)}})}};function hI(e){return new Zw(e)}function mI(e){return new TN(e)}function fI(e){return new IN(e)}function gI(e){return new _N(e)}function xI(e){return new CN(e)}function bI(e){return new AN(e)}function yI(e){return new EN(e)}function wI(e){return new GN(e)}function vI(e){return new zN(e)}function kI(e){return new BN(e)}function NI(e){return new PN(e)}function SI(e){return new WN(e)}function II(e){return new UN(e)}function _I(e){return new HN(e)}function CI(e){return new qN(e)}function TI(e){return new KN(e)}function EI(e){return new mS(e)}function AI(e){return new pS(e)}function $I(e){return new dS(e)}function RI(e){return new cS(e)}function FI(e){return new hS(e)}function DI(e){return new fS(e)}function MI(e){return new gS(e)}function OI(e){return new xS(e)}function jI(e){return new yS(e)}function LI(e){return new vS(e)}function zI(e){return new NS(e)}function PI(e){return new _S(e)}function BI(e){return new SS(e)}function WI(e){return new IS(e)}function VI(e){return new kS(e)}function UI(e){return new TS(e)}function GI(e){return new FS(e)}function HI(e){return new DS(e)}function qI(e){return new MS(e)}function KI(e){return new PS(e)}function XI(e){return KI(e)}function YI(e){return KI(e)}function ZI(e){return new VS(e)}function JI(e){return ZI(e)}function QI(e){return ZI(e)}function e_(e){return new HS(e)}function t_(e){return e_(e)}function n_(e){return e_(e)}function a_(e){return new KS(e)}function r_(e){return new ZS(e)}function s_(e){return new XS(e)}function i_(e){return new JS(e)}function o_(e){return new zS(e)}function l_(e){return new WS(e)}function u_(e){return new GS(e)}function d_(e){return new nS(e)}function c_(e){return new tS(e)}function p_(e){return new rS(e)}function h_(e){return new aS(e)}function m_(e){return new eS(e)}function f_(e){return new QN(e)}function g_(e){return new uS(e)}function x_(e){return new lS(e)}function b_(e){return new ZN(e)}function y_(e){return new sS(e)}function w_(e){return new tI(e)}function v_(e){return new eI(e)}pI.className="RandomWidth",vm.registerClass(pI);var k_=s_,N_=i_,S_=o_,I_=l_;function __(e){return new ES(e)}function C_(e){return new AS(e)}function T_(e){return new $S(e)}function E_(e){return new bS(e)}function A_(e){return new nI(e)}function $_(e){return new sI(e)}function R_(e){return new lI(e)}function F_(e){return new iI(e)}function D_(e){return new pI(e)}var M_={};function O_(e,t){return ik(e,t)}function j_(e,t){return dk(e,t)}function L_(e,t){return ck(e,t)}function z_(e,t){return ok(e,t)}function P_(e,t){return pk(e,t)}function B_(e,t){return uk(e,t)}function W_(e,t){return function(e,t){return to(()=>{let n=lk(e,t),a=function(e,t){return to(()=>pl(ld(Gd(zu(e,1),zu(t,0))),"float32"))}(e,t),r=fl(n,a);return pl(Pu(yd(r,0),xl(n,r),0),"float32")})}(e,t)}function V_(e,t){return ak(e,t)}function U_(e,t){return Jv(e,t)}function G_(e,t){return Qv(e,t)}function H_(e,t){return Qv(e,t)}function q_(e,t){return Qv(e,t)}function K_(e,t){return Zv(e,t)}function X_(e,t){return Zv(e,t)}function Y_(e,t){return Zv(e,t)}function Z_(e,t){return function(e,t){return to(()=>{let n=e.sub(t).square().sum(),a=e.sub(e.mean()).square().sum();return sd(1).sub(n.div(a))})}(e,t)}xe(M_,{MAPE:()=>H_,MSE:()=>X_,binaryAccuracy:()=>O_,binaryCrossentropy:()=>j_,categoricalAccuracy:()=>z_,categoricalCrossentropy:()=>P_,cosineProximity:()=>V_,mape:()=>q_,meanAbsoluteError:()=>U_,meanAbsolutePercentageError:()=>G_,meanSquaredError:()=>K_,mse:()=>Y_,precision:()=>B_,r2Score:()=>Z_,recall:()=>W_,sparseCategoricalAccuracy:()=>L_});var J_={};xe(J_,{modelFromJSON:()=>Gk});var Q_={};function eC(e){return new wN(e)}function tC(e){return function(e){return bN(e),new wN({l1:null!=e?e.l1:null,l2:0})}(e)}function nC(e){return function(e){return bN(e),new wN({l2:null!=e?e.l2:null,l1:0})}(e)}xe(Q_,{l1:()=>tC,l1l2:()=>eC,l2:()=>nC});var aC=class extends Bv{constructor(){super(...arguments),this.model=null}setModel(e){if(!(e instanceof Vk))throw new Error("model must be a LayersModel, not some other Container");this.model=e}};function rC(e,t){return e<t}function sC(e,t){return e>t}var iC,oC,lC=class extends aC{constructor(e){if(super(),null==e&&(e={}),e.restoreBestWeights)throw new ay("restoreBestWeights = True is not implemented in EarlyStopping yet.");this.monitor=e.monitor||"val_loss",this.minDelta=Math.abs(e.minDelta||0),this.patience=e.patience||0,this.verbose=e.verbose||0,this.mode=e.mode||"auto",this.baseline=e.baseline,-1===["auto","min","max"].indexOf(this.mode)&&(this.mode="auto"),"min"===this.mode?this.monitorFunc=rC:"max"===this.mode||-1!==this.monitor.indexOf("acc")?this.monitorFunc=sC:this.monitorFunc=rC,this.monitorFunc===rC&&(this.minDelta*=-1)}async onTrainBegin(e){this.wait=0,this.stoppedEpoch=0,null!=this.baseline?this.best=this.baseline:this.best=this.monitorFunc===rC?1/0:-1/0}async onEpochEnd(e,t){await zv(t);let n=this.getMonitorValue(t);null!=n&&(this.monitorFunc(n-this.minDelta,this.best)?(this.best=n,this.wait=0):(this.wait++,this.wait>=this.patience&&(this.stoppedEpoch=e,this.model.stopTraining=!0)))}async onTrainEnd(e){this.stoppedEpoch>0&&this.verbose}getMonitorValue(e){return null==e&&(e={}),e[this.monitor]}},uC={earlyStopping:function(e){return new lC(e)}};Pt().registerFlag("KEEP_INTERMEDIATE_TENSORS",()=>!1,e=>{}),function(e){e[e.DT_INVALID=0]="DT_INVALID",e[e.DT_FLOAT=1]="DT_FLOAT",e[e.DT_DOUBLE=2]="DT_DOUBLE",e[e.DT_INT32=3]="DT_INT32",e[e.DT_UINT8=4]="DT_UINT8",e[e.DT_INT16=5]="DT_INT16",e[e.DT_INT8=6]="DT_INT8",e[e.DT_STRING=7]="DT_STRING",e[e.DT_COMPLEX64=8]="DT_COMPLEX64",e[e.DT_INT64=9]="DT_INT64",e[e.DT_BOOL=10]="DT_BOOL",e[e.DT_QINT8=11]="DT_QINT8",e[e.DT_QUINT8=12]="DT_QUINT8",e[e.DT_QINT32=13]="DT_QINT32",e[e.DT_BFLOAT16=14]="DT_BFLOAT16",e[e.DT_QINT16=15]="DT_QINT16",e[e.DT_QUINT16=16]="DT_QUINT16",e[e.DT_UINT16=17]="DT_UINT16",e[e.DT_COMPLEX128=18]="DT_COMPLEX128",e[e.DT_HALF=19]="DT_HALF",e[e.DT_RESOURCE=20]="DT_RESOURCE",e[e.DT_VARIANT=21]="DT_VARIANT",e[e.DT_UINT32=22]="DT_UINT32",e[e.DT_UINT64=23]="DT_UINT64",e[e.DT_FLOAT_REF=101]="DT_FLOAT_REF",e[e.DT_DOUBLE_REF=102]="DT_DOUBLE_REF",e[e.DT_INT32_REF=103]="DT_INT32_REF",e[e.DT_UINT8_REF=104]="DT_UINT8_REF",e[e.DT_INT16_REF=105]="DT_INT16_REF",e[e.DT_INT8_REF=106]="DT_INT8_REF",e[e.DT_STRING_REF=107]="DT_STRING_REF",e[e.DT_COMPLEX64_REF=108]="DT_COMPLEX64_REF",e[e.DT_INT64_REF=109]="DT_INT64_REF",e[e.DT_BOOL_REF=110]="DT_BOOL_REF",e[e.DT_QINT8_REF=111]="DT_QINT8_REF",e[e.DT_QUINT8_REF=112]="DT_QUINT8_REF",e[e.DT_QINT32_REF=113]="DT_QINT32_REF",e[e.DT_BFLOAT16_REF=114]="DT_BFLOAT16_REF",e[e.DT_QINT16_REF=115]="DT_QINT16_REF",e[e.DT_QUINT16_REF=116]="DT_QUINT16_REF",e[e.DT_UINT16_REF=117]="DT_UINT16_REF",e[e.DT_COMPLEX128_REF=118]="DT_COMPLEX128_REF",e[e.DT_HALF_REF=119]="DT_HALF_REF",e[e.DT_RESOURCE_REF=120]="DT_RESOURCE_REF",e[e.DT_VARIANT_REF=121]="DT_VARIANT_REF",e[e.DT_UINT32_REF=122]="DT_UINT32_REF",e[e.DT_UINT64_REF=123]="DT_UINT64_REF"}(iC||(iC={})),function(e){var t;(t=e.CheckpointFormatVersion||(e.CheckpointFormatVersion={}))[t.LEGACY=0]="LEGACY",t[t.V1=1]="V1",t[t.V2=2]="V2"}(oC||(oC={}));var dC={};function cC(e,t){let n={tfOpName:e,category:"custom",inputs:[],attrs:[],customExecutor:t};dC[e]=n}function pC(e){return dC[e]}function hC(e){delete dC[e]}function mC(e,t,n,a,r){let s=t.inputParams[e];if(s&&void 0!==s.inputIndexStart){let e=s.inputIndexStart,i=0===s.inputIndexEnd?void 0:void 0===s.inputIndexEnd?e+1:s.inputIndexEnd,o=e<0?t.inputNames.length+e:e;if("tensor"===s.type)return fC(t.inputNames[o],n,a,r);if("tensors"===s.type){let s=t.inputs.slice(e,i);return t.inputNames.slice(e,i).filter((e,t)=>{var n;return"NoOp"!==(null===(n=s[t])||void 0===n?void 0:n.op)}).map(e=>fC(e,n,a,r))}let l=fC(t.inputNames[o],n,a,r),u=l.dataSync();return"number"===s.type?u[0]:Ns.toNestedArray(l.shape,u)}let i=t.attrParams[e];return i&&i.value}function fC(e,t,n,a){let[r,s]=yC(e,n);if(null!=a){let e=a.getHashTableHandleByName(r);if(null!=e)return e}let i=n.currentContextIds.find(e=>!!t[bC(r,e)]);return void 0!==i?t[bC(r,i)][s]:void 0}function gC(e,t,n){return t[bC(e,n.currentContextId)]}function xC(e,t){let[n,a,r]=yC(e,t);return[bC(n,t&&t.currentContextId),a,r]}function bC(e,t){return t?`${e}-${t}`:e}function yC(e,t){if(""===e)return["",0,void 0];let n=null!=t&&null!=t.parseNodeNameCache;if(n){let n=t.parseNodeNameCache.get(e);if(null!=n)return n}let a,r=e.split(":");if(1===r.length)a=[e,0,void 0];else{let e=r[0],t=3===r.length?r[1]:void 0;a=[e,Number(r[r.length-1]),t]}return n&&t.parseNodeNameCache.set(e,a),a}function wC(e,t,n){let a=mC("pad",e,t,n);if("explicit"===a){a=mC("explicitPaddings",e,t,n);let r=[[0,0],[0,0],[0,0],[0,0]];for(let e=0;e<4;e++)r[e][0]=a[2*e],r[e][1]=a[2*e+1];return r}return a}function vC(e){return e.kept?e:hl(e)}var kC={};xe(kC,{json:()=>NC});var NC=[{tfOpName:"Add",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AddV2",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AddN",category:"arithmetic",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}]},{tfOpName:"BiasAdd",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"Sub",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"RealDiv",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Div",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"DivNoNan",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"FloorDiv",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Mul",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Maximum",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Minimum",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Pow",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"SquaredDifference",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Mod",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"FloorMod",category:"arithmetic",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}],SC={};xe(SC,{json:()=>IC});var IC=[{tfOpName:"Abs",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Acos",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Asin",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atan2",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Ceil",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ClipByValue",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"clipValueMin",type:"number"},{start:2,name:"clipValueMax",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Complex",category:"basic_math",inputs:[{start:0,name:"real",type:"tensor"},{start:1,name:"imag",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ComplexAbs",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cos",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cosh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Elu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Exp",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Floor",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Log",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Imag",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"Tout",name:"outputType",type:"dtype",notSupported:!0}]},{tfOpName:"Neg",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Real",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"Tout",name:"outputType",type:"dtype",notSupported:!0}]},{tfOpName:"Prelu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"alpha",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Relu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Relu6",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Selu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sigmoid",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sin",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sinh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sqrt",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Rsqrt",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Square",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Tan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Tanh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Sign",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Round",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Expm1",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Log1p",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Reciprocal",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Softplus",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Asinh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Acosh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Atanh",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Erf",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LeakyRelu",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"alpha",name:"alpha",type:"number",defaultValue:.2},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"IsNan",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"IsFinite",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"IsInf",category:"basic_math",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}],_C={};xe(_C,{json:()=>CC});var CC=[{tfOpName:"EmptyTensorList",category:"control",inputs:[{start:0,name:"elementShape",type:"shape"},{start:1,name:"maxNumElements",type:"number"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"LoopCond",category:"control",inputs:[{start:0,name:"pred",type:"tensor"}]},{tfOpName:"Switch",category:"control",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"pred",type:"tensor"}]},{tfOpName:"Merge",category:"control",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}]},{tfOpName:"Enter",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"frame_name",name:"frameName",type:"string"},{tfName:"is_constant",name:"isConstant",type:"bool"}]},{tfOpName:"Exit",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"NextIteration",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayV3",category:"control",inputs:[{start:0,name:"size",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape",name:"elementShape",type:"shape"},{tfName:"dynamic_size",name:"dynamicSize",type:"bool"},{tfName:"clear_after_read",name:"clearAfterRead",type:"bool"},{tfName:"identical_element_shapes",name:"identicalElementShapes",type:"bool"},{tfName:"tensor_array_name",name:"name",type:"string"}]},{tfOpName:"TensorArrayWriteV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"index",type:"number"},{start:2,name:"tensor",type:"tensor"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayReadV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"index",type:"number"},{start:2,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"TensorArrayGatherV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"indices",type:"number[]"},{start:2,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape",name:"elementShape",type:"shape"}]},{tfOpName:"TensorArrayScatterV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"indices",type:"number[]"},{start:2,name:"tensor",type:"tensor"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"TensorArrayConcatV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"flowIn",type:"number"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"element_shape_except0",name:"elementShapeExcept0",type:"shape",notSupported:!0}]},{tfOpName:"TensorArraySplitV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"tensor",type:"tensor"},{start:2,name:"lengths",type:"number[]"},{start:3,name:"flowIn",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"TensorArraySizeV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"},{start:1,name:"flowIn",type:"number"}]},{tfOpName:"TensorArrayCloseV3",category:"control",inputs:[{start:0,name:"tensorArrayId",type:"tensor"}]},{tfOpName:"StatelessIf",category:"control",inputs:[{start:0,name:"cond",type:"tensor"},{start:1,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"then_branch",name:"thenBranch",type:"func"},{tfName:"else_branch",name:"elseBranch",type:"func"}]},{tfOpName:"If",category:"control",inputs:[{start:0,name:"cond",type:"tensor"},{start:1,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"then_branch",name:"thenBranch",type:"func"},{tfName:"else_branch",name:"elseBranch",type:"func"}]},{tfOpName:"StatelessWhile",category:"control",inputs:[{start:0,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"cond",name:"cond",type:"func"},{tfName:"body",name:"body",type:"func"}]},{tfOpName:"While",category:"control",inputs:[{start:0,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"cond",name:"cond",type:"func"},{tfName:"body",name:"body",type:"func"}]},{tfOpName:"TensorListScatter",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"},{start:1,name:"indices",type:"number[]"},{start:2,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListScatterV2",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"},{start:1,name:"indices",type:"number[]"},{start:2,name:"elementShape",type:"shape"},{start:3,name:"numElements",type:"number"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListGather",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"indices",type:"number[]"},{start:2,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListGetItem",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"index",type:"number"},{start:2,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListSetItem",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"index",type:"number"},{start:2,name:"tensor",type:"tensor"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListReserve",category:"control",inputs:[{start:0,name:"elementShape",type:"shape"},{start:1,name:"numElements",type:"number"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListFromTensor",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"},{start:1,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListStack",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"},{tfName:"num_elements",name:"numElements",type:"dtype"}]},{tfOpName:"TensorListSplit",category:"control",inputs:[{start:0,name:"tensor",type:"tensor"},{start:1,name:"elementShape",type:"shape"},{start:2,name:"lengths",type:"number[]"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListConcat",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"}],attrs:[{tfName:"element_shape",name:"elementShape",type:"shape"},{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListConcatV2",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"}],attrs:[{tfName:"element_shape",name:"elementShape",type:"shape"},{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListPopBack",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"elementShape",type:"shape"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListPushBack",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"tensor",type:"tensor"}],attrs:[{tfName:"element_dtype",name:"elementDType",type:"dtype"}]},{tfOpName:"TensorListLength",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"}]},{tfOpName:"TensorListResize",category:"control",inputs:[{start:0,name:"tensorListId",type:"tensor"},{start:1,name:"size",type:"number"}]}],TC={};xe(TC,{json:()=>EC});var EC=[{tfOpName:"AvgPool",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPool",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[],notSupported:!0},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPoolWithArgmax",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"include_batch_in_index",name:"includeBatchInIndex",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"AvgPool3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MaxPool3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"ksize",name:"kernelSize",type:"number[]"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Conv1D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"stride",name:"stride",type:"number"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NWC"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"dilation",name:"dilation",type:"number",defaultValue:1}]},{tfOpName:"Conv2D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"useCudnnOnGpu",name:"useCudnnOnGpu",type:"bool"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"_FusedConv2D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"},{start:2,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"num_args",name:"numArgs",type:"number"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]},{tfName:"use_cudnn_on_gpu",name:"useCudnnOnGpu",type:"bool",defaultValue:!0},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]",defaultValue:[1,1,1,1]},{tfName:"fused_ops",name:"fusedOps",type:"string[]",defaultValue:[]},{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:1e-4},{tfName:"leakyrelu_alpha",name:"leakyreluAlpha",type:"number",defaultValue:.2}]},{tfOpName:"Conv2DBackpropInput",category:"convolution",inputs:[{start:2,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"},{start:0,name:"outputShape",type:"number[]"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]},{tfName:"dilations",name:"dilations",type:"number[]",notSupported:!0}]},{tfOpName:"DepthwiseConv2d",category:"convolution",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"DepthwiseConv2dNative",category:"convolution",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"FusedDepthwiseConv2dNative",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"},{start:2,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"num_args",name:"numArgs",type:"number"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]",defaultValue:[1,1,1,1]},{tfName:"fused_ops",name:"fusedOps",type:"string[]",defaultValue:[]},{tfName:"explicit_paddings",name:"explicitPaddings",type:"number[]",defaultValue:[]}]},{tfOpName:"Conv3D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"padding",name:"pad",type:"string"},{tfName:"data_format",name:"dataFormat",type:"string",defaultValue:"NHWC"},{tfName:"dilations",name:"dilations",type:"number[]"}]},{tfOpName:"Dilation2D",category:"convolution",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"filter",type:"tensor"}],attrs:[{tfName:"strides",name:"strides",type:"number[]"},{tfName:"rates",name:"dilations",type:"number[]"},{tfName:"padding",name:"pad",type:"string"}]}],AC={};xe(AC,{json:()=>$C});var $C=[{tfOpName:"Fill",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"},{start:1,name:"value",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"LinSpace",category:"creation",inputs:[{start:0,name:"start",type:"number"},{start:1,name:"stop",type:"number"},{start:2,name:"num",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"OneHot",category:"creation",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"depth",type:"number"},{start:2,name:"onValue",type:"number",defaultValue:1},{start:3,name:"offValue",type:"number",defaultValue:0}],attrs:[{tfName:"axis",name:"axis",type:"number",notSupported:!0},{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"Ones",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"OnesLike",category:"creation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"RandomStandardNormal",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"seed",name:"seed",type:"number",defaultValue:0},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"RandomUniform",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"minval",name:"minval",type:"number",defaultValue:0},{tfName:"maxval",name:"maxval",type:"number",defaultValue:1},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"seed",name:"seed",type:"number",defaultValue:0},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"RandomUniformInt",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"minval",name:"minval",type:"number"},{tfName:"maxval",name:"maxval",type:"number"},{tfName:"seed",name:"seed",type:"number",defaultValue:0},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0}]},{tfOpName:"Range",category:"creation",inputs:[{start:0,name:"start",type:"number"},{start:1,name:"stop",type:"number"},{start:2,name:"step",type:"number",defaultValue:0}],attrs:[{tfName:"Tidx",name:"dtype",type:"dtype"}]},{tfOpName:"TruncatedNormal",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"means",name:"mean",type:"number",defaultValue:0},{tfName:"stddev",name:"stdDev",type:"number",defaultValue:1},{tfName:"seed",name:"seed",type:"number"},{tfName:"seed2",name:"seed2",type:"number",defaultValue:0,notSupported:!0},{tfName:"dtype",name:"dtype",type:"dtype"},{tfName:"T",name:"T",type:"number",notSupported:!0}]},{tfOpName:"Zeros",category:"creation",inputs:[{start:0,name:"shape",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"ZerosLike",category:"creation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"Multinomial",category:"creation",inputs:[{start:0,name:"logits",type:"tensor"},{start:1,name:"numSamples",type:"number"}],attrs:[{tfName:"seed",name:"seed",type:"number"},{tfName:"seed2",name:"seed2",type:"number"},{tfName:"T",name:"dtype",type:"dtype"},{tfName:"output_dtype",name:"output_dtype",type:"dtype"}]}],RC={};xe(RC,{json:()=>FC});var FC=[{tfOpName:"NonMaxSuppressionV2",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"}]},{tfOpName:"NonMaxSuppressionV3",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"},{start:4,name:"scoreThreshold",type:"number"}]},{tfOpName:"NonMaxSuppressionV4",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"},{start:4,name:"scoreThreshold",type:"number"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0},{tfName:"T_threshold",name:"threshold",type:"dtype",notSupported:!0},{tfName:"pad_to_max_output_size",name:"padToMaxOutputSize",type:"bool"}]},{tfOpName:"NonMaxSuppressionV5",category:"dynamic",inputs:[{start:0,name:"boxes",type:"tensor"},{start:1,name:"scores",type:"tensor"},{start:2,name:"maxOutputSize",type:"number"},{start:3,name:"iouThreshold",type:"number"},{start:4,name:"scoreThreshold",type:"number"},{start:5,name:"softNmsSigma",type:"number"}]},{tfOpName:"Where",category:"dynamic",inputs:[{start:0,name:"condition",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ListDiff",category:"dynamic",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]}],DC={};xe(DC,{json:()=>MC});var MC=[{tfOpName:"LowerBound",category:"evaluation",inputs:[{start:0,name:"sortedSequence",type:"tensor"},{start:1,name:"values",type:"tensor"}]},{tfOpName:"TopKV2",category:"evaluation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"k",type:"number"}],attrs:[{tfName:"sorted",name:"sorted",type:"bool"}]},{tfOpName:"UpperBound",category:"evaluation",inputs:[{start:0,name:"sortedSequence",type:"tensor"},{start:1,name:"values",type:"tensor"}]},{tfOpName:"Unique",category:"evaluation",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"UniqueV2",category:"evaluation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]}],OC={};xe(OC,{json:()=>jC});var jC=[{tfOpName:"PlaceholderWithDefault",category:"graph",inputs:[{start:0,name:"default",type:"tensor"}],attrs:[{tfName:"shape",name:"shape",type:"shape"},{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"Placeholder",category:"graph",attrs:[{tfName:"shape",name:"shape",type:"shape"},{tfName:"dtype",name:"dtype",type:"dtype"}]},{tfOpName:"Const",category:"graph"},{tfOpName:"Identity",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"IdentityN",category:"graph",inputs:[{start:0,end:0,name:"x",type:"tensors"}]},{tfOpName:"Snapshot",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Rank",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Size",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"Shape",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"ShapeN",category:"graph",inputs:[{start:0,end:0,name:"x",type:"tensors"}]},{tfOpName:"Print",category:"graph",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"data",type:"tensors"}],attrs:[{tfName:"message",name:"message",type:"string"},{tfName:"first_n",name:"firstN",type:"number",notSupported:!0},{tfName:"summarize",name:"summarize",type:"number",defaultValue:3}]},{tfOpName:"NoOp",category:"graph",inputs:[]},{tfOpName:"StopGradient",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"FakeQuantWithMinMaxVars",category:"graph",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"min",name:"min",type:"number"},{tfName:"max",name:"max",type:"number"}]}],LC={};xe(LC,{json:()=>zC});var zC=[{tfOpName:"HashTable",category:"hash_table",inputs:[],attrs:[{tfName:"shared_name",name:"sharedName",type:"string"},{tfName:"use_node_name_sharing",name:"useNodeNameSharing",type:"bool"},{tfName:"key_dtype",name:"keyDType",type:"dtype"},{tfName:"value_dtype",name:"valueDType",type:"dtype"}]},{tfOpName:"HashTableV2",category:"hash_table",inputs:[],attrs:[{tfName:"shared_name",name:"sharedName",type:"string"},{tfName:"use_node_name_sharing",name:"useNodeNameSharing",type:"bool"},{tfName:"key_dtype",name:"keyDType",type:"dtype"},{tfName:"value_dtype",name:"valueDType",type:"dtype"}]},{tfOpName:"LookupTableImport",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"values",type:"tensor"}],attrs:[{tfName:"Tin",name:"tIn",type:"dtype",notSupported:!0},{tfName:"Tout",name:"tOut",type:"dtype",notSupported:!0}]},{tfOpName:"LookupTableImportV2",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"values",type:"tensor"}],attrs:[{tfName:"Tin",name:"tIn",type:"dtype",notSupported:!0},{tfName:"Tout",name:"tOut",type:"dtype",notSupported:!0}]},{tfOpName:"LookupTableFind",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"Tin",name:"tIn",type:"dtype",notSupported:!0},{tfName:"Tout",name:"tOut",type:"dtype",notSupported:!0}]},{tfOpName:"LookupTableFindV2",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"Tin",name:"tIn",type:"dtype",notSupported:!0},{tfName:"Tout",name:"tOut",type:"dtype",notSupported:!0}]},{tfOpName:"LookupTableSize",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"}]},{tfOpName:"LookupTableSizeV2",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"}]},{tfOpName:"InitializeTable",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"values",type:"tensor"}]},{tfOpName:"InitializeTableV2",category:"hash_table",inputs:[{start:0,name:"tableHandle",type:"tensor"},{start:1,name:"keys",type:"tensor"},{start:2,name:"values",type:"tensor"}]}],PC={};xe(PC,{json:()=>BC});var BC=[{tfOpName:"ResizeBilinear",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"size",type:"number[]"}],attrs:[{tfName:"align_corners",name:"alignCorners",type:"bool"},{tfName:"half_pixel_centers",name:"halfPixelCenters",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"ResizeNearestNeighbor",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"size",type:"number[]"}],attrs:[{tfName:"align_corners",name:"alignCorners",type:"bool"},{tfName:"half_pixel_centers",name:"halfPixelCenters",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"CropAndResize",category:"image",inputs:[{start:0,name:"image",type:"tensor"},{start:1,name:"boxes",type:"tensor"},{start:2,name:"boxInd",type:"tensor"},{start:3,name:"cropSize",type:"number[]"}],attrs:[{tfName:"method",name:"method",type:"string"},{tfName:"extrapolation_value",name:"extrapolationValue",type:"number"}]},{tfOpName:"ImageProjectiveTransformV3",category:"image",inputs:[{start:0,name:"images",type:"tensor"},{start:1,name:"transforms",type:"tensor"},{start:2,name:"outputShape",type:"number[]"},{start:3,name:"fillValue",type:"number"}],attrs:[{tfName:"interpolation",name:"interpolation",type:"string"},{tfName:"fill_mode",name:"fillMode",type:"string"}]}],WC={};xe(WC,{json:()=>VC});var VC=[{tfOpName:"Equal",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"NotEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Greater",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"GreaterEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Less",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LessEqual",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalAnd",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalNot",category:"logical",inputs:[{start:0,name:"a",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"LogicalOr",category:"logical",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Select",category:"logical",inputs:[{start:0,name:"condition",type:"tensor"},{start:1,name:"a",type:"tensor"},{start:2,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"SelectV2",category:"logical",inputs:[{start:0,name:"condition",type:"tensor"},{start:1,name:"a",type:"tensor"},{start:2,name:"b",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BitwiseAnd",category:"logical",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"y",type:"tensor"}]}],UC={};xe(UC,{json:()=>GC});var GC=[{tfOpName:"_FusedMatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"},{start:2,end:0,name:"args",type:"tensors"}],attrs:[{tfName:"num_args",name:"numArgs",type:"number"},{tfName:"fused_ops",name:"fusedOps",type:"string[]",defaultValue:[]},{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:1e-4},{tfName:"transpose_a",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"transpose_b",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"leakyrelu_alpha",name:"leakyreluAlpha",type:"number",defaultValue:.2},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"MatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"transpose_a",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"transpose_b",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BatchMatMul",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"adj_x",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"adj_y",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"BatchMatMulV2",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"b",type:"tensor"}],attrs:[{tfName:"adj_x",name:"transposeA",type:"bool",defaultValue:!1},{tfName:"adj_y",name:"transposeB",type:"bool",defaultValue:!1},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Transpose",category:"matrices",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"perm",type:"number[]"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Einsum",category:"matrices",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}],attrs:[{tfName:"equation",name:"equation",type:"string"},{tfName:"N",name:"n",type:"number",defaultValue:2},{tfName:"T",name:"dtype",type:"dtype"}]},{tfOpName:"MatrixBandPart",category:"matrices",inputs:[{start:0,name:"a",type:"tensor"},{start:1,name:"numLower",type:"tensor"},{start:1,name:"numUpper",type:"tensor"}]}],HC={};xe(HC,{json:()=>qC});var qC=[{tfOpName:"EuclideanNorm",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool",defaultValue:!1}]},{tfOpName:"FusedBatchNorm",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"FusedBatchNormV2",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"FusedBatchNormV3",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"scale",type:"tensor"},{start:2,name:"offset",type:"tensor"},{start:3,name:"mean",type:"tensor"},{start:4,name:"variance",type:"tensor"}],attrs:[{tfName:"epsilon",name:"epsilon",type:"number",defaultValue:.001},{tfName:"data_format",name:"dataFormat",type:"string",notSupported:!0}]},{tfOpName:"LRN",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"depth_radius",name:"radius",type:"number",defaultValue:5},{tfName:"bias",name:"bias",type:"number",defaultValue:1},{tfName:"alpha",name:"alpha",type:"number",defaultValue:1},{tfName:"beta",name:"beta",type:"number",defaultValue:.5}]},{tfOpName:"Softmax",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"LogSoftmax",category:"normalization",inputs:[{start:0,name:"x",type:"tensor"}]}],KC={};xe(KC,{json:()=>XC});var XC=[{tfOpName:"Bincount",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"size",type:"number"},{start:2,name:"weights",type:"tensor"}]},{tfOpName:"DenseBincount",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"size",type:"number"},{start:2,name:"weights",type:"tensor"}],attrs:[{tfName:"binary_output",name:"binaryOutput",type:"bool"}]},{tfOpName:"Max",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Mean",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Min",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Sum",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"All",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"Any",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"}]},{tfOpName:"ArgMax",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"ArgMin",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"Prod",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}],attrs:[{tfName:"keep_dims",name:"keepDims",type:"bool"},{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"Cumprod",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}],attrs:[{tfName:"exclusive",name:"exclusive",type:"bool"},{tfName:"reverse",name:"reverse",type:"bool"}]},{tfOpName:"Cumsum",category:"reduction",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}],attrs:[{tfName:"exclusive",name:"exclusive",type:"bool"},{tfName:"reverse",name:"reverse",type:"bool"}]}],YC={};xe(YC,{json:()=>ZC});var ZC=[{tfOpName:"ConcatV2",category:"slice_join",inputs:[{start:0,end:-1,name:"tensors",type:"tensors"},{start:-1,name:"axis",type:"number"}],attrs:[{tfName:"N",name:"n",type:"number",defaultValue:2}]},{tfOpName:"Concat",category:"slice_join",inputs:[{start:1,end:0,name:"tensors",type:"tensors"},{start:0,name:"axis",type:"number"}],attrs:[{tfName:"N",name:"n",type:"number",defaultValue:2}]},{tfOpName:"GatherV2",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"axis",type:"number",defaultValue:0}],attrs:[{tfName:"batch_dims",name:"batchDims",type:"number",defaultValue:0}]},{tfOpName:"Gather",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"}],attrs:[{tfName:"validate_indices",name:"validateIndices",type:"bool",notSupported:!0}]},{tfOpName:"Reverse",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"dims",type:"bool[]"}]},{tfOpName:"ReverseV2",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number[]"}]},{tfOpName:"Slice",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"begin",type:"number[]"},{start:2,name:"size",type:"number[]"}]},{tfOpName:"StridedSlice",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"begin",type:"number[]"},{start:2,name:"end",type:"number[]"},{start:3,name:"strides",type:"number[]"}],attrs:[{tfName:"begin_mask",name:"beginMask",type:"number",defaultValue:0},{tfName:"end_mask",name:"endMask",type:"number",defaultValue:0},{tfName:"new_axis_mask",name:"newAxisMask",type:"number",defaultValue:0},{tfName:"ellipsis_mask",name:"ellipsisMask",type:"number",defaultValue:0},{tfName:"shrink_axis_mask",name:"shrinkAxisMask",type:"number",defaultValue:0}]},{tfOpName:"Pack",category:"slice_join",inputs:[{start:0,end:0,name:"tensors",type:"tensors"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0}]},{tfOpName:"Unpack",category:"slice_join",inputs:[{start:0,name:"tensor",type:"tensor"}],attrs:[{tfName:"axis",name:"axis",type:"number",defaultValue:0},{tfName:"num",name:"num",type:"number",defaultValue:0,notSupported:!0}]},{tfOpName:"Tile",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"reps",type:"number[]"}]},{tfOpName:"Split",category:"slice_join",inputs:[{start:0,name:"axis",type:"number",defaultValue:0},{start:1,name:"x",type:"tensor"}],attrs:[{tfName:"num_split",name:"numOrSizeSplits",type:"number",defaultValue:1}]},{tfOpName:"SplitV",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"numOrSizeSplits",type:"number[]"},{start:2,name:"axis",type:"number",defaultValue:0}]},{tfOpName:"ScatterNd",category:"slice_join",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"values",type:"tensor"},{start:2,name:"shape",type:"number[]"}]},{tfOpName:"GatherNd",category:"slice_join",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"indices",type:"tensor"}]},{tfOpName:"SparseToDense",category:"slice_join",inputs:[{start:0,name:"sparseIndices",type:"tensor"},{start:1,name:"outputShape",type:"number[]"},{start:2,name:"sparseValues",type:"tensor"},{start:3,name:"defaultValue",type:"tensor"}],attrs:[{tfName:"validate_indices",name:"validateIndices",type:"bool",defaultValue:!1,notSupported:!0}]},{tfOpName:"TensorScatterUpdate",category:"slice_join",inputs:[{start:0,name:"tensor",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"values",type:"tensor"}]}],JC={};xe(JC,{json:()=>QC});var QC=[{tfOpName:"SparseFillEmptyRows",category:"sparse",inputs:[{start:0,name:"indices",type:"tensor"},{start:1,name:"values",type:"tensor"},{start:2,name:"denseShape",type:"tensor"},{start:3,name:"defaultValue",type:"tensor"}]},{tfOpName:"SparseReshape",category:"sparse",inputs:[{start:0,name:"inputIndices",type:"tensor"},{start:1,name:"inputShape",type:"tensor"},{start:2,name:"newShape",type:"tensor"}],attrs:[{tfName:"T",name:"dtype",type:"dtype",notSupported:!0}]},{tfOpName:"SparseSegmentMean",category:"sparse",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"segmentIds",type:"tensor"}]},{tfOpName:"SparseSegmentSum",category:"sparse",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"indices",type:"tensor"},{start:2,name:"segmentIds",type:"tensor"}]}],eT={};xe(eT,{json:()=>tT});var tT=[{tfOpName:"FFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"IFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"}]},{tfOpName:"RFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"fft_length",type:"number",notSupported:!0}]},{tfOpName:"IRFFT",category:"spectral",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"fft_length",type:"number",notSupported:!0}]}],nT={};xe(nT,{json:()=>aT});var aT=[{tfOpName:"StaticRegexReplace",category:"string",inputs:[{start:0,name:"input",type:"tensor"}],attrs:[{tfName:"pattern",name:"pattern",type:"string"},{tfName:"rewrite",name:"rewrite",type:"string"},{tfName:"replace_global",name:"replaceGlobal",type:"bool"}]},{tfOpName:"StringNGrams",category:"string",inputs:[{start:0,name:"data",type:"tensor"},{start:1,name:"dataSplits",type:"tensor"}],attrs:[{tfName:"separator",name:"separator",type:"string"},{tfName:"ngram_widths",name:"nGramWidths",type:"number[]"},{tfName:"left_pad",name:"leftPad",type:"string"},{tfName:"right_pad",name:"rightPad",type:"string"},{tfName:"pad_width",name:"padWidth",type:"number"},{tfName:"preserve_short_sequences",name:"preserveShortSequences",type:"bool"}],outputs:["ngrams","ngrams_splits"]},{tfOpName:"StringSplit",category:"string",inputs:[{start:0,name:"input",type:"tensor"},{start:1,name:"delimiter",type:"tensor"}],attrs:[{tfName:"skip_empty",name:"skipEmpty",type:"bool"}],outputs:["indices","values","shape"]},{tfOpName:"StringToHashBucketFast",category:"string",inputs:[{start:0,name:"input",type:"tensor"}],attrs:[{tfName:"num_buckets",name:"numBuckets",type:"number"}]}],rT={};xe(rT,{json:()=>sT});var sT=[{tfOpName:"Cast",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"SrcT",name:"sdtype",type:"dtype",notSupported:!0},{tfName:"DstT",name:"dtype",type:"dtype"}]},{tfOpName:"ExpandDims",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"axis",type:"number"}]},{tfOpName:"MirrorPad",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"}],attrs:[{tfName:"mode",name:"mode",type:"string"}]},{tfOpName:"Pad",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"}],attrs:[{tfName:"constant_value",name:"constantValue",type:"number",defaultValue:0}]},{tfOpName:"PadV2",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"padding",type:"number[]"},{start:2,name:"constantValue",type:"number",defaultValue:0}]},{tfOpName:"Reshape",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"shape",type:"number[]"}]},{tfOpName:"EnsureShape",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"shape",type:"number[]"}]},{tfOpName:"Squeeze",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"axis",tfDeprecatedName:"squeeze_dims",name:"axis",type:"number[]"}]},{tfOpName:"SpaceToBatchND",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"blockShape",type:"number[]"},{start:2,name:"paddings",type:"number[]"}]},{tfOpName:"BatchToSpaceND",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"blockShape",type:"number[]"},{start:2,name:"crops",type:"number[]"}]},{tfOpName:"DepthToSpace",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"}],attrs:[{tfName:"block_size",name:"blockSize",type:"number"},{tfName:"data_format",name:"dataFormat",type:"string"}]},{tfOpName:"BroadcastTo",category:"transformation",inputs:[{start:0,name:"x",type:"tensor"},{start:1,name:"shape",type:"number[]"}],attrs:[]},{tfOpName:"BroadcastArgs",category:"transformation",inputs:[{start:0,name:"s0",type:"tensor"},{start:1,name:"s1",type:"tensor"}],attrs:[]}],iT=class{static get Instance(){return this._instance||(this._instance=new this)}constructor(){let e=[].concat(...[kC,SC,_C,TC,AC,RC,DC,OC,LC,PC,WC,UC,HC,KC,YC,JC,eT,nT,rT].map(e=>e.json));this.opMappers=e.reduce((e,t)=>(e[t.tfOpName]=t,e),{})}transformGraph(e,t={}){let n=e.node,a=[],r=[],s=[],i=n.reduce((e,t)=>(e[t.name]=this.mapNode(t),t.op.startsWith("Placeholder")?a.push(e[t.name]):"Const"===t.op?r.push(e[t.name]):(null==t.input||0===t.input.length)&&s.push(e[t.name]),e),{}),o=[],l=[],u={},d={};null!=t&&(u=this.mapSignatureEntries(t.inputs),d=this.mapSignatureEntries(t.outputs));let c=Object.keys(i);c.forEach(e=>{let t=i[e];t.inputNames.forEach((e,n)=>{let[a,,r]=xC(e),s=i[a];if(null!=s.outputs){let e=s.outputs.indexOf(r);if(-1!==e){let r=`${a}:${e}`;t.inputNames[n]=r}}t.inputs.push(s),s.children.push(t)})}),0===Object.keys(d).length?c.forEach(e=>{let t=i[e];0===t.children.length&&l.push(t)}):Object.keys(d).forEach(e=>{let[t]=xC(e),n=i[t];null!=n&&(n.signatureKey=d[e],l.push(n))}),Object.keys(u).length>0?Object.keys(u).forEach(e=>{let[t]=xC(e),n=i[t];n&&(n.signatureKey=u[e],o.push(n))}):o=a;let p={};null!=e.library&&null!=e.library.function&&(p=e.library.function.reduce((e,t)=>(e[t.signature.name]=this.mapFunction(t),e),{}));let h={nodes:i,inputs:o,outputs:l,weights:r,placeholders:a,signature:t,functions:p};return s.length>0&&(h.initNodes=s),h}mapSignatureEntries(e){return Object.keys(e||{}).reduce((t,n)=>(t[e[n].name]=n,t),{})}mapNode(e){let t=pC(e.op)||this.opMappers[e.op]||{};null==e.attr&&(e.attr={});let n={name:e.name,op:e.op,category:t.category,inputNames:(e.input||[]).map(e=>e.startsWith("^")?e.slice(1):e),inputs:[],children:[],inputParams:{},attrParams:{},rawAttrs:e.attr,outputs:t.outputs};return null!=t.inputs&&(n.inputParams=t.inputs.reduce((e,t)=>(e[t.name]={type:t.type,inputIndexStart:t.start,inputIndexEnd:t.end},e),{})),null!=t.attrs&&(n.attrParams=t.attrs.reduce((t,n)=>{let a,r=n.type;switch(n.type){case"string":a=lT(e.attr,n.tfName,n.defaultValue),void 0===a&&n.tfDeprecatedName&&(a=lT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"string[]":a=bT(e.attr,n.tfName,n.defaultValue),void 0===a&&n.tfDeprecatedName&&(a=bT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"number":a=dT(e.attr,n.tfName,n.defaultValue||0),void 0===a&&n.tfDeprecatedName&&(a=dT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"number[]":a=xT(e.attr,n.tfName,n.defaultValue),void 0===a&&n.tfDeprecatedName&&(a=xT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"bool":a=uT(e.attr,n.tfName,n.defaultValue),void 0===a&&n.tfDeprecatedName&&(a=uT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"bool[]":a=wT(e.attr,n.tfName,n.defaultValue),void 0===a&&n.tfDeprecatedName&&(a=wT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"shape":a=gT(e.attr,n.tfName,n.defaultValue),void 0===a&&n.tfDeprecatedName&&(a=gT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"shape[]":a=yT(e.attr,n.tfName,n.defaultValue),void 0===a&&n.tfDeprecatedName&&(a=yT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"dtype":a=hT(e.attr,n.tfName,n.defaultValue),void 0===a&&n.tfDeprecatedName&&(a=hT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"dtype[]":a=mT(e.attr,n.tfName,n.defaultValue),void 0===a&&n.tfDeprecatedName&&(a=mT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"func":a=pT(e.attr,n.tfName,n.defaultValue),void 0===a&&n.tfDeprecatedName&&(a=pT(e.attr,n.tfDeprecatedName,n.defaultValue));break;case"tensor":case"tensors":break;default:throw new Error(`Unsupported param type: ${n.type} for op: ${e.op}`)}return t[n.name]={value:a,type:r},t},{})),n}mapFunction(e){let t=e.nodeDef,n=[],a={};null!=t&&(a=t.reduce((e,t)=>(e[t.name]=this.mapNode(t),"Const"===t.op&&n.push(e[t.name]),e),{}));let r=[],s=[];e.signature.inputArg.forEach(e=>{let[t]=xC(e.name),n={name:t,op:"Placeholder",inputs:[],inputNames:[],category:"graph",inputParams:{},attrParams:{dtype:{value:cT(e.type),type:"dtype"}},children:[]};n.signatureKey=e.name,r.push(n),a[t]=n}),Object.keys(a).forEach(e=>{let t=a[e];t.inputNames.forEach((e,n)=>{let[r,,s]=xC(e),i=a[r];if(null!=i.outputs){let e=i.outputs.indexOf(s);if(-1!==e){let a=`${r}:${e}`;t.inputNames[n]=a}}t.inputs.push(i),i.children.push(t)})});let i=e.ret;e.signature.outputArg.forEach(e=>{let[t,n]=xC(i[e.name]),r=a[t];null!=r&&(r.defaultOutput=n,s.push(r))});let o=this.mapArgsToSignature(e);return{nodes:a,inputs:r,outputs:s,weights:n,placeholders:[],signature:o}}mapArgsToSignature(e){return{methodName:e.signature.name,inputs:e.signature.inputArg.reduce((e,t)=>(e[t.name]=this.mapArgToTensorInfo(t),e),{}),outputs:e.signature.outputArg.reduce((t,n)=>(t[n.name]=this.mapArgToTensorInfo(n,e.ret),t),{})}}mapArgToTensorInfo(e,t){let n=e.name;return null!=t&&(n=t[n]),{name:n,dtype:e.type}}};function oT(e,t){let n=Array.isArray(e)?String.fromCharCode.apply(null,e):function(e){let t=Pt().global;if(void 0!==t.atob)return t.atob(e);if("undefined"!=typeof Buffer)return new Buffer(e,"base64").toString();throw new Error("Unable to decode base64 in this environment. Missing built-in atob() or Buffer()")}(e);return t?n:n.toLowerCase()}function lT(e,t,n,a=!1){let r=e[t];return null!=r?oT(r.s,a):n}function uT(e,t,n){let a=e[t];return a?a.b:n}function dT(e,t,n){let a=e[t]||{},r=null!=a.i?a.i:null!=a.f?a.f:n;return"number"==typeof r?r:parseInt(r,10)}function cT(e){switch("string"==typeof e&&(e=iC[e]),e){case iC.DT_FLOAT:case iC.DT_HALF:return"float32";case iC.DT_INT32:case iC.DT_INT64:case iC.DT_INT8:case iC.DT_UINT8:return"int32";case iC.DT_BOOL:return"bool";case iC.DT_DOUBLE:return"float32";case iC.DT_STRING:return"string";case iC.DT_COMPLEX64:case iC.DT_COMPLEX128:return"complex64";default:return null}}function pT(e,t,n){let a=e[t];return a&&a.func?a.func.name:n}function hT(e,t,n){let a=e[t];return a&&a.type?cT(a.type):n}function mT(e,t,n){let a=e[t];return a&&a.list&&a.list.type?a.list.type.map(e=>cT(e)):n}function fT(e){if(!e.unknownRank)return null!=e.dim?e.dim.map(e=>"number"==typeof e.size?e.size:parseInt(e.size,10)):[]}function gT(e,t,n){let a=e[t];return a&&a.shape?fT(a.shape):n}function xT(e,t,n){let a=e[t];return a?((a.list.f&&a.list.f.length?a.list.f:a.list.i)||[]).map(e=>"number"==typeof e?e:parseInt(e,10)):n}function bT(e,t,n,a=!1){let r=e[t];return r&&r.list&&r.list.s?r.list.s.map(e=>oT(e,a)):n}function yT(e,t,n){let a=e[t];return a&&a.list&&a.list.shape?a.list.shape.map(e=>fT(e)):n}function wT(e,t,n){let a=e[t];return a&&a.list&&a.list.b?a.list.b:n}var vT=class{constructor(e,t,n){this.node=e,this.tensorMap=t,this.context=n,this.inputs=[],this.attrs={},this.inputs=e.inputNames.map(e=>this.getInput(e)),null!=e.rawAttrs&&(this.attrs=Object.keys(e.rawAttrs).reduce((e,t)=>(e[t]=this.getAttr(t),e),{}))}getInput(e){return fC(e,this.tensorMap,this.context)}getAttr(e,t){let n=this.node.rawAttrs[e];if(null!=n.tensor)return fC(e,this.tensorMap,this.context);if(null!=n.i||null!=n.f)return dT(this.node.rawAttrs,e,t);if(null!=n.s)return lT(this.node.rawAttrs,e,t);if(null!=n.b)return uT(this.node.rawAttrs,e,t);if(null!=n.shape)return gT(this.node.rawAttrs,e,t);if(null!=n.type)return hT(this.node.rawAttrs,e,t);if(null!=n.list){if(null!=n.list.i||null!=n.list.f)return xT(this.node.rawAttrs,e,t);if(null!=n.list.s)return bT(this.node.rawAttrs,e,t);if(null!=n.list.shape)return yT(this.node.rawAttrs,e,t);if(null!=n.list.b)return wT(this.node.rawAttrs,e,t);if(null!=n.list.type)return mT(this.node.rawAttrs,e,t)}return t}},kT={};function NT(e,t,n=""){if("number"!=typeof e&&"number"!=typeof t){Ns.assert(e.length===t.length,()=>n+` Shapes ${e} and ${t} must match`);for(let a=0;a<e.length;a++){let r=e[a],s=t[a];Ns.assert(r<0||s<0||r===s,()=>n+` Shapes ${e} and ${t} must match`)}}}function ST(e){return!("number"==typeof e||e.some(e=>e<0))}function IT(e,t,n){let a=_T(e,n),r=!ST(a);if(r&&0===t.length)throw new Error(`Tried to calculate elements of an empty list with non-fully-defined elementShape: ${a}`);if(r&&t.forEach(e=>{a=_T(e.shape,a)}),!ST(a))throw new Error(`Non-fully-defined elementShape: ${a}`);return a}function _T(e,t){if("number"==typeof e)return t;if("number"==typeof t)return e;if(e.length!==t.length)throw new Error(`Incompatible ranks during merge: ${e} vs. ${t}`);let n=[];for(let a=0;a<e.length;++a){let r=e[a],s=t[a];if(r>=0&&s>=0&&r!==s)throw new Error(`Incompatible shape during merge: ${e} vs. ${t}`);n[a]=r>=0?r:s}return n}xe(kT,{OP_SCOPE_SUFFIX:()=>Pi,abs:()=>yl,acos:()=>wl,acosh:()=>vl,add:()=>fl,addN:()=>kl,all:()=>Nl,any:()=>Sl,argMax:()=>Il,argMin:()=>_l,asin:()=>Cl,asinh:()=>Tl,atan:()=>El,atan2:()=>Al,atanh:()=>$l,avgPool:()=>Kl,avgPool3d:()=>Xl,basicLSTMCell:()=>tu,batchNorm:()=>ru,batchNorm2d:()=>su,batchNorm3d:()=>iu,batchNorm4d:()=>ou,batchToSpaceND:()=>nu,bincount:()=>lu,bitwiseAnd:()=>uu,booleanMaskAsync:()=>Qp,broadcastArgs:()=>du,broadcastTo:()=>cu,buffer:()=>cl,cast:()=>pl,ceil:()=>pu,clipByValue:()=>mu,clone:()=>hl,complex:()=>Wi,concat:()=>Yl,concat1d:()=>fu,concat2d:()=>gu,concat3d:()=>xu,concat4d:()=>bu,conv1d:()=>wu,conv2d:()=>yu,conv2dTranspose:()=>ku,conv3d:()=>Nu,conv3dTranspose:()=>Iu,cos:()=>_u,cosh:()=>Cu,cosineWindow:()=>oh,cumprod:()=>Tu,cumsum:()=>Eu,denseBincount:()=>Au,depthToSpace:()=>$u,depthwiseConv2d:()=>Ru,diag:()=>Fu,dilation2d:()=>Du,div:()=>xl,divNoNan:()=>Wu,dot:()=>Vu,dropout:()=>sh,einsum:()=>Uu,elu:()=>Gu,enclosingPowerOfTwo:()=>ih,ensureShape:()=>Hu,equal:()=>zu,erf:()=>qu,euclideanNorm:()=>cd,exp:()=>pd,expandDims:()=>hd,expm1:()=>md,eye:()=>gd,fft:()=>kp,fill:()=>hu,floor:()=>xd,floorDiv:()=>gl,fused:()=>uh,gather:()=>bd,gatherND:()=>rh,greater:()=>yd,greaterEqual:()=>wd,ifft:()=>Np,imag:()=>vd,image:()=>gm,inTopKAsync:()=>lh,irfft:()=>Sp,isFinite:()=>kd,isInf:()=>Nd,isNaN:()=>Sd,leakyRelu:()=>Id,less:()=>_d,lessEqual:()=>Cd,linalg:()=>xm,linspace:()=>Td,localResponseNormalization:()=>Ed,log:()=>Ad,log1p:()=>$d,logSigmoid:()=>Bd,logSoftmax:()=>Vd,logSumExp:()=>Ud,logicalAnd:()=>Gd,logicalNot:()=>Hd,logicalOr:()=>qd,logicalXor:()=>Kd,losses:()=>bm,lowerBound:()=>Zd,matMul:()=>Zl,max:()=>nd,maxPool:()=>Jd,maxPool3d:()=>Qd,maxPoolWithArgmax:()=>ec,maximum:()=>tc,mean:()=>nc,meshgrid:()=>sc,min:()=>ad,minimum:()=>ic,mirrorPad:()=>oc,mod:()=>lc,moments:()=>uc,movingAverage:()=>th,mul:()=>bl,multiRNNCell:()=>dc,multinomial:()=>cc,neg:()=>zd,norm:()=>dd,notEqual:()=>pc,oneHot:()=>hc,ones:()=>rc,onesLike:()=>mc,op:()=>Bi,outerProduct:()=>fc,pad:()=>gc,pad1d:()=>xc,pad2d:()=>bc,pad3d:()=>yc,pad4d:()=>wc,pool:()=>kc,pow:()=>rd,prelu:()=>Nc,print:()=>ml,prod:()=>Sc,raggedGather:()=>Ic,raggedRange:()=>_c,raggedTensorToTensor:()=>Cc,rand:()=>Tc,randomGamma:()=>Kc,randomNormal:()=>Xc,randomStandardNormal:()=>Yc,randomUniform:()=>Zc,randomUniformInt:()=>Jc,range:()=>Qc,real:()=>ep,reciprocal:()=>tp,relu:()=>np,relu6:()=>ap,reshape:()=>ql,reverse:()=>rp,reverse1d:()=>sp,reverse2d:()=>ip,reverse3d:()=>op,reverse4d:()=>lp,rfft:()=>_p,round:()=>up,rsqrt:()=>dp,scalar:()=>sd,scatterND:()=>nh,searchSorted:()=>Yd,selu:()=>cp,separableConv2d:()=>pp,setdiff1dAsync:()=>hp,sigmoid:()=>Jl,sign:()=>mp,signal:()=>fm,sin:()=>fp,sinh:()=>gp,slice:()=>Ql,slice1d:()=>xp,slice2d:()=>bp,slice3d:()=>yp,slice4d:()=>wp,softmax:()=>vp,softplus:()=>Pd,spaceToBatchND:()=>vc,sparse:()=>ym,sparseToDense:()=>ah,spectral:()=>mm,split:()=>Ip,sqrt:()=>id,square:()=>od,squaredDifference:()=>Cp,squeeze:()=>Tp,stack:()=>Ep,step:()=>Ap,stridedSlice:()=>$p,string:()=>wm,sub:()=>Wd,sum:()=>ld,tan:()=>Rp,tanh:()=>eu,tensor:()=>Ui,tensor1d:()=>Fp,tensor2d:()=>Dp,tensor3d:()=>Mp,tensor4d:()=>Op,tensor5d:()=>jp,tensor6d:()=>Lp,tensorScatterUpdate:()=>Vp,tile:()=>fd,topk:()=>Up,transpose:()=>eh,truncatedNormal:()=>Gp,unique:()=>Hp,unsortedSegmentSum:()=>qp,unstack:()=>Kp,upperBound:()=>Xp,variable:()=>Yp,where:()=>Pu,whereAsync:()=>Jp,zeros:()=>ac,zerosLike:()=>Bu});var CT=class{constructor(e,t,n,a,r,s,i){this.name=e,this.dtype=t,this.maxSize=n,this.elementShape=a,this.identicalElementShapes=r,this.dynamicSize=s,this.clearAfterRead=i,this.tensors=[],this.closed_=!1,this.idTensor=sd(0),ao(this.idTensor)}get id(){return this.idTensor.id}get closed(){return this.closed_}clearAndClose(e){this.tensors.forEach(t=>{(null==e||!e.has(t.tensor.id))&&t.tensor.dispose()}),this.tensors=[],this.closed_=!0,this.idTensor.dispose()}size(){return this.tensors.length}read(e){if(this.closed_)throw new Error(`TensorArray ${this.name} has already been closed.`);if(e<0||e>=this.size())throw new Error(`Tried to read from index ${e}, but array size is: ${this.size()}`);let t=this.tensors[e];if(t.cleared)throw new Error(`TensorArray ${this.name}: Could not read index ${e} twice because it was cleared after a previous read (perhaps try setting clear_after_read = false?).`);return this.clearAfterRead&&(t.cleared=!0),t.read=!0,t.tensor}readMany(e){return e.map(e=>this.read(e))}write(e,t){if(this.closed_)throw new Error(`TensorArray ${this.name} has already been closed.`);if(e<0||!this.dynamicSize&&e>=this.maxSize)throw new Error(`Tried to write to index ${e}, but array is not resizeable and size is: ${this.maxSize}`);let n=this.tensors[e]||{};if(t.dtype!==this.dtype)throw new Error(`TensorArray ${this.name}: Could not write to TensorArray index ${e},\n          because the value dtype is ${t.dtype}, but TensorArray dtype is ${this.dtype}.`);if(0===this.size()&&(null==this.elementShape||0===this.elementShape.length)&&(this.elementShape=t.shape),NT(this.elementShape,t.shape,`TensorArray ${this.name}: Could not write to TensorArray index ${e}.`),n.read)throw new Error(`TensorArray ${this.name}: Could not write to TensorArray index ${e}, because it has already been read.`);if(n.written)throw new Error(`TensorArray ${this.name}: Could not write to TensorArray index ${e}, because it has already been written.`);n.tensor=t,ao(t),n.written=!0,this.tensors[e]=n}writeMany(e,t){if(e.length!==t.length)throw new Error(`TensorArray ${this.name}: could not write multiple tensors,because the index size: ${e.length} is not the same as tensors size: ${t.length}.`);e.forEach((e,n)=>this.write(e,t[n]))}gather(e,t){if(t&&t!==this.dtype)throw new Error(`TensorArray dtype is ${this.dtype} but gather requested dtype ${t}`);if(e)e=e.slice(0,this.size());else{e=[];for(let t=0;t<this.size();t++)e.push(t)}if(0===e.length)return Ui([],[0].concat(this.elementShape));let n=this.readMany(e);return NT(this.elementShape,n[0].shape,"TensorArray shape mismatch: "),Ep(n,0)}concat(e){if(e&&e!==this.dtype)throw new Error(`TensorArray dtype is ${this.dtype} but concat requested dtype ${e}`);if(0===this.size())return Ui([],[0].concat(this.elementShape));let t=[];for(let a=0;a<this.size();a++)t.push(a);let n=this.readMany(t);return NT(this.elementShape,n[0].shape,`TensorArray shape mismatch: tensor array shape (${this.elementShape}) vs first tensor shape (${n[0].shape})`),Yl(n,0)}scatter(e,t){if(t.dtype!==this.dtype)throw new Error(`TensorArray dtype is ${this.dtype} but tensor has dtype ${t.dtype}`);if(e.length!==t.shape[0])throw new Error(`Expected len(indices) == tensor.shape[0], but saw: ${e.length} vs. ${t.shape[0]}`);let n=Math.max(...e);if(!this.dynamicSize&&n>=this.maxSize)throw new Error(`Max index must be < array size (${n}  vs. ${this.maxSize})`);this.writeMany(e,Kp(t,0))}split(e,t){if(t.dtype!==this.dtype)throw new Error(`TensorArray dtype is ${this.dtype} but tensor has dtype ${t.dtype}`);let n=0,a=e.map(e=>(n+=e,n));if(n!==t.shape[0])throw new Error(`Expected sum of lengths to be equal to\n          tensor.shape[0], but sum of lengths is\n        ${n}, and tensor's shape is: ${t.shape}`);if(!this.dynamicSize&&e.length!==this.maxSize)throw new Error(`TensorArray's size is not equal to the size of lengths (${this.maxSize} vs. ${e.length}), and the TensorArray is not marked as dynamically resizeable`);let r=0===n?0:t.size/n,s=[];to(()=>{t=ql(t,[1,n,r]);for(let n=0;n<e.length;++n){let i=[0,0===n?0:a[n-1],0],o=[1,e[n],r];s[n]=ql(Ql(t,i,o),this.elementShape)}return s});let i=[];for(let o=0;o<e.length;o++)i[o]=o;this.writeMany(i,s)}},TT=class e{get id(){return this.idTensor.id}constructor(e,t,n,a=-1){this.tensors=e,this.elementShape=t,this.elementDtype=n,null!=e&&e.forEach(e=>{if(n!==e.dtype)throw new Error(`Invalid data types; op elements ${n}, but list elements ${e.dtype}`);NT(t,e.shape,"TensorList shape mismatch: "),ao(e)}),this.idTensor=sd(0),this.maxNumElements=a,ao(this.idTensor)}copy(){return new e([...this.tensors],this.elementShape,this.elementDtype)}clearAndClose(e){this.tensors.forEach(t=>{(null==e||!e.has(t.id))&&t.dispose()}),this.tensors.length=0,this.idTensor.dispose()}size(){return this.tensors.length}stack(e,t,n=-1){if(t!==this.elementDtype)throw new Error(`Invalid data types; op elements ${t}, but list elements ${this.elementDtype}`);if(-1!==n&&this.tensors.length!==n)throw new Error(`Operation expected a list with ${n} elements but got a list with ${this.tensors.length} elements.`);NT(e,this.elementShape,"TensorList shape mismatch: ");let a=IT(this.elementShape,this.tensors,e);return to(()=>{let e=this.tensors.map(e=>ql(e,a));return Ep(e,0)})}popBack(e,t){if(t!==this.elementDtype)throw new Error(`Invalid data types; op elements ${t}, but list elements ${this.elementDtype}`);if(0===this.size())throw new Error("Trying to pop from an empty list.");let n=IT(this.elementShape,this.tensors,e),a=this.tensors.pop();return a.kept=!1,NT(a.shape,e,"TensorList shape mismatch: "),ql(a,n)}pushBack(e){if(e.dtype!==this.elementDtype)throw new Error(`Invalid data types; op elements ${e.dtype}, but list elements ${this.elementDtype}`);if(NT(e.shape,this.elementShape,"TensorList shape mismatch: "),this.maxNumElements===this.size())throw new Error("Trying to push element into a full list.");ao(e),this.tensors.push(e)}resize(t){if(t<0)throw new Error(`TensorListResize expects size to be non-negative. Got: ${t}`);if(-1!==this.maxNumElements&&t>this.maxNumElements)throw new Error(`TensorListResize input size ${t} is greater maxNumElement ${this.maxNumElements}.`);let n=new e([],this.elementShape,this.elementDtype,this.maxNumElements);n.tensors.length=t;for(let e=0;e<Math.min(this.tensors.length,t);++e)n.tensors[e]=this.tensors[e];return n}getItem(e,t,n){if(n!==this.elementDtype)throw new Error(`Invalid data types; op elements ${n}, but list elements ${this.elementDtype}`);if(e<0||e>this.tensors.length)throw new Error(`Trying to access element ${e} in a list with ${this.tensors.length} elements.`);if(null==this.tensors[e])throw new Error(`element at index ${e} is null.`);NT(this.tensors[e].shape,t,"TensorList shape mismatch: ");let a=IT(this.elementShape,this.tensors,t);return ql(this.tensors[e],a)}setItem(e,t){if(t.dtype!==this.elementDtype)throw new Error(`Invalid data types; op elements ${t.dtype}, but list elements ${this.elementDtype}`);if(e<0||-1!==this.maxNumElements&&e>=this.maxNumElements)throw new Error(`Trying to set element ${e} in a list with max ${this.maxNumElements} elements.`);NT(this.elementShape,t.shape,"TensorList shape mismatch: "),ao(t),null!=this.tensors[e]&&(this.tensors[e].kept=!1),this.tensors[e]=t}gather(e,t,n){if(t!==this.elementDtype)throw new Error(`Invalid data types; op elements ${t}, but list elements ${this.elementDtype}`);NT(this.elementShape,n,"TensorList shape mismatch: "),e=e.slice(0,this.size());let a=IT(this.elementShape,this.tensors,n);return 0===e.length?Ui([],[0].concat(a)):to(()=>{let t=e.map(e=>ql(this.tensors[e],a));return Ep(t,0)})}concat(e,t){if(e&&e!==this.elementDtype)throw new Error(`TensorList dtype is ${this.elementDtype} but concat requested dtype ${e}`);NT(this.elementShape,t,"TensorList shape mismatch: ");let n=IT(this.elementShape,this.tensors,t);return 0===this.size()?Ui([],[0].concat(n)):to(()=>{let e=this.tensors.map(e=>ql(e,n));return Yl(e,0)})}};function ET(e,t,n){let[a,r]=mC("fusedOps",e,t,n),s="biasadd"===a,i=!s,o="prelu"===r,l="fusedbatchnorm"===a,u=mC("numArgs",e,t,n);if(s){if(o&&2!==u)throw new Error("FusedConv2d and DepthwiseConv2d with BiasAdd and Prelu must have two extra arguments: bias and alpha.");if(!o&&s&&1!==u)throw new Error("FusedConv2d and DepthwiseConv2d with BiasAdd must have one extra argument: bias.")}if(l)throw new Error("FusedConv2d and DepthwiseConv2d with FusedBatchNorm is not supported");let d=mC("strides",e,t,n),c=wC(e,t,n),p=mC("dataFormat",e,t,n).toUpperCase(),h=mC("dilations",e,t,n),[m,f]=mC("args",e,t,n);return i&&(f=m,m=void 0),{stride:d,pad:c,dataFormat:p,dilations:h,biasArg:m,preluArg:f,activationFunc:r,leakyreluAlpha:mC("leakyreluAlpha",e,t,n)}}function AT(e,t,n){return{boxes:mC("boxes",e,t,n),scores:mC("scores",e,t,n),maxOutputSize:mC("maxOutputSize",e,t,n),iouThreshold:mC("iouThreshold",e,t,n),scoreThreshold:mC("scoreThreshold",e,t,n),softNmsSigma:mC("softNmsSigma",e,t,n)}}var $T=class{get id(){return this.handle.id}constructor(e,t){this.keyDType=e,this.valueDType=t,this.handle=sd(0),this.tensorMap=new Map,ao(this.handle)}clearAndClose(){this.tensorMap.forEach(e=>e.dispose()),this.tensorMap.clear(),this.handle.dispose()}size(){return this.tensorMap.size}tensorSize(){return sd(this.size(),"int32")}async import(e,t){this.checkKeyAndValueTensor(e,t);let n=await e.data();return this.tensorMap.forEach(e=>e.dispose()),this.tensorMap.clear(),to(()=>{let e=Kp(t),a=n.length,r=e.length;Ns.assert(a===r,()=>`The number of elements doesn't match, keys has ${a} elements, the values has ${r} elements.`);for(let t=0;t<a;t++){let a=n[t],r=e[t];ao(r),this.tensorMap.set(a,r)}return this.handle})}async find(e,t){this.checkKeyAndValueTensor(e,t);let n=await e.data();return to(()=>{let e=[];for(let a=0;a<n.length;a++){let r=n[a],s=this.findWithDefault(r,t);e.push(s)}return Ep(e)})}findWithDefault(e,t){let n=this.tensorMap.get(e);return null!=n?n:t}checkKeyAndValueTensor(e,t){if(e.dtype!==this.keyDType)throw new Error(`Expect key dtype ${this.keyDType}, but got ${e.dtype}`);if(t.dtype!==this.valueDType)throw new Error(`Expect value dtype ${this.valueDType}, but got ${t.dtype}`)}};function RT(e,t,n,a,r=to){let s=((e,t,n)=>{switch(e.category){case"arithmetic":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"BiasAdd":case"AddV2":case"Add":return[a.add(mC("a",e,t,n),mC("b",e,t,n))];case"AddN":return[a.addN(mC("tensors",e,t,n))];case"FloorMod":case"Mod":return[a.mod(mC("a",e,t,n),mC("b",e,t,n))];case"Mul":return[a.mul(mC("a",e,t,n),mC("b",e,t,n))];case"RealDiv":case"Div":return[a.div(mC("a",e,t,n),mC("b",e,t,n))];case"DivNoNan":return[a.divNoNan(mC("a",e,t,n),mC("b",e,t,n))];case"FloorDiv":return[a.floorDiv(mC("a",e,t,n),mC("b",e,t,n))];case"Sub":return[a.sub(mC("a",e,t,n),mC("b",e,t,n))];case"Minimum":return[a.minimum(mC("a",e,t,n),mC("b",e,t,n))];case"Maximum":return[a.maximum(mC("a",e,t,n),mC("b",e,t,n))];case"Pow":return[a.pow(mC("a",e,t,n),mC("b",e,t,n))];case"SquaredDifference":return[a.squaredDifference(mC("a",e,t,n),mC("b",e,t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"basic_math":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"Abs":case"ComplexAbs":return[a.abs(mC("x",e,t,n))];case"Acos":return[a.acos(mC("x",e,t,n))];case"Acosh":return[a.acosh(mC("x",e,t,n))];case"Asin":return[a.asin(mC("x",e,t,n))];case"Asinh":return[a.asinh(mC("x",e,t,n))];case"Atan":return[a.atan(mC("x",e,t,n))];case"Atan2":return[a.atan2(mC("x",e,t,n),mC("y",e,t,n))];case"Atanh":return[a.atanh(mC("x",e,t,n))];case"Ceil":return[a.ceil(mC("x",e,t,n))];case"Complex":return[a.complex(mC("real",e,t,n),mC("imag",e,t,n))];case"Cos":return[a.cos(mC("x",e,t,n))];case"Cosh":return[a.cosh(mC("x",e,t,n))];case"Elu":return[a.elu(mC("x",e,t,n))];case"Erf":return[a.erf(mC("x",e,t,n))];case"Exp":return[a.exp(mC("x",e,t,n))];case"Expm1":return[a.expm1(mC("x",e,t,n))];case"Floor":return[a.floor(mC("x",e,t,n))];case"Log":return[a.log(mC("x",e,t,n))];case"Log1p":return[a.log1p(mC("x",e,t,n))];case"Imag":return[a.imag(mC("x",e,t,n))];case"Neg":return[a.neg(mC("x",e,t,n))];case"Reciprocal":return[a.reciprocal(mC("x",e,t,n))];case"Real":return[a.real(mC("x",e,t,n))];case"Relu":return[a.relu(mC("x",e,t,n))];case"Round":return[a.round(mC("x",e,t,n))];case"Selu":return[a.selu(mC("x",e,t,n))];case"Sigmoid":return[a.sigmoid(mC("x",e,t,n))];case"Sin":return[a.sin(mC("x",e,t,n))];case"Sign":return[a.sign(mC("x",e,t,n))];case"Sinh":return[a.sinh(mC("x",e,t,n))];case"Softplus":return[a.softplus(mC("x",e,t,n))];case"Sqrt":return[a.sqrt(mC("x",e,t,n))];case"Square":return[a.square(mC("x",e,t,n))];case"Tanh":return[a.tanh(mC("x",e,t,n))];case"Tan":return[a.tan(mC("x",e,t,n))];case"ClipByValue":return[a.clipByValue(mC("x",e,t,n),mC("clipValueMin",e,t,n),mC("clipValueMax",e,t,n))];case"Relu6":return[a.relu6(mC("x",e,t,n))];case"Rsqrt":return[a.rsqrt(fC(e.inputNames[0],t,n))];case"LeakyRelu":return[a.leakyRelu(mC("x",e,t,n),mC("alpha",e,t,n))];case"Prelu":return[a.prelu(mC("x",e,t,n),mC("alpha",e,t,n))];case"IsNan":return[a.isNaN(fC(e.inputNames[0],t,n))];case"IsInf":return[a.isInf(fC(e.inputNames[0],t,n))];case"IsFinite":return[a.isFinite(fC(e.inputNames[0],t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"control":return(async(e,t,n)=>{switch(e.op){case"If":case"StatelessIf":{let a=mC("thenBranch",e,t,n),r=mC("elseBranch",e,t,n),s=mC("cond",e,t,n),i=mC("args",e,t,n);return(await s.data())[0]?n.functionMap[a].executeFunctionAsync(i,n.tensorArrayMap,n.tensorListMap):n.functionMap[r].executeFunctionAsync(i,n.tensorArrayMap,n.tensorListMap)}case"While":case"StatelessWhile":{let a=mC("body",e,t,n),r=mC("cond",e,t,n),s=mC("args",e,t,n),i=await n.functionMap[r].executeFunctionAsync(s,n.tensorArrayMap,n.tensorListMap),o=s.map(e=>e.id),l=await i[0].data();i.forEach(e=>{!e.kept&&-1===o.indexOf(e.id)&&e.dispose()});let u=s;for(;l[0];){let e=u;u=await n.functionMap[a].executeFunctionAsync(u,n.tensorArrayMap,n.tensorListMap);let t=u.map(e=>e.id);e.forEach(e=>{!e.kept&&-1===o.indexOf(e.id)&&-1===t.indexOf(e.id)&&e.dispose()});let s=await n.functionMap[r].executeFunctionAsync(u,n.tensorArrayMap,n.tensorListMap);l=await s[0].data(),s.forEach(e=>{!e.kept&&-1===o.indexOf(e.id)&&-1===t.indexOf(e.id)&&e.dispose()})}return u}case"LoopCond":return[vC(mC("pred",e,t,n))];case"Switch":{let a=mC("pred",e,t,n),r=mC("data",e,t,n);return r.kept||(r=vC(r)),(await a.data())[0]?[void 0,r]:[r,void 0]}case"Merge":{let a=e.inputNames.find(e=>void 0!==fC(e,t,n));return a?[vC(fC(a,t,n))]:void 0}case"Enter":{let a=mC("frameName",e,t,n),r=mC("tensor",e,t,n);return n.enterFrame(a),[vC(r)]}case"Exit":{let a=mC("tensor",e,t,n);return n.exitFrame(),[vC(a)]}case"NextIteration":{let a=mC("tensor",e,t,n);return n.nextIteration(),[vC(a)]}case"TensorArrayV3":{let a=mC("size",e,t,n),r=mC("dtype",e,t,n),s=mC("elementShape",e,t,n),i=mC("dynamicSize",e,t,n),o=mC("clearAfterRead",e,t,n),l=mC("identicalElementShapes",e,t,n),u=mC("name",e,t,n),d=new CT(u,r,a,s,l,i,o);return n.addTensorArray(d),[d.idTensor,sd(1)]}case"TensorArrayWriteV3":{let a=mC("tensorArrayId",e,t,n),r=mC("index",e,t,n),s=mC("tensor",e,t,n),i=n.getTensorArray(a.id);return i.write(r,s),[i.idTensor]}case"TensorArrayReadV3":{let a=mC("tensorArrayId",e,t,n),r=mC("index",e,t,n);return[n.getTensorArray(a.id).read(r)]}case"TensorArrayGatherV3":{let a=mC("tensorArrayId",e,t,n),r=mC("indices",e,t,n),s=mC("dtype",e,t,n);return[n.getTensorArray(a.id).gather(r,s)]}case"TensorArrayScatterV3":{let a=mC("tensorArrayId",e,t,n),r=mC("indices",e,t,n),s=mC("tensor",e,t,n),i=n.getTensorArray(a.id);return i.scatter(r,s),[i.idTensor]}case"TensorArrayConcatV3":{let a=mC("tensorArrayId",e,t,n),r=n.getTensorArray(a.id),s=mC("dtype",e,t,n);return[r.concat(s)]}case"TensorArraySplitV3":{let a=mC("tensorArrayId",e,t,n),r=mC("tensor",e,t,n),s=mC("lengths",e,t,n),i=n.getTensorArray(a.id);return i.split(s,r),[i.idTensor]}case"TensorArraySizeV3":{let a=mC("tensorArrayId",e,t,n);return[sd(n.getTensorArray(a.id).size(),"int32")]}case"TensorArrayCloseV3":{let a=mC("tensorArrayId",e,t,n),r=n.getTensorArray(a.id);return r.clearAndClose(),[r.idTensor]}case"TensorListSetItem":{let a=mC("tensorListId",e,t,n),r=mC("index",e,t,n),s=mC("tensor",e,t,n),i=n.getTensorList(a.id);return i.setItem(r,s),[i.idTensor]}case"TensorListGetItem":{let a=mC("tensorListId",e,t,n),r=mC("index",e,t,n),s=mC("elementShape",e,t,n),i=mC("elementDType",e,t,n);return[n.getTensorList(a.id).getItem(r,s,i)]}case"TensorListScatterV2":case"TensorListScatter":{let a=mC("indices",e,t,n),r=function(e,t,n,a){if(t.length!==e.shape[0])throw new Error(`Expected len(indices) == tensor.shape[0], but saw: ${t.length} vs. ${e.shape[0]}`);let r=Math.max(...t);if(null!=a&&-1!==a&&r>=a)throw new Error(`Max index must be < array size (${r}  vs. ${a})`);let s=new TT([],n,e.dtype,a),i=Kp(e,0);return t.forEach((e,t)=>{s.setItem(e,i[t])}),s}(mC("tensor",e,t,n),a,mC("elementShape",e,t,n),mC("numElements",e,t,n));return n.addTensorList(r),[r.idTensor]}case"TensorListReserve":case"EmptyTensorList":{let a,r=mC("elementShape",e,t,n),s=mC("elementDType",e,t,n);a="TensorListReserve"===e.op?"numElements":"maxNumElements";let i=mC(a,e,t,n),o=function(e,t,n,a){return new TT([],e,t,a)}(r,s,0,"TensorListReserve"===e.op?-1:i);return n.addTensorList(o),[o.idTensor]}case"TensorListGather":{let a=mC("tensorListId",e,t,n),r=mC("indices",e,t,n),s=mC("elementShape",e,t,n),i=mC("elementDType",e,t,n);return[n.getTensorList(a.id).gather(r,i,s)]}case"TensorListStack":{let a=mC("tensorListId",e,t,n),r=mC("elementShape",e,t,n),s=mC("elementDType",e,t,n),i=mC("numElements",e,t,n);return[n.getTensorList(a.id).stack(r,s,i)]}case"TensorListFromTensor":{let a=function(e,t,n){let a=e.dtype;if(e.shape.length<1)throw new Error(`Tensor must be at least a vector, but saw shape: ${e.shape}`);if(e.dtype!==n)throw new Error(`Invalid data types; op elements ${e.dtype}, but list elements ${n}`);NT(e.shape.slice(1),t,"TensorList shape mismatch: ");let r=Kp(e);return new TT(r,t,a)}(mC("tensor",e,t,n),mC("elementShape",e,t,n),mC("elementDType",e,t,n));return n.addTensorList(a),[a.idTensor]}case"TensorListConcat":case"TensorListConcatV2":{let a=mC("tensorListId",e,t,n),r=n.getTensorList(a.id),s=mC("dtype",e,t,n),i=mC("elementShape",e,t,n);return[r.concat(s,i)]}case"TensorListPushBack":{let a=mC("tensorListId",e,t,n),r=mC("tensor",e,t,n),s=n.getTensorList(a.id);return s.pushBack(r),[s.idTensor]}case"TensorListPopBack":{let a=mC("tensorListId",e,t,n),r=mC("elementShape",e,t,n),s=mC("elementDType",e,t,n);return[n.getTensorList(a.id).popBack(r,s)]}case"TensorListSplit":{let a=mC("tensor",e,t,n),r=mC("elementShape",e,t,n),s=function(e,t,n){let a=0,r=t.map(e=>(a+=e,a));if(a!==e.shape[0])throw new Error(`Expected sum of lengths to be equal to\n          tensor.shape[0], but sum of lengths is\n        ${a}, and tensor's shape is: ${e.shape}`);let s=_T(e.shape.slice(1),n),i=0===a?0:e.size/a,o=to(()=>{let n=[];e=ql(e,[1,a,i]);for(let a=0;a<t.length;++a){let o=[0,0===a?0:r[a-1],0],l=[1,t[a],i];n[a]=ql(Ql(e,o,l),s)}return e.dispose(),n}),l=new TT([],n,e.dtype,t.length);for(let u=0;u<o.length;u++)l.setItem(u,o[u]);return l}(a,mC("lengths",e,t,n),r);return n.addTensorList(s),[s.idTensor]}case"TensorListLength":{let a=mC("tensorListId",e,t,n);return[sd(n.getTensorList(a.id).size(),"int32")]}case"TensorListResize":{let a=mC("tensorListId",e,t,n),r=mC("size",e,t,n),s=n.getTensorList(a.id).resize(r);return n.addTensorList(s),[s.idTensor]}default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n);case"convolution":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"Conv1D":{let r=mC("stride",e,t,n),s=mC("pad",e,t,n),i=mC("dataFormat",e,t,n).toUpperCase(),o=mC("dilation",e,t,n);return[a.conv1d(mC("x",e,t,n),mC("filter",e,t,n),r,s,i,o)]}case"Conv2D":{let r=mC("strides",e,t,n),s=wC(e,t,n),i=mC("dataFormat",e,t,n).toUpperCase(),o=mC("dilations",e,t,n);return[a.conv2d(mC("x",e,t,n),mC("filter",e,t,n),[r[1],r[2]],s,i,[o[1],o[2]])]}case"_FusedConv2D":{let{stride:r,pad:s,dataFormat:i,dilations:o,biasArg:l,preluArg:u,activationFunc:d,leakyreluAlpha:c}=ET(e,t,n);return[a.fused.conv2d({x:mC("x",e,t,n),filter:mC("filter",e,t,n),strides:[r[1],r[2]],pad:s,dataFormat:i,dilations:[o[1],o[2]],bias:l,activation:d,preluActivationWeights:u,leakyreluAlpha:c})]}case"FusedDepthwiseConv2dNative":{let{stride:r,pad:s,dataFormat:i,dilations:o,biasArg:l,preluArg:u,activationFunc:d,leakyreluAlpha:c}=ET(e,t,n);return[a.fused.depthwiseConv2d({x:mC("x",e,t,n),filter:mC("filter",e,t,n),strides:[r[1],r[2]],pad:s,dataFormat:i,dilations:[o[1],o[2]],bias:l,activation:d,preluActivationWeights:u,leakyreluAlpha:c})]}case"Conv2DBackpropInput":case"Conv2dTranspose":{let r=mC("outputShape",e,t,n),s=mC("strides",e,t,n),i=wC(e,t,n);return[a.conv2dTranspose(mC("x",e,t,n),mC("filter",e,t,n),r,[s[1],s[2]],i)]}case"DepthwiseConv2dNative":case"DepthwiseConv2d":{let r=mC("strides",e,t,n),s=wC(e,t,n),i=mC("dilations",e,t,n),o=mC("dataFormat",e,t,n).toUpperCase();return[a.depthwiseConv2d(mC("input",e,t,n),mC("filter",e,t,n),[r[1],r[2]],s,o,[i[1],i[2]])]}case"Conv3D":{let r=mC("strides",e,t,n),s=mC("pad",e,t,n),i=mC("dataFormat",e,t,n).toUpperCase(),o=mC("dilations",e,t,n);return[a.conv3d(mC("x",e,t,n),mC("filter",e,t,n),[r[1],r[2],r[3]],s,i,[o[1],o[2],o[3]])]}case"AvgPool":{let r=mC("strides",e,t,n),s=mC("pad",e,t,n),i=mC("kernelSize",e,t,n);return[a.avgPool(mC("x",e,t,n),[i[1],i[2]],[r[1],r[2]],s)]}case"MaxPool":{let r=mC("strides",e,t,n),s=mC("pad",e,t,n),i=mC("kernelSize",e,t,n);return[a.maxPool(mC("x",e,t,n),[i[1],i[2]],[r[1],r[2]],s)]}case"MaxPoolWithArgmax":{let r=mC("strides",e,t,n),s=mC("pad",e,t,n),i=mC("kernelSize",e,t,n),o=mC("includeBatchInIndex",e,t,n),{result:l,indexes:u}=a.maxPoolWithArgmax(mC("x",e,t,n),[i[1],i[2]],[r[1],r[2]],s,o);return[l,u]}case"AvgPool3D":{let r=mC("strides",e,t,n),s=mC("pad",e,t,n),i=mC("kernelSize",e,t,n);return[a.avgPool3d(mC("x",e,t,n),[i[1],i[2],i[3]],[r[1],r[2],r[3]],s)]}case"MaxPool3D":{let r=mC("strides",e,t,n),s=mC("pad",e,t,n),i=mC("kernelSize",e,t,n);return[a.maxPool3d(mC("x",e,t,n),[i[1],i[2],i[3]],[r[1],r[2],r[3]],s)]}case"Dilation2D":{let r=mC("strides",e,t,n),s=mC("pad",e,t,n),i=mC("dilations",e,t,n),o=r[1],l=r[2],u=i[1],d=i[2];return[a.dilation2d(mC("x",e,t,n),mC("filter",e,t,n),[o,l],s,[u,d],"NHWC")]}default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"creation":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"Fill":{let r=mC("shape",e,t,n),s=mC("dtype",e,t,n),i=mC("value",e,t,n);return[a.fill(r,i,s)]}case"LinSpace":{let r=mC("start",e,t,n),s=mC("stop",e,t,n),i=mC("num",e,t,n);return[a.linspace(r,s,i)]}case"Multinomial":{let r=mC("logits",e,t,n),s=mC("numSamples",e,t,n),i=mC("seed",e,t,n);return[a.multinomial(r,s,i)]}case"OneHot":{let r=mC("indices",e,t,n),s=mC("depth",e,t,n),i=mC("onValue",e,t,n),o=mC("offValue",e,t,n),l=mC("dtype",e,t,n);return[a.oneHot(r,s,i,o,l)]}case"Ones":return[a.ones(mC("shape",e,t,n),mC("dtype",e,t,n))];case"OnesLike":return[a.onesLike(mC("x",e,t,n))];case"RandomStandardNormal":return[a.randomStandardNormal(mC("shape",e,t,n),mC("dtype",e,t,n),mC("seed",e,t,n))];case"RandomUniform":return[a.randomUniform(mC("shape",e,t,n),mC("minval",e,t,n),mC("maxval",e,t,n),mC("dtype",e,t,n))];case"RandomUniformInt":return[a.randomUniformInt(mC("shape",e,t,n),mC("minval",e,t,n),mC("maxval",e,t,n),mC("seed",e,t,n))];case"Range":{let r=mC("start",e,t,n),s=mC("stop",e,t,n),i=mC("step",e,t,n);return[a.range(r,s,i,mC("dtype",e,t,n))]}case"TruncatedNormal":{let r=mC("shape",e,t,n),s=mC("mean",e,t,n),i=mC("stdDev",e,t,n),o=mC("seed",e,t,n);return[a.truncatedNormal(r,s,i,mC("dtype",e,t,n),o)]}case"Zeros":return[a.zeros(mC("shape",e,t,n),mC("dtype",e,t,n))];case"ZerosLike":return[a.zerosLike(mC("x",e,t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"dynamic":return(async(e,t,n,a,r=kT)=>{switch(e.op){case"NonMaxSuppressionV5":{let{boxes:a,scores:s,maxOutputSize:i,iouThreshold:o,scoreThreshold:l,softNmsSigma:u}=AT(e,t,n),d=await r.image.nonMaxSuppressionWithScoreAsync(a,s,i,o,l,u);return[d.selectedIndices,d.selectedScores]}case"NonMaxSuppressionV4":{let{boxes:a,scores:s,maxOutputSize:i,iouThreshold:o,scoreThreshold:l}=AT(e,t,n),u=mC("padToMaxOutputSize",e,t,n),d=await r.image.nonMaxSuppressionPaddedAsync(a,s,i,o,l,u);return[d.selectedIndices,d.validOutputs]}case"NonMaxSuppressionV3":case"NonMaxSuppressionV2":{let{boxes:a,scores:s,maxOutputSize:i,iouThreshold:o,scoreThreshold:l}=AT(e,t,n);return[await r.image.nonMaxSuppressionAsync(a,s,i,o,l)]}case"Where":{let a=r.cast(mC("condition",e,t,n),"bool"),s=[await r.whereAsync(a)];return a.dispose(),s}case"ListDiff":return r.setdiff1dAsync(mC("x",e,t,n),mC("y",e,t,n));default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n);case"evaluation":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"LowerBound":{let r=mC("sortedSequence",e,t,n),s=mC("values",e,t,n);return[a.lowerBound(r,s)]}case"TopKV2":{let r=mC("x",e,t,n),s=mC("k",e,t,n),i=mC("sorted",e,t,n),o=a.topk(r,s,i);return[o.values,o.indices]}case"UpperBound":{let r=mC("sortedSequence",e,t,n),s=mC("values",e,t,n);return[a.upperBound(r,s)]}case"Unique":{let r=mC("x",e,t,n),s=a.unique(r);return[s.values,s.indices]}case"UniqueV2":{let r=mC("x",e,t,n),s=mC("axis",e,t,n),i=a.unique(r,s);return[i.values,i.indices]}default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"image":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"ResizeBilinear":{let r=mC("images",e,t,n),s=mC("size",e,t,n),i=mC("alignCorners",e,t,n),o=mC("halfPixelCenters",e,t,n);return[a.image.resizeBilinear(r,[s[0],s[1]],i,o)]}case"ResizeNearestNeighbor":{let r=mC("images",e,t,n),s=mC("size",e,t,n),i=mC("alignCorners",e,t,n),o=mC("halfPixelCenters",e,t,n);return[a.image.resizeNearestNeighbor(r,[s[0],s[1]],i,o)]}case"CropAndResize":{let r=mC("image",e,t,n),s=mC("boxes",e,t,n),i=mC("boxInd",e,t,n),o=mC("cropSize",e,t,n),l=mC("method",e,t,n),u=mC("extrapolationValue",e,t,n);return[a.image.cropAndResize(r,s,i,o,l,u)]}case"ImageProjectiveTransformV3":{let r=mC("images",e,t,n),s=mC("transforms",e,t,n),i=mC("outputShape",e,t,n),o=mC("fillValue",e,t,n),l=mC("interpolation",e,t,n),u=mC("fillMode",e,t,n);return[a.image.transform(r,s,l.toLowerCase(),u.toLowerCase(),o,i)]}default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"graph":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"Const":return t[e.name];case"PlaceholderWithDefault":let r=mC("default",e,t,n);return[fC(e.name,t,n)||r];case"Placeholder":return[fC(e.name,t,n)];case"Identity":case"StopGradient":case"FakeQuantWithMinMaxVars":case"Snapshot":return[vC(mC("x",e,t,n))];case"IdentityN":return mC("x",e,t,n).map(e=>vC(e));case"Shape":return[a.tensor1d(mC("x",e,t,n).shape,"int32")];case"ShapeN":return mC("x",e,t,n).map(e=>a.tensor1d(e.shape));case"Size":return[a.scalar(mC("x",e,t,n).size,"int32")];case"Rank":return[a.scalar(mC("x",e,t,n).rank,"int32")];case"NoOp":return[a.scalar(1)];case"Print":let s=mC("x",e,t,n),i=mC("data",e,t,n);mC("message",e,t,n),mC("summarize",e,t,n);for(let e=0;e<i.length;e++);return[s];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"logical":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"Equal":return[a.equal(mC("a",e,t,n),mC("b",e,t,n))];case"NotEqual":return[a.notEqual(mC("a",e,t,n),mC("b",e,t,n))];case"Greater":return[a.greater(mC("a",e,t,n),mC("b",e,t,n))];case"GreaterEqual":return[a.greaterEqual(mC("a",e,t,n),mC("b",e,t,n))];case"Less":return[a.less(mC("a",e,t,n),mC("b",e,t,n))];case"LessEqual":return[a.lessEqual(mC("a",e,t,n),mC("b",e,t,n))];case"LogicalAnd":return[a.logicalAnd(mC("a",e,t,n),mC("b",e,t,n))];case"LogicalNot":return[a.logicalNot(mC("a",e,t,n))];case"LogicalOr":return[a.logicalOr(mC("a",e,t,n),mC("b",e,t,n))];case"Select":case"SelectV2":return[a.where(mC("condition",e,t,n),mC("a",e,t,n),mC("b",e,t,n))];case"BitwiseAnd":return[a.bitwiseAnd(mC("a",e,t,n),mC("b",e,t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"matrices":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"BatchMatMul":case"BatchMatMulV2":case"MatMul":return[a.matMul(mC("a",e,t,n),mC("b",e,t,n),mC("transposeA",e,t,n),mC("transposeB",e,t,n))];case"Einsum":return[a.einsum(mC("equation",e,t,n),...mC("tensors",e,t,n))];case"Transpose":return[a.transpose(mC("x",e,t,n),mC("perm",e,t,n))];case"_FusedMatMul":let[r,s]=mC("fusedOps",e,t,n),i="biasadd"===r,o="prelu"===s,l=mC("numArgs",e,t,n),u=mC("leakyreluAlpha",e,t,n);if(i){if(o&&2!==l)throw new Error("Fused MatMul with BiasAdd and Prelu must have two extra arguments: bias and alpha.");if(!o&&1!==l)throw new Error("Fused MatMul with BiasAdd must have one extra argument: bias.")}let[d,c]=mC("args",e,t,n);return[a.fused.matMul({a:mC("a",e,t,n),b:mC("b",e,t,n),transposeA:mC("transposeA",e,t,n),transposeB:mC("transposeB",e,t,n),bias:d,activation:s,preluActivationWeights:c,leakyreluAlpha:u})];case"MatrixBandPart":return[a.linalg.bandPart(mC("a",e,t,n),mC("numLower",e,t,n),mC("numUpper",e,t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"normalization":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"EuclideanNorm":return[a.euclideanNorm(mC("x",e,t,n),mC("axis",e,t,n),mC("keepDims",e,t,n))];case"FusedBatchNorm":case"FusedBatchNormV2":case"FusedBatchNormV3":return[a.batchNorm(mC("x",e,t,n),mC("mean",e,t,n),mC("variance",e,t,n),mC("offset",e,t,n),mC("scale",e,t,n),mC("epsilon",e,t,n))];case"LRN":return[a.localResponseNormalization(mC("x",e,t,n),mC("radius",e,t,n),mC("bias",e,t,n),mC("alpha",e,t,n),mC("beta",e,t,n))];case"Softmax":return[a.softmax(mC("x",e,t,n))];case"LogSoftmax":return[a.logSoftmax(mC("x",e,t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"ragged":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"RaggedGather":{let{outputNestedSplits:r,outputDenseValues:s}=a.raggedGather(mC("paramsNestedSplits",e,t,n),mC("paramsDenseValues",e,t,n),mC("indices",e,t,n),mC("outputRaggedRank",e,t,n));return r.concat(s)}case"RaggedRange":{let{rtNestedSplits:r,rtDenseValues:s}=a.raggedRange(mC("starts",e,t,n),mC("limits",e,t,n),mC("splits",e,t,n));return[r,s]}case"RaggedTensorToTensor":return[a.raggedTensorToTensor(mC("shape",e,t,n),mC("values",e,t,n),mC("defaultValue",e,t,n),mC("rowPartitionTensors",e,t,n),mC("rowPartitionTypes",e,t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"reduction":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"Max":{let r=mC("axis",e,t,n),s=mC("keepDims",e,t,n);return[a.max(mC("x",e,t,n),r,s)]}case"Mean":{let r=mC("axis",e,t,n),s=mC("keepDims",e,t,n);return[a.mean(mC("x",e,t,n),r,s)]}case"Min":{let r=mC("axis",e,t,n),s=mC("keepDims",e,t,n);return[a.min(mC("x",e,t,n),r,s)]}case"Sum":{let r=mC("axis",e,t,n),s=mC("keepDims",e,t,n);return[a.sum(mC("x",e,t,n),r,s)]}case"All":{let r=mC("axis",e,t,n),s=mC("keepDims",e,t,n);return[a.all(mC("x",e,t,n),r,s)]}case"Any":{let r=mC("axis",e,t,n),s=mC("keepDims",e,t,n);return[a.any(mC("x",e,t,n),r,s)]}case"ArgMax":{let r=mC("axis",e,t,n);return[a.argMax(mC("x",e,t,n),r)]}case"ArgMin":{let r=mC("axis",e,t,n);return[a.argMin(mC("x",e,t,n),r)]}case"Prod":{let r=mC("axis",e,t,n),s=mC("keepDims",e,t,n);return[a.prod(mC("x",e,t,n),r,s)]}case"Cumprod":{let r=mC("axis",e,t,n),s=mC("exclusive",e,t,n),i=mC("reverse",e,t,n);return[a.cumprod(mC("x",e,t,n),r,s,i)]}case"Cumsum":{let r=mC("axis",e,t,n),s=mC("exclusive",e,t,n),i=mC("reverse",e,t,n);return[a.cumsum(mC("x",e,t,n),r,s,i)]}case"Bincount":let r=mC("x",e,t,n),s=mC("weights",e,t,n),i=mC("size",e,t,n);return[a.bincount(r,s,i)];case"DenseBincount":{let r=mC("x",e,t,n),s=mC("weights",e,t,n),i=mC("size",e,t,n),o=mC("binaryOutput",e,t,n);return[a.denseBincount(r,s,i,o)]}default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"slice_join":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"ConcatV2":case"Concat":{let r=mC("n",e,t,n),s=mC("axis",e,t,n),i=mC("tensors",e,t,n);return i=i.slice(0,r),[a.concat(i,s)]}case"Gather":{let r=mC("x",e,t,n),s=mC("indices",e,t,n);return[a.gather(r,a.cast(s,"int32"),0)]}case"GatherV2":{let r=mC("axis",e,t,n),s=mC("batchDims",e,t,n),i=mC("x",e,t,n),o=mC("indices",e,t,n);return[a.gather(i,a.cast(o,"int32"),r,s)]}case"Reverse":{let r=mC("dims",e,t,n),s=[];for(let e=0;e<r.length;e++)r[e]&&s.push(e);let i=mC("x",e,t,n);return[a.reverse(i,s)]}case"ReverseV2":{let r=mC("axis",e,t,n),s=mC("x",e,t,n);return[a.reverse(s,r)]}case"Slice":{let r=mC("begin",e,t,n),s=mC("size",e,t,n);return[a.slice(mC("x",e,t,n),r,s)]}case"StridedSlice":{let r=mC("begin",e,t,n),s=mC("end",e,t,n),i=mC("strides",e,t,n),o=mC("beginMask",e,t,n),l=mC("endMask",e,t,n),u=mC("ellipsisMask",e,t,n),d=mC("newAxisMask",e,t,n),c=mC("shrinkAxisMask",e,t,n),p=mC("x",e,t,n);return[a.stridedSlice(p,r,s,i,o,l,u,d,c)]}case"Pack":return to(()=>{let r=mC("axis",e,t,n),s=mC("tensors",e,t,n),i=s[0].shape,o=a.squeeze(s[0]).shape,l=s.map(e=>{let t=Ns.arraysEqual(e.shape,i);if(!t&&!Ns.arraysEqual(a.squeeze(e).shape,o))throw new Error("the input tensors shape does not match");return t?e:a.reshape(e,i)});return[a.stack(l,r)]});case"Unpack":{let r=mC("axis",e,t,n),s=mC("tensor",e,t,n);return a.unstack(s,r)}case"Tile":{let r=mC("reps",e,t,n);return[a.tile(mC("x",e,t,n),r)]}case"Split":case"SplitV":{let r=mC("axis",e,t,n),s=mC("numOrSizeSplits",e,t,n),i=mC("x",e,t,n);return a.split(i,s,r)}case"ScatterNd":{let r=mC("indices",e,t,n),s=mC("values",e,t,n),i=mC("shape",e,t,n);return[a.scatterND(r,s,i)]}case"GatherNd":{let r=mC("x",e,t,n),s=mC("indices",e,t,n);return[a.gatherND(r,s)]}case"SparseToDense":{let r=mC("sparseIndices",e,t,n),s=mC("outputShape",e,t,n),i=mC("sparseValues",e,t,n),o=mC("defaultValue",e,t,n);return[a.sparseToDense(r,i,s,i.dtype===o.dtype?o:a.cast(o,i.dtype))]}case"TensorScatterUpdate":{let r=mC("indices",e,t,n),s=mC("values",e,t,n),i=mC("tensor",e,t,n);return[a.tensorScatterUpdate(i,r,s)]}default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"sparse":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"SparseFillEmptyRows":{let{outputIndices:r,outputValues:s,emptyRowIndicator:i,reverseIndexMap:o}=a.sparse.sparseFillEmptyRows(mC("indices",e,t,n),mC("values",e,t,n),mC("denseShape",e,t,n),mC("defaultValue",e,t,n));return[r,s,i,o]}case"SparseReshape":{let{outputIndices:r,outputShape:s}=a.sparse.sparseReshape(mC("inputIndices",e,t,n),mC("inputShape",e,t,n),mC("newShape",e,t,n));return[r,s]}case"SparseSegmentMean":return[a.sparse.sparseSegmentMean(mC("data",e,t,n),mC("indices",e,t,n),mC("segmentIds",e,t,n))];case"SparseSegmentSum":return[a.sparse.sparseSegmentSum(mC("data",e,t,n),mC("indices",e,t,n),mC("segmentIds",e,t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"spectral":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"FFT":return[a.fft(mC("x",e,t,n))];case"IFFT":return[a.ifft(mC("x",e,t,n))];case"RFFT":return[a.rfft(mC("x",e,t,n))];case"IRFFT":return[a.irfft(mC("x",e,t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"string":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"StaticRegexReplace":return[a.string.staticRegexReplace(mC("input",e,t,n),mC("pattern",e,t,n),mC("rewrite",e,t,n),mC("replaceGlobal",e,t,n))];case"StringNGrams":{let{nGrams:r,nGramsSplits:s}=a.string.stringNGrams(mC("data",e,t,n),mC("dataSplits",e,t,n),mC("separator",e,t,n),mC("nGramWidths",e,t,n),mC("leftPad",e,t,n),mC("rightPad",e,t,n),mC("padWidth",e,t,n),mC("preserveShortSequences",e,t,n));return[r,s]}case"StringSplit":{let{indices:r,values:s,shape:i}=a.string.stringSplit(mC("input",e,t,n),mC("delimiter",e,t,n),mC("skipEmpty",e,t,n));return[r,s,i]}case"StringToHashBucketFast":return[a.string.stringToHashBucketFast(mC("input",e,t,n),mC("numBuckets",e,t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"transformation":return r(()=>((e,t,n,a=kT)=>{switch(e.op){case"Cast":return[a.cast(mC("x",e,t,n),mC("dtype",e,t,n))];case"ExpandDims":{let r=mC("axis",e,t,n);return[a.expandDims(mC("x",e,t,n),r)]}case"Squeeze":{let r=mC("axis",e,t,n);return[a.squeeze(mC("x",e,t,n),r)]}case"Reshape":return[a.reshape(mC("x",e,t,n),mC("shape",e,t,n))];case"EnsureShape":return[a.ensureShape(mC("x",e,t,n),mC("shape",e,t,n))];case"MirrorPad":return[a.mirrorPad(mC("x",e,t,n),mC("padding",e,t,n),mC("mode",e,t,n))];case"PadV2":case"Pad":return[a.pad(mC("x",e,t,n),mC("padding",e,t,n),mC("constantValue",e,t,n))];case"SpaceToBatchND":{let r=mC("blockShape",e,t,n),s=mC("paddings",e,t,n);return[a.spaceToBatchND(mC("x",e,t,n),r,s)]}case"BatchToSpaceND":{let r=mC("blockShape",e,t,n),s=mC("crops",e,t,n);return[a.batchToSpaceND(mC("x",e,t,n),r,s)]}case"DepthToSpace":{let r=mC("blockSize",e,t,n),s=mC("dataFormat",e,t,n).toUpperCase();return[a.depthToSpace(mC("x",e,t,n),r,s)]}case"BroadcastTo":return[a.broadcastTo(mC("x",e,t,n),mC("shape",e,t,n))];case"BroadcastArgs":return[a.broadcastArgs(mC("s0",e,t,n),mC("s1",e,t,n))];default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n));case"hash_table":return(async(e,t,n,a)=>{switch(e.op){case"HashTable":case"HashTableV2":{let r=a.getHashTableHandleByName(e.name);if(null!=r)return[r];{let r=mC("keyDType",e,t,n),s=mC("valueDType",e,t,n),i=new $T(r,s);return a.addHashTable(e.name,i),[i.handle]}}case"InitializeTable":case"InitializeTableV2":case"LookupTableImport":case"LookupTableImportV2":{let r=mC("tableHandle",e,t,n,a),s=mC("keys",e,t,n),i=mC("values",e,t,n);return[await a.getHashTableById(r.id).import(s,i)]}case"LookupTableFind":case"LookupTableFindV2":{let r=mC("tableHandle",e,t,n,a),s=mC("keys",e,t,n),i=mC("defaultValue",e,t,n);return[await a.getHashTableById(r.id).find(s,i)]}case"LookupTableSize":case"LookupTableSizeV2":{let r=mC("tableHandle",e,t,n,a);return[a.getHashTableById(r.id).tensorSize()]}default:throw TypeError(`Node type ${e.op} is not implemented`)}})(e,t,n,a);case"custom":let s=pC(e.op);if(s&&s.customExecutor)return s.customExecutor(new vT(e,t,n));throw TypeError(`Custom op ${e.op} is not registered.`);default:throw TypeError(`Unknown op '${e.op}'. File an issue at https://github.com/tensorflow/tfjs/issues so we can add it, or register a custom execution with tf.registerOp()`)}})(e,t,n);return Ns.isPromise(s)?s.then(e=>[].concat(e)):[].concat(s)}var FT=class{constructor(e={},t={},n={},a={},r){this.weightMap=e,this.tensorArrayMap=t,this.tensorListMap=n,this.functionMap=a,this.parseNodeNameCache=r,this.rootContext={id:0,frameName:"",iterationId:0},this.contexts=[this.rootContext],this.lastId=0,this.generateCurrentContextIds()}newFrame(e,t){return{id:e,frameName:t,iterationId:0}}set currentContext(e){this.contexts!==e&&(this.contexts=e,this.generateCurrentContextIds())}get currentContext(){return this.contexts}get currentContextId(){return this._currentContextIds[0]}get currentContextIds(){return this._currentContextIds}generateCurrentContextIds(){let e=[];for(let t=0;t<this.contexts.length-1;t++){let n=this.contexts.slice(0,this.contexts.length-t);e.push(this.contextIdforContexts(n))}e.push(""),this._currentContextIds=e}contextIdforContexts(e){return e?e.map(e=>0===e.id&&0===e.iterationId?"":`${e.frameName}-${e.iterationId}`).join("/"):""}enterFrame(e){this.contexts&&(this.lastId++,this.contexts=this.contexts.slice(),this.contexts.push(this.newFrame(this.lastId,e)),this._currentContextIds.unshift(this.contextIdforContexts(this.contexts)))}exitFrame(){if(!(this.contexts&&this.contexts.length>1))throw new Error("Cannot exit frame, the context is empty");this.contexts=this.contexts.slice(),this.contexts.splice(-1),this.currentContextIds.shift()}nextIteration(){if(!(this.contexts&&this.contexts.length>0))throw new Error("Cannot increase frame iteration, the context is empty");{this.contexts=this.contexts.slice(),this.lastId++;let e=Object.assign({},this.contexts[this.contexts.length-1]);e.iterationId+=1,e.id=this.lastId,this.contexts.splice(-1,1,e),this._currentContextIds.splice(0,1,this.contextIdforContexts(this.contexts))}}getWeight(e){return this.weightMap[e]}addTensorArray(e){this.tensorArrayMap[e.id]=e}getTensorArray(e){return this.tensorArrayMap[e]}addTensorList(e){this.tensorListMap[e.id]=e}getTensorList(e){return this.tensorListMap[e]}dispose(e){for(let t in this.tensorArrayMap)this.tensorArrayMap[t].clearAndClose(e);for(let t in this.tensorListMap)this.tensorListMap[t].clearAndClose(e)}};function DT(e,t,n,a){let r=new Set,s=[],i=null,o=null,l=new Set,u=new Set(Object.keys(e).map(e=>yC(e)[0]));a=a||[];let d=new Set(a.map(e=>yC(e.name)[0])),c=[...t];for(;c.length>0;){let e=c.pop();if((zT(e)||PT(e)||BT(e))&&null==i&&(i=e,o=i.children.map(e=>e.name).filter(e=>r.has(e))),r.add(e.name),null==n[e.name]&&!u.has(e.name)&&!d.has(e.name)){if(0===e.inputs.length){s.push(e.name);continue}e.inputs.forEach(e=>{l.has(e.name)||(l.add(e.name),c.push(e))})}}return{inputs:e,outputs:t,usedNodes:r,missingInputs:s,dynamicNode:i,syncInputs:o}}var MT=class extends Error{constructor(e){super(`NodesExecutionOrderError: ${e}`)}},OT=new Set(["Switch","Merge","Enter","Exit","NextIteration","StatelessIf","StatelessWhile","if","While"]),jT=new Set(["NonMaxSuppressionV2","NonMaxSuppressionV3","NonMaxSuppressionV5","Where"]),LT=new Set(["HashTable","HashTableV2","LookupTableImport","LookupTableImportV2","LookupTableFind","LookupTableFindV2","LookupTableSize","LookupTableSizeV2"]);function zT(e){return OT.has(e.op)}function PT(e){return jT.has(e.op)}function BT(e){return LT.has(e.op)}var WT=class e{get weightIds(){return this.parent?this.parent.weightIds:this._weightIds}get functionExecutorMap(){return this.parent?this.parent.functionExecutorMap:this._functionExecutorMap}get weightMap(){return this.parent?this.parent.weightMap:this._weightMap}set weightMap(e){let t=Object.keys(e).map(t=>e[t].map(e=>e.id));this._weightIds=[].concat(...t),this._weightMap=e}set resourceManager(e){this._resourceManager=e}get inputs(){return this._inputs.map(e=>({name:e.name,shape:e.attrParams.shape?e.attrParams.shape.value:void 0,dtype:e.attrParams.dtype?e.attrParams.dtype.value:void 0}))}get outputs(){return this._outputs.map(e=>({name:e.name,shape:e.attrParams.shape?e.attrParams.shape.value:void 0,dtype:e.attrParams.dtype?e.attrParams.dtype.value:void 0}))}get inputNodes(){return this._inputs.map(e=>e.signatureKey||e.name)}get outputNodes(){return this._outputs.map(e=>{let t=e.signatureKey||e.name;return e.defaultOutput?`${t}:${e.defaultOutput}`:t})}get functions(){return Object.keys(this._functions).reduce((e,t)=>(e[t]=this._functions[t].signature,e),{})}constructor(t,n){this.graph=t,this.parent=n,this.compiledMap=new Map,this.parseNodeNameCache=new Map,this._weightMap={},this.SEPARATOR=",",this._functions={},this._functionExecutorMap={},this.keepIntermediateTensors=!1,this._outputs=t.outputs,this._inputs=t.inputs,this._initNodes=t.initNodes,this._signature=t.signature,this._functions=t.functions,null!=t.functions&&Object.keys(t.functions).forEach(n=>{this._functionExecutorMap[n]=new e(t.functions[n],this)})}getCompilationKey(e,t){let n=e.map(e=>e.name).sort(),a=t.map(e=>e.name).sort();return n.join(this.SEPARATOR)+"--"+a.join(this.SEPARATOR)}compile(e,t){let n=DT(e,t,this.weightMap,this._initNodes),{missingInputs:a,dynamicNode:r,syncInputs:s}=n;if(null!=r)throw new Error(`This execution contains the node '${r.name}', which has the dynamic op '${r.op}'. Please use model.executeAsync() instead. Alternatively, to avoid the dynamic ops, specify the inputs [${s}]`);if(a.length>0){let n=t.map(e=>e.name),r=Object.keys(e);throw new Error(`Cannot compute the outputs [${n}] from the provided inputs [${r}]. Missing the following inputs: [${a}]`)}let i=function(e,t){let{usedNodes:n,inputs:a}=t,r=Object.keys(a).map(e=>yC(e)[0]).map(t=>e.nodes[t]),s=e.initNodes||[],i=e=>n.has("string"==typeof e?e:e.name);function o(e){return[...new Map(e.map(e=>[e.name,e])).values()]}let l=o([...r,...e.weights,...s]).filter(i),u=o([...l,...Object.values(e.nodes)]).filter(i),d=new Map(u.map(e=>[e.name,e])),c={};for(let f of u){c[f.name]=c[f.name]||0;for(let e of f.children)i(e)||(c[e.name]=Number.POSITIVE_INFINITY),c[e.name]=(c[e.name]||0)+1}let p=Object.entries(c).filter(([,e])=>0===e).map(([e])=>e),h=[...p];for(;p.length>0;){let e=p.pop(),t=d.get(e);for(let n of t.children.filter(i))0===--c[n.name]&&(h.push(n.name),p.push(n.name))}let m=function(e,t){let n=new Map(e.map(e=>[e.name,e])),a=t.map(e=>e.name),r=new Set(a);for(;a.length>0;){let e=a.pop(),t=n.get(e);for(let s of t.children)!n.has(s.name)||r.has(s.name)||(r.add(s.name),a.push(s.name))}return e.filter(e=>r.has(e.name))}(h.map(e=>d.get(e)),l);return function(e,t){let n=new Map(e.map((e,t)=>[e.name,t])),a=new Set(t.map(e=>e.name)),r=e=>a.has("string"==typeof e?e:e.name),s=new Set(e.map(e=>e.name)),i=e=>s.has("string"==typeof e?e:e.name);for(let o of e){for(let e of o.children.filter(i)){if(!n.has(e.name))throw new MT(`Child ${e.name} of node ${o.name} is unreachable.`);if(n.get(o.name)>n.get(e.name))throw new MT(`Node ${o.name} is scheduled to run after its child ${e.name}.`)}if(!r(o))for(let e of o.inputs){if(!n.has(e.name))throw new MT(`Input ${e.name} of node ${o.name} is unreachable.`);if(n.get(e.name)>n.get(o.name))throw new MT(`Node ${o.name} is scheduled to run before its input ${e.name}.`)}}}(m,l),m}(this.graph,n),o=function(e){let t=new Map(e.map((e,t)=>[e.name,t])),n=Number.MAX_SAFE_INTEGER,a=e.map((e,t)=>zT(e)?n:t),r=e=>{let n=a[t.get(e.name)];return null==n?-1:n},s=e.map((e,t)=>e.children.map(r).reduce((e,t)=>Math.max(e,t),a[t])),i=new Map;for(let o=0;o<e.length;++o){let t=s[o];if(t===n)continue;let a=e[o],r=e[t];i.has(r.name)||i.set(r.name,[]),i.get(r.name).push(a)}return i}(i);return{orderedNodes:i,nodeLiveUntilMap:o}}cloneAndKeepTensor(e){if(null==e)return null;let t=e.clone();return ao(t),t}cloneTensorList(e){return e?e.map(e=>this.cloneAndKeepTensor(e)):null}cloneTensorMap(e){return Object.fromEntries(Object.entries(e).map(([e,t])=>[e,this.cloneTensorList(t)]))}execute(e,t){this.disposeIntermediateTensors(),e=this.mapInputs(e);let n=Object.keys(e).sort();this.checkInputs(e),this.checkInputShapeAndType(e),t=this.mapOutputs(t),this.checkOutputs(t);let a=n.map(e=>this.graph.nodes[yC(e)[0]]),r=t.map(e=>yC(e)[0]),s=new Set(r),i=r.map(e=>this.graph.nodes[e]);0===i.length&&(i=this._outputs);let o=this.getCompilationKey(a,i),l=this.compiledMap.get(o);null==l&&(l=this.compile(e,i),this.compiledMap.set(o,l));try{this.keepIntermediateTensors=Pt().getBool("KEEP_INTERMEDIATE_TENSORS")}catch(c){this.keepIntermediateTensors=!1}let u={},d={};return to(()=>{let n=new FT(this.weightMap,u,d,this.functionExecutorMap,this.parseNodeNameCache),a=Object.assign({},this.weightMap);this.keepIntermediateTensors&&(this.clonedTensorsMap=this.cloneTensorMap(this.weightMap)),Object.keys(e).forEach(t=>{let[r,s]=yC(t,n),i=[];i[s]=e[t],a[r]=i,this.keepIntermediateTensors&&(this.clonedTensorsMap[r]=this.cloneTensorList(i))});let r=this.getFrozenTensorIds(a),{orderedNodes:i,nodeLiveUntilMap:o}=l;for(let e of i){if(a[e.name])continue;let t=RT(e,a,n,this._resourceManager);if(Ns.isPromise(t))throw new Error(`The execution of the op '${e.op}' returned a promise. Please use model.executeAsync() instead.`);a[e.name]=t,this.keepIntermediateTensors&&(this.clonedTensorsMap[e.name]=this.cloneTensorList(t)),this.checkTensorForDisposalWithNodeLiveUntilInfo(e,a,n,r,s,o.get(e.name))}return null==this.parent&&n.dispose(r),t.map(e=>fC(e,a,n))})}getFrozenTensorIds(e){let t=[].concat.apply([],Object.keys(e).map(t=>e[t]).map(e=>e.map(e=>e.id)));return new Set(t)}checkTensorForDisposal(e,t,n,a,r,s,i){if(!zT(t)&&!s.has(e)){for(let a of n[e])null!=a&&(i[a.id]=(i[a.id]||0)+t.children.length);for(let e of t.inputs){if(zT(e))continue;let t=gC(e.name,n,a);if(null!=t)for(let e of t){if(!e||e.kept||r.has(e.id))continue;let t=i[e.id];1===t?(e.dispose(),delete i[e.id]):null!=t&&i[e.id]--}}}}checkTensorForDisposalWithNodeLiveUntilInfo(e,t,n,a,r,s){function i(e){return zT(e)||r.has(e.name)}if(!zT(e)&&null!=s)for(let o of s){if(i(o))continue;let e=gC(o.name,t,n);for(let t of e)!t||t.kept||a.has(t.id)||t.dispose()}}async executeAsync(e,t){return this._executeAsync(e,t)}disposeIntermediateTensors(){this.clonedTensorsMap&&(Object.values(this.clonedTensorsMap).forEach(e=>{for(let t of e)t&&!t.isDisposed&&t.dispose()}),this.clonedTensorsMap=null)}getIntermediateTensors(){return this.clonedTensorsMap}async _executeAsync(e,t,n=!1,a={},r={}){this.disposeIntermediateTensors(),n||(e=this.mapInputs(e),this.checkInputs(e),this.checkInputShapeAndType(e),t=this.mapOutputs(t),this.checkOutputs(t));try{this.keepIntermediateTensors=Pt().getBool("KEEP_INTERMEDIATE_TENSORS")}catch(c){this.keepIntermediateTensors=!1}let s=new FT(this.weightMap,a,r,this.functionExecutorMap,this.parseNodeNameCache);this.keepIntermediateTensors&&(this.clonedTensorsMap=this.cloneTensorMap(this.weightMap));let i=await this.executeWithControlFlow(e,s,t,n),o=t.map(e=>fC(e,i,s)),l=o.map(e=>e.id),u=Object.keys(e).map(t=>e[t].id),d=new Set([...l,...u,...this.weightIds]);return Object.values(i).forEach(e=>{e.forEach(e=>{e&&!e.isDisposed&&!d.has(e.id)&&e.dispose()})}),null==this.parent&&s.dispose(d),o}async executeFunctionAsync(e,t,n){let a=e.reduce((e,t,n)=>(e[this.inputs[n].name]=t,e),{});return this._executeAsync(a,this.outputNodes,!0,t,n)}async executeWithControlFlow(e,t,n,a){let r=Object.keys(e),s=r.map(e=>this.graph.nodes[yC(e)[0]]),i=n.map(e=>yC(e)[0]),o=new Set(i),l=i.map(e=>this.graph.nodes[e]);0===l.length&&(l=this._outputs);let{usedNodes:u,missingInputs:d,dynamicNode:c,syncInputs:p}=DT(e,l,this.weightMap,this._initNodes),h=[...s,...this.graph.weights,...this._initNodes||[]].map(e=>({node:e,contexts:t.currentContext})),m=Object.assign({},this.weightMap);Object.keys(e).forEach(t=>{let[n,a]=yC(t),r=[];r[a]=e[t],m[n]=r});let f={},g=this.getFrozenTensorIds(m),x={};for(;h.length>0;){let e=this.processStack(s,h,t,m,x,g,o,f,u);await Promise.all(e)}let b=l.filter(e=>!zT(e)&&!fC(e.name,m,t)).map(e=>e.name);if(b.length>0){let e="";throw null!=c&&(e=`Alternatively, to avoid the dynamic ops, use model.execute() and specify the inputs [${p}]`),new Error(`Cannot compute the outputs [${b}] from the provided inputs [${r}]. Consider providing the following inputs: [${d}]. ${e}`)}return m}processStack(e,t,n,a,r,s,i,o,l){let u=[];for(;t.length>0;){let e=t.pop();n.currentContext=e.contexts;let d="";if("Enter"===e.node.op&&mC("isConstant",e.node,a,n)&&([d]=xC(e.node.name,n)),null==a[e.node.name]){let c=RT(e.node,a,n,this._resourceManager);d||([d]=xC(e.node.name,n));let p=n.currentContext;Ns.isPromise(c)?u.push(c.then(u=>(a[d]=u,this.keepIntermediateTensors&&(this.clonedTensorsMap[d]=this.cloneTensorList(u)),n.currentContext=p,this.checkTensorForDisposal(d,e.node,a,n,s,i,o),this.processChildNodes(e.node,t,n,a,r,l),u))):(a[d]=c,this.keepIntermediateTensors&&(this.clonedTensorsMap[d]=this.cloneTensorList(c)),this.checkTensorForDisposal(d,e.node,a,n,s,i,o),this.processChildNodes(e.node,t,n,a,r,l))}else this.processChildNodes(e.node,t,n,a,r,l)}return u}processChildNodes(e,t,n,a,r,s){e.children.forEach(e=>{let[i]=xC(e.name,n);r[i]||!s.has(e.name)||("Merge"===e.op?e.inputNames.some(e=>!!fC(e,a,n))&&(r[i]=!0,t.push({contexts:n.currentContext,node:e})):e.inputNames.every(e=>!!fC(e,a,n))&&(r[i]=!0,t.push({contexts:n.currentContext,node:e})))})}dispose(){Object.keys(this.weightMap).forEach(e=>this.weightMap[e].forEach(e=>e.dispose()))}checkInputShapeAndType(e){Object.keys(e).forEach(t=>{let n=e[t],[a]=yC(t),r=this.graph.nodes[a];if(r.attrParams.shape&&r.attrParams.shape.value){let e=r.attrParams.shape.value,t=e.length===n.shape.length&&n.shape.every((t,n)=>-1===e[n]||e[n]===t);Ns.assert(t,()=>`The shape of dict['${r.name}'] provided in model.execute(dict) must be [${e}], but was [${n.shape}]`)}r.attrParams.dtype&&r.attrParams.dtype.value&&Ns.assert(n.dtype===r.attrParams.dtype.value,()=>`The dtype of dict['${r.name}'] provided in model.execute(dict) must be ${r.attrParams.dtype.value}, but was ${n.dtype}`)})}mapInputs(e){var t,n;let a={};for(let r in e){let s=null===(n=null===(t=this._signature)||void 0===t?void 0:t.inputs)||void 0===n?void 0:n[r];null!=s?a[s.name]=e[r]:a[r]=e[r]}return a}checkInputs(e){let t=Object.keys(e).filter(e=>{let[t]=yC(e);return null==this.graph.nodes[t]});if(t.length>0)throw new Error(`The dict provided in model.execute(dict) has keys: [${t}] that are not part of graph`)}mapOutputs(e){return e.map(e=>{var t,n;let a=null===(n=null===(t=this._signature)||void 0===t?void 0:t.outputs)||void 0===n?void 0:n[e];return null!=a?a.name:e},{})}checkOutputs(e){e.forEach(e=>{let[t]=yC(e);if(!this.graph.nodes[t])throw new Error(`The output '${e}' is not found in the graph`)})}},VT=class{constructor(e={},t={}){this.hashTableNameToHandle=e,this.hashTableMap=t}addHashTable(e,t){this.hashTableNameToHandle[e]=t.handle,this.hashTableMap[t.id]=t}getHashTableHandleByName(e){return this.hashTableNameToHandle[e]}getHashTableById(e){return this.hashTableMap[e]}dispose(){for(let e in this.hashTableMap)this.hashTableMap[e].clearAndClose(),delete this.hashTableMap[e];for(let e in this.hashTableNameToHandle)this.hashTableNameToHandle[e].dispose(),delete this.hashTableNameToHandle[e]}},UT="?tfjs-format=file",GT="model.json",HT=class{get modelVersion(){return this.version}get inputNodes(){return this.executor.inputNodes}get outputNodes(){return this.executor.outputNodes}get inputs(){return this.executor.inputs}get outputs(){return this.executor.outputs}get weights(){return this.executor.weightMap}get metadata(){return this.artifacts.userDefinedMetadata}get modelSignature(){return this.signature}get modelStructuredOutputKeys(){return this.structuredOutputKeys}constructor(e,t={},n=jm){this.modelUrl=e,this.loadOptions=t,this.version="n/a",this.io=n,null==t&&(this.loadOptions={}),this.resourceManager=new VT}findIOHandler(){let e=this.modelUrl;if(null!=e.load)this.handler=e;else if(null!=this.loadOptions.requestInit)this.handler=this.io.browserHTTPRequest(e,this.loadOptions);else{let t=this.io.getLoadHandlers(e,this.loadOptions);if(0===t.length)t.push(this.io.browserHTTPRequest(e,this.loadOptions));else if(t.length>1)throw new Error(`Found more than one (${t.length}) load handlers for URL '${[e]}'`);this.handler=t[0]}}load(){if(this.findIOHandler(),null==this.handler.load)throw new Error("Cannot proceed with model loading because the IOHandler provided does not have the `load` method implemented.");let e=this.handler.load();return Ns.isPromise(e)?e.then(e=>null==e.getWeightStream?this.loadSync(e):this.loadStreaming(e)):this.loadSync(e)}loadSync(e){let t=this.io.decodeWeights(e.weightData,e.weightSpecs);return this.loadWithWeightMap(e,t)}async loadStreaming(e){if(null==e.getWeightStream)throw new Error("Model artifacts missing streamWeights function");let t=await vo(e.getWeightStream(),e.weightSpecs);return this.loadWithWeightMap(e,t)}loadWithWeightMap(e,t){this.artifacts=e;let n=this.artifacts.modelTopology,a=this.artifacts.signature;if(null!=this.artifacts.userDefinedMetadata){let e=this.artifacts.userDefinedMetadata;null!=e.signature&&(a=e.signature),null!=e.structuredOutputKeys&&(this.structuredOutputKeys=e.structuredOutputKeys)}if(this.signature=a,this.version=`${n.versions.producer}.${n.versions.minConsumer}`,this.executor=new WT(iT.Instance.transformGraph(n,this.signature)),this.executor.weightMap=this.convertTensorMapToTensorsMap(t),this.executor.resourceManager=this.resourceManager,null!=e.modelInitializer&&null!=e.modelInitializer.node){let t=iT.Instance.transformGraph(e.modelInitializer);this.initializer=new WT(t),this.initializer.weightMap=this.executor.weightMap,this.initializer.resourceManager=this.resourceManager,this.initializerSignature=e.initializerSignature}return!0}async save(e,t){if("string"==typeof e){let t=this.io.getSaveHandlers(e);if(0===t.length)throw new Error(`Cannot find any save handlers for URL '${e}'`);if(t.length>1)throw new Error(`Found more than one (${t.length}) save handlers for URL '${e}'`);e=t[0]}if(null==e.save)throw new Error("GraphModel.save() cannot proceed because the IOHandler provided does not have the `save` attribute defined.");return e.save(this.artifacts)}addStructuredOutputNames(e){if(this.structuredOutputKeys){let t={};return(e instanceof ri?[e]:e).forEach((e,n)=>t[this.structuredOutputKeys[n]]=e),t}return e}predict(e,t){let n=this.execute(e,this.outputNodes);return this.addStructuredOutputNames(n)}async predictAsync(e,t){let n=await this.executeAsync(e,this.outputNodes);return this.addStructuredOutputNames(n)}normalizeInputs(e){var t;if(!(e instanceof ri||Array.isArray(e))){let n=null===(t=this.signature)||void 0===t?void 0:t.inputs;if(null!=n)for(let t in n){let a=n[t];null!=a.resourceId&&(e[t]=this.resourceIdToCapturedInput[a.resourceId])}return e}e=Array.isArray(e)?e:[e];let n=Object.keys(this.resourceIdToCapturedInput).length;if(e.length+n!==this.inputNodes.length)throw new Error(`Input tensor count mismatch, the graph model has ${this.inputNodes.length-n} non-resource placeholders, while there are ${e.length} input tensors provided.`);let a=0;return this.inputNodes.reduce((t,n)=>{var r,s,i;let o=null===(i=null===(s=null===(r=this.signature)||void 0===r?void 0:r.inputs)||void 0===s?void 0:s[n])||void 0===i?void 0:i.resourceId;return t[n]=null!=o?this.resourceIdToCapturedInput[o]:e[a++],t},{})}normalizeOutputs(e){return e=e||this.outputNodes,Array.isArray(e)?e:[e]}executeInitializerGraph(){return null==this.initializer?[]:null==this.initializerSignature?this.initializer.execute({},[]):this.initializer.execute({},Object.keys(this.initializerSignature.outputs))}async executeInitializerGraphAsync(){return null==this.initializer?[]:null==this.initializerSignature?this.initializer.executeAsync({},[]):this.initializer.executeAsync({},Object.keys(this.initializerSignature.outputs))}setResourceIdToCapturedInput(e){if(this.resourceIdToCapturedInput={},this.initializerSignature){let t=this.initializerSignature.outputs,n=Object.keys(t);for(let a=0;a<n.length;a++){let r=t[n[a]];this.resourceIdToCapturedInput[r.resourceId]=e[a]}}}execute(e,t){null==this.resourceIdToCapturedInput&&this.setResourceIdToCapturedInput(this.executeInitializerGraph()),e=this.normalizeInputs(e),t=this.normalizeOutputs(t);let n=this.executor.execute(e,t);return n.length>1?n:n[0]}async executeAsync(e,t){null==this.resourceIdToCapturedInput&&this.setResourceIdToCapturedInput(await this.executeInitializerGraphAsync()),e=this.normalizeInputs(e),t=this.normalizeOutputs(t);let n=await this.executor.executeAsync(e,t);return n.length>1?n:n[0]}getIntermediateTensors(){return this.executor.getIntermediateTensors()}disposeIntermediateTensors(){this.executor.disposeIntermediateTensors()}convertTensorMapToTensorsMap(e){return Object.keys(e).reduce((t,n)=>(t[n]=[e[n]],t),{})}dispose(){this.executor.dispose(),this.initializer&&(this.initializer.dispose(),this.resourceIdToCapturedInput&&no(this.resourceIdToCapturedInput)),this.resourceManager.dispose()}};async function qT(e,t={},n=jm){if(null==e)throw new Error("modelUrl in loadGraphModel() cannot be null. Please provide a url or an IOHandler that loads the model");null==t&&(t={}),t.fromTFHub&&"string"==typeof e&&(e=function(e){return e.endsWith("/")||(e+="/"),`${e}${GT}${UT}`}(e));let a=new HT(e,t,n);return await a.load(),a}function KT(e){if(null==e)throw new Error("modelUrl in loadGraphModelSync() cannot be null. Please provide model artifacts or an IOHandler that loads the model");let t;if(e instanceof Array){let[n,a]=e;if(!n)throw new Error("modelJSON must be the first element of the array");if(!(a&&a instanceof ArrayBuffer))throw new Error("An ArrayBuffer of weights must be the second element of the array");if(!("modelTopology"in n))throw new Error("Model JSON is missing 'modelTopology'");if(!("weightsManifest"in n))throw new Error("Model JSON is missing 'weightsManifest'");let r=jm.getWeightSpecs(n.weightsManifest),s=jm.getModelArtifactsForJSONSync(n,r,a);t=jm.fromMemorySync(s)}else if("load"in e)t=e;else{if(!("modelTopology"in e&&"weightSpecs"in e&&"weightData"in e))throw new Error("Unknown model format");t=jm.fromMemorySync(e)}let n=new HT(t);return n.load(),n}var XT="4.22.0",YT={};xe(YT,{CSVDataset:()=>WE,Dataset:()=>EE,FileDataSource:()=>eA,TextLineDataset:()=>ME,URLDataSource:()=>tA,array:()=>$E,csv:()=>nA,func:()=>aA,generator:()=>rA,microphone:()=>iA,version_data:()=>oA,webcam:()=>sA,zip:()=>RE});var ZT=be(Ae()),JT=be(Ae());function QT(e,t,n=new Map,a=new Set){if(null==e)return null;if("function"==typeof Blob&&e instanceof Blob)return e.slice();if(a.has(e))throw new Error("Circular references are not supported.");if(n.has(e))return n.get(e);let r=t(e);if(r.recurse&&null!==r.value)throw new Error("A deep map function may not return both a value and recurse=true.");if(r.recurse){if(rE(e)){let r=Array.isArray(e)?[]:{};a.add(e);for(let s in e){let i=QT(e[s],t,n,a);r[s]=i}return a.delete(e),e.__proto__&&(r.__proto__=e.__proto__),r}throw new Error(`Can't recurse into non-iterable type: ${e}`)}return n.set(e,r.value),r.value}function eE(e,t=nE){return tE(e,t)}function tE(e,t,n=new Set){let a=e[0];if(n.has(a))throw new Error("Circular references are not supported.");let r=t(e);if(r.recurse&&null!==r.value)throw new Error("A deep zip function may not return both a value and recurse=true.");if(r.recurse){if(rE(a)){let r=Array.isArray(a)?[]:{};n.add(a);for(let s in a){let a=tE(e.map(e=>e[s]),t,n);r[s]=a}return n.delete(a),r}throw new Error(`Can't recurse into non-iterable type: ${a}`)}return r.value}function nE(e){return null===e?null:rE(e[0])?{value:null,recurse:!0}:{value:e,recurse:!1}}async function aE(e,t){let n=new Map;QT(e,t,n);for(let a of Array.from(n.keys())){let e=n.get(a);if(Ns.isPromise(e)){let t=await e;n.set(a,t)}}return QT(e,t,n)}function rE(e){let t=!1;if(Pt().get("IS_BROWSER"))t=e instanceof TextDecoder;else{let{StringDecoder:n}=$e();t=e instanceof n}return null!=e&&!ArrayBuffer.isView(e)&&(Array.isArray(e)||"object"==typeof e&&!(e instanceof ri)&&!(e instanceof Promise)&&!t)}function sE(e){return function(e){return QT(e,iE)}(e)}function iE(e){return e instanceof ri?{value:e.clone(),recurse:!1}:rE(e)?{value:null,recurse:!0}:{value:e,recurse:!1}}var oE=class{constructor(e){if(this.capacity=e,this.begin=0,this.end=0,null==e)throw new RangeError("Can't create a ring buffer of unknown capacity.");if(e<1)throw new RangeError("Can't create ring buffer of capacity < 1.");this.data=new Array(e),this.doubledCapacity=2*e}wrap(e){for(;e<0;)e+=this.doubledCapacity;return e%this.doubledCapacity}get(e){if(e<0)throw new RangeError("Can't get item at a negative index.");return this.data[e%this.capacity]}set(e,t){if(e<0)throw new RangeError("Can't set item at a negative index.");this.data[e%this.capacity]=t}length(){let e=this.end-this.begin;return e<0&&(e=this.doubledCapacity+e),e}isFull(){return this.length()===this.capacity}isEmpty(){return 0===this.length()}push(e){if(this.isFull())throw new RangeError("Ring buffer is full.");this.set(this.end,e),this.end=this.wrap(this.end+1)}pushAll(e){for(let t of e)this.push(t)}pop(){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");this.end=this.wrap(this.end-1);let e=this.get(this.end);return this.set(this.end,void 0),e}unshift(e){if(this.isFull())throw new RangeError("Ring buffer is full.");this.begin=this.wrap(this.begin-1),this.set(this.begin,e)}shift(){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");let e=this.get(this.begin);return this.set(this.begin,void 0),this.begin=this.wrap(this.begin+1),e}shuffleExcise(e){if(this.isEmpty())throw new RangeError("Ring buffer is empty.");let t=this.wrap(this.begin+e),n=this.get(t);return this.set(t,this.pop()),n}},lE=class e extends oE{constructor(){super(e.INITIAL_CAPACITY)}isFull(){return!1}push(e){super.isFull()&&this.expand(),super.push(e)}unshift(e){super.isFull()&&this.expand(),super.unshift(e)}expand(){let e=2*this.capacity,t=new Array(e),n=this.length();for(let a=0;a<n;a++)t[a]=this.get(this.wrap(this.begin+a));this.data=t,this.capacity=e,this.doubledCapacity=2*this.capacity,this.begin=0,this.end=n}};function uE(e){return new hE(e)}function dE(e){return new mE(e)}lE.INITIAL_CAPACITY=32;var cE,pE=class{async toArray(){let e=[],t=await this.next();for(;!t.done;)e.push(t.value),t=await this.next();return e}async toArrayForTest(){let e=this.prefetch(100),t=[],n=await e.next();for(;!n.done;)t.push(n.value),n=await e.next();return t}async resolveFully(){let e=await this.next();for(;!e.done;)e=await this.next()}async resolveWhile(e){let t=await this.next(),n=e(t.value);for(;!t.done&&n;)t=await this.next(),n=e(t.value)}handleErrors(e){return new vE(this,e)}filter(e){return new yE(this,e)}map(e){return new wE(this,e)}mapAsync(e){return new kE(this,e)}serialMapAsync(e){return new kE(this,e).serial()}flatmap(e){return new SE(this,e)}async forEachAsync(e){return this.map(e).resolveFully()}async serialForEach(e){return this.serialMapAsync(e).resolveWhile(e=>!0===e)}rowMajorBatch(e,t=!0){return new bE(this,e,t)}columnMajorBatch(e,t=!0,n=nE){return this.rowMajorBatch(e,t).map(e=>eE(e,n))}concatenate(e,t){return new IE(uE([this,e]),t)}take(e){return e<0||null==e?this:new xE(this,e)}skip(e){return e<0||null==e?this:new gE(this,e)}prefetch(e){return new CE(this,e)}shuffle(e,t){return new TE(this,e,t)}serial(){return new fE(this)}},hE=class extends pE{constructor(e){super(),this.items=e,this.trav=0}summary(){return`Array of ${this.items.length} items`}async next(){if(this.trav>=this.items.length)return{value:null,done:!0};let e=this.items[this.trav];return this.trav++,{value:sE(e),done:!1}}},mE=class extends pE{constructor(e){super(),this.nextFn=e}summary(){return"Function call"}async next(){try{return this.nextFn()}catch(ie){throw ie.message=`Error thrown while iterating through a dataset: ${ie.message}`,ie}}},fE=class extends pE{constructor(e){super(),this.upstream=e,this.lastRead=Promise.resolve({value:null,done:!1})}summary(){return`${this.upstream.summary()} -> Serial`}async next(){return this.lastRead=this.lastRead.then(()=>this.serialNext()),this.lastRead}async serialNext(){return this.upstream.next()}},gE=class extends pE{constructor(e,t){super(),this.upstream=e,this.maxCount=t,this.count=0,this.lastRead=Promise.resolve({value:null,done:!1})}summary(){return`${this.upstream.summary()} -> Skip`}async next(){return this.lastRead=this.lastRead.then(()=>this.serialNext()),this.lastRead}async serialNext(){for(;this.count++<this.maxCount;){let e=await this.upstream.next();if(e.done)return e;no(e.value)}return this.upstream.next()}},xE=class extends pE{constructor(e,t){super(),this.upstream=e,this.maxCount=t,this.count=0}summary(){return`${this.upstream.summary()} -> Take`}async next(){return this.count++>=this.maxCount?{value:null,done:!0}:this.upstream.next()}},bE=class extends pE{constructor(e,t,n=!0){super(),this.upstream=e,this.batchSize=t,this.enableSmallLastBatch=n,this.lastRead=Promise.resolve({value:null,done:!1})}summary(){return`${this.upstream.summary()} -> RowMajorBatch`}async next(){return this.lastRead=this.lastRead.then(()=>this.serialNext()),this.lastRead}async serialNext(){let e=[];for(;e.length<this.batchSize;){let t=await this.upstream.next();if(t.done)return this.enableSmallLastBatch&&e.length>0?{value:e,done:!1}:{value:null,done:!0};e.push(t.value)}return{value:e,done:!1}}},yE=class extends pE{constructor(e,t){super(),this.upstream=e,this.predicate=t,this.lastRead=Promise.resolve({value:null,done:!1})}summary(){return`${this.upstream.summary()} -> Filter`}async next(){return this.lastRead=this.lastRead.then(()=>this.serialNext()),this.lastRead}async serialNext(){for(;;){let e=await this.upstream.next();if(e.done||this.predicate(e.value))return e;no(e.value)}}},wE=class extends pE{constructor(e,t){super(),this.upstream=e,this.transform=t}summary(){return`${this.upstream.summary()} -> Map`}async next(){let e=await this.upstream.next();if(e.done)return{value:null,done:!0};let t=pi.getTensorsInContainer(e.value),n=this.transform(e.value),a=pi.getTensorsInContainer(n);for(let r of t)pi.isTensorInList(r,a)||r.dispose();return{value:n,done:!1}}},vE=class extends pE{constructor(e,t){super(),this.upstream=e,this.handler=t,this.count=0,this.lastRead=Promise.resolve({value:null,done:!1})}summary(){return`${this.upstream.summary()} -> handleErrors`}async next(){return this.lastRead=this.lastRead.then(()=>this.serialNext()),this.lastRead}async serialNext(){for(;;)try{return await this.upstream.next()}catch(ie){if(!this.handler(ie))return{value:null,done:!0}}}},kE=class extends pE{constructor(e,t){super(),this.upstream=e,this.transform=t}summary(){return`${this.upstream.summary()} -> AsyncMap`}async next(){let e=await this.upstream.next();if(e.done)return{value:null,done:!0};let t=pi.getTensorsInContainer(e.value),n=await this.transform(e.value),a=pi.getTensorsInContainer(n);for(let r of t)pi.isTensorInList(r,a)||r.dispose();return{value:n,done:!1}}},NE=class extends pE{constructor(){super(),this.outputQueue=new lE,this.lastRead=Promise.resolve({value:null,done:!1})}async next(){return this.lastRead=this.lastRead.then(()=>this.serialNext()),this.lastRead}async serialNext(){for(;0===this.outputQueue.length();)if(!(await this.pump()))return{value:null,done:!0};return{value:this.outputQueue.shift(),done:!1}}},SE=class extends NE{constructor(e,t){super(),this.upstream=e,this.transform=t}summary(){return`${this.upstream.summary()} -> Flatmap`}async pump(){let e=await this.upstream.next();if(e.done)return!1;let t=pi.getTensorsInContainer(e.value),n=this.transform(e.value),a=pi.getTensorsInContainer(n);this.outputQueue.pushAll(n);for(let r of t)pi.isTensorInList(r,a)||r.dispose();return!0}},IE=class extends pE{constructor(e,t){super(),this.baseErrorHandler=t,this.lastRead=null,this.iterator=null,this.moreIterators=e}summary(){return"TODO: fill in upstream of chained summaries -> Chained"}async next(){return this.lastRead=this.readFromChain(this.lastRead),this.lastRead}async readFromChain(e){if(await e,null==this.iterator){let e=await this.moreIterators.next();if(e.done)return{value:null,done:!0};this.iterator=e.value,null!=this.baseErrorHandler&&(this.iterator=this.iterator.handleErrors(this.baseErrorHandler))}let t=await this.iterator.next();return t.done?(this.iterator=null,this.readFromChain(e)):t}};!function(e){e[e.FAIL=0]="FAIL",e[e.SHORTEST=1]="SHORTEST",e[e.LONGEST=2]="LONGEST"}(cE||(cE={}));var _E=class extends pE{constructor(e,t=cE.FAIL){super(),this.iterators=e,this.mismatchMode=t,this.count=0,this.currentPromise=null}summary(){return"{TODO: fill in upstream of zip summaries} -> Zip"}async nextState(e){await e;let t=0,n=0,a=await aE(this.iterators,function(e){return e instanceof pE?{value:e.next().then(e=>(t++,e.done&&n++,e.value)),recurse:!1}:{value:null,recurse:!0}});if(t===n)return{value:null,done:!0};if(n>0)switch(this.mismatchMode){case cE.FAIL:throw new Error(`Zipped streams should have the same length. Mismatched at element ${this.count}.`);case cE.SHORTEST:return{value:null,done:!0};case cE.LONGEST:}return this.count++,{value:a,done:!1}}async next(){return this.currentPromise=this.nextState(this.currentPromise),this.currentPromise}},CE=class extends pE{constructor(e,t){super(),this.upstream=e,this.bufferSize=t,this.buffer=new oE(t)}summary(){return`${this.upstream.summary()} -> Prefetch`}refill(){for(;!this.buffer.isFull();){let e=this.upstream.next();this.buffer.push(e)}}next(){return this.refill(),this.buffer.shift()}},TE=class extends CE{constructor(e,t,n){super(e,t),this.upstream=e,this.windowSize=t,this.upstreamExhausted=!1,this.random=JT.alea(n||Ns.now().toString()),this.lastRead=Promise.resolve({value:null,done:!1})}async next(){return this.lastRead=this.lastRead.then(()=>this.serialNext()),this.lastRead}randomInt(e){return Math.floor(this.random()*e)}chooseIndex(){return this.randomInt(this.buffer.length())}async serialNext(){for(this.upstreamExhausted||this.refill();!this.buffer.isEmpty();){let e=this.chooseIndex(),t=await this.buffer.shuffleExcise(e);if(!t.done)return this.refill(),t;this.upstreamExhausted=!0}return{value:null,done:!0}}},EE=class{constructor(){this.size=null}batch(e,t=!0){let n,a=this;return Ns.assert(e>0,()=>`batchSize needs to be positive, but it is\n      ${e}`),n=this.size===1/0||null==this.size?this.size:t?Math.ceil(this.size/e):Math.floor(this.size/e),AE(async()=>(await a.iterator()).columnMajorBatch(e,t,FE),n)}concatenate(e){let t,n=this;return t=this.size===1/0||e.size===1/0?1/0:null!=this.size&&null!=e.size?this.size+e.size:null,AE(async()=>(await n.iterator()).concatenate(await e.iterator()),t)}filter(e){let t,n=this;return t=this.size===1/0?1/0:null,AE(async()=>(await n.iterator()).filter(t=>to(()=>e(t))),t)}async forEachAsync(e){return(await this.iterator()).forEachAsync(e)}map(e){let t=this;return AE(async()=>(await t.iterator()).map(t=>to(()=>e(t))),this.size)}mapAsync(e){let t=this;return AE(async()=>(await t.iterator()).mapAsync(e),this.size)}prefetch(e){if(null==e)throw new RangeError("`Dataset.prefetch()` requires bufferSize to be specified.");let t=this;return AE(async()=>(await t.iterator()).prefetch(e),this.size)}repeat(e){let t,n=this;return t=null!=this.size&&e>0?this.size*e:0===e?0:null!=this.size&&(void 0===e||e<0)?1/0:null,AE(async()=>function(e){return new IE(e,void 0)}(dE(async()=>({value:await n.iterator(),done:!1})).take(e)),t)}skip(e){let t,n=this;return t=null!=this.size&&e>=0&&this.size>=e?this.size-e:null!=this.size&&(this.size<e||void 0===e||e<0)?0:null,AE(async()=>(await n.iterator()).skip(e),t)}shuffle(e,t,n=!0){if(null==e||e<0)throw null==this.size?new RangeError("`Dataset.shuffle()` requires bufferSize to be specified."):new RangeError(`\`Dataset.shuffle()\` requires bufferSize to be specified.  If your data fits in main memory (for regular JS objects), and/or GPU memory (for \`tf.Tensor\`s), consider setting bufferSize to the dataset size (${this.size} elements)`);let a=this,r=ZT.alea(t||Ns.now().toString());return AE(async()=>{let t=r.int32();return n&&(t+=r.int32()),(await a.iterator()).shuffle(e,t.toString())},this.size)}take(e){let t,n=this;return t=null!=this.size&&this.size>e?e:null!=this.size&&this.size<=e?this.size:null,AE(async()=>(await n.iterator()).take(e),t)}async toArray(){if(this.size===1/0)throw new Error("Can not convert infinite data stream to array.");return(await this.iterator()).toArray()}async toArrayForTest(){if(this.size===1/0)throw new Error("Can not convert infinite data stream to array.");return(await this.iterator()).toArrayForTest()}};function AE(e,t=null){return new class extends EE{constructor(){super(...arguments),this.size=t}async iterator(){return e()}}}function $E(e){return AE(async()=>uE(e),e.length)}function RE(e){if(!rE(e))throw new Error("The argument to zip() must be an object or array.");let t;if(Array.isArray(e))for(let n=0;n<e.length;n++)t=null==t?e[n].size:Math.min(t,e[n].size);else if(e instanceof Object)for(let n in e)t=null==t?e[n].size:Math.min(t,e[n].size);return AE(async()=>function(e,t=cE.FAIL){return new _E(e,t)}(await aE(e,e=>{if(e instanceof EE)return{value:e.iterator(),recurse:!1};if(rE(e))return{value:null,recurse:!0};throw new Error("Leaves of the structure passed to zip() must be Datasets, not primitives.")}),cE.SHORTEST),t)}function FE(e){return null===e?null:function(e){return null==e||function(e){return null===e||"object"!=typeof e&&"function"!=typeof e}(e)||Array.isArray(e)||"object"==typeof e&&e instanceof ri||Ns.isTypedArray(e)}(e[0])?{value:DE(e),recurse:!1}:{value:null,recurse:!0}}function DE(e){if(0===e.length)throw new Error("Can't make a batch of zero elements.");return e[0]instanceof ri?Ep(e):Ui(e)}EE.MAX_BUFFER_SIZE=1e4;var ME=class extends EE{constructor(e){super(),this.input=e}async iterator(){return(await this.input.iterator()).decodeUTF8().split("\n").map(e=>(e.endsWith("\r")&&(e=e.slice(0,-1)),e))}},OE='"',jE=Symbol("out"),LE=Symbol("field"),zE=Symbol("quote"),PE=Symbol("quoteafterquote"),BE=Symbol("quoteinquote"),WE=class extends EE{async columnNames(){return this.columnNamesValidated||await this.setColumnNames(),this.configuredColumnsOnly?Object.keys(this.columnConfigs):this.fullColumnNames}async setColumnNames(){let e=await this.maybeReadHeaderLine();if(!this.fullColumnNames&&!e)throw new Error("Column names must be provided if there is no header line.");this.fullColumnNames&&e&&Ns.assert(e.length===this.fullColumnNames.length,()=>"The length of provided columnNames ("+this.fullColumnNames.length.toString()+") does not match the length of the header line read from file ("+e.length.toString()+")."),this.fullColumnNames||(this.fullColumnNames=e);let t=this.fullColumnNames.reduce((e,t)=>(e[t]=e[t]+1||1,e),{}),n=Object.keys(t).filter(e=>t[e]>1);if(Ns.assert(0===n.length,()=>"Duplicate column names found: "+n.toString()),this.columnConfigs)for(let a of Object.keys(this.columnConfigs))if(-1===this.fullColumnNames.indexOf(a))throw new Error('The key "'+a+'" provided in columnConfigs does not match any of the column names ('+this.fullColumnNames.toString()+").");this.columnNamesValidated=!0}async maybeReadHeaderLine(){if(this.hasHeader){let e=await(await this.base.iterator()).next();if(e.done)throw new Error("No data was found for CSV parsing.");let t=e.value;return this.parseRow(t,!1)}return null}constructor(e,t){super(),this.input=e,this.hasHeader=!0,this.fullColumnNames=null,this.columnNamesValidated=!1,this.columnConfigs=null,this.configuredColumnsOnly=!1,this.delimiter=",",this.delimWhitespace=!1,this.base=new ME(e),t||(t={}),this.hasHeader=!1!==t.hasHeader,this.fullColumnNames=t.columnNames,this.columnConfigs=t.columnConfigs,this.configuredColumnsOnly=t.configuredColumnsOnly,t.delimWhitespace?(Ns.assert(null==t.delimiter,()=>"Delimiter should not be provided when delimWhitespace is true."),this.delimWhitespace=!0,this.delimiter=" "):this.delimiter=t.delimiter?t.delimiter:","}async iterator(){this.columnNamesValidated||await this.setColumnNames();let e=await this.base.iterator();return this.hasHeader&&(e=e.skip(1)),e.map(e=>this.makeDataElement(e))}makeDataElement(e){let t=this.parseRow(e),n={},a={};for(let r=0;r<this.fullColumnNames.length;r++){let s=this.fullColumnNames[r],i=this.columnConfigs?this.columnConfigs[s]:null;if(!this.configuredColumnsOnly||i){let o=t[r],l=null;if(""===o)if(i&&void 0!==i.default)l=i.default;else{if(i&&(i.required||i.isLabel))throw new Error(`Required column ${s} is empty in this line: ${e}`);l=void 0}else{let e=Number(o);if(isNaN(e))l=i&&"bool"===i.dtype?this.getBoolean(o):o;else if(i&&i.dtype)switch(i.dtype){case"float32":default:l=e;break;case"int32":l=Math.floor(e);break;case"bool":l=this.getBoolean(o)}else l=e}i&&i.isLabel?a[s]=l:n[s]=l}}return 0===Object.keys(a).length?n:{xs:n,ys:a}}getBoolean(e){return"1"===e||"true"===e.toLowerCase()?1:0}parseRow(e,t=!0){let n=[],a=0,r=e.length,s=jE;for(let i=0;i<r;i++)switch(s){case jE:switch(e.charAt(i)){case OE:a=i+1,s=zE;break;case this.delimiter:if(a=i+1," "===this.delimiter&&this.delimWhitespace)break;n.push(""),s=jE;break;default:s=LE,a=i}break;case LE:e.charAt(i)===this.delimiter&&(n.push(e.substring(a,i)),s=jE,a=i+1);break;case zE:e.charAt(i)===OE&&(s=PE);break;case PE:switch(e.charAt(i)){case this.delimiter:n.push(e.substring(a,i-1)),s=jE,a=i+1;break;case OE:s=zE;break;default:s=BE}break;case BE:e.charAt(i)===OE&&(s=zE)}if(s===PE?n.push(e.substring(a,r-1)):n.push(e.substring(a)),t&&n.length!==this.fullColumnNames.length)throw new Error(`Invalid row in csv file. Should have ${this.fullColumnNames.length} elements in a row, but got ${n}`);return n}},VE=class e extends pE{constructor(e){super(),this.microphoneConfig=e,this.isClosed=!1,this.fftSize=e.fftSize||1024;let t=Math.log2(this.fftSize);if(this.fftSize<0||t<4||t>14||!Number.isInteger(t))throw new Error(`Invalid fftSize: it must be a power of 2 between 2 to 4 and 2 to 14, but got ${this.fftSize}`);if(this.numFrames=e.numFramesPerSpectrogram||43,this.sampleRateHz=e.sampleRateHz,this.columnTruncateLength=e.columnTruncateLength||this.fftSize,this.audioTrackConstraints=e.audioTrackConstraints,this.smoothingTimeConstant=e.smoothingTimeConstant||0,this.includeSpectrogram=!1!==e.includeSpectrogram,this.includeWaveform=!0===e.includeWaveform,!this.includeSpectrogram&&!this.includeWaveform)throw new Error("Both includeSpectrogram and includeWaveform are false. At least one type of data should be returned.")}summary(){return"microphone"}static async create(t={}){if(!Pt().get("IS_BROWSER"))throw new Error("microphone API is only supported in browser environment.");let n=new e(t);return await n.start(),n}async start(){try{this.stream=await navigator.mediaDevices.getUserMedia({audio:null==this.audioTrackConstraints||this.audioTrackConstraints,video:!1})}catch(n){throw new Error(`Error thrown while initializing video stream: ${n.message}`)}if(!this.stream)throw new Error("Could not obtain audio from microphone.");let e=window.AudioContext||window.webkitAudioContext;if(this.audioContext=new e,this.sampleRateHz){if(this.audioContext.sampleRate!==this.sampleRateHz)throw new Error(`Mismatch in sampling rate: Expected: ${this.sampleRateHz}; Actual: ${this.audioContext.sampleRate}`)}else this.sampleRateHz=this.audioContext.sampleRate;let t=this.audioContext.createMediaStreamSource(this.stream);this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2*this.fftSize,this.analyser.smoothingTimeConstant=this.smoothingTimeConstant,t.connect(this.analyser),this.freqData=new Float32Array(this.fftSize),this.timeData=new Float32Array(this.fftSize)}async next(){if(this.isClosed)return{value:null,done:!0};let e,t,n=await this.getAudioData();if(this.includeSpectrogram){let t=this.flattenQueue(n.freqDataQueue);e=this.getTensorFromAudioDataArray(t,[this.numFrames,this.columnTruncateLength,1])}if(this.includeWaveform){let e=this.flattenQueue(n.timeDataQueue);t=this.getTensorFromAudioDataArray(e,[this.numFrames*this.fftSize,1])}return{value:{spectrogram:e,waveform:t},done:!1}}async capture(){return(await this.next()).value}async getAudioData(){let e=[],t=[],n=0;return new Promise(a=>{let r=setInterval(()=>{this.includeSpectrogram&&(this.analyser.getFloatFrequencyData(this.freqData),this.freqData[0]===-1/0&&a({freqDataQueue:e,timeDataQueue:t}),e.push(this.freqData.slice(0,this.columnTruncateLength))),this.includeWaveform&&(this.analyser.getFloatTimeDomainData(this.timeData),t.push(this.timeData.slice())),++n===this.numFrames&&(clearInterval(r),a({freqDataQueue:e,timeDataQueue:t}))},this.fftSize/this.sampleRateHz*1e3)})}stop(){this.isClosed||(this.isClosed=!0,this.analyser.disconnect(),this.audioContext.close(),null!=this.stream&&this.stream.getTracks().length>0&&this.stream.getTracks()[0].stop())}toArray(){throw new Error("Can not convert infinite audio stream to array.")}getSampleRate(){return this.sampleRateHz}flattenQueue(e){let t=e[0].length,n=new Float32Array(e.length*t);return e.forEach((e,a)=>n.set(e,a*t)),n}getTensorFromAudioDataArray(e,t){let n=new Float32Array(Ns.sizeFromShape(t));return n.set(e,n.length-e.length),Ui(n,t)}},UE=class e extends pE{constructor(e,t){if(super(),this.webcamVideoElement=e,this.webcamConfig=t,this.isClosed=!0,this.resize=!1,this.needToResize())if(this.resize=!0,this.cropSize=[this.webcamConfig.resizeHeight,this.webcamConfig.resizeWidth],this.cropBoxInd=Fp([0],"int32"),this.webcamConfig.centerCrop){let e=1*this.webcamConfig.resizeWidth/this.webcamVideoElement.width,t=1*this.webcamConfig.resizeHeight/this.webcamVideoElement.height,n=(1-e)/2,a=(1-t)/2,r=n+e,s=t+a;this.cropBox=Dp([a,n,s,r],[1,4])}else this.cropBox=Dp([0,0,1,1],[1,4])}summary(){return"webcam"}static async create(t,n={}){if(!Pt().get("IS_BROWSER"))throw new Error("tf.data.webcam is only supported in browser environment.");if(!t){if(t=document.createElement("video"),!n.resizeWidth||!n.resizeHeight)throw new Error("Please provide webcam video element, or resizeWidth and resizeHeight to create a hidden video element.");t.width=n.resizeWidth,t.height=n.resizeHeight}let a=new e(t,n);return await a.start(),a}async start(){this.webcamConfig.facingMode&&Ns.assert("user"===this.webcamConfig.facingMode||"environment"===this.webcamConfig.facingMode,()=>`Invalid webcam facing mode: ${this.webcamConfig.facingMode}. Please provide 'user' or 'environment'`);try{this.stream=await navigator.mediaDevices.getUserMedia({video:{deviceId:this.webcamConfig.deviceId,facingMode:this.webcamConfig.facingMode?this.webcamConfig.facingMode:"user",width:this.webcamVideoElement.width,height:this.webcamVideoElement.height}})}catch(e){throw e.message=`Error thrown while initializing video stream: ${e.message}`,e}if(!this.stream)throw new Error("Could not obtain video from webcam.");try{this.webcamVideoElement.srcObject=this.stream}catch(e){this.webcamVideoElement.src=window.URL.createObjectURL(this.stream)}return this.webcamVideoElement.play(),this.isClosed=!1,new Promise(e=>{this.webcamVideoElement.onloadedmetadata=()=>{e()}})}async next(){if(this.isClosed)return{value:null,done:!0};let e;try{e=of.fromPixels(this.webcamVideoElement)}catch(XQ){throw new Error(`Error thrown converting video to pixels: ${JSON.stringify(XQ)}`)}if(!this.resize)return{value:e,done:!1};try{return{value:this.cropAndResizeFrame(e),done:!1}}catch(XQ){throw new Error(`Error thrown cropping the video: ${XQ.message}`)}finally{e.dispose()}}needToResize(){return!(!this.webcamConfig.resizeWidth||!this.webcamConfig.resizeHeight||this.webcamVideoElement.width===this.webcamConfig.resizeWidth&&this.webcamVideoElement.height===this.webcamConfig.resizeHeight)}cropAndResizeFrame(e){return to(()=>{let t,n=hd(pl(e,"float32"),0);t=gm.cropAndResize(n,this.cropBox,this.cropBoxInd,this.cropSize,"bilinear");let a=t.shape;return ql(t,a.slice(1))})}async capture(){return(await this.next()).value}stop(){this.stream.getTracks().forEach(e=>e.stop());try{this.webcamVideoElement.srcObject=null}catch(e){this.webcamVideoElement.src=null}this.isClosed=!0}toArray(){throw new Error("Can not convert infinite video stream to array.")}},GE=class{},HE=class extends pE{split(e){return new qE(this,e)}},qE=class extends HE{constructor(e,t){super(),this.upstream=e,this.impl=new KE(e,t)}summary(){return this.impl.summary()}async next(){return this.impl.next()}},KE=class extends NE{constructor(e,t){super(),this.upstream=e,this.separator=t,this.carryover=""}summary(){return`${this.upstream.summary()} -> Split('${this.separator}')`}async pump(){let e=await this.upstream.next();if(e.done)return""!==this.carryover&&(this.outputQueue.push(this.carryover),this.carryover="",!0);let t=e.value.split(this.separator);t[0]=this.carryover+t[0];for(let n of t.slice(0,-1))this.outputQueue.push(n);return this.carryover=t[t.length-1],!0}},XE=class extends pE{decodeUTF8(){return new YE(this)}},YE=class extends HE{constructor(e){super(),this.upstream=e,this.impl=new ZE(e)}summary(){return this.impl.summary()}async next(){return this.impl.next()}},ZE=class extends NE{constructor(e){if(super(),this.upstream=e,Pt().get("IS_BROWSER"))this.decoder=new TextDecoder("utf-8");else{let{StringDecoder:e}=$e();this.decoder=new e("utf8")}}summary(){return`${this.upstream.summary()} -> Utf8`}async pump(){let e,t,n=await this.upstream.next();return!n.done&&(e=n.value,t=Pt().get("IS_BROWSER")?this.decoder.decode(e,{stream:!0}):this.decoder.write(Buffer.from(e.buffer)),this.outputQueue.push(t),!0)}},JE=class extends XE{constructor(e,t={}){super(),this.file=e,this.options=t,Ns.assert(e instanceof Uint8Array||!!Pt().get("IS_BROWSER")&&(e instanceof File||e instanceof Blob),()=>"FileChunkIterator only supports File, Blob and Uint8Array right now."),this.offset=t.offset||0,this.chunkSize=t.chunkSize||1048576}summary(){return`FileChunks ${this.file}`}async next(){return this.offset>=(this.file instanceof Uint8Array?this.file.byteLength:this.file.size)?{value:null,done:!0}:{value:await new Promise((e,t)=>{let n=this.offset+this.chunkSize;if(this.file instanceof Uint8Array)e(new Uint8Array(this.file.slice(this.offset,n)));else{let a=new FileReader;a.onload=n=>{let r=a.result;if(r instanceof ArrayBuffer&&(r=new Uint8Array(r)),!(r instanceof Uint8Array))return t(new TypeError("FileReader returned unknown type."));e(r)},a.onabort=e=>t(new Error("Aborted")),a.onerror=e=>t(new Error(e.type));let r=this.file.slice(this.offset,n);a.readAsArrayBuffer(r)}this.offset=n}),done:!1}}};function QE(e){return"string"==typeof e&&"file://"===e.slice(0,7)}var eA=class extends GE{constructor(e,t={}){super(),this.input=e,this.options=t}async iterator(){if(QE(this.input)&&Pt().get("IS_NODE")){let e=Re();this.input=e.readFileSync(this.input.slice(7))}return new JE(this.input,this.options)}},tA=class extends GE{constructor(e,t={}){super(),this.url=e,this.fileOptions=t}async iterator(){return QE(this.url)?new eA(this.url,this.fileOptions).iterator():async function(e,t={}){let n,a;"string"==typeof e?n=e:(n=e.url,a=(e=>({method:e.method,headers:e.headers,body:e.body,mode:e.mode,credentials:e.credentials,cache:e.cache,redirect:e.redirect,referrer:e.referrer,integrity:e.integrity}))(e));let r=await(0,Ns.fetch)(n,a);if(r.ok){let e=new Uint8Array(await r.arrayBuffer());return new JE(e,t)}throw new Error(r.statusText)}(this.url,this.fileOptions)}};function nA(e,t={}){return new WE(new tA(e),t)}function aA(e){let t=dE(e);return AE(async()=>t)}function rA(e){return AE(async()=>{let t=await e();return dE(()=>t.next())})}async function sA(e,t){return UE.create(e,t)}async function iA(e){return VE.create(e)}var oA="4.22.0";function lA(e,t){Array.isArray(e)||(e=[e]),e.forEach(e=>{null!=e&&Ns.assert("complex64"!==e.dtype,()=>`${t} does not support complex64 tensors in the CPU backend.`)})}var uA=Yg.whereImpl,dA=class e extends Be{nextDataId(){return e.nextDataId++}constructor(){super(),this.blockSize=48,this.firstUse=!0,this.data=new Pe(this,Ji())}write(e,t,n){this.firstUse&&(this.firstUse=!1,Pt().get("IS_NODE")&&Uf.warn("\n============================\nHi, looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, visit https://github.com/tensorflow/tfjs-node for more details. \n============================"));let a={id:this.nextDataId()};return this.data.set(a,{values:e,dtype:n,refCount:1}),a}makeTensorInfo(e,t,n){let a;if("string"===t&&null!=n&&n.length>0&&Ns.isString(n[0])){let r=n.map(e=>Ns.encodeString(e));a=this.write(r,e,t)}else a=this.write(n,e,t);return{dataId:a,shape:e,dtype:t}}refCount(e){return this.data.has(e)?this.data.get(e).refCount:0}incRef(e){this.data.get(e).refCount++}decRef(e){this.data.has(e)&&this.data.get(e).refCount--}move(e,t,n,a,r){this.data.set(e,{values:t,dtype:a,refCount:r})}numDataIds(){return this.data.numDataIds()}async read(e){return this.readSync(e)}readSync(e){let{dtype:t,complexTensorInfos:n}=this.data.get(e);if("complex64"===t){let e=this.readSync(n.real.dataId),t=this.readSync(n.imag.dataId);return Uf.mergeRealAndImagArrays(e,t)}return Ns.convertBackendValuesAndArrayBuffer(this.data.get(e).values,t)}bufferSync(e){let t=this.readSync(e.dataId);if("string"===e.dtype)try{let n=t.map(e=>Ns.decodeString(e));return cl(e.shape,e.dtype,n)}catch(n){throw new Error("Failed to decode encoded string bytes into utf-8")}return cl(e.shape,e.dtype,t)}makeOutput(e,t,n){return Ji().makeTensorFromTensorInfo(this.makeTensorInfo(t,n,e),this)}disposeData(e,t=!1){if(this.data.has(e)){if(this.data.get(e).refCount--,!t&&this.data.get(e).refCount>0)return!1;let{complexTensorInfos:n}=this.data.get(e);null!=n&&(this.disposeData(n.real.dataId,!0),this.disposeData(n.imag.dataId,!0)),this.data.delete(e)}return!0}disposeIntermediateTensorInfo(e){this.disposeData(e.dataId)}async time(e){let t=Ns.now();return e(),{kernelMs:Ns.now()-t}}memory(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}}where(e){lA([e],"where");let t=this.readSync(e.dataId);return uA(e.shape,t)}dispose(){}floatPrecision(){return 32}epsilon(){return super.epsilon()}};dA.nextDataId=0;var cA={};function pA(e){let t=new Float32Array(e.length);for(let n=0;n<e.length;++n)t[n]=Math.abs(e[n]);return t}xe(cA,{addImpl:()=>CA,bincountImpl:()=>$A,bincountReduceImpl:()=>RA,bitwiseAndImpl:()=>FA,castImpl:()=>kA,ceilImpl:()=>zA,concatImpl:()=>WA,equalImpl:()=>VA,expImpl:()=>HA,expm1Impl:()=>XA,floorDivImpl:()=>t$,floorImpl:()=>JA,gatherNdImpl:()=>r$,gatherV2Impl:()=>s$,greaterEqualImpl:()=>u$,greaterImpl:()=>i$,lessEqualImpl:()=>f$,lessImpl:()=>p$,linSpaceImpl:()=>b$,logImpl:()=>y$,maxImpl:()=>k$,maximumImpl:()=>N$,minimumImpl:()=>_$,multiplyImpl:()=>E$,negImpl:()=>F$,notEqualImpl:()=>M$,prodImpl:()=>B$,raggedGatherImpl:()=>U$,raggedRangeImpl:()=>H$,raggedTensorToTensorImpl:()=>Z$,rangeImpl:()=>J$,rsqrtImpl:()=>Q$,scatterImpl:()=>nR,sigmoidImpl:()=>aR,simpleAbsImpl:()=>pA,sliceImpl:()=>iR,sparseFillEmptyRowsImpl:()=>uR,sparseReshapeImpl:()=>dR,sparseSegmentReductionImpl:()=>cR,sqrtImpl:()=>pR,squaredDifferenceImpl:()=>fR,staticRegexReplaceImpl:()=>bR,stridedSliceImpl:()=>vR,stringNGramsImpl:()=>NR,stringSplitImpl:()=>IR,stringToHashBucketFastImpl:()=>_R,subImpl:()=>CR,tileImpl:()=>$R,topKImpl:()=>DR,transposeImpl:()=>L$,uniqueImpl:()=>MR});var hA={kernelName:Gt,backendName:"cpu",kernelFunc:e=>{let{x:t}=e.inputs,n=e.backend;lA(t,"abs");let a=new Float32Array(Ns.sizeFromShape(t.shape));return a=pA(n.data.get(t.dataId).values),n.makeOutput(a,t.shape,t.dtype)}};function mA(e){return(t,n,a,r,s)=>{let i=Uf.assertAndGetBroadcastShape(t,n),o=i.length,l=Ns.computeStrides(i),u=Ns.sizeFromShape(i),d=Ns.getTypedArrayFromDType(s,u),c=t.length,p=n.length,h=Ns.computeStrides(t),m=Ns.computeStrides(n),f=Uf.getBroadcastDims(t,i),g=Uf.getBroadcastDims(n,i);if(f.length+g.length===0)for(let x=0;x<d.length;++x)d[x]=e(a[x%a.length],r[x%r.length]);else for(let x=0;x<d.length;++x){let t=Ns.indexToLoc(x,o,l),n=t.slice(-c);f.forEach(e=>n[e]=0);let s=Ns.locToIndex(n,c,h),i=t.slice(-p);g.forEach(e=>i[e]=0);let u=Ns.locToIndex(i,p,m);d[x]=e(a[s],r[u])}return[d,i]}}function fA(e){let{inputs:t,backend:n}=e,{real:a,imag:r}=t,s=n.data.get(a.dataId).values,i=n.data.get(r.dataId).values,o=n.makeTensorInfo(a.shape,"complex64");return n.data.get(o.dataId).complexTensorInfos={real:n.makeTensorInfo(a.shape,"float32",s),imag:n.makeTensorInfo(r.shape,"float32",i)},o}var gA={kernelName:yn,backendName:"cpu",kernelFunc:fA};function xA(e,t,n="float32"){if("complex64"===n)return fA({inputs:{real:xA(e,t,"float32"),imag:xA(e,t,"float32")},backend:e});let a=Ns.makeZerosTypedArray(Ns.sizeFromShape(t),n);return e.makeTensorInfo(t,n,a)}function bA(e){let{inputs:t,backend:n}=e,{x:a}=t;return n.incRef(a.dataId),{dataId:a.dataId,shape:a.shape,dtype:a.dtype}}var yA={kernelName:la,backendName:"cpu",kernelFunc:bA};function wA(e){let{inputs:t,backend:n}=e,{input:a}=t,r=n.data.get(a.dataId).complexTensorInfos.real,s=n.data.get(r.dataId).values;return n.makeTensorInfo(r.shape,r.dtype,s)}var vA={kernelName:ir,backendName:"cpu",kernelFunc:wA};function kA(e,t,n,a){if("int32"===a)return[t,"int32",Int32Array.from(e)];if("bool"===a){let a=Ns.toTypedArray([0],n),[r,s]=mA((e,t)=>e!==t?1:0)(t,[],e,a,"bool");return[s,"bool",r]}throw new Error(`Error in Cast: failed to cast ${n} to ${a}`)}function NA(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{dtype:s}=a;if("complex64"===s){if("complex64"===r.dtype)return bA({inputs:{x:r},backend:n});let e=xA(n,r.shape,r.dtype),t=NA({inputs:{x:r},backend:n,attrs:{dtype:"float32"}}),a=fA({inputs:{real:t,imag:e},backend:n});return n.disposeIntermediateTensorInfo(e),n.disposeIntermediateTensorInfo(t),a}if("complex64"===r.dtype){let e=wA({inputs:{input:r},backend:n}),t=NA({inputs:{x:e},backend:n,attrs:{dtype:s}});return n.disposeIntermediateTensorInfo(e),t}if(!Ns.hasEncodingLoss(r.dtype,s)){let e=bA({inputs:{x:r},backend:n});return{dataId:e.dataId,shape:e.shape,dtype:s}}let i=n.data.get(r.dataId).values,[o,l,u]=kA(i,r.shape,r.dtype,s);return n.makeTensorInfo(o,l,u)}var SA={kernelName:gn,backendName:"cpu",kernelFunc:NA};function IA(e,t,n,a){return null==n?({inputs:n,backend:r})=>{let{a:s,b:i}=n,o=r;lA([s,i],e);let l=o.data.get(s.dataId).values,u=o.data.get(i.dataId).values,d="string"===s.dtype?Uf.fromUint8ToStringArray(l):l,c="string"===s.dtype?Uf.fromUint8ToStringArray(u):u,p=a||s.dtype,[h,m]=t(s.shape,i.shape,d,c,p);return o.makeTensorInfo(m,p,h)}:({inputs:e,backend:r})=>{let{a:s,b:i}=e,o=r;if("complex64"===s.dtype||"complex64"===i.dtype){let e=NA({inputs:{x:s},backend:o,attrs:{dtype:"complex64"}}),t=o.data.get(e.dataId),a=t.complexTensorInfos.real,r=t.complexTensorInfos.imag,l=o.data.get(a.dataId).values,u=o.data.get(r.dataId).values,d=NA({inputs:{x:i},backend:o,attrs:{dtype:"complex64"}}),c=o.data.get(d.dataId),p=c.complexTensorInfos.real,h=c.complexTensorInfos.imag,m=o.data.get(p.dataId).values,f=o.data.get(h.dataId).values,[g,x,b]=n(s.shape,i.shape,l,u,m,f),y=o.makeTensorInfo(b,"float32",g),w=o.makeTensorInfo(b,"float32",x),v=fA({inputs:{real:y,imag:w},backend:o});return o.disposeIntermediateTensorInfo(e),o.disposeIntermediateTensorInfo(d),o.disposeIntermediateTensorInfo(y),o.disposeIntermediateTensorInfo(w),v}{let e=o.data.get(s.dataId).values,n=o.data.get(i.dataId).values,r=a||s.dtype,[l,u]=t(s.shape,i.shape,e,n,r);return o.makeTensorInfo(u,r,l)}}}function _A(e){return(t,n,a,r,s,i)=>{let o=Uf.assertAndGetBroadcastShape(t,n),l=Ns.sizeFromShape(o),u=o.length,d=Ns.computeStrides(o),c=Ns.getTypedArrayFromDType("float32",l),p=Ns.getTypedArrayFromDType("float32",l),h=Uf.getBroadcastDims(t,o),m=Uf.getBroadcastDims(n,o),f=Uf.mergeRealAndImagArrays(a,r),g=Uf.mergeRealAndImagArrays(s,i),x=t.length,b=Ns.computeStrides(t),y=n.length,w=Ns.computeStrides(n);if(h.length+m.length===0)for(let v=0;v<c.length;v++){let t=v%f.length,n=v%g.length,a=e(f[2*t],f[2*t+1],g[2*n],g[2*n+1]);c[v]=a.real,p[v]=a.imag}else for(let v=0;v<c.length;v++){let t=Ns.indexToLoc(v,u,d),n=t.slice(-x);h.forEach(e=>n[e]=0);let a=Ns.locToIndex(n,x,b),r=t.slice(-y);m.forEach(e=>r[e]=0);let s=Ns.locToIndex(r,y,w),i=e(f[2*a],f[2*a+1],g[2*s],g[2*s+1]);c[v]=i.real,p[v]=i.imag}return[c,p,o]}}var CA=mA((e,t)=>e+t),TA=_A((e,t,n,a)=>({real:e+n,imag:t+a})),EA=IA(Kt,CA,TA),AA={kernelName:Kt,backendName:"cpu",kernelFunc:EA};function $A(e,t,n,a,r){let s=Ns.sizeFromShape(a),i=Ns.makeZerosTypedArray(r,n);for(let o=0;o<e.length;o++){let n=e[o];if(n<0)throw new Error("Input x must be non-negative!");n>=r||(i[n]+=s>0?t[o]:1)}return i}function RA(e,t,n,a=!1){let r=e.shape[0],s=e.shape[1],i=cl([r,n],t.dtype);for(let o=0;o<r;o++)for(let r=0;r<s;r++){let s=e.get(o,r);if(s<0)throw new Error("Input x must be non-negative!");s>=n||(a?i.set(1,o,s):t.size>0?i.set(i.get(o,s)+t.get(o,r),o,s):i.set(i.get(o,s)+1,o,s))}return i}var FA=mA((e,t)=>e&t),DA=IA(hn,FA),MA={kernelName:hn,backendName:"cpu",kernelFunc:DA};function OA(e){return(t,n,a)=>{let r=Ns.getArrayFromDType(n,t.length);for(let s=0;s<t.length;++s)r[s]=e(t[s],a);return r}}function jA(e,t,n){return LA(e,OA(t),n)}function LA(e,t,n){return({inputs:a,attrs:r,backend:s})=>{let{x:i}=a;lA(i,e);let o,l=s,u=l.data.get(i.dataId).values;if("string"===i.dtype){if(!Array.isArray(u))throw new Error("String tensor's value was not an instance of Array");o=Uf.fromUint8ToStringArray(u)}else o=u;let d=n||i.dtype,c=t(o,d,r);return l.makeTensorInfo(i.shape,d,c)}}var zA=OA(e=>Math.ceil(e)),PA=LA(xn,zA),BA={kernelName:xn,backendName:"cpu",kernelFunc:PA};function WA(e,t,n,a){let r=Ns.getArrayFromDType(n,Ns.sizeFromShape(t));if(a&&"string"!==n){let t=0;e.forEach(e=>{let n=Ns.sizeFromShape(e.shape);r.set(e.vals,t),t+=n})}else{let a=0;e.forEach(e=>{let s="string"===n?Uf.fromUint8ToStringArray(e.vals):e.vals,i=0;for(let n=0;n<e.shape[0];++n){let o=n*t[1]+a;for(let t=0;t<e.shape[1];++t)r[o+t]=s[i++]}a+=e.shape[1]})}return r}var VA=mA((e,t)=>e===t?1:0),UA=IA(Kn,VA,null,"bool"),GA={kernelName:Kn,backendName:"cpu",kernelFunc:UA},HA=OA(e=>Math.exp(e)),qA=LA(Xn,HA,"float32"),KA={kernelName:Xn,backendName:"cpu",kernelFunc:qA},XA=OA(e=>Math.expm1(e)),YA=LA(Zn,XA),ZA={kernelName:Zn,backendName:"cpu",kernelFunc:YA},JA=OA(e=>Math.floor(e)),QA=LA(ta,JA),e$={kernelName:ta,backendName:"cpu",kernelFunc:QA},t$=mA((e,t)=>Math.floor(e/t)),n$=IA(na,t$,null,"int32"),a$={kernelName:na,backendName:"cpu",kernelFunc:n$};function r$(e,t,n,a,r,s,i,o,l){let u=cl([a,s],n);for(let d=0;d<a;d++){let n=[],a=0;for(let t=0;t<r;t++){let s=e[d*r+t];a+=s*i[t],n.push(s)}if(a<0||a>=l/s)throw new Error(`Invalid indices: ${n} does not index into ${o}`);for(let e=0;e<s;e++)u.values[d*s+e]=t.get(...t.indexToLoc(a*s+e))}return u}function s$(e,t,n){let a=cl(n,e.dtype);for(let r=0;r<a.size;++r){let n=a.indexToLoc(r).slice(),s=n[0],i=n[2],o=t.locToIndex([s,i]);n[2]=t.values[o];let l=e.locToIndex(n);0<=l&&l<e.values.length&&(a.values[r]=e.values[l])}return a}var i$=mA((e,t)=>e>t?1:0),o$=IA(ia,i$,null,"bool"),l$={kernelName:ia,backendName:"cpu",kernelFunc:o$},u$=mA((e,t)=>e>=t?1:0),d$=IA(oa,u$,null,"bool"),c$={kernelName:oa,backendName:"cpu",kernelFunc:d$},p$=mA((e,t)=>e<t?1:0),h$=IA(fa,p$,null,"bool"),m$={kernelName:fa,backendName:"cpu",kernelFunc:h$},f$=mA((e,t)=>e<=t?1:0),g$=IA(ga,f$,null,"bool"),x$={kernelName:ga,backendName:"cpu",kernelFunc:g$};function b$(e,t,n){let a=(t-e)/(n-1),r=Ns.makeZerosTypedArray(n,"float32");r[0]=e;for(let s=1;s<r.length;s++)r[s]=r[s-1]+a;return r}var y$=OA(e=>Math.log(e)),w$=LA(ba,y$),v$={kernelName:ba,backendName:"cpu",kernelFunc:w$};function k$(e,t,n,a){let r=Ns.getTypedArrayFromDType(a,Ns.sizeFromShape(n));for(let s=0;s<r.length;++s){let n=s*t,a=e[n];for(let r=0;r<t;++r){let t=e[n+r];(Number.isNaN(t)||t>a)&&(a=t)}r[s]=a}return r}var N$=mA((e,t)=>Math.max(e,t)),S$=IA(Aa,N$),I$={kernelName:Aa,backendName:"cpu",kernelFunc:S$},_$=mA((e,t)=>Math.min(e,t)),C$=IA(La,_$),T$={kernelName:La,backendName:"cpu",kernelFunc:C$},E$=mA((e,t)=>e*t),A$=_A((e,t,n,a)=>({real:e*n-t*a,imag:e*a+t*n})),$$=IA(Wa,E$,A$),R$={kernelName:Wa,backendName:"cpu",kernelFunc:$$};function F$(e,t,n){let a=Ns.createScalarValue(-1,n);return E$([],t,a,e,n)}var D$={kernelName:Va,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{x:a}=t;lA(a,"neg");let r=n.data.get(a.dataId).values,[s,i]=F$(r,a.shape,a.dtype);return n.makeTensorInfo(i,a.dtype,s)}},M$=mA((e,t)=>e!==t?1:0),O$=IA(Ua,M$,null,"bool"),j$={kernelName:Ua,backendName:"cpu",kernelFunc:O$};function L$(e,t,n,a,r){let s=t.length,i=Ns.sizeFromShape(t),o=Ns.computeStrides(t),l=Ns.computeStrides(r),u=Ns.getTypedArrayFromDType(n,Ns.sizeFromShape(r));for(let d=0;d<i;++d){let t=Ns.indexToLoc(d,s,o),n=new Array(t.length);for(let e=0;e<n.length;e++)n[e]=t[a[e]];u[Ns.locToIndex(n,s,l)]=e[d]}return u}function z$(e){let{inputs:t,attrs:n,backend:a}=e,{x:r}=t,{perm:s}=n;lA(r,"transpose");let i=r.shape.length,o=new Array(i);for(let u=0;u<o.length;u++)o[u]=r.shape[s[u]];let l=L$(a.data.get(r.dataId).values,r.shape,r.dtype,s,o);return{dataId:a.write(l,o,r.dtype),shape:o,dtype:r.dtype}}var P$={kernelName:Jr,backendName:"cpu",kernelFunc:z$};function B$(e,t,n,a){let[r,s]=Uf.computeOutAndReduceShapes(e,a),i=mi(t,"int32"),o=Ns.makeZerosTypedArray(Ns.sizeFromShape(r),i),l=Ns.sizeFromShape(s);for(let u=0;u<o.length;++u){let e=u*l,t=1;for(let a=0;a<l;++a)t*=n[e+a];o[u]=t}return{outVals:o,outShape:r,outDtype:i}}var W$={kernelName:tr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,keepDims:i}=a;lA(r,"prod");let o=r.shape.length,l=Ns.parseAxisParam(s,r.shape),u=Uf.getAxesPermutation(l,o),d=l,c=r,p=[];null!=u&&(c=z$({inputs:{x:r},backend:n,attrs:{perm:u}}),p.push(c),d=Uf.getInnerMostAxes(d.length,o));let h=n.data.get(c.dataId).values,{outVals:m,outShape:f,outDtype:g}=B$(c.shape,c.dtype,h,d),x=f;return i&&(x=Uf.expandShapeToKeepDim(f,l)),p.forEach(e=>n.disposeIntermediateTensorInfo(e)),n.makeTensorInfo(x,g,m)}};function V$(e,t){let n=e.slice(0,t);for(;n.length<t;)n.push(1);for(let a=t;a<e.length;a++)n[t-1]*=e[a];return n}function U$(e,t,n,a,r,s,i,o){if(0===e.length)throw new Error("paramsNestedSplits must be non empty");if(0===t[0].length)throw new Error("Split tensors must not be scalars");if(function(e,t,n){e.forEach((e,a)=>{if(e<0||e>=n){let r=Ns.indexToLoc(a,t.length,Ns.computeStrides(t)).join(",");throw new Error(`indices[${r}] = ${e} is not in [0, ${n})`)}})}(s,i,t[0][0]-1),0===a.length)throw new Error("params.rank must be nonzero");let l=a[0],{outSplits:u,valueSlices:d,numValues:c}=function(e,t,n,a){let r=[],s=0,i=t.length-1+n.length,o=new Array(i).fill(null).map(()=>[0]);!function(e,t){for(let n=0;n<e.length;++n){let a=e[n],r=n===e.length-1?t:e[n+1].length;if(0===a.length)throw new Error("Ragged splits may not be empty");if(a[0]<0)throw new Error("Ragged splits must be non-negative");if(a[a.length-1]>r)throw new Error("Ragged splits must not point past values");for(let e=1;e<a.length;++e)if(a[e-1]>a[e])throw new Error("Ragged splits must be sorted in ascending order")}}(n,a);let l=1;for(let u=0;u<t.length-1;++u){l*=t[u];let e=t[u+1];for(let t=1;t<l+1;++t)o[u].push(t*e)}for(let u=0;u<e.length;++u){let a=e[u],i=e[u]+1;for(let e=0;e<n.length;++e){let r=n[e],s=e+t.length-1;if(s>=0){let e=o[s],t=e[e.length-1]-r[a];for(let n=a;n<i;++n)o[s].push(r[n+1]+t)}a=r[a],i=r[i]}i!==a&&(r.push([a,i]),s+=i-a)}return{outSplits:o,valueSlices:r,numValues:s}}(s,i,e,l),p=function(e){let t=[];for(let n=0;n<e.length;++n){let a=e[n].length,r=Ns.getArrayFromDType("int32",a);t.push(r),e[n].forEach((e,t)=>r[t]=e)}return t}(u),h=function(e,t,n,a,r){let s=t.slice();s[0]=r;let i=Ns.getArrayFromDType(n,Ns.sizeFromShape(s)),o=e.length;return function(e,t,n,a,r,s){let i=V$(t,2)[1],o=V$(s,2)[1],l=0;for(let u of n)for(let t=u[0];t<u[1];++t){for(let n=0;n<a;++n)r[l*o+n]=e[t*i+n];++l}}(e,t,a,0===o?0:o/t[0],i,s),[i,s]}(n,a,r,d,c);return[p,h[0],h[1]]}var G$=2147483647;function H$(e,t,n,a,r,s,i){if(t.length>1)throw new Error("starts must be a scalar or vector");if(r.length>1)throw new Error("limits must be a scalar or vector");if(i.length>1)throw new Error("deltas must be a scalar or vector");let o=0===t.length,l=0===r.length,u=0===i.length,d=[];o||d.push(t[0]),l||d.push(r[0]),u||d.push(i[0]);for(let g=1;g<d.length;++g)if(d[g]!==d[g-1])throw new Error("starts, limits, and deltas must have the same shape");let c=0===d.length?1:d[0],p=Ns.getArrayFromDType("int32",c+1);p[0]=0;for(let g=0;g<c;++g){let t,n=o?e[0]:e[g],r=l?a[0]:a[g],i=u?s[0]:s[g];if(0===i)throw new Error("Requires delta != 0");if(i>0&&r<n||i<0&&r>n)t=0;else if(t=Math.ceil(Math.abs((r-n)/i)),t>G$)throw new Error(`Requires ((limit - start) / delta) <= ${G$}`);p[g+1]=p[g]+t}let h=p[c],m=Ns.getArrayFromDType(n,h),f=0;for(let g=0;g<c;++g){let t=p[g+1]-p[g],n=o?e[0]:e[g],a=u?s[0]:s[g];for(let e=0;e<t;++e)m[f++]=n,n+=a}return[p,m]}var q$=Uf.RowPartitionType,K$=class e{constructor(e,t,n,a,r,s,i,o,l,u){this.shape=e,this.shapeShape=t,this.values=n,this.valuesShape=a,this.valuesDType=r,this.defaultValue=s,this.defaultValueShape=i,this.rowPartitionValues=o,this.rowPartitionValuesShapes=l,this.rowPartitionTypes=Uf.getRowPartitionTypesHelper(u),this.raggedRank=Uf.getRaggedRank(this.rowPartitionTypes)}getRowPartitionTypeByDimension(e){return this.rowPartitionTypes[0]===q$.FIRST_DIM_SIZE?this.rowPartitionTypes[e+1]:this.rowPartitionTypes[e]}getRowPartitionTensor(e){return this.rowPartitionTypes[0]===q$.FIRST_DIM_SIZE?this.rowPartitionValues[e+1]:this.rowPartitionValues[e]}getMaxWidth(t){let n=this.getRowPartitionTensor(t-1);switch(this.getRowPartitionTypeByDimension(t-1)){case q$.VALUE_ROWIDS:return e.getMaxWidthValueRowID(n);case q$.ROW_SPLITS:return e.getMaxWidthRowSplit(n);default:throw new Error(`Cannot handle partition type ${q$[this.getRowPartitionTypeByDimension(t-1)]}`)}}static getMaxWidthRowSplit(e){let t=e.length;if(0===t||1===t)return 0;let n=0;for(let a=0;a<t-1;++a){let t=e[a+1]-e[a];t>n&&(n=t)}return n}static getMaxWidthValueRowID(e){let t=e.length;if(0===t)return 0;let n=0,a=e[0],r=0;for(let s=1;s<t;++s){let t=e[s];t!==a&&(a=t,r=Math.max(s-n,r),n=s)}return Math.max(t-n,r)}tensorShapeFromTensor(e,t,n=!0){if(0===t.length){if(-1===e[0])return[];throw new Error("The only valid scalar shape tensor is the fully unknown shape specified as -1.")}return Y$(e,n)}calculateOutputSize(e){let t=this.valuesShape,n=this.defaultValueShape;Uf.validateDefaultValueShape(n,t);let a=this.tensorShapeFromTensor(this.shape,this.shapeShape),r=Uf.combineRaggedTensorToTensorShapes(this.raggedRank,a,t);r[0]<0&&(r[0]=e);for(let s=1;s<=this.raggedRank;++s)r[s]<0&&(r[s]=this.getMaxWidth(s));return r}calculateFirstParentOutputIndex(e,t,n){let a=Math.min(e,n),r=[],s=0;for(let i=0;i<a;++i,s+=t)r.push(s);for(let i=a;i<e;++i)r.push(-1);return Ns.assert(r.length===e,()=>"Final length of result must be equal to firstDimension."),r}calculateOutputIndexRowSplit(e,t,n,a){let r=e.length,s=[];for(let i=0;i<r-1;++i){let r=e[i+1]-e[i],o=Math.min(a,r),l=t[i];-1===l&&(o=0);for(let e=0;e<o;++e)s.push(l),l+=n;for(let e=0;e<r-o;++e)s.push(-1)}if(r>0&&s.length!==e[r-1])throw new Error("Invalid row split size.");return s}calculateOutputIndexValueRowID(e,t,n,a){let r=e.length,s=[];if(0===r)return[];let i=0,o=e[0];if(o>=t.length)throw new Error(`Got currentValueRowId=${o}, which is not less than ${t.length}`);let l=t[o];s.push(l);for(let u=1;u<r;++u){let r=e[u];if(r===o)l>=0&&(++i,i<a?l+=n:l=-1);else{if(i=0,o=r,r>=t.length)throw new Error(`Got nextValueRowId=${r} which is not less than ${t.length}`);l=t[r]}s.push(l)}if(s.length!==e.length)throw new Error("Invalid row ids.");return s}calculateOutputIndex(e,t,n,a){let r=this.getRowPartitionTensor(e),s=this.getRowPartitionTypeByDimension(e);switch(s){case q$.VALUE_ROWIDS:return this.calculateOutputIndexValueRowID(r,t,n,a);case q$.ROW_SPLITS:if(r.length-1>t.length)throw new Error(`Row partition size is greater than output size: ${r.length-1} > ${t.length}`);return this.calculateOutputIndexRowSplit(r,t,n,a);default:throw new Error(`Unsupported partition type: ${q$[s]}`)}}getFirstDimensionSize(){let e=this.rowPartitionValues[0];if(0===this.rowPartitionTypes.length)throw new Error("No row_partition_types given.");let t=this.rowPartitionTypes[0];switch(t){case q$.FIRST_DIM_SIZE:return e[0];case q$.VALUE_ROWIDS:throw new Error("Cannot handle VALUE_ROWIDS in first dimension.");case q$.ROW_SPLITS:return this.rowPartitionValuesShapes[0][0]-1;default:throw new Error(`Cannot handle type ${q$[t]}`)}}compute(){if(this.rowPartitionValues[0].length<=0)throw new Error("Invalid first partition input. Tensor requires at least one element.");let e=this.getFirstDimensionSize(),t=this.calculateOutputSize(e),n=new Array(this.raggedRank+1);n[n.length-1]=1;for(let s=n.length-2;s>=0;--s)n[s]=n[s+1]*t[s+1];let a=Y$(t,!1),r=Ns.getArrayFromDType(this.valuesDType,Ns.sizeFromShape(a));if(n[0]*t[0]>0){let s=this.calculateFirstParentOutputIndex(e,n[0],t[0]);for(let e=1;e<=this.raggedRank;++e)s=this.calculateOutputIndex(e-1,s,n[e],t[e]);this.setOutput(this.raggedRank,s,r,a)}return[a,r]}setOutput(e,t,n,a){if(0===n.length)return;let r=this.values,s=n,i=a.slice();i=i.slice(e+1);let o=Ns.sizeFromShape(i),l=t.length,u=this.defaultValue;if(u.length!==o&&1!==u.length){let e=this.defaultValueShape;to(()=>{let t=ql(u,e);u=cu(t,i).dataSync()})}let d=0,c=0,p=0;for(let h=0;h<=l;++h){let e=h<l?t[h]:-1;if(e!==p){if(c<p){let e=r.subarray(d*o);X$(s.subarray(c*o),e,(p-c)*o)}if(h>=l){let t=n.length;e=Math.floor(t/o)}if(e>p)if(1===this.defaultValue.length)s.subarray(p*o,e*o).fill(this.defaultValue[0]),p=e;else for(;e>p;)X$(s.slice(p*o),u,o),++p;e<0?(d=h+1,c=p):(d=h,c=p,p=c+1)}else++p}}};function X$(e,t,n){for(let a=0;a<n;a++)e[a]=t[a]}function Y$(e,t){let n=[];for(let a of e){if(a<0){if(!t)throw new Error(`Dimension ${a} must be >= 0`);if(a<-1)throw new Error(`Dimension ${a} must be >= -1`);a=-1}n.push(a)}return n}function Z$(e,t,n,a,r,s,i,o,l,u){return new K$(e,t,n,a,r,s,i,o,l,u).compute()}function J$(e,t,n,a){if(e===t||e<t&&n<0||t<e&&n>1)return Ns.makeZerosTypedArray(0,a);let r=Math.abs(Math.ceil((t-e)/n)),s=Ns.makeZerosTypedArray(r,a);t<e&&1===n&&(n=-1),s[0]=e;for(let i=1;i<s.length;i++)s[i]=s[i-1]+n;return s}var Q$=OA(e=>1/Math.sqrt(e)),eR=LA(xr,Q$),tR={kernelName:xr,backendName:"cpu",kernelFunc:eR};function nR(e,t,n,a,r,s,i,o,l,u){let d=[a/r,r],c=e.values,p=t.values;if(0===a)return cl(n,t.dtype);let h=l instanceof ti?l:cl(d,t.dtype);"string"==typeof l||"number"==typeof l?h.values.fill(l):"boolean"==typeof l&&h.values.fill(+l);for(let m=0;m<s;m++){let e=[],s=0;for(let t=0;t<i;t++){let n=c[m*i+t];e.push(n),s+=n*o[t]}if(s<0||s>=a/r)throw new Error(`Invalid indices: ${e} does not index into ${n}`);for(let n=0;n<r;n++)u?h.values[s*r+n]+=p[m*r+n]:h.values[s*r+n]=0===t.rank?p[0]:p[m*r+n]}return h}var aR=OA(e=>1/(1+Math.exp(-e))),rR=jA(Cr,e=>1/(1+Math.exp(-e))),sR={kernelName:Cr,backendName:"cpu",kernelFunc:rR};function iR(e,t,n,a,r){let s=bf.isSliceContinous(a,t,n),i=Ns.sizeFromShape(n),o=Ns.computeStrides(a);if(s){let n=bf.computeFlatOffset(t,o);return"string"===r?e.slice(n,n+i):e.subarray(n,n+i)}let l=cl(a,r,"string"===r?Uf.fromUint8ToStringArray(e):e),u=cl(n,r);for(let d=0;d<u.size;++d){let e=u.indexToLoc(d),n=e.map((e,n)=>e+t[n]);u.set(l.get(...n),...e)}return"string"===r?Uf.fromStringArrayToUint8(u.values):u.values}function oR(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{begin:s,size:i}=a;lA(r,"slice");let[o,l]=bf.parseSliceParams(r,s,i);bf.assertParamsValid(r,o,l);let u=iR(n.data.get(r.dataId).values,o,l,r.shape,r.dtype);return n.makeTensorInfo(l,r.dtype,u)}var lR={kernelName:Nr,backendName:"cpu",kernelFunc:oR};function uR(e,t,n,a,r,s,i){let o=t[0],l=s[0],u=new Array(l),d=new Array(o),c=t[1];if(0===l){if(0!==o)throw new Error(Uf.getSparseFillEmptyRowsIndicesDenseShapeMismatch(o));return[Ns.getArrayFromDType(n,0),[0,c],Ns.getArrayFromDType(r,0),u,d]}let p=!0,h=0,m=new Array(l).fill(0);for(let g=0;g<o;++g){let t=e[g*c];if(t<0)throw new Error(Uf.getSparseFillEmptyRowsNegativeIndexErrorMessage(g,t));if(t>=l)throw new Error(Uf.getSparseFillEmptyRowsOutOfRangeIndexErrorMessage(g,t,l));++m[t],p=p&&t>=h,h=t}let f=!0;for(let g=0;g<l;++g){let e=0===m[g];u[g]=e,f=f&&!e,m[g]=Math.max(m[g],1),g>0&&(m[g]+=m[g-1])}if(f&&p){let t=e,n=a;for(let e=0;e<o;++e)d[e]=e;return[t,[o,c],n,u,d]}{let t=m[l-1],s=Ns.getArrayFromDType(n,t*c),p=Ns.getArrayFromDType(r,t),h=new Array(l).fill(0);for(let n=0;n<o;++n){let t=e[n*c],r=h[t],i=(0===t?0:m[t-1])+r;h[t]++;for(let a=0;a<c;++a)s[i*c+a]=e[n*c+a];p[i]=a[n],d[n]=i}for(let e=0;e<l;++e)if(0===h[e]){let t=0===e?0:m[e-1];s[t*c+0]=e;for(let e=1;e<c;++e)s[t*c+e]=0;p[t]=i}return[s,[t,c],p,u,d]}}function dR(e,t,n,a,r){let s=Ns.sizeFromShape(a),i=t[0],o=r.length,l=[],u=1,d=-1;for(let f=0;f<o;++f){let e=r[f];if(-1===e){if(-1!==d)throw new Error(Uf.getSparseReshapeMultipleNegativeOneOutputDimErrorMessage(d,f));d=f,l.push(1)}else{if(e<0)throw new Error(Uf.getSparseReshapeNegativeOutputDimErrorMessage(f,e));u*=e,l.push(e)}}if(-1!==d){if(u<=0)throw new Error(Uf.getSparseReshapeEmptyTensorZeroOutputDimErrorMessage());let e=Math.trunc(s/u);if(u*e!==s)throw new Error(Uf.getSparseReshapeInputOutputMultipleErrorMessage(a,l));l[d]=e}if(Ns.sizeFromShape(l)!==s)throw new Error(Uf.getSparseReshapeInputOutputMismatchErrorMessage(a,l));let c=a.length,p=[];if(c>0){p[c-1]=1;for(let e=c-2;e>=0;--e)p[e]=p[e+1]*a[e+1]}let h=[];if(o>0){h[o-1]=1;for(let e=o-2;e>=0;--e)h[e]=h[e+1]*l[e+1]}let m=Ns.getArrayFromDType(n,i*o);for(let f=0;f<i;++f){let t=0;for(let n=0;n<c;++n)t+=e[f*c+n]*p[n];for(let e=0;e<o;++e)m[f*o+e]=Math.trunc(t/h[e]),t%=h[e]}return[m,[i,o],l]}function cR(e,t,n,a,r,s=!1,i=0){let o=a.length,l=[t[0],e.length/t[0]],u=l[1],d=o>0?r[o-1]+1:0;if(d<0)throw new Error(Uf.getSparseSegmentReductionNegativeSegmentIdsErrorMessage());let c=t.slice();c[0]=d;let p=c.reduce((e,t)=>e*t,1),h=Ns.getArrayFromDType(n,p);if(0===o)return d>0&&h.fill(i),[h,c];if(d<=0)throw new Error(Uf.getSparseSegmentReductionNegativeSegmentIdsErrorMessage());let m=0,f=1,g=0,x=r[m];for(;;){let t=0;if(f<o){if(t=r[f],x===t){++f;continue}if(x>=t)throw new Error(Uf.getSparseSegmentReductionNonIncreasingSegmentIdsErrorMessage())}if(x<0||x>=d)throw new Error(Uf.getSparseSegmentReductionSegmentIdOutOfRangeErrorMessage(x,d));x>g&&h.fill(i,g*u,x*u);for(let n=m;n<f;++n){let t=a[n];if(t<0||t>=l[0])throw new Error(Uf.getSparseSegmentReductionIndicesOutOfRangeErrorMessage(n,a[n],l[0]));for(let n=0;n<u;n++)h[x*u+n]+=e[t*u+n]}if(s)for(let e=0;e<u;e++)h[x*u+e]/=f-m;if(m=f,++f,g=x+1,x=t,f>o)break}return g<d&&h.fill(i,g*u,d*u),[h,c]}var pR=OA(e=>Math.sqrt(e)),hR=jA(Er,e=>Math.sqrt(e)),mR={kernelName:Er,backendName:"cpu",kernelFunc:hR},fR=mA((e,t)=>{let n=e-t;return n*n}),gR=IA(zr,fR),xR={kernelName:zr,backendName:"cpu",kernelFunc:gR},bR=OA((e,t)=>{let{pattern:n,replaceGlobal:a,rewrite:r}=t;return e.replace(new RegExp(n,a?"g":""),r)}),yR=LA(Br,bR),wR={kernelName:Br,backendName:"cpu",kernelFunc:yR};function vR(e,t,n,a){let r=cl(e,t.dtype);for(let s=0;s<r.size;s++){let e=r.indexToLoc(s),i=new Array(e.length);for(let t=0;t<i.length;t++)i[t]=e[t]*n[t]+a[t];r.set(t.get(...i),...e)}return r}var kR=class{constructor(e,t,n,a,r,s){this.separator=Ns.encodeString(e),this.nGramWidths=t,this.leftPad=Ns.encodeString(n),this.rightPad=Ns.encodeString(a),this.padWidth=r,this.preserveShort=s}getPadWidth(e){return Math.min(this.padWidth<0?e-1:this.padWidth,e-1)}getNumNGrams(e,t){let n=this.getPadWidth(t);return Math.max(0,e+2*n-t+1)}createNGrams(e,t,n,a,r,s){for(let i=0;i<r;++i){let o=this.getPadWidth(s),l=Math.max(0,o-i),u=Math.max(0,o-(r-(i+1))),d=s-(l+u),c=t+(l>0?0:i-o),p=0;p+=l*this.leftPad.length;for(let t=0;t<d;++t)p+=e[c+t].length;p+=u*this.rightPad.length,p+=(l+u+d-1)*this.separator.length,n[a+i]=new Uint8Array(p);let h=n[a+i],m=0,f=e=>e.forEach(e=>h[m++]=e);for(let e=0;e<l;++e)f(this.leftPad),f(this.separator);for(let t=0;t<d-1;++t)f(e[c+t]),f(this.separator);if(d>0){f(e[c+d-1]);for(let e=0;e<u;++e)f(this.separator),f(this.rightPad)}else{for(let e=0;e<u-1;++e)f(this.rightPad),f(this.separator);f(this.rightPad)}}}compute(e,t){let n=e.length,a=t.length;if(a>0){let e=t[0];if(0!==e)throw new Error(`First split value must be 0, got ${e}`);for(let r=1;r<a;++r){let a=t[r]>=e;if(a=a&&t[r]<=n,!a)throw new Error(`Invalid split value ${t[r]}, must be in [${e}, ${n}]`);e=t[r]}if(e!==n)throw new Error(`Last split value must be data size. Expected ${n}, got ${e}`)}let r=a-1,s=Ns.getArrayFromDType("int32",a);if(0===n||0===a){let e=new Array(n);for(let t=0;t<=r;++t)s[t]=0;return[e,s]}s[0]=0;for(let o=1;o<=r;++o){let e=t[o]-t[o-1],n=0;this.nGramWidths.forEach(t=>{n+=this.getNumNGrams(e,t)}),this.preserveShort&&e>0&&0===n&&(n=1),s[o]=s[o-1]+n}let i=new Array(s[r]);for(let o=0;o<r;++o){let n=t[o],a=s[o];if(this.nGramWidths.forEach(r=>{let s=t[o+1]-t[o],l=this.getNumNGrams(s,r);this.createNGrams(e,n,i,a,l,r),a+=l}),this.preserveShort&&a===s[o]){let r=t[o+1]-t[o];if(0===r)continue;let s=r+2*this.padWidth;this.createNGrams(e,n,i,a,1,s)}}return[i,s]}};function NR(e,t,n,a,r,s,i,o){return new kR(n,a,r,s,i,o).compute(e,t)}function SR(e,t,n,a){if(!e.length)return;if(0===t.length){for(let t=0;t<e.length;++t)a.push(e.subarray(t,t+1));return}if(1===t.length){let r=t[0],s=e.indexOf(r);for(;-1!==s;){let t=e.subarray(0,s);(!n||0!==t.length)&&a.push(t),s=(e=e.subarray(s+1)).indexOf(r)}return void((!n||0!==e.length)&&a.push(e))}let r=0;for(let s=0;s<e.length+1;s++)if(s===e.length||-1!==t.indexOf(e[s])){let t=e.subarray(r,s);(!n||0!==t.length)&&a.push(t),r=s+1}}function IR(e,t,n){let a=e.length,r=[],s=0,i=0,o=new Array(a);for(let p=0;p<a;++p){let a=r.length;SR(e[p],t,n,r);let l=r.length-a;o[p]=l,s+=l,i=Math.max(i,l)}let l=Ns.getArrayFromDType("int32",2*s),u=new Array(s),d=[a,i],c=0;for(let p=0;p<a;++p)for(let e=0;e<o[p];++e)l[2*c]=p,l[2*c+1]=e,u[c]=r[c],++c;return[l,u,d]}function _R(e,t){let n=Ns.getArrayFromDType("int32",e.length);for(let a=0;a<e.length;++a)n[a]=Ns.fingerPrint64(e[a]).modulo(t).getLowBitsUnsigned();return n}var CR=mA((e,t)=>e-t),TR=_A((e,t,n,a)=>({real:e-n,imag:t-a})),ER=IA(Hr,CR,TR),AR={kernelName:Hr,backendName:"cpu",kernelFunc:ER};function $R(e,t){let n=new Array(e.rank);for(let r=0;r<n.length;r++)n[r]=e.shape[r]*t[r];let a=cl(n,e.dtype);for(let r=0;r<a.values.length;++r){let t=a.indexToLoc(r),n=new Array(e.rank);for(let a=0;a<n.length;a++)n[a]=t[a]%e.shape[a];let s=e.locToIndex(n);a.values[r]=e.values[s]}return a}var RR=(e,t)=>{let n=t.value-e.value;return 0===n?e.index-t.index:n};function FR(e,t,n=0,a=e.length-1){for(;a>n;){if(a-n>600){let r=a-n+1,s=t-n+1,i=Math.log(r),o=.5*Math.exp(2*i/3),l=.5*Math.sqrt(i*o*(r-o)/r)*Math.sign(s-r/2);FR(e,t,Math.max(n,Math.floor(t-s*o/r+l)),Math.min(a,Math.floor(t+(r-s)*o/r+l)))}let r=e[t],s=n,i=a;for(Ns.swap(e,n,t),RR(e[a],r)>0&&Ns.swap(e,n,a);s<i;){for(Ns.swap(e,s,i),s++,i--;RR(e[s],r)<0;)s+=1;for(;RR(e[i],r)>0;)i-=1}0===RR(e[n],r)?Ns.swap(e,n,i):(i+=1,Ns.swap(e,i,a)),i<=t&&(n=i+1),t<=i&&(a=i-1)}}function DR(e,t,n,a,r){let s=t[t.length-1],[i,o]=[e.length/s,s],l=Ns.getTypedArrayFromDType(n,i*a),u=Ns.getTypedArrayFromDType("int32",i*a);for(let c=0;c<i;c++){let t=c*o,n=e.subarray(t,t+o),s=new Array(n.length);n.forEach((e,t)=>s[t]={value:e,index:t}),a<s.length&&(FR(s,a),s=s.slice(0,a)),r&&s.sort(RR);let i=c*a,d=l.subarray(i,i+a),p=u.subarray(i,i+a);for(let e=0;e<a;e++)d[e]=s[e].value,p[e]=s[e].index}let d=t.slice();return d[d.length-1]=a,[cl(d,n,l),cl(d,"int32",u)]}function MR(e,t,n,a){let r=Ns.parseAxisParam(t,n)[0],s=[1,n[0],1];for(let m=0;m<r;m++)s[0]*=n[m];s[1]=n[r];for(let m=r+1;m<n.length;m++)s[2]*=n[m];let i=new Map,o=new Int32Array(n[r]),l=new ti(s,a,e),u=[],d=1===s[0]&&1===s[2];for(let m=0;m<n[r];m++){let t;if(d)t=e[m].toString();else{let e=[];for(let t=0;t<s[0];t++)for(let n=0;n<s[2];n++)e.push(l.get(t,m,n));t=e.join(",")}let n=i.get(t);if(null!=n)o[m]=n;else{let e=i.size;i.set(t,e),o[m]=e,u.push(m)}}let c=s.slice();c[1]=i.size;let p=new ti(c,a);u.forEach((e,t)=>{for(let n=0;n<s[0];n++)for(let a=0;a<s[2];a++)p.set(l.get(n,e,a),n,t,a)});let h=n.slice();return h[r]=c[1],{outputValues:p.values,outputShape:h,indices:o}}var OR="4.22.0";po("cpu",()=>new dA,1);var jR=jA(Gn,e=>e>=0?e:Math.exp(e)-1),LR={kernelName:Gn,backendName:"cpu",kernelFunc:jR};function zR(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{alpha:s}=a;lA([r],"leakyRelu");let i=Ns.sizeFromShape(r.shape),o=n.data.get(r.dataId).values,l=Ns.getTypedArrayFromDType("float32",i);for(let u=0;u<o.length;u++)l[u]=o[u]<0?s*o[u]:o[u];return n.makeTensorInfo(r.shape,"float32",l)}var PR={kernelName:ma,backendName:"cpu",kernelFunc:zR},BR=mA((e,t)=>e<0?t*e:e);function WR(e){let{inputs:t,backend:n}=e,{x:a,alpha:r}=t;lA([a,r],"prelu");let s=n.data.get(a.dataId).values,i=n.data.get(r.dataId).values,[o,l]=BR(a.shape,r.shape,s,i,"float32");return n.makeTensorInfo(l,"float32",o)}var VR={kernelName:er,backendName:"cpu",kernelFunc:WR},UR=jA(lr,e=>Math.max(0,e)),GR={kernelName:lr,backendName:"cpu",kernelFunc:UR},HR=jA(mr,e=>Math.min(Math.max(0,e),6)),qR={kernelName:mr,backendName:"cpu",kernelFunc:HR};function KR(e,t,n,a,r){if("linear"===n)return bA({inputs:{x:t},backend:e});if("relu"===n)return UR({inputs:{x:t},backend:e});if("elu"===n)return jR({inputs:{x:t},backend:e});if("relu6"===n)return HR({inputs:{x:t},backend:e});if("prelu"===n)return WR({inputs:{x:t,alpha:a},backend:e});if("leakyrelu"===n)return zR({inputs:{x:t},backend:e,attrs:{alpha:r}});if("sigmoid"===n)return rR({inputs:{x:t},backend:e});throw new Error(`Activation ${n} has not been implemented for the CPU backend.`)}function XR(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{shape:s}=a,i=Ns.sizeFromShape(r.shape),o=Ns.inferFromImplicitShape(s,i),l=Ns.sizeFromShape(o);Ns.assert(i===l,()=>`The new shape (${o}) has ${l} elements and the old shape (${r.shape}) has ${i} elements. The new shape and old shape must have the same number of elements.`),n.incRef(r.dataId);let u=n.data.get(r.dataId);if(null!=u.complexTensorInfos){let e=u.complexTensorInfos.real,t=u.complexTensorInfos.imag;e.shape=o,t.shape=o}return{dataId:r.dataId,shape:o,dtype:r.dtype}}var YR={kernelName:ur,backendName:"cpu",kernelFunc:XR};function ZR(e){let{inputs:t,backend:n,attrs:a}=e,{a:r,b:s}=t,{transposeA:i,transposeB:o}=a;lA([r,s],"matMul");let l=r.shape.length,u=s.shape.length,d=i?r.shape[l-2]:r.shape[l-1],c=o?s.shape[u-1]:s.shape[u-2],p=i?r.shape[l-1]:r.shape[l-2],h=o?s.shape[u-2]:s.shape[u-1],m=r.shape.slice(0,-2),f=s.shape.slice(0,-2),g=Ns.sizeFromShape(m),x=Ns.sizeFromShape(f),b=Mu.assertAndGetBroadcastShape(r.shape.slice(0,-2),s.shape.slice(0,-2)).concat([p,h]);Ns.assert(d===c,()=>`Error in matMul: inner shapes (${d}) and (${c}) of Tensors with shapes ${r.shape} and ${s.shape} and transposeA=${i} and transposeB=${o} must match.`);let y=o?[x,h,c]:[x,c,h],w=XR({inputs:{x:r},backend:n,attrs:{shape:i?[g,d,p]:[g,p,d]}}),v=XR({inputs:{x:s},backend:n,attrs:{shape:y}}),k=i?w.shape[1]:w.shape[2],N=i?w.shape[2]:w.shape[1],S=o?v.shape[1]:v.shape[2],I=Math.max(g,x),_=n.data.get(w.dataId).values,C=n.data.get(v.dataId).values,T=Ns.computeStrides(w.shape),E=Ns.computeStrides(v.shape),[A,$,R]=i?[T[0],1,T[1]]:[T[0],T[1],1],[F,D,M]=o?[1,E[1],E[0]]:[E[1],1,E[0]],O=N*S,j=cl([I,N,S],w.dtype),L=j.values,z=n.blockSize;for(let P=0;P<I;P++){let e=P%g,t=P%x;for(let n=0;n<N;n+=z){let a=Math.min(n+z,N);for(let r=0;r<S;r+=z){let s=Math.min(r+z,S);for(let i=0;i<k;i+=z){let o=Math.min(i+z,k);for(let l=n;l<a;l++)for(let n=r;n<s;n++){let a=0;for(let r=i;r<o;r++)a+=_[e*A+l*$+r*R]*C[r*F+n*D+t*M];L[P*O+(l*S+n)]+=a}}}}}return n.disposeIntermediateTensorInfo(w),n.disposeIntermediateTensorInfo(v),n.makeTensorInfo(b,j.dtype,j.values)}var JR={kernelName:dn,backendName:"cpu",kernelFunc:ZR},QR={kernelName:os,backendName:"cpu",kernelFunc:function(e){let t,n,a,{inputs:r,backend:s,attrs:i}=e,{a:o,b:l,bias:u,preluActivationWeights:d}=r,{transposeA:c,transposeB:p,activation:h,leakyreluAlpha:m}=i,f=[];t=ZR({inputs:{a:o,b:l},attrs:{transposeA:c,transposeB:p},backend:s}),u&&(n=EA({inputs:{a:t,b:u},backend:s}),f.push(t),t=n),h&&(a=KR(s,t,h,d,m),f.push(t),t=a);for(let g of f)s.disposeIntermediateTensorInfo(g);return t}},eF=jA(Ht,e=>Math.acos(e)),tF={kernelName:Ht,backendName:"cpu",kernelFunc:eF},nF=jA(qt,e=>Math.acosh(e)),aF={kernelName:qt,backendName:"cpu",kernelFunc:nF},rF={kernelName:Xt,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,a=t;lA(t,"addN");let r=a.map(e=>n.data.get(e.dataId).values),s=cl(a[0].shape,a[0].dtype),i=s.values;for(let o=0;o<a.length;o++){let e=r[o];for(let t=0;t<i.length;t++)i[t]+=e[t]}return n.makeTensorInfo(s.shape,s.dtype,s.values)}},sF={kernelName:Yt,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,keepDims:i}=a;lA(r,"all");let o=Ns.parseAxisParam(s,r.shape),l=o,u=Uf.getAxesPermutation(l,r.shape.length),d=r;null!=u&&(d=z$({inputs:{x:r},backend:n,attrs:{perm:u}}),l=Uf.getInnerMostAxes(l.length,r.shape.length)),Uf.assertAxesAreInnerMostDims("all",l,d.shape.length);let[c,p]=Uf.computeOutAndReduceShapes(d.shape,l),h=Ns.sizeFromShape(p),m=Ns.makeZerosTypedArray(Ns.sizeFromShape(c),d.dtype),f=n.data.get(d.dataId).values;for(let x=0;x<m.length;++x){let e=x*h,t=f[e];for(let n=0;n<h;++n){let a=f[e+n];t=t&&a}m[x]=t}null!=u&&n.disposeIntermediateTensorInfo(d);let g=n.makeTensorInfo(c,d.dtype,m);if(i){let e=XR({inputs:{x:g},backend:n,attrs:{shape:Uf.expandShapeToKeepDim(c,o)}});return n.disposeIntermediateTensorInfo(g),e}return g}},iF={kernelName:Zt,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,keepDims:i}=a;lA(r,"any");let o=Ns.parseAxisParam(s,r.shape),l=o,u=Uf.getAxesPermutation(l,r.shape.length),d=r;null!=u&&(d=z$({inputs:{x:r},backend:n,attrs:{perm:u}}),l=Uf.getInnerMostAxes(l.length,r.shape.length)),Uf.assertAxesAreInnerMostDims("any",l,d.shape.length);let[c,p]=Uf.computeOutAndReduceShapes(d.shape,l),h=Ns.sizeFromShape(p),m=Ns.makeZerosTypedArray(Ns.sizeFromShape(c),d.dtype),f=n.data.get(d.dataId).values;for(let x=0;x<m.length;++x){let e=x*h,t=f[e];for(let n=0;n<h;++n){let a=f[e+n];t=t||a}m[x]=t}null!=u&&n.disposeIntermediateTensorInfo(d);let g=n.makeTensorInfo(c,d.dtype,m);if(i){let e=XR({inputs:{x:g},backend:n,attrs:{shape:Uf.expandShapeToKeepDim(c,o)}});return n.disposeIntermediateTensorInfo(g),e}return g}},oF={kernelName:Jt,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s}=a;lA(r,"argMax");let i=Ns.parseAxisParam(s,r.shape),o=Uf.getAxesPermutation(i,r.shape.length),l=r,u=[];null!=o&&(l=z$({inputs:{x:r},backend:n,attrs:{perm:o}}),u.push(l),i=Uf.getInnerMostAxes(i.length,l.shape.length)),i=[i[0]],Uf.assertAxesAreInnerMostDims("argMax",i,l.shape.length);let[d,c]=Uf.computeOutAndReduceShapes(l.shape,i),p=Ns.sizeFromShape(d),h=Ns.makeZerosTypedArray(p,"int32"),m=Ns.sizeFromShape(c),f=n.data.get(l.dataId).values;for(let g=0;g<h.length;++g){let e=g*m,t=f[e],n=0;for(let a=0;a<m;++a){let r=f[e+a];r>t&&(t=r,n=a)}h[g]=n}return u.forEach(e=>n.disposeIntermediateTensorInfo(e)),n.makeTensorInfo(d,"int32",h)}},lF={kernelName:Qt,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s}=a;lA(r,"argMin");let i=Ns.parseAxisParam(s,r.shape),o=Uf.getAxesPermutation(i,r.shape.length),l=r,u=[];null!=o&&(l=z$({inputs:{x:r},backend:n,attrs:{perm:o}}),u.push(l),i=Uf.getInnerMostAxes(i.length,l.shape.length)),i=[i[0]],Uf.assertAxesAreInnerMostDims("argMin",i,l.shape.length);let[d,c]=Uf.computeOutAndReduceShapes(l.shape,i),p=Ns.sizeFromShape(d),h=Ns.makeZerosTypedArray(p,"int32"),m=Ns.sizeFromShape(c),f=n.data.get(l.dataId).values;for(let g=0;g<h.length;++g){let e=g*m,t=f[e],n=0;for(let a=0;a<m;++a){let r=f[e+a];r<t&&(t=r,n=a)}h[g]=n}return u.forEach(e=>n.disposeIntermediateTensorInfo(e)),n.makeTensorInfo(d,"int32",h)}},uF=jA(en,e=>Math.asin(e)),dF={kernelName:en,backendName:"cpu",kernelFunc:uF},cF=jA(tn,e=>Math.asinh(e)),pF={kernelName:tn,backendName:"cpu",kernelFunc:cF},hF=jA(nn,e=>Math.atan(e)),mF={kernelName:nn,backendName:"cpu",kernelFunc:hF},fF=mA((e,t)=>Math.atan2(e,t)),gF=IA(rn,fF),xF={kernelName:rn,backendName:"cpu",kernelFunc:gF},bF=jA(an,e=>Math.atanh(e)),yF={kernelName:an,backendName:"cpu",kernelFunc:bF};function wF(e,t,n,a,r,s){let i=r.strideHeight,o=r.strideWidth,l=r.dilationHeight,u=r.dilationWidth,d=r.effectiveFilterHeight,c=r.effectiveFilterWidth,p=r.padInfo.top,h=r.padInfo.left,m="max"===s?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,f=cl(r.outShape,n),g=f.values,x=r.outShape[1]*r.outShape[2]*r.outShape[3],b=r.outShape[2]*r.outShape[3],y=r.outShape[3];for(let w=0;w<r.batchSize;++w){let t=w*x,n=w*a[0];for(let f=0;f<r.inChannels;++f)for(let x=0;x<r.outHeight;++x){let w=x*i-p,v=Math.max(0,w),k=Math.min(r.inHeight,d+w),N=t+x*b;for(let t=0;t<r.outWidth;++t){let i=t*o-h,d=Math.max(0,i),p=Math.min(r.inWidth,c+i),x=m,b=0,w=0;for(let t=v;t<k;t+=l){let r=n+t*a[1];for(let t=d;t<p;t+=u){let n=e[r+t*a[2]+f];"max"===s&&n>x?x=n:"avg"===s&&(b+=n,w++)}if(isNaN(x))break}g[N+t*y+f]="avg"===s?b/w:x}}}return f}function vF(e,t,n,a,r=!1,s=!1){let i=cl(a.outShape,"int32"),o=a.strideHeight,l=a.strideWidth,u=a.dilationHeight,d=a.dilationWidth,c=a.effectiveFilterHeight,p=a.effectiveFilterWidth,h=a.padInfo.top,m=a.padInfo.left,f=cl(t,n,e);for(let g=0;g<a.batchSize;++g)for(let e=0;e<a.inChannels;++e)for(let t=0;t<a.outHeight;++t){let n=t*o-h,x=n;for(;x<0;)x+=u;let b=Math.min(a.inHeight,c+n);for(let o=0;o<a.outWidth;++o){let c=o*l-m,h=c;for(;h<0;)h+=d;let y=Math.min(a.inWidth,p+c),w=Number.NEGATIVE_INFINITY,v=-1;for(let t=x;t<b;t+=u){let i=t-n;for(let n=h;n<y;n+=d){let o=n-c,l=f.get(g,t,n,e);l>w&&(w=l,v=r?s?((g*a.inHeight+t)*a.inWidth+n)*a.inChannels+e:(t*a.inWidth+n)*a.inChannels+e:i*p+o)}}i.set(v,g,t,o,e)}}return i}function kF(e,t,n,a,r,s){let i=r.strideDepth,o=r.strideHeight,l=r.strideWidth,u=r.dilationDepth,d=r.dilationHeight,c=r.dilationWidth,p=r.effectiveFilterDepth,h=r.effectiveFilterHeight,m=r.effectiveFilterWidth,f=r.padInfo.front,g=r.padInfo.top,x=r.padInfo.left,b="max"===s?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,y=cl(r.outShape,n),w=y.values,v=r.outShape[1]*r.outShape[2]*r.outShape[3]*r.outShape[4],k=r.outShape[2]*r.outShape[3]*r.outShape[4],N=r.outShape[3]*r.outShape[4],S=r.outShape[4];for(let I=0;I<r.batchSize;++I){let t=I*v,n=I*a[0];for(let y=0;y<r.inChannels;++y)for(let v=0;v<r.outDepth;++v){let I=v*i-f,_=I;for(;_<0;)_+=u;let C=Math.min(r.inDepth,p+I),T=t+v*k;for(let t=0;t<r.outHeight;++t){let i=t*o-g,p=i;for(;p<0;)p+=d;let f=Math.min(r.inHeight,h+i),v=T+t*N;for(let t=0;t<r.outWidth;++t){let i=t*l-x,o=i;for(;o<0;)o+=c;let h=Math.min(r.inWidth,m+i),g=v+t*S,k=b,N=0,I=0;for(let t=_;t<C;t+=u){let r=n+t*a[1];for(let t=p;t<f;t+=d){let n=r+t*a[2];for(let t=o;t<h;t+=c){let r=e[n+t*a[3]+y];if("max"===s&&r>k?k=r:"avg"===s&&(N+=r,I++),isNaN(k))break}if(isNaN(k))break}if(isNaN(k))break}w[g+y]="avg"===s?N/Math.max(I,1):k}}}}return y}var NF={kernelName:sn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t;lA(r,"avgPool");let{filterSize:s,strides:i,pad:o,dimRoundingMode:l}=a;Ns.assert(Uf.eitherStridesOrDilationsAreOne(i,1),()=>`Error in avgPool: Either strides or dilations must be 1. Got strides ${i} and dilations '1'`);let u,d=Uf.computePool2DInfo(r.shape,s,i,1,o,l);if(1===d.filterWidth&&1===d.filterHeight&&Ns.arraysEqual(d.inShape,d.outShape))u=bA({inputs:{x:r},backend:n});else{let e=n.data.get(r.dataId).values,t=Ns.computeStrides(r.shape),a=wF(e,r.shape,r.dtype,t,d,"avg");u=n.makeTensorInfo(d.outShape,r.dtype,a.values)}return u}},SF={kernelName:ln,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{filterSize:s,strides:i,pad:o,dimRoundingMode:l,dataFormat:u}=a;lA(r,"avgPool3d");let d=Uf.computePool3DInfo(r.shape,s,i,1,o,l,u),c=kF(n.data.get(r.dataId).values,r.shape,r.dtype,Ns.computeStrides(r.shape),d,"avg");return n.makeTensorInfo(c.shape,"float32",c.values)}},IF={kernelName:un,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s}=t,{filterSize:i,strides:o,pad:l,dimRoundingMode:u}=a;lA([r,s],"avgPool3DGrad");let d=Uf.computePool3DInfo(s.shape,i,o,1,l,u),c=d.strideDepth,p=d.strideHeight,h=d.strideWidth,m=d.filterDepth,f=d.filterHeight,g=d.filterWidth,x=d.dilationDepth,b=d.dilationHeight,y=d.dilationWidth,w=d.effectiveFilterDepth,v=d.effectiveFilterHeight,k=d.effectiveFilterWidth,N=w-1-d.padInfo.front,S=k-1-d.padInfo.left,I=v-1-d.padInfo.top,_=cl(s.shape,"float32"),C=1/(m*f*g),T=n.bufferSync(r);for(let E=0;E<d.batchSize;++E)for(let e=0;e<d.inChannels;++e)for(let t=0;t<d.inDepth;++t)for(let n=0;n<d.inHeight;++n)for(let a=0;a<d.inWidth;++a){let r=t-N,s=n-I,i=a-S,o=0;for(let t=0;t<w;t+=x){let n=(r+t)/c;if(!(n<0||n>=d.outDepth||Math.floor(n)!==n))for(let t=0;t<v;t+=b){let a=(s+t)/p;if(!(a<0||a>=d.outHeight||Math.floor(a)!==a))for(let t=0;t<k;t+=y){let r=(i+t)/h;r<0||r>=d.outWidth||Math.floor(r)!==r||(o+=T.get(E,n,a,r,e))}}}_.set(o*C,E,t,n,a,e)}return n.makeTensorInfo(_.shape,_.dtype,_.values)}},_F={kernelName:on,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s}=t,i=s;lA([r,s],"avgPoolGrad");let{filterSize:o,strides:l,pad:u}=a,d=Uf.computePool2DInfo(i.shape,o,l,1,u),c=d.strideHeight,p=d.strideWidth,h=d.filterHeight,m=d.filterWidth,f=d.dilationHeight,g=d.dilationWidth,x=d.effectiveFilterHeight,b=d.effectiveFilterWidth,y=b-1-d.padInfo.left,w=x-1-d.padInfo.top,v=cl(i.shape,"float32"),k=1/(h*m),N=n.data.get(r.dataId).values,S=cl(r.shape,"float32",N);for(let I=0;I<d.batchSize;++I)for(let e=0;e<d.inChannels;++e)for(let t=0;t<d.inHeight;++t)for(let n=0;n<d.inWidth;++n){let a=t-w,r=n-y,s=0;for(let t=0;t<x;t+=f){let n=(a+t)/c;if(!(n<0||n>=d.outHeight||Math.floor(n)!==n))for(let t=0;t<b;t+=g){let a=(r+t)/p;a<0||a>=d.outWidth||Math.floor(a)!==a||(s+=S.get(I,n,a,e))}}v.set(s*k,I,t,n,e)}return n.makeTensorInfo(v.shape,v.dtype,v.values)}},CF={kernelName:aa,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,scale:s,offset:i,mean:o,variance:l}=t;Ns.assert(o.shape.length===l.shape.length,()=>"Batch normalization gradient requires mean and variance to have equal ranks."),Ns.assert(null==i||o.shape.length===i.shape.length,()=>"Batch normalization gradient requires mean and offset to have equal ranks."),Ns.assert(null==s||o.shape.length===s.shape.length,()=>"Batch normalization gradient requires mean and scale to have equal ranks."),lA([r,o,l,s,i],"batchNorm");let{varianceEpsilon:u}=a;null==u&&(u=.001);let d=n.data.get(r.dataId).values,c=n.data.get(o.dataId).values,p=n.data.get(l.dataId).values,h=s?n.data.get(s.dataId).values:new Float32Array([1]),m=i?n.data.get(i.dataId).values:new Float32Array([0]),f=new Float32Array(d.length),g=m.length,x=h.length,b=p.length,y=c.length,w=0,v=0,k=0,N=0;for(let S=0;S<d.length;++S)f[S]=m[w++]+(d[S]-c[v++])*h[k++]/Math.sqrt(p[N++]+u),w>=g&&(w=0),v>=y&&(v=0),k>=x&&(k=0),N>=b&&(N=0);return n.makeTensorInfo(r.shape,r.dtype,f)}},TF={kernelName:cn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{blockShape:s,crops:i}=a;lA([r],"batchToSpaceND");let o=s.reduce((e,t)=>e*t),l=Uf.getReshaped(r.shape,s,o),u=Uf.getPermuted(l.length,s.length),d=Uf.getReshapedPermuted(r.shape,s,o),c=Uf.getSliceBeginCoords(i,s.length),p=Uf.getSliceSize(d,i,s.length),h=XR({inputs:{x:r},backend:n,attrs:{shape:l}}),m=z$({inputs:{x:h},backend:n,attrs:{perm:u}}),f=XR({inputs:{x:m},backend:n,attrs:{shape:d}}),g=oR({inputs:{x:f},backend:n,attrs:{begin:c,size:p}});return n.disposeIntermediateTensorInfo(h),n.disposeIntermediateTensorInfo(m),n.disposeIntermediateTensorInfo(f),g}},EF={kernelName:pn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,weights:s}=t,{size:i}=a,o=$A(n.data.get(r.dataId).values,n.data.get(s.dataId).values,s.dtype,s.shape,i);return n.makeTensorInfo([i],s.dtype,o)}},AF={kernelName:fn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{s0:a,s1:r}=t,s=n.data.get(a.dataId).values,i=n.data.get(r.dataId).values,o=Uf.assertAndGetBroadcastShape(Array.from(s),Array.from(i));return n.makeTensorInfo([o.length],"int32",Int32Array.from(o))}},$F=jA(bn,(e,t)=>{let n=t;return e>n.clipValueMax?n.clipValueMax:e<n.clipValueMin?n.clipValueMin:e}),RF={kernelName:bn,backendName:"cpu",kernelFunc:$F},FF={kernelName:wn,backendName:"cpu",kernelFunc:e=>{let{x:t}=e.inputs,n=e.backend,a=new Float32Array(Ns.sizeFromShape(t.shape)),r=n.data.get(t.dataId),s=r.complexTensorInfos.real,i=r.complexTensorInfos.imag,o=n.data.get(s.dataId).values,l=n.data.get(i.dataId).values;for(let u=0;u<o.length;u++){let e=o[u],t=l[u];a[u]=Math.hypot(e,t)}return n.makeOutput(a,t.shape,"float32")}};function DF(e){let{inputs:t,backend:n}=e,{input:a}=t,r=n.data.get(a.dataId).complexTensorInfos.imag,s=n.data.get(r.dataId).values;return n.makeTensorInfo(r.shape,r.dtype,s)}var MF={kernelName:da,backendName:"cpu",kernelFunc:DF};function OF(e){let{inputs:t,backend:n,attrs:a}=e,{axis:r}=a,s=Ns.parseAxisParam(r,t[0].shape)[0],i=t.map(e=>e.shape);Uf.assertParamsConsistent(i,s);let o=Uf.computeOutShape(t.map(e=>e.shape),s);if(0===Ns.sizeFromShape(o))return n.makeTensorInfo(o,t[0].dtype,[]);let l=t.filter(e=>Ns.sizeFromShape(e.shape)>0);if(1===l.length)return bA({inputs:{x:l[0]},backend:n});if("complex64"===l[0].dtype){let e=l.map(e=>wA({inputs:{input:e},backend:n})),t=l.map(e=>DF({inputs:{input:e},backend:n})),a=OF({inputs:e,backend:n,attrs:{axis:s}}),r=OF({inputs:t,backend:n,attrs:{axis:s}}),i=fA({inputs:{real:a,imag:r},backend:n});return e.forEach(e=>n.disposeIntermediateTensorInfo(e)),t.forEach(e=>n.disposeIntermediateTensorInfo(e)),n.disposeIntermediateTensorInfo(a),n.disposeIntermediateTensorInfo(r),i}let u=l.map(e=>{let t=[-1,Ns.sizeFromShape(e.shape.slice(s))];return XR({inputs:{x:e},backend:n,attrs:{shape:t}})}),d=u.map(e=>({vals:n.data.get(e.dataId).values,shape:e.shape}));o=Uf.computeOutShape(u.map(e=>e.shape),1);let c=1===u[0].shape[0],p=WA(d,o,t[0].dtype,c),h=Uf.computeOutShape(l.map(e=>e.shape),s),m=n.makeTensorInfo(h,t[0].dtype,p);return u.forEach(e=>n.disposeIntermediateTensorInfo(e)),m}var jF={kernelName:vn,backendName:"cpu",kernelFunc:OF};function LF(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s}=t,{strides:i,pad:o,dataFormat:l,dilations:u,dimRoundingMode:d}=a;lA([r,s],"conv2d");let c=Uf.convertConv2DDataFormat(l),p=Uf.computeConv2DInfo(r.shape,s.shape,i,u,o,d,!1,c),h=p.filterHeight,m=p.filterWidth,f=p.dilationHeight,g=p.dilationWidth,x=p.padInfo.left,b=p.padInfo.top,y="channelsLast"===p.dataFormat,w=new ti(p.outShape,r.dtype),v=Ns.computeStrides(r.shape),k=Ns.computeStrides(s.shape),N=v[0],S=y?v[1]:v[2],I=y?v[2]:1,_=y?1:v[1],C=w.strides[0],T=y?w.strides[1]:w.strides[2],E=y?w.strides[2]:1,A=y?1:w.strides[1],$=n.data.get(r.dataId).values,R=n.data.get(s.dataId).values,F=w.values;for(let D=0;D<p.batchSize;++D){let e=D*N,t=D*C;for(let n=0;n<p.outHeight;++n){let a=t+n*T,r=n*p.strideHeight-b;for(let t=0;t<h;++t){let n=r+t*f;if(n<0||n>=p.inHeight)continue;let s=t*k[0],i=e+n*S;for(let e=0;e<p.outWidth;++e){let t=a+e*E,n=e*p.strideWidth-x;for(let e=0;e<m;++e){let a=n+e*g;if(a<0||a>=p.inWidth)continue;let r=i+a*I,o=s+e*k[1];for(let e=0;e<p.inChannels;++e){let n=$[r+e*_];for(let e=0;e<p.outChannels;++e)F[t+e*A]+=n*R[o+e];o+=p.outChannels}}}}}}return n.makeTensorInfo(w.shape,w.dtype,F)}var zF={kernelName:kn,backendName:"cpu",kernelFunc:LF},PF={kernelName:Nn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,dy:s}=t,{strides:i,pad:o,dataFormat:l,dimRoundingMode:u,filterShape:d}=a;lA([r,s],"conv2dBackpropFilter");let c=Uf.convertConv2DDataFormat(l),p=Uf.computeConv2DInfo(r.shape,d,i,1,o,u,!1,c),{strideHeight:h,strideWidth:m,filterHeight:f,filterWidth:g}=p,x="channelsLast"===p.dataFormat,b=new ti(p.filterShape,"float32"),y=p.padInfo.left,w=p.padInfo.top,v=n.data.get(r.dataId).values,k=n.data.get(s.dataId).values,N=new ti(r.shape,r.dtype,v),S=new ti(s.shape,s.dtype,k);for(let I=0;I<f;++I){let e=Math.max(0,Math.ceil((w-I)/h)),t=Math.min(p.outHeight,(p.inHeight+w-I)/h);for(let n=0;n<g;++n){let a=Math.max(0,Math.ceil((y-n)/m)),r=Math.min(p.outWidth,(p.inWidth+y-n)/m);for(let s=0;s<p.inChannels;++s)for(let i=0;i<p.outChannels;++i){let o=0;for(let l=0;l<p.batchSize;++l)for(let u=e;u<t;++u){let e=I+u*h-w;for(let t=a;t<r;++t){let a=n+t*m-y;o+=x?N.get(l,e,a,s)*S.get(l,u,t,i):N.get(l,s,e,a)*S.get(l,i,u,t)}}b.set(o,I,n,s,i)}}}return n.makeTensorInfo(b.shape,b.dtype,b.values)}},BF={kernelName:Sn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,filter:s}=t,{inputShape:i,strides:o,pad:l,dataFormat:u,dimRoundingMode:d}=a;lA([r,s],"conv2dBackpropInput");let c=Ns.computeStrides(s.shape),p=Ns.computeStrides(r.shape),h=Uf.convertConv2DDataFormat(u),m=Uf.computeConv2DInfo(i,s.shape,o,1,l,d,!1,h),f=new ti(m.inShape,"float32"),g=f.values,x=n.data.get(r.dataId).values,b=n.data.get(s.dataId).values,[y,w,v]=c,{batchSize:k,filterHeight:N,filterWidth:S,inChannels:I,inHeight:_,inWidth:C,outChannels:T,outHeight:E,outWidth:A,strideHeight:$,strideWidth:R}=m;h=m.dataFormat;let F=N-1-m.padInfo.top,D=S-1-m.padInfo.left,M="channelsLast"===h,O=f.strides[0],j=M?f.strides[1]:f.strides[2],L=M?f.strides[2]:1,z=M?1:f.strides[1],P=p[0],B=M?p[1]:p[2],W=M?p[2]:1,V=M?1:p[1];for(let U=0;U<k;++U)for(let e=0;e<I;++e)for(let t=0;t<_;++t){let n=t-F,a=Math.max(0,Math.ceil(n/$)),r=Math.min(E,(N+n)/$);for(let s=0;s<C;++s){let i=s-D,o=Math.max(0,Math.ceil(i/R)),l=Math.min(A,(S+i)/R),u=0;for(let t=a;t<r;++t){let a=t*$-n;for(let n=o;n<l;++n){let r=P*U+B*t+W*n,s=y*(N-1-a)+w*(S-1-(n*R-i))+v*e;for(let e=0;e<T;++e)u+=x[r+V*e]*b[s+e]}}g[O*U+j*t+L*s+z*e]=u}}return n.makeTensorInfo(f.shape,f.dtype,f.values)}},WF={kernelName:In,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s}=t,{strides:i,pad:o,dilations:l}=a;lA([r,s],"conv3d");let u=Uf.computeConv3DInfo(r.shape,s.shape,i,l,o),{filterDepth:d,filterHeight:c,filterWidth:p,dilationDepth:h,dilationHeight:m,dilationWidth:f,padInfo:g}=u,x=g.front,b=g.left,y=g.top,w=new ti(u.outShape,r.dtype),v=n.data.get(r.dataId).values,k=n.data.get(s.dataId).values,N=w.values,S=Ns.computeStrides(r.shape),I=Ns.computeStrides(s.shape);for(let _=0;_<u.batchSize;++_){let e=_*S[0],t=_*w.strides[0];for(let n=0;n<u.outDepth;++n){let a=t+n*w.strides[1],r=n*u.strideDepth-x;for(let t=0;t<d;++t){let n=r+t*h;if(n<0||n>=u.inDepth)continue;let s=t*I[0],i=e+n*S[1];for(let e=0;e<u.outHeight;++e){let t=a+e*w.strides[2],n=e*u.strideHeight-y;for(let e=0;e<c;++e){let a=n+e*m;if(a<0||a>=u.inHeight)continue;let r=s+e*I[1],o=i+a*S[2];for(let e=0;e<u.outWidth;++e){let n=t+e*u.outChannels,a=e*u.strideWidth-b;for(let e=0;e<p;++e){let t=a+e*f;if(t<0||t>=u.inWidth)continue;let s=r+e*I[2],i=o+t*u.inChannels,l=s;for(let e=0;e<u.inChannels;++e){let t=v[i+e];for(let e=0;e<u.outChannels;++e)N[n+e]+=t*k[l+e];l+=u.outChannels}}}}}}}}return n.makeTensorInfo(w.shape,w.dtype,w.values)}},VF={kernelName:_n,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,dy:s}=t,{strides:i,pad:o,filterShape:l}=a;lA([r,s],"conv3dBackpropFilterV2");let u=Ns.computeStrides(r.shape),d=Ns.computeStrides(s.shape),c=Uf.computeConv3DInfo(r.shape,l,i,1,o),p=c.strideDepth,h=c.strideHeight,m=c.strideWidth,f=c.filterDepth,g=c.filterHeight,x=c.filterWidth,b=new ti(c.filterShape,"float32"),y=b.values,[w,v,k,N]=b.strides,S=n.data.get(s.dataId).values,[I,_,C,T]=d,E=n.data.get(r.dataId).values,[A,$,R,F]=u,D=c.padInfo.front,M=c.padInfo.left,O=c.padInfo.top;for(let j=0;j<f;++j){let e=Math.max(0,Math.ceil((D-j)/p)),t=Math.min(c.outDepth,(c.inDepth+D-j)/p),n=j*w;for(let a=0;a<g;++a){let r=Math.max(0,Math.ceil((O-a)/h)),s=Math.min(c.outHeight,(c.inHeight+O-a)/h),i=a*v+n;for(let n=0;n<x;++n){let o=Math.max(0,Math.ceil((M-n)/m)),l=Math.min(c.outWidth,(c.inWidth+M-n)/m),u=n*k+i;for(let i=0;i<c.inChannels;++i){let d=i*N+u;for(let u=0;u<c.outChannels;++u){let f=0;for(let d=0;d<c.batchSize;++d){let c=d*A,g=d*I;for(let d=e;d<t;++d){let e=(j+d*p-D)*$+c,t=d*_+g;for(let d=r;d<s;++d){let r=(a+d*h-O)*R+e,s=d*C+t;for(let e=o;e<l;++e){let t=e*T+s;f+=E[(n+e*m-M)*F+r+i]*S[t+u]}}}}y[d+u]=f}}}}}return n.makeTensorInfo(b.shape,b.dtype,b.values)}},UF={kernelName:Cn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,filter:s}=t,{pad:i,strides:o,inputShape:l}=a;lA([r],"conv3dBackpropInputV2");let u=Ns.computeStrides(r.shape),d=Ns.computeStrides(s.shape),c=Uf.computeConv3DInfo(l,s.shape,o,1,i),p=new ti(c.inShape,"float32"),h=p.values,[m,f,g,x]=p.strides,b=n.data.get(r.dataId).values,[y,w,v,k]=u,N=n.data.get(s.dataId).values,[S,I,_,C]=d,{batchSize:T,filterDepth:E,filterHeight:A,filterWidth:$,inChannels:R,inDepth:F,inHeight:D,inWidth:M,outChannels:O,outDepth:j,outHeight:L,outWidth:z,strideDepth:P,strideHeight:B,strideWidth:W}=c,V=E-1-c.padInfo.front,U=A-1-c.padInfo.top,G=$-1-c.padInfo.left;for(let H=0;H<T;++H)for(let e=0;e<R;++e)for(let t=0;t<F;++t){let n=t-V,a=Math.max(0,Math.ceil(n/P)),r=Math.min(j,(E+n)/P);for(let s=0;s<D;++s){let i=s-U,o=Math.max(0,Math.ceil(i/B)),l=Math.min(L,(A+i)/B);for(let u=0;u<M;++u){let d=u-G,c=Math.max(0,Math.ceil(d/W)),p=Math.min(z,($+d)/W),T=0;for(let t=a;t<r;++t){let a=t*P-n;for(let n=o;n<l;++n){let r=n*B-i;for(let s=c;s<p;++s){let i=y*H+w*t+v*n+k*s,o=S*(E-1-a)+I*(A-1-r)+_*($-1-(s*W-d))+C*e;for(let e=0;e<O;++e)T+=b[i+e]*N[o+e]}}}h[m*H+f*t+g*s+x*u+e]=T}}}return n.makeTensorInfo(p.shape,p.dtype,p.values)}},GF=jA(Tn,e=>Math.cos(e)),HF={kernelName:Tn,backendName:"cpu",kernelFunc:GF},qF=jA(En,e=>Math.cosh(e)),KF={kernelName:En,backendName:"cpu",kernelFunc:qF},XF={kernelName:Rn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{image:r,boxes:s,boxInd:i}=t,{cropSize:o,method:l,extrapolationValue:u}=a,[d,c,p,h]=r.shape,m=s.shape[0],[f,g]=o,x=cl([m,f,g,h],"float32"),b=n.data.get(s.dataId).values,y=n.data.get(i.dataId).values,w=n.data.get(r.dataId).values,v=Ns.computeStrides(r.shape),k=Ns.computeStrides(x.shape);for(let N=0;N<m;N++){let e=4*N,t=b[e],n=b[e+1],a=b[e+2],r=b[e+3],s=y[N];if(s>=d)continue;let i=f>1?(a-t)*(c-1)/(f-1):0,o=g>1?(r-n)*(p-1)/(g-1):0;for(let d=0;d<f;d++){let e=f>1?t*(c-1)+d*i:.5*(t+a)*(c-1);if(e<0||e>c-1)for(let t=0;t<g;t++)for(let e=0;e<h;e++){let n=e+t*k[2]+d*k[1]+N*k[0];x.values[n]=u}else if("bilinear"===l){let t=Math.floor(e),a=Math.ceil(e),i=e-t;for(let e=0;e<g;e++){let l=g>1?n*(p-1)+e*o:.5*(n+r)*(p-1);if(l<0||l>p-1){for(let t=0;t<h;t++){let n=t+e*k[2]+d*k[1]+N*k[0];x.values[n]=u}continue}let c=Math.floor(l),m=Math.ceil(l),f=l-c;for(let n=0;n<h;n++){let r=n+c*v[2]+t*v[1]+s*v[0],o=w[r];r=n+m*v[2]+t*v[1]+s*v[0];let l=w[r];r=n+c*v[2]+a*v[1]+s*v[0];let u=w[r];r=n+m*v[2]+a*v[1]+s*v[0];let p=o+(l-o)*f,h=u+(w[r]-u)*f;r=n+e*k[2]+d*k[1]+N*k[0],x.values[r]=p+(h-p)*i}}}else for(let t=0;t<g;++t){let a=g>1?n*(p-1)+t*o:.5*(n+r)*(p-1);if(a<0||a>p-1){for(let e=0;e<h;e++){let n=e+t*k[2]+d*k[1]+N*k[0];x.values[n]=u}continue}let i=Math.round(a),l=Math.round(e);for(let e=0;e<h;e++){let n=e+i*v[2]+l*v[1]+s*v[0],a=e+t*k[2]+d*k[1]+N*k[0];x.values[a]=w[n]}}}}return n.makeTensorInfo(x.shape,x.dtype,x.values)}},YF={kernelName:An,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,exclusive:i,reverse:o}=a;lA(r,"cumprod");let l=Uf.getAxesPermutation([s],r.shape.length),u=r;null!=l&&(u=z$({inputs:{x:r},backend:n,attrs:{perm:l}}));let d=Uf.getInnerMostAxes(1,r.shape.length)[0];if(d!==u.shape.length-1)throw new Error(`backend.cumprod in CPU expects an inner-most axis=${u.shape.length-1} but got axis=${d}`);let c=mi(u.dtype,"int32"),p=Ns.makeOnesTypedArray(Ns.sizeFromShape(u.shape),c),h=n.data.get(u.dataId).values,m=u.shape[u.shape.length-1],f=o?(e,t)=>e+m-t-1:(e,t)=>e+t;for(let x=0;x<h.length;x+=m)for(let e=0;e<m;e++){let t=f(x,e);if(0===e)p[t]=i?1:h[t];else{let n=f(x,e-1);p[t]=i?h[n]*p[n]:h[t]*p[n]}}let g=n.makeTensorInfo(u.shape,c,p);if(null!=l){let e=z$({inputs:{x:g},backend:n,attrs:{perm:Uf.getUndoAxesPermutation(l)}});return n.disposeIntermediateTensorInfo(g),n.disposeIntermediateTensorInfo(u),e}return g}},ZF={kernelName:$n,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,exclusive:i,reverse:o}=a;lA(r,"cumsum");let l=Uf.getAxesPermutation([s],r.shape.length),u=r;null!=l&&(u=z$({inputs:{x:r},backend:n,attrs:{perm:l}}));let d=Uf.getInnerMostAxes(1,r.shape.length)[0];if(d!==u.shape.length-1)throw new Error(`backend.cumsum in CPU expects an inner-most axis=${u.shape.length-1} but got axis=${d}`);let c=mi(u.dtype,"int32"),p=Ns.makeZerosTypedArray(Ns.sizeFromShape(u.shape),c),h=n.data.get(u.dataId).values,m=u.shape[u.shape.length-1],f=o?(e,t)=>e+m-t-1:(e,t)=>e+t;for(let x=0;x<h.length;x+=m)for(let e=0;e<m;e++){let t=f(x,e);if(0===e)p[t]=i?0:h[t];else{let n=f(x,e-1);p[t]=i?h[n]+p[n]:h[t]+p[n]}}let g=n.makeTensorInfo(u.shape,c,p);if(null!=l){let e=z$({inputs:{x:g},backend:n,attrs:{perm:Uf.getUndoAxesPermutation(l)}});return n.disposeIntermediateTensorInfo(g),n.disposeIntermediateTensorInfo(u),e}return g}},JF={kernelName:Fn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,weights:s}=t,{size:i,binaryOutput:o}=a;if(1===r.shape.length){let e=$A(n.data.get(r.dataId).values,n.data.get(s.dataId).values,s.dtype,s.shape,i);return n.makeTensorInfo([i],s.dtype,e)}if(2===r.shape.length){let e=RA(n.bufferSync(r),n.bufferSync(s),i,o);return n.makeTensorInfo(e.shape,s.dtype,e.values)}throw new Error(`Error in denseBincount: input must be at most rank 2, but got rank${r.shape.length}.`)}},QF={kernelName:Dn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{blockSize:s,dataFormat:i}=a;Ns.assert("NHWC"===i,()=>`Only NHWC dataFormat supported on CPU for depthToSpace. Got ${i}`);let o=r.shape[0],l=r.shape[1],u=r.shape[2],d=r.shape[3],c=l*s,p=u*s,h=d/(s*s),m=n.data.get(r.dataId).values,f=new Float32Array(o*c*p*h),g=0;for(let x=0;x<o;++x)for(let e=0;e<c;++e){let t=Math.floor(e/s),n=e%s;for(let e=0;e<p;++e){let a=Math.floor(e/s),r=(n*s+e%s)*h;for(let e=0;e<h;++e){let n=e+r+d*(a+u*(t+l*x));f[g++]=m[n]}}}return n.makeTensorInfo([o,c,p,h],r.dtype,f)}};function eD(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s}=t,{strides:i,pad:o,dilations:l,dimRoundingMode:u}=a;lA([r,s],"depthwiseConv2DNative");let d=Ns.computeStrides(r.shape),c=Ns.computeStrides(s.shape),p=l;null==p&&(p=[1,1]),Ns.assert(Uf.eitherStridesOrDilationsAreOne(i,p),()=>`Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides ${i} and dilations '${p}'`);let h=Uf.computeConv2DInfo(r.shape,s.shape,i,p,o,u,!0),{filterHeight:m,filterWidth:f,dilationHeight:g,dilationWidth:x,padInfo:b}=h,y=b.left,w=b.top,v=h.outChannels/h.inChannels,k=new ti(h.outShape,r.dtype),N=n.data.get(r.dataId).values,S=n.data.get(s.dataId).values,I=k.values;for(let _=0;_<h.batchSize;++_){let e=_*d[0],t=_*k.strides[0];for(let n=0;n<h.outHeight;++n){let a=t+n*k.strides[1],r=n*h.strideHeight-w;for(let t=0;t<m;++t){let n=r+t*g;if(n<0||n>=h.inHeight)continue;let s=t*c[0],i=e+n*d[1];for(let e=0;e<h.outWidth;++e){let t=a+e*k.strides[2],n=e*h.strideWidth-y;for(let e=0;e<f;++e){let a=n+e*x;if(a<0||a>=h.inWidth)continue;let r=s+e*c[1],o=i+a*h.inChannels,l=t,u=r;for(let e=0;e<h.inChannels;++e){let t=N[o+e];for(let e=0;e<v;++e)I[l+e]+=t*S[u+e];l+=v,u+=v}}}}}}return n.makeTensorInfo(k.shape,k.dtype,k.values)}var tD={kernelName:Mn,backendName:"cpu",kernelFunc:eD},nD={kernelName:On,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,dy:s}=t,{strides:i,dilations:o,pad:l,dimRoundingMode:u,filterShape:d}=a;lA([r,s],"depthwiseConv2dNativeBackpropFilter");let c=Uf.computeConv2DInfo(r.shape,d,i,o,l,u,!0),{strideHeight:p,strideWidth:h,filterHeight:m,filterWidth:f}=c,g=new ti(c.filterShape,"float32"),x=c.padInfo.left,b=c.padInfo.top,y=c.outChannels/c.inChannels,w=n.data.get(r.dataId).values,v=new ti(r.shape,r.dtype,w),k=n.data.get(s.dataId).values,N=new ti(s.shape,s.dtype,k);for(let S=0;S<m;++S){let e=Math.max(0,Math.ceil((b-S)/p)),t=Math.min(c.outHeight,(c.inHeight+b-S)/p);for(let n=0;n<f;++n){let a=Math.max(0,Math.ceil((x-n)/h)),r=Math.min(c.outWidth,(c.inWidth+x-n)/h);for(let s=0;s<c.outChannels;++s){let i=Math.trunc(s/y),o=s%y,l=0;for(let u=0;u<c.batchSize;++u)for(let o=e;o<t;++o){let e=S+o*p-b;for(let t=a;t<r;++t){let a=n+t*h-x;l+=v.get(u,e,a,i)*N.get(u,o,t,s)}}g.set(l,S,n,i,o)}}}return n.makeTensorInfo(g.shape,g.dtype,g.values)}},aD={kernelName:jn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,filter:s}=t,{strides:i,dilations:o,pad:l,dimRoundingMode:u,inputShape:d}=a;lA([r,s],"depthwiseConv2DNativeBackpropInput");let c=Ns.computeStrides(r.shape),p=Ns.computeStrides(s.shape),h=Uf.computeConv2DInfo(d,s.shape,i,o,l,u,!0),m=new ti(h.inShape,"float32"),f=m.values,[g,x,b]=m.strides,y=n.data.get(r.dataId).values,[w,v,k]=c,N=n.data.get(s.dataId).values,[S,I,_]=p,{batchSize:C,filterHeight:T,filterWidth:E,inChannels:A,inHeight:$,inWidth:R,outChannels:F,outHeight:D,outWidth:M,strideHeight:O,strideWidth:j}=h,L=T-1-h.padInfo.top,z=E-1-h.padInfo.left,P=F/A;for(let B=0;B<C;++B)for(let e=0;e<A;++e)for(let t=0;t<$;++t){let n=t-L,a=Math.max(0,Math.ceil(n/O)),r=Math.min(D,(T+n)/O);for(let s=0;s<R;++s){let i=s-z,o=Math.max(0,Math.ceil(i/j)),l=Math.min(M,(E+i)/j),u=0;for(let t=a;t<r;++t){let a=t*O-n;for(let n=o;n<l;++n){let r=w*B+v*t+k*n,s=S*(T-1-a)+I*(E-1-(n*j-i))+_*e;for(let t=0;t<P;++t)u+=y[r+(e*P+t)]*N[s+t]}}f[g*B+x*t+b*s+e]=u}}return n.makeTensorInfo(m.shape,m.dtype,m.values)}},rD={kernelName:Ln,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{x:a}=t,r=Ns.sizeFromShape(a.shape),s=n.data.get(a.dataId).values,i=cl([r,r],a.dtype),o=i.values;for(let u=0;u<s.length;u++)o[u*r+u]=s[u];let l=[...a.shape,...a.shape];return n.makeTensorInfo(l,i.dtype,i.values)}},sD={kernelName:zn,backendName:"cpu",kernelFunc:({inputs:e,backend:t,attrs:n})=>{let{x:a,filter:r}=e,{strides:s,pad:i,dilations:o}=n,l=t,u=l.data.get(a.dataId).values,d=a.shape.length,c=l.data.get(r.dataId).values,p=r.shape.length,{batchSize:h,inHeight:m,inWidth:f,inChannels:g,outHeight:x,outWidth:b,padInfo:y,strideHeight:w,strideWidth:v,filterHeight:k,filterWidth:N,dilationHeight:S,dilationWidth:I,outShape:_}=Uf.computeDilation2DInfo(a.shape,r.shape,s,i,"NHWC",o),C=Ns.sizeFromShape(_),T=_.length,E=Ns.getArrayFromDType(a.dtype,C);for(let A=0;A<h;++A)for(let e=0;e<x;++e){let t=e*w-y.top;for(let n=0;n<b;++n){let s=n*v-y.left;for(let i=0;i<g;++i){let o=Number.MIN_SAFE_INTEGER;for(let e=0;e<k;++e){let n=t+e*S;if(n>=0&&n<m)for(let t=0;t<N;++t){let l=s+t*I;if(l>=0&&l<f){let s=Ns.locToIndex([A,n,l,i],d,Ns.computeStrides(a.shape)),h=Ns.locToIndex([e,t,i],p,Ns.computeStrides(r.shape)),m=u[s]+c[h];m>o&&(o=m)}}}E[Ns.locToIndex([A,e,n,i],T,Ns.computeStrides(_))]=o}}}return{dataId:l.write(Ns.toTypedArray(E,a.dtype),_,a.dtype),shape:_,dtype:a.dtype}}},iD={kernelName:Bn,backendName:"cpu",kernelFunc:({inputs:e,backend:t,attrs:n})=>{let{x:a,filter:r,dy:s}=e,{strides:i,pad:o,dilations:l}=n,u=t,d=Ns.toNestedArray(a.shape,u.data.get(a.dataId).values),c=Ns.toNestedArray(r.shape,u.data.get(r.dataId).values),{batchSize:p,inHeight:h,inWidth:m,inChannels:f,outHeight:g,outWidth:x,padInfo:b,strideHeight:y,strideWidth:w,filterHeight:v,filterWidth:k,dilationHeight:N,dilationWidth:S,outShape:I}=Uf.computeDilation2DInfo(a.shape,r.shape,i,o,"NHWC",l);Ns.assert(s.rank===I.length,()=>`Error in ${Bn}, dy must have the same rank as output ${I.length}, but got ${s.rank}`);let _=Ns.toNestedArray(I,u.data.get(s.dataId).values),C=Ns.makeZerosNestedTypedArray(r.shape,r.dtype);for(let T=0;T<p;++T)for(let e=0;e<g;++e){let t=e*y-b.top;for(let n=0;n<x;++n){let a=n*w-b.left;for(let r=0;r<f;++r){let s=Number.MIN_SAFE_INTEGER,i=0,o=0;for(let e=0;e<v;++e){let n=t+e*N;if(n>=0&&n<h)for(let t=0;t<k;++t){let l=a+t*S;if(l>=0&&l<m){let a=d[T][n][l][r]+c[e][t][r];a>s&&(s=a,i=e,o=t)}}}C[i][o][r]+=_[T][e][n][r]}}}return{dataId:u.write(Ns.toTypedArray(C,a.dtype),r.shape,r.dtype),shape:r.shape,dtype:r.dtype}}},oD={kernelName:Pn,backendName:"cpu",kernelFunc:({inputs:e,backend:t,attrs:n})=>{let{x:a,filter:r,dy:s}=e,{strides:i,pad:o,dilations:l}=n,u=t,d=Ns.toNestedArray(a.shape,u.data.get(a.dataId).values),c=Ns.toNestedArray(r.shape,u.data.get(r.dataId).values),{batchSize:p,inHeight:h,inWidth:m,inChannels:f,outHeight:g,outWidth:x,padInfo:b,strideHeight:y,strideWidth:w,filterHeight:v,filterWidth:k,dilationHeight:N,dilationWidth:S,outShape:I}=Uf.computeDilation2DInfo(a.shape,r.shape,i,o,"NHWC",l);Ns.assert(s.rank===I.length,()=>`Error in ${Pn}, dy must have the same rank as output ${I.length}, but got ${s.rank}`);let _=Ns.toNestedArray(I,u.data.get(s.dataId).values),C=Ns.makeZerosNestedTypedArray(a.shape,a.dtype);for(let T=0;T<p;++T)for(let e=0;e<g;++e){let t=e*y-b.top;for(let n=0;n<x;++n){let a=n*w-b.left;for(let r=0;r<f;++r){let s=Number.MIN_SAFE_INTEGER,i=t<0?0:t,o=a<0?0:a;for(let e=0;e<v;++e){let n=t+e*N;if(n>=0&&n<h)for(let t=0;t<k;++t){let l=a+t*S;if(l>=0&&l<m){let a=d[T][n][l][r]+c[e][t][r];a>s&&(s=a,i=n,o=l)}}}C[T][i][o][r]+=_[T][e][n][r]}}}return{dataId:u.write(Ns.toTypedArray(C,a.dtype),a.shape,a.dtype),shape:a.shape,dtype:a.dtype}}},lD={kernelName:Wn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{image:r}=t,{canvas:s,options:i}=a,{contextOptions:o,imageOptions:l}=i||{},u=(null==l?void 0:l.alpha)||1,d=(null==o?void 0:o.contextType)||"2d";if("2d"!==d)throw new Error(`Context type ${o.contextType} is not supported by the CPU backend.`);let c=s.getContext(d,(null==o?void 0:o.contextAttributes)||{});if(null==c)throw new Error(`Could not get the context with ${d} type.`);let[p,h]=r.shape.slice(0,2),m=2===r.shape.length?1:r.shape[2],f=n.data.get(r.dataId).values,g="float32"===r.dtype?255:1,x=new Uint8ClampedArray(h*p*4);for(let y=0;y<p*h;++y){let e=[0,0,0,255*u];for(let n=0;n<m;n++){let t=f[y*m+n];if("float32"===r.dtype){if(t<0||t>1)throw new Error(`Tensor values for a float32 Tensor must be in the range [0 - 1] but encountered ${t}.`)}else if("int32"===r.dtype&&(t<0||t>255))throw new Error(`Tensor values for a int32 Tensor must be in the range [0 - 255] but encountered ${t}.`);1===m?(e[0]=t*g,e[1]=t*g,e[2]=t*g):e[n]=t*g}let t=4*y;x[t+0]=Math.round(e[0]),x[t+1]=Math.round(e[1]),x[t+2]=Math.round(e[2]),x[t+3]=Math.round(e[3])}s.width=h,s.height=p;let b=new ImageData(x,h,p);return c.putImageData(b,0,0),r}};function uD(e){let t,{inputs:n,backend:a,attrs:r}=e,{x:s}=n,{axis:i,keepDims:o}=r;lA(s,"sum"),t="bool"===s.dtype?NA({inputs:{x:s},backend:a,attrs:{dtype:"int32"}}):bA({inputs:{x:s},backend:a});let l=t.shape.length,u=Ns.parseAxisParam(i,t.shape),d=Uf.getAxesPermutation(u,l),c=u,p=t;null!=d&&(p=z$({inputs:{x:t},backend:a,attrs:{perm:d}}),c=Uf.getInnerMostAxes(c.length,l)),Uf.assertAxesAreInnerMostDims("sum",c,p.shape.length);let[h,m]=Uf.computeOutAndReduceShapes(p.shape,c),f=xA(a,h,Uf.upcastType(p.dtype,"int32")),g=Ns.sizeFromShape(m),x=a.data.get(f.dataId).values,b=a.data.get(p.dataId).values;for(let y=0;y<x.length;++y){let e=y*g,t=0;for(let n=0;n<g;++n)t+=b[e+n];x[y]=t}if(o){let e=f;f=XR({inputs:{x:f},backend:a,attrs:{shape:Uf.expandShapeToKeepDim(f.shape,u)}}),a.disposeIntermediateTensorInfo(e)}return a.disposeIntermediateTensorInfo(t),null!=d&&a.disposeIntermediateTensorInfo(p),f}var dD={kernelName:Ar,backendName:"cpu",kernelFunc:uD},cD={kernelName:Un,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{equation:r}=a,s=t,{allDims:i,summedDims:o,idDims:l}=Uf.decodeEinsumEquation(r,s.length);Uf.checkEinsumDimSizes(i.length,l,s);let{path:u,steps:d}=Uf.getEinsumComputePath(o,l),c=d.length,p=null,h=i.length,m=[];for(let f=0;f<c;++f){for(let e of d[f]){let t,{permutationIndices:a,expandDims:r}=Uf.getEinsumPermutation(h,l[e]);Uf.isIdentityPermutation(a)?t=s[e]:(t=z$({inputs:{x:s[e]},backend:n,attrs:{perm:a}}),m.push(t));let i=t.shape.slice();for(let e=0;e<r.length;++e)i.splice(r[e],0,1);Ns.arraysEqual(t.shape,i)||(t=XR({inputs:{x:t},backend:n,attrs:{shape:i}}),m.push(t)),null===p?p=t:(p=$$({inputs:{a:t,b:p},backend:n}),m.push(p))}f<c-1&&(u[f]>=0&&(p=uD({inputs:{x:p},backend:n,attrs:{axis:u[f]-(i.length-h),keepDims:!1}}),m.push(p)),h--)}for(let f of m)f!==p&&n.disposeIntermediateTensorInfo(f);return p}},pD={kernelName:Hn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{dy:a,y:r}=t;lA([a,r],"eluGrad");let s=new Float32Array(Ns.sizeFromShape(r.shape)),i=n.data.get(r.dataId).values,o=n.data.get(a.dataId).values;for(let l=0;l<i.length;++l){let e=i[l];s[l]=e>=0?o[l]:o[l]*(e+1)}return n.makeTensorInfo(r.shape,"float32",s)}},hD=Uf.ERF_P,mD=Uf.ERF_A1,fD=Uf.ERF_A2,gD=Uf.ERF_A3,xD=Uf.ERF_A4,bD=Uf.ERF_A5,yD=jA(qn,e=>{let t=Math.sign(e),n=Math.abs(e),a=1/(1+hD*n);return t*(1-((((bD*a+xD)*a+gD)*a+fD)*a+mD)*a*Math.exp(-n*n))}),wD={kernelName:qn,backendName:"cpu",kernelFunc:yD};function vD(e){let{inputs:t,backend:n,attrs:a}=e,{input:r}=t,{dim:s}=a,i=r.shape.length,o=r.shape.slice(),l=s;return s<0&&(Ns.assert(-(i+1)<=s,()=>`Axis must be in the interval [${-(i+1)}, ${i}]`),l=i+s+1),o.splice(l,0,1),XR({inputs:{x:r},backend:n,attrs:{shape:o}})}var kD={kernelName:Yn,backendName:"cpu",kernelFunc:vD},ND=mA((e,t)=>e/t),SD=IA(Vn,ND),ID={kernelName:Vn,backendName:"cpu",kernelFunc:SD};function _D(e,t,n){let a=e.shape,r=a[0],s=a[1],i=n.data.get(e.dataId),o=i.complexTensorInfos.real,l=i.complexTensorInfos.imag,u=[r,s],d=Ns.sizeFromShape(u),c=Ns.getTypedArrayFromDType("float32",d),p=Ns.getTypedArrayFromDType("float32",d);for(let g=0;g<r;g++){let e=oR({inputs:{x:o},backend:n,attrs:{begin:[g,0],size:[1,s]}}),a=oR({inputs:{x:l},backend:n,attrs:{begin:[g,0],size:[1,s]}}),r=fA({inputs:{real:e,imag:a},backend:n}),{real:i,imag:u}=CD(r,t,n),d=Uf.mergeRealAndImagArrays(i,u);for(let t=0;t<s;t++){let e=Uf.getComplexWithIndex(d,t);c[g*s+t]=e.real,p[g*s+t]=e.imag}n.disposeIntermediateTensorInfo(e),n.disposeIntermediateTensorInfo(a),n.disposeIntermediateTensorInfo(r)}let h=n.makeTensorInfo(u,"float32",c),m=n.makeTensorInfo(u,"float32",p),f=fA({inputs:{real:h,imag:m},backend:n});return n.disposeIntermediateTensorInfo(h),n.disposeIntermediateTensorInfo(m),f}function CD(e,t,n){let a=Ns.sizeFromShape(e.shape),r=n.data.get(e.dataId),s=n.data.get(r.complexTensorInfos.real.dataId).values,i=n.data.get(r.complexTensorInfos.imag.dataId).values;if(function(e){return!(e&e-1)}(a)){let r=TD(s,i,a,t,n),o=[e.shape[0],e.shape[1]];if(t){let e=n.makeTensorInfo(o,"float32",r.real),t=n.makeTensorInfo(o,"float32",r.imag),s=n.makeTensorInfo([],"float32",Ns.createScalarValue(a,"float32")),i=bA({inputs:{x:s},backend:n}),l=ID.kernelFunc({inputs:{a:e,b:s},backend:n}),u=ID.kernelFunc({inputs:{a:t,b:i},backend:n}),d=n.data.get(l.dataId).values,c=n.data.get(u.dataId).values;return n.disposeIntermediateTensorInfo(e),n.disposeIntermediateTensorInfo(t),n.disposeIntermediateTensorInfo(s),n.disposeIntermediateTensorInfo(i),n.disposeIntermediateTensorInfo(l),n.disposeIntermediateTensorInfo(u),{real:d,imag:c}}return r}{let e=function(e,t,n){let a=new Float32Array(2*t);for(let r=0;r<t;r++){let s=0,i=0;for(let a=0;a<t;a++){let o=Uf.exponent(r*a,t,n),l=Uf.getComplexWithIndex(e,a);s+=l.real*o.real-l.imag*o.imag,i+=l.real*o.imag+l.imag*o.real}n&&(s/=t,i/=t),Uf.assignToTypedArray(a,s,i,r)}return a}(Uf.mergeRealAndImagArrays(s,i),a,t);return Uf.splitRealAndImagArrays(e)}}function TD(e,t,n,a,r){if(1===n)return{real:e,imag:t};let s=Uf.mergeRealAndImagArrays(e,t),i=n/2,o=Uf.complexWithEvenIndex(s),l=o.real,u=o.imag,d=[l.length],c=r.makeTensorInfo(d,"float32",l),p=r.makeTensorInfo(d,"float32",u),h=fA({inputs:{real:c,imag:p},backend:r}),m=Uf.complexWithOddIndex(s),f=m.real,g=m.imag,x=[f.length],b=r.makeTensorInfo(x,"float32",f),y=r.makeTensorInfo(x,"float32",g),w=fA({inputs:{real:b,imag:y},backend:r}),v=TD(l,u,i,a,r),k=v.real,N=v.imag,S=[k.length],I=r.makeTensorInfo(S,"float32",k),_=r.makeTensorInfo(S,"float32",N),C=fA({inputs:{real:I,imag:_},backend:r}),T=TD(f,g,i,a,r),E=T.real,A=T.imag,$=[E.length],R=r.makeTensorInfo($,"float32",E),F=r.makeTensorInfo($,"float32",A),D=fA({inputs:{real:R,imag:F},backend:r}),M=Uf.exponents(n,a),O=[M.real.length],j=r.makeTensorInfo(O,"float32",M.real),L=r.makeTensorInfo(O,"float32",M.imag),z=fA({inputs:{real:j,imag:L},backend:r}),P=$$({inputs:{a:z,b:D},backend:r}),B=EA({inputs:{a:C,b:P},backend:r}),W=ER({inputs:{a:C,b:P},backend:r}),V=wA({inputs:{input:B},backend:r}),U=wA({inputs:{input:W},backend:r}),G=DF({inputs:{input:B},backend:r}),H=DF({inputs:{input:W},backend:r}),q=OF({inputs:[V,U],backend:r,attrs:{axis:0}}),K=OF({inputs:[G,H],backend:r,attrs:{axis:0}}),X=r.data.get(q.dataId).values,Y=r.data.get(K.dataId).values;return r.disposeIntermediateTensorInfo(c),r.disposeIntermediateTensorInfo(p),r.disposeIntermediateTensorInfo(h),r.disposeIntermediateTensorInfo(b),r.disposeIntermediateTensorInfo(y),r.disposeIntermediateTensorInfo(w),r.disposeIntermediateTensorInfo(I),r.disposeIntermediateTensorInfo(_),r.disposeIntermediateTensorInfo(C),r.disposeIntermediateTensorInfo(R),r.disposeIntermediateTensorInfo(F),r.disposeIntermediateTensorInfo(D),r.disposeIntermediateTensorInfo(j),r.disposeIntermediateTensorInfo(L),r.disposeIntermediateTensorInfo(z),r.disposeIntermediateTensorInfo(P),r.disposeIntermediateTensorInfo(B),r.disposeIntermediateTensorInfo(W),r.disposeIntermediateTensorInfo(V),r.disposeIntermediateTensorInfo(G),r.disposeIntermediateTensorInfo(U),r.disposeIntermediateTensorInfo(H),r.disposeIntermediateTensorInfo(q),r.disposeIntermediateTensorInfo(K),{real:X,imag:Y}}var ED={kernelName:Jn,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{input:a}=t,r=Ns.sizeFromShape(a.shape),s=a.shape[a.shape.length-1],i=XR({inputs:{x:a},backend:n,attrs:{shape:[r/s,s]}}),o=_D(i,!1,n),l=XR({inputs:{x:o},backend:n,attrs:{shape:a.shape}});return n.disposeIntermediateTensorInfo(i),n.disposeIntermediateTensorInfo(o),l}};function AD(e){let{backend:t,attrs:n}=e,{shape:a,value:r,dtype:s}=n,i=s||Ns.inferDtype(r),o=Ns.getArrayFromDType(i,Ns.sizeFromShape(a));return function(e,t){e.fill(t)}(o,r),t.makeTensorInfo(a,i,o)}var $D={kernelName:Qn,backendName:"cpu",kernelFunc:AD},RD={kernelName:ea,backendName:"cpu",kernelFunc:({inputs:e,attrs:t,backend:n})=>{let{image:a}=e,r=n,s=Ns.getTypedArrayFromDType(a.dtype,Ns.sizeFromShape(a.shape)),[i,o,l,u]=a.shape,d=r.data.get(a.dataId).values;for(let c=0;c<i;c++){let e=c*l*o*u;for(let t=0;t<o;t++){let n=t*(l*u);for(let t=0;t<l;t++){let a=t*u;for(let r=0;r<u;r++){let i=Math.round(l-t-1),o=e+n+a+r,c=d[o];i>=0&&i<l&&(c=d[e+n+i*u+r]),s[o]=c}}}}return{dataId:r.write(s,a.shape,a.dtype),shape:a.shape,dtype:a.dtype}}},FD={kernelName:ls,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s,bias:i,preluActivationWeights:o}=t,{strides:l,pad:u,dataFormat:d,dilations:c,dimRoundingMode:p,activation:h,leakyreluAlpha:m}=a,f=LF({inputs:{x:r,filter:s},backend:n,attrs:{strides:l,pad:u,dataFormat:d,dilations:c,dimRoundingMode:p}});if(i){let e=f;if("NCHW"===d&&1===i.shape.length&&1!==i.shape[0]){let e=XR({inputs:{x:i},backend:n,attrs:{shape:[i.shape[0],1,1]}});f=EA({inputs:{a:f,b:e},backend:n}),n.disposeIntermediateTensorInfo(e)}else f=EA({inputs:{a:f,b:i},backend:n});n.disposeIntermediateTensorInfo(e)}if(h){let e=f;if("NCHW"===d&&"prelu"===h&&1===o.shape.length&&1!==o.shape[0]){let e=XR({inputs:{x:o},backend:n,attrs:{shape:[o.shape[0],1,1]}});f=KR(n,f,h,e,m),n.disposeIntermediateTensorInfo(e)}else f=KR(n,f,h,o,m);n.disposeIntermediateTensorInfo(e)}return f}},DD={kernelName:us,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s,bias:i,preluActivationWeights:o}=t,{strides:l,pad:u,dataFormat:d,dilations:c,dimRoundingMode:p,activation:h,leakyreluAlpha:m}=a,f=eD({inputs:{x:r,filter:s},backend:n,attrs:{strides:l,pad:u,dataFormat:d,dilations:c,dimRoundingMode:p}});if(i){let e=f;f=EA({inputs:{a:f,b:i},backend:n}),n.disposeIntermediateTensorInfo(e)}if(h){let e=f;f=KR(n,f,h,o,m),n.disposeIntermediateTensorInfo(e)}return f}},MD={kernelName:sa,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{params:a,indices:r}=t,s=Ns.sizeFromShape(a.shape),i=r.shape,o=i[i.length-1],[l,u,d,c]=Uf.prepareAndValidate(a,r);if(0===u)return n.makeTensorInfo(l,a.dtype,[]);let p=r$(n.data.get(r.dataId).values,n.bufferSync(a),a.dtype,u,o,d,c,a.shape,s);return n.makeTensorInfo(l,a.dtype,p.values)}},OD={kernelName:ra,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,indices:s}=t,{axis:i,batchDims:o}=a;lA([r,s],"gatherV2");let l=Ns.parseAxisParam(i,r.shape)[0],u=n.data.get(s.dataId).values,d=r.shape[l];for(let y=0;y<u.length;++y){let e=u[y];Ns.assert(e<=d-1&&e>=0,()=>`GatherV2: the index value ${e} is not in [0, ${d-1}]`)}let c=o;null==o&&(c=0);let p=Ns.sizeFromShape(s.shape),h=Uf.segment_util.collectGatherOpShapeInfo(r,s,l,c),m=XR({inputs:{x:r},backend:n,attrs:{shape:[h.batchSize,h.outerSize,h.dimSize,h.sliceSize]}}),f=XR({inputs:{x:s},backend:n,attrs:{shape:[h.batchSize,p/h.batchSize]}}),g=[h.batchSize,h.outerSize,p/h.batchSize,h.sliceSize],x=n.bufferSync(f),b=s$(n.bufferSync(m),x,g);return n.disposeIntermediateTensorInfo(m),n.disposeIntermediateTensorInfo(f),n.makeTensorInfo(h.outputShape,b.dtype,b.values)}},jD={kernelName:ua,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{input:a}=t,r=Ns.sizeFromShape(a.shape),s=a.shape[a.shape.length-1],i=XR({inputs:{x:a},backend:n,attrs:{shape:[r/s,s]}}),o=_D(i,!0,n),l=XR({inputs:{x:o},backend:n,attrs:{shape:a.shape}});return n.disposeIntermediateTensorInfo(i),n.disposeIntermediateTensorInfo(o),l}},LD=jA(ca,e=>Number.isFinite(e)?1:0,"bool"),zD={kernelName:ca,backendName:"cpu",kernelFunc:LD},PD=jA(pa,e=>Math.abs(e)===1/0?1:0,"bool"),BD={kernelName:pa,backendName:"cpu",kernelFunc:PD},WD=jA(ha,e=>Number.isNaN(e)?1:0,"bool"),VD={kernelName:ha,backendName:"cpu",kernelFunc:WD},UD={kernelName:xa,backendName:"cpu",kernelFunc:function(e){let{backend:t,attrs:n}=e,{start:a,stop:r,num:s}=n,i=b$(a,r,s);return t.makeTensorInfo([i.length],"float32",i)}},GD=jA(ya,e=>Math.log1p(e)),HD={kernelName:ya,backendName:"cpu",kernelFunc:GD},qD=mA((e,t)=>e&&t),KD=IA(wa,qD,null,"bool"),XD={kernelName:wa,backendName:"cpu",kernelFunc:KD},YD=jA(va,e=>e?0:1,"bool"),ZD={kernelName:va,backendName:"cpu",kernelFunc:YD},JD=mA((e,t)=>e||t),QD=IA(ka,JD,null,"bool"),eM={kernelName:ka,backendName:"cpu",kernelFunc:QD},tM={kernelName:_a,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{depthRadius:s,bias:i,alpha:o,beta:l}=a;lA(r,"LRN");let u=r.shape[3],d=u-1,c=n.data.get(r.dataId).values,p=Ns.sizeFromShape(r.shape),h=new Float32Array(p);function m(e){let t=e%u,n=e-t+Math.max(0,t-s),a=e-t+Math.min(t+s,d),r=0;for(;n<=a;n++){let e=c[n];r+=e*e}return r}for(let f=0;f<p;f++){let e=m(f),t=c[f]*Math.pow(i+o*e,-l);h[f]=t}return n.makeTensorInfo(r.shape,r.dtype,h)}},nM={kernelName:Ca,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,y:s,dy:i}=t,{depthRadius:o,bias:l,alpha:u,beta:d}=a;lA(i,"LRNGrad");let c=Ns.sizeFromShape(i.shape),p=i.shape[3],h=n.data.get(i.dataId).values,m=n.data.get(r.dataId).values,f=n.data.get(s.dataId).values,g=new Float32Array(c),x=c;for(let b=0;b<x;b++){let e=b%p,t=b-e+Math.max(0,e-o),n=b-e+Math.min(p,e+o+1),a=0;for(let r=t;r<n;r++)a+=Math.pow(m[r],2);a=u*a+l;for(let r=t;r<n;r++){let e=-2*u*d*m[r]*f[b]/a;b===r&&(e+=Math.pow(a,-d)),e*=h[b],g[r]+=e}}return n.makeTensorInfo(i.shape,r.dtype,g)}};function aM(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{reductionIndices:s,keepDims:i}=a,o=n,l=r.shape,u=l.length,d=Ns.parseAxisParam(s,l),c=d,p=Uf.getAxesPermutation(c,u),h=o.data.get(r.dataId).values;if(null!=p){let e=new Array(u);for(let t=0;t<e.length;t++)e[t]=l[p[t]];h=L$(h,l,r.dtype,p,e),c=Uf.getInnerMostAxes(c.length,u),l=e}lA(r,"max"),Uf.assertAxesAreInnerMostDims("max",c,u);let[m,f]=Uf.computeOutAndReduceShapes(l,c),g=k$(h,Ns.sizeFromShape(f),m,r.dtype),x=o.write(g,m,r.dtype),b=m;return i&&(b=Uf.expandShapeToKeepDim(m,d)),{dataId:x,shape:b,dtype:r.dtype}}var rM={kernelName:Ea,backendName:"cpu",kernelFunc:aM},sM={kernelName:$a,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t;lA(r,"maxPool");let{filterSize:s,strides:i,pad:o,dimRoundingMode:l}=a;Ns.assert(Uf.eitherStridesOrDilationsAreOne(i,1),()=>`Error in maxPool: Either strides or dilations must be 1. Got strides ${i} and dilations '1'`);let u,d=Uf.computePool2DInfo(r.shape,s,i,1,o,l);if(1===d.filterWidth&&1===d.filterHeight&&Ns.arraysEqual(d.inShape,d.outShape))u=bA({inputs:{x:r},backend:n});else{let e=n.data.get(r.dataId).values,t=Ns.computeStrides(r.shape),a=wF(e,r.shape,r.dtype,t,d,"max");u=n.makeTensorInfo(d.outShape,r.dtype,a.values)}return u}},iM={kernelName:Fa,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{filterSize:s,strides:i,pad:o,dimRoundingMode:l,dataFormat:u}=a;lA(r,"maxPool3d");let d=Uf.computePool3DInfo(r.shape,s,i,1,o,l,u),c=kF(n.data.get(r.dataId).values,r.shape,r.dtype,Ns.computeStrides(r.shape),d,"max");return n.makeTensorInfo(c.shape,"float32",c.values)}},oM={kernelName:Da,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s}=t,{filterSize:i,strides:o,pad:l,dimRoundingMode:u}=a;lA([r,s],"maxPool3DGrad");let d=Uf.computePool3DInfo(s.shape,i,o,1,l,u),c=function(e,t){let n=cl(t.outShape,"int32"),a=t.strideDepth,r=t.strideHeight,s=t.strideWidth,i=t.dilationDepth,o=t.dilationHeight,l=t.dilationWidth,u=t.effectiveFilterDepth,d=t.effectiveFilterHeight,c=t.effectiveFilterWidth,p=t.padInfo.front,h=t.padInfo.top,m=t.padInfo.left;for(let f=0;f<t.batchSize;++f)for(let g=0;g<t.inChannels;++g)for(let x=0;x<t.outDepth;++x){let b=x*a-p,y=b;for(;y<0;)y+=i;let w=Math.min(t.inDepth,u+b);for(let a=0;a<t.outHeight;++a){let u=a*r-h,p=u;for(;p<0;)p+=o;let v=Math.min(t.inHeight,d+u);for(let r=0;r<t.outWidth;++r){let h=r*s-m,k=h;for(;k<0;)k+=l;let N=Math.min(t.inWidth,c+h),S=Number.NEGATIVE_INFINITY,I=-1;for(let t=y;t<w;t+=i){let n=t-b;for(let a=p;a<v;a+=o){let r=a-u;for(let s=k;s<N;s+=l){let i=s-h,o=e.get(f,t,a,s,g);o>=S&&(S=o,I=n*d*c+r*d+i)}}}n.set(I,f,x,a,r,g)}}}return n}(n.bufferSync(s),d),p=d.strideDepth,h=d.strideHeight,m=d.strideWidth,f=d.dilationDepth,g=d.dilationHeight,x=d.dilationWidth,b=d.effectiveFilterDepth,y=d.effectiveFilterHeight,w=d.effectiveFilterWidth,v=b-1-d.padInfo.front,k=w-1-d.padInfo.left,N=y-1-d.padInfo.top,S=cl(s.shape,"float32"),I=n.bufferSync(r);for(let _=0;_<d.batchSize;++_)for(let e=0;e<d.inChannels;++e)for(let t=0;t<d.inDepth;++t)for(let n=0;n<d.inHeight;++n)for(let a=0;a<d.inWidth;++a){let r=t-v,s=n-N,i=a-k,o=0;for(let t=0;t<b;t+=f){let n=(r+t)/p;if(!(n<0||n>=d.outDepth||Math.floor(n)!==n))for(let a=0;a<y;a+=g){let r=(s+a)/h;if(!(r<0||r>=d.outHeight||Math.floor(r)!==r))for(let s=0;s<w;s+=x){let l=(i+s)/m;if(l<0||l>=d.outWidth||Math.floor(l)!==l)continue;let u=b*y*w-1-c.get(_,n,r,l,e)===t*y*w+a*w+s?1:0;0!==u&&(o+=I.get(_,n,r,l,e)*u)}}}S.set(o,_,t,n,a,e)}return n.makeTensorInfo(S.shape,S.dtype,S.values)}},lM={kernelName:Ra,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s,output:i}=t,o=s;lA([s,i],"maxPoolGrad");let{filterSize:l,strides:u,pad:d,dimRoundingMode:c}=a,p=Uf.computePool2DInfo(o.shape,l,u,1,d,c),h=n.data.get(o.dataId).values,m=cl(p.outShape,o.dtype,vF(h,o.shape,o.dtype,p).values),f=p.strideHeight,g=p.strideWidth,x=p.dilationHeight,b=p.dilationWidth,y=p.effectiveFilterHeight,w=p.effectiveFilterWidth,v=w-1-p.padInfo.left,k=y-1-p.padInfo.top,N=cl(o.shape,"float32"),S=n.data.get(r.dataId).values,I=cl(r.shape,"float32",S);for(let _=0;_<p.batchSize;++_)for(let e=0;e<p.inChannels;++e)for(let t=0;t<p.inHeight;++t)for(let n=0;n<p.inWidth;++n){let a=t-k,r=n-v,s=0;for(let t=0;t<y;t+=x){let n=(a+t)/f;if(!(n<0||n>=p.outHeight||Math.floor(n)!==n))for(let a=0;a<w;a+=b){let i=(r+a)/g;if(i<0||i>=p.outWidth||Math.floor(i)!==i)continue;let o=y*w-1-m.get(_,n,i,e)===t*w+a?1:0;0!==o&&(s+=I.get(_,n,i,e)*o)}}N.set(s,_,t,n,e)}return n.makeTensorInfo(N.shape,N.dtype,N.values)}},uM={kernelName:Ma,backendName:"cpu",kernelFunc:({inputs:e,attrs:t,backend:n})=>{let{x:a}=e,{filterSize:r,strides:s,pad:i,includeBatchInIndex:o}=t,l=n;lA(a,"MaxPoolWithArgmax");let u=l.data.get(a.dataId).values,d=Uf.computePool2DInfo(a.shape,r,s,[1,1],i),[c,p]=function(e,t,n,a,r){let s=wF(e,0,n,Ns.computeStrides(t),r,"max"),i=vF(e,t,n,r,!0,a);return[s.values,i.values]}(u,a.shape,a.dtype,o,d),h=l.write(c,d.outShape,a.dtype),m=l.write(p,d.outShape,a.dtype);return[{dataId:h,shape:d.outShape,dtype:a.dtype},{dataId:m,shape:d.outShape,dtype:"int32"}]}},dM={kernelName:Oa,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,keepDims:i}=a,o=Ns.parseAxisParam(s,r.shape),l=Uf.computeOutAndReduceShapes(r.shape,o)[1],u=Ns.sizeFromShape(l),d=[],c=n.makeTensorInfo([],"float32",new Float32Array([u]));d.push(c);let p=NA({inputs:{x:r},backend:n,attrs:{dtype:"float32"}});d.push(p);let h=SD({inputs:{a:p,b:c},backend:n});d.push(h);let m=uD({inputs:{x:h},backend:n,attrs:{axis:s,keepDims:i}});return d.forEach(e=>n.disposeIntermediateTensorInfo(e)),m}},cM={kernelName:ja,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,keepDims:i}=a;lA(r,"min");let o=Ns.parseAxisParam(s,r.shape),l=o,u=Uf.getAxesPermutation(l,r.shape.length),d=r;null!=u&&(d=z$({inputs:{x:r},backend:n,attrs:{perm:u}}),l=Uf.getInnerMostAxes(l.length,r.shape.length)),Uf.assertAxesAreInnerMostDims("min",l,d.shape.length);let[c,p]=Uf.computeOutAndReduceShapes(d.shape,l),h=Ns.sizeFromShape(p),m=Ns.makeZerosTypedArray(Ns.sizeFromShape(c),d.dtype),f=n.data.get(d.dataId).values;for(let x=0;x<m.length;++x){let e=x*h,t=f[e];for(let n=0;n<h;++n){let a=f[e+n];(Number.isNaN(a)||a<t)&&(t=a)}m[x]=t}null!=u&&n.disposeIntermediateTensorInfo(d);let g=n.makeTensorInfo(c,d.dtype,m);if(i){let e=XR({inputs:{x:g},backend:n,attrs:{shape:Uf.expandShapeToKeepDim(c,o)}});return n.disposeIntermediateTensorInfo(g),e}return g}},pM={kernelName:za,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{paddings:s,mode:i}=a;lA(r,"mirrorPad");let o=s.map((e,t)=>e[0]+r.shape[t]+e[1]),l=s.map(e=>e[0]),u=s.map((e,t)=>e[0]+r.shape[t]),d="reflect"===i?0:1,c=n.data.get(r.dataId).values,p=r.shape.length,h=Ns.computeStrides(r.shape),m=Ns.sizeFromShape(o),f=o.length,g=Ns.computeStrides(o),x=Ns.getTypedArrayFromDType(r.dtype,m);for(let b=0;b<m;b++){let e=Ns.indexToLoc(b,f,g);for(let n=0;n<f;n++)e[n]<l[n]?e[n]=2*l[n]-e[n]-d:e[n]>=u[n]&&(e[n]=2*(u[n]-1)-e[n]+d);e=e.map((e,t)=>e-l[t]);let t=Ns.locToIndex(e,p,h);x[b]=c[t]}return{dataId:n.write(x,o,r.dtype),shape:o,dtype:r.dtype}}},hM=mA((e,t)=>{let n=e%t;return e<0&&t<0||e>=0&&t>=0?n:(n+t)%t}),mM=IA(Pa,hM),fM={kernelName:Pa,backendName:"cpu",kernelFunc:mM},gM=be(Ae());function xM(e){let{inputs:t,backend:n,attrs:a}=e,{logits:r}=t,{dim:s}=a,i=r.shape.length,o=s;if(-1===o&&(o=i-1),o!==i-1)throw Error(`Softmax along a non-last dimension is not yet supported. Logits was rank ${i} and dim was ${o}`);let l=Ns.parseAxisParam([o],r.shape),u=aM({inputs:{x:r},backend:n,attrs:{reductionIndices:l,keepDims:!1}}),d=Uf.expandShapeToKeepDim(u.shape,l),c=XR({inputs:{x:u},backend:n,attrs:{shape:d}}),p=ER({inputs:{a:r,b:c},backend:n}),h=qA({inputs:{x:p},backend:n}),m=uD({inputs:{x:h},backend:n,attrs:{axis:l,keepDims:!1}}),f=XR({inputs:{x:m},backend:n,attrs:{shape:d}}),g=SD({inputs:{a:h,b:f},backend:n});return n.disposeIntermediateTensorInfo(u),n.disposeIntermediateTensorInfo(c),n.disposeIntermediateTensorInfo(p),n.disposeIntermediateTensorInfo(h),n.disposeIntermediateTensorInfo(m),n.disposeIntermediateTensorInfo(f),g}var bM={kernelName:Fr,backendName:"cpu",kernelFunc:xM},yM={kernelName:Ba,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{logits:r}=t,{numSamples:s,seed:i,normalized:o}=a;lA(r,"multinomial");let l=o?r:xM({inputs:{logits:r},backend:n,attrs:{dim:-1}}),u=l.shape[0],d=l.shape[1],c=n.data.get(l.dataId).values,p=[u,s],h=Ns.makeZerosTypedArray(Ns.sizeFromShape(p),"int32");for(let m=0;m<u;++m){let e=m*d,t=new Float32Array(d-1);t[0]=c[e];for(let r=1;r<t.length;++r)t[r]=t[r-1]+c[e+r];let n=gM.alea(i.toString()),a=m*s;for(let r=0;r<s;++r){let e=n();h[a+r]=t.length;for(let n=0;n<t.length;n++)if(e<t[n]){h[a+r]=n;break}}}return o||n.disposeIntermediateTensorInfo(l),n.makeTensorInfo(p,"int32",h)}},wM=Yg.nonMaxSuppressionV3Impl,vM={kernelName:Ga,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{boxes:r,scores:s}=t,{maxOutputSize:i,iouThreshold:o,scoreThreshold:l}=a;lA(r,"NonMaxSuppression");let u=n.data.get(r.dataId).values,d=n.data.get(s.dataId).values,{selectedIndices:c}=wM(u,d,i,o,l);return n.makeTensorInfo([c.length],"int32",new Int32Array(c))}},kM=Yg.nonMaxSuppressionV4Impl,NM={kernelName:Ha,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{boxes:r,scores:s}=t,{maxOutputSize:i,iouThreshold:o,scoreThreshold:l,padToMaxOutputSize:u}=a;lA(r,"NonMaxSuppressionPadded");let d=n.data.get(r.dataId).values,c=n.data.get(s.dataId).values,{selectedIndices:p,validOutputs:h}=kM(d,c,i,o,l,u);return[n.makeTensorInfo([p.length],"int32",new Int32Array(p)),n.makeTensorInfo([],"int32",new Int32Array([h]))]}},SM=Yg.nonMaxSuppressionV5Impl,IM={kernelName:qa,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{boxes:r,scores:s}=t,{maxOutputSize:i,iouThreshold:o,scoreThreshold:l,softNmsSigma:u}=a;lA(r,"NonMaxSuppressionWithScore");let d=n.data.get(r.dataId).values,c=n.data.get(s.dataId).values,p=i,h=o,m=l,f=u,{selectedIndices:g,selectedScores:x}=SM(d,c,p,h,m,f);return[n.makeTensorInfo([g.length],"int32",new Int32Array(g)),n.makeTensorInfo([x.length],"float32",new Float32Array(x))]}},_M={kernelName:Xa,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{indices:r}=t,{dtype:s,depth:i,onValue:o,offValue:l}=a;lA(r,"oneHot");let u=Ns.sizeFromShape(r.shape),d=new Float32Array(u*i);d.fill(l);let c=n.data.get(r.dataId).values;for(let p=0;p<u;++p)c[p]>=0&&c[p]<i&&(d[p*i+c[p]]=o);return n.makeTensorInfo([...r.shape,i],s,d)}};function CM(e){let{inputs:t,backend:n}=e,{x:a}=t;if("string"===a.dtype)throw new Error("zerosLike is not supported for string tensors");if("complex64"===a.dtype){let e=wA({inputs:{input:a},backend:n}),t=CM({inputs:{x:e},backend:n}),r=DF({inputs:{input:a},backend:n}),s=CM({inputs:{x:r},backend:n}),i=fA({inputs:{real:t,imag:s},backend:n});return n.disposeIntermediateTensorInfo(e),n.disposeIntermediateTensorInfo(t),n.disposeIntermediateTensorInfo(r),n.disposeIntermediateTensorInfo(s),i}return AD({backend:n,attrs:{shape:a.shape,value:0,dtype:a.dtype}})}var TM={kernelName:as,backendName:"cpu",kernelFunc:CM},EM={kernelName:Ka,backendName:"cpu",kernelFunc:function e(t){let{inputs:n,backend:a}=t,{x:r}=n;if("string"===r.dtype)throw new Error("onesLike is not supported for string tensors");if("complex64"===r.dtype){let t=wA({inputs:{input:r},backend:a}),n=e({inputs:{x:t},backend:a}),s=DF({inputs:{input:r},backend:a}),i=CM({inputs:{x:s},backend:a}),o=fA({inputs:{real:n,imag:i},backend:a});return a.disposeIntermediateTensorInfo(t),a.disposeIntermediateTensorInfo(n),a.disposeIntermediateTensorInfo(s),a.disposeIntermediateTensorInfo(i),o}return AD({backend:a,attrs:{shape:r.shape,value:1,dtype:r.dtype}})}};function AM(e){let{inputs:t,backend:n,attrs:a}=e,{axis:r}=a;if(1===t.length)return vD({inputs:{input:t[0]},backend:n,attrs:{dim:r}});let s=t[0].shape,i=t[0].dtype;t.forEach(e=>{Ns.assertShapesMatch(s,e.shape,"All tensors passed to stack must have matching shapes"),Ns.assert(i===e.dtype,()=>"All tensors passed to stack must have matching dtypes")});let o=[],l=OF({inputs:t.map(e=>{let t=vD({inputs:{input:e},backend:n,attrs:{dim:r}});return o.push(t),t}),backend:n,attrs:{axis:r}});return o.forEach(e=>n.disposeIntermediateTensorInfo(e)),l}var $M={kernelName:Ya,backendName:"cpu",kernelFunc:AM},RM={kernelName:Za,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{paddings:s,constantValue:i}=a;lA(r,"pad");let o=s.map((e,t)=>e[0]+r.shape[t]+e[1]),l=s.map(e=>e[0]),u=n.data.get(r.dataId).values,d=Ns.sizeFromShape(r.shape),c=r.shape.length,p=Ns.computeStrides(r.shape),h=Ns.sizeFromShape(o),m=o.length,f=Ns.computeStrides(o),g=Ns.getTypedArrayFromDType(r.dtype,h);0!==i&&g.fill(i);for(let x=0;x<d;x++){let e=Ns.indexToLoc(x,c,p).map((e,t)=>e+l[t]);g[Ns.locToIndex(e,m,f)]=u[x]}return{dataId:n.write(g,o,r.dtype),shape:o,dtype:r.dtype}}},FM=mA((e,t)=>Math.pow(e,t)),DM=IA(Qa,FM),MM={kernelName:Qa,backendName:"cpu",kernelFunc:DM},OM={kernelName:nr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{paramsNestedSplits:r,paramsDenseValues:s,indices:i}=t,{outputRaggedRank:o}=a,l=r.map(e=>n.data.get(e.dataId).values),u=r.map(e=>e.shape),d=n.data.get(s.dataId).values,c=n.data.get(i.dataId).values,[p,h,m]=U$(l,u,d,s.shape,s.dtype,c,i.shape),f=p.map(e=>n.makeTensorInfo([e.length],"int32",e)),g=n.makeTensorInfo(m,s.dtype,h);return f.concat([g])}},jM={kernelName:ar,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{starts:a,limits:r,deltas:s}=t,i=n.data.get(a.dataId).values,o=n.data.get(r.dataId).values,l=n.data.get(s.dataId).values,[u,d]=H$(i,a.shape,a.dtype,o,r.shape,l,s.shape);return[n.makeTensorInfo([u.length],"int32",u),n.makeTensorInfo([d.length],a.dtype,d)]}},LM={kernelName:rr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{shape:r,values:s,defaultValue:i,rowPartitionTensors:o}=t,{rowPartitionTypes:l}=a,u=n.data.get(r.dataId).values,d=n.data.get(s.dataId).values,c=n.data.get(i.dataId).values,p=o.map(e=>n.data.get(e.dataId).values),h=o.map(e=>e.shape),[m,f]=Z$(u,r.shape,d,s.shape,s.dtype,c,i.shape,p,h,l);return n.makeTensorInfo(m,s.dtype,f)}},zM={kernelName:sr,backendName:"cpu",kernelFunc:function(e){let{backend:t,attrs:n}=e,{start:a,stop:r,dtype:s,step:i}=n,o=J$(a,r,i,s);return t.makeTensorInfo([o.length],s,o)}},PM=jA(or,e=>1/e),BM={kernelName:or,backendName:"cpu",kernelFunc:PM},WM={kernelName:pr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{images:r}=t,{alignCorners:s,halfPixelCenters:i,size:o}=a;lA(r,"resizeBilinear");let l=Ns.computeStrides(r.shape),[u,d]=o,[c,p,h,m]=r.shape,f=n.data.get(r.dataId).values,g=new Float32Array(Ns.sizeFromShape([c,u,d,m])),x=[s&&u>1?p-1:p,s&&d>1?h-1:h],b=[s&&u>1?u-1:u,s&&d>1?d-1:d],y=0,w=x[0]/b[0],v=x[1]/b[1];for(let k=0;k<c;k++)for(let e=0;e<u;e++){let t;t=i?w*(e+.5)-.5:w*e;let n=Math.max(0,Math.floor(t)),a=t-n,r=Math.min(p-1,Math.ceil(t)),s=k*l[0]+n*l[1],o=k*l[0]+r*l[1];for(let e=0;e<d;e++){let t;t=i?v*(e+.5)-.5:v*e;let n=Math.max(0,Math.floor(t)),r=t-n,u=Math.min(h-1,Math.ceil(t)),d=s+n*l[2],c=o+n*l[2],p=s+u*l[2],x=o+u*l[2];for(let e=0;e<m;e++){let t=f[d+e],n=f[c+e],s=t+(f[p+e]-t)*r,i=s+(n+(f[x+e]-n)*r-s)*a;g[y++]=i}}}return n.makeTensorInfo([c,u,d,m],"float32",g)}},VM={kernelName:hr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{images:r,dy:s}=t,{alignCorners:i}=a;lA([s,r],"resizeBilinearGrad");let o=Ns.computeStrides(r.shape),[l,u,d,c]=r.shape,[,p,h]=s.shape,m=new Float32Array(l*u*d*c),f=[i&&p>1?u-1:u,i&&h>1?d-1:d],g=[i&&p>1?p-1:p,i&&h>1?h-1:h],x=f[0]/g[0],b=f[1]/g[1],y=n.data.get(s.dataId).values,w=0;for(let v=0;v<l;v++){let e=v*o[0];for(let t=0;t<p;t++){let n=t*x,a=Math.floor(n),r=Math.min(Math.ceil(n),u-1),s=e+a*o[1],i=e+r*o[1],l=n-a,p=1-l;for(let e=0;e<h;e++){let t=e*b,n=Math.floor(t),a=Math.min(Math.ceil(t),d-1),r=t-n,u=1-r,h=s+n*o[2],f=s+a*o[2],g=i+n*o[2],x=i+a*o[2],v=p*u,k=p*r,N=l*u,S=l*r;for(let e=0;e<c;e++){let t=y[w++];m[h+e]+=t*v,m[f+e]+=t*k,m[g+e]+=t*N,m[x+e]+=t*S}}}}return n.makeTensorInfo([l,d,u,c],"float32",m)}},UM={kernelName:dr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{images:r}=t,{alignCorners:s,halfPixelCenters:i,size:o}=a;lA(r,"resizeNearestNeighbor");let l=Ns.computeStrides(r.shape),[u,d]=o,[c,p,h,m]=r.shape,f=n.data.get(r.dataId).values,g=new Float32Array(c*u*d*m),x=[s&&u>1?p-1:p,s&&d>1?h-1:h],b=[s&&u>1?u-1:u,s&&d>1?d-1:d],y=x[0]/b[0],w=x[1]/b[1],v=0;for(let k=0;k<c;k++){let e=k*l[0];for(let t=0;t<u;t++){let n=i?y*(t+.5):y*t,a=Math.min(p-1,s?Math.round(n):Math.floor(n));i&&(a=Math.max(0,a));let r=e+a*l[1];for(let e=0;e<d;e++){let t=i?w*(e+.5):w*e,n=Math.min(h-1,s?Math.round(t):Math.floor(t));i&&(n=Math.max(0,n));let a=r+n*l[2];for(let e=0;e<m;e++){let t=f[a+e];g[v++]=t}}}}return n.makeTensorInfo([c,u,d,m],r.dtype,g)}},GM={kernelName:cr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{images:r,dy:s}=t,{alignCorners:i}=a;lA([s,r],"resizeNearestNeighborGrad");let o=Ns.computeStrides(r.shape),l=Ns.computeStrides(s.shape),[u,d,c,p]=r.shape,[,h,m]=s.shape,f=new Float32Array(u*d*c*p),g=n.data.get(s.dataId).values,x=[i&&h>1?d-1:d,i&&m>1?c-1:c],b=[i&&h>1?h-1:h,i&&m>1?m-1:m],y=x[0]/b[0],w=x[1]/b[1],v=1/y,k=1/w,N=2*Math.ceil(v)+2,S=2*Math.ceil(k)+2;for(let I=0;I<u;I++){let e=I*o[0];for(let t=0;t<d;t++){let n=e+t*o[1],a=Math.floor(t*v),r=Math.floor(a-N/2);for(let s=0;s<c;s++){let a=n+s*o[2],u=Math.floor(s*k),x=Math.floor(u-S/2);for(let n=0;n<p;n++){let o=0;for(let a=0;a<N;a++){let u=a+r;if(u<0||u>=h)continue;let p=e+u*l[1],f=u*y;if(t===Math.min(d-1,i?Math.round(f):Math.floor(f)))for(let e=0;e<S;e++){let t=e+x;if(t<0||t>=m)continue;let a=p+t*l[2],r=t*w;s===Math.min(c-1,i?Math.round(r):Math.floor(r))&&(o+=g[a+n])}}f[a+n]=o}}}}return n.makeTensorInfo(r.shape,r.dtype,f)}},HM={kernelName:fr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{dims:s}=a;lA(r,"reverse");let i=r.shape.length,o=Ns.parseAxisParam(s,r.shape);if(0===i)return bA({inputs:{x:r},backend:n});let l=new ti(r.shape,r.dtype),u=n.bufferSync(r);for(let d=0;d<l.size;d++){let e=l.indexToLoc(d),t=e.slice();o.forEach(e=>t[e]=r.shape[e]-1-t[e]),l.set(u.get(...t),...e)}return n.makeTensorInfo(l.shape,l.dtype,l.values)}},qM={kernelName:is,backendName:"cpu",kernelFunc:({inputs:e,attrs:t,backend:n})=>{let{image:a}=e,{radians:r,fillValue:s,center:i}=t,o=n,l=Ns.getTypedArrayFromDType(a.dtype,Ns.sizeFromShape(a.shape)),[u,d,c,p]=a.shape,[h,m]=Uf.getImageCenter(i,d,c),f=Math.sin(r),g=Math.cos(r),x=o.data.get(a.dataId).values;for(let b=0;b<u;b++){let e=b*c*d*p;for(let t=0;t<d;t++){let n=t*(c*p);for(let a=0;a<c;a++){let r=a*p;for(let i=0;i<p;i++){let o=[u,t,a,i],b=o[2],y=o[1],w=(b-h)*g-(y-m)*f,v=(b-h)*f+(y-m)*g;w=Math.round(w+h),v=Math.round(v+m);let k=s;"number"!=typeof s&&(k=3===i?255:s[i]),w>=0&&w<c&&v>=0&&v<d&&(k=x[e+v*(c*p)+w*p+i]),l[e+n+r+i]=k}}}}return{dataId:o.write(l,a.shape,a.dtype),shape:a.shape,dtype:a.dtype}}},KM=jA(gr,e=>{let t=Math.floor(e);return e-t<.5?Math.floor(e):e-t>.5?Math.ceil(e):t%2==0?t:t+1}),XM={kernelName:gr,backendName:"cpu",kernelFunc:KM},YM={kernelName:br,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{indices:r,updates:s}=t,{shape:i}=a,{sliceRank:o,numUpdates:l,sliceSize:u,strides:d,outputSize:c}=Uf.calculateShapes(s,r,i),p=nR(n.bufferSync(r),n.bufferSync(s),i,c,u,l,o,d,0,!0);return n.makeTensorInfo(i,p.dtype,p.values)}};function ZM(e,t){let n=0,a=e.length,r=0;for(;n<a;)r=Math.floor((n+a)/2),e[r]<t?n=r+1:a=r;return a}function JM(e,t){let n=0,a=e.length,r=0;for(;n<a;)r=Math.floor((n+a)/2),e[r]<=t?n=r+1:a=r;return a}var QM={kernelName:wr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{sortedSequence:r,values:s}=t,{side:i}=a,o=function(e,t,n,a,r,s){let i=Ns.getArrayFromDType("int32",n*r);for(let o=0;o<n;++o){let n=e.slice(o*a,(o+1)*a),l=o*r;for(let e=0;e<r;++e)i[l+e]="left"===s?ZM(n,t[e+l]):JM(n,t[e+l])}return i}(n.data.get(r.dataId).values,n.data.get(s.dataId).values,r.shape[0],r.shape[1],s.shape[1],i);return n.makeTensorInfo(s.shape,"int32",o)}},eO={kernelName:vr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{condition:a,t:r,e:s}=t;lA([a,r,s],"select");let i=a.shape.length,o=n.data.get(a.dataId).values,l=n.data.get(r.dataId).values,u=n.data.get(s.dataId).values,d=mi(r.dtype,s.dtype),c=Ns.makeZerosTypedArray(Ns.sizeFromShape(r.shape),d),p=0,h=0===i||i>1||1===r.shape.length?1:Ns.sizeFromShape(r.shape.slice(1));for(let m=0;m<o.length;m++)for(let e=0;e<h;e++)1===o[m]?c[p++]=l[m]:c[p++]=u[m];return n.makeTensorInfo(r.shape,d,c)}},tO=Uf.SELU_SCALEALPHA,nO=Uf.SELU_SCALE,aO=jA(kr,e=>e>=0?nO*e:tO*(Math.exp(e)-1)),rO={kernelName:kr,backendName:"cpu",kernelFunc:aO},sO=jA(_r,e=>e<0?-1:e>0?1:0),iO={kernelName:_r,backendName:"cpu",kernelFunc:sO},oO=jA(Sr,e=>Math.sin(e)),lO={kernelName:Sr,backendName:"cpu",kernelFunc:oO},uO=jA(Ir,e=>Math.sinh(e)),dO={kernelName:Ir,backendName:"cpu",kernelFunc:uO},cO=Math.log(1.1920928955078125e-7)+2,pO=jA(Tr,e=>{let t,n=e>-cO,a=e<cO,r=Math.exp(e);return t=a?r:n?e:Math.log(1+r),t}),hO={kernelName:Tr,backendName:"cpu",kernelFunc:pO},mO={kernelName:$r,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{blockShape:s,paddings:i}=a;lA([r],"spaceToBatchND");let o=Ns.sizeFromShape(s),l=[[0,0]];l.push(...i);for(let g=1+s.length;g<r.shape.length;++g)l.push([0,0]);let u=RM.kernelFunc({inputs:{x:r},backend:n,attrs:{paddings:l,constantValue:0}}),d=Uf.getReshaped(u.shape,s,o,!1),c=Uf.getPermuted(d.length,s.length,!1),p=Uf.getReshapedPermuted(u.shape,s,o,!1),h=XR({inputs:{x:u},backend:n,attrs:{shape:d}}),m=z$({inputs:{x:h},backend:n,attrs:{perm:c}}),f=XR({inputs:{x:m},backend:n,attrs:{shape:p}});return n.disposeIntermediateTensorInfo(u),n.disposeIntermediateTensorInfo(h),n.disposeIntermediateTensorInfo(m),f}},fO={kernelName:Dr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{indices:a,values:r,denseShape:s,defaultValue:i}=t;if(1!==s.shape.length)throw new Error(`Dense shape must be a vector, saw:\n        ${s.shape}`);if(2!==a.shape.length)throw new Error(`Indices must be a matrix, saw:\n        ${a.shape}`);if(1!==r.shape.length)throw new Error(`Values must be a vector, saw:\n        ${r.shape}`);if(0!==i.shape.length)throw new Error(`Default value must be a scalar, saw:\n        ${i.shape}`);let o=n.data.get(a.dataId).values,l=n.data.get(r.dataId).values,u=n.data.get(s.dataId).values,d=n.data.get(i.dataId).values[0],[c,p,h,m,f]=uR(o,a.shape,a.dtype,l,r.dtype,u,d);return[n.makeTensorInfo(p,a.dtype,c),n.makeTensorInfo([p[0]],r.dtype,h),n.makeTensorInfo([m.length],"bool",new Uint8Array(m.map(e=>Number(e)))),n.makeTensorInfo([f.length],a.dtype,new Int32Array(f))]}},gO={kernelName:Mr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{inputIndices:a,inputShape:r,newShape:s}=t;if(2!==a.shape.length)throw new Error(`Input indices should be a matrix but received shape\n        ${a.shape}`);if(1!==r.shape.length)throw new Error(`Input shape should be a vector but received shape\n        ${r.shape}`);if(1!==s.shape.length)throw new Error(`Target shape should be a vector but received shape ${s.shape}`);let i=Array.from(n.data.get(r.dataId).values),o=n.data.get(a.dataId).values,l=Array.from(n.data.get(s.dataId).values),[u,d,c]=dR(o,a.shape,a.dtype,i,l);return[n.makeTensorInfo(d,a.dtype,u),n.makeTensorInfo([c.length],s.dtype,new Int32Array(c))]}},xO={kernelName:Or,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{data:a,indices:r,segmentIds:s}=t;if(a.shape.length<1)throw new Error("Data should be at least 1 dimensional but received scalar");if(1!==r.shape.length)throw new Error(`Indices should be a vector but received shape\n          ${r.shape}`);if(1!==s.shape.length)throw new Error(`Segment ids should be a vector but received shape\n          ${s.shape}`);if(r.shape[0]!==s.shape[0])throw new Error("segmentIds and indices should have same size.");let i=n.data.get(a.dataId).values,o=n.data.get(r.dataId).values,l=n.data.get(s.dataId).values,[u,d]=cR(i,a.shape,a.dtype,o,l,!0);return n.makeTensorInfo(d,a.dtype,u)}},bO={kernelName:jr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{data:a,indices:r,segmentIds:s}=t;if(a.shape.length<1)throw new Error("Data should be at least 1 dimensional but received scalar");if(1!==r.shape.length)throw new Error(`Indices should be a vector but received shape\n         ${r.shape}`);if(1!==s.shape.length)throw new Error(`Segment ids should be a vector but received shape\n         ${s.shape}`);if(r.shape[0]!==s.shape[0])throw new Error("segmentIds and indices should have same size.");let i=n.data.get(a.dataId).values,o=n.data.get(r.dataId).values,l=n.data.get(s.dataId).values,[u,d]=cR(i,a.shape,a.dtype,o,l);return n.makeTensorInfo(d,a.dtype,u)}},yO={kernelName:Lr,backendName:"cpu",kernelFunc:function(e){let t,{inputs:n,backend:a,attrs:r}=e,{sparseIndices:s,sparseValues:i,defaultValue:o}=n,{outputShape:l}=r,{sliceRank:u,numUpdates:d,sliceSize:c,strides:p,outputSize:h}=Uf.calculateShapes(i,s,l),m=!1,f=a.bufferSync(s);switch(i.dtype){case"bool":t=nR(f,a.bufferSync(i),l,h,c,d,u,p,!!a.data.get(o.dataId).values[0],m);break;case"float32":case"int32":t=nR(f,a.bufferSync(i),l,h,c,d,u,p,a.data.get(o.dataId).values[0],m);break;case"string":t=nR(f,a.bufferSync(i),l,h,c,d,u,p,Ns.decodeString(a.data.get(o.dataId).values[0]),m);break;default:throw new Error(`Unsupported type ${i.dtype}`)}return a.makeTensorInfo(l,t.dtype,t.values)}},wO={kernelName:Rr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{numOrSizeSplits:s,axis:i}=a,o=Ns.parseAxisParam(i,r.shape)[0],l=Uf.prepareSplitSize(r,s,o),u=new Array(r.shape.length).fill(0),d=r.shape.slice();return l.map(e=>{let t=[...d];t[o]=e;let a=oR({inputs:{x:r},backend:n,attrs:{begin:u,size:t}});return u[o]+=e,a})}},vO={kernelName:Pr,backendName:"cpu",kernelFunc:({inputs:e,backend:t})=>{let{x:n}=e,a=t;lA(n,"square");let r=a.data.get(n.dataId).values,s=new Float32Array(r.length);for(let i=0;i<r.length;++i){let e=r[i];s[i]=e*e}return{dataId:a.write(s,n.shape,n.dtype),shape:n.shape,dtype:n.dtype}}},kO=jA(rs,(e,t)=>{let n=t;return isNaN(e)?NaN:e>0?1:n.alpha}),NO={kernelName:rs,backendName:"cpu",kernelFunc:kO},SO={kernelName:Wr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{begin:s,end:i,strides:o,beginMask:l,endMask:u,ellipsisMask:d,newAxisMask:c,shrinkAxisMask:p}=a;lA(r,"stridedSlice");let h,{finalShapeSparse:m,finalShape:f,isIdentity:g,sliceDim0:x,isSimpleSlice:b,begin:y,end:w,strides:v}=bf.sliceInfo(r.shape,s,i,o,l,u,d,c,p);if(g)h=XR({inputs:{x:r},backend:n,attrs:{shape:f}});else if(x||b){Ns.assert(r.shape.length>=1,()=>`Input must have rank at least 1, got: ${r.shape.length}`);let e=bf.computeOutShape(y,w,v),t=oR({inputs:{x:r},backend:n,attrs:{begin:y,size:e}});h=XR({inputs:{x:t},backend:n,attrs:{shape:f}}),n.disposeIntermediateTensorInfo(t)}else{let e=vR(m,n.bufferSync(r),v,y);h=n.makeTensorInfo(f,e.dtype,e.values)}return h}},IO={kernelName:Vr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{separator:r,nGramWidths:s,leftPad:i,rightPad:o,padWidth:l,preserveShortSequences:u}=a,{data:d,dataSplits:c}=t,p=n.data.get(d.dataId).values,h=n.data.get(c.dataId).values,[m,f]=NR(p,h,r,s,i,o,l,u);return[n.makeTensorInfo([m.length],"string",m),n.makeTensorInfo(c.shape,"int32",f)]}},_O={kernelName:Ur,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{skipEmpty:r}=a,{input:s,delimiter:i}=t;if("string"!==s.dtype)throw new Error("Input must be of datatype string");if(1!==s.shape.length)throw new Error(`Input must be a vector, got shape: ${s.shape}`);if(0!==i.shape.length)throw new Error(`Delimiter must be a scalar, got shape: ${i.shape}`);let o=n.data.get(s.dataId).values,l=n.data.get(i.dataId).values[0],[u,d,c]=IR(o,l,r),p=d.length;return[n.makeTensorInfo([p,2],"int32",u),n.makeTensorInfo([p],"string",d),n.makeTensorInfo([2],"int32",new Int32Array(c))]}},CO={kernelName:Gr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{numBuckets:r}=a,{input:s}=t;if("string"!==s.dtype)throw new Error("Input must be of datatype string");if(r<=0)throw new Error("Number of buckets must be at least 1");let i=_R(n.data.get(s.dataId).values,r);return n.makeTensorInfo(s.shape,"int32",i)}},TO=jA(qr,e=>Math.tan(e)),EO={kernelName:qr,backendName:"cpu",kernelFunc:TO},AO=jA(Kr,e=>Math.tanh(e)),$O={kernelName:yr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n}=e,{tensor:a,indices:r,updates:s}=t,{sliceRank:i,numUpdates:o,sliceSize:l,strides:u,outputSize:d}=Uf.calculateShapes(s,r,a.shape),c=n.bufferSync(r),p=n.bufferSync(s),h=n.bufferSync(a),m=nR(c,p,a.shape,d,l,o,i,u,h,!1);return n.makeTensorInfo(a.shape,m.dtype,m.values)}},RO={kernelName:Xr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{reps:s}=a;lA(r,"tile");let i=$R(n.bufferSync(r),s);return n.makeTensorInfo(i.shape,i.dtype,i.values)}},FO={kernelName:Yr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{k:s,sorted:i}=a;lA(r,"topk");let o=n.data.get(r.dataId).values,[l,u]=DR(o,r.shape,r.dtype,s,i);return[n.makeTensorInfo(l.shape,l.dtype,l.values),n.makeTensorInfo(u.shape,u.dtype,u.values)]}},DO={kernelName:Zr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,{image:r,transforms:s}=t,{interpolation:i,fillMode:o,fillValue:l,outputShape:u}=n,[d,c,p,h]=r.shape,[m,f]=null!=u?u:[c,p],g=[d,m,f,h],x=Ns.computeStrides(r.shape),b=x[0],y=x[1],w=x[2],v=Ns.computeStrides(g),k=v[0],N=v[1],S=v[2],I=Ns.getTypedArrayFromDType(r.dtype,Ns.sizeFromShape(g));I.fill(l);let _=a.data.get(r.dataId).values,C=a.data.get(s.dataId).values;for(let T=0;T<d;++T){let e=1===s.shape[0]?C:C.subarray(8*T,8*T+8);for(let t=0;t<m;++t)for(let n=0;n<f;++n)for(let a=0;a<h;++a){let r,s=e[6]*n+e[7]*t+1;if(0===s)continue;let u=(e[0]*n+e[1]*t+e[2])/s,d=(e[3]*n+e[4]*t+e[5])/s,h=MO(u,p,o),m=MO(d,c,o);switch(i){case"nearest":r=jO(_,c,p,b,y,w,T,m,h,a,l);break;case"bilinear":r=LO(_,c,p,b,y,w,T,m,h,a,l);break;default:throw new Error(`Error in Transform: Expect 'nearest' or 'bilinear', but got ${i}`)}I[T*k+t*N+n*S+a]=r}return a.makeTensorInfo(g,r.dtype,I)}return{dataId:a.write(I,g,r.dtype),shape:r.shape,dtype:r.dtype}}};function MO(e,t,n){switch(n){case"reflect":return function(e,t){let n=e;if(n<0)if(t<=1)n=0;else{let e=2*t;n<e&&(n=e*Math.trunc(-n/e)+n),n=n<-t?n+e:-n-1}else if(n>t-1)if(t<=1)n=0;else{let e=2*t;n-=e*Math.trunc(n/e),n>=t&&(n=e-n-1)}return Ns.clamp(0,n,t-1)}(e,t);case"wrap":return function(e,t){let n=e;if(n<0)if(t<=1)n=0;else{let e=t-1;n+=t*(Math.trunc(-n/e)+1)}else if(n>t-1)if(t<=1)n=0;else{let e=t-1;n-=t*Math.trunc(n/e)}return Ns.clamp(0,n,t-1)}(e,t);case"nearest":return function(e,t){return Ns.clamp(0,e,t-1)}(e,t);default:return e}}function OO(e,t,n,a,r,s,i,o,l,u,d){return 0<=o&&o<t&&0<=l&&l<n?e[i*a+o*r+l*s+u]:d}function jO(e,t,n,a,r,s,i,o,l,u,d){return OO(e,t,n,a,r,s,i,Math.round(o),Math.round(l),u,d)}function LO(e,t,n,a,r,s,i,o,l,u,d){let c=Math.floor(o),p=Math.floor(l),h=c+1,m=p+1;return(h-o)*((m-l)*OO(e,t,n,a,r,s,i,c,p,u,d)+(l-p)*OO(e,t,n,a,r,s,i,c,m,u,d))+(o-c)*((m-l)*OO(e,t,n,a,r,s,i,h,p,u,d)+(l-p)*OO(e,t,n,a,r,s,i,h,m,u,d))}var zO={kernelName:Qr,backendName:"cpu",kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,{axis:r}=n,{x:s}=t;lA(s,"unique");let i=a.data.get(s.dataId).values,{outputValues:o,outputShape:l,indices:u}=MR(i,r,s.shape,s.dtype);return[a.makeTensorInfo(l,s.dtype,o),a.makeTensorInfo([u.length],"int32",u)]}},PO={kernelName:es,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{value:r}=t,{axis:s}=a;s<0&&(s+=r.shape.length);let i=r.shape.length,o=r.shape[s],l=new Array(i-1),u=0;for(let h=0;h<i;h++)h!==s&&(l[u++]=r.shape[h]);let d=new Array(i).fill(0),c=r.shape.slice();c[s]=1;let p=new Array(o);for(let h=0;h<p.length;h++){d[s]=h;let e=oR({inputs:{x:r},backend:n,attrs:{begin:d,size:c}});p[h]=XR({inputs:{x:e},backend:n,attrs:{shape:l}}),n.disposeIntermediateTensorInfo(e)}return p}},BO={kernelName:ts,backendName:"cpu",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,segmentIds:s}=t,{numSegments:i}=a;lA(r,"unsortedSegmentSum");let o=[],l=[],u=r.shape.length-s.shape.length,d=s;for(let p=0;p<u;++p){let e=vD({inputs:{input:d},backend:n,attrs:{dim:p+1}});d=e,l.push(e)}for(let p=0;p<i;++p){let e=Ns.createScalarValue(p,"int32"),t=n.makeTensorInfo([],"int32",e),a=UA({inputs:{a:t,b:d},backend:n}),s=NA({inputs:{x:a},backend:n,attrs:{dtype:"float32"}}),i=$$({inputs:{a:s,b:r},backend:n}),u=uD({inputs:{x:i},backend:n,attrs:{axis:0,keepDims:!1}});o.push(u),l.push(t),l.push(a),l.push(s),l.push(i),l.push(u)}let c=AM({inputs:o,backend:n,attrs:{axis:0}});return l.forEach(e=>n.disposeIntermediateTensorInfo(e)),c}},WO=[QR,hA,tF,aF,AA,rF,sF,iF,oF,lF,dF,pF,mF,xF,yF,NF,SF,IF,_F,JR,CF,TF,EF,MA,AF,SA,BA,RF,gA,FF,jF,zF,PF,BF,WF,VF,UF,HF,KF,XF,YF,ZF,JF,QF,tD,nD,aD,rD,sD,iD,oD,lD,cD,LR,pD,GA,wD,KA,kD,ZA,ED,$D,RD,e$,a$,FD,DD,MD,OD,l$,c$,yA,jD,MF,zD,BD,VD,PR,m$,x$,UD,v$,HD,XD,ZD,eM,tM,nM,rM,I$,sM,iM,oM,lM,uM,dM,cM,T$,pM,fM,yM,R$,D$,vM,NM,IM,j$,_M,EM,$M,RM,MM,VR,W$,OM,jM,LM,zM,vA,ID,BM,GR,qR,YR,WM,VM,UM,GM,HM,qM,XM,tR,YM,QM,eO,rO,sR,iO,lO,dO,lR,bM,hO,mO,fO,gO,xO,bO,yO,wO,mR,vO,xR,wR,NO,SO,IO,_O,CO,AR,dD,EO,{kernelName:Kr,backendName:"cpu",kernelFunc:AO},$O,RO,FO,DO,P$,zO,PO,BO,TM];for(let p1 of WO)xs(p1);var VO={};xe(VO,{assertNotComplex:()=>Jj,bindCanvasToFramebuffer:()=>Tj,bindColorTextureToFramebuffer:()=>Ej,bindTextureToProgramUniformSampler:()=>Cj,bindTextureUnit:()=>Nj,bindVertexBufferToProgramAttribute:()=>kj,callAndCheck:()=>tj,canBeRepresented:()=>rj,createFragmentShader:()=>lj,createFramebuffer:()=>vj,createProgram:()=>hj,createStaticIndexBuffer:()=>xj,createStaticVertexBuffer:()=>gj,createTexture:()=>yj,createVertexShader:()=>oj,getBatchDim:()=>Mj,getExtensionOrThrow:()=>ij,getFramebufferErrorMessage:()=>Rj,getMaxTexturesInShader:()=>Uj,getNumChannels:()=>bj,getProgramUniformLocation:()=>_j,getProgramUniformLocationOrThrow:()=>Ij,getRowsCols:()=>Oj,getShapeAs3D:()=>jj,getTextureShapeFromLogicalShape:()=>Lj,getWebGLDisjointQueryTimerVersion:()=>Gj,getWebGLErrorMessage:()=>sj,getWebGLMaxTextureSize:()=>Bj,hasExtension:()=>Hj,isCapableOfRenderingToFloatTexture:()=>Kj,isDownloadFloatTextureEnabled:()=>Xj,isReshapeFree:()=>Pj,isWebGLFenceEnabled:()=>Zj,isWebGLVersionEnabled:()=>qj,linkProgram:()=>mj,logShaderSourceAndInfoLog:()=>pj,resetMaxTextureSize:()=>Wj,resetMaxTexturesInShader:()=>Vj,unbindColorTextureFromFramebuffer:()=>Aj,unbindTextureUnit:()=>Sj,validateFramebuffer:()=>$j,validateProgram:()=>fj,validateTextureSize:()=>wj});var UO,GO,HO,qO={},KO={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function XO(e,t){qO[e]=t}function YO(e,t){if(!(e in qO)||null!=t){let n=function(e,t){if(1!==e&&2!==e)throw new Error("Cannot get WebGL rendering context, WebGL is disabled.");let n=null==t?function(e){if(!Pt().getBool("IS_SAFARI")&&"undefined"!=typeof OffscreenCanvas&&2===e)return new OffscreenCanvas(300,150);if("undefined"!=typeof document)return document.createElement("canvas");throw new Error("Cannot create a canvas in this context")}(e):t;return n.addEventListener("webglcontextlost",t=>{t.preventDefault(),delete qO[e]},!1),Pt().getBool("SOFTWARE_WEBGL_ENABLED")&&(KO.failIfMajorPerformanceCaveat=!1),1===e?n.getContext("webgl",KO)||n.getContext("experimental-webgl",KO):n.getContext("webgl2",KO)}(e,t);if(null===n)return null;qO[e]=n}let n=qO[e];return null==n||n.isContextLost()?(delete qO[e],YO(e)):(n.disable(n.DEPTH_TEST),n.disable(n.STENCIL_TEST),n.disable(n.BLEND),n.disable(n.DITHER),n.disable(n.POLYGON_OFFSET_FILL),n.disable(n.SAMPLE_COVERAGE),n.enable(n.SCISSOR_TEST),n.enable(n.CULL_FACE),n.cullFace(n.BACK),qO[e])}function ZO(e,t){return[t,e]}function JO(e){let t=Ns.sizeFromShape(e),n=Math.ceil(t/4);return Ns.sizeToSquarishShape(n)}function QO(e,t){return[Math.max(1,Math.ceil(t/2)),Math.max(1,Math.ceil(e/2))]}function ej(e,t){let n,a,r,s,i,o,l,u,d,c,p=e;return 2===Pt().getNumber("WEBGL_VERSION")?(n=p.R32F,a=p.R16F,r=p.RGBA16F,s=p.RGBA32F,i=p.RED,l=4,u=1,d=p.HALF_FLOAT,c=p.FLOAT,o=p.RGBA8):(n=e.RGBA,a=e.RGBA,r=e.RGBA,s=p.RGBA,i=e.RGBA,l=4,u=4,d=null!=t?t.HALF_FLOAT_OES:null,c=e.FLOAT,o=e.RGBA),{internalFormatFloat:n,internalFormatHalfFloat:a,internalFormatPackedHalfFloat:r,internalFormatPackedFloat:s,textureFormatFloat:i,downloadTextureFormat:o,downloadUnpackNumChannels:l,defaultNumChannels:u,textureTypeHalfFloat:d,textureTypeFloat:c}}function tj(e,t){let n=t();return Pt().getBool("DEBUG")&&function(e){let t=e.getError();if(t!==e.NO_ERROR)throw new Error("WebGL Error: "+sj(e,t))}(e),n}!function(e){e[e.DENSE=0]="DENSE",e[e.SHARED_BATCH=1]="SHARED_BATCH"}(UO||(UO={})),function(e){e[e.RENDER=0]="RENDER",e[e.UPLOAD=1]="UPLOAD",e[e.PIXELS=2]="PIXELS",e[e.DOWNLOAD=3]="DOWNLOAD"}(GO||(GO={})),function(e){e[e.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",e[e.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",e[e.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",e[e.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",e[e.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16"}(HO||(HO={}));var nj=5.96e-8,aj=65504;function rj(e){return!!(Pt().getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===e||nj<Math.abs(e)&&Math.abs(e)<aj)}function sj(e,t){switch(t){case e.NO_ERROR:return"NO_ERROR";case e.INVALID_ENUM:return"INVALID_ENUM";case e.INVALID_VALUE:return"INVALID_VALUE";case e.INVALID_OPERATION:return"INVALID_OPERATION";case e.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case e.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case e.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return`Unknown error code ${t}`}}function ij(e,t){return Fj(e,()=>e.getExtension(t),'Extension "'+t+'" not supported on this browser.')}function oj(e,t){let n=Fj(e,()=>e.createShader(e.VERTEX_SHADER),"Unable to create vertex WebGLShader.");if(tj(e,()=>e.shaderSource(n,t)),tj(e,()=>e.compileShader(n)),!1===e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error("Failed to compile vertex shader.");return n}function lj(e,t){let n=Fj(e,()=>e.createShader(e.FRAGMENT_SHADER),"Unable to create fragment WebGLShader.");if(tj(e,()=>e.shaderSource(n,t)),tj(e,()=>e.compileShader(n)),Pt().get("ENGINE_COMPILE_ONLY"))return n;if(!1===e.getShaderParameter(n,e.COMPILE_STATUS))throw pj(t,e.getShaderInfoLog(n)),new Error("Failed to compile fragment shader.");return n}var uj,dj,cj=/ERROR: [0-9]+:([0-9]+):/g;function pj(e,t){let n=cj.exec(t);if(null==n)return;let a=+n[1],r=e.split("\n"),s=r.length.toString().length+2,i=r.map((e,t)=>Ns.rightPad((t+1).toString(),s)+e),o=0;for(let l=0;l<i.length;l++)o=Math.max(i[l].length,o);i.slice(0,a-1),i.slice(a-1,a),i.slice(a)}function hj(e){return Fj(e,()=>e.createProgram(),"Unable to create WebGLProgram.")}function mj(e,t){if(tj(e,()=>e.linkProgram(t)),!Pt().get("ENGINE_COMPILE_ONLY")&&!1===e.getProgramParameter(t,e.LINK_STATUS))throw new Error("Failed to link vertex and fragment shaders.")}function fj(e,t){if(tj(e,()=>e.validateProgram(t)),!1===e.getProgramParameter(t,e.VALIDATE_STATUS))throw new Error("Shader program validation failed.")}function gj(e,t){let n=Fj(e,()=>e.createBuffer(),"Unable to create WebGLBuffer");return tj(e,()=>e.bindBuffer(e.ARRAY_BUFFER,n)),tj(e,()=>e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW)),n}function xj(e,t){let n=Fj(e,()=>e.createBuffer(),"Unable to create WebGLBuffer");return tj(e,()=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n)),tj(e,()=>e.bufferData(e.ELEMENT_ARRAY_BUFFER,t,e.STATIC_DRAW)),n}function bj(){return 2===Pt().getNumber("WEBGL_VERSION")?1:4}function yj(e){return Fj(e,()=>e.createTexture(),"Unable to create WebGLTexture.")}function wj(e,t){let n=Pt().getNumber("WEBGL_MAX_TEXTURE_SIZE");if(e<=0||t<=0)throw new Error(`Requested texture size [${e}x${t}] is invalid.`);if(e>n||t>n)throw new Error(`Requested texture size [${e}x${t}] greater than WebGL maximum on this browser / GPU [${n}x${n}].`)}function vj(e){return Fj(e,()=>e.createFramebuffer(),"Unable to create WebGLFramebuffer.")}function kj(e,t,n,a,r,s,i){let o=e.getAttribLocation(t,n);return-1!==o&&(tj(e,()=>e.bindBuffer(e.ARRAY_BUFFER,a)),tj(e,()=>e.vertexAttribPointer(o,r,e.FLOAT,!1,s,i)),tj(e,()=>e.enableVertexAttribArray(o)),!0)}function Nj(e,t,n){Dj(e,n),tj(e,()=>e.activeTexture(e.TEXTURE0+n)),tj(e,()=>e.bindTexture(e.TEXTURE_2D,t))}function Sj(e,t){Dj(e,t),tj(e,()=>e.activeTexture(e.TEXTURE0+t)),tj(e,()=>e.bindTexture(e.TEXTURE_2D,null))}function Ij(e,t,n){return Fj(e,()=>e.getUniformLocation(t,n),'uniform "'+n+'" not present in program.')}function _j(e,t,n){return e.getUniformLocation(t,n)}function Cj(e,t,n,a){tj(e,()=>Nj(e,t,a)),tj(e,()=>e.uniform1i(n,a))}function Tj(e){tj(e,()=>e.bindFramebuffer(e.FRAMEBUFFER,null)),tj(e,()=>e.viewport(0,0,e.canvas.width,e.canvas.height)),tj(e,()=>e.scissor(0,0,e.canvas.width,e.canvas.height))}function Ej(e,t,n){tj(e,()=>e.bindFramebuffer(e.FRAMEBUFFER,n)),tj(e,()=>e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0))}function Aj(e,t){tj(e,()=>e.bindFramebuffer(e.FRAMEBUFFER,t)),tj(e,()=>e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,null,0))}function $j(e){let t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error("Error binding framebuffer: "+Rj(e,t))}function Rj(e,t){switch(t){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case e.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return`unknown error ${t}`}}function Fj(e,t,n){let a=tj(e,()=>t());if(null==a)throw new Error(n);return a}function Dj(e,t){let n=e.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,a=t+e.TEXTURE0;if(a<e.TEXTURE0||a>n)throw new Error(`textureUnit must be in [gl.TEXTURE0, gl.TEXTURE${n}].`)}function Mj(e,t=2){return Ns.sizeFromShape(e.slice(0,e.length-t))}function Oj(e){if(0===e.length)throw Error("Cannot get rows and columns of an empty shape array.");return[e.length>1?e[e.length-2]:1,e[e.length-1]]}function jj(e){let t=[1,1,1];return 0===e.length||1===e.length&&1===e[0]||(t=[Mj(e),...Oj(e)]),t}function Lj(e,t=!1){let n=Pt().getNumber("WEBGL_MAX_TEXTURE_SIZE"),a=Pt().getNumber("WEBGL_MAX_SIZE_FOR_NARROW_TEXTURE");a===1/0&&Pt().getBool("WEBGL_AUTO_SQUARIFY_NARROW_TEXTURE_SHAPE")&&(a=n/2),t&&(n*=2,a*=2,1===(e=e.map((t,n)=>n>=e.length-2?Ns.nearestLargerEven(e[n]):e[n])).length&&(e=[2,e[0]])),2!==e.length&&(e=Ns.squeezeShape(e).newShape);let r=Ns.sizeFromShape(e),s=null;e.length<=1&&r<=n?s=[1,r]:2===e.length&&e[0]<=n&&e[1]<=n?s=e:3===e.length&&e[0]*e[1]<=n&&e[2]<=n?s=[e[0]*e[1],e[2]]:3===e.length&&e[0]<=n&&e[1]*e[2]<=n?s=[e[0],e[1]*e[2]]:4===e.length&&e[0]*e[1]*e[2]<=n&&e[3]<=n?s=[e[0]*e[1]*e[2],e[3]]:4===e.length&&e[0]<=n&&e[1]*e[2]*e[3]<=n&&(s=[e[0],e[1]*e[2]*e[3]]);let i=null!=s&&Math.max(...s)>a&&Math.min(...s)<=(t?2:1)&&Math.min(...s)>0;if(null==s||i)if(t){let t=Mj(e),n=2,a=2;e.length&&([n,a]=Oj(e)),r=t*(n/2)*(a/2),s=Ns.sizeToSquarishShape(r).map(e=>2*e)}else s=Ns.sizeToSquarishShape(r);return s}function zj(e){return e%2==0}function Pj(e,t){if(e=e.slice(-2),t=t.slice(-2),Ns.arraysEqual(e,t)||!e.length||!t.length||0===e[0]||0===e[1]||0===t[0]||0===t[1])return!0;if(e.length!==t.length){let n=e[e.length-1],a=t[t.length-1];if(n===a||zj(n)&&zj(a)&&(1===e[0]||1===t[0]))return!0}return e[1]===t[1]&&zj(e[0])&&zj(t[0])}function Bj(e){if(null==uj){let t=YO(e);uj=t.getParameter(t.MAX_TEXTURE_SIZE)}return uj}function Wj(){uj=null}function Vj(){dj=null}function Uj(e){if(null==dj){let t=YO(e);dj=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,dj)}function Gj(e){if(0===e)return 0;let t,n=YO(e);return t=Hj(n,"EXT_disjoint_timer_query_webgl2")&&2===e?2:Hj(n,"EXT_disjoint_timer_query")?1:0,t}function Hj(e,t){return null!=e.getExtension(t)}function qj(e){try{if(null!=YO(e))return!0}catch(t){return!1}return!1}function Kj(e){if(0===e)return!1;let t=YO(e);if(1===e){if(!Hj(t,"OES_texture_float"))return!1}else if(!Hj(t,"EXT_color_buffer_float"))return!1;return Yj(t)}function Xj(e){if(0===e)return!1;let t=YO(e);if(1!==e){if(Hj(t,"EXT_color_buffer_float"))return Yj(t);let e="EXT_color_buffer_half_float";if(Hj(t,e)){let n=t.getExtension(e);return function(e,t){let n=ej(e,t),a=e.createTexture();e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,n.internalFormatHalfFloat,1,1,0,n.textureFormatFloat,n.textureTypeHalfFloat,null);let r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a,0);let s=e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE;return e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteTexture(a),e.deleteFramebuffer(r),s}(t,n)}return!1}return!(!Hj(t,"OES_texture_float")||!Hj(t,"WEBGL_color_buffer_float"))&&Yj(t)}function Yj(e){let t=ej(e),n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,t.internalFormatFloat,1,1,0,t.textureFormatFloat,t.textureTypeFloat,null);let a=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,a),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0);let r=e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE;return e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteTexture(n),e.deleteFramebuffer(a),r}function Zj(e){return 2===e&&null!=YO(e).fenceSync}function Jj(e,t){Array.isArray(e)||(e=[e]),e.forEach(e=>{null!=e&&Ns.assert("complex64"!==e.dtype,()=>`${t} does not support complex64 tensors in the WebGL backend.`)})}var Qj=Pt();function eL(){let e,t,n,a,r,s,i,o,l,u;return 2===Pt().getNumber("WEBGL_VERSION")?(e="#version 300 es",t="in",n="out",a="in",r="texture",s="outputColor",i="out vec4 outputColor;",o=Pt().getBool("WEBGL2_ISNAN_CUSTOM")?"\n      bool isnan_custom(float val) {\n        uint floatToUint = floatBitsToUint(val);\n        return (floatToUint & 0x7fffffffu) > 0x7f800000u;\n      }\n\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan_custom(val.x),\n          isnan_custom(val.y), isnan_custom(val.z), isnan_custom(val.w));\n      }\n\n      #define isnan(value) isnan_custom(value)\n    ":"",l="",u="\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(e="",t="attribute",n="varying",a="varying",r="texture2D",s="gl_FragColor",i="",o="\n      #define isnan(value) isnan_custom(value)\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n      }\n    ",l="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ",u="\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "),{version:e,attribute:t,varyingVs:n,varyingFs:a,texture2D:r,output:s,defineOutput:i,defineSpecialNaN:o,defineSpecialInf:l,defineRound:u}}function tL(e,t,n="index"){let a=Ns.computeStrides(t);return a.map((t,r)=>`int ${e[r]} = ${n} / ${t}; ${r===a.length-1?`int ${e[r+1]} = ${n} - ${e[r]} * ${t}`:`index -= ${e[r]} * ${t}`};`).join("")}function nL(e,t,n="index"){let a=Ns.computeStrides(t);return a.map((t,r)=>`int ${e[r]} = ${n} / outShapeStrides[${r}]; ${r===a.length-1?`int ${e[r+1]} = ${n} - ${e[r]} * outShapeStrides[${r}]`:`index -= ${e[r]} * outShapeStrides[${r}]`};`).join("")}function aL(e){let t=Ns.computeStrides(e).map(e=>e.toString());return`\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * ${t[0]} + coords.y * ${t[1]} + coords.z;\n  }\n`}Qj.registerFlag("HAS_WEBGL",()=>Qj.getNumber("WEBGL_VERSION")>0),Qj.registerFlag("WEBGL_VERSION",()=>qj(2)?2:qj(1)?1:0),Qj.registerFlag("WEBGL_CHECK_NUMERICAL_PROBLEMS",()=>!1),Qj.registerFlag("WEBGL_BUFFER_SUPPORTED",()=>2===Qj.get("WEBGL_VERSION")),Qj.registerFlag("WEBGL_CPU_FORWARD",()=>!0),Qj.registerFlag("WEBGL_FORCE_F16_TEXTURES",()=>!1),Qj.registerFlag("WEBGL_PACK",()=>Qj.getBool("HAS_WEBGL")),Qj.registerFlag("WEBGL_PACK_NORMALIZATION",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_PACK_CLIP",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_PACK_DEPTHWISECONV",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_PACK_UNARY_OPERATIONS",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_PACK_REDUCE",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_LAZILY_UNPACK",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_CONV_IM2COL",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_PACK_CONV2DTRANSPOSE",()=>Qj.getBool("WEBGL_PACK")),Qj.registerFlag("WEBGL_MAX_TEXTURE_SIZE",()=>Bj(Qj.getNumber("WEBGL_VERSION"))),Qj.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",()=>Uj(Qj.getNumber("WEBGL_VERSION"))),Qj.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",()=>{let e=Qj.getNumber("WEBGL_VERSION");return 0===e?0:Gj(e)}),Qj.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",()=>Qj.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0&&!Ai.isMobile()),Qj.registerFlag("WEBGL_RENDER_FLOAT32_CAPABLE",()=>Kj(Qj.getNumber("WEBGL_VERSION"))),Qj.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",()=>!Qj.getBool("WEBGL_FORCE_F16_TEXTURES")&&Qj.getBool("WEBGL_RENDER_FLOAT32_CAPABLE")),Qj.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",()=>Xj(Qj.getNumber("WEBGL_VERSION"))),Qj.registerFlag("WEBGL_FENCE_API_ENABLED",()=>Zj(Qj.getNumber("WEBGL_VERSION"))),Qj.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",()=>Qj.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?4:0),Qj.registerFlag("WEBGL_DELETE_TEXTURE_THRESHOLD",()=>-1,e=>{if("number"!=typeof e)throw new Error(`WEBGL_DELETE_TEXTURE_THRESHOLD must be a number but got ${e}.`);if(e<0&&-1!==e)throw new Error(`WEBGL_DELETE_TEXTURE_THRESHOLD must be -1 (indicating never delete) or at least 0, but got ${e}.`)}),Qj.registerFlag("WEBGL_FLUSH_THRESHOLD",()=>Ai.isMobile()?1:-1,e=>{if("number"!=typeof e)throw new Error(`WEBGL_FLUSH_THRESHOLD must be a number but got ${e}.`);if(e<0&&-1!==e)throw new Error(`WEBGL_FLUSH_THRESHOLD must be -1 (indicating never manual flush) or at least 0, but got ${e}.`)}),Qj.registerFlag("CPU_HANDOFF_SIZE_THRESHOLD",()=>128),Qj.registerFlag("WEBGL_USE_SHAPES_UNIFORMS",()=>!1),Qj.registerFlag("TOPK_LAST_DIM_CPU_HANDOFF_SIZE_THRESHOLD",()=>1e5),Qj.registerFlag("TOPK_K_CPU_HANDOFF_THRESHOLD",()=>128),Qj.registerFlag("WEBGL_EXP_CONV",()=>!1),Qj.registerFlag("SOFTWARE_WEBGL_ENABLED",()=>Qj.getBool("IS_TEST")),Qj.registerFlag("WEBGL_MAX_SIZE_FOR_NARROW_TEXTURE",()=>1/0),Qj.registerFlag("WEBGL_AUTO_SQUARIFY_NARROW_TEXTURE_SHAPE",()=>!1),Qj.registerFlag("WEBGL2_ISNAN_CUSTOM",()=>!1),Qj.registerFlag("ENGINE_COMPILE_ONLY",()=>!1);var rL="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n",{getBroadcastDims:sL}=Uf;function iL(e,t,n){let a=[];if(e.forEach(e=>{let t=Ns.sizeFromShape(e.shapeInfo.logicalShape);if(e.shapeInfo.isUniform?a.push(`uniform float ${e.name}${t>1?`[${t}]`:""};`):(a.push(`uniform sampler2D ${e.name};`),a.push(`uniform int offset${e.name};`)),n.enableShapeUniforms){let{uniformShape:t}=gL(n.packedInputs,e.shapeInfo.logicalShape,e.shapeInfo.texShape);switch(t.length){case 1:a.push(`uniform int ${e.name}Shape;`);break;case 2:a.push(`uniform ivec2 ${e.name}Shape;`);break;case 3:a.push(`uniform ivec3 ${e.name}Shape;`);break;case 4:a.push(`uniform ivec4 ${e.name}Shape;`)}a.push(`uniform ivec2 ${e.name}TexShape;`)}}),n.enableShapeUniforms){switch(t.logicalShape.length){case 1:a.push("uniform int outShape;");break;case 2:a.push("uniform ivec2 outShape;"),a.push("uniform int outShapeStrides;");break;case 3:a.push("uniform ivec3 outShape;"),a.push("uniform ivec2 outShapeStrides;");break;case 4:a.push("uniform ivec4 outShape;"),a.push("uniform ivec3 outShapeStrides;")}a.push("uniform ivec2 outTexShape;")}n.customUniforms&&n.customUniforms.forEach(e=>{a.push(`uniform ${e.type} ${e.name}${e.arrayIndex?`[${e.arrayIndex}]`:""};`)});let r,s,i=a.join("\n"),o=e.map(e=>function(e,t,n=!1,a){let r="";r+=n?lL(e,a):oL(e,a);let s=e.shapeInfo.logicalShape,i=t.logicalShape;return s.length<=i.length&&(r+=n?function(e,t){let n,a=e.name,r=a.charAt(0).toUpperCase()+a.slice(1),s="get"+r+"AtOutCoords",i=e.shapeInfo.logicalShape.length,o=t.logicalShape.length,l=sL(e.shapeInfo.logicalShape,t.logicalShape),u=fL(o),d=o-i,c=["x","y","z","w","u","v"];n=0===i?"":o<2&&l.length>=1?"coords = 0;":l.map(e=>`coords.${c[e+d]} = 0;`).join("\n");let p="";p=o<2&&i>0?"coords":e.shapeInfo.logicalShape.map((e,t)=>`coords.${c[t+d]}`).join(", ");let h="return outputValue;",m=1===Ns.sizeFromShape(e.shapeInfo.logicalShape),f=1===Ns.sizeFromShape(t.logicalShape);if(1!==i||m||f){if(m&&!f)h=1===o?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ";else if(l.length){let e=i-2,t=i-1;l.indexOf(e)>-1&&l.indexOf(t)>-1?h="return vec4(outputValue.x);":l.indexOf(e)>-1?h="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":l.indexOf(t)>-1&&(h="return vec4(outputValue.xx, outputValue.zz);")}}else h="\n      return vec4(outputValue.xy, outputValue.xy);\n    ";return`\n    vec4 ${s}() {\n      ${u} coords = getOutputCoords();\n      ${n}\n      vec4 outputValue = get${r}(${p});\n      ${h}\n    }\n  `}(e,t):function(e,t){let n=e.name,a=n.charAt(0).toUpperCase()+n.slice(1),r="get"+a+"AtOutCoords",s=t.texShape,i=e.shapeInfo.texShape,o=e.shapeInfo.logicalShape.length,l=t.logicalShape.length;if(!e.shapeInfo.isUniform&&o===l&&null==e.shapeInfo.flatOffset&&Ns.arraysEqual(i,s))return`\n      float ${r}() {\n        return sampleTexture(${n}, resultUV);\n      }\n    `;let u,d=fL(l),c=sL(e.shapeInfo.logicalShape,t.logicalShape),p=l-o,h=["x","y","z","w","u","v"];u=0===o?"":l<2&&c.length>=1?"coords = 0;":c.map(e=>`coords.${h[e+p]} = 0;`).join("\n");let m="";return m=l<2&&o>0?"coords":e.shapeInfo.logicalShape.map((e,t)=>`coords.${h[t+p]}`).join(", "),`\n    float ${r}() {\n      ${d} coords = getOutputCoords();\n      ${u}\n      return get${a}(${m});\n    }\n  `}(e,t)),r}(e,t,n.packedInputs,n.enableShapeUniforms)).join("\n"),l=t.texShape,u=eL(),d=function(e){return`\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return ${e.texture2D}(textureSampler, uv).r;\n    }\n  `}(u),c=function(e){return`${e.version}\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    ${e.varyingFs} vec2 resultUV;\n    ${e.defineOutput}\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    ${e.defineSpecialNaN}\n    ${e.defineSpecialInf}\n    ${e.defineRound}\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    ${uL}\n    ${dL}\n    ${cL}\n  `}(u);return t.isPacked?(r=function(e,t,n){switch(e.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(e,t,n){let a=[Math.ceil(t[0]/2),Math.ceil(t[1]/2)];return 1===a[0]?n?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * ceil(float(outTexShape[1]) / 2.0));\n      }\n    ":`\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * ${a[1]}.0);\n      }\n    `:1===a[1]?n?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * ceil(float(outTexShape[0]) / 2.0));\n      }\n    ":`\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * ${a[0]}.0);\n      }\n    `:n?"\n    int getOutputCoords() {\n      ivec2 packedTexShape = ivec2(ceil(float(outTexShape[0]) / 2.0), ceil(float(outTexShape[1]) / 2.0));\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(packedTexShape[0], packedTexShape[1]));\n      return 2 * (resTexRC.x * packedTexShape[1] + resTexRC.y);\n    }\n  ":`\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(${a[0]}, ${a[1]}));\n      return 2 * (resTexRC.x * ${a[1]} + resTexRC.y);\n    }\n  `}(0,t,n);case 2:return function(e,t,n){let a=[Math.ceil(t[0]/2),Math.ceil(t[1]/2)];if(Ns.arraysEqual(e,t))return n?"\n      ivec2 getOutputCoords() {\n        ivec2 packedTexShape = ivec2(ceil(float(outTexShape[0]) / 2.0), ceil(float(outTexShape[1]) / 2.0));\n        return 2 * ivec2(resultUV.yx * vec2(packedTexShape[0], packedTexShape[1]));\n      }\n    ":`\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2(${a[0]}, ${a[1]}));\n      }\n    `;let r=Math.ceil(e[1]/2);return n?"\n    ivec2 getOutputCoords() {\n      ivec2 packedTexShape = ivec2(ceil(float(outTexShape[0]) / 2.0), ceil(float(outTexShape[1]) / 2.0));\n      int texelsInLogicalRow = int(ceil(float(outShape[1]) / 2.0));\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(packedTexShape[0], packedTexShape[1]));\n\n      int index = resTexRC.x * packedTexShape[1] + resTexRC.y;\n      int r = 2 * (index / texelsInLogicalRow);\n      int c = imod(index, texelsInLogicalRow) * 2;\n\n      return ivec2(r, c);\n    }\n  ":`\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(${a[0]}, ${a[1]}));\n\n      int index = resTexRC.x * ${a[1]} + resTexRC.y;\n      int r = 2 * (index / ${r});\n      int c = imod(index, ${r}) * 2;\n\n      return ivec2(r, c);\n    }\n  `}(e,t,n);case 3:return function(e,t,n){if(n)return"\n    ivec3 getOutputCoords() {\n      ivec2 packedTexShape = ivec2(ceil(float(outTexShape[0]) / 2.0), ceil(float(outTexShape[1]) / 2.0));\n      int texelsInLogicalRow = int(ceil(float(outShape[2]) / 2.0));\n      int texelsInBatch = texelsInLogicalRow * int(ceil(float(outShape[1]) / 2.0));\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(packedTexShape[0], packedTexShape[1]));\n      int index = resTexRC.x * packedTexShape[1] + resTexRC.y;\n\n      int b = index / texelsInBatch;\n      index -= b * texelsInBatch;\n\n      int r = 2 * (index / texelsInLogicalRow);\n      int c = imod(index, texelsInLogicalRow) * 2;\n\n      return ivec3(b, r, c);\n    }\n  ";let a=[Math.ceil(t[0]/2),Math.ceil(t[1]/2)],r=Math.ceil(e[2]/2),s=r*Math.ceil(e[1]/2);return`\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(${a[0]}, ${a[1]}));\n      int index = resTexRC.x * ${a[1]} + resTexRC.y;\n\n      int b = index / ${s};\n      index -= b * ${s};\n\n      int r = 2 * (index / ${r});\n      int c = imod(index, ${r}) * 2;\n\n      return ivec3(b, r, c);\n    }\n  `}(e,t,n);default:return function(e,t,n){if(n)return"\n    ivec4 getOutputCoords() {\n      ivec2 packedTexShape = ivec2(ceil(float(outTexShape[0]) / 2.0), ceil(float(outTexShape[1]) / 2.0));\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(packedTexShape[0], packedTexShape[1]));\n      int index = resTexRC.x * packedTexShape[1] + resTexRC.y;\n\n      int texelsInLogicalRow = int(ceil(float(outShape[3]) / 2.0));\n      int texelsInBatch = texelsInLogicalRow * int(ceil(float(outShape[2]) / 2.0));\n      int texelsInBatchN = texelsInBatch * outShape[1];\n\n      int b2 = index / texelsInBatchN;\n      index -= b2 * texelsInBatchN;\n\n      int b = index / texelsInBatch;\n      index -= b * texelsInBatch;\n\n      int r = 2 * (index / texelsInLogicalRow);\n      int c = imod(index, texelsInLogicalRow) * 2;\n\n      return ivec4(b2, b, r, c);\n    }\n  ";let a=[Math.ceil(t[0]/2),Math.ceil(t[1]/2)],r=Math.ceil(e[e.length-1]/2),s=r*Math.ceil(e[e.length-2]/2),i=s,o="",l="b, r, c";for(let u=2;u<e.length-1;u++)i*=e[e.length-u-1],o=`\n      int b${u} = index / ${i};\n      index -= b${u} * ${i};\n    `+o,l=`b${u}, `+l;return`\n    ivec${e.length} getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(${a[0]}, ${a[1]}));\n      int index = resTexRC.x * ${a[1]} + resTexRC.y;\n\n      ${o}\n\n      int b = index / ${s};\n      index -= b * ${s};\n\n      int r = 2 * (index / ${r});\n      int c = imod(index, ${r}) * 2;\n\n      return ivec${e.length}(${l});\n    }\n  `}(e,t,n)}}(t.logicalShape,l,n.enableShapeUniforms),s=function(e){return`\n    void setOutput(vec4 val) {\n      ${e.output} = val;\n    }\n  `}(u)):(r=function(e,t,n){switch(e.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return function(e,t,n){return 1===t[0]?n?"\n      int getOutputCoords() {\n        return int(resultUV.x * float(outTexShape[1]));\n      }\n    ":`\n      int getOutputCoords() {\n        return int(resultUV.x * ${t[1]}.0);\n      }\n    `:1===t[1]?n?"\n      int getOutputCoords() {\n        return int(resultUV.y * float(outTexShape[0]));\n      }\n    ":`\n      int getOutputCoords() {\n        return int(resultUV.y * ${t[0]}.0);\n      }\n    `:n?"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(outTexShape[0], outTexShape[1]));\n      return resTexRC.x * outTexShape[1] + resTexRC.y;\n    }\n  ":`\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(${t[0]}, ${t[1]}));\n      return resTexRC.x * ${t[1]} + resTexRC.y;\n    }\n  `}(0,t,n);case 2:return function(e,t,n){return Ns.arraysEqual(e,t)?n?"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2(outTexShape[0], outTexShape[1]));\n      }\n    ":`\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2(${t[0]}, ${t[1]}));\n      }\n    `:1===e[1]?n?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2(outTexShape[0], outTexShape[1]));\n        int index = resTexRC.x * outTexShape[1] + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    ":`\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2(${t[0]}, ${t[1]}));\n        int index = resTexRC.x * ${t[1]} + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    `:1===e[0]?n?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2(outTexShape[0], outTexShape[1]));\n        int index = resTexRC.x * outTexShape[1] + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":`\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2(${t[0]}, ${t[1]}));\n        int index = resTexRC.x * ${t[1]} + resTexRC.y;\n        return ivec2(0, index);\n      }\n    `:n?"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(outTexShape[0], outTexShape[1]));\n      int index = resTexRC.x * outTexShape[1] + resTexRC.y;\n      int r = index / outShape[1];\n      int c = index - r * outShape[1];\n      return ivec2(r, c);\n    }\n  ":`\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(${t[0]}, ${t[1]}));\n      int index = resTexRC.x * ${t[1]} + resTexRC.y;\n      int r = index / ${e[1]};\n      int c = index - r * ${e[1]};\n      return ivec2(r, c);\n    }\n  `}(e,t,n);case 3:return function(e,t,n){if(n)return`\n  ivec3 getOutputCoords() {\n    ivec2 resTexRC = ivec2(resultUV.yx *\n                           vec2(outTexShape[0], outTexShape[1]));\n    int index = resTexRC.x * outTexShape[1] + resTexRC.y;\n    ${nL(["r","c","d"],e)}\n    return ivec3(r, c, d);\n  }\n`;let a=tL(["r","c","d"],e);return`\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2(${t[0]}, ${t[1]}));\n      int index = resTexRC.x * ${t[1]} + resTexRC.y;\n      ${a}\n      return ivec3(r, c, d);\n    }\n  `}(e,t,n);case 4:return function(e,t,n){if(n)return`\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2(outTexShape[0], outTexShape[1]));\n      int index = resTexRC.x * outTexShape[1] + resTexRC.y;\n      ${nL(["r","c","d","d2"],e)}\n      return ivec4(r, c, d, d2);\n    }\n  `;let a=tL(["r","c","d","d2"],e);return`\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2(${t[0]}, ${t[1]}));\n      int index = resTexRC.x * ${t[1]} + resTexRC.y;\n      ${a}\n      return ivec4(r, c, d, d2);\n    }\n  `}(e,t,n);case 5:return function(e,t){let n=tL(["r","c","d","d2","d3"],e);return`\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2(${t[0]},\n                             ${t[1]}));\n\n      int index = resTexRC.x * ${t[1]} + resTexRC.y;\n\n      ${n}\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  `}(e,t);case 6:return function(e,t){let n=tL(["r","c","d","d2","d3","d4"],e);return`\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2(${t[0]}, ${t[1]}));\n      int index = resTexRC.x * ${t[1]} + resTexRC.y;\n\n      ${n}\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  `}(e,t);default:throw new Error(`${e.length}-D output sampling is not yet supported`)}}(t.logicalShape,l,n.enableShapeUniforms),s=function(e){return`\n    void setOutput(float val) {\n      ${e.output} = vec4(val, 0, 0, 0);\n    }\n  `}(u)),n.packedInputs&&(c+=pL),[c,d,s,i,r,o,n.userCode].join("\n")}function oL(e,t=!1){let n=e.shapeInfo.logicalShape;switch(n.length){case 0:return function(e,t){let n=e.name,a="get"+n.charAt(0).toUpperCase()+n.slice(1);if(e.shapeInfo.isUniform)return`float ${a}() {return ${n};}`;let[r,s]=e.shapeInfo.texShape;if(1===r&&1===s)return`\n      float ${a}() {\n        return sampleTexture(${n}, halfCR);\n      }\n    `;let i=hL(n);if(t)return`\n    float ${a}() {\n      vec2 uv = uvFromFlat(${n}TexShape[0], ${n}TexShape[1], ${i});\n      return sampleTexture(${n}, uv);\n    }\n  `;let[o,l]=e.shapeInfo.texShape;return`\n    float ${a}() {\n      vec2 uv = uvFromFlat(${o}, ${l}, ${i});\n      return sampleTexture(${n}, uv);\n    }\n  `}(e,t);case 1:return function(e,t){let n=e.name,a="get"+n.charAt(0).toUpperCase()+n.slice(1);if(e.shapeInfo.isUniform)return`\n      float ${a}(int index) {\n        ${mL(e)}\n      }\n    `;let r=e.shapeInfo.texShape,s=r[0],i=r[1];if(1===i&&1===s)return`\n      float ${a}(int index) {\n        return sampleTexture(${n}, halfCR);\n      }\n    `;let o=hL(n);return 1===i?t?`\n      float ${a}(int index) {\n        vec2 uv = vec2(0.5, (float(index + ${o}) + 0.5) / float(${n}TexShape[0]));\n        return sampleTexture(${n}, uv);\n      }\n    `:`\n      float ${a}(int index) {\n        vec2 uv = vec2(0.5, (float(index + ${o}) + 0.5) / ${s}.0);\n        return sampleTexture(${n}, uv);\n      }\n    `:1===s?t?`\n      float ${a}(int index) {\n        vec2 uv = vec2((float(index + ${o}) + 0.5) / float(${n}TexShape[1]), 0.5);\n        return sampleTexture(${n}, uv);\n      }\n    `:`\n      float ${a}(int index) {\n        vec2 uv = vec2((float(index + ${o}) + 0.5) / ${i}.0, 0.5);\n        return sampleTexture(${n}, uv);\n      }\n    `:t?`\n    float ${a}(int index) {\n      vec2 uv = uvFromFlat(${n}TexShape[0], ${n}TexShape[1], index + ${o});\n      return sampleTexture(${n}, uv);\n    }\n  `:`\n    float ${a}(int index) {\n      vec2 uv = uvFromFlat(${s}, ${i}, index + ${o});\n      return sampleTexture(${n}, uv);\n    }\n  `}(e,t);case 2:return function(e,t){let n=e.shapeInfo.logicalShape,a=e.name,r="get"+a.charAt(0).toUpperCase()+a.slice(1),s=e.shapeInfo.texShape;if(null!=s&&Ns.arraysEqual(n,s)){if(t)return`\n      float ${r}(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2(${a}TexShape[1], ${a}TexShape[0]);\n        return sampleTexture(${a}, uv);\n      }\n    `;let e=s[0];return`\n    float ${r}(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2(${s[1]}.0, ${e}.0);\n      return sampleTexture(${a}, uv);\n    }\n  `}let{newShape:i,keptDims:o}=Ns.squeezeShape(n),l=i;if(l.length<n.length){let n=["row","col"];return`\n      ${oL(xL(e,l),t)}\n      float ${r}(int row, int col) {\n        return ${r}(${bL(n,o)});\n      }\n    `}if(e.shapeInfo.isUniform)return`\n      float ${r}(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2(${n[1]}, 1)));\n        ${mL(e)}\n      }\n    `;let u=s[0],d=s[1],c=hL(a);return 1===d?t?`\n      float ${r}(int row, int col) {\n        float index = dot(vec3(row, col, ${c}), vec3(${a}Shape[1], 1, 1));\n        vec2 uv = vec2(0.5, (index + 0.5) / float(${a}TexShape[0]));\n        return sampleTexture(${a}, uv);\n      }\n    `:`\n    float ${r}(int row, int col) {\n      float index = dot(vec3(row, col, ${c}), vec3(${n[1]}, 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / ${u}.0);\n      return sampleTexture(${a}, uv);\n    }\n  `:1===u?t?`\n      float ${r}(int row, int col) {\n        float index = dot(vec3(row, col, ${c}), vec3(${a}Shape[1], 1, 1));\n        vec2 uv = vec2((index + 0.5) / float(${a}TexShape[1]), 0.5);\n        return sampleTexture(${a}, uv);\n      }\n    `:`\n    float ${r}(int row, int col) {\n      float index = dot(vec3(row, col, ${c}), vec3(${n[1]}, 1, 1));\n      vec2 uv = vec2((index + 0.5) / ${d}.0, 0.5);\n      return sampleTexture(${a}, uv);\n    }\n  `:t?`\n      float ${r}(int row, int col) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * ${a}Shape[1] + col + ${c};\n        vec2 uv = uvFromFlat(${a}TexShape[0], ${a}TexShape[1], index);\n        return sampleTexture(${a}, uv);\n      }\n    `:`\n  float ${r}(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * ${n[1]} + col + ${c};\n    vec2 uv = uvFromFlat(${u}, ${d}, index);\n    return sampleTexture(${a}, uv);\n  }\n`}(e,t);case 3:return function(e,t){let n=e.shapeInfo.logicalShape,a=e.name,r="get"+a.charAt(0).toUpperCase()+a.slice(1),s=n[1]*n[2],i=n[2],{newShape:o,keptDims:l}=Ns.squeezeShape(n),u=o;if(u.length<n.length){let n=["row","col","depth"];return`\n        ${oL(xL(e,u),t)}\n        float ${r}(int row, int col, int depth) {\n          return ${r}(${bL(n,l)});\n        }\n      `}if(e.shapeInfo.isUniform)return`\n      float ${r}(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3(${s}, ${i}, 1)));\n        ${mL(e)}\n      }\n    `;let d=e.shapeInfo.texShape,c=d[0],p=d[1],h=e.shapeInfo.flatOffset;if(p===s&&null==h)return t?`\n      float ${r}(int row, int col, int depth) {\n        int stride1 = ${a}Shape[2];\n        float texR = float(row);\n        float texC = dot(vec2(col, depth), vec2(stride1, 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2(${a}TexShape[1], ${a}TexShape[0]);\n        return sampleTexture(${a}, uv);\n      }\n    `:`\n        float ${r}(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2(${i}, 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2(${p}.0, ${c}.0);\n          return sampleTexture(${a}, uv);\n        }\n      `;if(p===i&&null==h)return t?`\n      float ${r}(int row, int col, int depth) {\n        float texR = dot(vec2(row, col), vec2(${a}Shape[1], 1));\n        float texC = float(depth);\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2(${a}TexShape[1], ${a}TexShape[0]);\n        return sampleTexture(${a}, uv);\n      }\n    `:`\n    float ${r}(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2(${n[1]}, 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2(${p}.0, ${c}.0);\n      return sampleTexture(${a}, uv);\n    }\n  `;let m=hL(a);return t?`\n    float ${r}(int row, int col, int depth) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int stride0 = ${a}Shape[1] * ${a}Shape[2];\n      int stride1 = ${a}Shape[2];\n      int index = row * stride0 + col * stride1 + depth + ${m};\n      vec2 uv = uvFromFlat(${a}TexShape[0], ${a}TexShape[1], index);\n      return sampleTexture(${a}, uv);\n    }\n    `:`\n      float ${r}(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * ${s} + col * ${i} + depth + ${m};\n        vec2 uv = uvFromFlat(${c}, ${p}, index);\n        return sampleTexture(${a}, uv);\n      }\n  `}(e,t);case 4:return function(e,t){let n=e.shapeInfo.logicalShape,a=e.name,r="get"+a.charAt(0).toUpperCase()+a.slice(1),s=n[3],i=n[2]*s,o=n[1]*i,{newShape:l,keptDims:u}=Ns.squeezeShape(n);if(l.length<n.length){let n=["row","col","depth","depth2"];return`\n      ${oL(xL(e,l),t)}\n      float ${r}(int row, int col, int depth, int depth2) {\n        return ${r}(${bL(n,u)});\n      }\n    `}if(e.shapeInfo.isUniform)return`\n      float ${r}(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4(${o}, ${i}, ${s}, 1)));\n        ${mL(e)}\n      }\n    `;let d=e.shapeInfo.flatOffset,c=e.shapeInfo.texShape,p=c[0],h=c[1],m=`int stride2 = ${a}Shape[3];`,f=`int stride1 = ${a}Shape[2] * stride2;`,g=`int stride0 = ${a}Shape[1] * stride1;`;if(h===o&&null==d)return t?`\n      float ${r}(int row, int col, int depth, int depth2) {\n        ${m}\n        ${f}\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3(stride1, stride2, 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2(${a}TexShape[1], ${a}TexShape[0]);\n        return sampleTexture(${a}, uv);\n      }\n    `:`\n      float ${r}(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3(${i}, ${s}, 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2(${h}.0, ${p}.0);\n        return sampleTexture(${a}, uv);\n      }\n    `;if(h===s&&null==d)return t?`\n      float ${r}(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3(${a}Shape[1] * ${a}Shape[2], ${a}Shape[2], 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2(${a}TexShape[1], ${a}TexShape[0]);\n        return sampleTexture(${a}, uv);\n      }\n    `:`\n      float ${r}(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3(${n[1]*n[2]}, ${n[2]}, 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2(${h}.0, ${p}.0);\n        return sampleTexture(${a}, uv);\n      }\n    `;let x=hL(a);return t?`\n    float ${r}(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      ${m}\n      ${f}\n      ${g}\n      int index = row * stride0 + col * stride1 +\n          depth * stride2 + depth2;\n      vec2 uv = uvFromFlat(${a}TexShape[0], ${a}TexShape[1], index + ${x});\n      return sampleTexture(${a}, uv);\n    }\n  `:`\n    float ${r}(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * ${o} + col * ${i} +\n          depth * ${s} + depth2;\n      vec2 uv = uvFromFlat(${p}, ${h}, index + ${x});\n      return sampleTexture(${a}, uv);\n    }\n  `}(e,t);case 5:return function(e){let t=e.shapeInfo.logicalShape,n=e.name,a="get"+n.charAt(0).toUpperCase()+n.slice(1),r=t[4],s=t[3]*r,i=t[2]*s,o=t[1]*i,{newShape:l,keptDims:u}=Ns.squeezeShape(t);if(l.length<t.length){let t=["row","col","depth","depth2","depth3"];return`\n      ${oL(xL(e,l))}\n      float ${a}(int row, int col, int depth, int depth2, int depth3) {\n        return ${a}(${bL(t,u)});\n      }\n    `}if(e.shapeInfo.isUniform)return`\n      float ${a}(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4(${o}, ${i}, ${s}, ${r})) +\n          depth3;\n        ${mL(e)}\n      }\n    `;let d=e.shapeInfo.flatOffset,c=e.shapeInfo.texShape,p=c[0],h=c[1];return h===o&&null==d?`\n      float ${a}(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4(${i}, ${s}, ${r}, 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2(${h}.0, ${p}.0);\n        return sampleTexture(${n}, uv);\n      }\n    `:h===r&&null==d?`\n      float ${a}(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4(${t[1]*t[2]*t[3]},\n               ${t[2]*t[3]}, ${t[3]}, 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2(${h}.0, ${p}.0);\n        return sampleTexture(${n}, uv);\n      }\n    `:`\n    float ${a}(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * ${o} + col * ${i} + depth * ${s} +\n          depth2 * ${r} + depth3 + ${hL(n)};\n      vec2 uv = uvFromFlat(${p}, ${h}, index);\n      return sampleTexture(${n}, uv);\n    }\n  `}(e);case 6:return function(e){let t=e.shapeInfo.logicalShape,n=e.name,a="get"+n.charAt(0).toUpperCase()+n.slice(1),{newShape:r,keptDims:s}=Ns.squeezeShape(t);if(r.length<t.length){let t=["row","col","depth","depth2","depth3","depth4"];return`\n      ${oL(xL(e,r))}\n      float ${a}(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return ${a}(${bL(t,s)});\n      }\n    `}let i=t[5],o=t[4]*i,l=t[3]*o,u=t[2]*l,d=t[1]*u;if(e.shapeInfo.isUniform)return`\n      float ${a}(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4(${d}, ${u}, ${l}, ${o})) +\n          dot(\n            vec2(depth3, depth4),\n            vec2(${i}, 1)));\n        ${mL(e)}\n      }\n    `;let c=e.shapeInfo.flatOffset,p=e.shapeInfo.texShape,h=p[0],m=p[1];return m===d&&null==c?`\n      float ${a}(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4(${u}, ${l}, ${o}, ${i})) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2(${m}.0, ${h}.0);\n        return sampleTexture(${n}, uv);\n      }\n    `:m===i&&null==c?`\n      float ${a}(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4(${t[1]*t[2]*t[3]*t[4]},\n               ${t[2]*t[3]*t[4]},\n               ${t[3]*t[4]},\n               ${t[4]})) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2(${m}.0, ${h}.0);\n        return sampleTexture(${n}, uv);\n      }\n    `:`\n    float ${a}(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * ${d} + col * ${u} + depth * ${l} +\n          depth2 * ${o} + depth3 * ${i} + depth4 + ${hL(n)};\n      vec2 uv = uvFromFlat(${h}, ${m}, index);\n      return sampleTexture(${n}, uv);\n    }\n  `}(e);default:throw new Error(`${n.length}-D input sampling is not yet supported`)}}function lL(e,t){switch(e.shapeInfo.logicalShape.length){case 0:return function(e){let t=e.name;return`\n    vec4 ${"get"+t.charAt(0).toUpperCase()+t.slice(1)}() {\n      return ${eL().texture2D}(${t}, halfCR);\n    }\n  `}(e);case 1:return function(e,t){let n=e.name,a="get"+n.charAt(0).toUpperCase()+n.slice(1),r=e.shapeInfo.texShape,s=eL();if(t)return`\n    vec4 ${a}(int index) {\n      ivec2 packedTexShape = ivec2(ceil(float(${n}TexShape[0]) / 2.0), ceil(float(${n}TexShape[1]) / 2.0));\n      vec2 uv = packedUVfrom1D(\n        packedTexShape[0], packedTexShape[1], index);\n      return ${s.texture2D}(${n}, uv);\n    }\n  `;let i=[Math.ceil(r[0]/2),Math.ceil(r[1]/2)];return`\n    vec4 ${a}(int index) {\n      vec2 uv = packedUVfrom1D(\n        ${i[0]}, ${i[1]}, index);\n      return ${s.texture2D}(${n}, uv);\n    }\n  `}(e,t);case 2:return function(e,t){let n=e.shapeInfo.logicalShape,a=e.name,r="get"+a.charAt(0).toUpperCase()+a.slice(1),s=e.shapeInfo.texShape,i=s[0],o=s[1],l=eL();if(null!=s&&Ns.arraysEqual(n,s))return t?`\n      vec4 ${r}(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2(${a}TexShape[1], ${a}TexShape[0]);\n\n        return ${l.texture2D}(${a}, uv);\n      }\n    `:`\n      vec4 ${r}(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2(${o}.0, ${i}.0);\n\n        return ${l.texture2D}(${a}, uv);\n      }\n    `;if(t)return`\n    vec4 ${r}(int row, int col) {\n      ivec2 packedTexShape = ivec2(ceil(float(${a}TexShape[0]) / 2.0), ceil(float(${a}TexShape[1]) / 2.0));\n      int valuesPerRow = int(ceil(float(${a}Shape[1]) / 2.0));\n      vec2 uv = packedUVfrom2D(valuesPerRow, packedTexShape[0], packedTexShape[1], row, col);\n      return ${l.texture2D}(${a}, uv);\n    }\n  `;let u=[Math.ceil(s[0]/2),Math.ceil(s[1]/2)];return`\n    vec4 ${r}(int row, int col) {\n      vec2 uv = packedUVfrom2D(${Math.ceil(n[1]/2)}, ${u[0]}, ${u[1]}, row, col);\n      return ${l.texture2D}(${a}, uv);\n    }\n  `}(e,t);case 3:return function(e,t){let n=e.shapeInfo.logicalShape,a=e.name,r="get"+a.charAt(0).toUpperCase()+a.slice(1),s=e.shapeInfo.texShape,i=[Math.ceil(s[0]/2),Math.ceil(s[1]/2)];if(1===n[0]){let a=[1,2],s=["b","row","col"];return`\n        ${lL(xL(e,n.slice(1)),t)}\n        vec4 ${r}(int b, int row, int col) {\n          return ${r}(${bL(s,a)});\n        }\n      `}let o=eL();if(t)return`\n    vec4 ${r}(int b, int row, int col) {\n      ivec2 packedTexShape = ivec2(ceil(float(${a}TexShape[0]) / 2.0), ceil(float(${a}TexShape[1]) / 2.0));\n      int valuesPerRow = int(ceil(float(${a}Shape[2]) / 2.0));\n      int texelsInBatch = valuesPerRow * int(ceil(float(${a}Shape[1]) / 2.0));\n      vec2 uv = packedUVfrom3D(\n        packedTexShape[0], packedTexShape[1], texelsInBatch, valuesPerRow, b, row, col);\n      return ${o.texture2D}(${a}, uv);\n    }\n  `;let l=i[0],u=i[1],d=Math.ceil(n[2]/2);return`\n    vec4 ${r}(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        ${l}, ${u}, ${d*Math.ceil(n[1]/2)}, ${d}, b, row, col);\n      return ${o.texture2D}(${a}, uv);\n    }\n  `}(e,t);default:return function(e,t){let n=e.name,a="get"+n.charAt(0).toUpperCase()+n.slice(1),r=eL();if(t)return`\n    vec4 ${a}(int b2, int b, int row, int col) {\n      int valuesPerRow = int(ceil(float(${n}Shape[3]) / 2.0));\n      int texelsInBatch = valuesPerRow * int(ceil(float(${n}Shape[2]) / 2.0));\n      int index = b * texelsInBatch + (row / 2) * valuesPerRow + (col / 2);\n      texelsInBatch *= ${n}Shape[1];\n      index = b2 * texelsInBatch + index;\n      ivec2 packedTexShape = ivec2(ceil(float(${n}TexShape[0]) / 2.0), ceil(float(${n}TexShape[1]) / 2.0));\n      int texR = index / packedTexShape[1];\n      int texC = index - texR * packedTexShape[1];\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2(packedTexShape[1], packedTexShape[0]); return ${r.texture2D}(${n}, uv);\n    }\n  `;let s=e.shapeInfo.logicalShape,i=s.length,o=e.shapeInfo.texShape,l=[Math.ceil(o[0]/2),Math.ceil(o[1]/2)],u=l[0],d=l[1],c=Math.ceil(s[i-1]/2),p=c*Math.ceil(s[i-2]/2),h="int b, int row, int col",m=`b * ${p} + (row / 2) * ${c} + (col / 2)`;for(let f=2;f<i-1;f++)h=`int b${f}, `+h,p*=s[i-f-1],m=`b${f} * ${p} + `+m;return`\n    vec4 ${a}(${h}) {\n      int index = ${m};\n      int texR = index / ${d};\n      int texC = index - texR * ${d};\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2(${d}, ${u});\n      return ${r.texture2D}(${n}, uv);\n    }\n  `}(e,t)}}var uL="\nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",dL="\nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",cL="\nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n",pL="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n";function hL(e){return`offset${e}`}function mL(e){let t=e.name,n=Ns.sizeFromShape(e.shapeInfo.logicalShape);return n<2?`return ${t};`:`\n    for (int i = 0; i < ${n}; i++) {\n      if (i == index) {\n        return ${t}[i];\n      }\n    }\n  `}function fL(e){if(e<=1)return"int";if(2===e)return"ivec2";if(3===e)return"ivec3";if(4===e)return"ivec4";if(5===e)return"ivec5";if(6===e)return"ivec6";throw Error(`GPU for rank ${e} is not yet supported`)}function gL(e,t,n){let{newShape:a,keptDims:r}=Ns.squeezeShape(t),s=t.length,i=e&&3===s&&1===t[0],o=i?t.slice(1):a,l=!e&&s>1&&!Ns.arraysEqual(t,n)&&a.length<s||i;return{useSqueezeShape:l,uniformShape:l?o:t,keptDims:r}}function xL(e,t){let n=JSON.parse(JSON.stringify(e));return n.shapeInfo.logicalShape=t,n}function bL(e,t){return t.map(t=>e[t]).join(", ")}function yL(e,t,n){let a,r,s,i=[],o=[],l=null,u=null;u=e.getUniformLocation(n,"NAN",!1),1===Pt().getNumber("WEBGL_VERSION")&&(l=e.getUniformLocation(n,"INFINITY",!1));let d=!1;for(let c of t.variableNames){let a={name:c,uniform:e.getUniformLocation(n,c,d),offset:e.getUniformLocation(n,`offset${c}`,d)};t.enableShapeUniforms&&(a.shape=e.getUniformLocation(n,`${c}Shape`,d),a.texShape=e.getUniformLocation(n,`${c}TexShape`,d)),i.push(a)}if(t.enableShapeUniforms&&(a=e.getUniformLocation(n,"outShape",d),s=e.getUniformLocation(n,"outShapeStrides",d),r=e.getUniformLocation(n,"outTexShape",d)),t.customUniforms)for(let c of t.customUniforms)o.push(e.getUniformLocation(n,c.name,d));return{variablesLocations:i,customUniformLocations:o,infLoc:l,nanLoc:u,outShapeLocation:a,outShapeStridesLocation:s,outTexShapeLocation:r}}function wL(e,t){if(e.length!==t.length)throw Error(`Binary was compiled with ${e.length} inputs, but was executed with ${t.length} inputs`);e.forEach((e,n)=>{let a=e.logicalShape,r=t[n],s=r.shape;if(!Ns.arraysEqual(a,s))throw Error(`Binary was compiled with different shapes than the current args. Shapes ${a} and ${s} must match`);if(e.isUniform&&r.isUniform)return;let i=e.texShape,o=r.isUniform?null:r.texData.texShape;if(!Ns.arraysEqual(i,o))throw Error(`Binary was compiled with different texture shapes than the current args. Shape ${i} and ${o} must match`)})}function vL(e){return Pt().getBool("WEBGL_USE_SHAPES_UNIFORMS")&&e<=4}var kL=class{constructor(e){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outPackingScheme=UO.DENSE,this.customUniforms=[{name:"texShape",type:"ivec2"}];let t=eL();this.outputShape=e,this.enableShapeUniforms=vL(this.outputShape.length),this.userCode=`\n      ivec3 outCoordsFromFlatIndex(int index) {\n        ${this.enableShapeUniforms?nL(["r","c","d"],e):tL(["r","c","d"],e)}\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx * vec2(texShape[0], texShape[1]));\n        int index = 4 * (resTexRC.x * texShape[1] + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        ${t.output} = result;\n      }\n    `}},NL=class{constructor(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outPackingScheme=UO.DENSE,this.customUniforms=[{name:"texShape",type:"ivec2"}];let t=eL();this.outputShape=e,this.enableShapeUniforms=vL(this.outputShape.length),this.userCode=`\n      ivec3 outCoordsFromFlatIndex(int index) {\n        ${this.enableShapeUniforms?nL(["r","c","d"],e):tL(["r","c","d"],e)}\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx * vec2(texShape[0], texShape[1]));\n        int index = 4 * (resTexRC.x * texShape[1] + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        ${t.output} = result;\n      }\n    `}},SL=class{constructor(e){this.variableNames=["A"],this.outTexUsage=GO.DOWNLOAD;let t=eL();this.outputShape=e,this.userCode=`\n      ${rL}\n\n      void main() {\n        float x = getAAtOutCoords();\n        ${t.output} = encode_float(x);\n      }\n    `}},IL=class{constructor(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outTexUsage=GO.DOWNLOAD;let t=eL();this.outputShape=e,this.userCode=`\n      ${rL}\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        ${t.output} = encode_float(x);\n      }\n    `}},_L={R:0,G:1,B:2,A:3},CL=class{constructor(e,t=!1,n="RGBA"){this.variableNames=["A"],this.customUniforms=[{name:"texShape",type:"ivec2"}];let a=eL();this.outputShape=e,this.enableShapeUniforms=vL(this.outputShape.length);let r="result";t&&(r="floor(result * 255. + 0.5)");let s="";for(let i=0;i<n.length;i++){let e=n[i];s+=`\n          if(offset == ${i}) {\n            result = values[${_L[e]}];\n          }`}this.userCode=`\n      ${this.enableShapeUniforms?"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * outShapeStrides[0] + coords.y * outShapeStrides[1] + coords.z;\n  }\n":aL(e)}\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int flatIndex = getFlatIndex(coords);\n        float result = 0.;\n        int offset = imod(flatIndex, ${n.length});\n\n        flatIndex = idiv(flatIndex, ${n.length}, 1.);\n\n        int r = flatIndex / texShape[1];\n        if (r < texShape[0]) {\n          int c = imod(flatIndex, texShape[1]);\n          vec2 uv = (vec2(c, r) + halfCR) / vec2(texShape[1], texShape[0]);\n          vec4 values = ${a.texture2D}(A, uv);\n          ${s}\n        }\n        ${a.output} = vec4(${r}, 0., 0., 0.);\n      }\n    `}},TL=class{constructor(e,t=!1){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.customUniforms=[{name:"texShape",type:"ivec2"}];let n=eL();this.outputShape=e,this.enableShapeUniforms=vL(this.outputShape.length);let a="",r="result";t&&(r="floor(result * 255. + 0.5)");for(let s=0;s<=1;s++)for(let t=0;t<=1;t++){let r=2*s+t;a+=`\n          localCoords = coords;\n          if(localCoords[2] + ${t} < ${this.enableShapeUniforms?"outShape[2]":`${e[2]}`}) {\n          localCoords[2] += ${t};\n          if (localCoords[1] + ${s} < ${this.enableShapeUniforms?"outShape[1]":`${e[1]}`}) {\n            localCoords[1] += ${s};\n\n            flatIndex = getFlatIndex(localCoords);\n            offset = imod(flatIndex, 4);\n\n            flatIndex = idiv(flatIndex, 4, 1.);\n\n            int r = flatIndex / texShape[1];\n            int c = imod(flatIndex, texShape[1]);\n            vec2 uv = (vec2(c, r) + halfCR) / vec2(texShape[1], texShape[0]);\n            values = ${n.texture2D}(A, uv);\n\n            if (offset == 0) {\n              result[${r}] = values[0];\n            } else if (offset == 1) {\n              result[${r}] = values[1];\n            } else if (offset == 2) {\n              result[${r}] = values[2];\n            } else {\n              result[${r}] = values[3];\n            }\n          }\n        }\n        `}this.userCode=`\n        ${this.enableShapeUniforms?"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * outShapeStrides[0] + coords.y * outShapeStrides[1] + coords.z;\n  }\n":aL(e)}\n\n        void main() {\n          ivec3 coords = getOutputCoords();\n\n          vec4 result = vec4(0.);\n          int flatIndex, r, c, offset;\n          ivec3 localCoords;\n          vec2 uv;\n          vec4 values;\n\n          ${a}\n\n          ${n.output} = ${r};\n        }\n    `}},EL={};function AL(e){let t=eL();return oj(e,`${t.version}\n    precision highp float;\n    ${t.attribute} vec3 clipSpacePos;\n    ${t.attribute} vec2 uv;\n    ${t.varyingVs} vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }`)}function $L(e){return gj(e,new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]))}function RL(e){return xj(e,new Uint16Array([0,1,2,2,1,3]))}function FL(e,t,n,a,r,s){wj(t,n);let i=yj(e),o=e.TEXTURE_2D;return tj(e,()=>e.bindTexture(o,i)),tj(e,()=>e.texParameteri(o,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE)),tj(e,()=>e.texParameteri(o,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),tj(e,()=>e.texParameteri(o,e.TEXTURE_MIN_FILTER,e.NEAREST)),tj(e,()=>e.texParameteri(o,e.TEXTURE_MAG_FILTER,e.NEAREST)),1===Pt().getNumber("WEBGL_VERSION")?tj(e,()=>e.texImage2D(o,0,a,t,n,0,r,s,null)):tj(e,()=>e.texStorage2D(o,1,a,t,n)),tj(e,()=>e.bindTexture(e.TEXTURE_2D,null)),{texture:i,texShape:[n,t]}}function DL(e){return e.internalFormatFloat}function ML(e,t,n,a){let[r,s]=ZO(t,n);return FL(e,r,s,DL(a),a.textureFormatFloat,e.FLOAT)}function OL(e){return e.internalFormatHalfFloat}function jL(e,t,n,a){let[r,s]=ZO(t,n);return FL(e,r,s,OL(a),a.textureFormatFloat,a.textureTypeHalfFloat)}function LL(e){return e.downloadTextureFormat}function zL(e,t,n,a){let[r,s]=ZO(t,n);return FL(e,r,s,LL(a),e.RGBA,e.UNSIGNED_BYTE)}function PL(e){return e.internalFormatPackedFloat}function BL(e,t,n,a){let[r,s]=QO(t,n);return FL(e,r,s,PL(a),e.RGBA,e.FLOAT)}function WL(e){return e.internalFormatPackedHalfFloat}function VL(e,t,n,a){let[r,s]=QO(t,n);return FL(e,r,s,WL(a),e.RGBA,a.textureTypeHalfFloat)}function UL(e,t,n){return tj(e,()=>e.bindBuffer(e.ARRAY_BUFFER,n)),kj(e,t,"clipSpacePos",n,3,20,0)&&kj(e,t,"uv",n,2,20,12)}function GL(e,t,n,a,r,s){let i,o,l;tj(e,()=>e.bindTexture(e.TEXTURE_2D,t)),r instanceof Uint8Array?(i=new Uint8Array(n*a*4),o=e.UNSIGNED_BYTE,l=e.RGBA):(i=new Float32Array(n*a*4),o=e.FLOAT,l=s.internalFormatPackedFloat),i.set(r),2===Pt().getNumber("WEBGL_VERSION")?tj(e,()=>e.texSubImage2D(e.TEXTURE_2D,0,0,0,n,a,e.RGBA,o,i)):tj(e,()=>e.texImage2D(e.TEXTURE_2D,0,l,n,a,0,e.RGBA,o,i)),tj(e,()=>e.bindTexture(e.TEXTURE_2D,null))}function HL(e,t,n){tj(e,()=>e.bindTexture(e.TEXTURE_2D,t)),n.data instanceof Uint8Array?2===Pt().getNumber("WEBGL_VERSION")?tj(e,()=>e.texSubImage2D(e.TEXTURE_2D,0,0,0,n.width,n.height,e.RGBA,e.UNSIGNED_BYTE,n.data)):tj(e,()=>e.texImage2D(e.TEXTURE_2D,0,e.RGBA,n.width,n.height,0,e.RGBA,e.UNSIGNED_BYTE,n.data)):2===Pt().getNumber("WEBGL_VERSION")?tj(e,()=>e.texSubImage2D(e.TEXTURE_2D,0,0,0,e.RGBA,e.UNSIGNED_BYTE,n)):tj(e,()=>e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n)),tj(e,()=>e.bindTexture(e.TEXTURE_2D,null))}function qL(e,t,n,a){let r=e.createBuffer();tj(e,()=>e.bindBuffer(e.PIXEL_PACK_BUFFER,r));let s=16*t*n;return tj(e,()=>e.bufferData(e.PIXEL_PACK_BUFFER,s,e.STREAM_READ)),tj(e,()=>e.readPixels(0,0,n,t,e.RGBA,e.FLOAT,0)),tj(e,()=>e.bindBuffer(e.PIXEL_PACK_BUFFER,null)),r}function KL(e,t,n){let a=e,r=new Float32Array(n);return a.bindBuffer(a.PIXEL_PACK_BUFFER,t),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,r),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),r}function XL(e,t,n,a){let[r,s]=ZO(t,n),i=new Uint8Array(function(e){return 4*e}(t*n));return tj(e,()=>e.readPixels(0,0,r,s,a.downloadTextureFormat,e.UNSIGNED_BYTE,i)),new Float32Array(i.buffer)}function YL(e,t,n,a,r,s,i,o){let l=e,u=new Float32Array(function(e,t){let[n,a]=QO(e,t);return n*a*4}(s,i));return l.bindBuffer(l.PIXEL_PACK_BUFFER,t),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,u),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),u}function ZL(e,t,n){let a=new Float32Array(t*n*4);return tj(e,()=>e.readPixels(0,0,n,t,e.RGBA,e.FLOAT,a)),a}xe(EL,{bindVertexProgramAttributeStreams:()=>UL,createBufferFromOutputTexture:()=>qL,createFloat16MatrixTexture:()=>jL,createFloat16PackedMatrixTexture:()=>VL,createFloat32MatrixTexture:()=>ML,createIndexBuffer:()=>RL,createPackedMatrixTexture:()=>BL,createUnsignedBytesMatrixTexture:()=>zL,createVertexBuffer:()=>$L,createVertexShader:()=>AL,downloadByteEncodedFloatMatrixFromOutputTexture:()=>XL,downloadFloat32MatrixFromBuffer:()=>KL,downloadMatrixFromPackedOutputTexture:()=>ZL,downloadPackedMatrixFromBuffer:()=>YL,getInternalFormatForFloat16MatrixTexture:()=>OL,getInternalFormatForFloat16PackedMatrixTexture:()=>WL,getInternalFormatForFloat32MatrixTexture:()=>DL,getInternalFormatForPackedMatrixTexture:()=>PL,getInternalFormatForUnsignedBytesMatrixTexture:()=>LL,uploadDenseMatrixToTexture:()=>GL,uploadPixelDataToTexture:()=>HL});var JL=class{constructor(e){this.outputTexture=null,this.program=null,this.disposed=!1,this.itemsToPoll=[];let t=Pt().getNumber("WEBGL_VERSION");if(null!=e?(this.gl=e,XO(t,e)):this.gl=YO(t),e=this.gl,2===Pt().getNumber("WEBGL_VERSION")){let t=e;this.createVertexArray=()=>tj(t,()=>t.createVertexArray()),this.bindVertexArray=e=>tj(t,()=>t.bindVertexArray(e)),this.deleteVertexArray=e=>tj(t,()=>t.deleteVertexArray(e)),this.getVertexArray=()=>tj(t,()=>t.getParameter(t.VERTEX_ARRAY_BINDING))}else if(null!=e){let t=e.getExtension("OES_vertex_array_object");if(null==t)throw new Error("All WebGL1 implementations are expected to offer OES_vertex_array_object.");this.createVertexArray=()=>tj(e,()=>t.createVertexArrayOES()),this.bindVertexArray=n=>tj(e,()=>t.bindVertexArrayOES(n)),this.deleteVertexArray=n=>tj(e,()=>t.deleteVertexArrayOES(n)),this.getVertexArray=()=>tj(e,()=>e.getParameter(t.VERTEX_ARRAY_BINDING_OES))}let n="WEBGL_color_buffer_float",a="EXT_color_buffer_half_float";if(this.parallelCompilationExtension=this.gl.getExtension("KHR_parallel_shader_compile"),1===Pt().getNumber("WEBGL_VERSION")){let e="OES_texture_float",t="OES_texture_half_float";if(this.textureFloatExtension=ij(this.gl,e),Hj(this.gl,t))this.textureHalfFloatExtension=ij(this.gl,t);else if(Pt().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support half float textures, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.");if(this.colorBufferFloatExtension=this.gl.getExtension(n),Hj(this.gl,a))this.colorBufferHalfFloatExtension=ij(this.gl,a);else if(Pt().get("WEBGL_FORCE_F16_TEXTURES"))throw new Error("GL context does not support color renderable half floats, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.")}else if(n="EXT_color_buffer_float",Hj(this.gl,n))this.colorBufferFloatExtension=this.gl.getExtension(n);else{if(!Hj(this.gl,a))throw new Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension(a)}this.vertexBuffer=$L(this.gl),this.indexBuffer=RL(this.gl),this.framebuffer=vj(this.gl),this.textureConfig=ej(this.gl,this.textureHalfFloatExtension)}get debug(){return Pt().getBool("DEBUG")}dispose(){if(this.disposed)return;this.program,this.outputTexture;let e=this.gl;tj(e,()=>e.finish()),tj(e,()=>e.bindFramebuffer(e.FRAMEBUFFER,null)),tj(e,()=>e.deleteFramebuffer(this.framebuffer)),tj(e,()=>e.bindBuffer(e.ARRAY_BUFFER,null)),tj(e,()=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)),tj(e,()=>e.deleteBuffer(this.indexBuffer)),this.disposed=!0}createFloat32MatrixTexture(e,t){return this.throwIfDisposed(),ML(this.gl,e,t,this.textureConfig)}createFloat16MatrixTexture(e,t){return this.throwIfDisposed(),jL(this.gl,e,t,this.textureConfig)}createUnsignedBytesMatrixTexture(e,t){return this.throwIfDisposed(),zL(this.gl,e,t,this.textureConfig)}uploadPixelDataToTexture(e,t){this.throwIfDisposed(),HL(this.gl,e,t)}uploadDenseMatrixToTexture(e,t,n,a){this.throwIfDisposed(),GL(this.gl,e,t,n,a,this.textureConfig)}createFloat16PackedMatrixTexture(e,t){return this.throwIfDisposed(),VL(this.gl,e,t,this.textureConfig)}createPackedMatrixTexture(e,t){return this.throwIfDisposed(),BL(this.gl,e,t,this.textureConfig)}deleteMatrixTexture(e){this.throwIfDisposed(),this.outputTexture===e&&(Aj(this.gl,this.framebuffer),this.outputTexture=null),tj(this.gl,()=>this.gl.deleteTexture(e))}downloadByteEncodedFloatMatrixFromOutputTexture(e,t,n){return this.downloadMatrixDriver(e,()=>XL(this.gl,t,n,this.textureConfig))}downloadPackedMatrixFromBuffer(e,t,n,a,r,s){return YL(this.gl,e,0,0,0,r,s,this.textureConfig)}downloadFloat32MatrixFromBuffer(e,t){return KL(this.gl,e,t)}createBufferFromTexture(e,t,n){this.bindTextureToFrameBuffer(e);let a=qL(this.gl,t,n,this.textureConfig);return this.unbindTextureToFrameBuffer(),a}createAndWaitForFence(){let e=this.createFence(this.gl);return this.pollFence(e)}createFence(e){let t,n;if(Pt().getBool("WEBGL_FENCE_API_ENABLED")){let a=e,r=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);e.flush(),n=()=>{let e=a.clientWaitSync(r,0,0);return e===a.ALREADY_SIGNALED||e===a.CONDITION_SATISFIED},t=r}else Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?(t=this.beginQuery(),this.endQuery(),n=()=>this.isQueryAvailable(t,Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))):n=()=>!0;return{query:t,isFencePassed:n}}downloadMatrixFromPackedTexture(e,t,n){return this.downloadMatrixDriver(e,()=>ZL(this.gl,t,n))}createProgram(e){this.throwIfDisposed();let t=this.gl;null==this.vertexShader&&(this.vertexShader=AL(t));let n=hj(t);tj(t,()=>t.attachShader(n,this.vertexShader)),tj(t,()=>t.attachShader(n,e)),mj(t,n);let a=Object.assign(n,{vao:this.createVertexArray()});return this.debug&&fj(t,a),a}buildVao(e){this.setProgram(e),this.bindVertexArray(e.vao);let t=this.gl;tj(t,()=>t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer)),UL(t,e,this.vertexBuffer)}deleteProgram(e){this.throwIfDisposed(),e===this.program&&(this.program=null),null!=e&&(tj(this.gl,()=>this.gl.deleteProgram(e)),this.deleteVertexArray(e.vao))}setProgram(e){this.throwIfDisposed(),this.program=e,null!=this.program&&this.debug&&fj(this.gl,this.program),tj(this.gl,()=>this.gl.useProgram(e))}getUniformLocation(e,t,n=!0){return this.throwIfDisposed(),n?Ij(this.gl,e,t):_j(this.gl,e,t)}getAttributeLocation(e,t){return this.throwIfDisposed(),tj(this.gl,()=>this.gl.getAttribLocation(e,t))}getUniformLocationNoThrow(e,t){return this.throwIfDisposed(),this.gl.getUniformLocation(e,t)}setInputMatrixTexture(e,t,n){this.throwIfDisposed(),this.throwIfNoProgram(),Cj(this.gl,e,t,n)}setOutputMatrixTexture(e,t,n){this.setOutputMatrixTextureDriver(e,n,t)}setOutputPackedMatrixTexture(e,t,n){this.throwIfDisposed();let[a,r]=QO(t,n);this.setOutputMatrixTextureDriver(e,a,r)}setOutputMatrixWriteRegion(e,t,n,a){this.setOutputMatrixWriteRegionDriver(n,e,a,t)}setOutputPackedMatrixWriteRegion(e,t,n,a){throw new Error("setOutputPackedMatrixWriteRegion not implemented.")}debugValidate(){null!=this.program&&fj(this.gl,this.program),$j(this.gl)}executeProgram(){this.throwIfDisposed(),this.throwIfNoProgram();let e=this.gl;this.debug&&(this.getVertexArray(),this.debugValidate()),tj(e,()=>e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0))}blockUntilAllProgramsCompleted(){this.throwIfDisposed(),tj(this.gl,()=>this.gl.finish())}getQueryTimerExtension(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=ij(this.gl,2===Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension}getQueryTimerExtensionWebGL2(){return this.getQueryTimerExtension()}getQueryTimerExtensionWebGL1(){return this.getQueryTimerExtension()}beginQuery(){if(2===Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){let e=this.gl,t=this.getQueryTimerExtensionWebGL2(),n=e.createQuery();return e.beginQuery(t.TIME_ELAPSED_EXT,n),n}let e=this.getQueryTimerExtensionWebGL1(),t=e.createQueryEXT();return e.beginQueryEXT(e.TIME_ELAPSED_EXT,t),t}endQuery(){if(2===Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){let e=this.gl,t=this.getQueryTimerExtensionWebGL2();return void e.endQuery(t.TIME_ELAPSED_EXT)}let e=this.getQueryTimerExtensionWebGL1();e.endQueryEXT(e.TIME_ELAPSED_EXT)}async waitForQueryAndGetTime(e){return await Ns.repeatedTry(()=>this.disposed||this.isQueryAvailable(e,Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))),this.getQueryTime(e,Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}getQueryTime(e,t){if(0===t)return null;if(2===t){let t=this.gl;return t.getQueryParameter(e,t.QUERY_RESULT)/1e6}{let t=this.getQueryTimerExtensionWebGL1();return t.getQueryObjectEXT(e,t.QUERY_RESULT_EXT)/1e6}}isQueryAvailable(e,t){if(0===t)return!0;if(2===t){let t=this.gl,n=this.getQueryTimerExtensionWebGL2(),a=t.getQueryParameter(e,t.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(n.GPU_DISJOINT_EXT)),a&&!this.disjoint}{let t=this.getQueryTimerExtensionWebGL1(),n=t.getQueryObjectEXT(e,t.QUERY_RESULT_AVAILABLE_EXT);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(t.GPU_DISJOINT_EXT)),n&&!this.disjoint}}pollFence(e){return new Promise(t=>{this.addItemToPoll(()=>e.isFencePassed(),()=>t())})}pollItems(){let e=function(e){let t=0;for(;t<e.length&&e[t]();++t);return t-1}(this.itemsToPoll.map(e=>e.isDoneFn));for(let t=0;t<=e;++t){let{resolveFn:e}=this.itemsToPoll[t];e()}this.itemsToPoll=this.itemsToPoll.slice(e+1)}addItemToPoll(e,t){if(this.itemsToPoll.push({isDoneFn:e,resolveFn:t}),this.itemsToPoll.length>1)return;let n;"setTimeoutCustom"in Pt().platform&&(n=Pt().platform.setTimeoutCustom.bind(Pt().platform)),Ns.repeatedTry(()=>(this.pollItems(),0===this.itemsToPoll.length),()=>0,null,n)}bindTextureToFrameBuffer(e){this.throwIfDisposed(),Ej(this.gl,e,this.framebuffer),this.debug&&$j(this.gl)}unbindTextureToFrameBuffer(){null!=this.outputTexture?(Ej(this.gl,this.outputTexture,this.framebuffer),this.debug&&$j(this.gl)):Aj(this.gl,this.framebuffer)}downloadMatrixDriver(e,t){this.bindTextureToFrameBuffer(e);let n=t();return this.unbindTextureToFrameBuffer(),n}setOutputMatrixTextureDriver(e,t,n){this.throwIfDisposed();let a=this.gl;Ej(a,e,this.framebuffer),this.debug&&$j(a),this.outputTexture=e,tj(a,()=>a.viewport(0,0,t,n)),tj(a,()=>a.scissor(0,0,t,n))}setOutputMatrixWriteRegionDriver(e,t,n,a){this.throwIfDisposed(),tj(this.gl,()=>this.gl.scissor(e,t,n,a))}throwIfDisposed(){if(this.disposed)throw new Error("Attempted to use disposed GPGPUContext.")}throwIfNoProgram(){if(null==this.program)throw new Error("No GPU program is currently set.")}},{addImpl:QL,bincountImpl:ez,bincountReduceImpl:tz,bitwiseAndImpl:nz,castImpl:az,ceilImpl:rz,concatImpl:sz,equalImpl:iz,expImpl:oz,expm1Impl:lz,floorImpl:uz,gatherNdImpl:dz,gatherV2Impl:cz,greaterImpl:pz,greaterEqualImpl:hz,lessImpl:mz,lessEqualImpl:fz,linSpaceImpl:gz,logImpl:xz,maxImpl:bz,maximumImpl:yz,minimumImpl:wz,multiplyImpl:vz,negImpl:kz,notEqualImpl:Nz,prodImpl:Sz,raggedGatherImpl:Iz,raggedRangeImpl:_z,raggedTensorToTensorImpl:Cz,rangeImpl:Tz,rsqrtImpl:Ez,scatterImpl:Az,sigmoidImpl:$z,simpleAbsImpl:Rz,sliceImpl:Fz,sparseFillEmptyRowsImpl:Dz,sparseReshapeImpl:Mz,sparseSegmentReductionImpl:Oz,sqrtImpl:jz,staticRegexReplaceImpl:Lz,stridedSliceImpl:zz,stringNGramsImpl:Pz,stringSplitImpl:Bz,stringToHashBucketFastImpl:Wz,subImpl:Vz,tileImpl:Uz,topKImpl:Gz,transposeImpl:Hz,uniqueImpl:qz}=cA;function Kz(e,t){return["x","y","z","w","u","v"].slice(0,t).map(t=>`${e}.${t}`)}function Xz(e,t){return 1===t?[e]:Kz(e,t)}var Yz=class{constructor(e){if(this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outputShape=e,this.rank=e.length,this.enableShapeUniforms=vL(this.outputShape.length),0===this.rank)this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ";else{let e=Xz("rc",this.rank),t=fL(this.rank),n=this.getOutOfBoundsCondition(e),a=this.getSetup(e),r=this.getOutput(e);this.userCode=`\n        void main() {\n          ${t} rc = getOutputCoords();\n\n          if(${n}) {\n            setOutput(vec4(0));\n          } else {\n            ${a}\n\n            setOutput(vec4(${r}));\n          }\n        }\n      `}}getSourceCoordsArr(e){let t=[];for(let n=0;n<=1;n++)for(let a=0;a<=1;a++){let r=`${0===n?"r":"rp1"}, ${0===a?"c":"cp1"}`;for(let t=2;t<this.rank;t++)r=`${e[e.length-1-t]},`+r;t.push(r)}return t}getOutOfBoundsCondition(e){if(1===this.rank)return`rc > ${this.enableShapeUniforms?"outShape":this.outputShape[0]}`;let t="";for(let n=this.rank-2;n<this.rank;n++)t+=`${e[n]} >= ${this.enableShapeUniforms?`outShape[${n}]`:this.outputShape[n]}`,n<this.rank-1&&(t+="||");return t}getSetup(e){if(1===this.rank)return"";let t=e.slice(-2),n=this.enableShapeUniforms?`outShape[${this.rank} - 1]`:this.outputShape[this.rank-1],a=this.enableShapeUniforms?`outShape[${this.rank} - 2]`:this.outputShape[this.rank-2];return`\n      int r = ${t[0]};\n      int c = ${t[1]};\n      int rp1 = r + 1;\n      int cp1 = c + 1;\n\n      bool cEdge = cp1 >= ${n};\n      bool rEdge = rp1 >= ${a};\n    `}getOutput(e){let t=this.getSourceCoordsArr(e);return 1===this.rank?`getA(rc), (rc + 1 >= ${this.enableShapeUniforms?"outShape":this.outputShape[0]} ? 0. : getA(rc + 1)), 0, 0`:`getA(${t[0]}),\n            cEdge ? 0. : getA(${t[1]}),\n            rEdge ? 0. : getA(${t[2]}),\n            rEdge || cEdge ? 0. : getA(${t[3]})`}},Zz=class{constructor(e,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"inputShape",type:"ivec3"}],this.outputShape=e,this.enableShapeUniforms=vL(this.outputShape.length);let n="";for(let a=0;a<4;a++){let e="thisRC = rc;";a%2==1&&(e+="thisRC.z += 1;"),a>1&&(e+="thisRC.y += 1;"),n+=`\n        ${e}\n        ${a>0?"if(thisRC.y < rows && thisRC.z < cols){":""}\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result[${a}] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        ${a>0?"}":""}\n      `}this.userCode=`\n      ${function(e,t){return`\n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      ${t?function(e,t,n="index"){let a=function(e,t){let n=e.length,a=e.map(e=>`${t}[${e}]`),r=new Array(n-1);r[n-2]=a[n-1];for(let s=n-3;s>=0;--s)r[s]=`(${r[s+1]} * ${a[s+1]})`;return r}(e.map((e,t)=>t),t);return a.map((t,r)=>`int ${e[r]} = ${n} / ${a[r]}; ${r===a.length-1?`int ${e[r+1]} = ${n} - ${e[r]} * ${a[r]}`:`index -= ${e[r]} * ${a[r]}`};`).join("")}(["r","c","d"],"inputShape"):tL(["r","c","d"],e)}\n      return ivec3(r, c, d);\n    }\n  `}(t,this.enableShapeUniforms)}\n      ${this.enableShapeUniforms?"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * outShapeStrides[0] + coords.y * outShapeStrides[1] + coords.z;\n  }\n":aL(e)}\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = ${this.enableShapeUniforms?"outShape[1]":e[1]};\n        int cols = ${this.enableShapeUniforms?"outShape[2]":e[2]};\n\n        ${n}\n\n        setOutput(result);\n      }\n    `}},Jz=class{constructor(e){this.gpgpu=e,this.numUsedTextures=0,this.numFreeTextures=0,this._numBytesAllocated=0,this._numBytesFree=0,this.freeTextures={},this.usedTextures={},this.logEnabled=!1}acquireTexture(e,t,n){let a=eP(t,n),r=tP(e,a,n);r in this.freeTextures||(this.freeTextures[r]=[]),r in this.usedTextures||(this.usedTextures[r]=[]);let s,i=Qz(e,a,this.gpgpu.gl,this.gpgpu.textureConfig,n);if(this.freeTextures[r].length>0){this.numFreeTextures--,this.numUsedTextures++,this._numBytesFree-=i,this.log();let e=this.freeTextures[r].pop();return this.usedTextures[r].push(e),e}return a===HO.PACKED_2X2_FLOAT32?s=this.gpgpu.createPackedMatrixTexture(e[0],e[1]):a===HO.PACKED_2X2_FLOAT16?s=this.gpgpu.createFloat16PackedMatrixTexture(e[0],e[1]):a===HO.UNPACKED_FLOAT32?s=this.gpgpu.createFloat32MatrixTexture(e[0],e[1]):a===HO.UNPACKED_FLOAT16?s=this.gpgpu.createFloat16MatrixTexture(e[0],e[1]):a===HO.PACKED_4X1_UNSIGNED_BYTE&&(s=this.gpgpu.createUnsignedBytesMatrixTexture(e[0],e[1])),this.usedTextures[r].push(s),this.numUsedTextures++,this._numBytesAllocated+=i,this.log(),s}releaseTexture(e,t,n,a){if(null==this.freeTextures)return;let r=eP(n,a),s=tP(t,r,a);s in this.freeTextures||(this.freeTextures[s]=[]);let i=Qz(t,r,this.gpgpu.gl,this.gpgpu.textureConfig,a),o=Pt().getNumber("WEBGL_DELETE_TEXTURE_THRESHOLD");-1!==o&&this._numBytesAllocated>o?(this.gpgpu.deleteMatrixTexture(e.texture),this._numBytesAllocated-=i):(this.freeTextures[s].push(e),this.numFreeTextures++,this._numBytesFree+=i),this.numUsedTextures--;let l=this.usedTextures[s],u=l&&l.indexOf(e);if(null==u||u<0)throw new Error("Cannot release a texture that was never provided by this texture manager");l[u]=l[l.length-1],l.pop(),this.log()}log(){this.logEnabled&&(this.numFreeTextures,this.numUsedTextures,this._numBytesFree,this._numBytesAllocated)}get numBytesAllocated(){return this._numBytesAllocated}get numBytesFree(){return this._numBytesFree}getNumUsedTextures(){return this.numUsedTextures}getNumFreeTextures(){return this.numFreeTextures}dispose(){if(null!=this.freeTextures){for(let e in this.freeTextures)this.freeTextures[e].forEach(e=>{this.gpgpu.deleteMatrixTexture(e.texture)});for(let e in this.usedTextures)this.usedTextures[e].forEach(e=>{this.gpgpu.deleteMatrixTexture(e.texture)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0,this._numBytesAllocated=0,this._numBytesFree=0}}};function Qz(e,t,n,a,r){let s,i=function(e,t){switch(e){case HO.PACKED_2X2_FLOAT32:return PL(t);case HO.PACKED_2X2_FLOAT16:return WL(t);case HO.UNPACKED_FLOAT32:return DL(t);case HO.UNPACKED_FLOAT16:return OL(t);case HO.PACKED_4X1_UNSIGNED_BYTE:return LL(t);default:throw new Error(`Unknown physical texture type ${e}`)}}(t,a);if(r){let[t,n]=QO(e[0],e[1]);s=t*n}else{let[t,n]=ZO(e[0],e[1]);s=t*n}let o=function(e,t){let n=e;if(t===n.R32F)return 4;if(t===n.R16F)return 2;if(t===n.RGBA32F||t===e.RGBA)return 16;if(t===n.RGBA16F)return 8;if(t===n.RGBA8)return 4;throw new Error(`Unknown internal format ${t}`)}(n,i);return s*o}function eP(e,t){if(e===GO.UPLOAD)return HO.PACKED_2X2_FLOAT32;if(e===GO.RENDER||null==e)return function(e){return Pt().getBool("WEBGL_RENDER_FLOAT32_ENABLED")?e?HO.PACKED_2X2_FLOAT32:HO.UNPACKED_FLOAT32:e?HO.PACKED_2X2_FLOAT16:HO.UNPACKED_FLOAT16}(t);if(e===GO.DOWNLOAD||e===GO.PIXELS)return HO.PACKED_4X1_UNSIGNED_BYTE;throw new Error(`Unknown logical texture type ${e}`)}function tP(e,t,n){return`${e[0]}_${e[1]}_${t}_${n}`}var nP=class{constructor(e,t){this.variableNames=["A"],this.outputShape=e,this.enableShapeUniforms=vL(this.outputShape.length),this.userCode=`\n      float unaryOperation(float x) {\n        ${t}\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    `}},aP="if (isnan(x)) return x;",rP="return abs(x);",sP=aP+"\n  return (x < 0.0) ? 0.0 : x;\n",iP=aP+"\n  return (x < 0.0) ? 0.0 : min(6.0, x);\n",oP="return x;",lP=class{constructor(e,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.enableShapeUniforms=vL(this.outputShape.length),this.userCode=`\n      vec4 unaryOperation(vec4 x) {\n        ${t}\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    `}},uP=class{constructor(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outputShape=e,this.enableShapeUniforms=vL(this.outputShape.length);let t=e.length,n=Xz("rc",t),a=fL(t),r=function(e,t){if(1===e)return"rc";let n="";for(let a=0;a<e;a++)n+=t[a],a<e-1&&(n+=",");return n}(t,n),s=n.slice(-2),i=t<=1?"rc":`vec2(${s.join(",")})`;this.userCode=`\n      void main() {\n        ${a} rc = getOutputCoords();\n        vec4 packedInput = getA(${r});\n\n        setOutput(getChannel(packedInput, ${i}));\n      }\n    `}},dP=Yg.whereImpl,cP={},pP=Pt().getNumber("CPU_HANDOFF_SIZE_THRESHOLD"),hP=class e extends Be{nextDataId(){return e.nextDataId++}constructor(e){if(super(),this.pendingRead=new WeakMap,this.pendingDisposal=new WeakSet,this.dataRefCount=new WeakMap,this.numBytesInGPU=0,this.uploadWaitMs=0,this.downloadWaitMs=0,this.lastGlFlushTime=0,this.warnedAboutMemory=!1,this.pendingDeletes=0,this.disposed=!1,!Pt().getBool("HAS_WEBGL"))throw new Error("WebGL is not supported on this device");let t;if(null!=e){if(e instanceof JL)t=e;else{let n=YO(Pt().getNumber("WEBGL_VERSION"),e);t=new JL(n)}this.binaryCache={},this.gpgpuCreatedLocally=!1}else{let e=YO(Pt().getNumber("WEBGL_VERSION"));t=new JL(e),this.binaryCache=function(e){return e in cP||(cP[e]={}),cP[e]}(Pt().getNumber("WEBGL_VERSION")),this.gpgpuCreatedLocally=!0}this.gpgpu=t,this.canvas=this.gpgpu.gl.canvas,this.textureManager=new Jz(this.gpgpu),this.numMBBeforeWarning=null==Pt().global.screen?1024:Pt().global.screen.height*Pt().global.screen.width*window.devicePixelRatio*600/1024/1024,this.texData=new Pe(this,Ji())}numDataIds(){return this.texData.numDataIds()-this.pendingDeletes}writeTexture(e,t,n,a,r,s){let i=this.makeTensorInfo(t,n),o=this.texData.get(i.dataId);o.isPacked=!1,o.texture={texture:e,texShape:[a,r]},o.texShape=[a,r];let l=jj(t),u=new CL(l,!1,s),d=this.runWebGLProgram(u,[i],n,[[a,r]]);return d.shape=t,o.texture=null,this.disposeIntermediateTensorInfo(i),d.dataId}write(e,t,n){if((Pt().getBool("WEBGL_CHECK_NUMERICAL_PROBLEMS")||Pt().getBool("DEBUG"))&&this.checkNumericalProblems(e),"complex64"===n&&null!=e)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");let a={id:this.nextDataId()};return this.texData.set(a,{shape:t,dtype:n,values:e,usage:GO.UPLOAD,refCount:1}),a}refCount(e){return this.texData.has(e)?this.texData.get(e).refCount:0}incRef(e){this.texData.get(e).refCount++}decRef(e){this.texData.has(e)&&this.texData.get(e).refCount--}move(e,t,n,a,r){if(Pt().getBool("DEBUG")&&this.checkNumericalProblems(t),"complex64"===a)throw new Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.texData.set(e,{shape:n,dtype:a,values:t,usage:GO.UPLOAD,refCount:r})}disposeIntermediateTensorInfo(e){this.disposeData(e.dataId)}readSync(e){let t=this.texData.get(e),{values:n,dtype:a,complexTensorInfos:r,slice:s,shape:i,isPacked:o}=t;if(null!=s){let t;t=o?new lP(i,oP):new nP(i,oP);let n=this.runWebGLProgram(t,[{dataId:e,shape:i,dtype:a}],a),r=this.readSync(n.dataId);return this.disposeIntermediateTensorInfo(n),r}if(null!=n)return this.convertAndCacheOnCPU(e);if("string"===a)return n;let l,u,d=null!=this.activeTimers;if(d&&(l=Ns.now()),"complex64"===a){let e=this.readSync(r.real.dataId),t=this.readSync(r.imag.dataId);u=Uf.mergeRealAndImagArrays(e,t)}else u=this.getValuesFromTexture(e);return d&&(this.downloadWaitMs+=Ns.now()-l),this.convertAndCacheOnCPU(e,u)}async read(e){if(this.pendingRead.has(e)){let t=this.pendingRead.get(e);return new Promise(e=>t.push(e))}let t=this.texData.get(e),{values:n,shape:a,slice:r,dtype:s,complexTensorInfos:i,isPacked:o}=t;if(null!=r){let t;t=o?new lP(a,oP):new nP(a,oP);let n=this.runWebGLProgram(t,[{dataId:e,shape:a,dtype:s}],s),r=this.read(n.dataId);return this.disposeIntermediateTensorInfo(n),r}if(null!=n)return this.convertAndCacheOnCPU(e);if(Pt().getBool("DEBUG")&&!Pt().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===Pt().getNumber("WEBGL_VERSION"))throw new Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");let l,u,d=null;if("complex64"!==s&&Pt().get("WEBGL_BUFFER_SUPPORTED")){l=this.decode(e);let t=this.texData.get(l.dataId);d=this.gpgpu.createBufferFromTexture(t.texture.texture,...JO(a))}if(this.pendingRead.set(e,[]),"complex64"!==s&&await this.gpgpu.createAndWaitForFence(),"complex64"===s){let e=await Promise.all([this.read(i.real.dataId),this.read(i.imag.dataId)]),t=e[0],n=e[1];u=Uf.mergeRealAndImagArrays(t,n)}else if(null==d)u=this.getValuesFromTexture(e);else{let e=Ns.sizeFromShape(a);u=this.gpgpu.downloadFloat32MatrixFromBuffer(d,e)}if(null!=l&&this.disposeIntermediateTensorInfo(l),null!=d){let e=this.gpgpu.gl;tj(e,()=>e.deleteBuffer(d))}let c=this.convertAndCacheOnCPU(e,u),p=this.pendingRead.get(e);return this.pendingRead.delete(e),p.forEach(e=>e(c)),this.pendingDisposal.has(e)&&(this.pendingDisposal.delete(e),this.disposeData(e)&&Ji().removeDataId(e,this),this.pendingDeletes--),c}readToGPU(e,t={}){let n=this.texData.get(e),{values:a,shape:r,slice:s,dtype:i,isPacked:o,texture:l}=n;if("complex64"===i)throw new Error("Does not support reading texture for complex64 dtype.");if(null!=s){let n;n=o?new lP(r,oP):new nP(r,oP);let a=this.runWebGLProgram(n,[{dataId:e,shape:r,dtype:i}],i),s=this.readToGPU(a,t);return this.disposeIntermediateTensorInfo(a),s}if(null==l)throw null!=a?new Error("Data is not on GPU but on CPU."):new Error("There is no data on GPU or CPU.");let u=this.decode(e,t.customTexShape),d=Ji().makeTensorFromTensorInfo(u),c=this.texData.get(u.dataId);return Object.assign({tensorRef:d},c.texture)}bufferSync(e){let t=this.readSync(e.dataId);if("string"===e.dtype)try{let n=t.map(e=>Ns.decodeString(e));return cl(e.shape,e.dtype,n)}catch(n){throw new Error("Failed to decode encoded string bytes into utf-8")}return cl(e.shape,e.dtype,t)}checkNumericalProblems(e){if(null!=e)for(let t=0;t<e.length;t++){let n=e[t];if(!rj(n))throw Pt().getBool("WEBGL_RENDER_FLOAT32_CAPABLE")?Error(`The value ${n} cannot be represented with your current settings. Consider enabling float32 rendering: 'tf.env().set('WEBGL_RENDER_FLOAT32_ENABLED', true);'`):Error(`The value ${n} cannot be represented on this device.`)}}getValuesFromTexture(e){let{shape:t,dtype:n,isPacked:a}=this.texData.get(e),r=Ns.sizeFromShape(t);if(Pt().getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){let n=this.decode(e),a=this.texData.get(n.dataId),s=this.gpgpu.downloadMatrixFromPackedTexture(a.texture.texture,...JO(t)).subarray(0,r);return this.disposeIntermediateTensorInfo(n),s}let s=Pt().getBool("WEBGL_PACK")&&!0===a,i=s?jj(t):t,o=s?new IL(i):new SL(i),l=this.runWebGLProgram(o,[{shape:i,dtype:n,dataId:e}],"float32"),u=this.texData.get(l.dataId),d=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(u.texture.texture,u.texShape[0],u.texShape[1]).subarray(0,r);return this.disposeIntermediateTensorInfo(l),d}timerAvailable(){return Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0}time(e){let t=this.activeTimers,n=[],a=!1;null==this.programTimersStack?(this.programTimersStack=n,a=!0):this.activeTimers.push(n),this.activeTimers=n,e();let r=Ns.flatten(this.activeTimers.map(e=>e.query)).filter(e=>null!=e),s=Ns.flatten(this.activeTimers.map(e=>e.name)).filter(e=>null!=e);this.activeTimers=t,a&&(this.programTimersStack=null);let i={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:null,wallMs:null};return(async()=>{if(Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0){let e=await Promise.all(r);i.kernelMs=Ns.sum(e),i.getExtraProfileInfo=()=>e.map((e,t)=>({name:s[t],ms:e})).map(e=>`${e.name}: ${e.ms}`).join(", ")}else i.kernelMs={error:"WebGL query timers are not supported in this environment."};return this.uploadWaitMs=0,this.downloadWaitMs=0,i})()}memory(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU,numBytesInGPUAllocated:this.textureManager.numBytesAllocated,numBytesInGPUFree:this.textureManager.numBytesFree}}startTimer(){return Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?this.gpgpu.beginQuery():{startMs:Ns.now(),endMs:null}}endTimer(e){return Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?(this.gpgpu.endQuery(),e):(e.endMs=Ns.now(),e)}async getQueryTime(e){if(Pt().getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0)return this.gpgpu.waitForQueryAndGetTime(e);let t=e;return t.endMs-t.startMs}disposeData(e,t=!1){if(this.pendingDisposal.has(e))return!1;if(!this.texData.has(e))return!0;if(t?this.texData.get(e).refCount=0:this.texData.get(e).refCount--,!t&&this.texData.get(e).refCount>0)return!1;if(this.pendingRead.has(e))return this.pendingDisposal.add(e),this.pendingDeletes++,!1;this.releaseGPUData(e);let{complexTensorInfos:n}=this.texData.get(e);return null!=n&&(this.disposeData(n.real.dataId,t),this.disposeData(n.imag.dataId,t)),this.texData.delete(e),!0}releaseGPUData(e){let{texture:t,dtype:n,texShape:a,usage:r,isPacked:s,slice:i}=this.texData.get(e),o=i&&i.origDataId||e,l=this.dataRefCount.get(o);l>1?this.dataRefCount.set(o,l-1):(this.dataRefCount.delete(o),null!=t&&(this.numBytesInGPU-=this.computeBytes(a,n),this.textureManager.releaseTexture(t,a,r,s)));let u=this.texData.get(e);u.texture=null,u.texShape=null,u.isPacked=!1,u.slice=null}getTexture(e){return this.uploadToGPU(e),this.texData.get(e).texture.texture}getDataInfo(e){return this.texData.get(e)}shouldExecuteOnCPU(e,t=pP){return Pt().getBool("WEBGL_CPU_FORWARD")&&e.every(e=>null==this.texData.get(e.dataId).texture&&Ns.sizeFromShape(e.shape)<t)}getGPGPUContext(){return this.gpgpu}where(e){Uf.warn("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");let t=e.dataSync();return dP(e.shape,t)}packedUnaryOp(e,t,n){let a=new lP(e.shape,t),r=this.compileAndRun(a,[e],n);return Ji().makeTensorFromTensorInfo(r)}abs(e){if(this.shouldExecuteOnCPU([e])&&"complex64"!==e.dtype){let t=Rz(this.texData.get(e.dataId).values);return this.makeOutput(e.shape,e.dtype,t)}if(Pt().getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(e,rP,e.dtype);let t=new nP(e.shape,rP),n=this.compileAndRun(t,[e]);return Ji().makeTensorFromTensorInfo(n)}makeTensorInfo(e,t,n){let a;if("string"===t&&null!=n&&n.length>0&&Ns.isString(n[0])){let r=n.map(e=>Ns.encodeString(e));a=this.write(r,e,t)}else a=this.write(n,e,t);return this.texData.get(a).usage=null,{dataId:a,shape:e,dtype:t}}makeOutput(e,t,n){return Ji().makeTensorFromTensorInfo(this.makeTensorInfo(e,t,n),this)}unpackTensor(e){let t=new uP(e.shape);return this.runWebGLProgram(t,[e],e.dtype)}packTensor(e){let t=new Yz(e.shape);return this.runWebGLProgram(t,[e],e.dtype,null,!0)}packedReshape(e,t){let n=[Mj(e.shape),...Oj(e.shape)],a={dtype:e.dtype,shape:n,dataId:e.dataId},r=[Mj(t),...Oj(t)],s=new Zz(r,n),i=[n],o=this.runWebGLProgram(s,[a],e.dtype,i,!0);return{dataId:o.dataId,shape:t,dtype:o.dtype}}decode(e,t){let n=this.texData.get(e),{isPacked:a,shape:r,dtype:s}=n;if(null!=t){let e=Ns.sizeFromShape(r),n=t[0]*t[1]*4;Ns.assert(e<=n,()=>"customTexShape is too small. Row * Column * 4 should be equal or larger than the size of the tensor data.")}let i,o=jj(r);i=a?new NL(o):new kL(o);let l=[null!=t?t:JO(o)];return{dtype:s,shape:r,dataId:this.runWebGLProgram(i,[{shape:o,dtype:s,dataId:e}],s,l,!0,t).dataId}}runWebGLProgram(e,t,n,a,r=!1,s){let i=this.makeTensorInfo(e.outputShape,n),o=this.texData.get(i.dataId);if(e.packedOutput&&(o.isPacked=!0),e.outPackingScheme===UO.DENSE){let t=null!=s?s:JO(e.outputShape);o.texShape=t.map(e=>2*e)}if(null!=e.outTexUsage&&(o.usage=e.outTexUsage),0===Ns.sizeFromShape(i.shape))return o.values=Ns.getTypedArrayFromDType(i.dtype,0),i;let l=[],u=t.map(t=>{if("complex64"===t.dtype)throw new Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");let n=this.texData.get(t.dataId);if(null==n.texture){if(!e.packedInputs&&Ns.sizeFromShape(t.shape)<=Pt().getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:t.shape,texData:null,isUniform:!0,uniformValues:n.values};e.packedInputs&&(n.isPacked=!0,n.shape=t.shape)}if(this.uploadToGPU(t.dataId),!!n.isPacked!=!!e.packedInputs)t=n.isPacked?this.unpackTensor(t):this.packTensor(t),l.push(t),n=this.texData.get(t.dataId);else if(n.isPacked&&!Pj(n.shape,t.shape)){let e=t,a=t.shape;t.shape=n.shape,t=this.packedReshape(t,a),l.push(t),n=this.texData.get(t.dataId),e.shape=a}return{shape:t.shape,texData:n,isUniform:!1}});this.uploadToGPU(i.dataId);let d,c={shape:i.shape,texData:o,isUniform:!1},p=function(e,t,n){let a="";t.concat(n).forEach(t=>{let r=null!=t.texData&&null!=t.texData.slice&&t.texData.slice.flatOffset>0;if(e.enableShapeUniforms&&!t.isUniform){let s=t.texData.texShape,{useSqueezeShape:i,uniformShape:o,keptDims:l}=gL(e.packedInputs,t.shape,s),u="",d="",c="";if(1===o.length&&e.packedInputs){let e=[Math.ceil(s[0]/2),Math.ceil(s[1]/2)];u=`${e[0]>1}_${e[1]>1}`}else if(2!==o.length||e.packedInputs){if(o.length>2&&!e.packedInputs){let e=Ns.computeStrides(o);c=`${e[0]===s[1]}_${e[e.length-1]===s[1]}`}}else d=`${o[0]>1}_${o[1]>1}`;let p=t.shape.length,h=2===o.length&&Ns.arraysEqual(t.shape,s),m=1===Ns.sizeFromShape(t.shape),f=Uf.getBroadcastDims(t.shape,n.shape),g=!e.packedInputs&&p===n.shape.length&&Ns.arraysEqual(s,n.texData.texShape),x=e.packedInputs||o.length>2?"":`${s[0]>1}_${s[1]>1}`;a+=`${p}_${g}_${i?l:""}_${o.length}_${m}_${f}_${h}_${u}_${d}_${c}_${x}_${r}`}else{let e=t.isUniform?"uniform":t.texData.texShape;a+=`${t.shape}_${e}_${r}`}});let r=e.userCode,s=e.constructor.name;return s+="_"+a+"_"+r+`${Pt().getNumber("WEBGL_VERSION")}`,s}(e,u,c),h=this.getAndSaveBinary(p,()=>function(e,t,n,a){let r=n.map((e,n)=>{let a={logicalShape:e.shape,texShape:e.isUniform?null:e.texData.texShape,isUniform:e.isUniform,isPacked:!e.isUniform&&e.texData.isPacked,flatOffset:null};return null!=e.texData&&null!=e.texData.slice&&e.texData.slice.flatOffset>0&&(a.flatOffset=e.texData.slice.flatOffset),{name:t.variableNames[n],shapeInfo:a}}),s=r.map(e=>e.shapeInfo),i={logicalShape:a.shape,texShape:a.texData.texShape,isUniform:!1,isPacked:a.texData.isPacked,flatOffset:null},o=iL(r,i,t),l=lj(e.gl,o),u=e.createProgram(l);return Pt().get("ENGINE_COMPILE_ONLY")?{program:t,fragmentShader:l,source:o,webGLProgram:u,inShapeInfos:s,outShapeInfo:i,variablesLocations:null,customUniformLocations:null,infLoc:null,nanLoc:null,outShapeLocation:null,outShapeStridesLocation:null,outTexShapeLocation:null}:(e.buildVao(u),Object.assign({program:t,fragmentShader:l,source:o,webGLProgram:u,inShapeInfos:s,outShapeInfo:i},yL(e,t,u)))}(this.gpgpu,e,u,c)),m=null!=this.activeTimers;m&&(d=this.startTimer()),Pt().get("ENGINE_COMPILE_ONLY")||function(e,t,n,a,r){t.program.enableShapeUniforms||(wL(t.inShapeInfos,n),wL([t.outShapeInfo],[a]));let s=a.texData.texture,i=a.texData.texShape;a.texData.isPacked?e.setOutputPackedMatrixTexture(s.texture,i[0],i[1]):e.setOutputMatrixTexture(s.texture,i[0],i[1]),e.setProgram(t.webGLProgram),e.bindVertexArray(t.webGLProgram.vao),1===Pt().getNumber("WEBGL_VERSION")&&null!==t.infLoc&&e.gl.uniform1f(t.infLoc,1/0),null!==t.nanLoc&&e.gl.uniform1f(t.nanLoc,NaN);for(let l=0;l<n.length;++l){let a=n[l],{uniform:r,offset:s,shape:i,texShape:o}=t.variablesLocations[l];if(i){let{uniformShape:n}=gL(t.program.packedInputs,a.shape,a.texData.texShape);switch(n.length){case 1:e.gl.uniform1iv(i,new Int32Array(n));break;case 2:e.gl.uniform2iv(i,new Int32Array(n));break;case 3:e.gl.uniform3iv(i,new Int32Array(n));break;case 4:e.gl.uniform4iv(i,new Int32Array(n))}}if(o&&e.gl.uniform2i(o,a.texData.texShape[0],a.texData.texShape[1]),null!=r){if(a.isUniform){if(Ns.sizeFromShape(a.shape)<2)e.gl.uniform1f(r,a.uniformValues[0]);else{let t=a.uniformValues;t instanceof Float32Array||(t=new Float32Array(t)),e.gl.uniform1fv(r,t)}continue}null!=a.texData.slice&&null!=s&&e.gl.uniform1i(s,a.texData.slice.flatOffset),e.setInputMatrixTexture(a.texData.texture.texture,r,l)}}let o=t.outShapeLocation;if(o)switch(a.shape.length){case 1:e.gl.uniform1iv(o,new Int32Array(a.shape));break;case 2:e.gl.uniform2iv(o,new Int32Array(a.shape));break;case 3:e.gl.uniform3iv(o,new Int32Array(a.shape));break;case 4:e.gl.uniform4iv(o,new Int32Array(a.shape))}if(t.outShapeStridesLocation){let n=Ns.computeStrides(a.shape);switch(a.shape.length){case 2:e.gl.uniform1iv(t.outShapeStridesLocation,new Int32Array(n));break;case 3:e.gl.uniform2iv(t.outShapeStridesLocation,new Int32Array(n));break;case 4:e.gl.uniform3iv(t.outShapeStridesLocation,new Int32Array(n))}}if(t.outTexShapeLocation&&e.gl.uniform2i(t.outTexShapeLocation,a.texData.texShape[0],a.texData.texShape[1]),t.program.customUniforms&&r)for(let l=0;l<t.program.customUniforms.length;++l){let n=t.program.customUniforms[l],a=t.customUniformLocations[l],s=r[l];if("float"===n.type)e.gl.uniform1fv(a,s);else if("vec2"===n.type)e.gl.uniform2fv(a,s);else if("vec3"===n.type)e.gl.uniform3fv(a,s);else if("vec4"===n.type)e.gl.uniform4fv(a,s);else if("int"===n.type)e.gl.uniform1iv(a,s);else if("ivec2"===n.type)e.gl.uniform2iv(a,s);else if("ivec3"===n.type)e.gl.uniform3iv(a,s);else{if("ivec4"!==n.type)throw Error(`uniform type ${n.type} is not supported yet.`);e.gl.uniform4iv(a,s)}}e.executeProgram()}(this.gpgpu,h,u,c,a),l.forEach(e=>this.disposeIntermediateTensorInfo(e)),m&&(d=this.endTimer(d),this.activeTimers.push({name:e.constructor.name,query:this.getQueryTime(d)}));let f=Pt().getNumber("WEBGL_FLUSH_THRESHOLD");if(f>0){let e=Ns.now();e-this.lastGlFlushTime>f&&(this.gpgpu.gl.flush(),this.lastGlFlushTime=e)}if(!Pt().getBool("WEBGL_LAZILY_UNPACK")&&o.isPacked&&!1===r){let e=this.unpackTensor(i);return this.disposeIntermediateTensorInfo(i),e}return i}compileAndRun(e,t,n,a,r=!1){return n=n||t[0].dtype,this.runWebGLProgram(e,t,n,a,r)}getAndSaveBinary(e,t){return e in this.binaryCache||(this.binaryCache[e]=t()),this.binaryCache[e]}getTextureManager(){return this.textureManager}dispose(){this.disposed||(Pt().getBool("IS_TEST")||Object.keys(this.binaryCache).forEach(e=>{this.gpgpu.deleteProgram(this.binaryCache[e].webGLProgram),delete this.binaryCache[e]}),this.textureManager.dispose(),null!=this.canvas&&"undefined"!=typeof HTMLCanvasElement&&this.canvas instanceof HTMLCanvasElement?this.canvas.remove():this.canvas=null,this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)}floatPrecision(){return null==this.floatPrecisionValue&&(this.floatPrecisionValue=to(()=>{if(!Pt().get("WEBGL_RENDER_FLOAT32_ENABLED")){let e=Pt().getBool("DEBUG");Pt().set("DEBUG",!1);let t=this.abs(sd(1e-8)).dataSync()[0];if(Pt().set("DEBUG",e),t>0)return 32}return 16})),this.floatPrecisionValue}epsilon(){return 32===this.floatPrecision()?1e-7:1e-4}uploadToGPU(e){let t=this.texData.get(e),{shape:n,dtype:a,values:r,texture:s,usage:i,isPacked:o}=t;if(null!=s)return;let l,u=null!=this.activeTimers;u&&(l=Ns.now());let d=t.texShape;if(null==d&&(d=Lj(n,o),t.texShape=d),null!=r){let e,s=jj(n),i=d[1],c=d[0],p=r instanceof Uint8Array||r instanceof Uint8ClampedArray;(o||!p)&&([i,c]=QO(d[0],d[1])),e=o?new TL(s,p):new CL(s,p);let h=p?[c,i]:d,m=this.makeTensorInfo(h,a),f=this.texData.get(m.dataId);f.usage=p?GO.PIXELS:GO.UPLOAD,f.texShape=h,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(m.dataId),i,c,r);let g=[[c,i]],x=this.runWebGLProgram(e,[m],a,g,!0),b=this.texData.get(x.dataId);t.texShape=b.texShape,t.isPacked=b.isPacked,t.usage=b.usage,Pt().get("ENGINE_COMPILE_ONLY")?this.disposeData(x.dataId):(t.texture=b.texture,t.values=null,this.texData.delete(x.dataId)),this.disposeIntermediateTensorInfo(m),u&&(this.uploadWaitMs+=Ns.now()-l)}else{let e=this.acquireTexture(d,i,a,o);t.texture=e}}convertAndCacheOnCPU(e,t){let n=this.texData.get(e),{dtype:a}=n;return null!=t&&(n.values=function(e,t){if("float32"===t||"complex64"===t)return e;if("int32"===t||"bool"===t){let n="int32"===t?new Int32Array(e.length):new Uint8Array(e.length);for(let t=0;t<n.length;++t)n[t]=Math.round(e[t]);return n}throw new Error(`Unknown dtype ${t}`)}(t,a)),n.values}acquireTexture(e,t,n,a){return this.numBytesInGPU+=this.computeBytes(e,n),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024&&((this.numBytesInGPU/1024/1024).toFixed(2),this.warnedAboutMemory=!0),this.textureManager.acquireTexture(e,t,a)}computeBytes(e,t){return e[0]*e[1]*Ns.bytesPerElement(t)}checkCompileCompletion(){for(let[,e]of Object.entries(this.binaryCache))this.checkCompletion_(e)}async checkCompileCompletionAsync(){let e=[];if(this.gpgpu.parallelCompilationExtension){for(let[,t]of Object.entries(this.binaryCache))e.push(this.checkCompletionAsync_(t));return Promise.all(e)}for(let[,t]of Object.entries(this.binaryCache)){let n=new Promise(e=>{try{this.checkCompletion_(t),e(!0)}catch(n){throw n}});e.push(n)}return Promise.all(e)}async checkCompletionAsync_(e){return this.gpgpu.gl.getProgramParameter(e.webGLProgram,this.gpgpu.parallelCompilationExtension.COMPLETION_STATUS_KHR)?this.checkCompletion_(e):(await Wf(),this.checkCompletionAsync_(e))}checkCompletion_(e){if(!1===this.gpgpu.gl.getProgramParameter(e.webGLProgram,this.gpgpu.gl.LINK_STATUS))throw!1===this.gpgpu.gl.getShaderParameter(e.fragmentShader,this.gpgpu.gl.COMPILE_STATUS)?(pj(e.source,this.gpgpu.gl.getShaderInfoLog(e.fragmentShader)),new Error("Failed to compile fragment shader.")):new Error("Failed to link vertex and fragment shaders.");return!0}getUniformLocations(){for(let e of Object.values(this.binaryCache)){this.gpgpu.buildVao(e.webGLProgram);let{variablesLocations:t,customUniformLocations:n,infLoc:a,nanLoc:r,outShapeLocation:s,outShapeStridesLocation:i,outTexShapeLocation:o}=yL(this.gpgpu,e.program,e.webGLProgram);e.variablesLocations=t,e.customUniformLocations=n,e.infLoc=a,e.nanLoc=r,e.outShapeLocation=s,e.outShapeStridesLocation=i,e.outTexShapeLocation=o}}createTensorFromGPUData(e,t,n){e.channels=e.channels||"RGBA";let{texture:a,height:r,width:s,channels:i}=e,o=Ji().backend;if(!o.gpgpu.gl.isTexture(a))throw new Error("The texture is invalid. Also, please make sure the texture and the TFJS WebGL backend are using the same canvas. If you want to use your own custom canvas, you have to create and use the custom TFJS WebGL backend created from the canvas through 'new tf.MathBackendWebGL(customCanvas)'.");let l=o.writeTexture(a,t,n,r,s,i);return Ji().makeTensorFromDataId(l,t,n,o)}};hP.nextDataId=0;var mP="4.22.0";function fP(){Pt().set("WEBGL_FORCE_F16_TEXTURES",!0)}Ai.isBrowser()&&po("webgl",()=>new hP,2);var gP={forceHalfFloat:fP},xP="\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n",bP=class{constructor(e,t,n){this.variableNames=["A","B"],this.outputShape=Uf.assertAndGetBroadcastShape(t,n),this.enableShapeUniforms=vL(this.outputShape.length),this.userCode=`\n      float binaryOperation(float a, float b) {\n        ${e}\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    `}},yP="\n  result.r = isNaN.r ? NAN : result.r;\n  result.g = isNaN.g ? NAN : result.g;\n  result.b = isNaN.b ? NAN : result.b;\n  result.a = isNaN.a ? NAN : result.a;\n",wP=class{constructor(e,t,n,a=!1){this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.packedInputs=!0,this.packedOutput=!0,this.outputShape=Uf.assertAndGetBroadcastShape(t,n);let r=this.outputShape.length;this.enableShapeUniforms=vL(r);let s="";if(a)if(0===r||1===Ns.sizeFromShape(this.outputShape))s="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ";else if(s=`\n          ${fL(r)} coords = getOutputCoords();\n        `,1===r)this.enableShapeUniforms?s+="\n            result.y = (coords + 1) >= outShape ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ":s+=`\n            result.y = (coords + 1) >= ${this.outputShape[0]} ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          `;else{let e=Xz("coords",r);this.enableShapeUniforms?s+=`\n            bool nextRowOutOfBounds =\n              (${e[r-2]} + 1) >= outShape[${r} - 2];\n            bool nextColOutOfBounds =\n              (${e[r-1]} + 1) >= outShape[${r} - 1];\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          `:s+=`\n            bool nextRowOutOfBounds =\n              (${e[r-2]} + 1) >= ${this.outputShape[r-2]};\n            bool nextColOutOfBounds =\n              (${e[r-1]} + 1) >= ${this.outputShape[r-1]};\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          `}this.userCode=`\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        ${e}\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        ${s}\n\n        setOutput(result);\n      }\n    `}};function vP(e){let{inputs:t,backend:n}=e,{x:a}=t;return n.incRef(a.dataId),{dataId:a.dataId,shape:a.shape,dtype:a.dtype}}var kP={kernelName:la,backendName:"webgl",kernelFunc:vP};function NP(e){let{inputs:t,backend:n}=e,{real:a,imag:r}=t,s=n.makeTensorInfo(a.shape,"complex64"),i=n.texData.get(s.dataId),o=vP({inputs:{x:a},backend:n}),l=vP({inputs:{x:r},backend:n});return i.complexTensorInfos={real:o,imag:l},s}var SP={kernelName:yn,backendName:"webgl",kernelFunc:NP},IP="return (a < 0.) ? b * a : a;",_P="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",CP={kernelName:ma,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{alpha:s}=a,i=n.makeTensorInfo([],"float32",Ns.createScalarValue(s,"float32")),o=Pt().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wP(_P,r.shape,i.shape):new bP(IP,r.shape,i.shape),l=n.runWebGLProgram(o,[r,i],"float32");return n.disposeIntermediateTensorInfo(i),l}},TP="return (a < 0.) ? b * a : a;",EP="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",AP={kernelName:er,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{x:a,alpha:r}=t,s=Pt().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wP(EP,a.shape,r.shape):new bP(TP,a.shape,r.shape);return n.runWebGLProgram(s,[a,r],"float32")}},$P="if (isnan(x)) return x;";function RP({opSnippet:e,packedOpSnippet:t,cpuKernelImpl:n,dtype:a}){return({inputs:r,backend:s})=>{let i,{x:o}=r,l=s,u=a||o.dtype;if(l.shouldExecuteOnCPU([o])&&null!=n){let e=l.texData.get(o.dataId),t=n(e.values,u);return l.makeTensorInfo(o.shape,u,t)}return i=Pt().getBool("WEBGL_PACK_UNARY_OPERATIONS")&&null!=t?new lP(o.shape,t):new nP(o.shape,e),l.runWebGLProgram(i,[o],u)}}function FP({opSnippet:e,packedOpSnippet:t,checkOutOfBounds:n=!1,supportsComplex:a=!1,cpuKernelImpl:r,dtype:s}){return({inputs:i,backend:o})=>{let{a:l,b:u}=i,d=o;if(a&&"complex64"===l.dtype){let t=d.texData.get(l.dataId),n=d.texData.get(u.dataId),[a,r]=[[t.complexTensorInfos.real,n.complexTensorInfos.real],[t.complexTensorInfos.imag,n.complexTensorInfos.imag]].map(t=>{let[n,a]=t,r={dataId:n.dataId,dtype:n.dtype,shape:l.shape},s={dataId:a.dataId,dtype:a.dtype,shape:u.shape},i=new bP(e,l.shape,u.shape);return d.runWebGLProgram(i,[r,s],mi(n.dtype,a.dtype))}),s=NP({inputs:{real:a,imag:r},backend:d});return d.disposeIntermediateTensorInfo(a),d.disposeIntermediateTensorInfo(r),s}let c,p=s||mi(l.dtype,u.dtype);if(("string"===l.dtype||"string"===u.dtype||d.shouldExecuteOnCPU([l,u]))&&null!=r){let e=d.texData.get(l.dataId).values,t=d.texData.get(u.dataId).values,n="string"===l.dtype?Uf.fromUint8ToStringArray(e):e,a="string"===l.dtype?Uf.fromUint8ToStringArray(t):t,[s,i]=r(l.shape,u.shape,n,a,p),o=d.makeTensorInfo(i,p);return d.texData.get(o.dataId).values=s,o}return c=Pt().getBool("WEBGL_PACK_BINARY_OPERATIONS")&&null!=t?new wP(t,l.shape,u.shape,n):new bP(e,l.shape,u.shape),d.runWebGLProgram(c,[l,u],p)}}function DP(e,t=!1){if("linear"===e)return"return x;";if("relu"===e)return t?"\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n":sP;if("elu"===e)return t?"\n  vec4 result;\n\n  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);\n  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);\n  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);\n  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);\n\n  return result;\n":"return (x >= 0.0) ? x : (exp(x) - 1.0);";if("relu6"===e)return t?"\n  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n":iP;if("prelu"===e)return t?EP:TP;if("leakyrelu"===e)return t?_P:IP;if("sigmoid"===e)return"return 1.0 / (1.0 + exp(-1.0 * x));";throw new Error(`Activation ${e} has not been implemented for the WebGL backend.`)}var MP=class{constructor(e,t,n,a=!1,r=!1,s=!1,i=null,o=!1,l=!1){this.variableNames=["matrixA","matrixB"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=n,this.enableShapeUniforms=vL(this.outputShape.length);let u=a?e[1]:e[2],d=Math.ceil(u/2),c=a?"i * 2, rc.y":"rc.y, i * 2",p=r?"rc.z, i * 2":"i * 2, rc.z",h=a?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],m=r?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],f="",g="";i&&(f=o?`vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          ${i}\n        }`:l?`vec4 activation(vec4 a) {\n          vec4 b = getLeakyreluAlphaAtOutCoords();\n          ${i}\n        }`:`vec4 activation(vec4 x) {\n          ${i}\n        }`,g="result = activation(result);");let x=s?"result += getBiasAtOutCoords();":"";s&&this.variableNames.push("bias"),o&&this.variableNames.push("preluActivationWeights"),l&&this.variableNames.push("leakyreluAlpha");let b="rc.x",y="rc.x";e[0]<t[0]?b=`imod(rc.x, ${e[0]})`:t[0]<e[0]&&(y=`imod(rc.x, ${t[0]})`),this.userCode=`\n      ${f}\n      // Don't use uniform for sharedDimensionPacked for performance.\n      const float sharedDimension = ${d}.0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        int batchA = ${b};\n        int batchB = ${y};\n        for (int i = 0; i < ${d}; i++) {\n          vec4 a = getMatrixA(batchA, ${c});\n          vec4 b = getMatrixB(batchB, ${p});\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += (${h[0]} * ${m[0]});\n          result += (${h[1]} * ${m[1]});\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        ${x}\n\n        ${g}\n\n        setOutput(result);\n      }\n    `}},OP=class{constructor(e,t,n){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=Uf.assertAndGetBroadcastShape(t,n),this.userCode=`\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        ${e}\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    `}},jP="return a * b;";function LP(e){let t,{inputs:n,backend:a}=e,{a:r,b:s}=n,i=Uf.upcastType(r.dtype,s.dtype);if("complex64"===r.dtype){let e=a.texData.get(r.dataId),t=a.texData.get(s.dataId),n=new OP("return areal * breal - aimag * bimag;",r.shape,s.shape),i=new OP("return areal * bimag + aimag * breal;",r.shape,s.shape),o=[{dataId:e.complexTensorInfos.real.dataId,dtype:e.complexTensorInfos.real.dtype,shape:r.shape},{dataId:e.complexTensorInfos.imag.dataId,dtype:e.complexTensorInfos.imag.dtype,shape:r.shape},{dataId:t.complexTensorInfos.real.dataId,dtype:t.complexTensorInfos.real.dtype,shape:s.shape},{dataId:t.complexTensorInfos.imag.dataId,dtype:t.complexTensorInfos.imag.dtype,shape:s.shape}],l=a.runWebGLProgram(n,o,"float32"),u=a.runWebGLProgram(i,o,"float32"),d=NP({inputs:{real:l,imag:u},backend:a});return a.disposeIntermediateTensorInfo(l),a.disposeIntermediateTensorInfo(u),d}if(a.shouldExecuteOnCPU([r,s])){let e=a.texData.get(r.dataId),t=a.texData.get(s.dataId),[n,o]=vz(r.shape,s.shape,e.values,t.values,i),l=a.makeTensorInfo(o,i);return a.texData.get(l.dataId).values=n,l}return t=Pt().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wP(jP,r.shape,s.shape):new bP(jP,r.shape,s.shape),a.runWebGLProgram(t,[r,s],i)}var zP={kernelName:Wa,backendName:"webgl",kernelFunc:LP};function PP(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{shape:s}=a,i=n,o=Ns.sizeFromShape(r.shape),l=Ns.inferFromImplicitShape(s,o),u=Ns.sizeFromShape(l);Ns.assert(o===u,()=>`The new shape (${l}) has ${u} elements and the old shape (${r.shape}) has ${o} elements. The new shape and old shape must have the same number of elements.`);let d=i.texData.get(r.dataId);return!d.isPacked||Pj(r.shape,l)||null!==d.texture&&Pj(d.shape,l)?(i.incRef(r.dataId),{dataId:r.dataId,shape:l,dtype:r.dtype}):function(e,t,n){let a=[Mj(e.shape),...Oj(e.shape)],r={dtype:e.dtype,shape:a,dataId:e.dataId},s=[Mj(t),...Oj(t)],i=new Zz(s,a),o=[a],l=n.runWebGLProgram(i,[r],e.dtype,o,!0);return{dataId:l.dataId,shape:t,dtype:l.dtype}}(r,l,i)}var BP={kernelName:ur,backendName:"webgl",kernelFunc:PP},WP=class{constructor(e,t){this.variableNames=["x"];let{windowSize:n,batchSize:a,inSize:r,outSize:s}=e;this.outputShape=[a,s];let i=4*Math.floor(n/4),o=n%4,l="sumValue += dot(values, ones);";if(null!=t){let e=1/t;l=`sumValue += dot(values * ${Ns.isInt(e)?e.toPrecision(2):e}, ones);`}let u="";r%n>0&&(u=`\n        if (inIdx < 0 || inIdx >= ${r}) {\n          return 0.0;\n        }\n      `),this.userCode=`\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        ${u}\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * ${n};\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < ${i}; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          ${l}\n        }\n\n        int inIdx = inOffset + ${i};\n        if (${1===o}) {\n          vec4 values = vec4(getValue(batch, inIdx), 0.0, 0.0, 0.0);\n\n          ${l}\n        } else if (${2===o}) {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1), 0.0, 0.0);\n\n          ${l}\n        } else if (${3===o}) {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2), 0.0);\n\n          ${l}\n        }\n        setOutput(sumValue);\n      }\n    `}},VP=class{constructor(e,t){this.variableNames=["x"];let{windowSize:n,batchSize:a,inSize:r,outSize:s}=e;this.outputShape=[a,s];let i="0.0",o="";"prod"===t?i="1.0":"min"===t?(i="1.0 / 1e-20",o="min"):"max"===t&&(i="-1.0 / 1e-20",o="max");let l=`${t}(${t}(${t}(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])`;"sum"===t?l="sumValue":"prod"===t?l="prodValue":"all"===t?l="allValue":"any"===t&&(l="anyValue");let u=4*Math.floor(n/4),d=n%4,c=`\n      if (${"sum"===t}) {\n        sumValue += dot(values, ones);\n      } else if (${"prod"===t}) {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = ${o}(values, minMaxValue);\n        if (${"min"===t} || ${"max"===t}) {\n          minMaxValue = ${o}(values, minMaxValue);\n          bvec4 isNaN = isnan(values);\n          if (isNaN.r || isNaN.g || isNaN.b || isNaN.a) {\n            minMaxValue = vec4(NAN);\n          }\n        }\n      }\n    `,p="vec4";"all"===t?(i="1.0",c="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",p="bvec4"):"any"===t&&(i="0.0",c="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",p="bvec4");let h="";r%n>0&&(h=`\n        if (inIdx < 0 || inIdx >= ${r}) {\n          return initializationValue;\n        }\n      `),this.userCode=`\n      const float initializationValue = ${i};\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        ${h}\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * ${n};\n\n        vec4 minMaxValue = vec4(${i});\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < ${u}; i += 4) {\n          int inIdx = inOffset + i;\n          ${p} values = ${p}(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          ${c}\n        }\n\n        int inIdx = inOffset + ${u};\n        if (${1===d}) {\n          ${p} values = ${p}(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          ${c}\n        } else if (${2===d}) {\n          ${p} values = ${p}(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          ${c}\n        } else if (${3===d}) {\n          ${p} values = ${p}(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          ${c}\n        }\n        setOutput(${l});\n      }\n    `}};function UP(e,t,n,a){let r=function(e){let t=[];for(;0===t.length||1!==t[t.length-1].outSize;){let n=t.length?t[t.length-1].outSize:e[1],a=Uf.computeOptimalWindowSize(n);t.push({inSize:n,windowSize:a,outSize:Math.ceil(n/a)})}return t}(e.shape),s=e;for(let i=0;i<r.length;i++){let o,l,{inSize:u,windowSize:d,outSize:c}=r[i];o="mean"===n?0===i?new WP({windowSize:d,inSize:u,batchSize:e.shape[0],outSize:c},u):new WP({windowSize:d,inSize:u,batchSize:e.shape[0],outSize:c}):new VP({windowSize:d,inSize:u,batchSize:e.shape[0],outSize:c},n),l=s,s=a.runWebGLProgram(o,[s],t),l.dataId!==e.dataId&&a.disposeIntermediateTensorInfo(l)}return s}var GP=class{constructor(e,t){this.variableNames=["A"];let n=new Array(e.length);for(let s=0;s<n.length;s++)n[s]=e[t[s]];this.outputShape=n,this.rank=n.length;let a=fL(this.rank),r=function(e){let t=e.length;if(t>6)throw Error(`Transpose for rank ${t} is not yet supported`);let n=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],a=new Array(t);for(let r=0;r<e.length;r++)a[e[r]]=n[r];return a.join()}(t);this.userCode=`\n    void main() {\n      ${a} resRC = getOutputCoords();\n      setOutput(getA(${r}));\n    }\n    `}},HP=class{constructor(e,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0;let n=new Array(e.length);for(let u=0;u<n.length;u++)n[u]=e[t[u]];if(this.outputShape=n,this.rank=n.length,this.rank>6)throw Error(`Packed transpose for rank ${this.rank} is not yet supported.`);let a=fL(this.rank),r=Kz("rc",this.rank),s=new Array(this.rank);for(let u=0;u<t.length;u++)s[t[u]]=r[u];let i=`vec2(${s.slice(-2).join()})`,o=`++${r[this.rank-1]} < ${n[this.rank-1]}`,l=`getChannel(getA(${s.join()}), ${i})`;this.userCode=`\n    void main() {\n      ${a} rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = ${l};\n      if(${o}) {\n        result[1] = ${l};\n      }\n      --${r[this.rank-1]};\n      if(++${r[this.rank-2]} < ${n[this.rank-2]}) {\n        result[2] = ${l};\n        if(${o}) {\n          result[3] = ${l};\n        }\n      }\n      setOutput(result);\n    }\n    `}};function qP(e,t,n){let a=Pt().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new HP(e.shape,t):new GP(e.shape,t);return n.runWebGLProgram(a,[e],e.dtype)}function KP(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,keepDims:i}=a;return function(e,t,n,a){let r=t,s=e.shape.length,i=Ns.parseAxisParam(r,e.shape),o=i,l=Uf.getAxesPermutation(o,s),u=null!=l,d=e;u&&(d=qP(e,l,a),o=Uf.getInnerMostAxes(o.length,s)),Uf.assertAxesAreInnerMostDims("sum",o,s);let[c,p]=Uf.computeOutAndReduceShapes(d.shape,o),h=c;n&&(h=Uf.expandShapeToKeepDim(c,i));let m=Ns.sizeFromShape(p),f=PP({inputs:{x:d},attrs:{shape:[Ns.sizeFromShape(e.shape)/m,m]},backend:a}),g=UP(f,fi(e.dtype),"sum",a),x=PP({inputs:{x:g},attrs:{shape:h},backend:a});return a.disposeIntermediateTensorInfo(f),a.disposeIntermediateTensorInfo(g),u&&a.disposeIntermediateTensorInfo(d),x}(r,s,i,n)}var XP={kernelName:Ar,backendName:"webgl",kernelFunc:KP};function YP(e){let t,{inputs:n,backend:a,attrs:r}=e,{x:s}=n,{perm:i}=r,o=a,l=s.shape.length,u=new Array(l);for(let d=0;d<u.length;d++)u[d]=s.shape[i[d]];if(o.shouldExecuteOnCPU([s])){let e=o.texData.get(s.dataId).values,n=Hz(e,s.shape,s.dtype,i,u);t=o.makeTensorInfo(u,s.dtype),o.texData.get(t.dataId).values=n}else t=qP(s,i,o);return t}var ZP={kernelName:Jr,backendName:"webgl",kernelFunc:YP};function JP({a:e,b:t,transposeA:n,transposeB:a,backend:r,bias:s=null,preluActivationWeights:i=null,leakyreluAlpha:o=0,activation:l=null}){let u=e.shape.length,d=t.shape.length,c=n?e.shape[u-2]:e.shape[u-1],p=a?t.shape[d-1]:t.shape[d-2],h=n?e.shape[u-1]:e.shape[u-2],m=a?t.shape[d-2]:t.shape[d-1],f=e.shape.slice(0,-2),g=t.shape.slice(0,-2),x=Ns.sizeFromShape(f),b=Ns.sizeFromShape(g),y=Mu.assertAndGetBroadcastShape(e.shape.slice(0,-2),t.shape.slice(0,-2)).concat([h,m]);Ns.assert(c===p,()=>`Error in matMul: inner shapes (${c}) and (${p}) of Tensors with shapes ${e.shape} and ${t.shape} and transposeA=${n} and transposeB=${a} must match.`);let w,v=n?[x,c,h]:[x,h,c],k=a?[b,m,p]:[b,p,m],N=PP({inputs:{x:e},backend:r,attrs:{shape:v}}),S=PP({inputs:{x:t},backend:r,attrs:{shape:k}}),I=[N,S],_=Math.max(x,b),C=n?N.shape[1]:N.shape[2],T=null!=s,E=null!=i,A="leakyrelu"===l,$=null!=l?DP(l,!0):null;if((1===h||1===m)&&C>1e3&&!1===(T||E||A||null!=$)){let e=N,t=S;n&&(e=YP({inputs:{x:N},backend:r,attrs:{perm:[0,2,1]}}),I.push(e)),a&&(t=YP({inputs:{x:S},backend:r,attrs:{perm:[0,2,1]}}),I.push(t));let s=1===m,i=e;1!==m&&(i=PP({inputs:{x:e},backend:r,attrs:{shape:[_,C,1]}}),I.push(i));let o=1===m?2:1,l=t;s&&(l=PP({inputs:{x:t},backend:r,attrs:{shape:[_,1,C]}}),I.push(l));let u=LP({inputs:{a:i,b:l},backend:r});w=KP({inputs:{x:u},backend:r,attrs:{axis:o,keepDims:!0}}),I.push(u)}else{let l=mi(e.dtype,t.dtype),u=new MP(v,k,[_,h,m],n,a,T,$,E,A),d=[N,S];if(null!=s&&d.push(s),E&&d.push(i),A){let e=r.makeTensorInfo([],"float32",Ns.createScalarValue(o,"float32"));d.push(e),I.push(e)}w=r.runWebGLProgram(u,d,l)}let R=PP({inputs:{x:w},backend:r,attrs:{shape:y}});I.push(w);for(let F of I)r.disposeIntermediateTensorInfo(F);return R}var QP={kernelName:os,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{a:r,b:s,bias:i,preluActivationWeights:o}=t,{transposeA:l,transposeB:u,activation:d,leakyreluAlpha:c}=a;return JP({a:r,b:s,transposeA:l,transposeB:u,backend:n,bias:i,preluActivationWeights:o,leakyreluAlpha:c,activation:d})}},eB="return abs(x);",tB={kernelName:Gt,backendName:"webgl",kernelFunc:function(e){let t,{inputs:n,backend:a}=e,{x:r}=n;if(a.shouldExecuteOnCPU([r])&&"complex64"!==r.dtype){let e=a.texData.get(r.dataId),t=Rz(e.values);return a.makeTensorInfo(r.shape,r.dtype,t)}return t=Pt().getBool("WEBGL_PACK_UNARY_OPERATIONS")?new lP(r.shape,eB):new nP(r.shape,eB),a.runWebGLProgram(t,[r],r.dtype)}},nB=RP({opSnippet:aP+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return acos(x);\n"}),aB={kernelName:Ht,backendName:"webgl",kernelFunc:nB},rB=RP({opSnippet:aP+"\n  if (x < 1.0) return NAN;\nreturn log(x + sqrt(x * x - 1.0));"}),sB={kernelName:qt,backendName:"webgl",kernelFunc:rB},iB="return a + b;",oB=FP({opSnippet:iB,packedOpSnippet:iB,supportsComplex:!0,cpuKernelImpl:QL}),lB={kernelName:Kt,backendName:"webgl",kernelFunc:oB},uB=class{constructor(e,t){this.outputShape=[],this.outputShape=e,this.variableNames=t.map((e,t)=>`T${t}`);let n=[];this.variableNames.forEach(e=>{n.push(`float v${e} = get${e}AtOutCoords();`)});let a=this.variableNames.map(e=>`v${e}`).join(" + ");this.userCode=`\n      void main() {\n        ${n.join("\n        ")}\n\n        float result = ${a};\n        setOutput(result);\n      }\n    `}},dB=class{constructor(e,t){this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.variableNames=t.map((e,t)=>`T${t}`);let n=[];this.variableNames.forEach(e=>{n.push(`vec4 v${e} = get${e}AtOutCoords();`)});let a=this.variableNames.map(e=>`v${e}`).join(" + ");this.userCode=`\n      void main() {\n        ${n.join("\n        ")}\n\n        vec4 result = ${a};\n        setOutput(result);\n      }\n    `}},cB={kernelName:Xt,backendName:"webgl",kernelFunc:function e(t){let{inputs:n,backend:a}=t,r=n;if(1===r.length)return vP({inputs:{x:r[0]},backend:a});if(r.length>Pt().getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){let t=Math.floor(r.length/2),n=e({inputs:r.slice(0,t),backend:a}),s=e({inputs:r.slice(t),backend:a});return e({inputs:[n,s],backend:a})}let s=r.map(e=>e.dtype).reduce((e,t)=>mi(e,t)),i=r.map(e=>e.shape),o=Pt().getBool("WEBGL_PACK")?new dB(r[0].shape,i):new uB(r[0].shape,i);return a.runWebGLProgram(o,r,s)}},pB={kernelName:Yt,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,keepDims:i}=a,o=r.shape.length,l=Ns.parseAxisParam(s,r.shape),u=l,d=Uf.getAxesPermutation(u,o),c=r;null!=d&&(c=YP({inputs:{x:r},backend:n,attrs:{perm:d}}),u=Uf.getInnerMostAxes(u.length,o)),Uf.assertAxesAreInnerMostDims("all",u,o);let p,[h,m]=Uf.computeOutAndReduceShapes(c.shape,u),f=PP({inputs:{x:c},backend:n,attrs:{shape:[-1,Ns.sizeFromShape(m)]}}),g=UP(f,f.dtype,"all",n);return p=PP(i?{inputs:{x:g},backend:n,attrs:{shape:Uf.expandShapeToKeepDim(h,l)}}:{inputs:{x:g},backend:n,attrs:{shape:h}}),n.disposeIntermediateTensorInfo(f),n.disposeIntermediateTensorInfo(g),null!=d&&n.disposeIntermediateTensorInfo(c),p}},hB={kernelName:Zt,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,keepDims:i}=a,o=r.shape.length,l=Ns.parseAxisParam(s,r.shape),u=l,d=Uf.getAxesPermutation(u,o),c=r;null!=d&&(c=YP({inputs:{x:r},backend:n,attrs:{perm:d}}),u=Uf.getInnerMostAxes(u.length,o)),Uf.assertAxesAreInnerMostDims("any",u,o);let p,[h,m]=Uf.computeOutAndReduceShapes(c.shape,u),f=PP({inputs:{x:c},backend:n,attrs:{shape:[-1,Ns.sizeFromShape(m)]}}),g=UP(f,f.dtype,"any",n);return p=PP(i?{inputs:{x:g},backend:n,attrs:{shape:Uf.expandShapeToKeepDim(h,l)}}:{inputs:{x:g},backend:n,attrs:{shape:h}}),n.disposeIntermediateTensorInfo(f),n.disposeIntermediateTensorInfo(g),null!=d&&n.disposeIntermediateTensorInfo(c),p}},mB=class{constructor(e,t,n){this.variableNames=["A"];let{windowSize:a,batchSize:r,outSize:s}=e;n||this.variableNames.push("bestIndicesA"),this.outputShape=[r,s];let i="max"===t?">":"<",o=n?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));";this.userCode=`\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * ${a};\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < ${a}; i++) {\n          int inIdx = ${o};\n          float candidate = getA(batch, inIdx);\n          if (candidate ${i} bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    `}},fB=class{constructor(e,t,n,a){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,Ns.assert(e.length>2,()=>`Packed arg${n.charAt(0).toUpperCase()+n.slice(1)} supports only inputs with rank above 2.`);let r=e[e.length-1],s=Math.ceil(r/t);this.outputShape=e.slice(0,-1),s>1&&this.outputShape.push(s),a||this.variableNames.push("bestIndicesA");let i,o,l=this.outputShape,u=l.length,d=fL(u),c=Xz("coords",u);if(1===s){o=u+1;let e=fL(o);i=`\n        ${e} sourceLocR = ${e}(${c.join()}, 0);\n        ++${c[u-1]};\n        ${e} sourceLocG = ${e}(${c.join()}, 0);\n        ++${c[u-2]};\n        ${e} sourceLocA = ${e}(${c.join()}, 0);\n        --${c[u-1]};\n        ${e} sourceLocB = ${e}(${c.join()}, 0);\n        --${c[u-2]};`}else o=u,i=`\n        ${d} sourceLocR = coords;\n        ++${c[u-1]};\n        ${d} sourceLocG = coords;\n        ++${c[u-2]};\n        ${d} sourceLocA = coords;\n        --${c[u-1]};\n        ${d} sourceLocB = coords;\n        --${c[u-2]};`;let p=["x","y","z","w","u","v"].slice(0,o),h="."+p[o-1],m=p.map(e=>"int "+e),f=Xz("sourceLocR",o-1).concat("inIdx.r"),g=Xz("sourceLocG",o-1).concat("inIdx.g"),x=Xz("sourceLocB",o-1).concat("inIdx.b"),b=Xz("sourceLocA",o-1).concat("inIdx.a"),y="max"===n?"greaterThan":"lessThan",w=a?"":`\n          inIdx = round(vec4(getBestIndicesAChannel(${f.join()}),\n                             getBestIndicesAChannel(${g.join()}),\n                             getBestIndicesAChannel(${x.join()}),\n                             getBestIndicesAChannel(${b.join()})));`,v=`vec4(\n            getAChannel(${f.join()}),\n            hasNextCol ? getAChannel(${g.join()}) : 0.,\n            hasNextRow ? getAChannel(${x.join()}) : 0.,\n            hasNextRow && hasNextCol ? getAChannel(${b.join()}) : 0.)`,k=a?"":`\n      float getBestIndicesAChannel(${m.join()}) {\n        return getChannel(getBestIndicesA(${p.join()}),\n                                          vec2(${p.slice(-2).join()}));\n      }`;this.userCode=`\n      float getAChannel(${m.join()}) {\n        return getChannel(getA(${p.join()}),\n                               vec2(${p.slice(-2).join()}));\n      }\n      ${k}\n      void main() {\n        ${d} coords = getOutputCoords();\n        bool hasNextCol = ${c[u-1]} < ${l[u-1]-1};\n        bool hasNextRow = ${c[u-2]} < ${l[u-2]-1};\n        ${i}\n        ivec4 srcIdx = ivec4(sourceLocR${h}, sourceLocG${h},\n          sourceLocB${h}, sourceLocA${h}) * ${t};\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = ${v};\n\n        for (int i = 0; i < ${t}; i++) {\n          inIdx = srcIdx;\n          ${w}\n          vec4 candidate = ${v};\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4(${y}(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    `}};function gB(e,t,n,a=null){let r=t.shape[0],s=t.shape[1];null!=a&&(r=a.shape[0],s=a.shape[1]);let i=Uf.computeOptimalWindowSize(s),o={windowSize:i,inSize:s,batchSize:r,outSize:Math.ceil(s/i)},l=new mB(o,n,null==a),u=[t];null!=a&&u.push(a);let d=e.runWebGLProgram(l,u,"int32");if(1===d.shape[1])return d;let c=gB(e,t,n,d);return e.disposeIntermediateTensorInfo(d),c}function xB(e,t,n,a=null){let r=null!=a?a.shape:t.shape,s=r[r.length-1],i=Uf.computeOptimalWindowSize(s),o=new fB(r,i,n,null==a),l=null==a?[t]:[t,a],u=e.runWebGLProgram(o,l,"int32");if(u.shape.length===t.shape.length){let a=xB(e,t,n,u);return e.disposeIntermediateTensorInfo(u),a}return u}function bB(e,t,n,a){let r=[n];if(Uf.assertAxesAreInnerMostDims("arg"+a.charAt(0).toUpperCase()+a.slice(1),r,t.shape.length),!Pt().getBool("WEBGL_PACK_REDUCE")||t.shape.length<=2){let n=[],s=e.texData.get(t.dataId),i=t;null!==s&&s.isPacked&&(i=e.unpackTensor(t),n.push(i));let[o,l]=Uf.computeOutAndReduceShapes(i.shape,r),u=Ns.sizeFromShape(l),d=PP({inputs:{x:i},backend:e,attrs:{shape:[-1,u]}});n.push(d);let c=gB(e,d,a);n.push(c);let p=PP({inputs:{x:c},backend:e,attrs:{shape:o}});return n.forEach(t=>e.disposeIntermediateTensorInfo(t)),p}return xB(e,t,a)}var yB={kernelName:Jt,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s}=a,i=Ns.parseAxisParam(s,r.shape),o=Uf.getAxesPermutation(i,r.shape.length),l=r,u=[];null!=o&&(l=YP({inputs:{x:r},backend:n,attrs:{perm:o}}),u.push(l),i=Uf.getInnerMostAxes(i.length,l.shape.length)),Uf.assertAxesAreInnerMostDims("argMax",[i[0]],l.shape.length);let d=bB(n,l,i[0],"max");return u.forEach(e=>n.disposeIntermediateTensorInfo(e)),d}},wB={kernelName:Qt,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s}=a,i=Ns.parseAxisParam(s,r.shape),o=Uf.getAxesPermutation(i,r.shape.length),l=r,u=[];null!=o&&(l=YP({inputs:{x:r},backend:n,attrs:{perm:o}}),u.push(l),i=Uf.getInnerMostAxes(i.length,l.shape.length)),Uf.assertAxesAreInnerMostDims("argMin",[i[0]],l.shape.length);let d=bB(n,l,i[0],"min");return u.forEach(e=>n.disposeIntermediateTensorInfo(e)),d}},vB=RP({opSnippet:aP+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return asin(x);\n"}),kB={kernelName:en,backendName:"webgl",kernelFunc:vB},NB=RP({opSnippet:aP+"return log(x + sqrt(x * x + 1.0));"}),SB={kernelName:tn,backendName:"webgl",kernelFunc:NB},IB=RP({opSnippet:aP+"\n  return atan(x);\n"}),_B={kernelName:nn,backendName:"webgl",kernelFunc:IB},CB=FP({opSnippet:xP+"\n  return atan(a, b);\n",packedOpSnippet:"\n  vec4 result = atan(a, b);\n  bvec4 isNaNA = isnan(a);\n  bvec4 isNaNB = isnan(b);\n  bvec4 isNaN = bvec4(isNaNA.x || isNaNB.x, isNaNA.y || isNaNB.y, isNaNA.z || isNaNB.z, isNaNA.w || isNaNB.w);\n  "+yP+"\n  return result;\n"}),TB={kernelName:rn,backendName:"webgl",kernelFunc:CB},EB=RP({opSnippet:aP+"\n  if ((x < -1.0) || (x > 1.0)) return NAN;\nreturn (log(1.0 + x) - log(1.0 - x)) / 2.0;"}),AB={kernelName:an,backendName:"webgl",kernelFunc:EB},$B=class{constructor(e,t,n,a=!1,r=!1){if(this.variableNames=["x"],"avg"===t&&n)throw new Error("Cannot compute positions for average pool.");let s=e.filterWidth,i=e.strideHeight,o=e.strideWidth,l=e.dilationHeight,u=e.dilationWidth,d=e.effectiveFilterHeight,c=e.effectiveFilterWidth,p=e.padInfo.top,h=e.padInfo.left;this.outputShape=e.outShape;let m="avg"===t,f=`((batch  * ${e.inHeight} + xR) * ${e.inWidth} + xC) * ${e.inChannels} + d`,g=`(xR * ${e.inWidth} + xC) * ${e.inChannels} + d`,x="0.0";if(m||(x="-1.0 / 1e-20"),n){let t=">=";return void(this.userCode=`\n        const ivec2 strides = ivec2(${i}, ${o});\n        const ivec2 pads = ivec2(${p}, ${h});\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < ${d};\n              wR += ${l}) {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= ${e.inHeight}) {\n              continue;\n            }\n\n            for (int wC = 0; wC < ${c};\n                wC += ${u}) {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= ${e.inWidth}) {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value ${t} currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = ${a?r?f:g:`wR * ${c} + wC`};\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      `)}let b=`${t}(${t}(${t}(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])`;"avg"===t&&(b="avgValue / max(count, 1.0)");let y=4*Math.floor(s/4),w=s%4,v=`\n      if (${m}) {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    `;this.userCode=`\n      const ivec2 strides = ivec2(${i}, ${o});\n      const ivec2 pads = ivec2(${p}, ${h});\n      const float initializationValue = ${x};\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= ${e.inWidth}) {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4(${x});\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < ${d};\n            wR += ${l}) {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= ${e.inHeight}) {\n            continue;\n          }\n\n          for (int wC = 0; wC < ${y}; wC += 4) {\n            int xC = xCCorner + wC * ${u};\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + ${u}, d),\n              getValue(batch, xR, xC + 2 * ${u}, d),\n              getValue(batch, xR, xC + 3 * ${u}, d)\n            );\n\n            ${v}\n          }\n\n          int xC = xCCorner + ${y};\n          if (${1===w}) {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            ${v}\n          } else if (${2===w}) {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + ${u}, d),\n              initializationValue,\n              initializationValue\n            );\n\n            ${v}\n          } else if (${3===w}) {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + ${u}, d),\n              getValue(batch, xR, xC + 2 * ${u}, d),\n              initializationValue\n            );\n\n            ${v}\n          }\n        }\n        setOutput(${b});\n      }\n    `}},RB=class{constructor(e,t,n,a=!1,r=!1){if(this.variableNames=["x"],"avg"===t&&n)throw new Error("Cannot compute positions for average pool.");let s=e.filterWidth,i=e.strideDepth,o=e.strideHeight,l=e.strideWidth,u=e.dilationDepth,d=e.dilationHeight,c=e.dilationWidth,p=e.effectiveFilterDepth,h=e.effectiveFilterHeight,m=e.effectiveFilterWidth,f=e.padInfo.front,g=e.padInfo.top,x=e.padInfo.left;this.outputShape=e.outShape;let b="avg"===t,y="0.0";if(b||(y="-1.0 / 1e-20"),n){let t=">=";return void(this.userCode=`\n        const ivec3 strides =\n            ivec3(${i}, ${o}, ${l});\n        const ivec3 pads = ivec3(${f}, ${g}, ${x});\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < ${p};\n              wD += ${u}) {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= ${e.inDepth}) {\n              continue;\n            }\n\n            for (int wR = 0; wR < ${h};\n                wR += ${d}) {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= ${e.inHeight}) {\n                continue;\n              }\n\n              for (int wC = 0; wC < ${m};\n                  wC += ${c}) {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= ${e.inWidth}) {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value ${t} currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition = ${a?r?`(((batch * ${e.inDepth} + xD) * ${e.inHeight} + xR) * ${e.inWidth} + xC) * ${e.inChannels} + ch`:`((xD * ${e.inHeight} + xR) * ${e.inWidth} + xC) * ${e.inChannels} + ch`:`wD * ${h} * ${m} +\n                      wR * ${m} + wC`};\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      `)}let w=`${t}(${t}(${t}(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])`;"avg"===t&&(w="avgValue / max(count, 1.0)");let v=4*Math.floor(s/4),k=s%4,N=`\n      if (${b}) {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    `;this.userCode=`\n      const ivec3 strides =\n        ivec3(${i}, ${o}, ${l});\n      const ivec3 pads = ivec3(${f}, ${g}, ${x});\n      const float initializationValue = ${y};\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= ${e.inWidth}) {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4(${y});\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < ${p};\n            wD += ${u}) {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= ${e.inDepth}) {\n            continue;\n          }\n\n          for (int wR = 0; wR < ${h};\n            wR += ${d}) {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= ${e.inHeight}) {\n              continue;\n            }\n\n            for (int wC = 0; wC < ${v}; wC += 4) {\n              int xC = xCCorner + wC * ${c};\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + ${c}, ch),\n                getValue(batch, xD, xR, xC + 2 * ${c}, ch),\n                getValue(batch, xD, xR, xC + 3 * ${c}, ch)\n              );\n\n              ${N}\n            }\n\n            int xC = xCCorner + ${v};\n            if (${1===k}) {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              ${N}\n            } else if (${2===k}) {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + ${c}, ch),\n                initializationValue,\n                initializationValue\n              );\n\n              ${N}\n            } else if (${3===k}) {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + ${c}, ch),\n                getValue(batch, xD, xR, xC + 2 * ${c}, ch),\n                initializationValue\n              );\n\n              ${N}\n            }\n          }\n        }\n        setOutput(${w});\n      }\n    `}},FB={kernelName:sn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t;Jj(r,"avgPool");let{filterSize:s,strides:i,pad:o,dimRoundingMode:l}=a;Ns.assert(Uf.eitherStridesOrDilationsAreOne(i,1),()=>`Error in avgPool: Either strides or dilations must be 1. Got strides ${i} and dilations '1'`);let u=Uf.computePool2DInfo(r.shape,s,i,1,o,l);if(1===u.filterWidth&&1===u.filterHeight&&Ns.arraysEqual(u.inShape,u.outShape))return vP({inputs:{x:r},backend:n});let d=new $B(u,"avg",!1);return n.runWebGLProgram(d,[r],"float32")}},DB={kernelName:ln,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{filterSize:s,strides:i,pad:o,dimRoundingMode:l,dataFormat:u}=a,d=Uf.computePool3DInfo(r.shape,s,i,[1,1,1],o,l,u),c=new RB(d,"avg",!1);return n.runWebGLProgram(c,[r],"float32")}},MB=class{constructor(e){this.variableNames=["dy"],this.outputShape=e.inShape;let t=e.filterHeight,n=e.filterWidth,a=e.strideHeight,r=e.strideWidth,s=e.dilationHeight,i=e.dilationWidth,o=e.effectiveFilterHeight,l=e.effectiveFilterWidth,u=o-1-e.padInfo.top,d=l-1-e.padInfo.left,c=1/(t*n);this.userCode=`\n      const ivec2 pads = ivec2(${u}, ${d});\n      const float avgMultiplier = float(${c});\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < ${o};\n            wR += ${s}) {\n          float dyR = float(dyRCorner + wR) / ${a}.0;\n\n          if (dyR < 0.0 || dyR >= ${e.outHeight}.0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < ${l};\n            wC+= ${i}) {\n            float dyC = float(dyCCorner + wC) / ${r}.0;\n\n            if (dyC < 0.0 || dyC >= ${e.outWidth}.0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},OB=class{constructor(e){this.variableNames=["dy"],this.outputShape=e.inShape;let t=e.filterDepth,n=e.filterHeight,a=e.filterWidth,r=e.strideDepth,s=e.strideHeight,i=e.strideWidth,o=e.dilationDepth,l=e.dilationHeight,u=e.dilationWidth,d=e.effectiveFilterDepth,c=e.effectiveFilterHeight,p=e.effectiveFilterWidth,h=d-1-e.padInfo.front,m=c-1-e.padInfo.top,f=p-1-e.padInfo.left,g=1/(t*n*a);this.userCode=`\n      const ivec3 pads = ivec3(${h}, ${m}, ${f});\n      const float avgMultiplier = float(${g});\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < ${d};\n            wD += ${o}) {\n          float dyD = float(dyDCorner + wD) / ${r}.0;\n\n          if (dyD < 0.0 || dyD >= ${e.outDepth}.0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < ${c};\n              wR += ${l}) {\n            float dyR = float(dyRCorner + wR) / ${s}.0;\n\n            if (dyR < 0.0 || dyR >= ${e.outHeight}.0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < ${p};\n                wC += ${u}) {\n              float dyC = float(dyCCorner + wC) / ${i}.0;\n\n              if (dyC < 0.0 || dyC >= ${e.outWidth}.0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},jB={kernelName:un,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s}=t,i=s,{filterSize:o,strides:l,pad:u,dimRoundingMode:d}=a,c=Uf.computePool3DInfo(i.shape,o,l,[1,1,1],u,d),p=new OB(c);return n.runWebGLProgram(p,[r],i.dtype)}},LB={kernelName:on,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s}=t,i=s;Jj([r,s],"avgPoolGrad");let{filterSize:o,strides:l,pad:u}=a,d=Uf.computePool2DInfo(i.shape,o,l,1,u),c=new MB(d);return n.runWebGLProgram(c,[r],i.dtype)}},zB={kernelName:dn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{a:r,b:s}=t,{transposeA:i,transposeB:o}=a;return JP({a:r,b:s,transposeA:i,transposeB:o,backend:n})}},PB=class{constructor(e,t,n,a,r,s){this.outputShape=[],this.variableNames=["x","mean","variance"],Uf.assertAndGetBroadcastShape(e,t),Uf.assertAndGetBroadcastShape(e,n);let i="0.0";null!=a&&(Uf.assertAndGetBroadcastShape(e,a),this.variableNames.push("offset"),i="getOffsetAtOutCoords()");let o="1.0";null!=r&&(Uf.assertAndGetBroadcastShape(e,r),this.variableNames.push("scale"),o="getScaleAtOutCoords()"),this.outputShape=e,this.userCode=`\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = ${i};\n        float scale = ${o};\n        float inv = scale * inversesqrt(variance + float(${s}));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    `}},BB=class{constructor(e,t,n,a,r,s){this.packedInputs=!0,this.packedOutput=!0,this.variableNames=["x","mean","variance"],Uf.assertAndGetBroadcastShape(e,t),Uf.assertAndGetBroadcastShape(e,n);let i="vec4(0.0)";null!=a&&(Uf.assertAndGetBroadcastShape(e,a),this.variableNames.push("offset"),i="getOffsetAtOutCoords()");let o="vec4(1.0)";null!=r&&(Uf.assertAndGetBroadcastShape(e,r),this.variableNames.push("scale"),o="getScaleAtOutCoords()"),this.outputShape=e,this.userCode=`\n      void main() {\n        vec4 offset = ${i};\n        vec4 scale = ${o};\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4(${s}));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    `}},WB={kernelName:aa,backendName:"webgl",kernelFunc:({inputs:e,backend:t,attrs:n})=>{let{x:a,mean:r,variance:s,offset:i,scale:o}=e;Ns.assert(r.shape.length===s.shape.length,()=>"Batch normalization gradient requires mean and variance to have equal ranks."),Ns.assert(null==i||r.shape.length===i.shape.length,()=>"Batch normalization gradient requires mean and offset to have equal ranks."),Ns.assert(null==o||r.shape.length===o.shape.length,()=>"Batch normalization gradient requires mean and scale to have equal ranks.");let{varianceEpsilon:l}=n;null==l&&(l=.001);let u=[a,r,s],d=null;null!=i&&(d=i.shape,u.push(i));let c=null;null!=o&&(c=o.shape,u.push(o));let p=Pt().getBool("WEBGL_PACK_NORMALIZATION")?new BB(a.shape,r.shape,s.shape,d,c,l):new PB(a.shape,r.shape,s.shape,d,c,l);return t.runWebGLProgram(p,u,u[0].dtype)}},VB=class{constructor(e){this.variableNames=["source"],this.outputShape=e,this.rank=e.length;let t=fL(this.rank);this.customUniforms=[{name:"start",arrayIndex:this.rank,type:"int"}];let n,a=function(e){if(1===e)return"sourceLoc";if(e<=6)return UB.slice(0,e).map(e=>"sourceLoc."+e).join(",");throw Error(`Slicing for rank ${e} is not yet supported`)}(this.rank);n=`\n        ${t} sourceLoc;\n        ${t} coords = getOutputCoords();\n        ${e.map((e,t)=>`sourceLoc.${UB[t]} = start[${t}] + coords.${UB[t]};`).join("\n")}\n      `,this.userCode=`\n      void main() {\n        ${n}\n        setOutput(getSource(${a}));\n      }\n    `}},UB=["x","y","z","w","u","v"],GB=class{constructor(e){this.variableNames=["source"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=e,this.rank=e.length,this.customUniforms=[{name:"start",arrayIndex:this.rank,type:"int"}];let t=fL(this.rank),n=Xz("coords",this.rank),a=Xz("sourceLoc",this.rank),r=1===this.rank?"sourceLoc":`vec2(${a.slice(-2).join()})`,s=`getChannel(getSource(${a.join()}), ${r})`,i=`\n      result.x = ${s};\n      if (++${n[this.rank-1]} < ${e[this.rank-1]}) {\n        ++${a[this.rank-1]};\n        result.y = ${s};\n        --${a[this.rank-1]};\n      }\n    `,o=1===this.rank?"":`\n      --${n[this.rank-1]};\n      if (++${n[this.rank-2]} < ${e[this.rank-2]}) {\n        ++${a[this.rank-2]};\n        result.z = ${s};\n        if (++${n[this.rank-1]} < ${e[this.rank-1]}) {\n          ++${a[this.rank-1]};\n          result.w = ${s};\n        }\n      }\n    `,l=this.rank<=4?`sourceLoc = coords +\n            ${t}(${e.map((e,t)=>`start[${t}]`).join()});`:e.map((e,t)=>`${a[t]} = ${n[t]} + start[${t}];`).join("\n");this.userCode=`\n      void main() {\n        ${t} coords = getOutputCoords();\n        ${t} sourceLoc;\n        ${l}\n        vec4 result = vec4(0.);\n        ${i}\n        ${o}\n        setOutput(result);\n      }\n    `}};function HB(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{begin:s,size:i}=a,[o,l]=bf.parseSliceParams(r,s,i);if(bf.assertParamsValid(r,o,l),0===Ns.sizeFromShape(l))return n.makeTensorInfo(l,r.dtype,[]);if(n.shouldExecuteOnCPU([r])||"string"===r.dtype){let e=n.texData.get(r.dataId),t=Fz(e.values,o,l,r.shape,r.dtype);return n.makeTensorInfo(l,r.dtype,t)}let{isPacked:u}=n.texData.get(r.dataId),d=bf.isSliceContinous(r.shape,o,l);if(u||!d){let e=Pt().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new GB(l):new VB(l),t=[o];return n.runWebGLProgram(e,[r],r.dtype,t)}return n.uploadToGPU(r.dataId),function(e,t,n,a){let r=a.texData.get(e.dataId),s=a.makeTensorInfo(n,e.dtype),i=a.texData.get(s.dataId);Object.assign(i,r),i.refCount=1,i.shape=n,i.dtype=e.dtype;let o=bf.computeFlatOffset(t,Ns.computeStrides(e.shape));r.slice&&(o+=r.slice.flatOffset),i.slice={flatOffset:o,origDataId:r.slice&&r.slice.origDataId||e.dataId};let l=a.dataRefCount.get(i.slice.origDataId)||1;return a.dataRefCount.set(i.slice.origDataId,l+1),s}(r,o,l,n)}var qB={kernelName:Nr,backendName:"webgl",kernelFunc:HB},KB={kernelName:cn,backendName:"webgl",kernelFunc:e=>{let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{blockShape:s,crops:i}=a;Ns.assert(r.shape.length<=4,()=>"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet");let o=s.reduce((e,t)=>e*t),l=Uf.getReshaped(r.shape,s,o),u=Uf.getPermuted(l.length,s.length),d=Uf.getReshapedPermuted(r.shape,s,o),c=Uf.getSliceBeginCoords(i,s.length),p=Uf.getSliceSize(d,i,s.length),h=[],m=PP({inputs:{x:r},backend:n,attrs:{shape:l}}),f=YP({inputs:{x:m},backend:n,attrs:{perm:u}}),g=PP({inputs:{x:f},backend:n,attrs:{shape:d}}),x=HB({inputs:{x:g},backend:n,attrs:{begin:c,size:p}});return h.push(m),h.push(f),h.push(g),h.forEach(e=>n.disposeIntermediateTensorInfo(e)),x}},XB={kernelName:pn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,weights:s}=t,{size:i}=a,o=n.readSync(r.dataId),l=n.readSync(s.dataId),u=ez(o,l,s.dtype,s.shape,i);return n.makeTensorInfo([i],s.dtype,u)}},YB={kernelName:hn,backendName:"webgl",kernelFunc:function(e){let t,{inputs:n,backend:a}=e,{a:r,b:s}=n,i=Pt().getBool("WEBGL_PACK_BINARY_OPERATIONS"),o=Pt().getNumber("WEBGL_VERSION");if(a.shouldExecuteOnCPU([r,s])||1===o){let e=a.texData.get(r.dataId).values,t=a.texData.get(s.dataId).values,[n,i]=nz(r.shape,s.shape,e,t,r.dtype),o=a.makeTensorInfo(i,r.dtype);return a.texData.get(o.dataId).values=n,o}return t=i?new wP("\n  int r = int(a.r) & int(b.r);\n  int g = int(a.g) & int(b.g);\n  int rb = int(a.b) & int(b.b);\n  int ra = int(a.a) & int(b.a);\n  return vec4(r, g, rb, ra);\n",r.shape,s.shape,!1):new bP("\n  return float(int(a.r) & int(b.r));\n",r.shape,s.shape),a.runWebGLProgram(t,[r,s],r.dtype)}},ZB={kernelName:fn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{s0:a,s1:r}=t,s=n.readSync(a.dataId),i=n.readSync(r.dataId),o=Uf.assertAndGetBroadcastShape(Array.from(s),Array.from(i));return n.makeTensorInfo([o.length],"int32",Int32Array.from(o))}},JB=FP({opSnippet:"return float(a != b);",cpuKernelImpl:Nz,dtype:"bool"}),QB={kernelName:Ua,backendName:"webgl",kernelFunc:JB};function eW(e){let{inputs:t,backend:n}=e,{input:a}=t;return vP({inputs:{x:n.texData.get(a.dataId).complexTensorInfos.real},backend:n})}var tW={kernelName:ir,backendName:"webgl",kernelFunc:eW},nW={kernelName:gn,backendName:"webgl",kernelFunc:function e(t){let{inputs:n,backend:a,attrs:r}=t,{x:s}=n,{dtype:i}=r;if("complex64"===i){if("complex64"===s.dtype)return vP({inputs:{x:s},backend:a});let t=ac(s.shape),n=e({inputs:{x:s},backend:a,attrs:{dtype:"float32"}}),r=NP({inputs:{real:n,imag:t},backend:a});return t.dispose(),a.disposeIntermediateTensorInfo(n),r}if("complex64"===s.dtype){let t=eW({inputs:{input:s},backend:a}),n=e({inputs:{x:t},backend:a,attrs:{dtype:i}});return a.disposeIntermediateTensorInfo(t),n}if(!Ns.hasEncodingLoss(s.dtype,i)){let e=vP({inputs:{x:s},backend:a});return{dataId:e.dataId,shape:e.shape,dtype:i}}if(a.shouldExecuteOnCPU([s])){let e=a.texData.get(s.dataId).values,[t,n,r]=az(e,s.shape,s.dtype,i);return a.makeTensorInfo(t,n,r)}if("int32"===i)return function(e,t){let n=new nP(e.shape,"return float(int(x));"),a=t.runWebGLProgram(n,[e],"int32");return{dataId:a.dataId,shape:a.shape,dtype:a.dtype}}(s,a);if("bool"===i){let e=a.makeTensorInfo([],"bool",Ns.getTypedArrayFromDType("bool",1)),t=JB({inputs:{a:s,b:e},backend:a});return a.disposeIntermediateTensorInfo(e),t}throw new Error(`Error in Cast: failed to cast ${s.dtype} to ${i}`)}},aW="return ceil(x);",rW=RP({opSnippet:aW,packedOpSnippet:aW,cpuKernelImpl:rz}),sW={kernelName:xn,backendName:"webgl",kernelFunc:rW},iW=class{constructor(e){this.variableNames=["A"],this.customUniforms=[{name:"minVal",type:"float"},{name:"maxVal",type:"float"}],this.outputShape=e,this.userCode="\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}},oW=class{constructor(e){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"minVal",type:"float"},{name:"maxVal",type:"float"}],this.outputShape=e,this.userCode="\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}},lW={kernelName:bn,backendName:"webgl",kernelFunc:function(e){let t,{inputs:n,backend:a,attrs:r}=e,{x:s}=n,{clipValueMin:i,clipValueMax:o}=r;t=Pt().getBool("WEBGL_PACK_CLIP")?new oW(s.shape):new iW(s.shape);let l=[[i],[o]];return a.runWebGLProgram(t,[s],s.dtype,l)}},uW=class{constructor(e){this.variableNames=["real","imag"],this.outputShape=e,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "}};function dW(e,t){return{dataId:t.dataId,dtype:t.dtype,shape:e.shape}}var cW={kernelName:wn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{x:a}=t,r=n.texData.get(a.dataId),s=new uW(a.shape),i=[dW(a,r.complexTensorInfos.real),dW(a,r.complexTensorInfos.imag)];return n.runWebGLProgram(s,i,i[0].dtype)}},pW=class{constructor(e){this.outputShape=[],this.outputShape=Uf.computeOutShape(e,1),this.variableNames=e.map((e,t)=>`T${t}`);let t=new Array(e.length-1);t[0]=e[0][1];for(let s=1;s<t.length;s++)t[s]=t[s-1]+e[s][1];let n=[`if (yC < ${t[0]}) setOutput(getT0(yR, yC));`];for(let s=1;s<t.length;s++){let e=t[s-1];n.push(`else if (yC < ${t[s]}) setOutput(getT${s}(yR, yC-${e}));`)}let a=t.length,r=t[t.length-1];n.push(`else setOutput(getT${a}(yR, yC-${r}));`),this.userCode=`\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        ${n.join("\n        ")}\n      }\n    `}},hW=class{constructor(e,t){this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[],this.outputShape=Uf.computeOutShape(e,t);let n=this.outputShape,a=n.length,r=fL(a),s=Xz("coords",a),i=["x","y","z","w","u","v"].slice(0,a);this.variableNames=e.map((e,t)=>`T${t}`);let o=new Array(e.length-1);o[0]=e[0][t];for(let m=1;m<o.length;m++)o[m]=o[m-1]+e[m][t];let l=i[t],u=i.slice(-2),d=i.join(),c=`if (${l} < ${o[0]}) {\n        return getChannel(\n            getT0(${d}), vec2(${u.join()}));\n        }`;for(let m=1;m<o.length;m++){let e=o[m-1];c+=`\n        if (${l} < ${o[m]}  && ${l} >= ${o[m-1]}) {\n          return getChannel(\n            getT${m}(${mW(i,l,e)}),\n            vec2(${mW(u,l,e)}));\n        }`}let p=o.length,h=o[o.length-1];c+=`\n        return getChannel(\n          getT${p}(${mW(i,l,h)}),\n          vec2(${mW(u,l,h)}));`,this.userCode=`\n      float getValue(${i.map(e=>"int "+e)}) {\n        ${c}\n      }\n\n      void main() {\n        ${r} coords = getOutputCoords();\n        vec4 result = vec4(getValue(${s}), 0., 0., 0.);\n\n        ${s[a-1]} = ${s[a-1]} + 1;\n        if (${s[a-1]} < ${n[a-1]}) {\n          result.g = getValue(${s});\n        }\n\n        ${s[a-2]} = ${s[a-2]} + 1;\n        if (${s[a-2]} < ${n[a-2]}) {\n          result.a = getValue(${s});\n        }\n\n        ${s[a-1]} = ${s[a-1]} - 1;\n        if (${s[a-2]} < ${n[a-2]} &&\n            ${s[a-1]} < ${n[a-1]}) {\n          result.b = getValue(${s});\n        }\n        setOutput(result);\n      }\n    `}};function mW(e,t,n){let a=e.indexOf(t);return e.map((e,t)=>t===a?`${e} - ${n}`:e).join()}function fW(e){let{inputs:t,backend:n}=e,{input:a}=t;return vP({inputs:{x:n.texData.get(a.dataId).complexTensorInfos.imag},backend:n})}var gW={kernelName:da,backendName:"webgl",kernelFunc:fW};function xW(e,t,n){let a=e[0].dtype;if("complex64"===a){let a=e.map(e=>eW({inputs:{input:e},backend:n})),r=e.map(e=>fW({inputs:{input:e},backend:n})),s=xW(a,t,n),i=xW(r,t,n),o=NP({inputs:{real:s,imag:i},backend:n});return a.forEach(e=>n.disposeIntermediateTensorInfo(e)),r.forEach(e=>n.disposeIntermediateTensorInfo(e)),n.disposeIntermediateTensorInfo(s),n.disposeIntermediateTensorInfo(i),o}let r=n.shouldExecuteOnCPU(e);if("string"===a&&(r=!0),r){let r=e.map(e=>{let a=[-1,Ns.sizeFromShape(e.shape.slice(t))];return PP({inputs:{x:e},backend:n,attrs:{shape:a}})}),s=r.map(e=>({vals:n.readSync(e.dataId),shape:e.shape})),i=Uf.computeOutShape(r.map(e=>e.shape),1),o=1===r[0].shape[0],l=sz(s,i,a,o),u=Uf.computeOutShape(e.map(e=>e.shape),t),d=n.makeTensorInfo(u,a,l);return r.forEach(e=>n.disposeIntermediateTensorInfo(e)),d}let s=e.filter(e=>Ns.sizeFromShape(e.shape)>0),i=Pt().getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&s[0].shape.length>1;if(1===s.length){let t=i?new nP(e[0].shape,oP):new lP(e[0].shape,oP);return n.runWebGLProgram(t,e,a)}let o=Pt().getNumber("WEBGL_MAX_TEXTURES_IN_SHADER");if(s.length>o){let e=[];for(let r=0;r<s.length;r+=o){let a=s.slice(r,r+o);e.push(xW(a,t,n))}let a=xW(e,t,n);for(let t of e)n.disposeIntermediateTensorInfo(t);return a}if(i){let e=new hW(s.map(e=>e.shape),t);return n.runWebGLProgram(e,s,a)}let{tensors2D:l,outShape:u}=function(e,t,n){let a=Uf.computeOutShape(e.map(e=>e.shape),t);return{tensors2D:e.map(e=>PP({inputs:{x:e},attrs:{shape:[-1,Ns.sizeFromShape(e.shape.slice(t))]},backend:n})),outShape:a}}(s,t,n),d=new pW(l.map(e=>e.shape)),c=n.runWebGLProgram(d,l,a);l.forEach(e=>n.disposeIntermediateTensorInfo(e));let p=PP({inputs:{x:c},attrs:{shape:u},backend:n});return n.disposeIntermediateTensorInfo(c),p}function bW(e){let{inputs:t,backend:n,attrs:a}=e,{axis:r}=a,s=Ns.parseAxisParam(r,t[0].shape)[0],i=t.map(e=>e.shape);Uf.assertParamsConsistent(i,s);let o=Uf.computeOutShape(t.map(e=>e.shape),s);if(0===Ns.sizeFromShape(o))return n.makeTensorInfo(o,t[0].dtype,[]);let l=t.filter(e=>Ns.sizeFromShape(e.shape)>0);return 1===l.length?vP({inputs:{x:l[0]},backend:n}):xW(l,s,n)}var yW={kernelName:vn,backendName:"webgl",kernelFunc:bW},wW=class{constructor(e,t=!1,n=null,a=!1,r=!1){this.variableNames=["x","W"],this.outputShape=e.outShape;let s=e.padInfo.top,i=e.padInfo.left,o=e.strideHeight,l=e.strideWidth,u=e.dilationHeight,d=e.dilationWidth,c=e.filterHeight,p=e.filterWidth,h=4*Math.floor(e.inChannels/4),m=e.inChannels%4,f="channelsLast"===e.dataFormat,g=f?1:2,x=f?2:3,b=f?3:1,y="",w="";n&&(y=a?`float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          ${n}\n        }`:r?`float activation(float a) {\n          float b = getLeakyreluAlphaAtOutCoords();\n          ${n}\n        }`:`\n          float activation(float x) {\n            ${n}\n          }\n        `,w="result = activation(result);");let v=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),a&&this.variableNames.push("preluActivationWeights"),r&&this.variableNames.push("leakyreluAlpha"),this.userCode=`\n      ${y}\n\n      const ivec2 strides = ivec2(${o}, ${l});\n      const ivec2 pads = ivec2(${s}, ${i});\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords[${b}];\n\n        ivec2 xRCCorner =\n            ivec2(coords[${g}], coords[${x}]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < ${c}; wR++) {\n          int xR = xRCorner + wR * ${u};\n\n          if (xR < 0 || xR >= ${e.inHeight}) {\n            continue;\n          }\n\n          for (int wC = 0; wC < ${p}; wC++) {\n            int xC = xCCorner + wC * ${d};\n\n            if (xC < 0 || xC >= ${e.inWidth}) {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < ${h}; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if (${f}) {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if (${1===m}) {\n\n              if (${f}) {\n                dotProd +=\n                    getX(batch, xR, xC, ${h}) *\n                    getW(wR, wC, ${h}, d2);\n              } else {\n                dotProd +=\n                    getX(batch, ${h}, xR, xC) *\n                    getW(wR, wC, ${h}, d2);\n              }\n\n            } else if (${2===m}) {\n              vec2 wValues = vec2(\n                getW(wR, wC, ${h}, d2),\n                getW(wR, wC, ${h} + 1, d2)\n              );\n\n              if (${f}) {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, ${h}),\n                  getX(batch, xR, xC, ${h} + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, ${h}, xR, xC),\n                  getX(batch, ${h} + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if (${3===m}) {\n              vec3 wValues = vec3(\n                getW(wR, wC, ${h}, d2),\n                getW(wR, wC, ${h} + 1, d2),\n                getW(wR, wC, ${h} + 2, d2)\n              );\n\n              if (${f}) {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, ${h}),\n                  getX(batch, xR, xC, ${h} + 1),\n                  getX(batch, xR, xC, ${h} + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, ${h}, xR, xC),\n                  getX(batch, ${h} + 1, xR, xC),\n                  getX(batch, ${h} + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        ${v}\n        ${w}\n        setOutput(result);\n      }\n    `}},vW=class{constructor(e){this.variableNames=["x","W"],this.outputShape=e.outShape;let t=e.padInfo.front,n=e.padInfo.top,a=e.padInfo.left,r=e.strideDepth,s=e.strideHeight,i=e.strideWidth,o=e.dilationDepth,l=e.dilationHeight,u=e.dilationWidth,d=e.filterDepth,c=e.filterHeight,p=e.filterWidth,h=4*Math.floor(e.inChannels/4),m=e.inChannels%4;this.userCode=`\n      const ivec3 strides = ivec3(${r}, ${s}, ${i});\n      const ivec3 pads = ivec3(${t}, ${n}, ${a});\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < ${d}; wF++) {\n          int xF = xFCorner + wF * ${o};\n\n          if (xF < 0 || xF >= ${e.inDepth}) {\n            continue;\n          }\n\n          for (int wR = 0; wR < ${c}; wR++) {\n            int xR = xRCorner + wR * ${l};\n\n            if (xR < 0 || xR >= ${e.inHeight}) {\n              continue;\n            }\n\n            for (int wC = 0; wC < ${p}; wC++) {\n              int xC = xCCorner + wC * ${u};\n\n              if (xC < 0 || xC >= ${e.inWidth}) {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < ${h}; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if (${1===m}) {\n                dotProd +=\n                  getX(batch, xF, xR, xC, ${h}) *\n                  getW(wF, wR, wC, ${h}, d2);\n              } else if (${2===m}) {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, ${h}),\n                  getX(batch, xF, xR, xC, ${h} + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, ${h}, d2),\n                  getW(wF, wR, wC, ${h} + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if (${3===m}) {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, ${h}),\n                  getX(batch, xF, xR, xC, ${h} + 1),\n                  getX(batch, xF, xR, xC, ${h} + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, ${h}, d2),\n                  getW(wF, wR, wC, ${h} + 1, d2),\n                  getW(wF, wR, wC, ${h} + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},kW=class{constructor(e,t=!1,n=null,a=!1,r=!1){this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"pads",type:"ivec2"},{name:"strides",type:"ivec2"},{name:"dilations",type:"ivec2"},{name:"inDims",type:"ivec2"}],this.outputShape=e.outShape,this.enableShapeUniforms=vL(this.outputShape.length);let s=e.padInfo.left,i=e.strideWidth,o=e.dilationWidth,l=e.filterHeight,u=e.filterWidth,d=u,c="\n       int xR; int xC; int xCOffset;\n       vec4 wTexel; vec4 previous; vec4 final;";for(let f=0;f<u;f++)c+=`\n           vec4 xTexelC${2*f};\n           int xTexelC${2*f}Ready;\n           vec4 xTexelC${2*f+1};\n           int xTexelC${2*f+1}Ready;\n           vec4 xC${f};`;c+=`\n     for (int r = 0; r < ${l}; r++) {\n      for (int d1 = 0; d1 < ${e.inChannels}; d1 += 2) {\n       `;for(let f=0;f<u;f++)c+=`\n           xTexelC${2*f} = vec4(0.0);\n           xTexelC${2*f}Ready = 0;\n           xTexelC${2*f+1} = vec4(0.0);\n           xTexelC${2*f+1}Ready = 0;\n           xC${f} = vec4(0.0);`;c+="\n         xR = xRCorner + r * dilations[0];\n         if (xR >=0 && xR < inDims[0]) {\n       ";for(let f=0;f<(d+1)/2;f++){let t=2*f;if(c+=`\n           xC = xCCorner + ${t*o};\n           `,1===i){if(t<u&&(s%2==1?(c+=`\n                 xCOffset = xC + 1;\n                 if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC${t}Ready == 0) {\n                   xTexelC${t} = getX(batch, xR, xCOffset, d1);\n\n                   // Need to manually clear unused channels in case\n                   // we're reading from recycled texture.\n                   if (xCOffset + 1 >= inDims[1]) {\n                     xTexelC${t}.zw = vec2(0.0);\n                   }\n                   xTexelC${t}Ready = 1;\n                 }\n               `,c+=1===o&&t>0?`\n                 xC${t} = vec4(xTexelC${t-2}.zw, xTexelC${t}.xy);\n                 `:`\n                   xCOffset = xC + 1 - 2;\n\n                   if (xCOffset >= 0 && xCOffset < inDims[1]) {\n                     previous = getX(batch, xR, xCOffset, d1);\n\n                     // Need to manually clear unused channels in case\n                     // we're reading from recycled texture.\n                     if (xCOffset + 1 >= inDims[1]) {\n                       previous.zw = vec2(0.0);\n                     }\n\n                     xC${t} = vec4(previous.zw, xTexelC${t}.xy);\n                   } else {\n                     xC${t} = vec4(0.0, 0.0, xTexelC${t}.xy);\n                   }\n                   `):c+=`\n                 if (xC >= 0 && xC < inDims[1] && xTexelC${t}Ready == 0) {\n                   xTexelC${t} = getX(batch, xR, xC, d1);\n                   if (xC + 1 >= inDims[1]) {\n                     xTexelC${t}.zw = vec2(0.0);\n                   }\n                   xTexelC${t}Ready = 1;\n                 }\n\n                 xC${t} = xTexelC${t};\n                 `,t+1<u)){let e=s%2==0?Ns.nearestLargerEven(o):o;o%2==0&&s%2==1||o%2!=0&&s%2!=1?(c+=`\n                   xCOffset = xC + imod(pads[1], 2) + ${e};\n\n                   if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC${t+1}Ready == 0) {\n                     xTexelC${t+1} = getX(batch, xR, xCOffset, d1);\n\n                     // Need to manually clear unused channels in case\n                     // we're reading from recycled texture.\n                     if (xCOffset + 1 >= inDims[1]) {\n                       xTexelC${t+1}.zw = vec2(0.0);\n                     }\n                     xTexelC${t+1}Ready = 1;\n                   }\n                   `,c+=o>1?`\n                     xCOffset -= 2;\n                     if (xCOffset >= 0 && xCOffset < inDims[1]) {\n                      previous = getX(batch, xR, xCOffset, d1);\n                      xC${t+1} = vec4(previous.zw, xTexelC${t+1}.xy);\n                     } else {\n                      xC${t+1} = vec4(0.0, 0.0, xTexelC${t+1}.xy);\n                     }\n                     `:`\n                     xC${t+1} = vec4(xTexelC${t}.zw, xTexelC${t+1}.xy);\n                     `):c+=1===e?`\n                     xC${t+1} = xTexelC${t};\n                     `:`\n                     xCOffset = xC + ${e};\n\n                     if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC${t+1}Ready == 0) {\n                       xTexelC${t+1} = getX(batch, xR, xCOffset, d1);\n                       if (xCOffset + 1 >= inDims[1]) {\n                         xTexelC${t+1}.zw = vec2(0.0);\n                       }\n                       xTexelC${t+1}Ready = 1;\n                     }\n\n                     xC${t+1} = xTexelC${t+1};\n                     `}}else t<u&&(s%2==1?(c+=`\n                 xCOffset = xC + 1 - strides[1];\n                 if(xCOffset >= 0 && xCOffset < inDims[1] && xTexelC${t}Ready == 0) {\n                   xTexelC${t} = getX(batch, xR, xCOffset, d1);\n                   // Need to manually clear unused channels in case\n                   // we're reading from recycled texture.\n                   if (xCOffset + 1 >= inDims[1]) {\n                     xTexelC${t}.zw = vec2(0.0);\n                   }\n                   xTexelC${t}Ready = 1;\n                 }\n\n                 if(xC + 1 >= 0 && xC + 1 < inDims[1] && xTexelC${t+1}Ready == 0) {\n                   xTexelC${t+1} = getX(batch, xR, xC + 1, d1);\n                   // Need to manually clear unused channels in case\n                   // we're reading from recycled texture.\n                   if (xC + 2 >= inDims[1]) {\n                     xTexelC${t+1}.zw = vec2(0.0);\n                   }\n                   xTexelC${t+1}Ready = 1;\n                 }\n\n                 xC${t} = vec4(xTexelC${t}.zw, xTexelC${t+1}.zw);\n               `,t+1<u&&(c+=`\n                   final = vec4(0.0);\n                   xCOffset = xC + 1 + strides[1];\n                   if(xCOffset >= 0 && xCOffset < inDims[1]) {\n                     final = getX(batch, xR, xCOffset, d1);\n                   }\n                   xC${t+1} = vec4(xTexelC${t+1}.xy, final.xy);\n                 `)):(c+=`\n                 if(xC >= 0 && xC < inDims[1] && xTexelC${t}Ready == 0) {\n                   xTexelC${t} = getX(batch, xR, xC, d1);\n                   if (xC + 1 >= inDims[1]) {\n                     xTexelC${t}.zw = vec2(0.0);\n                   }\n                   xTexelC${t}Ready = 1;\n                 }\n\n                 xCOffset = xC + strides[1];\n                 if(xCOffset >= 0 && xCOffset < inDims[1] && xTexelC${t+1}Ready == 0) {\n                   xTexelC${t+1} = getX(batch, xR, xCOffset, d1);\n                   if (xCOffset + 1 >= inDims[1]) {\n                     xTexelC${t+1}.zw = vec2(0.);\n                   }\n                   xTexelC${t+1}Ready = 1;\n                 }\n\n                 xC${t} = vec4(\n                   xTexelC${t}.xy, xTexelC${t+1}.xy);\n               `,t+1<u&&(c+=`\n                   xC${t+1} = vec4(xTexelC${t}.zw, xTexelC${t+1}.zw);\n                 `)));t<u&&(c+=`\n             wTexel = getW(r, ${t}, d1, d2);\n             dotProd += xC${t}.xxzz * vec4(wTexel.xy, wTexel.xy);\n             if(d1 + 1 < ${e.inChannels}) {\n               dotProd += xC${t}.yyww * vec4(wTexel.zw, wTexel.zw);\n             }\n           `,t+1<u&&(c+=`\n               wTexel = getW(r, ${t+1}, d1, d2);\n               dotProd += xC${t+1}.xxzz * vec4(wTexel.xy, wTexel.xy);\n               if(d1 + 1 < ${e.inChannels}) {\n                 dotProd += xC${t+1}.yyww * vec4(wTexel.zw, wTexel.zw);\n               }\n             `))}c+="\n     }\n   ",c+="\n     }\n   ",c+="\n     }\n   ";let p="",h="";n&&(p=a?`vec4 activation(vec4 a) {\n           vec4 b = getPreluActivationWeightsAtOutCoords();\n           ${n}\n         }`:r?`vec4 activation(vec4 a) {\n           vec4 b = getLeakyreluAlphaAtOutCoords();\n           ${n}\n         }`:`vec4 activation(vec4 x) {\n           ${n}\n         }`,h="result = activation(result);");let m=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),a&&this.variableNames.push("preluActivationWeights"),r&&this.variableNames.push("leakyreluAlpha"),this.userCode=`\n       ${p}\n\n       void main() {\n         ivec4 coords = getOutputCoords();\n         int batch = coords.x;\n         ivec2 xRCCorner = coords.yz * strides - pads;\n         int d2 = coords.w;\n         int xRCorner = xRCCorner.x;\n         int xCCorner = xRCCorner.y;\n\n         //intialize dotProd with a small epsilon seems to reduce GPU accuracy loss.\n         vec4 dotProd = vec4(0.000000000000001);\n\n         ${c}\n\n         vec4 result = dotProd - vec4(0.000000000000001);\n         ${m}\n         ${h}\n         setOutput(result);\n       }\n     `}},NW=class{constructor(e,t){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"inputShape",type:"ivec4"},{name:"pad",type:"ivec2"},{name:"stride",type:"ivec2"},{name:"dilation",type:"ivec2"},{name:"inChannels",type:"int"},{name:"itemsPerBlockRow",type:"int"},{name:"outWidth",type:"int"}],this.outputShape=e,this.enableShapeUniforms=vL(this.outputShape.length);let{dataFormat:n}=t,a=eL(),r="channelsLast"===n,s=r?1:2,i=r?2:3,o=this.enableShapeUniforms?"if(blockIndex < outShape[2] && pos < outShape[1]) {":`if(blockIndex < ${e[2]} && pos < ${e[1]}) {`,l="";for(let u=0;u<=1;u++)for(let e=0;e<=1;e++)l+=`\n          blockIndex = rc.z + ${e};\n          pos = rc.y + ${u};\n\n          ${o}\n            offsetY = int(blockIndex / outWidth) * stride[0] - pad[0];\n            d0 = offsetY + dilation[0] * (pos / itemsPerBlockRow);\n\n            if(d0 < inputShape[${s}] && d0 >= 0) {\n              // Use custom imod instead mod. On Intel GPU, mod may generate\n              // unexpected value.\n              // https://github.com/tensorflow/tfjs/issues/5447\n              offsetX = imod(blockIndex, outWidth) * stride[1] - pad[1];\n              d1 = offsetX + dilation[1] * (imod(pos, itemsPerBlockRow) /\n                  inChannels);\n\n              if(d1 < inputShape[${i}] && d1 >= 0) {\n\n                ch = imod(pos, inChannels);\n\n                if (${r}) {\n                  innerDims = vec2(d1, ch);\n                  result[${2*u+e}] = getChannel(\n                    getA(rc.x, d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result[${2*u+e}] = getChannel(\n                    getA(rc.x, ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        `;this.userCode=`\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        ${l}\n\n        ${a.output} = result;\n      }\n    `}};function SW(e,t){let n=e.length;return n>=3?t?[...e.slice(0,-3),e[n-3]*e[n-2],e[n-1]]:[...e.slice(0,-3),e[n-3],e[n-2]*e[n-1]]:!t&&1===n&&e[0]>1?[e[0],1]:null}function IW({x:e,filter:t,convInfo:n,backend:a,bias:r=null,preluActivationWeights:s=null,leakyreluAlpha:i=0,activation:o=null}){let l,u=e.shape,d=a.texData.get(e.dataId),c=n.inChannels,p=u[0]*u[1]*u[2],h=n.outChannels,m="channelsLast"===n.dataFormat,f=!1,g=[];if(null!=s){let e=SW(s.shape,m);null!=e&&(s=PP({inputs:{x:s},backend:a,attrs:{shape:e}}),g.push(s))}if(null!=r){let e=SW(r.shape,m);null!=e&&(r=PP({inputs:{x:r},backend:a,attrs:{shape:e}}),g.push(r))}if((1!==p&&1!==h||!(c>1e3))&&d.isPacked&&m&&null!=d.texture&&u[2]%2!=0&&Ns.arraysEqual(d.shape.slice(-3),u.slice(-3))){let c=u[0]*u[1]*(u[2]+1),p={dataId:e.dataId,shape:[1,c,n.inChannels],dtype:e.dtype},h=d.shape;d.shape=d.shape.slice(),d.shape[d.shape.length-2]++,Ns.assert(Pj(d.shape,p.shape),()=>`packed reshape ${d.shape} to ${p.shape} isn't free`);let m=PP({inputs:{x:t},backend:a,attrs:{shape:[1,n.inChannels,n.outChannels]}});g.push(m);let x=JP({a:p,b:m,backend:a,transposeA:!1,transposeB:f,bias:r,activation:o,preluActivationWeights:s,leakyreluAlpha:i}),b=a.texData.get(x.dataId);Ns.assert(b.isPacked,()=>"batchMatMul result is expected to be packed"),d.shape=h,b.shape=n.outShape,l=vP({inputs:{x:x},backend:a}),l.shape=n.outShape,g.push(x)}else{let u=n.outHeight*n.outWidth,d=PP({inputs:{x:e},backend:a,attrs:{shape:m?[n.batchSize,u,n.inChannels]:[n.batchSize,n.inChannels,u]}}),c=PP({inputs:{x:t},backend:a,attrs:{shape:[1,n.inChannels,n.outChannels]}}),p=JP({a:m?d:c,b:m?c:d,transposeA:!m,transposeB:f,backend:a,bias:r,activation:o,preluActivationWeights:s,leakyreluAlpha:i});l=PP({inputs:{x:p},backend:a,attrs:{shape:n.outShape}}),g.push(d),g.push(c),g.push(p)}for(let x of g)a.disposeIntermediateTensorInfo(x);return l}function _W({x:e,filter:t,convInfo:n,backend:a,bias:r=null,preluActivationWeights:s=null,leakyreluAlpha:i=0,activation:o=null}){let{filterWidth:l,filterHeight:u,inChannels:d,outWidth:c,outHeight:p,dataFormat:h}=n,m="channelsLast"===h,f=l*u*d,g=p*c,x=[n.batchSize,f,g],b=[];if(null!=s){let e=SW(s.shape,m);null!=e&&(s=PP({inputs:{x:s},backend:a,attrs:{shape:e}}),b.push(s))}if(null!=r){let e=SW(r.shape,m);null!=e&&(r=PP({inputs:{x:r},backend:a,attrs:{shape:e}}),b.push(r))}let y=PP({inputs:{x:t},backend:a,attrs:{shape:[1,f,Ns.sizeFromShape(t.shape)/f]}});b.push(y);let w=new NW(x,n),v=[e.shape,[n.padInfo.top,n.padInfo.left],[n.strideHeight,n.strideWidth],[n.dilationHeight,n.dilationWidth],[n.inChannels],[n.filterWidth*n.inChannels],[n.outWidth]],k=a.runWebGLProgram(w,[e],"float32",v),N=PP({inputs:{x:k},backend:a,attrs:{shape:x}});b.push(k),b.push(N);let S=null!=r,I=null!=s,_="leakyrelu"===o,C=o?DP(o,!0):null,T=new MP(m?N.shape:y.shape,m?y.shape:N.shape,m?[n.batchSize,g,n.outChannels]:[n.batchSize,n.outChannels,g],!0,!1,S,C,I,_),E=m?[N,y]:[y,N];if(r&&E.push(r),I&&E.push(s),_){let e=a.makeTensorInfo([],"float32",Ns.createScalarValue(i,"float32"));E.push(e),b.push(e)}let A=a.runWebGLProgram(T,E,"float32"),$=PP({inputs:{x:A},backend:a,attrs:{shape:n.outShape}});b.push(A);for(let R of b)a.disposeIntermediateTensorInfo(R);return $}var CW,TW={kernelName:kn,backendName:"webgl",kernelFunc:function(e){let t,{inputs:n,backend:a,attrs:r}=e,{x:s,filter:i}=n,{strides:o,pad:l,dataFormat:u,dilations:d,dimRoundingMode:c}=r,p=Uf.convertConv2DDataFormat(u),h=Uf.computeConv2DInfo(s.shape,i.shape,o,d,l,c,!1,p);if(1!==h.filterHeight||1!==h.filterWidth||1!==h.dilationHeight||1!==h.dilationWidth||1!==h.strideHeight||1!==h.strideWidth||"SAME"!==h.padInfo.type&&"VALID"!==h.padInfo.type)if(h.strideWidth<=2&&"channelsLast"===p&&Pt().getBool("WEBGL_EXP_CONV")){let e=new kW(h),n=[[h.padInfo.top,h.padInfo.left],[h.strideHeight,h.strideWidth],[h.dilationHeight,h.dilationWidth],[h.inHeight,h.inWidth]];t=a.runWebGLProgram(e,[s,i],"float32",n)}else if(Pt().getBool("WEBGL_CONV_IM2COL"))t=_W({x:s,filter:i,convInfo:h,backend:a});else{let e=new wW(h);t=a.runWebGLProgram(e,[s,i],"float32")}else t=IW({x:s,filter:i,convInfo:h,backend:a});let m=PP({inputs:{x:t},backend:a,attrs:{shape:h.outShape}});return a.disposeIntermediateTensorInfo(t),m}},EW=class{constructor(e){this.variableNames=["x","dy"],this.outputShape=e.filterShape;let t=e.strideHeight,n=e.strideWidth,a=e.padInfo.top,r=e.padInfo.left,s="channelsLast"===e.dataFormat;this.userCode=`\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < ${e.batchSize}; b++) {\n          for (int yR = 0; yR < ${e.outHeight}; yR++) {\n            int xR = wR + yR * ${t} - ${a};\n\n            if (xR < 0 || xR >= ${e.inHeight}) {\n              continue;\n            }\n\n            for (int yC = 0; yC < ${e.outWidth}; yC++) {\n              int xC = wC + yC * ${n} - ${r};\n\n              if (xC < 0 || xC >= ${e.inWidth}) {\n                continue;\n              }\n\n              ${s?"float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);":"float dyValue = getDy(b, d2, yR, yC);\n              float xValue = getX(b, d1, xR, xC);\n              dotProd += (xValue * dyValue);"}\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},AW=class{constructor(e){this.variableNames=["dy","W"],this.outputShape=e.inShape;let t=e.filterHeight,n=e.filterWidth,a=e.strideHeight,r=e.strideWidth,s="channelsLast"===e.dataFormat,i=t-1-e.padInfo.top,o=n-1-e.padInfo.left,l=s?1:2,u=s?2:3,d=s?3:1;this.userCode=`\n      const ivec2 pads = ivec2(${i}, ${o});\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[${d}];\n\n        ivec2 dyCorner = ivec2(coords[${l}], coords[${u}]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < ${t}; wR++) {\n          float dyR = float(dyRCorner + wR) / ${a}.0;\n\n          if (dyR < 0.0 || dyR >= ${e.outHeight}.0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = ${t} - 1 - wR;\n\n          for (int wC = 0; wC < ${n}; wC++) {\n            float dyC = float(dyCCorner + wC) / ${r}.0;\n\n            if (dyC < 0.0 || dyC >= ${e.outWidth}.0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = ${n} - 1 - wC;\n\n            for (int d2 = 0; d2 < ${e.outChannels}; d2++) {\n\n              if (${s}) {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},$W=class{constructor(e){this.variableNames=["x","dy"],this.outputShape=e.filterShape;let t=e.strideDepth,n=e.strideHeight,a=e.strideWidth,r=e.padInfo.front,s=e.padInfo.top,i=e.padInfo.left;this.userCode=`\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < ${e.batchSize}; b++) {\n          for (int yF = 0; yF < ${e.outDepth}; yF++) {\n            int xF = wF + yF * ${t} - ${r};\n\n            if (xF < 0 || xF >= ${e.inDepth}) {\n              continue;\n            }\n\n            for (int yR = 0; yR < ${e.outHeight}; yR++) {\n              int xR = wR + yR * ${n} - ${s};\n\n              if (xR < 0 || xR >= ${e.inHeight}) {\n                continue;\n              }\n\n              for (int yC = 0; yC < ${e.outWidth}; yC++) {\n                int xC = wC + yC * ${a} - ${i};\n\n                if (xC < 0 || xC >= ${e.inWidth}) {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},RW=class{constructor(e){this.variableNames=["dy","W"],this.outputShape=e.inShape;let t=e.filterDepth,n=e.filterHeight,a=e.filterWidth,r=e.strideDepth,s=e.strideHeight,i=e.strideWidth,o=t-1-e.padInfo.front,l=n-1-e.padInfo.top,u=a-1-e.padInfo.left;this.userCode=`\n      const ivec3 pads = ivec3(${o}, ${l}, ${u});\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < ${t}; wF++) {\n          float dyF = float(dyFCorner + wF) / ${r}.0;\n\n          if (dyF < 0.0 || dyF >= ${e.outDepth}.0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = ${t} - 1 - wF;\n\n          for (int wR = 0; wR < ${n}; wR++) {\n            float dyR = float(dyRCorner + wR) / ${s}.0;\n\n            if (dyR < 0.0 || dyR >= ${e.outHeight}.0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = ${n} - 1 - wR;\n\n            for (int wC = 0; wC < ${a}; wC++) {\n              float dyC = float(dyCCorner + wC) / ${i}.0;\n\n              if (dyC < 0.0 || dyC >= ${e.outWidth}.0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = ${a} - 1 - wC;\n\n              for (int d2 = 0; d2 < ${e.outChannels}; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},FW={kernelName:Nn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,dy:s}=t,{strides:i,pad:o,dataFormat:l,dimRoundingMode:u,filterShape:d}=a,c=Uf.convertConv2DDataFormat(l),p=Uf.computeConv2DInfo(r.shape,d,i,1,o,u,!1,c),h=new EW(p);return n.runWebGLProgram(h,[r,s],"float32")}},DW=class{constructor(e){this.variableNames=["dy","W"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"strides",type:"vec2"}],this.outputShape=e.inShape,this.enableShapeUniforms=vL(this.outputShape.length);let t=e.filterHeight,n=e.filterWidth,a=t-1-e.padInfo.top,r=n-1-e.padInfo.left;this.userCode=`\n      const ivec2 pads = ivec2(${a}, ${r});\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n\n        ivec2 dyCorner = ivec2(coords[1], coords[2]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        vec4 result = vec4(0.);\n        for (int wR = 0; wR < ${t}; wR++) {\n          float dyR = float(dyRCorner + wR) / strides[0];\n          if (dyR < 0.0 || dyR >= ${e.outHeight}.0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n          int wRPerm = ${t} - 1 - wR;\n\n          for (int wC = 0; wC < ${n}; wC++) {\n            int wCPerm = ${n} - 1 - wC;\n\n            float dyC = float(dyCCorner + wC) / strides[1];\n            bool idyCVal = (dyC >= 0.0) && (dyC < ${e.outWidth}.0)\n              && (fract(dyC) == 0.0);\n            int idyC = int(dyC);\n\n            float dyC2 = float(dyCCorner + wC + 1) / strides[1];\n            bool idyCVal2 = (dyC2 >= 0.0) && (dyC2 < ${e.outWidth}.0)\n              && (fract(dyC2) == 0.0);\n            int idyC2 = int(dyC2);\n\n            if (idyCVal && idyCVal2) {\n              for (int d2 = 0; d2 < ${e.outChannels}; d2 += 2) {\n                vec4 wValue = getW(wRPerm, wCPerm, d1, d2);\n                vec4 dySample = getDy(batch, idyR, idyC, d2);\n                vec4 dySample2 = (idyC / 2 == idyC2 / 2) ?\n                  dySample : getDy(batch, idyR, idyC2, d2);\n\n                vec2 dyValue = mod(float(idyC), 2.) == 0. ?\n                  dySample.xy : dySample.zw;\n                result.xy += vec2(dot(dyValue, wValue.xy),\n                  dot(dyValue, wValue.zw));\n\n                dyValue = mod(float(idyC2), 2.) == 0. ?\n                  dySample2.xy : dySample2.zw;\n                result.zw += vec2(dot(dyValue, wValue.xy),\n                  dot(dyValue, wValue.zw));\n              }\n            } else if (idyCVal) {\n              for (int d2 = 0; d2 < ${e.outChannels}; d2 += 2) {\n                vec4 wValue = getW(wRPerm, wCPerm, d1, d2);\n                vec4 dySample = getDy(batch, idyR, idyC, d2);\n                vec2 dyValue = mod(float(idyC), 2.) == 0. ?\n                  dySample.xy : dySample.zw;\n                result.xy += vec2(dot(dyValue, wValue.xy),\n                  dot(dyValue, wValue.zw));\n              }\n            } else if (idyCVal2) {\n              for (int d2 = 0; d2 < ${e.outChannels}; d2 += 2) {\n                vec4 wValue = getW(wRPerm, wCPerm, d1, d2);\n                vec4 dySample = getDy(batch, idyR, idyC2, d2);\n                vec2 dyValue = mod(float(idyC2), 2.) == 0. ?\n                  dySample.xy : dySample.zw;\n                result.zw += vec2(dot(dyValue, wValue.xy),\n                  dot(dyValue, wValue.zw));\n              }\n            }\n          }\n        }\n        setOutput(result);\n      }\n    `}},MW={kernelName:Sn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,filter:s}=t,{inputShape:i,strides:o,pad:l,dataFormat:u,dimRoundingMode:d}=a,c=Uf.convertConv2DDataFormat(u),p=Uf.computeConv2DInfo(i,s.shape,o,1,l,d,!1,c);if(Pt().getBool("WEBGL_PACK_CONV2DTRANSPOSE")&&"channelsLast"===c){let e=[[p.strideHeight,p.strideWidth]],t=new DW(p);return n.runWebGLProgram(t,[r,s],"float32",e)}{let e=new AW(p);return n.runWebGLProgram(e,[r,s],"float32")}}},OW={kernelName:In,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s}=t,{strides:i,pad:o,dilations:l}=a,u=Uf.computeConv3DInfo(r.shape,s.shape,i,l,o),d=new vW(u);return n.runWebGLProgram(d,[r,s],"float32")}},jW={kernelName:_n,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,dy:s}=t,{strides:i,pad:o,filterShape:l}=a,u=Uf.computeConv3DInfo(r.shape,l,i,1,o),d=new $W(u);return n.runWebGLProgram(d,[r,s],"float32")}},LW={kernelName:Cn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,filter:s}=t,{pad:i,strides:o,inputShape:l}=a,u=Uf.computeConv3DInfo(l,s.shape,o,1,i),d=new RW(u);return n.runWebGLProgram(d,[r,s],"float32")}},zW=RP({opSnippet:$P+"\n  return cos(x);\n",packedOpSnippet:`\n  vec4 result = cos(x);\n  bvec4 isNaN = isnan(x);\n  ${yP}\n  return result;\n`}),PW={kernelName:Tn,backendName:"webgl",kernelFunc:zW},BW=RP({opSnippet:"\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n"}),WW={kernelName:En,backendName:"webgl",kernelFunc:BW},VW=class{constructor(e,t,n,a,r){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];let[s,i,o,l]=e,[u]=t,[d,c]=n;this.outputShape=[u,d,c,l];let p="bilinear"===a?1:0,[h,m]=[i-1+".0",o-1+".0"],[f,g,x]=d>1?[""+(i-1)/(d-1),"(y2-y1) * height_ratio",`y1*${h} + float(y)*(height_scale)`]:["0.0","0.0",`0.5 * (y1+y2) * ${h}`],[b,y,w]=c>1?[""+(o-1)/(c-1),"(x2-x1) * width_ratio",`x1*${m} + float(x)*(width_scale)`]:["0.0","0.0",`0.5 * (x1+x2) * ${m}`];this.userCode=`\n      const float height_ratio = float(${f});\n      const float width_ratio = float(${b});\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= ${s}) {\n          return;\n        }\n\n        float height_scale = ${g};\n        float width_scale = ${y};\n\n        float in_y = ${x};\n        if( in_y < 0.0 || in_y > ${h} ) {\n          setOutput(float(${r}));\n          return;\n        }\n        float in_x = ${w};\n        if( in_x < 0.0 || in_x > ${m} ) {\n          setOutput(float(${r}));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if(${p} == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    `}},UW={kernelName:Rn,backendName:"webgl",kernelFunc:e=>{let{inputs:t,backend:n,attrs:a}=e,{image:r,boxes:s,boxInd:i}=t,{cropSize:o,method:l,extrapolationValue:u}=a,d=new VW(r.shape,s.shape,o,l,u);return n.runWebGLProgram(d,[r,s,i],"float32")}};!function(e){e.Prod="*",e.Sum="+"}(CW||(CW={}));var GW=class{constructor(e,t,n,a){this.op=e,this.outputShape=t,this.variableNames=["x"],this.customUniforms=[{name:"index",type:"float"}];let r=this.outputShape.length,s=this.op===CW.Prod?"1.0":"0.0",i=n?s:`getX(${HW(r,"coords",this.op)})`,o=this.outputShape[this.outputShape.length-1],l="",u="";n?(l=a?"end != "+(o-1):"end != 0",u=a?"end + 1":"end - 1"):(l=a?`end + pow2 < ${o}`:"end >= pow2",u=a?"end + pow2":"end - pow2"),this.userCode=`\n      void main() {\n        ${fL(r)} coords = getOutputCoords();\n        int end = ${qW(r,"coords",this.op)};\n        float val = ${i};\n        int pow2 = int(pow(2.0, index));\n        if (${l}) {\n          int idx = ${u};\n          ${qW(r,"coords",this.op)} = idx;\n          val ${this.op}= getX(${HW(r,"coords",this.op)});\n        }\n        setOutput(val);\n      }\n    `}};function HW(e,t,n){if(1===e)return`${t}`;if(2===e)return`${t}.x, ${t}.y`;if(3===e)return`${t}.x, ${t}.y, ${t}.z`;if(4===e)return`${t}.x, ${t}.y, ${t}.z, ${t}.w`;throw new Error(`Cumulative ${n} for rank ${e} is not yet supported`)}function qW(e,t,n){if(1===e)return`${t}`;if(2===e)return`${t}.y`;if(3===e)return`${t}.z`;if(4===e)return`${t}.w`;throw new Error(`Cumulative ${n} for rank ${e} is not yet supported`)}function KW(e,t,n,a,r,s){let i=t.shape.length,o=Uf.getAxesPermutation([a],i),l=t;null!=o&&(l=YP({inputs:{x:t},backend:n,attrs:{perm:o}}));let u=Uf.getInnerMostAxes(1,i)[0];if(u!==i-1)throw new Error(`WebGL cumprod shader expects an inner-most axis=${t.shape.length-1} but got axis=${a}`);let d=l.shape[u],c=vP({inputs:{x:l},backend:n});for(let p=0;p<=Math.ceil(Math.log2(d))-1;p++){let t=new GW(e,l.shape,!1,s),a=[[p]],r=c;c=n.runWebGLProgram(t,[c],c.dtype,a),n.disposeIntermediateTensorInfo(r)}if(r){let t=new GW(e,l.shape,r,s),a=c;c=n.runWebGLProgram(t,[c],c.dtype),n.disposeIntermediateTensorInfo(a)}if(null!=o){let e=YP({inputs:{x:c},backend:n,attrs:{perm:Uf.getUndoAxesPermutation(o)}});return n.disposeIntermediateTensorInfo(c),n.disposeIntermediateTensorInfo(l),e}return c}var XW={kernelName:An,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,exclusive:i,reverse:o}=a;return KW(CW.Prod,r,n,s,i,o)}},YW={kernelName:$n,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,exclusive:i,reverse:o}=a;return KW(CW.Sum,r,n,s,i,o)}},ZW={kernelName:Fn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,weights:s}=t,{size:i,binaryOutput:o}=a;if(1===r.shape.length){let e=n.readSync(r.dataId),t=n.readSync(s.dataId),a=ez(e,t,s.dtype,s.shape,i);return n.makeTensorInfo([i],s.dtype,a)}if(2===r.shape.length){let e=n.bufferSync(r),t=n.bufferSync(s),a=tz(e,t,i,o);return n.makeTensorInfo(a.shape,s.dtype,a.values)}throw new Error(`Error in denseBincount: input must be at most rank 2, but got rank${r.shape.length}.`)}},JW=class{constructor(e,t,n){this.variableNames=["x"],this.outputShape=[],this.outputShape=e,this.blockSize=t,this.dataFormat=n,this.userCode=`\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = ${this.getHeightCoordString()};\n      int w = ${this.getWidthCoordString()};\n      int d = ${this.getDepthCoordString()};\n\n      int in_h = h / ${t};\n      int offset_h = imod(h, ${t});\n      int in_w = w / ${t};\n      int offset_w = imod(w, ${t});\n      int offset_d = (offset_h * ${t} + offset_w) *\n        ${this.getOutputDepthSize()};\n      int in_d = d + offset_d;\n\n      float result = ${this.getInputSamplingString()};\n      setOutput(result);\n    }\n  `}getHeightCoordString(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"}getWidthCoordString(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"}getDepthCoordString(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"}getOutputDepthSize(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]}getInputSamplingString(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"}},QW={kernelName:Dn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{blockSize:s,dataFormat:i}=a,o=r.shape[0],l=("NHWC"===i?r.shape[1]:r.shape[2])*s,u=("NHWC"===i?r.shape[2]:r.shape[3])*s,d=("NHWC"===i?r.shape[3]:r.shape[1])/(s*s),c=new JW("NHWC"===i?[o,l,u,d]:[o,d,l,u],s,i);return n.runWebGLProgram(c,[r],r.dtype)}},eV=class{constructor(e,t=!1,n=null,a=!1,r=!1){this.variableNames=["x","W"],this.customUniforms=[{name:"pads",type:"ivec2"},{name:"strides",type:"ivec2"},{name:"dilations",type:"ivec2"},{name:"inDims",type:"ivec2"}],this.outputShape=e.outShape,this.enableShapeUniforms=vL(this.outputShape.length);let s=e.filterHeight,i=e.filterWidth,o=e.outChannels/e.inChannels,l="",u="";n&&(l=a?`float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          ${n}\n        }`:r?`float activation(float a) {\n          float b = getLeakyreluAlphaAtOutCoords();\n          ${n}\n        }`:`\n          float activation(float x) {\n            ${n}\n          }\n        `,u="result = activation(result);");let d=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),a&&this.variableNames.push("preluActivationWeights"),r&&this.variableNames.push("leakyreluAlpha"),this.userCode=`\n      ${l}\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / ${o};\n        int q = d2 - d1 * ${o};\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TO DO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < ${s}; wR++) {\n          int xR = xRCorner + wR * dilations[0];\n\n          if (xR < 0 || xR >= inDims[0]) {\n            continue;\n          }\n\n          for (int wC = 0; wC < ${i}; wC++) {\n            int xC = xCCorner + wC * dilations[1];\n\n            if (xC < 0 || xC >= inDims[1]) {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n\n        float result = dotProd;\n        ${d}\n        ${u}\n        setOutput(result);\n      }\n    `}},tV=class{constructor(e,t=!1,n=null,a=!1,r=!1){this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"pads",type:"ivec2"},{name:"strides",type:"ivec2"},{name:"dilations",type:"ivec2"},{name:"inDims",type:"ivec2"}],this.outputShape=e.outShape,this.enableShapeUniforms=vL(this.outputShape.length);let s=e.outChannels/e.inChannels,i=e.padInfo.left,o=e.strideWidth,l=e.dilationWidth,u=e.filterHeight,d=e.filterWidth,c=d,p="\n      int xR; int xC; int xCOffset;\n      vec4 wTexel; vec4 previous; vec4 final;";for(let g=0;g<d;g++)p+=`\n          vec4 xTexelC${2*g};\n          int xTexelC${2*g}Ready;\n          vec4 xTexelC${2*g+1};\n          int xTexelC${2*g+1}Ready;\n          vec4 xC${g};`;p+=`\n    for (int r = 0; r < ${u}; r++) {\n      `;for(let g=0;g<d;g++)p+=`\n          xTexelC${2*g} = vec4(0.0);\n          xTexelC${2*g}Ready = 0;\n          xTexelC${2*g+1} = vec4(0.0);\n          xTexelC${2*g+1}Ready = 0;\n          xC${g} = vec4(0.0);`;p+="\n        xR = xRCorner + r * dilations[0];\n        if (xR >=0 && xR < inDims[0]) {\n      ";for(let g=0;g<(c+1)/2;g++){let e=2*g;if(p+=`\n          xC = xCCorner + ${e*l};\n          `,1===o){if(e<d&&(i%2==1?(p+=`\n                xCOffset = xC + 1;\n                if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC${e}Ready == 0) {\n                  xTexelC${e} = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if (xCOffset + 1 >= inDims[1]) {\n                    xTexelC${e}.zw = vec2(0.0);\n                  }\n                  xTexelC${e}Ready = 1;\n                }\n              `,p+=1===l&&e>0?`\n                xC${e} = vec4(xTexelC${e-2}.zw, xTexelC${e}.xy);\n                `:`\n                  xCOffset = xC + 1 - 2;\n\n                  if (xCOffset >= 0 && xCOffset < inDims[1]) {\n                    previous = getX(batch, xR, xCOffset, d1);\n\n                    // Need to manually clear unused channels in case\n                    // we're reading from recycled texture.\n                    if (xCOffset + 1 >= inDims[1]) {\n                      previous.zw = vec2(0.0);\n                    }\n\n                    xC${e} = vec4(previous.zw, xTexelC${e}.xy);\n                  } else {\n                    xC${e} = vec4(0.0, 0.0, xTexelC${e}.xy);\n                  }\n                  `):p+=`\n                if (xC >= 0 && xC < inDims[1] && xTexelC${e}Ready == 0) {\n                  xTexelC${e} = getX(batch, xR, xC, d1);\n                  if (xC + 1 >= inDims[1]) {\n                    xTexelC${e}.zw = vec2(0.0);\n                  }\n                  xTexelC${e}Ready = 1;\n                }\n\n                xC${e} = xTexelC${e};\n                `,e+1<d)){let t=i%2==0?Ns.nearestLargerEven(l):l;l%2==0&&i%2==1||l%2!=0&&i%2!=1?(p+=`\n                  xCOffset = xC + imod(pads[1], 2) + ${t};\n\n                  if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC${e+1}Ready == 0) {\n                    xTexelC${e+1} = getX(batch, xR, xCOffset, d1);\n\n                    // Need to manually clear unused channels in case\n                    // we're reading from recycled texture.\n                    if (xCOffset + 1 >= inDims[1]) {\n                      xTexelC${e+1}.zw = vec2(0.0);\n                    }\n                    xTexelC${e+1}Ready = 1;\n                  }\n                  `,p+=l>1?`\n                    xCOffset -= 2;\n                    if (xCOffset >= 0 && xCOffset < inDims[1]) {\n                     previous = getX(batch, xR, xCOffset, d1);\n                     xC${e+1} = vec4(previous.zw, xTexelC${e+1}.xy);\n                    } else {\n                     xC${e+1} = vec4(0.0, 0.0, xTexelC${e+1}.xy);\n                    }\n                    `:`\n                    xC${e+1} = vec4(xTexelC${e}.zw, xTexelC${e+1}.xy);\n                    `):p+=1===t?`\n                    xC${e+1} = xTexelC${e};\n                    `:`\n                    xCOffset = xC + ${t};\n\n                    if (xCOffset >= 0 && xCOffset < inDims[1] && xTexelC${e+1}Ready == 0) {\n                      xTexelC${e+1} = getX(batch, xR, xCOffset, d1);\n                      if (xCOffset + 1 >= inDims[1]) {\n                        xTexelC${e+1}.zw = vec2(0.0);\n                      }\n                      xTexelC${e+1}Ready = 1;\n                    }\n\n                    xC${e+1} = xTexelC${e+1};\n                    `}}else e<d&&(i%2==1?(p+=`\n                xCOffset = xC + 1 - strides[1];\n                if(xCOffset >= 0 && xCOffset < inDims[1] && xTexelC${e}Ready == 0) {\n                  xTexelC${e} = getX(batch, xR, xCOffset, d1);\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if (xCOffset + 1 >= inDims[1]) {\n                    xTexelC${e}.zw = vec2(0.0);\n                  }\n                  xTexelC${e}Ready = 1;\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < inDims[1] && xTexelC${e+1}Ready == 0) {\n                  xTexelC${e+1} = getX(batch, xR, xC + 1, d1);\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if (xC + 2 >= inDims[1]) {\n                    xTexelC${e+1}.zw = vec2(0.0);\n                  }\n                  xTexelC${e+1}Ready = 1;\n                }\n\n                xC${e} = vec4(xTexelC${e}.zw, xTexelC${e+1}.zw);\n              `,e+1<d&&(p+=`\n                  final = vec4(0.0);\n                  xCOffset = xC + 1 + strides[1];\n                  if(xCOffset >= 0 && xCOffset < inDims[1]) {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xC${e+1} = vec4(xTexelC${e+1}.xy, final.xy);\n                `)):(p+=`\n                if(xC >= 0 && xC < inDims[1] && xTexelC${e}Ready == 0) {\n                  xTexelC${e} = getX(batch, xR, xC, d1);\n                  if (xC + 1 >= inDims[1]) {\n                    xTexelC${e}.zw = vec2(0.0);\n                  }\n                  xTexelC${e}Ready = 1;\n                }\n\n                xCOffset = xC + strides[1];\n                if(xCOffset >= 0 && xCOffset < inDims[1] && xTexelC${e+1}Ready == 0) {\n                  xTexelC${e+1} = getX(batch, xR, xCOffset, d1);\n                  if (xCOffset + 1 >= inDims[1]) {\n                    xTexelC${e+1}.zw = vec2(0.);\n                  }\n                  xTexelC${e+1}Ready = 1;\n                }\n\n                xC${e} = vec4(\n                  xTexelC${e}.xy, xTexelC${e+1}.xy);\n              `,e+1<d&&(p+=`\n                  xC${e+1} = vec4(xTexelC${e}.zw, xTexelC${e+1}.zw);\n                `)));e<d&&(p+=`\n            wTexel = getW(r, ${e}, d1, q);\n            dotProd += xC${e} * vec4(wTexel.xz, wTexel.xz);\n          `,e+1<d&&(p+=`\n              wTexel = getW(r, ${e+1}, d1, q);\n              dotProd += xC${e+1} * vec4(wTexel.xz, wTexel.xz);\n            `))}p+="\n    }\n  ",p+="\n      }\n    ";let h="",m="";n&&(h=a?`vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          ${n}\n        }`:r?`vec4 activation(vec4 a) {\n          vec4 b = getLeakyreluAlphaAtOutCoords();\n          ${n}\n        }`:`vec4 activation(vec4 x) {\n          ${n}\n        }`,m="result = activation(result);");let f=t?"result += getBiasAtOutCoords();":"";t&&this.variableNames.push("bias"),a&&this.variableNames.push("preluActivationWeights"),r&&this.variableNames.push("leakyreluAlpha"),this.userCode=`\n      ${h}\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / ${s};\n        int q = d2 - d1 * ${s};\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        //intialize dotProd with a small epsilon seems to reduce GPU accuracy loss.\n        vec4 dotProd = vec4(0.000000000000001);\n\n        ${p}\n\n        vec4 result = dotProd - vec4(0.000000000000001);\n        ${f}\n        ${m}\n        setOutput(result);\n      }\n    `}},nV={kernelName:Mn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s}=t,{strides:i,pad:o,dilations:l,dimRoundingMode:u}=a,d=l;null==d&&(d=[1,1]),Ns.assert(Uf.eitherStridesOrDilationsAreOne(i,d),()=>`Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides ${i} and dilations '${d}'`);let c,p=Uf.computeConv2DInfo(r.shape,s.shape,i,d,o,u,!0);c=Pt().getBool("WEBGL_PACK_DEPTHWISECONV")&&p.strideWidth<=2&&p.outChannels/p.inChannels===1?new tV(p):new eV(p);let h=[[p.padInfo.top,p.padInfo.left],[p.strideHeight,p.strideWidth],[p.dilationHeight,p.dilationWidth],[p.inHeight,p.inWidth]];return n.runWebGLProgram(c,[r,s],"float32",h)}},aV=class{constructor(e){this.variableNames=["x","dy"],this.outputShape=e.filterShape;let t=e.strideHeight,n=e.strideWidth,a=e.padInfo.top,r=e.padInfo.left,s=e.outChannels/e.inChannels;this.userCode=`\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * ${s} + dm;\n\n        float dotProd = 0.0;\n\n        // TO DO: Vec4 over the batch size\n        for (int b = 0; b < ${e.batchSize}; b++) {\n          for (int yR = 0; yR < ${e.outHeight}; yR++) {\n            int xR = wR + yR * ${t} - ${a};\n\n            if (xR < 0 || xR >= ${e.inHeight}) {\n              continue;\n            }\n\n            for (int yC = 0; yC < ${e.outWidth}; yC++) {\n              int xC = wC + yC * ${n} - ${r};\n\n              if (xC < 0 || xC >= ${e.inWidth}) {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},rV=class{constructor(e){this.variableNames=["dy","W"],this.outputShape=e.inShape;let t=e.filterHeight,n=e.filterWidth,a=e.strideHeight,r=e.strideWidth,s=t-1-e.padInfo.top,i=n-1-e.padInfo.left,o=e.outChannels/e.inChannels;this.userCode=`\n      const ivec2 pads = ivec2(${s}, ${i});\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < ${t}; wR++) {\n          float dyR = float(dyRCorner + wR) / ${a}.0;\n\n          if (dyR < 0.0 || dyR >= ${e.outHeight}.0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = ${t} - 1 - wR;\n\n          for (int wC = 0; wC < ${n}; wC++) {\n            float dyC = float(dyCCorner + wC) / ${r}.0;\n\n            if (dyC < 0.0 || dyC >= ${e.outWidth}.0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = ${n} - 1 - wC;\n\n            // TO DO: Vec4 over the channelMul\n            for (int dm = 0; dm < ${o}; dm++) {\n              int d2 = d1 * ${o} + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},sV={kernelName:On,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,dy:s}=t,{strides:i,dilations:o,pad:l,dimRoundingMode:u,filterShape:d}=a,c=Uf.computeConv2DInfo(r.shape,d,i,o,l,u,!0),p=new aV(c);return n.runWebGLProgram(p,[r,s],"float32")}},iV={kernelName:jn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,filter:s}=t,{strides:i,dilations:o,pad:l,dimRoundingMode:u,inputShape:d}=a,c=Uf.computeConv2DInfo(d,s.shape,i,o,l,u,!0),p=new rV(c);return n.runWebGLProgram(p,[r,s],"float32")}},oV=class{constructor(e){this.variableNames=["X"],this.outputShape=[e,e],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "}},lV={kernelName:Ln,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{x:a}=t,r=[...a.shape,...a.shape],s=Ns.sizeFromShape(a.shape),i=PP({inputs:{x:a},backend:n,attrs:{shape:[s]}}),o=new oV(s),l=n.runWebGLProgram(o,[i],i.dtype),u=PP({inputs:{x:l},backend:n,attrs:{shape:r}});return n.disposeIntermediateTensorInfo(i),n.disposeIntermediateTensorInfo(l),u}},uV=class{constructor(e){this.variableNames=["x","W"],this.outputShape=e.outShape;let{inHeight:t,inWidth:n,padInfo:a,strideHeight:r,strideWidth:s,filterHeight:i,filterWidth:o,dilationHeight:l,dilationWidth:u}=e,{top:d,left:c}=a;this.userCode=`\n      const ivec2 strides = ivec2(${r}, ${s});\n      const ivec2 pads = ivec2(${d}, ${c});\n      const float neg_infinity = -3.4e38;\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.w;\n        ivec2 outTopLeftCorner =\n            coords.yz * strides - pads;\n        int hBeg = outTopLeftCorner.x;\n        int wBeg = outTopLeftCorner.y;\n\n        float curVal = neg_infinity;\n        for (int h = 0; h < ${i}; h++) {\n          int hIn = hBeg + h * ${l};\n\n          if (hIn >= 0 && hIn < ${t}) {\n            for (int w = 0; w < ${o}; w++) {\n              int wIn = wBeg + w * ${u};\n\n              if (wIn >= 0 && wIn < ${n}) {\n                float xVal = getX(batch, hIn, wIn, d1);\n                float wVal = getW(h, w, d1);\n\n                float val = xVal + wVal;\n                if (val > curVal) {\n                  curVal = val;\n                }\n              }\n            }\n          }\n        }\n\n        float result = curVal;\n        setOutput(result);\n      }\n    `}},dV={kernelName:zn,backendName:"webgl",kernelFunc:function(e){let t,{inputs:n,backend:a,attrs:r}=e,{x:s,filter:i}=n,{strides:o,pad:l,dilations:u}=r,d=Uf.computeDilation2DInfo(s.shape,i.shape,o,l,"NHWC",u),c=new uV(d);t=a.runWebGLProgram(c,[s,i],"float32");let p=PP({inputs:{x:t},backend:a,attrs:{shape:d.outShape}});return a.disposeIntermediateTensorInfo(t),p}},cV={kernelName:Un,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{equation:r}=a,s=t,{allDims:i,summedDims:o,idDims:l}=Uf.decodeEinsumEquation(r,s.length);Uf.checkEinsumDimSizes(i.length,l,s);let{path:u,steps:d}=Uf.getEinsumComputePath(o,l),c=d.length,p=null,h=i.length,m=[];for(let f=0;f<c;++f){for(let e of d[f]){let t,{permutationIndices:a,expandDims:r}=Uf.getEinsumPermutation(h,l[e]);Uf.isIdentityPermutation(a)?t=s[e]:(t=YP({inputs:{x:s[e]},backend:n,attrs:{perm:a}}),m.push(t));let i=t.shape.slice();for(let e=0;e<r.length;++e)i.splice(r[e],0,1);Ns.arraysEqual(t.shape,i)||(t=PP({inputs:{x:t},backend:n,attrs:{shape:i}}),m.push(t)),null===p?p=t:(p=LP({inputs:{a:t,b:p},backend:n}),m.push(p))}f<c-1&&(u[f]>=0&&(p=KP({inputs:{x:p},backend:n,attrs:{axis:u[f]-(i.length-h),keepDims:!1}}),m.push(p)),h--)}for(let f of m)f!==p&&n.disposeIntermediateTensorInfo(f);return p}},pV=RP({opSnippet:"return (x >= 0.0) ? x : (exp(x) - 1.0);",packedOpSnippet:"\n  vec4 result;\n\n  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);\n  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);\n  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);\n  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);\n\n  return result;\n"}),hV={kernelName:Gn,backendName:"webgl",kernelFunc:pV},mV={kernelName:Hn,backendName:"webgl",kernelFunc:e=>{let{inputs:t,backend:n}=e,{dy:a,y:r}=t,s=Pt().getBool("WEBGL_PACK_BINARY_OPERATIONS")?new wP("\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",a.shape,r.shape):new bP("return (b >= 0.0) ? a : a * (b + 1.0);",a.shape,r.shape);return n.runWebGLProgram(s,[a,r],a.dtype)}},fV=FP({opSnippet:"return float(a == b);",packedOpSnippet:"\n  return vec4(equal(a, b));\n",dtype:"bool",cpuKernelImpl:iz}),gV={kernelName:Kn,backendName:"webgl",kernelFunc:fV},xV=RP({opSnippet:`\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = ${Uf.ERF_P};\n  float a1 = ${Uf.ERF_A1};\n  float a2 = ${Uf.ERF_A2};\n  float a3 = ${Uf.ERF_A3};\n  float a4 = ${Uf.ERF_A4};\n  float a5 = ${Uf.ERF_A5};\n\n  float sign = sign(x);\n  x = abs(x);\n  float t = 1.0 / (1.0 + p * x);\n  return sign * (1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x));\n`}),bV={kernelName:qn,backendName:"webgl",kernelFunc:xV},yV=RP({opSnippet:$P+"\n  return exp(x);\n",packedOpSnippet:"\n  vec4 result = exp(x);\n  bvec4 isNaN = isnan(x);\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",cpuKernelImpl:oz,dtype:"float32"}),wV={kernelName:Xn,backendName:"webgl",kernelFunc:yV};function vV(e){let{inputs:t,attrs:n,backend:a}=e,{dim:r}=n,{input:s}=t,i=s.shape.length,o=s.shape.slice(),l=r;return r<0&&(Ns.assert(-(i+1)<=r,()=>`Axis must be in the interval [${-(i+1)}, ${i}]`),l=i+r+1),o.splice(l,0,1),PP({inputs:{x:s},backend:a,attrs:{shape:o}})}var kV={kernelName:Yn,backendName:"webgl",kernelFunc:vV},NV="return exp(x) - 1.0;",SV=RP({opSnippet:NV,packedOpSnippet:NV,cpuKernelImpl:lz}),IV={kernelName:Zn,backendName:"webgl",kernelFunc:SV},_V=class{constructor(e,t,n){this.variableNames=["real","imag"];let a=t[1];this.outputShape=t;let r,s=n?`2.0 * ${Math.PI}`:`-2.0 * ${Math.PI}`,i=n?`${a}.0`:"1.0";if("real"===e)r="return real * expR - imag * expI;";else{if("imag"!==e)throw new Error(`FFT component must be either "real" or "imag", got ${e}.`);r="return real * expI + imag * expR;"}this.userCode=`\n      const float exponentMultiplier = ${s};\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        ${r}\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float(${a});\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < ${a}; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / ${i};\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    `}};function CV(e,t,n){let a=n.texData.get(e.dataId),r=Ns.sizeFromShape(e.shape),s=e.shape[e.shape.length-1],i=PP({inputs:{x:e},backend:n,attrs:{shape:[r/s,s]}}),o=i.shape,l=new _V("real",o,t),u=new _V("imag",o,t),d=[{dataId:a.complexTensorInfos.real.dataId,dtype:a.complexTensorInfos.real.dtype,shape:o},{dataId:a.complexTensorInfos.imag.dataId,dtype:a.complexTensorInfos.imag.dtype,shape:o}],c=n.runWebGLProgram(l,d,"float32"),p=n.runWebGLProgram(u,d,"float32"),h=NP({inputs:{real:c,imag:p},backend:n});n.disposeIntermediateTensorInfo(c),n.disposeIntermediateTensorInfo(p);let m=PP({inputs:{x:h},backend:n,attrs:{shape:e.shape}});return n.disposeIntermediateTensorInfo(i),n.disposeIntermediateTensorInfo(h),m}var TV={kernelName:Jn,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{input:a}=t;return CV(a,!1,n)}},EV=class{constructor(e,t){this.outputShape=[],this.customUniforms=[{name:"value",type:"float"}],this.variableNames=["x"],this.outputShape=e,this.userCode="\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}};function AV(e){let{backend:t,attrs:n}=e,{shape:a,value:r}=n,{dtype:s}=n;if(s=s||Ns.inferDtype(r),"string"===s){let e=Ns.getArrayFromDType(s,Ns.sizeFromShape(a));return e.fill(r),t.makeTensorInfo(a,s,e)}{let e=new EV(a,r),n=[[r]];return t.runWebGLProgram(e,[],s,n)}}var $V,RV={kernelName:Qn,backendName:"webgl",kernelFunc:AV},FV=class{constructor(e){this.variableNames=["Image"],this.outputShape=[];let t=e[2];this.outputShape=e,this.userCode=`\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int x = coords[2];\n\n          int coordX = ${t} - x - 1;\n          float outputValue;\n          if(coordX >= 0 && coordX < ${t}) {\n            outputValue = getImage(coords[0], coords[1], coordX, coords[3]);\n          } else {\n            outputValue = getImage(coords[0], coords[1], coords[2], coords[3]);\n          }\n          setOutput(outputValue);\n        }\n    `}},DV={kernelName:ea,backendName:"webgl",kernelFunc:({inputs:e,backend:t})=>{let{image:n}=e,a=t,r=new FV(n.shape);return a.runWebGLProgram(r,[n],n.dtype)}},MV="return floor(x);",OV=RP({opSnippet:MV,packedOpSnippet:MV,cpuKernelImpl:uz}),jV={kernelName:ta,backendName:"webgl",kernelFunc:OV},LV=FP({opSnippet:"\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",packedOpSnippet:"\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n",dtype:"int32"}),zV={kernelName:na,backendName:"webgl",kernelFunc:LV},PV=class{constructor(e){this.variableNames=["A"];let t=eL(),[n,a]=e;this.outputShape=e,this.userCode=`\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2(${a}.0, ${n}.0);\n\n        vec4 values = ${t.texture2D}(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    `}},BV=class{constructor(e){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;let t=eL(),[n,a]=e;this.outputShape=e,this.userCode=`\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) /\n                       vec2(${a}.0, ${n}.0);\n            vec4 values = ${t.texture2D}(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        ${t.output} = result;\n      }\n    `}},WV={kernelName:ss,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{pixels:r}=t,{numChannels:s}=a,i="undefined"!=typeof HTMLVideoElement&&r instanceof HTMLVideoElement,o="undefined"!=typeof HTMLImageElement&&r instanceof HTMLImageElement,[l,u]=i?[r.videoWidth,r.videoHeight]:[r.width,r.height],d=[u,l],c=[u,l,s];if(o||i){let e=Pt().getBool("CANVAS2D_WILL_READ_FREQUENTLY_FOR_GPU");(null==$V||e!==VV)&&(VV=e,$V=document.createElement("canvas").getContext("2d",{willReadFrequently:VV})),$V.canvas.width=l,$V.canvas.height=u,$V.drawImage(r,0,0,l,u),r=$V.canvas}let p=n.makeTensorInfo(d,"int32");n.texData.get(p.dataId).usage=GO.PIXELS,n.gpgpu.uploadPixelDataToTexture(n.getTexture(p.dataId),r);let h=Pt().getBool("WEBGL_PACK")?new BV(c):new PV(c),m=n.runWebGLProgram(h,[p],"int32");return n.disposeData(p.dataId),m}},VV=Pt().getBool("CANVAS2D_WILL_READ_FREQUENTLY_FOR_GPU"),UV={kernelName:ls,backendName:"webgl",kernelFunc:function(e){let t,{inputs:n,backend:a,attrs:r}=e,{x:s,filter:i,bias:o,preluActivationWeights:l}=n,{strides:u,pad:d,dataFormat:c,dilations:p,dimRoundingMode:h,activation:m,leakyreluAlpha:f}=r,g=Uf.convertConv2DDataFormat(c),x=Uf.computeConv2DInfo(s.shape,i.shape,u,p,d,h,!1,g),b=[],y=null!=o,w=null!=l,v="leakyrelu"===m,k=()=>{let e=[s,i],t=(e,t)=>{if("NCHW"===t&&1===e.shape.length&&1!==e.shape[0]){let t=PP({inputs:{x:e},backend:a,attrs:{shape:[e.shape[0],1,1]}});return b.push(t),t}return e};if(y&&e.push(t(o,c)),w&&e.push(t(l,c)),v){let t=a.makeTensorInfo([],"float32",Ns.createScalarValue(f,"float32"));e.push(t),b.push(t)}return e};if(1!==x.filterHeight||1!==x.filterWidth||1!==x.dilationHeight||1!==x.dilationWidth||1!==x.strideHeight||1!==x.strideWidth||"SAME"!==x.padInfo.type&&"VALID"!==x.padInfo.type)if(x.strideWidth<=2&&"channelsLast"===g&&Pt().getBool("WEBGL_EXP_CONV")){let e=m?DP(m,!0):null,n=new kW(x,y,e,w,v),r=[[x.padInfo.top,x.padInfo.left],[x.strideHeight,x.strideWidth],[x.dilationHeight,x.dilationWidth],[x.inHeight,x.inWidth]],s=k();t=a.runWebGLProgram(n,s,"float32",r)}else if(Pt().getBool("WEBGL_CONV_IM2COL"))t=_W({x:s,filter:i,convInfo:x,backend:a,bias:o,activation:m,preluActivationWeights:l,leakyreluAlpha:f});else{let e=m?DP(m,!1):null,n=new wW(x,y,e,w,v),r=k();t=a.runWebGLProgram(n,r,"float32")}else t=IW({x:s,filter:i,convInfo:x,backend:a,bias:o,activation:m,preluActivationWeights:l,leakyreluAlpha:f});let N=PP({inputs:{x:t},backend:a,attrs:{shape:x.outShape}});return b.push(t),b.forEach(e=>a.disposeIntermediateTensorInfo(e)),N}},GV={kernelName:us,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s,bias:i,preluActivationWeights:o}=t,{strides:l,pad:u,dilations:d,dimRoundingMode:c,activation:p,leakyreluAlpha:h}=a,m=[],f=d;null==f&&(f=[1,1]),Ns.assert(Uf.eitherStridesOrDilationsAreOne(l,f),()=>`Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides ${l} and dilations '${f}'`);let g,x=Uf.computeConv2DInfo(r.shape,s.shape,l,f,u,c,!0),b=Pt().getBool("WEBGL_PACK_DEPTHWISECONV")&&x.strideWidth<=2&&x.outChannels/x.inChannels===1,y=p?DP(p,b):null,w=[r,s],v=null!=i,k=null!=o,N="leakyrelu"===p;if(v&&w.push(i),k&&w.push(o),N){let e=n.makeTensorInfo([],"float32",Ns.createScalarValue(h,"float32"));w.push(e),m.push(e)}g=b?new tV(x,v,y,k,N):new eV(x,v,y,k,N);let S=[[x.padInfo.top,x.padInfo.left],[x.strideHeight,x.strideWidth],[x.dilationHeight,x.dilationWidth],[x.inHeight,x.inWidth]],I=n.runWebGLProgram(g,w,"float32",S);return m.forEach(e=>n.disposeIntermediateTensorInfo(e)),I}},HV=class{constructor(e,t,n,a){this.sliceDim=e,this.strides=t,this.paramsShape=a,this.variableNames=["x","indices"],this.outputShape=n;let r=fL(n.length),s="\n    int index;";for(let i=0;i<this.sliceDim;i++)s+=`\n          index = round(getIndices(coords[0], ${i}));\n          out_of_bounds = out_of_bounds || index < 0;\n          out_of_bounds = out_of_bounds || index >= ${this.paramsShape[i]};\n          flattenIndex += index * ${this.strides[i]};`;this.userCode=`\n         void main() {\n          ${r} coords = getOutputCoords();\n          int flattenIndex = 0;\n          bool out_of_bounds = false;\n\n          ${s}\n\n          setOutput(out_of_bounds ? 0.0 : getX(flattenIndex, coords[1]));\n        }\n      `}},qV={kernelName:sa,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{params:a,indices:r}=t,s=r.shape,i=s[s.length-1],o=Ns.sizeFromShape(a.shape),[l,u,d,c]=Uf.prepareAndValidate(a,r),p=PP({inputs:{x:r},backend:n,attrs:{shape:[u,i]}}),h=PP({inputs:{x:a},backend:n,attrs:{shape:[Ns.sizeFromShape(a.shape)/d,d]}});if(n.shouldExecuteOnCPU([a,r])||"string"===a.dtype){let e=n.readSync(r.dataId),t=n.bufferSync(a),s=dz(e,t,a.dtype,u,i,d,c,a.shape,o);return n.makeTensorInfo(l,a.dtype,s.values)}let m=new HV(i,c,[u,d],a.shape),f=n.runWebGLProgram(m,[h,p],h.dtype),g=PP({inputs:{x:f},backend:n,attrs:{shape:l}});return n.disposeIntermediateTensorInfo(p),n.disposeIntermediateTensorInfo(h),n.disposeIntermediateTensorInfo(f),g}},KV=class{constructor(e,t){this.variableNames=["A","indices"],this.outputShape=t,this.rank=t.length;let n=fL(this.rank),a=function(e){let t=["resRC.x","resRC.y","resRC.z","resRC.w"],n=[];for(let a=0;a<e.length;a++)2===a?n.push("index"):n.push(`${t[a]}`);return n.join()}(e);this.userCode=`\n      void main() {\n        ${n} resRC = getOutputCoords();\n        int index = int(getIndices(resRC.x, resRC.z));\n        float inBounds = (index >= 0) && (index < ${e[2]}) ? 1.0 : 0.0;\n        setOutput(inBounds * getA(${a}));\n      }\n    `}};function XV(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,indices:s}=t,{axis:i,batchDims:o}=a,l=Ns.parseAxisParam(i,r.shape)[0];if(Pt().get("DEBUG")){let e=n.readSync(s.dataId),t=r.shape[l];for(let n=0;n<e.length;++n){let a=e[n];Ns.assert(a<=t-1&&a>=0,()=>`GatherV2: the index value ${a} is not in [0, ${t-1}]`)}}let u=Uf.segment_util.collectGatherOpShapeInfo(r,s,l,o),d=Ns.sizeFromShape(s.shape),c=[],p=PP({inputs:{x:r},backend:n,attrs:{shape:[u.batchSize,u.outerSize,u.dimSize,u.sliceSize]}}),h=PP({inputs:{x:s},backend:n,attrs:{shape:[u.batchSize,d/u.batchSize]}});c.push(p),c.push(h);let m=[u.batchSize,u.outerSize,d/u.batchSize,u.sliceSize];if(n.shouldExecuteOnCPU([r,s])||"string"===r.dtype){let e=n.bufferSync(h),t=n.bufferSync(p),a=cz(t,e,m);return c.forEach(e=>n.disposeIntermediateTensorInfo(e)),n.makeTensorInfo(u.outputShape,a.dtype,a.values)}let f=new KV(p.shape,m),g=n.runWebGLProgram(f,[p,h],p.dtype);c.push(g);let x=PP({inputs:{x:g},backend:n,attrs:{shape:u.outputShape}});return c.forEach(e=>n.disposeIntermediateTensorInfo(e)),x}var YV={kernelName:ra,backendName:"webgl",kernelFunc:XV},ZV=FP({opSnippet:"return float(a > b);",packedOpSnippet:"\n  return vec4(greaterThan(a, b));\n",cpuKernelImpl:pz,dtype:"bool"}),JV={kernelName:ia,backendName:"webgl",kernelFunc:ZV},QV=FP({opSnippet:"return float(a >= b);",packedOpSnippet:"\n  return vec4(greaterThanEqual(a, b));\n",dtype:"bool",cpuKernelImpl:hz}),eU={kernelName:oa,backendName:"webgl",kernelFunc:QV},tU={kernelName:ua,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{input:a}=t;return CV(a,!0,n)}},nU=RP({opSnippet:"return float(!isnan(x) && !isinf(x));",dtype:"bool"}),aU={kernelName:ca,backendName:"webgl",kernelFunc:nU},rU=RP({opSnippet:"return float(isinf(x));",dtype:"bool"}),sU={kernelName:pa,backendName:"webgl",kernelFunc:rU},iU=RP({opSnippet:"return float(isnan(x));",dtype:"bool"}),oU={kernelName:ha,backendName:"webgl",kernelFunc:iU},lU=FP({opSnippet:"return float(a < b);",packedOpSnippet:"\n  return vec4(lessThan(a, b));\n",cpuKernelImpl:mz,dtype:"bool"}),uU={kernelName:fa,backendName:"webgl",kernelFunc:lU},dU=FP({opSnippet:"return float(a <= b);",packedOpSnippet:"\n  return vec4(lessThanEqual(a, b));\n",cpuKernelImpl:fz,dtype:"bool"}),cU={kernelName:ga,backendName:"webgl",kernelFunc:dU},pU={kernelName:xa,backendName:"webgl",kernelFunc:function(e){let{backend:t,attrs:n}=e,{start:a,stop:r,num:s}=n,i=gz(a,r,s);return t.makeTensorInfo([i.length],"float32",i)}},hU=RP({opSnippet:$P+"\n  return x < 0.0 ? 0./0. : log(x);\n",packedOpSnippet:"\n  vec4 result = log(x);\n  bvec4 isNaN = isnan(x);\n  result.r = isNaN.r ? x.r : (x.r < 0.0 ? 0./0. : result.r);\n  result.g = isNaN.g ? x.g : (x.g < 0.0 ? 0./0. : result.g);\n  result.b = isNaN.b ? x.b : (x.b < 0.0 ? 0./0. : result.b);\n  result.a = isNaN.a ? x.a : (x.a < 0.0 ? 0./0. : result.a);\n  return result;\n",cpuKernelImpl:xz}),mU={kernelName:ba,backendName:"webgl",kernelFunc:hU},fU=RP({opSnippet:$P+"\n  return log(1.0 + x);\n"}),gU={kernelName:ya,backendName:"webgl",kernelFunc:fU},xU=FP({opSnippet:"return float(a >= 1.0 && b >= 1.0);",packedOpSnippet:"\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n",dtype:"bool"}),bU={kernelName:wa,backendName:"webgl",kernelFunc:xU},yU=RP({opSnippet:"return float(!(x >= 1.0));"}),wU={kernelName:va,backendName:"webgl",kernelFunc:yU},vU=FP({opSnippet:"return float(a >= 1.0 || b >= 1.0);",packedOpSnippet:"\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n",dtype:"bool"}),kU={kernelName:ka,backendName:"webgl",kernelFunc:vU},NU=class{constructor(e,t,n,a,r){this.variableNames=["x"],this.outputShape=[];let s=t,i=e[3]-1;this.outputShape=e;let o,l=`float(${n}) + float(${a}) * sum`;o=.5===r?`inversesqrt(${l})`:1===r?`1.0/(${l})`:`exp(log(${l}) * float(-${r}));`,this.userCode=`\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -${s}; j <= ${s}; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  ${i}) {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * ${o};\n        setOutput(val);\n      }\n    `}},SU=class{constructor(e,t,n,a,r){this.variableNames=["x"],this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0;let s=t,i=e[3]-1;this.outputShape=e;let o,l=`float(${n}) + float(${a}) * sum`;o=.5===r?`inversesqrt(${l})`:1===r?`1.0/(${l})`:`exp(log(${l}) * float(-${r}));`,this.userCode=`\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < ${this.outputShape[3]};\n        bool hasNextRow = c < ${this.outputShape[2]};\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - ${s};\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - ${s}; j <= ${s}; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2(${i}));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * ${o};\n        setOutput(result);\n      }\n    `}},IU={kernelName:_a,backendName:"webgl",kernelFunc:e=>{let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{depthRadius:s,bias:i,alpha:o,beta:l}=a,u=Pt().getBool("WEBGL_PACK_NORMALIZATION")?new SU(r.shape,s,i,o,l):new NU(r.shape,s,i,o,l);return n.runWebGLProgram(u,[r],r.dtype)}},_U=class{constructor(e,t,n,a,r){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=e,this.depth=e[3],this.depthRadius=t,this.bias=n,this.alpha=a,this.beta=r,this.userCode=`\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < ${this.depth}; ++d) {\n          int depthBegin = int(max(0.0, float(d - ${t})));\n          int depthEnd = int(min(float(${this.depth}),\n              float(d + ${t} + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = ${this.depth};\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float(${a}) * norm + float(${n});\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float(${a})\n                * float(${r})\n                * getInputImage(b, r, c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * ${r});\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    `}},CU={kernelName:Ca,backendName:"webgl",kernelFunc:e=>{let{inputs:t,backend:n,attrs:a}=e,{x:r,y:s,dy:i}=t,{depthRadius:o,bias:l,alpha:u,beta:d}=a,c=new _U(r.shape,o,l,u,d);return n.runWebGLProgram(c,[r,s,i],r.dtype)}};function TU(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{reductionIndices:s,keepDims:i}=a,o=r.shape.length,l=Ns.parseAxisParam(s,r.shape),u=l,d=Uf.getAxesPermutation(u,o),c=null!=d,p=n.shouldExecuteOnCPU([r]),h=r;if(c){if(p){let e=n.texData.get(h.dataId).values,t=new Array(o);for(let n=0;n<t.length;n++)t[n]=r.shape[d[n]];let a=Hz(e,r.shape,r.dtype,d,t);h=n.makeTensorInfo(t,r.dtype),n.texData.get(h.dataId).values=a}else h=qP(r,d,n);u=Uf.getInnerMostAxes(u.length,o)}Uf.assertAxesAreInnerMostDims("max",u,o);let m,[f,g]=Uf.computeOutAndReduceShapes(h.shape,u),x=f;if(i&&(x=Uf.expandShapeToKeepDim(f,l)),p){let e=n.texData.get(h.dataId).values,t=bz(e,Ns.sizeFromShape(g),x,r.dtype);m=n.makeTensorInfo(x,r.dtype),n.texData.get(m.dataId).values=t}else m=function(e,t,n,a){let r=Ns.sizeFromShape(t),s=PP({inputs:{x:e},attrs:{shape:[Ns.sizeFromShape(e.shape)/r,r]},backend:a}),i=UP(s,e.dtype,"max",a),o=PP({inputs:{x:i},attrs:{shape:n},backend:a});return a.disposeIntermediateTensorInfo(s),a.disposeIntermediateTensorInfo(i),o}(h,g,x,n);return c&&n.disposeIntermediateTensorInfo(h),m}var EU={kernelName:Ea,backendName:"webgl",kernelFunc:TU},AU=FP({opSnippet:xP+"\n  return max(a, b);\n",packedOpSnippet:"\n  vec4 result = vec4(max(a, b));\n  bvec4 isNaNA = isnan(a);\n  bvec4 isNaNB = isnan(b);\n  bvec4 isNaN = bvec4(isNaNA.x || isNaNB.x, isNaNA.y || isNaNB.y, isNaNA.z || isNaNB.z, isNaNA.w || isNaNB.w);\n  "+yP+"\n  return result;\n",cpuKernelImpl:yz}),$U={kernelName:Aa,backendName:"webgl",kernelFunc:AU},RU={kernelName:$a,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t;Jj(r,"maxPool");let{filterSize:s,strides:i,pad:o,dimRoundingMode:l}=a;Ns.assert(Uf.eitherStridesOrDilationsAreOne(i,1),()=>`Error in maxPool: Either strides or dilations must be 1. Got strides ${i} and dilations '1'`);let u=Uf.computePool2DInfo(r.shape,s,i,1,o,l);if(1===u.filterWidth&&1===u.filterHeight&&Ns.arraysEqual(u.inShape,u.outShape))return vP({inputs:{x:r},backend:n});let d=new $B(u,"max",!1);return n.runWebGLProgram(d,[r],r.dtype)}},FU={kernelName:Fa,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{filterSize:s,strides:i,pad:o,dataFormat:l,dimRoundingMode:u}=a,d=Uf.computePool3DInfo(r.shape,s,i,[1,1,1],o,u,l),c=new RB(d,"max",!1);return n.runWebGLProgram(c,[r],r.dtype)}},DU=class{constructor(e){this.variableNames=["dy","maxPos"],this.outputShape=e.inShape;let t=e.strideHeight,n=e.strideWidth,a=e.dilationHeight,r=e.effectiveFilterHeight,s=e.effectiveFilterWidth,i=r-1-e.padInfo.top,o=s-1-e.padInfo.left,l=r*s-1;this.userCode=`\n      const ivec2 pads = ivec2(${i}, ${o});\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < ${r};\n          wR += ${a}) {\n          float dyR = float(dyRCorner + wR) / ${t}.0;\n\n          if (dyR < 0.0 || dyR >= ${e.outHeight}.0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < ${s}; wC++) {\n            float dyC = float(dyCCorner + wC) / ${n}.0;\n\n            if (dyC < 0.0 || dyC >= ${e.outWidth}.0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = ${l} - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * ${s} + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},MU=class{constructor(e){this.variableNames=["dy","maxPos"],this.outputShape=e.inShape;let t=e.strideDepth,n=e.strideHeight,a=e.strideWidth,r=e.dilationDepth,s=e.dilationHeight,i=e.dilationWidth,o=e.effectiveFilterDepth,l=e.effectiveFilterHeight,u=e.effectiveFilterWidth,d=o-1-e.padInfo.front,c=l-1-e.padInfo.top,p=u-1-e.padInfo.left,h=o*l*u-1;this.userCode=`\n      const ivec3 pads = ivec3(${d}, ${c}, ${p});\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < ${o};\n           wD += ${r}) {\n          float dyD = float(dyDCorner + wD) / ${t}.0;\n\n          if (dyD < 0.0 || dyD >= ${e.outDepth}.0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < ${l};\n              wR += ${s}) {\n            float dyR = float(dyRCorner + wR) / ${n}.0;\n\n            if (dyR < 0.0 || dyR >= ${e.outHeight}.0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < ${u};\n                wC += ${i}) {\n              float dyC = float(dyCCorner + wC) / ${a}.0;\n\n              if (dyC < 0.0 || dyC >= ${e.outWidth}.0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = ${h} -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * ${l} * ${u} +\n                  wR * ${u} + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    `}},OU={kernelName:Da,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s}=t,i=s,{filterSize:o,strides:l,pad:u,dimRoundingMode:d}=a,c=Uf.computePool3DInfo(i.shape,o,l,[1,1,1],u,d),p=new RB(c,"max",!0),h=n.runWebGLProgram(p,[i],i.dtype),m=new MU(c),f=n.runWebGLProgram(m,[r,h],i.dtype);return n.disposeIntermediateTensorInfo(h),f}},jU={kernelName:Ra,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s,output:i}=t,o=s;Jj([s,i],"maxPoolGrad");let{filterSize:l,strides:u,pad:d,dimRoundingMode:c}=a,p=Uf.computePool2DInfo(o.shape,l,u,1,d,c),h=new $B(p,"max",!0),m=n.runWebGLProgram(h,[o],o.dtype),f=new DU(p),g=n.runWebGLProgram(f,[r,m],o.dtype);return n.disposeIntermediateTensorInfo(m),g}},LU={kernelName:Ma,backendName:"webgl",kernelFunc:({inputs:e,attrs:t,backend:n})=>{let{x:a}=e,{filterSize:r,strides:s,pad:i,includeBatchInIndex:o}=t,l=n;Ns.assert(4===a.shape.length,()=>`Error in maxPool: input must be rank 4 but got rank ${a.shape.length}.`);let u=[1,1];Ns.assert(Uf.eitherStridesOrDilationsAreOne(s,u),()=>`Error in maxPool: Either strides or dilations must be 1. Got strides ${s} and dilations '${u}'`);let d=Uf.computePool2DInfo(a.shape,r,s,u,i),[c,p]=function(e,t,n,a){let r=new $B(n,"max",!1),s=a.runWebGLProgram(r,[e],"float32");return r=new $B(n,"max",!0,!0,t),[s,a.runWebGLProgram(r,[e],"float32")]}(a,o,d,l);return[c,p]}},zU={kernelName:Oa,backendName:"webgl",kernelFunc:({inputs:e,attrs:t,backend:n})=>{let{x:a}=e,{keepDims:r,axis:s}=t,i=n,o=a.shape.length,l=Ns.parseAxisParam(s,a.shape),u=l,d=Uf.getAxesPermutation(u,o),c=null!=d,p=i.shouldExecuteOnCPU([a]),h=[],m=a;if(c){if(p){let e=i.texData.get(m.dataId).values,t=new Array(o);for(let r=0;r<t.length;r++)t[r]=a.shape[d[r]];let n=Hz(e,a.shape,a.dtype,d,t);m=i.makeTensorInfo(t,a.dtype),i.texData.get(m.dataId).values=n}else m=qP(a,d,i);h.push(m),u=Uf.getInnerMostAxes(u.length,o)}Uf.assertAxesAreInnerMostDims("sum",u,o);let[f,g]=Uf.computeOutAndReduceShapes(m.shape,u),x=f;r&&(x=Uf.expandShapeToKeepDim(f,l));let b=function(e,t,n,a){let r=Ns.sizeFromShape(t),s=PP({inputs:{x:e},attrs:{shape:[Ns.sizeFromShape(e.shape)/r,r]},backend:a}),i=UP(s,"float32","mean",a),o=PP({inputs:{x:i},attrs:{shape:n},backend:a});return a.disposeIntermediateTensorInfo(s),a.disposeIntermediateTensorInfo(i),o}(m,g,x,i);for(let y of h)i.disposeIntermediateTensorInfo(y);return b}},PU={kernelName:ja,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,keepDims:i}=a,o=r.shape.length,l=Ns.parseAxisParam(s,r.shape),u=l,d=Uf.getAxesPermutation(u,o),c=r;null!=d&&(c=YP({inputs:{x:r},backend:n,attrs:{perm:d}}),u=Uf.getInnerMostAxes(u.length,r.shape.length)),Uf.assertAxesAreInnerMostDims("min",u,o);let p,[h,m]=Uf.computeOutAndReduceShapes(c.shape,u),f=PP({inputs:{x:c},backend:n,attrs:{shape:[-1,Ns.sizeFromShape(m)]}}),g=UP(f,f.dtype,"min",n);return p=PP(i?{inputs:{x:g},backend:n,attrs:{shape:Uf.expandShapeToKeepDim(h,l)}}:{inputs:{x:g},backend:n,attrs:{shape:h}}),n.disposeIntermediateTensorInfo(f),n.disposeIntermediateTensorInfo(g),null!=d&&n.disposeIntermediateTensorInfo(c),p}},BU=FP({opSnippet:xP+"\n  return min(a, b);\n",packedOpSnippet:"\n  vec4 result = vec4(min(a, b));\n  bvec4 isNaNA = isnan(a);\n  bvec4 isNaNB = isnan(b);\n  bvec4 isNaN = bvec4(isNaNA.x || isNaNB.x, isNaNA.y || isNaNB.y, isNaNA.z || isNaNB.z, isNaNA.w || isNaNB.w);\n  "+yP+"\n  return result;\n",cpuKernelImpl:wz}),WU={kernelName:La,backendName:"webgl",kernelFunc:BU},VU=class{constructor(e,t,n){this.variableNames=["x"],this.outputShape=t.map((t,n)=>t[0]+e[n]+t[1]);let a=e.length,r=fL(a),s=t.map(e=>e[0]).join(","),i=t.map((t,n)=>t[0]+e[n]).join(","),o=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,a),l="reflect"===n?0:1;this.userCode=1!==a?`\n      ${r} start = ${r}(${s});\n      ${r} end = ${r}(${i});\n\n      void main() {\n        ${r} outC = getOutputCoords();\n        for (int i = 0; i < ${a}; i++) {\n          if (outC[i] < start[i]) {\n            outC[i] = start[i] * 2 - outC[i] - ${l};\n          } else if(outC[i] >= end[i]) {\n            outC[i] = (end[i] - 1) * 2 - outC[i] + ${l};\n          }\n        }\n        ${r} coords = outC - start;\n        setOutput(getX(${o}));\n      }\n    `:`\n        int start = ${s};\n        int end = ${i};\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start) {\n            outC = start * 2 - outC - ${l};\n          } else if(outC >= end) {\n            outC = (end - 1) * 2 - outC + ${l};\n          }\n          setOutput(getX(outC - start));\n        }\n      `}},UU=class{constructor(e,t,n){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=t.map((t,n)=>t[0]+e[n]+t[1]);let a=e.length,r=fL(a),s=t.map(e=>e[0]).join(","),i=t.map((t,n)=>t[0]+e[n]).join(","),o=Xz("rc",a),l=Xz("source",a),u=`${o[a-1]} < ${this.outputShape[a-1]}`,d=1===a?"source":`vec2(${l.slice(-2).join()})`,c="reflect"===n?0:1,p="";if(1===a){let e=`\n        ${r} source = rc;\n        if (source < start) {\n          source = start * 2 - source - ${c};\n        } else if (source >= end) {\n          source = (end - 1) * 2 - source + ${c};\n        }\n        source -= start;\n      `;p=`\n        ${r} rc = outputLoc;\n        ${e}\n        result[0] = getChannel(getX(${l.join()}), ${d});\n        ${o[a-1]} += 1;\n        if(${u}) {\n          ${e}\n          result[1] = getChannel(getX(${l.join()}), ${d});\n        }\n      `}else{let e=`\n        ${r} source = rc;\n        ${r} lt = ${r}(lessThan(source, start));\n        ${r} gte = ${r}(greaterThanEqual(source, end));\n        ${r} orig = 1 - (lt + gte);\n        source = orig * source +\n                lt * (start * 2 - source - ${c}) +\n                gte * ((end - 1) * 2 - source + ${c});\n        source -= start;\n      `;p=`\n        ${r} rc = outputLoc;\n        ${e}\n        result[0] = getChannel(getX(${l.join()}), ${d});\n        ${o[a-1]} += 1;\n        if(${u}) {\n          ${e}\n          result[1] = getChannel(getX(${l.join()}), ${d});\n        }\n        rc = outputLoc;\n        ${o[a-2]} += 1;\n        if(${o[a-2]} < ${this.outputShape[a-2]}) {\n          ${e}\n          result[2] = getChannel(getX(${l.join()}), ${d});\n          ${o[a-1]} += 1;\n          if(${u}) {\n            ${e}\n            result[3] = getChannel(getX(${l.join()}), ${d});\n          }\n        }\n      `}this.userCode=`\n      const ${r} start = ${r}(${s});\n      const ${r} end = ${r}(${i});\n\n      void main() {\n        ${r} outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        ${p}\n        setOutput(result);\n      }\n    `}},GU={kernelName:za,backendName:"webgl",kernelFunc:({inputs:e,backend:t,attrs:n})=>{let{x:a}=e,{paddings:r,mode:s}=n,i=Pt().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new UU(a.shape,r,s):new VU(a.shape,r,s);return t.runWebGLProgram(i,[a],a.dtype)}},HU=FP({opSnippet:"if (b == 0.0) return NAN;\n  return mod(a, b);",packedOpSnippet:"\n  vec4 result = mod(a, b);\n  bvec4 isNaN = equal(b, vec4(0.0));\n  "+yP+"\n  return result;\n"}),qU={kernelName:Pa,backendName:"webgl",kernelFunc:HU},KU=class{constructor(e,t,n){this.variableNames=["probs"],this.customUniforms=[{name:"seed",type:"float"}],this.outputShape=[e,n],this.userCode=`\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < ${t-1}; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float(${t-1}));\n      }\n    `}},XU=FP({opSnippet:"\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",packedOpSnippet:"\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n",checkOutOfBounds:!0}),YU={kernelName:Vn,backendName:"webgl",kernelFunc:XU},ZU="return a - b;",JU=FP({opSnippet:ZU,packedOpSnippet:ZU,supportsComplex:!0,cpuKernelImpl:Vz}),QU={kernelName:Hr,backendName:"webgl",kernelFunc:JU};function eG(e){let{inputs:t,backend:n,attrs:a}=e,{logits:r}=t,{dim:s}=a,i=Ns.parseAxisParam([s],r.shape),o=TU({inputs:{x:r},backend:n,attrs:{reductionIndices:i,keepDims:!1}}),l=Uf.expandShapeToKeepDim(o.shape,i),u=PP({inputs:{x:o},backend:n,attrs:{shape:l}}),d=JU({inputs:{a:r,b:u},backend:n}),c=yV({inputs:{x:d},backend:n}),p=KP({inputs:{x:c},backend:n,attrs:{axis:i,keepDims:!1}}),h=PP({inputs:{x:p},backend:n,attrs:{shape:l}}),m=XU({inputs:{a:c,b:h},backend:n});return n.disposeIntermediateTensorInfo(o),n.disposeIntermediateTensorInfo(u),n.disposeIntermediateTensorInfo(d),n.disposeIntermediateTensorInfo(c),n.disposeIntermediateTensorInfo(p),n.disposeIntermediateTensorInfo(h),m}var tG={kernelName:Fr,backendName:"webgl",kernelFunc:eG},nG={kernelName:Ba,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{logits:r}=t,{numSamples:s,seed:i,normalized:o}=a,l=o?r:eG({inputs:{logits:r},backend:n,attrs:{dim:r.shape.length-1}}),u=l.shape[0],d=l.shape[1],c=new KU(u,d,s),p=[[i]],h=n.runWebGLProgram(c,[l],"int32",p);return o||n.disposeIntermediateTensorInfo(l),h}},aG=aP+"\n  return -x;\n",rG={kernelName:Va,backendName:"webgl",kernelFunc:function(e){let t,{inputs:n,backend:a}=e,{x:r}=n;if(a.shouldExecuteOnCPU([r])){let e=a.texData.get(r.dataId),[t,n]=kz(e.values,r.shape,r.dtype);return a.makeTensorInfo(n,r.dtype,t)}return t=Pt().getBool("WEBGL_PACK_UNARY_OPERATIONS")?new lP(r.shape,"\n  vec4 result = -x;\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n"):new nP(r.shape,aG),a.runWebGLProgram(t,[r],r.dtype)}},sG=Yg.nonMaxSuppressionV3Impl,iG={kernelName:Ga,backendName:"webgl",kernelFunc:function(e){Uf.warn("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");let{inputs:t,backend:n,attrs:a}=e,{boxes:r,scores:s}=t,{maxOutputSize:i,iouThreshold:o,scoreThreshold:l}=a,u=n.readSync(r.dataId),d=n.readSync(s.dataId),{selectedIndices:c}=sG(u,d,i,o,l);return n.makeTensorInfo([c.length],"int32",new Int32Array(c))}},oG=Yg.nonMaxSuppressionV4Impl,lG={kernelName:Ha,backendName:"webgl",kernelFunc:function(e){Uf.warn("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");let{inputs:t,backend:n,attrs:a}=e,{boxes:r,scores:s}=t,{maxOutputSize:i,iouThreshold:o,scoreThreshold:l,padToMaxOutputSize:u}=a,d=n.readSync(r.dataId),c=n.readSync(s.dataId),{selectedIndices:p,validOutputs:h}=oG(d,c,i,o,l,u);return[n.makeTensorInfo([p.length],"int32",new Int32Array(p)),n.makeTensorInfo([],"int32",new Int32Array([h]))]}},uG=Yg.nonMaxSuppressionV5Impl,dG={kernelName:qa,backendName:"webgl",kernelFunc:function(e){Uf.warn("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");let{inputs:t,backend:n,attrs:a}=e,{boxes:r,scores:s}=t,{maxOutputSize:i,iouThreshold:o,scoreThreshold:l,softNmsSigma:u}=a,d=n.readSync(r.dataId),c=n.readSync(s.dataId),p=i,h=o,m=l,f=u,{selectedIndices:g,selectedScores:x}=uG(d,c,p,h,m,f);return[n.makeTensorInfo([g.length],"int32",new Int32Array(g)),n.makeTensorInfo([x.length],"float32",new Float32Array(x))]}},cG=class{constructor(e,t,n,a){this.variableNames=["indices"],this.outputShape=[e,t],this.userCode=`\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float(${a}), float(${n}),\n                      float(index == coords.y)));\n      }\n    `}},pG={kernelName:Xa,backendName:"webgl",kernelFunc:e=>{let{inputs:t,backend:n,attrs:a}=e,{indices:r}=t,{dtype:s,depth:i,onValue:o,offValue:l}=a,u=Ns.sizeFromShape(r.shape),d=new cG(u,i,o,l),c=PP({inputs:{x:r},backend:n,attrs:{shape:[u]}}),p=n.runWebGLProgram(d,[c],s);n.disposeIntermediateTensorInfo(c);let h=PP({inputs:{x:p},backend:n,attrs:{shape:[...r.shape,i]}});return n.disposeIntermediateTensorInfo(p),h}};function hG(e){let{inputs:t,backend:n}=e,{x:a}=t;if("complex64"===a.dtype){let e=eW({inputs:{input:a},backend:n}),t=hG({inputs:{x:e},backend:n}),r=fW({inputs:{input:a},backend:n}),s=hG({inputs:{x:r},backend:n}),i=NP({inputs:{real:t,imag:s},backend:n});return n.disposeIntermediateTensorInfo(e),n.disposeIntermediateTensorInfo(t),n.disposeIntermediateTensorInfo(r),n.disposeIntermediateTensorInfo(s),i}return AV({attrs:{shape:a.shape,dtype:a.dtype,value:"string"===a.dtype?"":0},backend:n})}var mG={kernelName:as,backendName:"webgl",kernelFunc:hG},fG={kernelName:Ka,backendName:"webgl",kernelFunc:function e(t){let{inputs:n,backend:a}=t,{x:r}=n;if("string"===r.dtype)throw new Error("onesLike is not supported under string dtype");if("complex64"===r.dtype){let t=eW({inputs:{input:r},backend:a}),n=e({inputs:{x:t},backend:a}),s=fW({inputs:{input:r},backend:a}),i=hG({inputs:{x:s},backend:a}),o=NP({inputs:{real:n,imag:i},backend:a});return a.disposeIntermediateTensorInfo(t),a.disposeIntermediateTensorInfo(n),a.disposeIntermediateTensorInfo(s),a.disposeIntermediateTensorInfo(i),o}return AV({attrs:{shape:r.shape,dtype:r.dtype,value:1},backend:a})}},gG={kernelName:Ya,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{axis:r}=a;if(1===t.length)return vV({inputs:{input:t[0]},backend:n,attrs:{dim:r}});let s=t[0].shape,i=t[0].dtype;t.forEach(e=>{Ns.assertShapesMatch(s,e.shape,"All tensors passed to stack must have matching shapes"),Ns.assert(i===e.dtype,()=>"All tensors passed to stack must have matching dtypes")});let o=[],l=bW({inputs:t.map(e=>{let t=vV({inputs:{input:e},backend:n,attrs:{dim:r}});return o.push(t),t}),backend:n,attrs:{axis:r}});return o.forEach(e=>n.disposeIntermediateTensorInfo(e)),l}},xG=class{constructor(e,t,n){this.variableNames=["x"],this.customUniforms=[{name:"value",type:"float"}],this.outputShape=t.map((t,n)=>t[0]+e[n]+t[1]);let a=e.length,r=fL(a),s=t.map(e=>e[0]).join(","),i=t.map((t,n)=>t[0]+e[n]).join(","),o=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,a);this.userCode=1!==a?`\n      ${r} start = ${r}(${s});\n      ${r} end = ${r}(${i});\n\n      void main() {\n        ${r} outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(value);\n        } else {\n          ${r} coords = outC - start;\n          setOutput(getX(${o}));\n        }\n      }\n    `:`\n        int start = ${s};\n        int end = ${i};\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(value);\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      `}},bG=class{constructor(e,t,n){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.customUniforms=[{name:"value",type:"float"}],this.outputShape=t.map((t,n)=>t[0]+e[n]+t[1]);let a=e.length,r=fL(a),s=t.map(e=>e[0]).join(","),i=t.map((t,n)=>t[0]+e[n]).join(","),o=Xz("rc",a),l=Xz("source",a),u=`${o[a-1]} < ${this.outputShape[a-1]}`,d=1===a?"source":`vec2(${l.slice(-2).join()})`,c=[`${r} rc = outputLoc;`,`${o[a-1]} += 1;\n       if(${u}) {\n      `,1===a?"":`}\n       rc = outputLoc;\n       ${o[a-2]} += 1;\n       if(${o[a-2]} < ${this.outputShape[a-2]}) {`,1===a?"":`  ${o[a-1]} += 1;\n         if(${u}) {`],p=1===a?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",h="";for(let m=0,f=1===a?2:4;m<f;m++)h+=`\n        ${c[m]}\n        if (${p}) {\n          result[${m}] = float(value);\n        } else {\n          ${r} source = rc - start;\n          result[${m}] = getChannel(getX(${l.join()}), ${d});\n        }\n      `;h+=1===a?"} ":"}}",this.userCode=`\n      const ${r} start = ${r}(${s});\n      const ${r} end = ${r}(${i});\n\n      void main() {\n        ${r} outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        ${h}\n        setOutput(result);\n      }\n    `}},yG=e=>{let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{paddings:s,constantValue:i}=a;if(0===Ns.sizeFromShape(r.shape))return AV({backend:n,attrs:{shape:s.map((e,t)=>e[0]+r.shape[t]+e[1]),value:i,dtype:r.dtype}});let o=Pt().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new bG(r.shape,s,i):new xG(r.shape,s,i),l=[[i]];return n.runWebGLProgram(o,[r],r.dtype,l)},wG={kernelName:Za,backendName:"webgl",kernelFunc:yG},vG=FP({opSnippet:"\n  if(a < 0.0 && floor(b) < b){\n    return NAN;\n  }\n  if (b == 0.0) {\n    return 1.0;\n  }\n  return (round(mod(b, 2.0)) != 1) ?\n      pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",packedOpSnippet:"\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  bvec4 isNaN1 = lessThan(a, vec4(0.0));\n  bvec4 isNaN2 = lessThan(floor(b), b);\n  bvec4 isNaN = bvec4(isNaN1.x && isNaN2.x, isNaN1.y && isNaN2.y, isNaN1.z && isNaN2.z, isNaN1.w && isNaN2.w);\n  "+yP+"\n  return result;\n"}),kG={kernelName:Qa,backendName:"webgl",kernelFunc:vG},NG={kernelName:tr,backendName:"webgl",kernelFunc:function(e){let t,{inputs:n,backend:a,attrs:r}=e,{x:s}=n,{axis:i,keepDims:o}=r,l=s.shape.length,u=[],d=Ns.parseAxisParam(i,s.shape),c=d,p=Uf.getAxesPermutation(c,l),h=s;if(null!=p&&(h=YP({inputs:{x:s},backend:a,attrs:{perm:p}}),c=Uf.getInnerMostAxes(c.length,l),u.push(h)),Uf.assertAxesAreInnerMostDims("prod",c,l),a.shouldExecuteOnCPU([h])){let e=a.texData.get(h.dataId).values,{outVals:n,outShape:r,outDtype:s}=Sz(h.shape,h.dtype,e,c);t=a.makeTensorInfo(r,s,n)}else{let[e,n]=Uf.computeOutAndReduceShapes(h.shape,c),r=Ns.sizeFromShape(n),i=PP({inputs:{x:h},backend:a,attrs:{shape:[-1,r]}}),o=UP(i,fi(s.dtype),"prod",a);t=PP({inputs:{x:o},backend:a,attrs:{shape:e}}),u.push(i),u.push(o)}if(o){u.push(t);let e=Uf.expandShapeToKeepDim(t.shape,d);t=PP({inputs:{x:t},backend:a,attrs:{shape:e}})}return u.forEach(e=>a.disposeIntermediateTensorInfo(e)),t}},SG={kernelName:nr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{paramsNestedSplits:r,paramsDenseValues:s,indices:i}=t,{outputRaggedRank:o}=a,l=r.map(e=>n.readSync(e.dataId)),u=r.map(e=>e.shape),d=n.readSync(s.dataId),c=n.readSync(i.dataId),[p,h,m]=Iz(l,u,d,s.shape,s.dtype,c,i.shape,o),f=p.map(e=>n.makeTensorInfo([e.length],"int32",e)),g=n.makeTensorInfo(m,s.dtype,h);return f.concat([g])}},IG={kernelName:ar,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{starts:a,limits:r,deltas:s}=t,i=n.readSync(a.dataId),o=n.readSync(r.dataId),l=n.readSync(s.dataId),[u,d]=_z(i,a.shape,a.dtype,o,r.shape,l,s.shape);return[n.makeTensorInfo([u.length],"int32",u),n.makeTensorInfo([d.length],a.dtype,d)]}},_G={kernelName:rr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{shape:r,values:s,defaultValue:i,rowPartitionTensors:o}=t,{rowPartitionTypes:l}=a,u=n.readSync(r.dataId),d=n.readSync(s.dataId),c=n.readSync(i.dataId),p=o.map(e=>n.readSync(e.dataId)),h=o.map(e=>e.shape),[m,f]=Cz(u,r.shape,d,s.shape,s.dtype,c,i.shape,p,h,l);return n.makeTensorInfo(m,s.dtype,f)}},CG=e=>{let{backend:t,attrs:n}=e,{start:a,stop:r,step:s,dtype:i}=n,o=Tz(a,r,s,i);return t.makeTensorInfo([o.length],i,o)},TG={kernelName:sr,backendName:"webgl",kernelFunc:CG},EG=RP({opSnippet:"return 1.0 / x;"}),AG={kernelName:or,backendName:"webgl",kernelFunc:EG},$G=RP({opSnippet:aP+"\n  return (x < 0.0) ? 0.0 : x;\n",packedOpSnippet:"\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n"}),RG={kernelName:lr,backendName:"webgl",kernelFunc:$G},FG=RP({opSnippet:aP+"\n  return (x < 0.0) ? 0.0 : min(6.0, x);\n",packedOpSnippet:"\n  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n"}),DG={kernelName:mr,backendName:"webgl",kernelFunc:FG},MG=class{constructor(e,t,n,a,r){this.variableNames=["A"],this.outputShape=[];let[s,i,o,l]=e;this.outputShape=[s,t,n,l];let u,d=[a&&t>1?i-1:i,a&&n>1?o-1:o],c=[a&&t>1?t-1:t,a&&n>1?n-1:n];u=r?"(vec2(yRC) + vec2(0.5)) * effectiveInputOverOutputRatioRC - vec2(0.5)":"vec2(yRC) * effectiveInputOverOutputRatioRC",this.userCode=`\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          ${d[0]/c[0]},\n          ${d[1]/c[1]});\n      const vec2 inputShapeRC = vec2(${i}.0, ${o}.0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = ${u};\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(max(sourceFracIndexRC, vec2(0.0)));\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    `}},OG=class{constructor(e,t,n,a,r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];let[s,i,o,l]=e;this.outputShape=[s,t,n,l];let u,d=[a&&t>1?i-1:i,a&&n>1?o-1:o],c=[a&&t>1?t-1:t,a&&n>1?n-1:n];u=r?"(vec3(yRC) + vec3(0.5)) * effectiveInputOverOutputRatioRC - vec3(0.5)":"vec3(yRC) * effectiveInputOverOutputRatioRC",this.userCode=`\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          ${d[0]/c[0]},\n          ${d[1]/c[1]},\n          ${d[1]/c[1]});\n      const vec3 inputShapeRC = vec3(${i}.0, ${o}.0,\n                                     ${o}.0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = ${u};\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(max(sourceFracIndexRC, vec3(0.0)));\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < ${l-1};\n        bool hasNextRow = coords.z < ${n-1};\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    `}},jG={kernelName:pr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{images:r}=t,{alignCorners:s,halfPixelCenters:i,size:o}=a,[l,u]=o,d=Pt().getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new OG(r.shape,l,u,s,i):new MG(r.shape,l,u,s,i);return n.runWebGLProgram(d,[r],"float32")}},LG=class{constructor(e,t,n){this.variableNames=["dy"],this.outputShape=[],this.outputShape=t;let[,a,r]=t,[,s,i]=e,o=[n&&s>1?a-1:a,n&&i>1?r-1:r],l=[n&&s>1?s-1:s,n&&i>1?i-1:i],u=o[0]/l[0],d=o[1]/l[1],c=1/u,p=1/d,h=2*Math.ceil(c)+2,m=2*Math.ceil(p)+2;this.userCode=`\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float(${u});\n        const float widthScale = float(${d});\n\n        const float invHeightScale = float(${c});\n        const float invWidthScale = float(${p});\n\n        const int winHeight = int(${h});\n        const int winWidth = int(${m});\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= ${s}) {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= ${i}) {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), ${a-1}.0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), ${r-1}.0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    `}},zG={kernelName:hr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{images:r,dy:s}=t,{alignCorners:i}=a,o=new LG(s.shape,r.shape,i);return n.runWebGLProgram(o,[s],s.dtype)}},PG=class{constructor(e,t,n,a,r){this.variableNames=["A"],this.outputShape=[];let[s,i,o,l]=e;this.outputShape=[s,t,n,l];let u,d=[a&&t>1?i-1:i,a&&n>1?o-1:o],c=[a&&t>1?t-1:t,a&&n>1?n-1:n],p=a?"0.5":"0.0";u=r?"max((vec2(yRC) + vec2(0.5)) * effectiveInputOverOutputRatioRC, vec2(0.0))":"vec2(yRC) * effectiveInputOverOutputRatioRC",this.userCode=`\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          ${d[0]/c[0]},\n          ${d[1]/c[1]});\n      const vec2 inputShapeRC = vec2(${i}.0, ${o}.0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = ${u};\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + ${p})));\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    `}},BG=class{constructor(e,t,n,a,r){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];let[s,i,o,l]=e;this.outputShape=[s,t,n,l];let u,d=[a&&t>1?i-1:i,a&&n>1?o-1:o],c=[a&&t>1?t-1:t,a&&n>1?n-1:n],p=a?"0.5":"0.0";u=r?"max((vec3(yRC) + vec3(0.5)) * effectiveInputOverOutputRatioRC, vec3(0.0))":"vec3(yRC) * effectiveInputOverOutputRatioRC",this.userCode=`\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          ${d[0]/c[0]},\n          ${d[1]/c[1]},\n          ${d[1]/c[1]});\n      const vec3 inputShapeRC = vec3(${i}.0, ${o}.0,\n                                     ${o}.0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = ${u};\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec3 sourceNearestRC = ivec3(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + ${p})));\n\n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < ${l-1};\n        bool hasNextRow = coords.z < ${n-1};\n\n        vec4 newValue = vec4(\n          getAValue(b, sourceNearestRC.x, sourceNearestRC.y, d),\n          hasNextCol ? getAValue(b, sourceNearestRC.x, sourceNearestRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceNearestRC.x, sourceNearestRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceNearestRC.x, sourceNearestRC.z, d + 1) : 0.0);\n\n        setOutput(newValue);\n      }\n    `}},WG={kernelName:dr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{images:r}=t,{alignCorners:s,halfPixelCenters:i,size:o}=a,[l,u]=o,d=Pt().getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new BG(r.shape,l,u,s,i):new PG(r.shape,l,u,s,i);return n.runWebGLProgram(d,[r],r.dtype)}},VG=class{constructor(e,t,n){this.variableNames=["dy"],this.outputShape=[],this.outputShape=t;let[,a,r]=t,[,s,i]=e,o=[n&&s>1?a-1:a,n&&i>1?r-1:r],l=[n&&s>1?s-1:s,n&&i>1?i-1:i],u=o[0]/l[0],d=o[1]/l[1],c=1/u,p=1/d,h=2*Math.ceil(c)+2,m=2*Math.ceil(p)+2;this.userCode=`\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float(${u});\n        const float widthScale = float(${d});\n\n        const float invHeightScale = float(${c});\n        const float invWidthScale = float(${p});\n\n        const int winHeight = int(${h});\n        const int winWidth = int(${m});\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= ${s}) {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= ${i}) {\n              continue;\n            }\n\n            float sourceFracRow =\n              float(${o[0]}) *\n                (float(dyR) / float(${l[0]}));\n\n            float sourceFracCol =\n                float(${o[1]}) *\n                  (float(dyC) / float(${l[1]}));\n\n            int sourceNearestRow = int(min(\n                float(int(${a}) - 1),\n                ${n} ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int(${r}) - 1),\n                ${n} ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    `}},UG={kernelName:cr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{images:r,dy:s}=t,{alignCorners:i}=a,o=new VG(s.shape,r.shape,i);return n.runWebGLProgram(o,[s],s.dtype)}},GG=class{constructor(e,t){this.variableNames=["x"];let n=e.length;if(n>4)throw new Error(`WebGL backend: Reverse of rank-${n} tensor is not yet supported`);if(this.outputShape=e,1===n)return void(this.userCode=`\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX(${e[0]} - coord - 1));\n        }\n      `);let a=e.map((n,a)=>(n=>-1!==t.indexOf(n)&&1!==e[n]?`${e[n]} - coords[${n}] - 1`:`coords[${n}]`)(a)).join(","),r=fL(n);this.userCode=`\n      void main() {\n        ${r} coords = getOutputCoords();\n        setOutput(getX(${a}));\n      }\n    `}},HG=class{constructor(e,t){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0;let n=e.length;if(n>4)throw new Error(`WebGL backend: Reverse of rank-${n} tensor is not yet supported`);this.outputShape=e;let a=Xz("rc",n),r=`${a[n-1]} + 1 < ${this.outputShape[n-1]}`,s=`${a[n-2]} + 1 < ${this.outputShape[n-2]}`,i=fL(n);var o;function l(n){let a=e.map((a,r)=>function(n,a){return-1!==t.indexOf(n)&&1!==e[n]?`${e[n]} - ${a[n]} - 1`:`${a[n]}`}(r,n));return`getChannel(getX(${a.join(",")}), vec2(${a.slice(-2).join(",")}))`}this.userCode=1===n?`\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX(${e[0]} - rc - 1),\n            ${e[0]} - rc - 1);\n          if(${r}){\n              result.g = getChannel(getX(${e[0]} - (rc  + 1) - 1),\n                ${e[0]} - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      `:`\n        void main() {\n          ${i} rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = ${o=a.slice(),l(o)};\n          if(${r}){\n            result.g = ${function(e){return e[n-1]="("+e[n-1]+" + 1)",l(e)}(a.slice())};\n          }\n          if(${s}) {\n            result.b = ${function(e){return e[n-2]="("+e[n-2]+" + 1)",l(e)}(a.slice())};\n            if(${r}) {\n              result.a = ${function(e){return e[n-1]="("+e[n-1]+" + 1)",e[n-2]="("+e[n-2]+" + 1)",l(e)}(a.slice())};\n            }\n          }\n          setOutput(result);\n        }\n    `}},qG={kernelName:fr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{dims:s}=a,i=r.shape.length,o=Ns.parseAxisParam(s,r.shape);if(0===i)return vP({inputs:{x:r},backend:n});let l=Pt().getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new HG(r.shape,o):new GG(r.shape,o);return n.runWebGLProgram(l,[r],r.dtype)}},KG=class{constructor(e,t){this.variableNames=["Image"],this.outputShape=[],this.customUniforms=[{name:"params",type:"vec4"}];let n=e[1],a=e[2];this.outputShape=e;let r="";r="number"==typeof t?`float outputValue = ${t.toFixed(2)};`:`\n        vec3 fill = vec3(${t.join(",")});\n        float outputValue = fill[coords[3]];`,this.userCode=`\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int x = coords[2];\n          int y = coords[1];\n          float coordXFloat = (float(x) - params[0]) * params[3] -\n            (float(y) - params[1]) * params[2];\n          float coordYFloat = (float(x) - params[0]) * params[2] +\n            (float(y) - params[1]) * params[3];\n          int coordX = int(round(coordXFloat + params[0]));\n          int coordY = int(round(coordYFloat + params[1]));\n          ${r}\n          if(coordX >= 0 && coordX < ${a} && coordY >= 0 && coordY < ${n}) {\n            outputValue = getImage(coords[0], coordY, coordX, coords[3]);\n          }\n          setOutput(outputValue);\n        }\n    `}},XG={kernelName:is,backendName:"webgl",kernelFunc:({inputs:e,attrs:t,backend:n})=>{let{image:a}=e,{radians:r,fillValue:s,center:i}=t,o=n,l=new KG(a.shape,s),[u,d]=Uf.getImageCenter(i,a.shape[1],a.shape[2]),c=[[u,d,Math.sin(r),Math.cos(r)]];return o.runWebGLProgram(l,[a],a.dtype,c)}},YG=RP({opSnippet:"\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n"}),ZG={kernelName:gr,backendName:"webgl",kernelFunc:YG},JG=RP({opSnippet:"return inversesqrt(x);",cpuKernelImpl:Ez}),QG={kernelName:xr,backendName:"webgl",kernelFunc:JG},eH=class{constructor(e,t,n,a,r,s,i=!0,o=!1){this.variableNames=["updates","indices","defaultValue"],this.outputShape=s;let l=fL(r.length),u=fL(s.length),d="";1===n?d="i":2===n&&(d="i, j");let c=`getIndices(${d})`,p="";1===a?p="i":2===a&&(p="i, coords[1]");let h=`getUpdates(${p})`,m="";o&&(m="coords[0], coords[1]");let f=`getDefaultValue(${m})`,g=t>1?"strides[j]":"strides";this.userCode=`\n        ${l} strides = ${l}(${r});\n\n        void main() {\n          ${u} coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < ${e}; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < ${t}; j++) {\n              int index = round(${c});\n              flattenedIndex += index * ${g};\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += ${h};\n              found = true;\n            }\n          }\n          setOutput(mix(${f}, sum, float(found)));\n        }\n      `}},tH=class{constructor(e,t,n,a,r,s,i=!0,o=!1){this.variableNames=["updates","indices","defaultValue"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=s;let l=fL(r.length),u=fL(s.length),d="";1===n?d="i":2===n&&(d="i, j");let c=`getIndices(${d})`,p="";1===a?p="i":2===a&&(p="i, coords[1]");let h=`getUpdates(${p})`,m="";o&&(m="coords[0], coords[1]");let f=`getDefaultValue(${m})`,g=t>1?"strides[j]":"strides",x=t>1?"strides[j + 1]":"strides";this.userCode=`\n        ${l} strides = ${l}(${r});\n\n        void main() {\n          ${u} coords = getOutputCoords();\n          vec4 sum = vec4(0.);\n          vec4 found = vec4(0.);\n          for (int i = 0; i < ${e}; i+=2) {\n            ivec2 flattenedIndex = ivec2(0);\n            for (int j = 0; j < ${t}; j+=2) {\n              ivec4 index = round(${c});\n              flattenedIndex += index.xz * ${g};\n              if (j + 1 < ${t}) {\n                flattenedIndex += index.yw * ${x};\n              }\n            }\n            if (flattenedIndex[0] == coords[0] || flattenedIndex[1] == coords[0] ||\n                flattenedIndex[0] == coords[0] + 1 || flattenedIndex[1] == coords[0] + 1) {\n              vec4 updVals = ${h};\n              if (flattenedIndex[0] == coords[0]) {\n                sum.xy += updVals.xy;\n                found.xy = vec2(1.);\n              } else if (flattenedIndex[0] == coords[0] + 1) {\n                sum.zw += updVals.xy;\n                found.zw = vec2(1.);\n              }\n              if (flattenedIndex[1] == coords[0]) {\n                sum.xy += updVals.zw;\n                found.xy = vec2(1.);\n              } else if (flattenedIndex[1] == coords[0] + 1) {\n                sum.zw += updVals.zw;\n                found.zw = vec2(1.);\n              }\n            }\n          }\n          setOutput(mix(${f}, sum, found));\n        }\n      `}},nH={kernelName:br,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{indices:r,updates:s}=t,{shape:i}=a,{sliceRank:o,numUpdates:l,sliceSize:u,strides:d,outputSize:c}=Uf.calculateShapes(s,r,i),p=[c/u,u];if(0===c)return n.makeTensorInfo(i,r.dtype);let h,m=PP({inputs:{x:r},backend:n,attrs:{shape:[l,o]}}),f=PP({inputs:{x:s},backend:n,attrs:{shape:[l,u]}}),g=n.makeTensorInfo([],"float32",new Float32Array([0]));h=Pt().getBool("WEBGL_PACK")?new tH(l,o,m.shape.length,f.shape.length,d,p):new eH(l,o,m.shape.length,f.shape.length,d,p);let x=n.runWebGLProgram(h,[f,m,g],f.dtype),b=PP({inputs:{x:x},backend:n,attrs:{shape:i}});return n.disposeIntermediateTensorInfo(m),n.disposeIntermediateTensorInfo(f),n.disposeIntermediateTensorInfo(x),n.disposeIntermediateTensorInfo(g),b}},aH=class{constructor(e,t,n,a){this.variableNames=["sortedSequence","values"],this.customUniforms=[{name:"numInputs",type:"int"}],this.outputShape=[e,n];let r=`for (int i = 0; i < ${Math.ceil(Math.log2(t+1))}; ++i) { if (left >= right) break;`,s=2===Pt().getNumber("WEBGL_VERSION")?"while (left < right) {":r,i="left"===a?"<":"<=";this.userCode=`\n       int findBound(int batch, float value) {\n         int left = 0;\n         int right = numInputs;\n         int mid;\n         ${s}\n           mid = (left + right) / 2;\n           if (getSortedSequence(batch, mid) ${i} value) {\n             left = mid + 1;\n           } else {\n             right = mid;\n           }\n         }\n         return right;\n       }\n\n       void main() {\n         ivec2 coords = getOutputCoords();\n         int batch = coords[0];\n         int valueIndex = coords[1];\n\n         float value = getValues(batch, valueIndex);\n\n         setOutput(float(findBound(batch, value)));\n       }\n     `}},rH={kernelName:wr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{sortedSequence:r,values:s}=t,{side:i}=a,o=new aH(r.shape[0],r.shape[1],s.shape[1],i),l=[[r.shape[1]]];return n.runWebGLProgram(o,[r,s],"int32",l)}},sH=class{constructor(e,t,n){let a,r;if(this.variableNames=["c","a","b"],this.outputShape=t,n>4)throw Error(`Where for rank ${n} is not yet supported`);if(1===n)r="resRC",a="resRC";else{let n=["resRC.x","resRC.y","resRC.z","resRC.w"],s=[],i=[];for(let a=0;a<t.length;a++)i.push(`${n[a]}`),a<e&&s.push(`${n[a]}`);a=s.join(),r=i.join()}let s=fL(n);this.userCode=`\n      void main() {\n        ${s} resRC = getOutputCoords();\n        float cVal = getC(${a});\n        if (cVal >= 1.0) {\n          setOutput(getA(${r}));\n        } else {\n          setOutput(getB(${r}));\n        }\n      }\n    `}},iH={kernelName:vr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{condition:a,t:r,e:s}=t,i=new sH(a.shape.length,r.shape,r.shape.length);return n.runWebGLProgram(i,[a,r,s],mi(r.dtype,s.dtype))}},oH=RP({opSnippet:`\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = ${Uf.SELU_SCALEALPHA};\n  float scale = ${Uf.SELU_SCALE};\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n`}),lH={kernelName:kr,backendName:"webgl",kernelFunc:oH},uH=RP({opSnippet:$P+"\n  return 1.0 / (1.0 + exp(-1.0 * x));\n",packedOpSnippet:"\n  vec4 result = 1.0 / (1.0 + exp(-1.0 * x));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",cpuKernelImpl:$z}),dH={kernelName:Cr,backendName:"webgl",kernelFunc:uH},cH=RP({opSnippet:"\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n"}),pH={kernelName:_r,backendName:"webgl",kernelFunc:cH},hH=RP({opSnippet:$P+"\n  return sin(x);\n",packedOpSnippet:`\n  vec4 result = sin(x);\n  bvec4 isNaN = isnan(x);\n  ${yP}\n  return result;\n`}),mH={kernelName:Sr,backendName:"webgl",kernelFunc:hH},fH=RP({opSnippet:"\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n"}),gH={kernelName:Ir,backendName:"webgl",kernelFunc:fH},xH=RP({opSnippet:"\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n"}),bH={kernelName:Tr,backendName:"webgl",kernelFunc:xH},yH={kernelName:$r,backendName:"webgl",kernelFunc:e=>{let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{blockShape:s,paddings:i}=a;Ns.assert(r.shape.length<=4,()=>"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet");let o=s.reduce((e,t)=>e*t),l=[[0,0]];l.push(...i);for(let x=1+s.length;x<r.shape.length;++x)l.push([0,0]);let u=[],d=yG({inputs:{x:r},backend:n,attrs:{paddings:l,constantValue:0}}),c=Uf.getReshaped(d.shape,s,o,!1),p=Uf.getPermuted(c.length,s.length,!1),h=Uf.getReshapedPermuted(d.shape,s,o,!1),m=PP({inputs:{x:d},backend:n,attrs:{shape:c}}),f=YP({inputs:{x:m},backend:n,attrs:{perm:p}}),g=PP({inputs:{x:f},backend:n,attrs:{shape:h}});return u.push(d),u.push(m),u.push(f),u.forEach(e=>n.disposeIntermediateTensorInfo(e)),g}},wH={kernelName:Dr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{indices:a,values:r,denseShape:s,defaultValue:i}=t;if(1!==s.shape.length)throw new Error(`Dense shape must be a vector, saw:\n         ${s.shape}`);if(2!==a.shape.length)throw new Error(`Indices must be a matrix, saw:\n         ${a.shape}`);if(1!==r.shape.length)throw new Error(`Values must be a vector, saw:\n         ${r.shape}`);if(0!==i.shape.length)throw new Error(`Default value must be a scalar, saw:\n        ${i.shape}`);let o=n.readSync(a.dataId),l=n.readSync(r.dataId),u=n.readSync(s.dataId),d=n.readSync(i.dataId)[0],[c,p,h,m,f]=Dz(o,a.shape,a.dtype,l,r.dtype,u,d);return[n.makeTensorInfo(p,a.dtype,c),n.makeTensorInfo([p[0]],r.dtype,h),n.makeTensorInfo([m.length],"bool",new Uint8Array(m.map(e=>Number(e)))),n.makeTensorInfo([f.length],a.dtype,new Int32Array(f))]}},vH={kernelName:Mr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{inputIndices:a,inputShape:r,newShape:s}=t;if(2!==a.shape.length)throw new Error(`Input indices should be a matrix but received shape ${a.shape}`);if(1!==r.shape.length)throw new Error(`Input shape should be a vector but received shape ${r.shape}`);if(1!==s.shape.length)throw new Error(`Target shape should be a vector but received shape ${s.shape}`);let i=Array.from(n.readSync(r.dataId)),o=n.readSync(a.dataId),l=Array.from(n.readSync(s.dataId)),[u,d,c]=Mz(o,a.shape,a.dtype,i,l);return[n.makeTensorInfo(d,a.dtype,u),n.makeTensorInfo([c.length],s.dtype,new Int32Array(c))]}},kH={kernelName:Or,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{data:a,indices:r,segmentIds:s}=t;if(a.shape.length<1)throw new Error("Data should be at least 1 dimensional but received scalar");if(1!==r.shape.length)throw new Error(`Indices should be a vector but received shape\n              ${r.shape}`);if(1!==s.shape.length)throw new Error(`Segment ids should be a vector but received shape\n              ${s.shape}`);let i=n.readSync(a.dataId),o=n.readSync(r.dataId),l=n.readSync(s.dataId),[u,d]=Oz(i,a.shape,a.dtype,o,l,!0);return n.makeTensorInfo(d,a.dtype,u)}},NH={kernelName:jr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n}=e,{data:a,indices:r,segmentIds:s}=t;if(a.shape.length<1)throw new Error("Data should be at least 1 dimensional but received scalar");if(1!==r.shape.length)throw new Error(`Indices should be a vector but received shape\n             ${r.shape}`);if(1!==s.shape.length)throw new Error(`Segment ids should be a vector but received shape\n             ${s.shape}`);let i=n.readSync(a.dataId),o=n.readSync(r.dataId),l=n.readSync(s.dataId),[u,d]=Oz(i,a.shape,a.dtype,o,l);return n.makeTensorInfo(d,a.dtype,u)}},SH={kernelName:Lr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{sparseIndices:r,sparseValues:s,defaultValue:i}=t,{outputShape:o}=a,{sliceRank:l,numUpdates:u,sliceSize:d,strides:c,outputSize:p}=Uf.calculateShapes(s,r,o),h=!1;if("string"===s.dtype){let e=n.bufferSync(r),t=n.bufferSync(s),a=Ns.decodeString(n.readSync(i.dataId)[0]),m=Az(e,t,o,p,d,u,l,c,a,h);return n.makeTensorInfo(o,m.dtype,m.values)}let m=new eH(u,l,r.shape.length,s.shape.length,c,[p,1],h),f=n.runWebGLProgram(m,[s,r,i],s.dtype),g=PP({inputs:{x:f},backend:n,attrs:{shape:o}});return n.disposeIntermediateTensorInfo(f),g}},IH={kernelName:Rr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{numOrSizeSplits:s,axis:i}=a,o=Ns.parseAxisParam(i,r.shape)[0],l=Uf.prepareSplitSize(r,s,o),u=r.shape.length,d=new Array(u).fill(0),c=r.shape.slice();return l.map(e=>{let t=[...c];t[o]=e;let a=HB({inputs:{x:r},backend:n,attrs:{begin:d,size:t}});return d[o]+=e,a})}},_H="return sqrt(x);",CH=RP({opSnippet:_H,packedOpSnippet:_H,cpuKernelImpl:jz}),TH={kernelName:Er,backendName:"webgl",kernelFunc:CH},EH=RP({opSnippet:"return x * x;"}),AH={kernelName:Pr,backendName:"webgl",kernelFunc:EH},$H="return (a - b) * (a - b);",RH=FP({opSnippet:$H,packedOpSnippet:$H}),FH={kernelName:zr,backendName:"webgl",kernelFunc:RH},DH={kernelName:Br,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t;if("string"!==r.dtype)throw new Error("Input must be of datatype string");let s=n.readSync(r.dataId),i=Uf.fromUint8ToStringArray(s),o=Lz(i,"string",a);return n.makeTensorInfo(r.shape,"string",o)}},MH={kernelName:rs,backendName:"webgl",kernelFunc:function({inputs:e,attrs:t,backend:n}){let{x:a}=e,r=aP+`\n    return x > 0.0 ? 1.0 : float(${t.alpha});\n  `,s=new nP(a.shape,r);return n.runWebGLProgram(s,[a],a.dtype)}},OH=class{constructor(e,t,n){this.variableNames=["x"],this.outputShape=n;let a=n.length,r=fL(n.length),s=fL(n.length),i="";if(1===a)i="coords * strides + begin";else{let e=0;i=n.map((t,a)=>(e++,1===n.length?`coords * strides[${a}] + begin[${a}]`:`coords[${e-1}] * strides[${a}] + begin[${a}]`)).join(",")}this.userCode=`\n      ${r} begin = ${r}(${e});\n      ${r} strides = ${r}(${t});\n\n      void main() {\n        ${s} coords = getOutputCoords();\n        setOutput(getX(${i}));\n      }\n    `}},jH={kernelName:Wr,backendName:"webgl",kernelFunc:function(e){let t,{inputs:n,backend:a,attrs:r}=e,{x:s}=n,{begin:i,end:o,strides:l,beginMask:u,endMask:d,ellipsisMask:c,newAxisMask:p,shrinkAxisMask:h}=r,{finalShapeSparse:m,finalShape:f,isIdentity:g,sliceDim0:x,isSimpleSlice:b,begin:y,end:w,strides:v}=bf.sliceInfo(s.shape,i,o,l,u,d,c,p,h);if(g)t=PP({inputs:{x:s},backend:a,attrs:{shape:f}});else if(x||b){Ns.assert(s.shape.length>=1,()=>`Input must have rank at least 1, got: ${s.shape.length}`);let e=bf.computeOutShape(y,w,v),n=HB({inputs:{x:s},backend:a,attrs:{begin:y,size:e}});t=PP({inputs:{x:n},backend:a,attrs:{shape:f}}),a.disposeIntermediateTensorInfo(n)}else if(a.shouldExecuteOnCPU([s])){let e=a.readSync(s.dataId),n=cl(s.shape,s.dtype,e),r=zz(m,n,v,y);t=a.makeTensorInfo(f,s.dtype,r.values)}else{let e=new OH(y,v,m);t=a.runWebGLProgram(e,[s],s.dtype)}let k=PP({inputs:{x:t},backend:a,attrs:{shape:f}});return a.disposeIntermediateTensorInfo(t),k}},LH={kernelName:Vr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{separator:r,nGramWidths:s,leftPad:i,rightPad:o,padWidth:l,preserveShortSequences:u}=a,{data:d,dataSplits:c}=t,p=n.readSync(d.dataId),h=n.readSync(c.dataId),[m,f]=Pz(p,h,r,s,i,o,l,u);return[n.makeTensorInfo([m.length],"string",m),n.makeTensorInfo(c.shape,"int32",f)]}},zH={kernelName:Ur,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{skipEmpty:r}=a,{input:s,delimiter:i}=t;if("string"!==s.dtype)throw new Error("Input must be of datatype string");if(1!==s.shape.length)throw new Error(`Input must be a vector, got shape: ${s.shape}`);if(0!==i.shape.length)throw new Error(`Delimiter must be a scalar, got shape: ${i.shape}`);let o=n.readSync(s.dataId),l=n.readSync(i.dataId)[0],[u,d,c]=Bz(o,l,r),p=d.length;return[n.makeTensorInfo([p,2],"int32",u),n.makeTensorInfo([p],"string",d),n.makeTensorInfo([2],"int32",new Int32Array(c))]}},PH={kernelName:Gr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{numBuckets:r}=a,{input:s}=t;if("string"!==s.dtype)throw new Error("Input must be of datatype string");if(r<=0)throw new Error("Number of buckets must be at least 1");let i=n.readSync(s.dataId),o=Wz(i,r);return n.makeTensorInfo(s.shape,"int32",o)}},BH=RP({opSnippet:"return tan(x);"}),WH={kernelName:qr,backendName:"webgl",kernelFunc:BH},VH=RP({opSnippet:"\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n"}),UH={kernelName:Kr,backendName:"webgl",kernelFunc:VH},GH={kernelName:yr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{tensor:r,indices:s,updates:i}=t,{sliceRank:o,numUpdates:l,sliceSize:u,strides:d,outputSize:c}=Uf.calculateShapes(i,s,r.shape),p=[c/u,u];if(0===c)return n.makeTensorInfo(r.shape,s.dtype);let h=PP({inputs:{x:s},backend:n,attrs:{shape:[l,o]}}),m=PP({inputs:{x:i},backend:n,attrs:{shape:[l,u]}}),f=PP({inputs:{x:r},backend:n,attrs:{shape:p}}),g=new eH(l,o,h.shape.length,m.shape.length,d,p,!1,!0),x=n.runWebGLProgram(g,[m,h,f],f.dtype),b=PP({inputs:{x:x},backend:n,attrs:{shape:r.shape}});return n.disposeIntermediateTensorInfo(h),n.disposeIntermediateTensorInfo(m),n.disposeIntermediateTensorInfo(f),n.disposeIntermediateTensorInfo(x),b}},HH=class{constructor(e,t){this.variableNames=["A"];let n=new Array(e.length);for(let s=0;s<n.length;s++)n[s]=e[s]*t[s];this.outputShape=n,this.rank=n.length;let a=fL(this.rank),r=function(e){let t=e.length;if(t>5)throw Error(`Tile for rank ${t} is not yet supported`);if(1===t)return`imod(resRC, ${e[0]})`;let n=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],a=[];for(let r=0;r<e.length;r++)a.push(`imod(${n[r]}, ${e[r]})`);return a.join()}(e);this.userCode=`\n      void main() {\n        ${a} resRC = getOutputCoords();\n        setOutput(getA(${r}));\n      }\n    `}};function qH(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{reps:s}=a;if("string"===r.dtype||r.shape.length>5){let e=n.readSync(r.dataId),t="string"===r.dtype?e.map(e=>Ns.decodeString(e)):e,a=cl(r.shape,r.dtype,t),i=Uz(a,s);return n.makeTensorInfo(i.shape,i.dtype,i.values)}let i=new HH(r.shape,s);return n.runWebGLProgram(i,[r],r.dtype)}var KH={kernelName:Xr,backendName:"webgl",kernelFunc:qH},XH=class{constructor(e){this.variableNames=["x","indices"],this.customUniforms=[{name:"n",type:"int"},{name:"firstPass",type:"int"},{name:"negativeInf",type:"float"},{name:"dir",type:"int"},{name:"inc",type:"int"}],this.outputShape=e,this.userCode="\n       void main() {\n         ivec2 coords = getOutputCoords();\n         int batch = coords[0];\n         int elemIdx = coords[1];\n\n         // We compare elements pair-wise within a group of size 2 * inc.\n         // The comparing rule for each group alternates between ascending\n         // and descending. Within each group, we compare each pair at\n         // positions i and i+inc. To decide whether an element at position i\n         // is x0 or x1, we mod it by 2 * inc, if the result is smaller than\n         // inc, it is in the first half of the group, we denote it as x0,\n         // otherwise we denote it as x1.\n         // For example, as shown in the Bitonic top K paper referenced above,\n         // Figure5(a) shows that element[1] is in the\n         // second half of the group when group size is 2, but it is in the\n         // first half of the group when group size is 4.\n\n         bool isFirstInPair = imod(elemIdx, 2 * inc) < inc;\n         int i = isFirstInPair ? elemIdx : elemIdx - inc;\n\n         int i0 = firstPass == 1 ? i : int(getIndices(batch, i));\n         int i1 = firstPass == 1 ? i + inc : int(getIndices(batch, i + inc));\n         float x0 = i0 < n ? getX(batch, i0) : negativeInf;\n         float x1 = i1 < n ? getX(batch, i1) : negativeInf;\n\n         // Denotes which direction indices are in (ascending or descending).\n         bool reverse = imod(elemIdx, 2 * dir) >= dir;\n         bool isGreater = x0 > x1 || (x0 == x1 && i1 > i0);\n         if (reverse == isGreater) { // Elements in opposite order of direction\n           int iTemp = i0;\n           i0 = i1;\n           i1 = iTemp;\n         }\n         if (isFirstInPair) {\n            setOutput(float(i0));\n         } else {\n            setOutput(float(i1));\n         }\n       }\n     "}},YH=class{constructor(e){this.variableNames=["x","indices"],this.customUniforms=[{name:"n",type:"int"},{name:"firstPass",type:"int"},{name:"k",type:"int"}],this.outputShape=e,this.userCode="\n    void main() {\n         // Takes max of indices (0, k), (1, k + 1), (2, k + 2) ...\n         ivec2 coords = getOutputCoords();\n         int batch = coords[0];\n         int elemIdx = coords[1];\n\n         // The output size is half of the previous size.\n         // If the previous sequence is | | | | _ _ _ _  | | | |  _ _ _ _ (k=4),\n         // we only need to output the indices at positions |, the indices at\n         // positions _ can be thrown away, see Figure5(b) After Phase 2\n         // (Merge phase) in the Bitonic Top K paper referenced above.\n         // For example, the paper shows we only need to output the orange bars.\n         // The output sequence should look like this | | | | | | | |.\n         // Because the sequence is halved, to map the output index back\n         // to the previous sequence to find the corresponding value,\n         // we need to double the index. When we double the index,\n         // we basically interpolate a position, so 2i looks like\n         // | _ | _ | _ | _ | _ | _ | _. We move the | to the first k position\n         // of each 2k positions by - elemIdx % k. E.g. for output at\n         // index 4,5,6,7, we want to get the corresponding element at\n         // original index 8,9,10,11, for output at index 8,9,10,11,\n         // we want to get the corresponding element at original index\n         // 16,17,18,19, so on and so forth.\n\n         int i = elemIdx < k ? elemIdx : (elemIdx * 2 - imod(elemIdx, k));\n         int i0 = firstPass == 1 ? i : int(getIndices(batch, i));\n         int i1 = firstPass == 1 ? i + k : int(getIndices(batch, i + k));\n\n         float x0 = getX(batch, i0);\n         float x1 = i1 < n ? getX(batch, i1) : x0;\n\n         setOutput(x0 >= x1 ? float(i0) : float(i1));\n       }\n     "}};function ZH(e,t){null!==t&&e.disposeIntermediateTensorInfo(t)}function JH(e){let t=1;for(;t<e;)t*=2;return t}var QH,eq,tq,nq={kernelName:Yr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{k:s,sorted:i}=a,o=Pt().getNumber("TOPK_LAST_DIM_CPU_HANDOFF_SIZE_THRESHOLD"),l=Pt().getNumber("TOPK_K_CPU_HANDOFF_THRESHOLD"),u=r.shape,d=u[u.length-1];if(n.shouldExecuteOnCPU([r])||d<o||s>l){let e=n.readSync(r.dataId),[t,a]=Gz(e,u,r.dtype,s,i);return[n.makeTensorInfo(t.shape,t.dtype,t.values),n.makeTensorInfo(a.shape,a.dtype,a.values)]}if(0===s)return u[u.length-1]=0,[n.makeTensorInfo(u,r.dtype,[]),n.makeTensorInfo(u,"int32",[])];if(1===d)return[r,AV({attrs:{shape:u,dtype:"int32",value:0},backend:n})];let c=n.texData.get(r.dataId),p=null!==c&&c.isPacked,h=p?n.unpackTensor(r):r,m=Ns.sizeFromShape(u)/d,f=PP({inputs:{x:h},attrs:{shape:[m,d]},backend:n});p&&ZH(n,h);let g=JH(s),x=JH(d),b=null,y=()=>null===b?[f,f]:[f,b],w=(e,t,a)=>{let r=y(),s=new XH(a),i=[[d],[null===b?1:0],[Number.NEGATIVE_INFINITY],[e],[t]],o=b;b=n.runWebGLProgram(s,r,"int32",i),ZH(n,o)};for(let I=1;I<g;I*=2){let e=2*I;for(let t=I;t>=1;t/=2)w(e,t,[m,x])}for(let I=x;I>g;I/=2){let e=y(),t=new YH([m,I/2]),a=[[d],[null===b?1:0],[g]],r=b;b=n.runWebGLProgram(t,e,"int32",a),ZH(n,r);let s=g/2,i=2*s;for(let n=s;n>=1;n/=2)w(i,n,b.shape)}let v=b;b=HB({inputs:{x:b},backend:n,attrs:{begin:0,size:[m,s]}}),ZH(n,v);let k=XV({inputs:{x:f,indices:b},backend:n,attrs:{axis:1,batchDims:1}});ZH(n,f);let N=u.slice(0,-1);N.push(s),v=b,b=PP({inputs:{x:b},attrs:{shape:N},backend:n}),ZH(n,v);let S=k;return k=PP({inputs:{x:k},attrs:{shape:N},backend:n}),ZH(n,S),[k,b]}},aq=class{constructor(e,t,n,a,r,s){this.variableNames=["Image","Transforms"],this.outputShape=s;let i,o="nearest"===n?1:2;switch(a){case"constant":default:i=1;break;case"reflect":i=2;break;case"wrap":i=3;break;case"nearest":i=4}this.userCode=`\n            float mapCoord(float outCoord, float len) {\n              float inCoord = outCoord;\n              if(${i} == 2) {\n                if (inCoord < 0.0) {\n                  if (len <= 1.0) {\n                    inCoord = 0.0;\n                  } else {\n                    float sz2 = 2.0 * len;\n                    if (inCoord < sz2) {\n                      inCoord = sz2 * float(int(float(-inCoord / sz2))) +\n                      inCoord;\n                    }\n                    inCoord = inCoord < -len ? inCoord + sz2 : -inCoord - 1.0;\n                  }\n                } else if (inCoord > len - 1.0) {\n                  if (len <= 1.0) {\n                    inCoord = 0.0;\n                  } else {\n                    float sz2 = 2.0 * len;\n                    inCoord -= sz2 * float(int(float(inCoord / sz2)));\n                    if (inCoord >= len) {\n                      inCoord = sz2 - inCoord - 1.0;\n                    }\n                  }\n                }\n                return clamp(inCoord, 0.0, len - 1.0);\n              } else if (${i} == 3) {\n                if (inCoord < 0.0) {\n                  if (len <= 1.0) {\n                    inCoord = 0.0;\n                  } else {\n                    float sz = len - 1.0;\n                    inCoord += len * (float(int(float(-inCoord / sz))) + 1.0);\n                  }\n                } else if (inCoord > len - 1.0) {\n                  if (len <= 1.0) {\n                    inCoord = 0.0;\n                  } else {\n                    float sz = len - 1.0;\n                    inCoord -= len * float(int(float(inCoord / sz)));\n                  }\n                }\n                return clamp(inCoord, 0.0, len - 1.0);\n              } else if (${i} == 4) {\n                return clamp(outCoord, 0.0, len - 1.0);\n              } else {\n                return outCoord;\n              }\n            }\n\n            float readWithFillValue(int batch, int coordY, int coordX,\n              int channel) {\n              float outputValue;\n              if (0 <= coordY && coordY < ${e} && 0 <= coordX && coordX < ${t}) {\n                  outputValue = getImage(batch, coordY, coordX, channel);\n              } else {\n                outputValue = float(${r});\n              }\n              return outputValue;\n            }\n\n            void main() {\n              ivec4 coords = getOutputCoords();\n              float outputValue;\n              int batch = coords[0];\n              int x = coords[2];\n              int y = coords[1];\n              int channel = coords[3];\n              float xf = float(x);\n              float yf = float(y);\n              float a1 = getTransforms(batch, 0);\n              float a2 = getTransforms(batch, 1);\n              float a3 = getTransforms(batch, 2);\n              float b1 = getTransforms(batch, 3);\n              float b2 = getTransforms(batch, 4);\n              float b3 = getTransforms(batch, 5);\n              float c1 = getTransforms(batch, 6);\n              float c2 = getTransforms(batch, 7);\n              float projection = c1 * xf + c2 * yf + 1.0;\n              if (projection == 0.0) {\n                outputValue = float(${r});\n              } else {\n                float inX = (a1 * xf + a2 * yf + a3) / projection;\n                float inY = (b1 * xf + b2 * yf + b3) / projection;\n                float mapX = mapCoord(inX, float(${t}));\n                float mapY = mapCoord(inY, float(${e}));\n\n                if (${o} == 1) {\n                  int coordY = int(round(mapY));\n                  int coordX = int(round(mapX));\n                  outputValue = readWithFillValue(batch, coordY, coordX,\n                    channel);\n                } else {\n                  float yFloor = floor(mapY);\n                  float xFloor = floor(mapX);\n                  float yCeil = yFloor + 1.0;\n                  float xCeil = xFloor + 1.0;\n                  float valueYFloor = (xCeil - mapX) *\n                  readWithFillValue(batch, int(yFloor), int(xFloor), channel) +\n                  (mapX - xFloor) *\n                  readWithFillValue(batch, int(yFloor), int(xCeil), channel);\n                  float valueYCeil = (xCeil - mapX) *\n                  readWithFillValue(batch, int(yCeil), int(xFloor), channel) +\n                  (mapX - xFloor) *\n                  readWithFillValue(batch, int(yCeil), int(xCeil), channel);\n                  outputValue = (yCeil - mapY) * valueYFloor +\n                  (mapY - yFloor) * valueYCeil;\n                }\n              }\n              setOutput(outputValue);\n            }\n        `}},rq={kernelName:Zr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{image:r,transforms:s}=t,{interpolation:i,fillMode:o,fillValue:l,outputShape:u}=a,[d,c,p,h]=r.shape,[m,f]=null!=u?u:[c,p],g=new aq(c,p,i,o,l,[d,m,f,h]);return n.runWebGLProgram(g,[r,s],"float32")}},sq={kernelName:Qr,backendName:"webgl",kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,{axis:r}=n,{x:s}=t;Jj(s,"unique");let i=a.readSync(s.dataId),{outputValues:o,outputShape:l,indices:u}=qz(i,r,s.shape,s.dtype);return[a.makeTensorInfo(l,s.dtype,o),a.makeTensorInfo([u.length],"int32",u)]}},iq={kernelName:es,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{value:r}=t,{axis:s}=a;s<0&&(s+=r.shape.length);let i=r,o=i.shape.length,l=r.shape[s],u=new Array(o-1),d=0;for(let f=0;f<o;f++)f!==s&&(u[d++]=i.shape[f]);let c=[],p=new Array(o).fill(0),h=i.shape.slice();h[s]=1;let m=new Array(l);for(let f=0;f<m.length;f++){p[s]=f;let e=HB({inputs:{x:i},backend:n,attrs:{begin:p,size:h}}),t=PP({inputs:{x:e},backend:n,attrs:{shape:u}});m[f]=t,c.push(e)}return c.forEach(e=>n.disposeIntermediateTensorInfo(e)),m}},oq=class{constructor(e,t){this.variableNames=["x","segmentIds"];let n=e.windowSize,a=e.batchSize,r=e.inSize,s=e.numSegments,i=s*Math.ceil(r/n);this.outputShape=[a,i];let o=4*Math.floor(n/4),l=n%4,u="\n        sumValue += dot(values, segFilter);\n    ",d="";r%n>0&&(d=`\n        if (inIdx < 0 || inIdx >= ${r}) {\n          return initializationValue;\n        }\n      `);let c="";r%n>0&&(c=`\n        if (inIdx < 0 || inIdx >= ${r}) {\n          return -1.0;\n        }\n      `),this.userCode=`\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        ${d}\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        ${c}\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          ${s})) * float(${n}));\n        int currentSeg = int(mod(float(outIdx), float(${s})));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < ${o}; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          ${u}\n        }\n\n        int inIdx = inOffset + ${o};\n        if (${1===l}) {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          ${u}\n        } else if (${2===l}) {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          ${u}\n        } else if (${3===l}) {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          ${u}\n        }\n        setOutput(sumValue);\n      }\n    `}},lq={kernelName:ts,backendName:"webgl",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,segmentIds:s}=t,{numSegments:i}=a,o=r.shape.length,l=[],u=0,d=Uf.getAxesPermutation([u],o),c=r;null!=d&&(c=YP({inputs:{x:r},backend:n,attrs:{perm:d}}),l.push(c),u=Uf.getInnerMostAxes(1,o)[0]);let p=Uf.segment_util.computeOutShape(c.shape,u,i),h=Ns.sizeFromShape([c.shape[u]]),m=PP({inputs:{x:c},backend:n,attrs:{shape:[-1,h]}});l.push(m);let f=fi(r.dtype),g=(e,t,a,r,s)=>{let i=e.shape[0],o=e.shape[1],u=Uf.segment_util.segOpComputeOptimalWindowSize(o,s),d=new oq({windowSize:u,inSize:o,batchSize:i,numSegments:s},t),c=n.compileAndRun(d,[e,a],r);if(l.push(c),c.shape[1]===s)return c;let p=CG({backend:n,attrs:{start:0,stop:s,step:1,dtype:"float32"}}),h=qH({inputs:{x:p},backend:n,attrs:{reps:[o/u]}});return l.push(p),l.push(h),g(c,t,h,r,s)},x=PP({inputs:{x:g(m,"unsortedSegmentSum",s,f,i)},backend:n,attrs:{shape:p}}),b=x;if(null!=d){l.push(x);let e=Uf.getUndoAxesPermutation(d);b=YP({inputs:{x:b},backend:n,attrs:{perm:e}})}return l.forEach(e=>n.disposeIntermediateTensorInfo(e)),b}},uq=[QP,tB,aB,sB,lB,cB,pB,hB,yB,wB,kB,SB,_B,TB,AB,FB,DB,jB,LB,zB,WB,KB,XB,YB,ZB,nW,sW,lW,SP,cW,yW,TW,FW,MW,OW,jW,LW,PW,WW,UW,XW,YW,ZW,QW,nV,sV,iV,lV,dV,cV,hV,mV,gV,bV,wV,kV,IV,TV,RV,DV,jV,zV,WV,UV,GV,qV,YV,JV,eU,kP,tU,gW,aU,sU,oU,CP,uU,cU,pU,mU,gU,bU,wU,kU,IU,CU,EU,$U,RU,FU,OU,jU,LU,zU,PU,WU,GU,qU,nG,zP,rG,iG,lG,dG,QB,pG,fG,gG,wG,kG,AP,NG,SG,IG,_G,TG,tW,YU,AG,RG,DG,BP,jG,zG,WG,UG,qG,XG,ZG,QG,nH,rH,iH,lH,dH,pH,mH,gH,qB,tG,bH,yH,wH,vH,kH,NH,SH,IH,TH,AH,FH,DH,MH,jH,LH,zH,PH,QU,XP,WH,UH,GH,KH,nq,rq,ZP,sq,iq,lq,mG];for(let p1 of uq)xs(p1);!function(e){e[e.float32=0]="float32",e[e.int32=1]="int32",e[e.bool=2]="bool",e[e.string=3]="string",e[e.complex64=4]="complex64"}(QH||(QH={})),function(e){e[e.linear=0]="linear",e[e.relu=1]="relu",e[e.relu6=2]="relu6",e[e.prelu=3]="prelu",e[e.leakyrelu=4]="leakyrelu",e[e.sigmoid=5]="sigmoid",e[e.elu=6]="elu"}(eq||(eq={}));var dq={kernelName:os,backendName:"wasm",setupFunc:function(e){tq=e.wasm.cwrap(os,null,["number","array","number","number","array","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{a:r,b:s,bias:i,preluActivationWeights:o}=t;if("float32"!==r.dtype||"float32"!==s.dtype)throw new Error("_FusedMatMul for non non-float32 tensors not yet supported.");let{transposeA:l,transposeB:u,activation:d,leakyreluAlpha:c}=a,p=n.dataIdMap.get(r.dataId).id,h=n.dataIdMap.get(s.dataId).id,m=0;if(null!=i){let e=n.dataIdMap.get(i.dataId);if(1!==e.shape.length)throw new Error(`_FusedMatMul only supports rank-1 bias but got rank ${e.shape.length}.`);m=e.id}let f=null==o?0:n.dataIdMap.get(o.dataId).id,g=eq[d];if(null==g)throw new Error(`${d} activation not yet supported for FusedConv2D in the wasm backend.`);let x=l?r.shape[2]:r.shape[1],b=u?s.shape[1]:s.shape[2],y=Mu.assertAndGetBroadcastShape(r.shape.slice(0,-2),s.shape.slice(0,-2)),w=n.makeOutput([...y,x,b],r.dtype),v=n.dataIdMap.get(w.dataId).id,k=new Uint8Array(new Int32Array(r.shape).buffer),N=new Uint8Array(new Int32Array(s.shape).buffer);return tq(p,k,r.shape.length,h,N,s.shape.length,l,u,g,m,f,c||0,v),w}};function cq(e,t){let n;return{kernelName:e,backendName:"wasm",setupFunc:function(t){n=t.wasm.cwrap(e,null,["number","number","number"])},kernelFunc:function(e){let{backend:a,inputs:{x:r}}=e,s=a.dataIdMap.get(r.dataId).id,i=a.makeOutput(r.shape,t||r.dtype),o=a.dataIdMap.get(i.dataId).id;return 0===Ns.sizeFromShape(i.shape)||n(s,QH[r.dtype],o),i}}}var pq=cq(Gt),hq=cq(Ht),mq=cq(qt);function fq(e,t,n){let a;return{kernelName:e,backendName:"wasm",setupFunc:function(t){a=t.wasm.cwrap(e,null,["number","array","number","number","array","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:r}=e,{a:s,b:i}=r,o=t.dataIdMap.get(s.dataId).id,l=t.dataIdMap.get(i.dataId).id,u=null!=n?n:s.dtype,d=Uf.assertAndGetBroadcastShape(s.shape,i.shape),c=t.makeOutput(d,u);if(0===Ns.sizeFromShape(d))return c;let p=new Uint8Array(new Int32Array(s.shape).buffer),h=new Uint8Array(new Int32Array(i.shape).buffer),m=t.dataIdMap.get(c.dataId).id;return a(o,p,s.shape.length,l,h,i.shape.length,QH[s.dtype],m),c}}}var gq,xq=fq(Kt),bq={kernelName:Xt,backendName:"wasm",setupFunc:function(e){gq=e.wasm.cwrap(Xt,null,["array","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n}=e,a=n.makeOutput(t[0].shape,t[0].dtype);if(0===Ns.sizeFromShape(a.shape))return a;let r=t.map(e=>n.dataIdMap.get(e.dataId).id),s=new Uint8Array(new Int32Array(r).buffer),i=n.dataIdMap.get(a.dataId).id;return gq(s,r.length,QH[a.dtype],i),a}};function yq(e){let{inputs:{x:t},backend:n}=e;if("string"===t.dtype)return Ui(n.readSync(t.dataId),t.shape,t.dtype);let a=n.makeOutput(t.shape,t.dtype),r=n.typedArrayFromHeap(t);return n.typedArrayFromHeap(a).set(r),a}var wq,vq={kernelName:la,backendName:"wasm",kernelFunc:yq};function kq(e){let{inputs:t,backend:n,attrs:a}=e,[r,s]=function(e,t){let n=[],a=[];for(let r=0;r<e.length;++r)1!==e[r]&&n.push(e[r]),1!==e[t[r]]&&a.push(t[r]);for(let r=0;r<a.length;++r){let e=-1;for(let t=0;t<a.length;++t)a[t]>=r&&(-1===e||a[e]>a[t])&&(e=t);a[e]=r}return[n,a]}(t.x.shape,a.perm),i=!0;for(let m=0;m<s.length;m++)s[m]!==m&&(i=!1);let o=function(e,t){let n=new Array(e.length);for(let a=0;a<n.length;a++)n[a]=e[t[a]];return n}(t.x.shape,a.perm),l={dataId:t.x.dataId,shape:r,dtype:t.x.dtype};if(i){let e=yq({inputs:t,backend:n});return e.shape=o,e}let u=n.makeOutput(o,l.dtype),d=n.dataIdMap.get(l.dataId).id,c=n.dataIdMap.get(u.dataId).id,p=new Uint8Array(new Int32Array(s).buffer),h=new Uint8Array(new Int32Array(l.shape).buffer);return wq(d,h,l.shape.length,QH[l.dtype],c,p,s.length),u}var Nq,Sq={kernelName:Jr,backendName:"wasm",kernelFunc:kq,setupFunc:function(e){wq=e.wasm.cwrap(Jr,null,["number","array","number","number","number","array","number"])}};function Iq(e,t,n){let a=e.shape,r=e.shape.length,s=Ns.parseAxisParam(t,a),i=s,o=Uf.getAxesPermutation(i,r),l=null,u=!1;if(null!=o){let t=new Array(r);for(let e=0;e<t.length;e++)t[e]=a[o[e]];i=Uf.getInnerMostAxes(i.length,r),l=kq({inputs:{x:e},attrs:{perm:o},backend:n});let s=n.dataIdMap.get(e.dataId).id;n.dataIdMap.get(l.dataId).id!==s&&(u=!0)}return{transposed:l,originalAxes:s,axes:i,inputWasTransposed:u}}var _q,Cq={kernelName:Yt,backendName:"wasm",setupFunc:function(e){Nq=e.wasm.cwrap(Yt,null,["number, number, number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{axis:r,keepDims:s}=a,{x:i}=n,o=t.dataIdMap.get(i.dataId).id,l=i,{transposed:u,axes:d,originalAxes:c,inputWasTransposed:p}=Iq(i,r,t);p&&(l=u,o=t.dataIdMap.get(u.dataId).id);let h=l.shape.length;Uf.assertAxesAreInnerMostDims("all",d,h);let[m,f]=Uf.computeOutAndReduceShapes(l.shape,d),g=Ns.sizeFromShape(f),x=t.makeOutput(m,i.dtype);if(0!==Ns.sizeFromShape(l.shape)){let e=t.dataIdMap.get(x.dataId).id;Nq(o,g,e)}if(p&&t.disposeData(u.dataId),s){let e=Uf.expandShapeToKeepDim(x.shape,c);x.shape=e}return x}},Tq={kernelName:Zt,backendName:"wasm",setupFunc:function(e){_q=e.wasm.cwrap(Zt,null,["number, number, number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{axis:r,keepDims:s}=a,{x:i}=n,o=t.dataIdMap.get(i.dataId).id,l=i,{transposed:u,axes:d,originalAxes:c,inputWasTransposed:p}=Iq(i,r,t);p&&(l=u,o=t.dataIdMap.get(u.dataId).id);let h=l.shape.length;Uf.assertAxesAreInnerMostDims("any",d,h);let[m,f]=Uf.computeOutAndReduceShapes(l.shape,d),g=Ns.sizeFromShape(f),x=t.makeOutput(m,i.dtype);if(0!==Ns.sizeFromShape(l.shape)){let e=t.dataIdMap.get(x.dataId).id;_q(o,g,e)}if(p&&t.disposeData(u.dataId),s){let e=Uf.expandShapeToKeepDim(x.shape,c);x.shape=e}return x}};function Eq(e){let t;return{kernelName:e,backendName:"wasm",setupFunc:function(n){t=n.wasm.cwrap(e,null,["number","number","number","number","number"])},kernelFunc:function(e){let{backend:n,inputs:a,attrs:r}=e,{axis:s}=r,{x:i}=a,o=n.dataIdMap.get(i.dataId).id,l=o,u=i,{transposed:d,axes:c,inputWasTransposed:p}=Iq(i,s,n);if(p){let e=n.dataIdMap.get(d.dataId).id;e!==o&&(u=d,l=e)}let h=u.shape.slice(0,-1),m=n.makeOutput(h,"int32"),f=n.dataIdMap.get(m.dataId).id,g=Ns.sizeFromShape(m.shape),x=u.shape[c[0]];return t(l,QH[u.dtype],g,x,f),p&&n.disposeData(d.dataId),m}}}var Aq,$q,Rq,Fq,Dq=Eq(Jt),Mq=Eq(Qt),Oq=cq(en),jq=cq(tn),Lq=cq(nn),zq=fq(rn),Pq=cq(an),Bq={kernelName:sn,backendName:"wasm",setupFunc:function(e){Aq=e.wasm.cwrap(sn,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,r=t.x,s=a.dataIdMap.get(r.dataId).id,{filterSize:i,strides:o,pad:l,dimRoundingMode:u}=n,d=Uf.computePool2DInfo(r.shape,i,o,1,l,u),c=d.filterHeight,p=d.filterWidth,h=d.padInfo.top,m=d.padInfo.right,f=d.padInfo.bottom,g=d.padInfo.left,x=d.strideHeight,b=d.strideWidth,y=d.inChannels;if("channelsLast"!==d.dataFormat)throw new Error(`wasm backend does not support dataFormat:'${d.dataFormat}'. Please use 'channelsLast'.`);if(1!==d.dilationWidth||1!==d.dilationHeight)throw new Error(`was backend only supports average pooling with dilation = [1, 1], got [${d.dilationHeight}, ${d.dilationWidth}].`);let w=a.makeOutput(d.outShape,"float32"),v=a.dataIdMap.get(w.dataId).id;return Aq(s,r.shape[0],r.shape[1],r.shape[2],c,p,h,m,f,g,x,b,y,v),w}},Wq={kernelName:ln,backendName:"wasm",setupFunc:function(e){$q=e.wasm.cwrap("AvgPool3D",null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{filterSize:s,strides:i,pad:o,dimRoundingMode:l,dataFormat:u}=a,d=Uf.computePool3DInfo(r.shape,s,i,1,o,l,u),c=n.makeOutput(d.outShape,r.dtype);return $q(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(c.dataId).id,d.batchSize,d.inChannels,d.inDepth,d.inHeight,d.inWidth,d.outDepth,d.outHeight,d.outWidth,d.strideDepth,d.strideHeight,d.strideWidth,d.dilationDepth,d.dilationHeight,d.dilationWidth,d.effectiveFilterDepth,d.effectiveFilterHeight,d.effectiveFilterWidth,d.padInfo.front,d.padInfo.top,d.padInfo.left),c}},Vq={kernelName:un,backendName:"wasm",setupFunc:function(e){Rq=e.wasm.cwrap("AvgPool3DGrad",null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s}=t,{filterSize:i,strides:o,pad:l,dimRoundingMode:u}=a,d=Uf.computePool3DInfo(s.shape,i,o,1,l,u),c=n.makeOutput(s.shape,s.dtype);return Rq(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(c.dataId).id,d.batchSize,d.inChannels,d.inDepth,d.inHeight,d.inWidth,d.outDepth,d.outHeight,d.outWidth,d.strideDepth,d.strideHeight,d.strideWidth,d.dilationDepth,d.dilationHeight,d.dilationWidth,d.effectiveFilterDepth,d.effectiveFilterHeight,d.effectiveFilterWidth,d.padInfo.front,d.padInfo.top,d.padInfo.left,d.filterDepth,d.filterHeight,d.filterWidth),c}},Uq={kernelName:on,backendName:"wasm",setupFunc:function(e){Fq=e.wasm.cwrap("AvgPoolGrad",null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s}=t,{filterSize:i,strides:o,pad:l}=a,u=Uf.computePool2DInfo(s.shape,i,o,1,l),d=n.makeOutput(s.shape,s.dtype);return Fq(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(d.dataId).id,u.batchSize,u.inChannels,u.inHeight,u.inWidth,u.outHeight,u.outWidth,u.strideHeight,u.strideWidth,u.dilationHeight,u.dilationWidth,u.effectiveFilterHeight,u.effectiveFilterWidth,u.padInfo.top,u.padInfo.left,u.filterHeight,u.filterWidth),d}};function Gq(e){let{inputs:t,attrs:n}=e,{x:a}=t,{shape:r}=n,s=Ns.sizeFromShape(a.shape),i=Ns.inferFromImplicitShape(r,s);return Ns.assert(s===Ns.sizeFromShape(i),()=>`new shape: ${i}, old shape: ${a.shape}. New shape and old shape must have the same number of elements.`),e.backend.incRef(a.dataId),{dataId:a.dataId,shape:i,dtype:a.dtype}}var Hq,qq={kernelName:ur,backendName:"wasm",kernelFunc:Gq},Kq={kernelName:dn,backendName:"wasm",setupFunc:function(e){Hq=e.wasm.cwrap(dn,null,["number","array","number","number","array","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{a:r,b:s}=t,{transposeA:i,transposeB:o}=a;if("float32"!==r.dtype||"float32"!==s.dtype)throw new Error("BatchMatMul for non non-float32 tensors not yet supported.");let l=r.shape.length,u=s.shape.length,d=i?r.shape[l-2]:r.shape[l-1],c=o?s.shape[u-1]:s.shape[u-2],p=i?r.shape[l-1]:r.shape[l-2],h=o?s.shape[u-2]:s.shape[u-1],m=r.shape.slice(0,-2),f=s.shape.slice(0,-2),g=Ns.sizeFromShape(m),x=Ns.sizeFromShape(f),b=Mu.assertAndGetBroadcastShape(r.shape.slice(0,-2),s.shape.slice(0,-2)).concat([p,h]);Ns.assert(d===c,()=>`Error in matMul: inner shapes (${d}) and (${c}) of Tensors with shapes ${r.shape} and ${s.shape} and transposeA=${i} and transposeB=${o} must match.`);let y=o?[x,h,c]:[x,c,h],w=Gq({inputs:{x:r},backend:n,attrs:{shape:i?[g,d,p]:[g,p,d]}}),v=Gq({inputs:{x:s},backend:n,attrs:{shape:y}}),k=n.dataIdMap.get(w.dataId).id,N=n.dataIdMap.get(v.dataId).id,S=i?w.shape[2]:w.shape[1],I=o?v.shape[1]:v.shape[2],_=Math.max(g,x),C=n.makeOutput([_,S,I],w.dtype),T=n.dataIdMap.get(C.dataId).id,E=new Uint8Array(new Int32Array(w.shape).buffer),A=new Uint8Array(new Int32Array(v.shape).buffer);return Hq(k,E,w.shape.length,N,A,v.shape.length,i,o,T),n.disposeData(w.dataId),n.disposeData(v.dataId),C.shape=b,C}};function Xq(e){let{inputs:{x:t},attrs:{begin:n,size:a},backend:r}=e,[s,i]=bf.parseSliceParams(t,n,a),o=bf.isSliceContinous(t.shape,s,i),l=r.readSync(t.dataId),u=r.makeOutput(i,t.dtype),d=Ns.computeStrides(t.shape),c=r.dataIdMap.get(u.dataId);if(o){let e=bf.computeFlatOffset(s,d);return"string"===t.dtype?c.stringBytes=l.slice(e,e+Ns.sizeFromShape(i)):r.typedArrayFromHeap(u).set(l.subarray(e,e+Ns.sizeFromShape(i))),u}if("string"===t.dtype){let e=iR(l,s,i,t.shape,t.dtype);return c.stringBytes=e,u}let p=r.typedArrayFromHeap(u),h=t.shape.length;if(2===h)!function(e,t,n,a,r){let s=0,i=a[0],o=a[1],l=i+r[0];for(let u=i;u<l;u++){let a=u*t+o;n.set(e.subarray(a,a+r[1]),s),s+=r[1]}}(l,d[0],p,s,i);else if(3===h)!function(e,t,n,a,r,s){let i=0,o=r[0],l=r[1],u=r[2],d=o+s[0],c=l+s[1];for(let p=o;p<d;p++)for(let r=l;r<c;r++){let o=p*t+r*n+u;a.set(e.subarray(o,o+s[2]),i),i+=s[2]}}(l,d[0],d[1],p,s,i);else if(4===h)!function(e,t,n,a,r,s,i){let o=0,l=s[0],u=s[1],d=s[2],c=l+i[0],p=u+i[1],h=d+i[2],m=s[3];for(let f=l;f<c;f++)for(let s=u;s<p;s++)for(let l=d;l<h;l++){let u=f*t+s*n+l*a+m;r.set(e.subarray(u,u+i[3]),o),o+=i[3]}}(l,d[0],d[1],d[2],p,s,i);else{let e=iR(l,s,i,t.shape,t.dtype);p.set(e)}return u}var Yq,Zq={kernelName:Nr,backendName:"wasm",kernelFunc:Xq},Jq={kernelName:cn,backendName:"wasm",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{blockShape:s,crops:i}=a,o=s.reduce((e,t)=>e*t),l=Uf.getReshaped(r.shape,s,o),u=Uf.getPermuted(l.length,s.length),d=Uf.getReshapedPermuted(r.shape,s,o),c=Uf.getSliceBeginCoords(i,s.length),p=Uf.getSliceSize(d,i,s.length),h=Gq({inputs:{x:r},backend:n,attrs:{shape:l}}),m=kq({inputs:{x:h},backend:n,attrs:{perm:u}}),f=Gq({inputs:{x:m},backend:n,attrs:{shape:d}}),g=Xq({inputs:{x:f},backend:n,attrs:{begin:c,size:p}});return n.disposeData(h.dataId),n.disposeData(m.dataId),n.disposeData(f.dataId),g}},Qq={kernelName:pn,backendName:"wasm",setupFunc:function(e){Yq=e.wasm.cwrap(pn,null,["number","number","boolean","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{x:r,weights:s}=n,{size:i}=a,o=0!==s.shape.reduce((e,t)=>e*t,1),l=1===r.shape.length?[i]:[r.shape[0],i],u=t.makeOutput(l,s.dtype);function d(e){return t.dataIdMap.get(e.dataId).id}return Yq(d(r),i,o,d(s),QH[s.dtype],d(u)),u}},eK=fq(hn),tK={kernelName:fn,backendName:"wasm",kernelFunc:function(e){let{inputs:t,backend:n}=e,{s0:a,s1:r}=t,s=n.typedArrayFromHeap(a),i=n.typedArrayFromHeap(r),o=Uf.assertAndGetBroadcastShape(Array.from(s),Array.from(i));return n.makeOutput([o.length],"int32",void 0,new Int32Array(o))}};function nK(e){let{inputs:{x:t},attrs:{dtype:n},backend:a}=e,r=a.makeOutput(t.shape,n),s=a.typedArrayFromHeap(t);return a.typedArrayFromHeap(r).set(s),r}var aK,rK={kernelName:gn,backendName:"wasm",kernelFunc:nK},sK=cq(xn),iK={kernelName:bn,backendName:"wasm",setupFunc:function(e){aK=e.wasm.cwrap(bn,null,["number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{clipValueMin:s,clipValueMax:i}=a,o=n.dataIdMap.get(r.dataId).id,l=n.makeOutput(r.shape,r.dtype),u=n.dataIdMap.get(l.dataId).id;return aK(o,s,i,u),l}};function oK(e){let{inputs:t,backend:n}=e,a=Ns.parseAxisParam(e.attrs.axis,t[0].shape)[0],r=t.map(e=>e.shape);Uf.assertParamsConsistent(r,a);let s=Uf.computeOutShape(t.map(e=>e.shape),a),i=t.filter(e=>Ns.sizeFromShape(e.shape)>0);if(1===i.length)return yq({inputs:{x:i[0]},backend:n});let o=n.makeOutput(s,t[0].dtype);if(0===Ns.sizeFromShape(s))return o;if("string"===i[0].dtype){let e=i.map(e=>{let t=[-1,Ns.sizeFromShape(e.shape.slice(a))];return Gq({inputs:{x:e},backend:n,attrs:{shape:t}})}),r=e.map(e=>({vals:n.readSync(e.dataId),shape:e.shape}));s=Uf.computeOutShape(e.map(e=>e.shape),1);let l=1===e[0].shape[0],u=WA(r,s,t[0].dtype,l),d=Uf.computeOutShape(i.map(e=>e.shape),a);return o.shape=d,n.dataIdMap.get(o.dataId).stringBytes=Uf.fromStringArrayToUint8(u),e.forEach(e=>n.disposeData(e.dataId)),o}let l=Ns.sizeFromShape(i[0].shape.slice(0,a)),u=0,d=i.map(e=>{let t=Ns.sizeFromShape(e.shape.slice(a));return u+=t,t}),c=i.map(e=>n.typedArrayFromHeap(e)),p=n.typedArrayFromHeap(o);for(let h=0;h<l;h++){let e=h*u;for(let t=0;t<c.length;t++){let n=d[t],a=h*n,r=c[t].subarray(a,a+n);p.set(r,e),e+=n}}return o}var lK,uK,dK,cK,pK,hK,mK,fK={kernelName:vn,backendName:"wasm",kernelFunc:oK},gK={kernelName:kn,backendName:"wasm",setupFunc:function(e){lK=e.wasm.cwrap(kn,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,{x:r,filter:s}=t,i=a.dataIdMap.get(r.dataId).id,o=a.dataIdMap.get(s.dataId).id,{strides:l,dilations:u,pad:d,dimRoundingMode:c,dataFormat:p}=n,h=Uf.convertConv2DDataFormat(p),m=Uf.computeConv2DInfo(r.shape,s.shape,l,u,d,c,!1,h),f=m.filterHeight,g=m.filterWidth,x=m.padInfo.top,b=m.padInfo.right,y=m.padInfo.bottom,w=m.padInfo.left,v=m.dilationHeight,k=m.dilationWidth,N=m.strideHeight,S=m.strideWidth,I=m.inChannels,_=m.outChannels,C="SAME"===m.padInfo.type?1:0;if("channelsLast"!==m.dataFormat)throw new Error(`wasm backend Conv2D does not support dataFormat:'${m.dataFormat}'. Please use 'channelsLast'.`);let T=a.makeOutput(m.outShape,"float32"),E=a.dataIdMap.get(T.dataId).id;return lK(i,r.shape[0],r.shape[1],r.shape[2],o,f,g,x,b,y,w,C,v,k,N,S,I,_,E),T}},xK={kernelName:Sn,backendName:"wasm",setupFunc:function(e){uK=e.wasm.cwrap(Sn,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{dy:r,filter:s}=n,{strides:i,pad:o,dataFormat:l,dimRoundingMode:u,inputShape:d}=a,c=Uf.convertConv2DDataFormat(l),p=Uf.computeConv2DInfo(d,s.shape,i,1,o,u,!1,c),{batchSize:h,filterHeight:m,filterWidth:f,inChannels:g,inHeight:x,inWidth:b,outChannels:y,outHeight:w,outWidth:v,strideHeight:k,strideWidth:N}=p,S=m-1-p.padInfo.top,I=f-1-p.padInfo.left,_="channelsLast"===p.dataFormat,C=Ns.computeStrides(p.inShape),T=Ns.computeStrides(r.shape),[E,A,$]=Ns.computeStrides(s.shape),R=C[0],F=_?C[1]:C[2],D=_?C[2]:1,M=_?1:C[1],O=T[0],j=_?T[1]:T[2],L=_?T[2]:1,z=_?1:T[1],P=t.makeOutput(p.inShape,"float32"),B=t.dataIdMap.get(P.dataId).id,W=t.dataIdMap.get(r.dataId).id,V=t.dataIdMap.get(s.dataId).id;return uK(W,V,h,m,f,x,b,g,w,v,y,k,N,S,I,E,A,$,R,F,D,M,O,j,L,z,B),P}},bK={kernelName:In,backendName:"wasm",setupFunc:function(e){dK=e.wasm.cwrap(In,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s}=t,{strides:i,pad:o,dilations:l}=a;if("float32"!==r.dtype)throw new Error(`Tensor x must have dtype float32, got ${r.dtype}`);if("float32"!==s.dtype)throw new Error(`Tensor filter must have dtype float32, got ${s.dtype}`);let u=Uf.computeConv3DInfo(r.shape,s.shape,i,l,o),d=n.makeOutput(u.outShape,r.dtype);return dK(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(s.dataId).id,n.dataIdMap.get(d.dataId).id,u.batchSize,u.inDepth,u.inHeight,u.inWidth,u.inChannels,u.outDepth,u.outHeight,u.outWidth,u.outChannels,u.strideDepth,u.strideHeight,u.strideWidth,u.dilationDepth,u.dilationHeight,u.dilationWidth,u.filterDepth,u.filterHeight,u.filterWidth,u.padInfo.front,u.padInfo.top,u.padInfo.left),d}},yK={kernelName:_n,backendName:"wasm",setupFunc:function(e){cK=e.wasm.cwrap(_n,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,dy:s}=t,{strides:i,pad:o,filterShape:l}=a;if("float32"!==r.dtype)throw new Error(`Tensor dy must have dtype float32, got ${r.dtype}`);if("float32"!==s.dtype)throw new Error(`Tensor filter must have dtype float32, got ${s.dtype}`);let u=Uf.computeConv3DInfo(r.shape,l,i,1,o),d=n.makeOutput(u.filterShape,s.dtype);return cK(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(s.dataId).id,n.dataIdMap.get(d.dataId).id,u.batchSize,u.inDepth,u.inHeight,u.inWidth,u.inChannels,u.outDepth,u.outHeight,u.outWidth,u.outChannels,u.strideDepth,u.strideHeight,u.strideWidth,u.dilationDepth,u.dilationHeight,u.dilationWidth,u.filterDepth,u.filterHeight,u.filterWidth,u.padInfo.front,u.padInfo.top,u.padInfo.left),d}},wK={kernelName:Cn,backendName:"wasm",setupFunc:function(e){pK=e.wasm.cwrap(Cn,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,filter:s}=t,{pad:i,strides:o,inputShape:l}=a;if("float32"!==r.dtype)throw new Error(`Tensor dy must have dtype float32, got ${r.dtype}`);if("float32"!==s.dtype)throw new Error(`Tensor filter must have dtype float32, got ${s.dtype}`);let u=Uf.computeConv3DInfo(l,s.shape,o,1,i),d=n.makeOutput(u.inShape,r.dtype);return pK(n.dataIdMap.get(s.dataId).id,n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(d.dataId).id,u.batchSize,u.inDepth,u.inHeight,u.inWidth,u.inChannels,u.outDepth,u.outHeight,u.outWidth,u.outChannels,u.strideDepth,u.strideHeight,u.strideWidth,u.dilationDepth,u.dilationHeight,u.dilationWidth,u.filterDepth,u.filterHeight,u.filterWidth,u.padInfo.front,u.padInfo.top,u.padInfo.left),d}},vK=cq(Tn),kK=cq(En);!function(e){e[e.bilinear=0]="bilinear",e[e.nearest=1]="nearest"}(hK||(hK={}));var NK,SK,IK,_K,CK,TK,EK,AK,$K,RK,FK={kernelName:Rn,backendName:"wasm",setupFunc:function(e){mK=e.wasm.cwrap(Rn,null,["number","number","number","number","array","number","number","number","number","number"])},kernelFunc:function(e){let t,{backend:n,inputs:a,attrs:r}=e,{method:s,extrapolationValue:i,cropSize:o}=r,{image:l,boxes:u,boxInd:d}=a,c=u.shape[0],[p,h]=o,m=[c,p,h,l.shape[3]],f=n.dataIdMap.get(l.dataId);"float32"!==l.dtype&&(t=nK({backend:n,inputs:{x:l},attrs:{dtype:"float32"}}),f=n.dataIdMap.get(t.dataId));let g=f.id,x=n.dataIdMap.get(u.dataId).id,b=n.dataIdMap.get(d.dataId).id,y=n.makeOutput(m,"float32"),w=n.dataIdMap.get(y.dataId).id,v=new Uint8Array(new Int32Array(l.shape).buffer);return mK(g,x,b,c,v,p,h,hK[s],i,w),null!=t&&n.disposeData(t.dataId),y}},DK={kernelName:An,backendName:"wasm",setupFunc:function(e){NK=e.wasm.cwrap(An,null,["number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,exclusive:i,reverse:o}=a,l=r.shape.length;Ns.assert("float32"===r.dtype||"int32"===r.dtype,()=>`cumprod does not support ${r.dtype} tensors in the WASM backend`);let u=Uf.getAxesPermutation([s],l),d=r;null!==u&&(d=kq({inputs:{x:r},attrs:{perm:u},backend:n}));let c=Uf.getInnerMostAxes(1,l)[0];Uf.assertAxesAreInnerMostDims("cumprod",[c],l);let p=n.makeOutput(d.shape,d.dtype),h=d.shape[c],m=n.dataIdMap.get(d.dataId).id,f=n.dataIdMap.get(p.dataId).id;NK(m,i?1:0,o?1:0,h,f,QH[r.dtype]);let g=p;return null!==u&&(g=kq({inputs:{x:p},attrs:{perm:Uf.getUndoAxesPermutation(u)},backend:n}),n.disposeData(d.dataId),n.disposeData(p.dataId)),g}},MK={kernelName:$n,backendName:"wasm",setupFunc:function(e){SK=e.wasm.cwrap($n,null,["number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{axis:s,exclusive:i,reverse:o}=a,l=r.shape.length;Ns.assert("float32"===r.dtype||"int32"===r.dtype,()=>`cumsum does not support ${r.dtype} tensors in the WASM backend`);let u=Uf.getAxesPermutation([s],l),d=r;null!==u&&(d=kq({inputs:{x:r},attrs:{perm:u},backend:n}));let c=Uf.getInnerMostAxes(1,l)[0];Uf.assertAxesAreInnerMostDims("cumsum",[c],l);let p=n.makeOutput(d.shape,d.dtype),h=d.shape[c],m=n.dataIdMap.get(d.dataId).id,f=n.dataIdMap.get(p.dataId).id;SK(m,i?1:0,o?1:0,h,f,QH[r.dtype]);let g=p;return null!==u&&(g=kq({inputs:{x:p},attrs:{perm:Uf.getUndoAxesPermutation(u)},backend:n}),n.disposeData(d.dataId),n.disposeData(p.dataId)),g}},OK={kernelName:Fn,backendName:"wasm",setupFunc:function(e){IK=e.wasm.cwrap("DenseBincount",null,["number","array","number","number","boolean","number","number","boolean","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{x:r,weights:s}=n,{size:i,binaryOutput:o}=a,l=0!==s.shape.reduce((e,t)=>e*t,1),u=1===r.shape.length?[i]:[r.shape[0],i],d=t.makeOutput(u,s.dtype);function c(e){return t.dataIdMap.get(e.dataId).id}return IK(c(r),new Uint8Array(new Int32Array(r.shape).buffer),r.shape.length,i,l,c(s),QH[s.dtype],o,c(d)),d}},jK={kernelName:Dn,backendName:"wasm",setupFunc:function(e){_K=e.wasm.cwrap(Dn,null,["number","number","number","array","number","array","array","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{x:r}=n,{blockSize:s,dataFormat:i}=a,o=r.shape[0],l=("NHWC"===i?r.shape[1]:r.shape[2])*s,u=("NHWC"===i?r.shape[2]:r.shape[3])*s,d=("NHWC"===i?r.shape[3]:r.shape[1])/(s*s),c="NHWC"===i?[o,l,u,d]:[o,d,l,u],p=t.makeOutput(c,"float32"),h=t.dataIdMap.get(r.dataId).id,m=new Uint8Array(new Int32Array(Ns.computeStrides(r.shape)).buffer),f=new Uint8Array(new Int32Array(c).buffer),g=new Uint8Array(new Int32Array(Ns.computeStrides(c)).buffer),x=t.dataIdMap.get(p.dataId).id;return _K(h,s,"NHWC"===i?1:0,m,r.shape.length-1,f,g,c.length,x),p}},LK={kernelName:Mn,backendName:"wasm",setupFunc:function(e){CK=e.wasm.cwrap(Mn,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,{x:r,filter:s}=t,i=a.dataIdMap.get(r.dataId).id,o=a.dataIdMap.get(s.dataId).id,{strides:l,dilations:u,pad:d,dimRoundingMode:c}=n,p=null==u?[1,1]:u,h=Uf.computeConv2DInfo(r.shape,s.shape,l,p,d,c,!0),m=h.filterHeight,f=h.filterWidth,g=h.padInfo.top,x=h.padInfo.right,b=h.padInfo.bottom,y=h.padInfo.left,w=h.dilationHeight,v=h.dilationWidth,k=h.strideHeight,N=h.strideWidth,S=h.inChannels,I=h.outChannels,_="SAME"===h.padInfo.type?1:0;if("channelsLast"!==h.dataFormat)throw new Error(`wasm backend DepthwiseConv2dNative does not support dataFormat:'${h.dataFormat}'. Please use 'channelsLast'.`);let C=a.makeOutput(h.outShape,"float32"),T=a.dataIdMap.get(C.dataId).id;return CK(i,r.shape[0],r.shape[1],r.shape[2],o,m,f,g,x,b,y,_,w,v,k,N,S,I,T),C}},zK={kernelName:Ln,backendName:"wasm",setupFunc:function(e){TK=e.wasm.cwrap("Diag",null,["number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n}=e,{x:a}=t,r=Ns.sizeFromShape(a.shape),s=n.makeOutput([...a.shape,...a.shape],a.dtype);return TK(n.dataIdMap.get(a.dataId).id,QH[a.dtype],r,n.dataIdMap.get(s.dataId).id),s}},PK={kernelName:zn,backendName:"wasm",setupFunc:function(e){EK=e.wasm.cwrap(zn,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s}=t,{strides:i,pad:o,dilations:l}=a;if(r.dtype!==s.dtype)throw new Error(`Dilation2D error: x must have the same dtype as filter. Got ${r.dtype} and ${s.dtype}`);let u=Uf.computeDilation2DInfo(r.shape,s.shape,i,o,"NHWC",l),d=n.makeOutput(u.outShape,r.dtype);return EK(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(s.dataId).id,n.dataIdMap.get(d.dataId).id,QH[r.dtype],u.batchSize,u.inChannels,u.inHeight,u.inWidth,u.outHeight,u.outWidth,u.strideHeight,u.strideWidth,u.dilationHeight,u.dilationWidth,u.filterHeight,u.filterWidth,u.padInfo.top,u.padInfo.left),d}},BK={kernelName:Bn,backendName:"wasm",setupFunc:function(e){AK=e.wasm.cwrap(Bn,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s,dy:i}=t,{strides:o,pad:l,dilations:u}=a;if(r.dtype!==s.dtype||r.dtype!==i.dtype)throw new Error(`Dilation2DBackpropFilter error: x must have the same dtype as filter and dy. Got ${r.dtype}, ${s.dtype}, and ${i.dtype}`);let d=Uf.computeDilation2DInfo(r.shape,s.shape,o,l,"NHWC",u),c=n.makeOutput(s.shape,s.dtype);return AK(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(s.dataId).id,n.dataIdMap.get(i.dataId).id,n.dataIdMap.get(c.dataId).id,QH[r.dtype],d.batchSize,d.inChannels,d.inHeight,d.inWidth,d.outHeight,d.outWidth,d.strideHeight,d.strideWidth,d.dilationHeight,d.dilationWidth,d.filterHeight,d.filterWidth,d.padInfo.top,d.padInfo.left),c}},WK={kernelName:Pn,backendName:"wasm",setupFunc:function(e){$K=e.wasm.cwrap(Pn,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,filter:s,dy:i}=t,{strides:o,pad:l,dilations:u}=a;if(r.dtype!==s.dtype||r.dtype!==i.dtype)throw new Error(`Dilation2DBackpropInput error: x must have the same dtype as filter and dy. Got ${r.dtype}, ${s.dtype}, and ${i.dtype}`);let d=Uf.computeDilation2DInfo(r.shape,s.shape,o,l,"NHWC",u),c=n.makeOutput(r.shape,r.dtype);return $K(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(s.dataId).id,n.dataIdMap.get(i.dataId).id,n.dataIdMap.get(c.dataId).id,QH[r.dtype],d.batchSize,d.inChannels,d.inHeight,d.inWidth,d.outHeight,d.outWidth,d.strideHeight,d.strideWidth,d.dilationHeight,d.dilationWidth,d.filterHeight,d.filterWidth,d.padInfo.top,d.padInfo.left),c}},VK=cq(Gn),UK={kernelName:Hn,backendName:"wasm",setupFunc:function(e){RK=e.wasm.cwrap(Hn,null,["number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n}=e,{dy:a,y:r}=t,s=n.makeOutput(r.shape,"float32"),i=e=>n.dataIdMap.get(e.dataId).id;return RK(i(r),i(a),i(s)),s}},GK=fq(Kn,0,"bool"),HK=cq(qn),qK=cq(Xn,"float32");function KK(e){let{inputs:t,attrs:n,backend:a}=e,{input:r}=t,{dim:s}=n,i=r.shape.length,o=r.shape.slice(),l=s;return s<0&&(Ns.assert(-(i+1)<=s,()=>`Axis must be in the interval [${-(i+1)}, ${i}]`),l=i+s+1),o.splice(l,0,1),Gq({inputs:{x:r},backend:a,attrs:{shape:o}})}var XK={kernelName:Yn,backendName:"wasm",kernelFunc:KK},YK=cq(Zn,"float32");function ZK(e){let{attrs:{shape:t,value:n},backend:a}=e,{attrs:{dtype:r}}=e;r=r||Ns.inferDtype(n);let s=a.makeOutput(t,r);return a.typedArrayFromHeap(s).fill(n),s}var JK,QK,eX,tX,nX,aX,rX,sX,iX,oX,lX,uX,dX,cX,pX,hX,mX,fX,gX,xX,bX={kernelName:Qn,backendName:"wasm",kernelFunc:ZK},yX={kernelName:ea,backendName:"wasm",kernelFunc:function(e){let{inputs:t,backend:n}=e,{image:a}=t,r=n.makeOutput(a.shape,a.dtype),s=n.dataIdMap.get(a.dataId).id,i=n.dataIdMap.get(r.dataId).id,[o,l,u,d]=a.shape;return JK(s,o,l,u,d,i),r},setupFunc:function(e){JK=e.wasm.cwrap(ea,null,["number","number","number","number","number","number"])}},wX=cq(ta),vX=fq(na),kX={kernelName:aa,backendName:"wasm",setupFunc:function(e){QK=e.wasm.cwrap(aa,null,["number","number","number","number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{varianceEpsilon:r}=a,{x:s,mean:i,variance:o,offset:l,scale:u}=n,d=t.dataIdMap.get(s.dataId).id,c=t.dataIdMap.get(i.dataId).id,p=t.dataIdMap.get(o.dataId).id,h=null!=l?t.dataIdMap.get(l.dataId).id:0,m=null!=u?t.dataIdMap.get(u.dataId).id:0,f=t.makeOutput(s.shape,s.dtype);if(0===Ns.sizeFromShape(s.shape))return f;let g=t.dataIdMap.get(f.dataId).id;return QK(d,c,p,h,m,r,g),f}},NX={kernelName:ls,backendName:"wasm",setupFunc:function(e){eX=e.wasm.cwrap(ls,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,{x:r,filter:s,bias:i,preluActivationWeights:o}=t,{strides:l,pad:u,dilations:d,dataFormat:c,dimRoundingMode:p,activation:h,leakyreluAlpha:m}=n,f=Uf.computeConv2DInfo(r.shape,s.shape,l,d,u,p),g=eq[h];if(null==g)throw new Error(`${h} activation not yet supported for FusedConv2D in the wasm backend.`);let x=a.dataIdMap.get(r.dataId).id,b=a.dataIdMap.get(s.dataId).id,y=f.outChannels,w=0;if(null!=i){let e=a.dataIdMap.get(i.dataId);if(1!==e.shape.length)throw new Error(`FusedConv2D only supports rank-1 bias but got rank ${e.shape.length}.`);if(e.shape[0]!==y)throw new Error(`FusedConv2D bias shape (${e.shape}) does not match the number of output channels (${y})`);w=e.id}let v=f.filterHeight,k=f.filterWidth,N=f.padInfo.top,S=f.padInfo.right,I=f.padInfo.bottom,_=f.padInfo.left,C=f.dilationHeight,T=f.dilationWidth,E=f.strideHeight,A=f.strideWidth,$=f.inChannels,R="SAME"===f.padInfo.type?1:0,F=f.batchSize,D=f.inHeight,M=f.inWidth;if("NHWC"!==c)throw new Error(`wasm backend FusedConv2D does not support dataFormat:'${c}'. Please use 'NHWC'.`);let O=a.makeOutput(f.outShape,"float32"),j=a.dataIdMap.get(O.dataId).id,L=null==o?0:a.dataIdMap.get(o.dataId).id;return eX(x,F,D,M,b,v,k,w,N,S,I,_,R,C,T,E,A,$,y,g,L,m||0,j),O}},SX={kernelName:us,backendName:"wasm",setupFunc:function(e){tX=e.wasm.cwrap(us,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,{x:r,filter:s,bias:i,preluActivationWeights:o}=t,{strides:l,pad:u,dilations:d,dataFormat:c,dimRoundingMode:p,activation:h,leakyreluAlpha:m}=n,f=Uf.computeConv2DInfo(r.shape,s.shape,l,d,u,p,!0),g=eq[h];if(null==g)throw new Error(`${h} activation not yet supported for FusedDepthwiseConv2D in the wasm backend.`);let x=a.dataIdMap.get(r.dataId).id,b=a.dataIdMap.get(s.dataId).id,y=f.outChannels,w=0;if(null!=i){let e=a.dataIdMap.get(i.dataId);if(1!==e.shape.length)throw new Error(`FusedDepthwiseConv2D only supports rank-1 bias but got rank ${e.shape.length}.`);if(e.shape[0]!==y)throw new Error(`FusedDepthwiseConv2D bias shape (${e.shape}) does not match the number of output channels (${y})`);w=e.id}let v=f.filterHeight,k=f.filterWidth,N=f.padInfo.top,S=f.padInfo.right,I=f.padInfo.bottom,_=f.padInfo.left,C=f.dilationHeight,T=f.dilationWidth,E=f.strideHeight,A=f.strideWidth,$=f.inChannels,R="SAME"===f.padInfo.type?1:0,F=f.batchSize,D=f.inHeight,M=f.inWidth;if("NHWC"!==c)throw new Error(`wasm backend FusedDepthwiseConv2D does not support dataFormat:'${c}'. Please use 'NHWC'.`);let O=a.makeOutput(f.outShape,"float32"),j=a.dataIdMap.get(O.dataId).id,L=null==o?0:a.dataIdMap.get(o.dataId).id;return tX(x,F,D,M,b,v,k,w,N,S,I,_,R,C,T,E,A,$,y,g,L,m||0,j),O}},IX={kernelName:sa,backendName:"wasm",setupFunc:function(e){nX=e.wasm.cwrap(sa,null,["number","number","number","number","number","number","array","number"])},kernelFunc:function(e){let{backend:t,inputs:n}=e,{params:a,indices:r}=n,[s,i,o,l]=gf.prepareAndValidate(a,r),u=t.makeOutput(s,a.dtype);if(0===i)return u;let d=r.shape,c=d[d.length-1],p=t.dataIdMap.get(a.dataId).id,h=t.dataIdMap.get(r.dataId).id,m=new Uint8Array(new Int32Array(l).buffer),f=t.dataIdMap.get(u.dataId).id;return nX(p,QH[a.dtype],h,i,c,o,m,f),u}},_X={kernelName:ra,backendName:"wasm",setupFunc:function(e){aX=e.wasm.cwrap("Gather",null,["number","number","array","number","number","number","array","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{x:r,indices:s}=n,{axis:i,batchDims:o}=a,l=Ns.parseAxisParam(i,r.shape)[0],u=t.readSync(s.dataId),d=r.shape[l];for(let N=0;N<u.length;++N){let e=u[N];Ns.assert(e<=d-1&&e>=0,()=>`GatherV2: the index value ${e} is not in [0, ${d-1}]`)}let c=Uf.segment_util.collectGatherOpShapeInfo(r,s,l,o),p=Gq({inputs:{x:r},attrs:{shape:[c.batchSize,c.outerSize,c.dimSize,c.sliceSize]},backend:t}),h=Ns.sizeFromShape(s.shape),m=Gq({inputs:{x:s},attrs:{shape:[c.batchSize,h/c.batchSize]},backend:t}),f=[c.batchSize,c.outerSize,h/c.batchSize,c.sliceSize],g=t.makeOutput(f,r.dtype);if(0===Ns.sizeFromShape(r.shape))return g;let x=p.shape.length-1,b=t.dataIdMap.get(p.dataId).id,y=t.dataIdMap.get(m.dataId).id,w=t.dataIdMap.get(g.dataId).id,v=new Uint8Array(new Int32Array(Ns.computeStrides(p.shape)).buffer),k=new Uint8Array(new Int32Array(Ns.computeStrides(f)).buffer);return aX(b,QH[r.dtype],v,x,y,c.batchSize,k,w),t.disposeData(p.dataId),t.disposeData(m.dataId),g.shape=c.outputShape,g}},CX=fq(ia,0,"bool"),TX=fq(oa,0,"bool"),EX=cq(ca,"bool"),AX=cq(pa,"bool"),$X=cq(ha,"bool"),RX={kernelName:ma,backendName:"wasm",setupFunc:function(e){rX=e.wasm.cwrap(ma,null,["number","number","number","number"])},kernelFunc:function(e){let{inputs:{x:t},attrs:{alpha:n},backend:a}=e,r=a.dataIdMap.get(t.dataId).id,s=a.makeOutput(t.shape,"float32");if(0!==Ns.sizeFromShape(t.shape)){let e=a.dataIdMap.get(s.dataId).id;rX(r,QH[t.dtype],n,e)}return s}},FX=fq(fa,0,"bool"),DX=fq(ga,0,"bool"),MX={kernelName:xa,backendName:"wasm",setupFunc:function(e){sX=e.wasm.cwrap(xa,null,["number","number","number","number"])},kernelFunc:function(e){let{attrs:t,backend:n}=e,{start:a,stop:r,num:s}=t,i=Math.floor(s),o=n.makeOutput([i],"float32");return sX(n.dataIdMap.get(o.dataId).id,a,r,i),o}},OX=cq(ba),jX=cq(ya),LX=fq(wa,0,"bool"),zX=cq(va),PX=fq(ka,0,"bool"),BX=fq(Na,0,"bool"),WX={kernelName:_a,backendName:"wasm",setupFunc:function(e){iX=e.wasm.cwrap(_a,null,["number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{depthRadius:s,bias:i,alpha:o,beta:l}=a;if("float32"!==r.dtype)throw new Error("LRN error: x must have dtype float32");let u=n.makeOutput(r.shape,r.dtype);return iX(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(u.dataId).id,r.shape[3],s,i,o,l),u}},VX={kernelName:Ca,backendName:"wasm",setupFunc:function(e){oX=e.wasm.cwrap(Ca,null,["number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r,y:s,dy:i}=t,{depthRadius:o,bias:l,alpha:u,beta:d}=a;if("float32"!==r.dtype||"float32"!==s.dtype||"float32"!==i.dtype)throw new Error("LRNGrad error: x, y, and dy must have dtype float32");let c=n.makeOutput(r.shape,r.dtype);return oX(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(s.dataId).id,n.dataIdMap.get(i.dataId).id,n.dataIdMap.get(c.dataId).id,i.shape[3],o,l,u,d),c}},UX={kernelName:Ea,backendName:"wasm",setupFunc:function(e){lX=e.wasm.cwrap(Ea,null,["number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{reductionIndices:r,keepDims:s}=a,{x:i}=n,o=t.dataIdMap.get(i.dataId).id,l=i,{transposed:u,axes:d,originalAxes:c,inputWasTransposed:p}=Iq(i,r,t);p&&(l=u,o=t.dataIdMap.get(u.dataId).id);let h=l.shape.length;Uf.assertAxesAreInnerMostDims("max",d,h);let[m,f]=Uf.computeOutAndReduceShapes(l.shape,d),g=Ns.sizeFromShape(f),x=t.makeOutput(m,i.dtype);if(0!==Ns.sizeFromShape(l.shape)){let e=t.dataIdMap.get(x.dataId).id;lX(o,QH[i.dtype],g,e)}if(p&&t.disposeData(u.dataId),s){let e=Uf.expandShapeToKeepDim(x.shape,c);x.shape=e}return x}},GX=fq(Aa),HX={kernelName:$a,backendName:"wasm",setupFunc:function(e){uX=e.wasm.cwrap($a,null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,r=t.x,s=a.dataIdMap.get(r.dataId).id;Ns.assert("float32"===r.dtype,()=>`Error in MaxPool: only float32 input is supported. Got ${r.dtype}.`);let{filterSize:i,strides:o,pad:l,dimRoundingMode:u}=n,d=Uf.computePool2DInfo(r.shape,i,o,1,l,u),c=d.filterHeight,p=d.filterWidth,h=d.padInfo.top,m=d.padInfo.right,f=d.padInfo.bottom,g=d.padInfo.left,x=d.dilationHeight,b=d.dilationWidth,y=d.strideHeight,w=d.strideWidth,v=d.inChannels,k=d.outChannels;if("channelsLast"!==d.dataFormat)throw new Error(`wasm backend does not support dataFormat:'${d.dataFormat}'. Please use 'channelsLast'.`);let N=a.makeOutput(d.outShape,"float32"),S=a.dataIdMap.get(N.dataId).id;return uX(s,r.shape[0],r.shape[1],r.shape[2],c,p,h,m,f,g,x,b,y,w,v,k,S),N}},qX={kernelName:Fa,backendName:"wasm",setupFunc:function(e){dX=e.wasm.cwrap("MaxPool3D",null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{filterSize:s,strides:i,pad:o,dimRoundingMode:l,dataFormat:u}=a,d=Uf.computePool3DInfo(r.shape,s,i,1,o,l,u),c=n.makeOutput(d.outShape,r.dtype);return dX(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(c.dataId).id,d.batchSize,d.inChannels,d.inDepth,d.inHeight,d.inWidth,d.outDepth,d.outHeight,d.outWidth,d.strideDepth,d.strideHeight,d.strideWidth,d.dilationDepth,d.dilationHeight,d.dilationWidth,d.effectiveFilterDepth,d.effectiveFilterHeight,d.effectiveFilterWidth,d.padInfo.front,d.padInfo.top,d.padInfo.left),c}},KX={kernelName:Da,backendName:"wasm",setupFunc:function(e){cX=e.wasm.cwrap("MaxPool3DGrad",null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s}=t,{filterSize:i,strides:o,pad:l,dimRoundingMode:u}=a,d=Uf.computePool3DInfo(s.shape,i,o,1,l,u),c=n.makeOutput(s.shape,s.dtype);return cX(n.dataIdMap.get(s.dataId).id,n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(c.dataId).id,d.batchSize,d.inChannels,d.inDepth,d.inHeight,d.inWidth,d.outDepth,d.outHeight,d.outWidth,d.strideDepth,d.strideHeight,d.strideWidth,d.dilationDepth,d.dilationHeight,d.dilationWidth,d.effectiveFilterDepth,d.effectiveFilterHeight,d.effectiveFilterWidth,d.padInfo.front,d.padInfo.top,d.padInfo.left),c}},XX={kernelName:Ra,backendName:"wasm",setupFunc:function(e){pX=e.wasm.cwrap("MaxPoolGrad",null,["number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{dy:r,input:s}=t,{filterSize:i,strides:o,pad:l,dimRoundingMode:u}=a,d=Uf.computePool2DInfo(s.shape,i,o,1,l,u),c=n.makeOutput(s.shape,s.dtype);return pX(n.dataIdMap.get(s.dataId).id,n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(c.dataId).id,d.batchSize,d.inChannels,d.inHeight,d.inWidth,d.outHeight,d.outWidth,d.strideHeight,d.strideWidth,d.dilationHeight,d.dilationWidth,d.effectiveFilterHeight,d.effectiveFilterWidth,d.padInfo.top,d.padInfo.left),c}},YX={kernelName:Ma,backendName:"wasm",setupFunc:function(e){hX=e.wasm.cwrap("MaxPoolWithArgmax",null,["number","number","number","number","boolean","number","number","number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{filterSize:s,strides:i,pad:o,includeBatchInIndex:l}=a;Ns.assert(4===r.shape.length,()=>`Error in maxPool: input must be rank 4 but got rank ${r.shape.length}.`);let u=[1,1];Ns.assert(Uf.eitherStridesOrDilationsAreOne(i,u),()=>`Error in maxPool: Either strides or dilations must be 1. Got strides ${i} and dilations '${u}'`);let d=Uf.computePool2DInfo(r.shape,s,i,[1,1],o),c=n.makeOutput(d.outShape,r.dtype),p=n.makeOutput(d.outShape,"int32");return hX(n.dataIdMap.get(r.dataId).id,n.dataIdMap.get(c.dataId).id,n.dataIdMap.get(p.dataId).id,QH[r.dtype],l,d.batchSize,d.inChannels,d.inHeight,d.inWidth,d.outHeight,d.outWidth,d.strideHeight,d.strideWidth,d.dilationHeight,d.dilationWidth,d.effectiveFilterHeight,d.effectiveFilterWidth,d.padInfo.top,d.padInfo.left),[c,p]}},ZX={kernelName:Oa,backendName:"wasm",setupFunc:function(e){mX=e.wasm.cwrap(Oa,null,["number, number, number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{axis:r,keepDims:s}=a,{x:i}=n,o=t.dataIdMap.get(i.dataId).id,l=o,u=i,{transposed:d,axes:c,originalAxes:p,inputWasTransposed:h}=Iq(i,r,t),m=c;if(h){let e=t.dataIdMap.get(d.dataId).id;e!==o&&(u=d,l=e,m=Uf.getInnerMostAxes(m.length,u.shape.length))}Uf.assertAxesAreInnerMostDims("mean",m,u.shape.length);let[f,g]=Uf.computeOutAndReduceShapes(u.shape,m),x=Ns.sizeFromShape(g),b=u;"float32"!==u.dtype&&(b=nK({backend:t,inputs:{x:u},attrs:{dtype:"float32"}}),l=t.dataIdMap.get(b.dataId).id);let y=t.makeOutput(f,"float32");if(0!==Ns.sizeFromShape(u.shape)){let e=t.dataIdMap.get(y.dataId).id;mX(l,x,e)}if(h&&t.disposeData(d.dataId),s){let e=Uf.expandShapeToKeepDim(y.shape,p);y.shape=e}return"float32"!==u.dtype&&t.disposeData(b.dataId),y}},JX={kernelName:ja,backendName:"wasm",setupFunc:function(e){fX=e.wasm.cwrap(ja,null,["number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{axis:r,keepDims:s}=a,{x:i}=n,o=t.dataIdMap.get(i.dataId).id,l=o,u=i,{transposed:d,axes:c,originalAxes:p,inputWasTransposed:h}=Iq(i,r,t);if(h){let e=t.dataIdMap.get(d.dataId).id;e!==o&&(u=d,l=e)}let m=u.shape.length;Uf.assertAxesAreInnerMostDims("min",c,m);let[f,g]=Uf.computeOutAndReduceShapes(u.shape,c),x=Ns.sizeFromShape(g),b=t.makeOutput(f,u.dtype);if(0!==Ns.sizeFromShape(u.shape)){let e=t.dataIdMap.get(b.dataId).id;fX(l,QH[i.dtype],x,e)}if(h&&t.disposeData(d.dataId),s){let e=Uf.expandShapeToKeepDim(b.shape,p);b.shape=e}return b}},QX=fq(La);!function(e){e[e.reflect=0]="reflect",e[e.symmetric=1]="symmetric"}(gX||(gX={}));var eY,tY={kernelName:za,backendName:"wasm",kernelFunc:function(e){let{inputs:{x:t},backend:n,attrs:{paddings:a,mode:r}}=e,s=a.map((e,n)=>e[0]+t.shape[n]+e[1]),i=n.dataIdMap.get(t.dataId).id,o=n.makeOutput(s,t.dtype),l=n.dataIdMap.get(o.dataId).id,u=new Uint8Array(new Int32Array(t.shape).buffer),d=a.map(e=>e[0]),c=a.map(e=>e[1]),p=new Uint8Array(new Int32Array(d).buffer),h=new Uint8Array(new Int32Array(c).buffer);return xX(i,u,t.shape.length,QH[t.dtype],p,h,gX[r],l),o},setupFunc:function(e){xX=e.wasm.cwrap(za,null,["number","array","number","number","array","array","number","number"])}};function nY(e){let{backend:t,inputs:{logits:n},attrs:{dim:a}}=e,r=t.dataIdMap.get(n.dataId).id,s=t.makeOutput(n.shape,n.dtype),i=t.dataIdMap.get(s.dataId).id,o=n.shape[a],l=Ns.sizeFromShape(n.shape)/o;return 0===Ns.sizeFromShape(s.shape)||eY(r,i,o,l),s}var aY,rY,sY={kernelName:Fr,backendName:"wasm",setupFunc:function(e){eY=e.wasm.cwrap(Fr,null,["number","number","number","number"])},kernelFunc:nY},iY={kernelName:Ba,backendName:"wasm",setupFunc:function(e){aY=e.wasm.cwrap(Ba,null,["number","number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{logits:r}=t,{numSamples:s,seed:i,normalized:o}=a;if("float32"!==r.dtype)throw new Error(`Tensor logits must have dtype float32, got ${r.dtype}`);let l=o?r:nY({inputs:{logits:r},backend:n,attrs:{dim:r.shape.length-1}}),[u,d]=l.shape,c=n.makeOutput([u,s],"int32");return aY(n.dataIdMap.get(l.dataId).id,u,d,s,i,n.dataIdMap.get(c.dataId).id),o||n.disposeData(l.dataId),c}},oY=fq(Pa),lY=fq(Wa),uY=cq(Va);function dY(e,t){let n=new Int32Array(e.wasm.HEAPU8.buffer,t,4),a=n[0],r=n[1],s=n[2],i=n[3];return e.wasm._free(t),{pSelectedIndices:a,selectedSize:r,pSelectedScores:s,pValidOutputs:i}}var cY,pY,hY,mY,fY,gY,xY,bY,yY,wY,vY,kY,NY,SY,IY,_Y,CY,TY,EY,AY={kernelName:Ga,backendName:"wasm",setupFunc:function(e){rY=e.wasm.cwrap(Ga,"number",["number","number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{iouThreshold:r,maxOutputSize:s,scoreThreshold:i}=a,{boxes:o,scores:l}=n,u=t.dataIdMap.get(o.dataId).id,d=t.dataIdMap.get(l.dataId).id,c=rY(u,d,s,r,i),{pSelectedIndices:p,selectedSize:h,pSelectedScores:m,pValidOutputs:f}=dY(t,c);return t.wasm._free(m),t.wasm._free(f),t.makeOutput([h],"int32",p)}},$Y={kernelName:Ha,backendName:"wasm",setupFunc:function(e){cY=e.wasm.cwrap(Ha,"number",["number","number","number","number","number","bool"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{iouThreshold:r,maxOutputSize:s,scoreThreshold:i,padToMaxOutputSize:o}=a,{boxes:l,scores:u}=n,d=t.dataIdMap.get(l.dataId).id,c=t.dataIdMap.get(u.dataId).id,p=cY(d,c,s,r,i,o),{pSelectedIndices:h,selectedSize:m,pSelectedScores:f,pValidOutputs:g}=dY(t,p);return t.wasm._free(f),[t.makeOutput([m],"int32",h),t.makeOutput([],"int32",g)]}},RY={kernelName:qa,backendName:"wasm",setupFunc:function(e){pY=e.wasm.cwrap(qa,"number",["number","number","number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{iouThreshold:r,maxOutputSize:s,scoreThreshold:i,softNmsSigma:o}=a,{boxes:l,scores:u}=n,d=t.dataIdMap.get(l.dataId).id,c=t.dataIdMap.get(u.dataId).id,p=pY(d,c,s,r,i,o),{pSelectedIndices:h,selectedSize:m,pSelectedScores:f,pValidOutputs:g}=dY(t,p);return t.wasm._free(g),[t.makeOutput([m],"int32",h),t.makeOutput([m],"float32",f)]}},FY=fq(Ua,0,"bool"),DY={kernelName:Xa,backendName:"wasm",setupFunc:function(e){hY=e.wasm.cwrap(Xa,null,["number","number","number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{indices:r}=t,{dtype:s,depth:i,onValue:o,offValue:l}=a,u=n.makeOutput([...r.shape,i],s),d=n.dataIdMap.get(u.dataId).id,c=n.dataIdMap.get(r.dataId).id;return hY(c,i,o,l,d),u}},MY={kernelName:Ka,backendName:"wasm",kernelFunc:function(e){let{inputs:{x:t},backend:n}=e,a=n.makeOutput(t.shape,t.dtype);return n.typedArrayFromHeap(a).fill(1),a}},OY={kernelName:Ya,backendName:"wasm",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{axis:r}=a;if(1===t.length)return KK({inputs:{input:t[0]},backend:n,attrs:{dim:r}});let s=t[0].shape,i=t[0].dtype;t.forEach(e=>{Ns.assertShapesMatch(s,e.shape,"All tensors passed to stack must have matching shapes"),Ns.assert(i===e.dtype,()=>"All tensors passed to stack must have matching dtypes")});let o=[],l=oK({inputs:t.map(e=>{let t=KK({inputs:{input:e},backend:n,attrs:{dim:r}});return o.push(t),t}),backend:n,attrs:{axis:r}});return o.forEach(e=>n.disposeData(e.dataId)),l}},jY={kernelName:Za,backendName:"wasm",kernelFunc:function(e){let{inputs:{x:t},backend:n,attrs:{paddings:a,constantValue:r}}=e,s=a.map((e,n)=>e[0]+t.shape[n]+e[1]);if(0===Ns.sizeFromShape(t.shape))return ZK({backend:n,attrs:{shape:s,value:r,dtype:t.dtype}});let i=n.dataIdMap.get(t.dataId).id,o=n.makeOutput(s,t.dtype),l=n.dataIdMap.get(o.dataId).id,u=new Uint8Array(new Int32Array(t.shape).buffer),d=a.map(e=>e[0]),c=a.map(e=>e[1]),p=new Uint8Array(new Int32Array(d).buffer),h=new Uint8Array(new Int32Array(c).buffer);return mY(i,u,t.shape.length,QH[t.dtype],p,h,r,l),o},setupFunc:function(e){mY=e.wasm.cwrap(Za,null,["number","array","number","number","array","array","number","number"])}},LY=fq(Qa),zY={kernelName:er,backendName:"wasm",setupFunc:function(e){fY=e.wasm.cwrap(er,null,["number","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n}=e,{x:a,alpha:r}=t,s=n.dataIdMap.get(a.dataId).id,i=n.dataIdMap.get(r.dataId).id,o=s,l=a,u=l;"float32"!==l.dtype&&(u=nK({backend:n,inputs:{x:a},attrs:{dtype:"float32"}}),o=n.dataIdMap.get(u.dataId).id);let d=n.makeOutput(a.shape,"float32"),c=n.dataIdMap.get(d.dataId).id;return fY(o,i,c),"float32"!==l.dtype&&n.disposeData(u.dataId),d}},PY={kernelName:tr,backendName:"wasm",setupFunc:function(e){gY=e.wasm.cwrap(tr,null,["number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{axis:r,keepDims:s}=a,{x:i}=n,o=t.dataIdMap.get(i.dataId).id,l=o,u=i,{transposed:d,axes:c,originalAxes:p,inputWasTransposed:h}=Iq(i,r,t),m=c;if(h){let e=t.dataIdMap.get(d.dataId).id;e!==o&&(u=d,l=e,m=Uf.getInnerMostAxes(m.length,u.shape.length))}Uf.assertAxesAreInnerMostDims("prod",m,u.shape.length);let[f,g]=Uf.computeOutAndReduceShapes(u.shape,m),x=Ns.sizeFromShape(g),b=t.makeOutput(f,u.dtype);if(0!==Ns.sizeFromShape(u.shape)){let e=t.dataIdMap.get(b.dataId).id;gY(l,x,QH[b.dtype],e)}if(h&&t.disposeData(d.dataId),s){let e=Uf.expandShapeToKeepDim(b.shape,p);b.shape=e}return b}},BY={kernelName:sr,backendName:"wasm",kernelFunc:e=>{let{backend:t,attrs:n}=e,{start:a,stop:r,step:s,dtype:i}=n,o=J$(a,r,s,i),l=t.makeOutput([o.length],i);return t.typedArrayFromHeap(l).set(o),l}},WY=fq(Vn),VY=cq(or),UY=cq(lr),GY=cq(mr),HY={kernelName:pr,backendName:"wasm",setupFunc:function(e){xY=e.wasm.cwrap(pr,null,["number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let t,{backend:n,inputs:a,attrs:r}=e,{images:s}=a,{alignCorners:i,halfPixelCenters:o,size:l}=r,[u,d]=l,[c,p,h,m]=s.shape,f=[c,u,d,m],g=n.dataIdMap.get(s.dataId);"float32"!==g.dtype&&(t=nK({backend:n,inputs:{x:s},attrs:{dtype:"float32"}}),g=n.dataIdMap.get(t.dataId));let x=g.id,b=n.makeOutput(f,"float32");if(0===Ns.sizeFromShape(s.shape))return b;let y=n.dataIdMap.get(b.dataId).id;return xY(x,c,p,h,m,u,d,i?1:0,o?1:0,y),null!=t&&n.disposeData(t.dataId),b}},qY={kernelName:hr,backendName:"wasm",setupFunc:function(e){bY=e.wasm.cwrap(hr,null,["number","number","number","array","array","boolean"])},kernelFunc:function(e){let t,{inputs:n,backend:a,attrs:r}=e,{images:s,dy:i}=n,{alignCorners:o}=r,l=a.makeOutput(s.shape,"float32"),u=a.dataIdMap.get(s.dataId);return"float32"!==u.dtype&&(t=nK({backend:a,inputs:{x:s},attrs:{dtype:"float32"}}),u=a.dataIdMap.get(t.dataId)),bY(a.dataIdMap.get(s.dataId).id,a.dataIdMap.get(i.dataId).id,a.dataIdMap.get(l.dataId).id,new Uint8Array(new Int32Array(s.shape).buffer),new Uint8Array(new Int32Array(i.shape).buffer),o),null!=t&&a.disposeData(t.dataId),l}},KY={kernelName:dr,backendName:"wasm",setupFunc:function(e){yY=e.wasm.cwrap(dr,null,["number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{images:r}=n,{alignCorners:s,halfPixelCenters:i,size:o}=a,[l,u]=o,[d,c,p,h]=r.shape,m=[d,l,u,h],f=t.makeOutput(m,"float32");if(0===Ns.sizeFromShape(r.shape))return f;let g,x=t.dataIdMap.get(r.dataId);"float32"!==x.dtype&&(g=nK({backend:t,inputs:{x:r},attrs:{dtype:"float32"}}),x=t.dataIdMap.get(g.dataId));let b=x.id,y=t.dataIdMap.get(f.dataId).id;return yY(b,d,c,p,h,l,u,s?1:0,i?1:0,y),null!=g&&t.disposeData(g.dataId),f}},XY={kernelName:cr,backendName:"wasm",setupFunc:function(e){wY=e.wasm.cwrap(cr,null,["number","number","number","array","array","boolean"])},kernelFunc:function(e){let t,{inputs:n,backend:a,attrs:r}=e,{images:s,dy:i}=n,{alignCorners:o}=r,l=a.makeOutput(s.shape,"float32"),u=a.dataIdMap.get(s.dataId);return"float32"!==u.dtype&&(t=nK({backend:a,inputs:{x:s},attrs:{dtype:"float32"}}),u=a.dataIdMap.get(t.dataId)),wY(a.dataIdMap.get(s.dataId).id,a.dataIdMap.get(i.dataId).id,a.dataIdMap.get(l.dataId).id,new Uint8Array(new Int32Array(s.shape).buffer),new Uint8Array(new Int32Array(i.shape).buffer),o),null!=t&&a.disposeData(t.dataId),l}},YY={kernelName:fr,backendName:"wasm",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{dims:s}=a,i=Ns.parseAxisParam(s,r.shape);if(0===r.shape.length)return yq({inputs:{x:r},backend:n});let o=n.makeOutput(r.shape,r.dtype),l=n.dataIdMap.get(r.dataId).id,u=n.dataIdMap.get(o.dataId).id,d=new Uint8Array(new Int32Array(i).buffer),c=new Uint8Array(new Int32Array(r.shape).buffer);vY(l,d,i.length,c,r.shape.length,u);let p=Gq({inputs:{x:o},attrs:{shape:r.shape},backend:n});return n.disposeData(o.dataId),p},setupFunc:function(e){vY=e.wasm.cwrap(fr,null,["number","array","number","array","number","number"])}},ZY={kernelName:is,backendName:"wasm",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{image:r}=t,{radians:s,fillValue:i,center:o}=a,l=n.makeOutput(r.shape,r.dtype),u=n.dataIdMap.get(r.dataId).id,d=n.dataIdMap.get(l.dataId).id,[c,p,h,m]=r.shape,[f,g]=Uf.getImageCenter(o,p,h),x="number"==typeof i?[i,i,i,0===i?0:255]:[...i,255],b=new Uint8Array(new Int32Array(x).buffer);return kY(u,c,p,h,m,s,f,g,b,x.length,d),l},setupFunc:function(e){kY=e.wasm.cwrap(is,null,["number","number","number","number","number","number","number","number","array","number","number"])}},JY=cq(gr),QY=cq(xr),eZ={kernelName:br,backendName:"wasm",setupFunc:function(e){NY=e.wasm.cwrap(br,null,["number","number","number","number","number","number","array","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{indices:r,updates:s}=n,{shape:i}=a,o=t.makeOutput(i,s.dtype);if(0===Ns.sizeFromShape(i))return o;let{sliceRank:l,numUpdates:u,sliceSize:d,strides:c,outputSize:p}=zp.calculateShapes(s,r,i),h=t.dataIdMap.get(r.dataId).id,m=t.dataIdMap.get(s.dataId).id,f=new Uint8Array(new Int32Array(c).buffer),g=t.dataIdMap.get(o.dataId).id;return NY(h,m,QH[s.dtype],l,u,d,f,p,g),o}},tZ={kernelName:wr,backendName:"wasm",setupFunc:function(e){SY=e.wasm.cwrap(wr,null,["number","number","number","number","number","number","bool","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{sortedSequence:r,values:s}=t,{side:i}=a;if(r.dtype!==s.dtype)throw new Error(`SearchSorted error: sorted_sequence must have the same dtype as values. Got ${r.dtype} and ${s.dtype}`);let o=n.makeOutput(s.shape,"int32");function l(e){return n.dataIdMap.get(e.dataId).id}return SY(l(r),l(s),r.shape[0],r.shape[1],s.shape[1],QH[r.dtype],"left"===i,l(o)),o}},nZ={kernelName:vr,backendName:"wasm",kernelFunc:function(e){let{inputs:t,backend:n}=e,{condition:a,t:r,e:s}=t,i=n.dataIdMap.get(a.dataId).id,o=n.dataIdMap.get(r.dataId).id,l=n.dataIdMap.get(s.dataId).id,u=n.makeOutput(r.shape,r.dtype),d=n.dataIdMap.get(u.dataId).id,c=a.shape.length,p=r.shape.length,h=0===c||c>1||1===p?1:Ns.sizeFromShape(r.shape.slice(1));return IY(i,o,l,h,d),u},setupFunc:function(e){IY=e.wasm.cwrap("SelectV2",null,["number","number","number","number","number"])}},aZ=cq(kr),rZ={kernelName:"Sigmoid",backendName:"wasm",setupFunc:function(e){_Y=e.wasm.cwrap(Cr,null,["number","number"])},kernelFunc:function(e){let{backend:t,inputs:{x:n}}=e,a=t.dataIdMap.get(n.dataId).id,r=t.makeOutput(n.shape,n.dtype),s=t.dataIdMap.get(r.dataId).id;return 0===Ns.sizeFromShape(r.shape)||_Y(a,s),r}},sZ=cq(_r),iZ=cq(Sr),oZ=cq(Ir),lZ=cq(Tr),uZ={kernelName:$r,backendName:"wasm",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,{blockShape:s,paddings:i}=a,o=Ns.sizeFromShape(s),l=[[0,0]];l.push(...i);for(let g=1+s.length;g<r.shape.length;++g)l.push([0,0]);let u=jY.kernelFunc({inputs:{x:r},backend:n,attrs:{paddings:l,constantValue:0}}),d=Uf.getReshaped(u.shape,s,o,!1),c=Uf.getPermuted(d.length,s.length,!1),p=Uf.getReshapedPermuted(u.shape,s,o,!1),h=Gq({inputs:{x:u},backend:n,attrs:{shape:d}}),m=kq({inputs:{x:h},backend:n,attrs:{perm:c}}),f=Gq({inputs:{x:m},backend:n,attrs:{shape:p}});return n.disposeData(u.dataId),n.disposeData(h.dataId),n.disposeData(m.dataId),f}},dZ={kernelName:Dr,backendName:"wasm",setupFunc:function(e){CY=e.wasm.cwrap("SparseFillEmptyRows","number",["number","number","number","number","number","number","number","number","number","number","number","number"])},kernelFunc:function(e){let t,{backend:n,inputs:a}=e,{indices:r,values:s,denseShape:i,defaultValue:o}=a,l=r.shape[0],u=r.shape[1],d=n.readSync(i.dataId)[0],c=[l+d,u],p=n.dataIdMap.get(r.dataId).id,h=n.dataIdMap.get(s.dataId).id,m=n.dataIdMap.get(o.dataId).id,f=n.makeOutput(c,r.dtype),g=n.dataIdMap.get(f.dataId).id,x=n.makeOutput(c.slice(0,1),s.dtype),b=n.dataIdMap.get(x.dataId).id,y=n.makeOutput([d],"bool"),w=n.dataIdMap.get(y.dataId).id,v=n.makeOutput([l],r.dtype),k=n.dataIdMap.get(v.dataId).id,N=n.makeOutput([4],"int32"),S=n.dataIdMap.get(N.dataId).id,I=CY(p,h,QH[s.dtype],l,d,u,m,g,b,w,k,S),_=n.readSync(N.dataId);switch(_[0]){case 1:t=Uf.getSparseFillEmptyRowsIndicesDenseShapeMismatch(_[1]);break;case 2:t=Uf.getSparseFillEmptyRowsNegativeIndexErrorMessage(_[1],_[2]);break;case 3:t=Uf.getSparseFillEmptyRowsOutOfRangeIndexErrorMessage(_[1],_[2],_[3]);break;default:t=""}if(n.disposeData(N.dataId),t)throw n.disposeData(f.dataId),n.disposeData(x.dataId),n.disposeData(y.dataId),n.disposeData(v.dataId),new Error(t);let C=f,T=x;return I!==c[0]&&(C=Xq({inputs:{x:f},attrs:{begin:0,size:[I,u]},backend:n}),T=Xq({inputs:{x:x},attrs:{begin:0,size:I},backend:n}),n.disposeData(f.dataId),n.disposeData(x.dataId)),[C,T,y,v]}},cZ={kernelName:Mr,backendName:"wasm",setupFunc:function(e){TY=e.wasm.cwrap(Mr,null,["number","number","number","number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n}=e,{inputIndices:a,inputShape:r,newShape:s}=n;if(2!==a.shape.length)throw new Error(`Input indices should be a matrix but received shape\n        ${a.shape}`);if(1!==r.shape.length)throw new Error(`Input shape should be a vector but received shape\n        ${r.shape}`);if(1!==s.shape.length)throw new Error(`Target shape should be a vector but received shape ${s.shape}`);let i=t.dataIdMap.get(a.dataId).id,o=t.dataIdMap.get(r.dataId).id,l=t.dataIdMap.get(s.dataId).id,u=a.shape[0],d=Ns.sizeFromShape(s.shape),c=t.makeOutput([u,d],a.dtype),p=t.dataIdMap.get(c.dataId).id,h=t.makeOutput([d],s.dtype),m=t.dataIdMap.get(h.dataId).id,f=t.makeOutput([3],"int32"),g=t.dataIdMap.get(f.dataId).id;TY(i,o,l,u,p,m,g);let x,b=t.readSync(f.dataId);switch(b[0]){case 0:x=Uf.getSparseReshapeMultipleNegativeOneOutputDimErrorMessage(b[1],b[2]);break;case 1:x=Uf.getSparseReshapeNegativeOutputDimErrorMessage(b[1],b[2]);break;case 2:x=Uf.getSparseReshapeEmptyTensorZeroOutputDimErrorMessage();break;case 3:{let e=Array.from(t.readSync(r.dataId)),n=Array.from(t.readSync(h.dataId));x=Uf.getSparseReshapeInputOutputMultipleErrorMessage(e,n);break}case 4:{let e=Array.from(t.readSync(r.dataId)),n=Array.from(t.readSync(h.dataId));x=Uf.getSparseReshapeInputOutputMismatchErrorMessage(e,n);break}default:x=""}if(t.disposeData(f.dataId),x)throw t.disposeData(c.dataId),t.disposeData(h.dataId),new Error(x);return[c,h]}};function pZ(e){EY=e.wasm.cwrap("SparseSegmentReduction",null,["number","number","number","number","number","number","number","number","number"])}function hZ(e,t){let{backend:n,inputs:a}=e,{data:r,indices:s,segmentIds:i}=a,o=s.shape[0],l=n.readSync(i.dataId,o-1,o)[0],u=o>0?l+1:0;if(u<0)throw new Error(Uf.getSparseSegmentReductionNegativeSegmentIdsErrorMessage());let d=r.shape.slice();d[0]=u;let c=n.dataIdMap.get(r.dataId).id,p=n.dataIdMap.get(s.dataId).id,h=n.dataIdMap.get(i.dataId).id,m=n.makeOutput(d,r.dtype),f=n.dataIdMap.get(m.dataId).id,g=n.makeOutput([4],"int32"),x=n.dataIdMap.get(g.dataId).id;EY(c,QH[r.dtype],r.shape[0],p,h,f,x,t,0);let b,y=n.readSync(g.dataId);switch(y[0]){case 0:b=Uf.getSparseSegmentReductionNegativeSegmentIdsErrorMessage();break;case 1:b=Uf.getSparseSegmentReductionNonIncreasingSegmentIdsErrorMessage();break;case 2:b=Uf.getSparseSegmentReductionSegmentIdOutOfRangeErrorMessage(y[1],y[2]);break;case 3:b=Uf.getSparseSegmentReductionIndicesOutOfRangeErrorMessage(y[1],y[2],y[3]);break;default:b=""}if(n.disposeData(g.dataId),b)throw n.disposeData(m.dataId),new Error(b);return m}var mZ,fZ,gZ,xZ,bZ,yZ,wZ,vZ,kZ={kernelName:Or,backendName:"wasm",setupFunc:pZ,kernelFunc:function(e){return hZ(e,!0)}},NZ={kernelName:jr,backendName:"wasm",setupFunc:pZ,kernelFunc:function(e){return hZ(e,!1)}},SZ={kernelName:Lr,backendName:"wasm",setupFunc:function(e){mZ=e.wasm.cwrap(Lr,null,["number","number","number","number","number","number","number","number","array","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{sparseIndices:r,sparseValues:s,defaultValue:i}=n,{outputShape:o}=a,l=t.makeOutput(o,i.dtype);if(0===Ns.sizeFromShape(o))return l;let{sliceRank:u,numUpdates:d,sliceSize:c,strides:p,outputSize:h}=Uf.calculateShapes(s,r,o),m=t.dataIdMap.get(r.dataId).id,f=t.dataIdMap.get(s.dataId).id,g=t.dataIdMap.get(i.dataId).id,x=new Uint8Array(new Int32Array(p).buffer),b=t.dataIdMap.get(l.dataId).id;return mZ(m,f,s.shape.length,g,QH[i.dtype],u,d,c,x,h,b),l}},IZ={kernelName:Rr,backendName:"wasm",kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,{x:r}=t,{numOrSizeSplits:s,axis:i}=n,o=Ns.parseAxisParam(i,r.shape)[0],l=Uf.prepareSplitSize(r,s,o),u=new Array(r.shape.length).fill(0),d=r.shape.slice();return l.map(e=>{let t=[...d];t[o]=e;let n=Xq({inputs:{x:r},attrs:{begin:u,size:t},backend:a});return u[o]+=e,n})}},_Z=cq(Er),CZ=cq(Pr),TZ=fq(zr),EZ={kernelName:rs,backendName:"wasm",setupFunc:function(e){fZ=e.wasm.cwrap(rs,null,["number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{alpha:r}=a,{x:s}=n,i=t.dataIdMap.get(s.dataId).id,o=t.makeOutput(s.shape,s.dtype),l=t.dataIdMap.get(o.dataId).id;return fZ(i,r,QH[s.dtype],l),o}},AZ={kernelName:Wr,backendName:"wasm",setupFunc:function(e){gZ=e.wasm.cwrap(Wr,null,["number","array","number","array","array","array","array","array","number","number"])},kernelFunc:function(e){let t,{backend:n,inputs:a,attrs:r}=e,{x:s}=a,{begin:i,end:o,strides:l,beginMask:u,endMask:d,ellipsisMask:c,newAxisMask:p,shrinkAxisMask:h}=r,{finalShapeSparse:m,finalShape:f,isIdentity:g,sliceDim0:x,isSimpleSlice:b,begin:y,end:w,strides:v}=bf.sliceInfo(s.shape,i,o,l,u,d,c,p,h);if(g)t=Gq({inputs:{x:s},backend:n,attrs:{shape:f}});else if(x||b){Ns.assert(s.shape.length>=1,()=>`Input must have rank at least 1, got: ${s.shape.length}`);let e=bf.computeOutShape(y,w,v),a=Xq({inputs:{x:s},backend:n,attrs:{begin:y,size:e}});t=Gq({inputs:{x:a},backend:n,attrs:{shape:f}}),n.disposeData(a.dataId)}else{let e=n.makeOutput(m,"float32"),a=n.dataIdMap.get(s.dataId).id,r=new Uint8Array(new Int32Array(Ns.computeStrides(s.shape)).buffer),i=new Uint8Array(new Int32Array(y).buffer),o=new Uint8Array(new Int32Array(w).buffer),l=new Uint8Array(new Int32Array(v).buffer),u=new Uint8Array(new Int32Array(m).buffer),d=new Uint8Array(new Int32Array(Ns.computeStrides(m)).buffer),c=n.dataIdMap.get(e.dataId).id;gZ(a,r,s.shape.length,i,o,l,u,d,m.length,c),t=Gq({inputs:{x:e},backend:n,attrs:{shape:f}}),n.disposeData(e.dataId)}return t}},$Z={kernelName:Vr,backendName:"wasm",kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{data:r,dataSplits:s}=n,{separator:i,nGramWidths:o,leftPad:l,rightPad:u,padWidth:d,preserveShortSequences:c}=a,p=t.readSync(r.dataId),h=t.readSync(s.dataId),[m,f]=NR(p,h,i,o,l,u,d,c),g=t.makeOutput([m.length],"string");t.dataIdMap.get(g.dataId).stringBytes=m;let x=t.makeOutput(s.shape,"int32");return t.typedArrayFromHeap(x).set(f),[g,x]}},RZ={kernelName:Ur,backendName:"wasm",kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{input:r,delimiter:s}=n,{skipEmpty:i}=a,o=t.readSync(r.dataId),l=t.readSync(s.dataId),[u,d,c]=IR(o,l[0],i),p=d.length,h=t.makeOutput([p,2],"int32");t.typedArrayFromHeap(h).set(u);let m=t.makeOutput([p],"string");t.dataIdMap.get(m.dataId).stringBytes=d;let f=t.makeOutput([2],"int32");return t.typedArrayFromHeap(f).set(c),[h,m,f]}},FZ={kernelName:Gr,backendName:"wasm",kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{input:r}=n,{numBuckets:s}=a,i=_R(t.readSync(r.dataId),s),o=t.makeOutput(r.shape,"int32");return t.typedArrayFromHeap(o).set(i),o}},DZ=fq(Hr),MZ={kernelName:Ar,backendName:"wasm",setupFunc:function(e){xZ=e.wasm.cwrap(Ar,null,["number","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{axis:r,keepDims:s}=a,{x:i}=n,o=t.dataIdMap.get(i.dataId).id,l=o,u=i,{transposed:d,axes:c,originalAxes:p,inputWasTransposed:h}=Iq(i,r,t),m=c;if(h){let e=t.dataIdMap.get(d.dataId).id;e!==o&&(u=d,l=e,m=Uf.getInnerMostAxes(m.length,u.shape.length))}Uf.assertAxesAreInnerMostDims("sum",m,u.shape.length);let[f,g]=Uf.computeOutAndReduceShapes(u.shape,m),x=Ns.sizeFromShape(g),b=t.makeOutput(f,u.dtype);if(0!==Ns.sizeFromShape(u.shape)){let e=t.dataIdMap.get(b.dataId).id;xZ(l,x,QH[b.dtype],e)}if(h&&t.disposeData(d.dataId),s){let e=Uf.expandShapeToKeepDim(b.shape,p);b.shape=e}return b}},OZ=cq(qr),jZ=cq(Kr),LZ={kernelName:yr,backendName:"wasm",setupFunc:function(e){bZ=e.wasm.cwrap(yr,null,["number","number","number","number","number","number","array","number","number","number"])},kernelFunc:function(e){let{backend:t,inputs:n,attrs:a}=e,{tensor:r,indices:s,updates:i}=n,o=t.makeOutput(r.shape,r.dtype);if(0===Ns.sizeFromShape(r.shape))return o;let{sliceRank:l,numUpdates:u,sliceSize:d,strides:c,outputSize:p}=zp.calculateShapes(i,s,r.shape),h=t.dataIdMap.get(s.dataId).id,m=t.dataIdMap.get(i.dataId).id,f=t.dataIdMap.get(r.dataId).id,g=new Uint8Array(new Int32Array(c).buffer),x=t.dataIdMap.get(o.dataId).id;return bZ(h,m,QH[i.dtype],l,u,d,g,p,x,f),o}},zZ={kernelName:Xr,backendName:"wasm",setupFunc:function(e){yZ=e.wasm.cwrap(Xr,null,["number","array","number","array","number","number"])},kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{x:r}=t,s=n.dataIdMap.get(r.dataId).id,{reps:i}=a,o=new Array(r.shape.length);for(let p=0;p<o.length;p++)o[p]=r.shape[p]*i[p];let l=new Uint8Array(new Int32Array(r.shape).buffer),u=new Uint8Array(new Int32Array(o).buffer),d=n.makeOutput(o,r.dtype),c=n.dataIdMap.get(d.dataId).id;return yZ(s,l,r.shape.length,u,o.length,QH[d.dtype],c),d}},PZ={kernelName:Yr,backendName:"wasm",setupFunc:function(e){wZ=e.wasm.cwrap(Yr,null,["number","array","number","number","number","bool","number","number"])},kernelFunc:({inputs:e,backend:t,attrs:n})=>{let{x:a}=e,{k:r,sorted:s}=n,i=t.dataIdMap.get(a.dataId).id,o=new Uint8Array(new Int32Array(a.shape).buffer),l=a.shape.slice();l[l.length-1]=r;let u=t.makeOutput(l,a.dtype),d=t.dataIdMap.get(u.dataId).id,c=t.makeOutput(l,"int32"),p=t.dataIdMap.get(c.dataId).id;return wZ(i,o,a.shape.length,QH[a.dtype],r,s,d,p),[u,c]}},BZ={kernelName:Zr,backendName:"wasm",setupFunc:function(e){vZ=e.wasm.cwrap(Zr,null,["number","number","bool","number","number","number","number","number","number","array","number","array","number","number","number","number","number"])},kernelFunc:function(e){let t,{backend:n,inputs:a,attrs:r}=e,{image:s,transforms:i}=a,{interpolation:o,fillMode:l,fillValue:u,outputShape:d}=r,[c,p,h,m]=s.shape,[f,g]=null!=d?d:[p,h],x=[c,f,g,m],b=new Uint8Array(new Int32Array(Ns.computeStrides(s.shape)).buffer),y=new Uint8Array(new Int32Array(Ns.computeStrides(x)).buffer),w=n.makeOutput(x,s.dtype),v=n.dataIdMap.get(w.dataId).id,k=n.dataIdMap.get(s.dataId).id,N=n.dataIdMap.get(i.dataId).id,S="nearest"===o?1:2;switch(l){case"constant":default:t=1;break;case"reflect":t=2;break;case"wrap":t=3;break;case"nearest":t=4}return vZ(k,N,i.shape[0]>1,c,f,g,m,h,p,b,s.shape.length-1,y,x.length-1,S,t,u,v),w}},WZ={kernelName:Qr,backendName:"wasm",kernelFunc:function(e){let{inputs:t,attrs:n,backend:a}=e,{axis:r}=n,{x:s}=t,{outputValues:i,outputShape:o,indices:l}=MR(a.readSync(s.dataId),r,s.shape,s.dtype);return[a.makeOutput(o,s.dtype,void 0,i),a.makeOutput([l.length],"int32",void 0,l)]}},VZ={kernelName:es,backendName:"wasm",kernelFunc:function(e){let{inputs:t,backend:n,attrs:a}=e,{value:r}=t,{axis:s}=a;s<0&&(s+=r.shape.length);let i=r.shape[s],o=r.shape.length,l=new Array(o-1),u=0;for(let h=0;h<o;h++)h!==s&&(l[u++]=r.shape[h]);let d=new Array(i),c=new Array(o).fill(0),p=r.shape.slice();p[s]=1;for(let h=0;h<d.length;h++)c[s]=h,d[h]=Xq({inputs:{x:r},attrs:{begin:c,size:p},backend:n});return d.map(({dataId:e,dtype:t})=>({dataId:e,dtype:t,shape:l}))}},UZ={kernelName:as,backendName:"wasm",kernelFunc:function(e){let{inputs:{x:t},backend:n}=e,a=n.makeOutput(t.shape,t.dtype);return n.typedArrayFromHeap(a).fill(0),a}},GZ=[dq,pq,hq,mq,xq,bq,Cq,Tq,Dq,Mq,Oq,jq,Lq,zq,Pq,Bq,Uq,Wq,Vq,Kq,Jq,Qq,eK,tK,rK,sK,iK,fK,gK,xK,bK,yK,wK,vK,kK,FK,DK,MK,OK,jK,LK,zK,PK,BK,WK,VK,UK,GK,HK,qK,XK,YK,bX,yX,wX,vX,kX,NX,SX,IX,_X,CX,TX,vq,EX,AX,$X,RX,FX,DX,MX,jX,OX,LX,zX,PX,BX,WX,VX,UX,GX,HX,qX,KX,XX,YX,ZX,JX,QX,tY,iY,oY,lY,uY,AY,$Y,RY,FY,DY,MY,OY,jY,LY,zY,PY,BY,WY,VY,UY,GY,qq,HY,qY,KY,XY,YY,ZY,JY,QY,eZ,tZ,nZ,aZ,rZ,sZ,iZ,oZ,Zq,sY,lZ,uZ,dZ,cZ,kZ,NZ,SZ,IZ,_Z,CZ,TZ,EZ,AZ,$Z,RZ,FZ,DZ,MZ,OZ,jZ,LZ,zZ,PZ,BZ,Sq,WZ,VZ,UZ];for(let p1 of GZ)xs(p1);var HZ=Pt();HZ.registerFlag("WASM_HAS_SIMD_SUPPORT",async()=>{try{return WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,10,9,1,7,0,65,0,253,15,26,11]))}catch(ie){return!1}}),HZ.registerFlag("WASM_HAS_MULTITHREAD_SUPPORT",async()=>{if(HZ.get("IS_NODE"))return!1;try{return(new MessageChannel).port1.postMessage(new SharedArrayBuffer(1)),WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,5,4,1,3,1,1,10,11,1,9,0,65,0,254,16,2,0,26,11]))}catch(ie){return!1}});var qZ=be(je()),KZ=be(Le()),XZ=be(ze()),YZ=qZ.default||qZ,ZZ=XZ.default||XZ,JZ=class extends Be{constructor(e){super(),this.wasm=e,this.dataIdNextNumber=1,this.wasm.tfjs.initWithThreadsCount(lJ),uJ=this.wasm.tfjs.getThreadsCount(),this.dataIdMap=new Pe(this,Ji())}write(e,t,n){let a={id:this.dataIdNextNumber++};return this.move(a,e,t,n,1),a}numDataIds(){return this.dataIdMap.numDataIds()}async time(e){let t=Ns.now();return e(),{kernelMs:Ns.now()-t}}move(e,t,n,a,r){let s=this.dataIdNextNumber++;if("string"===a){let i=t;return void this.dataIdMap.set(e,{id:s,stringBytes:i,shape:n,dtype:a,memoryOffset:null,refCount:r})}let i=Ns.sizeFromShape(n),o=i*Ns.bytesPerElement(a),l=this.wasm._malloc(o)>>>0;this.dataIdMap.set(e,{id:s,memoryOffset:l,shape:n,dtype:a,refCount:r}),this.wasm.tfjs.registerTensor(s,i,l),null!=t&&this.wasm.HEAPU8.set(new Uint8Array(t.buffer,t.byteOffset,o),l)}async read(e){return this.readSync(e)}readSync(e,t,n){let{memoryOffset:a,dtype:r,shape:s,stringBytes:i}=this.dataIdMap.get(e);if("string"===r)return null!=t&&0!==t||!(null==n||n>=i.length)?i.slice(t,n):i;t=t||0,n=n||Ns.sizeFromShape(s);let o=Ns.bytesPerElement(r);return function(e,t){switch(t){case"float32":return new Float32Array(e);case"int32":return new Int32Array(e);case"bool":return new Uint8Array(e);default:throw new Error(`Unknown dtype ${t}`)}}(this.wasm.HEAPU8.slice(a+t*o,a+n*o).buffer,r)}disposeData(e,t=!1){if(this.dataIdMap.has(e)){let n=this.dataIdMap.get(e);if(n.refCount--,!t&&n.refCount>0)return!1;this.wasm._free(n.memoryOffset),this.wasm.tfjs.disposeData(n.id),this.dataIdMap.delete(e)}return!0}refCount(e){return this.dataIdMap.has(e)?this.dataIdMap.get(e).refCount:0}incRef(e){let t=this.dataIdMap.get(e);null!=t&&t.refCount++}floatPrecision(){return 32}getMemoryOffset(e){return this.dataIdMap.get(e).memoryOffset}dispose(){this.wasm.tfjs.dispose(),"PThread"in this.wasm&&this.wasm.PThread.terminateAllThreads(),this.wasm=null}memory(){return{unreliable:!1}}makeOutput(e,t,n,a){let r;if(null==n)r=this.write(null!=a?a:null,e,t);else{let a=this.dataIdNextNumber++;r={id:a},this.dataIdMap.set(r,{id:a,memoryOffset:n,shape:e,dtype:t,refCount:1});let s=Ns.sizeFromShape(e);this.wasm.tfjs.registerTensor(a,s,n)}return{dataId:r,shape:e,dtype:t}}typedArrayFromHeap({shape:e,dtype:t,dataId:n}){let a=this.wasm.HEAPU8.buffer,{memoryOffset:r}=this.dataIdMap.get(n),s=Ns.sizeFromShape(e);switch(t){case"float32":return new Float32Array(a,r,s);case"int32":return new Int32Array(a,r,s);case"bool":return new Uint8Array(a,r,s);default:throw new Error(`Unknown dtype ${t}`)}}};function QZ(e,t,n){if(null!=tJ)return tJ;let a="tfjs-backend-wasm.wasm";return e&&t?a="tfjs-backend-wasm-threaded-simd.wasm":e&&(a="tfjs-backend-wasm-simd.wasm"),null!=aJ&&null!=aJ[a]?aJ[a]:n+a}var eJ=["tfjs-backend-wasm.wasm","tfjs-backend-wasm-simd.wasm","tfjs-backend-wasm-threaded-simd.wasm"],tJ=null,nJ=null,aJ={},rJ=!1,sJ=!1;function iJ(e,t=!1){if(Yi(),rJ)throw new Error("The WASM backend was already initialized. Make sure you call `setWasmPath()` before you call `tf.setBackend()` or `tf.ready()`");tJ=e,sJ=t}function oJ(e,t=!1){if(rJ)throw new Error("The WASM backend was already initialized. Make sure you call `setWasmPaths()` before you call `tf.setBackend()` or `tf.ready()`");if("string"==typeof e)nJ=e;else{aJ=e;let t=eJ.filter(e=>null==aJ[e]);if(t.length>0)throw new Error(`There were no entries found for the following binaries: ${t.join(",")}. Please either call setWasmPaths with a map providing a path for each binary, or with a string indicating the directory where all the binaries can be found.`)}sJ=t}var lJ=-1,uJ=-1;function dJ(e){lJ=e}function cJ(){if(-1===uJ)throw new Error("WASM backend not initialized.");return uJ}var pJ="4.22.0";po("wasm",async()=>{let{wasm:e}=await async function(){let[e,t]=await Promise.all([Pt().getAsync("WASM_HAS_SIMD_SUPPORT"),Pt().getAsync("WASM_HAS_MULTITHREAD_SUPPORT")]);return new Promise((n,a)=>{let r={locateFile:(n,a)=>{if(n.endsWith(".worker.js")){let e=KZ.wasmWorkerContents.replace(/\n/g,"\\n"),t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}return n.endsWith(".wasm")?QZ(e,t,null!=nJ?nJ:a):a+n}};sJ&&(r.instantiateWasm=function(e){return(t,n)=>(Ns.fetch(e,{credentials:"same-origin"}).then(a=>{a.ok||t.env.a(`failed to load wasm binary file at '${e}'`),a.arrayBuffer().then(e=>{WebAssembly.instantiate(e,t).then(e=>{n(e.instance,e.module)})})}),{})}(QZ(e,t,null!=nJ?nJ:"")));let s,i=!1;r.onAbort=()=>{i||rJ||(rJ=!0,a({message:"Make sure the server can serve the `.wasm` file relative to the bundled js file. For more details see https://github.com/tensorflow/tfjs/blob/master/tfjs-backend-wasm/README.md#using-bundlers"}))},t&&e&&null==tJ?(r.mainScriptUrlOrBlob=new Blob(["var WasmBackendModuleThreadedSimd = "+YZ.toString()],{type:"text/javascript"}),s=YZ(r)):s=ZZ(r),s.then(e=>{i=!0,rJ=!1,e.tfjs={init:e.cwrap("init",null,[]),initWithThreadsCount:e.cwrap("init_with_threads_count",null,["number"]),getThreadsCount:e.cwrap("get_threads_count","number",[]),registerTensor:e.cwrap("register_tensor",null,["number","number","number"]),disposeData:e.cwrap("dispose_data",null,["number"]),dispose:e.cwrap("dispose",null,[])},n({wasm:e})}).catch(a)})}();return new JZ(e)},2);var hJ="4.22.0",mJ={tfjs:hJ,"tfjs-core":hJ,"tfjs-converter":"4.22.0","tfjs-backend-cpu":"4.22.0","tfjs-backend-webgl":"4.22.0","tfjs-backend-wasm":"4.22.0"};function fJ(e,t,n=!1){if(e.beginPath(),t.slice(1).forEach(({x:n,y:a},r)=>{let s=t[r];e.moveTo(s.x,s.y),e.lineTo(n,a)}),n){let n=t[t.length-1],a=t[0];if(!n||!a)return;e.moveTo(n.x,n.y),e.lineTo(a.x,a.y)}e.stroke()}ue({},{AnchorPosition:()=>nQ,DrawBox:()=>iQ,DrawBoxOptions:()=>sQ,DrawFaceLandmarks:()=>GQ,DrawFaceLandmarksOptions:()=>UQ,DrawTextField:()=>rQ,DrawTextFieldOptions:()=>aQ,drawContour:()=>fJ,drawDetections:()=>oQ,drawFaceExpressions:()=>BQ,drawFaceLandmarks:()=>HQ}),ue({},{computeReshapedDimensions:()=>_J,getCenterPoint:()=>CJ,isDimensions:()=>IJ,isEven:()=>NJ,isFloat:()=>kJ,isTensor:()=>xJ,isTensor1D:()=>bJ,isTensor2D:()=>yJ,isTensor3D:()=>wJ,isTensor4D:()=>vJ,isValidNumber:()=>EJ,isValidProbablitiy:()=>AJ,range:()=>TJ,round:()=>SJ});var gJ=class e{constructor(e,t){if(!EJ(e)||!EJ(t))throw new Error(`Dimensions.constructor - expected width and height to be valid numbers, instead have ${JSON.stringify({width:e,height:t})}`);this._width=e,this._height=t}get width(){return this._width}get height(){return this._height}reverse(){return new e(1/this.width,1/this.height)}};function xJ(e,t){return e instanceof ri&&e.shape.length===t}function bJ(e){return xJ(e,1)}function yJ(e){return xJ(e,2)}function wJ(e){return xJ(e,3)}function vJ(e){return xJ(e,4)}function kJ(e){return e%1!=0}function NJ(e){return e%2==0}function SJ(e,t=2){let n=10**t;return Math.floor(e*n)/n}function IJ(e){return e&&e.width&&e.height}function _J({width:e,height:t},n){let a=n/Math.max(t,e);return new gJ(Math.round(e*a),Math.round(t*a))}function CJ(e){return e.reduce((e,t)=>e.add(t),new $J(0,0)).div(new $J(e.length,e.length))}function TJ(e,t,n){return Array(e).fill(0).map((e,a)=>t+a*n)}function EJ(e){return!!e&&e!==1/0&&e!==-1/0&&!Number.isNaN(e)||0===e}function AJ(e){return EJ(e)&&e>=0&&e<=1}var $J=class e{constructor(e,t){this._x=e,this._y=t}get x(){return this._x}get y(){return this._y}add(t){return new e(this.x+t.x,this.y+t.y)}sub(t){return new e(this.x-t.x,this.y-t.y)}mul(t){return new e(this.x*t.x,this.y*t.y)}div(t){return new e(this.x/t.x,this.y/t.y)}abs(){return new e(Math.abs(this.x),Math.abs(this.y))}magnitude(){return Math.sqrt(this.x**2+this.y**2)}floor(){return new e(Math.floor(this.x),Math.floor(this.y))}},RJ=class e{static isRect(e){return!!e&&[e.x,e.y,e.width,e.height].every(EJ)}static assertIsValidBox(t,n,a=!1){if(!e.isRect(t))throw new Error(`${n} - invalid box: ${JSON.stringify(t)}, expected object with properties x, y, width, height`);if(!a&&(t.width<0||t.height<0))throw new Error(`${n} - width (${t.width}) and height (${t.height}) must be positive numbers`)}constructor(t,n=!0){let a=t||{},r=[a.left,a.top,a.right,a.bottom].every(EJ),s=[a.x,a.y,a.width,a.height].every(EJ);if(!s&&!r)throw new Error(`Box.constructor - expected box to be IBoundingBox | IRect, instead have ${JSON.stringify(a)}`);let[i,o,l,u]=s?[a.x,a.y,a.width,a.height]:[a.left,a.top,a.right-a.left,a.bottom-a.top];e.assertIsValidBox({x:i,y:o,width:l,height:u},"Box.constructor",n),this._x=i,this._y=o,this._width=l,this._height=u}get x(){return this._x}get y(){return this._y}get width(){return this._width}get height(){return this._height}get left(){return this.x}get top(){return this.y}get right(){return this.x+this.width}get bottom(){return this.y+this.height}get area(){return this.width*this.height}get topLeft(){return new $J(this.left,this.top)}get topRight(){return new $J(this.right,this.top)}get bottomLeft(){return new $J(this.left,this.bottom)}get bottomRight(){return new $J(this.right,this.bottom)}round(){let[t,n,a,r]=[this.x,this.y,this.width,this.height].map(e=>Math.round(e));return new e({x:t,y:n,width:a,height:r})}floor(){let[t,n,a,r]=[this.x,this.y,this.width,this.height].map(e=>Math.floor(e));return new e({x:t,y:n,width:a,height:r})}toSquare(){let{x:t,y:n,width:a,height:r}=this,s=Math.abs(a-r);return a<r&&(t-=s/2,a+=s),r<a&&(n-=s/2,r+=s),new e({x:t,y:n,width:a,height:r})}rescale(t){let n=IJ(t)?t.width:t,a=IJ(t)?t.height:t;return new e({x:this.x*n,y:this.y*a,width:this.width*n,height:this.height*a})}pad(t,n){let[a,r,s,i]=[this.x-t/2,this.y-n/2,this.width+t,this.height+n];return new e({x:a,y:r,width:s,height:i})}clipAtImageBorders(t,n){let{x:a,y:r,right:s,bottom:i}=this,o=Math.max(a,0),l=Math.max(r,0),u=s-o,d=i-l,c=Math.min(u,t-o),p=Math.min(d,n-l);return new e({x:o,y:l,width:c,height:p}).floor()}shift(t,n){let{width:a,height:r}=this,s=this.x+t,i=this.y+n;return new e({x:s,y:i,width:a,height:r})}padAtBorders(e,t){let n=this.width+1,a=this.height+1,r=n,s=a,i=this.left,o=this.top,l=this.right,u=this.bottom;return l>t&&(r=-l+t+n,l=t),u>e&&(s=-u+e+a,u=e),i<1&&(s=2-i,i=1),o<1&&(s=2-o,o=1),{dy:1,edy:s,dx:1,edx:r,y:o,ey:u,x:i,ex:l,w:n,h:a}}calibrate(t){return new e({left:this.left+t.left*this.width,top:this.top+t.top*this.height,right:this.right+t.right*this.width,bottom:this.bottom+t.bottom*this.height}).toSquare().round()}},FJ=class extends RJ{constructor(e,t,n,a,r=!1){super({left:e,top:t,right:n,bottom:a},r)}},DJ=class e{constructor(e,t,n,a,r){this._imageDims=new gJ(r.width,r.height),this._score=e,this._classScore=t,this._className=n,this._box=new RJ(a).rescale(this._imageDims)}get score(){return this._score}get classScore(){return this._classScore}get className(){return this._className}get box(){return this._box}get imageDims(){return this._imageDims}get imageWidth(){return this.imageDims.width}get imageHeight(){return this.imageDims.height}get relativeBox(){return new RJ(this._box).rescale(this.imageDims.reverse())}forSize(t,n){return new e(this.score,this.classScore,this.className,this.relativeBox,{width:t,height:n})}},MJ=class e extends DJ{constructor(e,t,n){super(e,e,"",t,n)}forSize(t,n){let{score:a,relativeBox:r,imageDims:s}=super.forSize(t,n);return new e(a,r,s)}};function OJ(e,t,n=!0){let a=Math.max(0,Math.min(e.right,t.right)-Math.max(e.left,t.left))*Math.max(0,Math.min(e.bottom,t.bottom)-Math.max(e.top,t.top));return n?a/(e.area+t.area-a):a/Math.min(e.area,t.area)}function jJ(e,t){return to(()=>{let[n,a,r]=t,s=hu([...e.shape.slice(0,3),1],n,"float32"),i=hu([...e.shape.slice(0,3),1],a,"float32"),o=hu([...e.shape.slice(0,3),1],r,"float32"),l=Yl([s,i,o],3);return Wd(e,l)})}function LJ(e){return 1/(1+Math.exp(-e))}var zJ,PJ=class extends RJ{constructor(e,t,n,a,r=!1){super({x:e,y:t,width:n,height:a},r)}},BJ=class{constructor(e,t,n=new $J(0,0)){let{width:a,height:r}=t;this._imgDims=new gJ(a,r),this._shift=n,this._positions=e.map(e=>e.mul(new $J(a,r)).add(n))}get shift(){return new $J(this._shift.x,this._shift.y)}get imageWidth(){return this._imgDims.width}get imageHeight(){return this._imgDims.height}get positions(){return this._positions}get relativePositions(){return this._positions.map(e=>e.sub(this._shift).div(new $J(this.imageWidth,this.imageHeight)))}forSize(e,t){return new this.constructor(this.relativePositions,{width:e,height:t})}shiftBy(e,t){return new this.constructor(this.relativePositions,this._imgDims,new $J(e,t))}shiftByPoint(e){return this.shiftBy(e.x,e.y)}align(e,t={}){if(e){let n=e instanceof MJ?e.box.floor():new RJ(e);return this.shiftBy(n.x,n.y).align(null,t)}let{useDlibAlignment:n,minBoxPadding:a}={useDlibAlignment:!1,minBoxPadding:.2,...t};return n?this.alignDlib():this.alignMinBbox(a)}alignDlib(){let e=this.getRefPointsForAlignment(),[t,n,a]=e,r=e=>a.sub(e).magnitude(),s=(r(t)+r(n))/2,i=Math.floor(s/.45),o=CJ(e),l=Math.floor(Math.max(0,o.x-.5*i)),u=Math.floor(Math.max(0,o.y-.43*i));return new PJ(l,u,Math.min(i,this.imageWidth+l),Math.min(i,this.imageHeight+u))}alignMinBbox(e){let t=function(e){let t=e.map(e=>e.x),n=e.map(e=>e.y),a=t.reduce((e,t)=>t<e?t:e,1/0),r=n.reduce((e,t)=>t<e?t:e,1/0),s=t.reduce((e,t)=>e<t?t:e,0),i=n.reduce((e,t)=>e<t?t:e,0);return new FJ(a,r,s,i)}(this.positions);return t.pad(t.width*e,t.height*e)}getRefPointsForAlignment(){throw new Error("getRefPointsForAlignment not implemented by base class")}},WJ=class extends BJ{getJawOutline(){return this.positions.slice(0,17)}getLeftEyeBrow(){return this.positions.slice(17,22)}getRightEyeBrow(){return this.positions.slice(22,27)}getNose(){return this.positions.slice(27,36)}getLeftEye(){return this.positions.slice(36,42)}getRightEye(){return this.positions.slice(42,48)}getMouth(){return this.positions.slice(48,68)}getRefPointsForAlignment(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(CJ)}};function VJ(e){return e.detection instanceof MJ}function UJ(e,t){return{...e,detection:t}}function GJ(){let e=window.fetch;if(!e)throw new Error("fetch - missing fetch implementation for browser environment");return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D:CanvasRenderingContext2D,Image:HTMLImageElement,ImageData:ImageData,Video:HTMLVideoElement,createCanvasElement:()=>document.createElement("canvas"),createImageElement:()=>document.createElement("img"),createVideoElement:()=>document.createElement("video"),fetch:e,readFile:()=>{throw new Error("readFile - filesystem not available for browser environment")}}}function HJ(){return"object"==typeof global&&"undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node}function qJ(e){let t="";if(!e&&HJ())try{e=le("fs")}catch(n){t=n.toString()}return{readFile:e?t=>new Promise((n,a)=>{e.readFile(t,(e,t)=>e?a(e):n(t))}):()=>{throw new Error(`readFile - failed to require fs in nodejs environment with error: ${t}`)}}}function KJ(){let e=global.Canvas||global.HTMLCanvasElement,t=global.Image||global.HTMLImageElement,n=global.Video||global.HTMLVideoElement,a=global.fetch,r=qJ();return{Canvas:e||class{},CanvasRenderingContext2D:global.CanvasRenderingContext2D||class{},Image:t||class{},ImageData:global.ImageData||class{},Video:global.HTMLVideoElement||class{},createCanvasElement:()=>{if(e)return new e;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},createImageElement:()=>{if(t)return new t;throw new Error("createImageElement - missing Image implementation for nodejs environment")},createVideoElement:()=>{if(n)return new n;throw new Error("createVideoElement - missing Video implementation for nodejs environment")},fetch:a,...r}}function XJ(){return"object"==typeof window&&"undefined"!=typeof document&&"undefined"!=typeof HTMLImageElement&&"undefined"!=typeof HTMLCanvasElement&&"undefined"!=typeof HTMLVideoElement&&"undefined"!=typeof ImageData&&"undefined"!=typeof CanvasRenderingContext2D}function YJ(e){zJ=e}function ZJ(){return XJ()?YJ(GJ()):HJ()?YJ(KJ()):null}var JJ={getEnv:function(){if(!zJ)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return zJ},setEnv:YJ,initialize:ZJ,createBrowserEnv:GJ,createFileSystem:qJ,createNodejsEnv:KJ,monkeyPatch:function(e){if(zJ||ZJ(),!zJ)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");let{Canvas:t=zJ.Canvas,Image:n=zJ.Image}=e;zJ.Canvas=t,zJ.Image=n,zJ.createCanvasElement=e.createCanvasElement||(()=>new t),zJ.createImageElement=e.createImageElement||(()=>new n),zJ.ImageData=e.ImageData||zJ.ImageData,zJ.Video=e.Video||zJ.Video,zJ.fetch=e.fetch||zJ.fetch,zJ.readFile=e.readFile||zJ.readFile},isBrowser:XJ,isNodejs:HJ};function QJ(e){return JJ.isNodejs()||"string"!=typeof e?e:document.getElementById(e)}function eQ(e){let{Canvas:t,CanvasRenderingContext2D:n}=JJ.getEnv();if(e instanceof n)return e;let a=QJ(e);if(!(a instanceof t))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");let r=a.getContext("2d",{willReadFrequently:!0});if(!r)throw new Error("resolveContext2d - canvas 2d context is null");return r}ZJ();var tQ,nQ=((tQ=nQ||{}).TOP_LEFT="TOP_LEFT",tQ.TOP_RIGHT="TOP_RIGHT",tQ.BOTTOM_LEFT="BOTTOM_LEFT",tQ.BOTTOM_RIGHT="BOTTOM_RIGHT",tQ),aQ=class{constructor(e={}){let{anchorPosition:t,backgroundColor:n,fontColor:a,fontSize:r,fontStyle:s,padding:i}=e;this.anchorPosition=t||"TOP_LEFT",this.backgroundColor=n||"rgba(0, 0, 0, 0.5)",this.fontColor=a||"rgba(255, 255, 255, 1)",this.fontSize=r||14,this.fontStyle=s||"Georgia",this.padding=i||4}},rQ=class e{constructor(t,n,a={}){this.text="string"==typeof t?[t]:t instanceof e?t.text:t,this.anchor=n,this.options=new aQ(a)}measureWidth(e){let{padding:t}=this.options;return this.text.map(t=>e.measureText(t).width).reduce((e,t)=>e<t?t:e,0)+2*t}measureHeight(){let{fontSize:e,padding:t}=this.options;return this.text.length*e+2*t}getUpperLeft(e,t){let{anchorPosition:n}=this.options,a="BOTTOM_RIGHT"===n||"TOP_RIGHT"===n,r="BOTTOM_LEFT"===n||"BOTTOM_RIGHT"===n,s=this.measureWidth(e),i=this.measureHeight(),o=a?this.anchor.x-s:this.anchor.x,l=r?this.anchor.y-i:this.anchor.y;if(t){let{width:e,height:n}=t;return{x:Math.max(Math.min(o,e-s),0),y:Math.max(Math.min(l,n-i),0)}}return{x:o,y:l}}draw(e){let t=QJ(e),n=eQ(t),{backgroundColor:a,fontColor:r,fontSize:s,fontStyle:i,padding:o}=this.options;n.font=`${s}px ${i}`;let l=this.measureWidth(n),u=this.measureHeight();n.fillStyle=a;let d=this.getUpperLeft(n,t);n.fillRect(d.x,d.y,l,u),n.fillStyle=r,this.text.forEach((e,t)=>{let a=o+d.x,r=o+d.y+(t+1)*s;n.fillText(e,a,r)})}},sQ=class{constructor(e={}){let{boxColor:t,lineWidth:n,label:a,drawLabelOptions:r}=e;this.boxColor=t||"rgba(0, 0, 255, 1)",this.lineWidth=n||2,this.label=a;let s={anchorPosition:"BOTTOM_LEFT",backgroundColor:this.boxColor};this.drawLabelOptions=new aQ({...s,...r})}},iQ=class{constructor(e,t={}){this.box=new RJ(e),this.options=new sQ(t)}draw(e){let t=eQ(e),{boxColor:n,lineWidth:a}=this.options,{x:r,y:s,width:i,height:o}=this.box;t.strokeStyle=n,t.lineWidth=a,t.strokeRect(r,s,i,o);let{label:l}=this.options;l&&new rQ([l],{x:r-a/2,y:s},this.options.drawLabelOptions).draw(e)}};function oQ(e,t){(Array.isArray(t)?t:[t]).forEach(t=>{let n=t instanceof MJ?t.score:VJ(t)?t.detection.score:void 0,a=t instanceof MJ?t.box:VJ(t)?t.detection.box:new RJ(t),r=n?`${SJ(n)}`:void 0;new iQ(a,{label:r}).draw(e)})}function lQ(e){let{Image:t,Video:n}=JJ.getEnv();return e instanceof t&&e.complete||e instanceof n&&e.readyState>=3}function uQ(e){let{Image:t,Video:n}=JJ.getEnv();return e instanceof t?new gJ(e.naturalWidth,e.naturalHeight):e instanceof n?new gJ(e.videoWidth,e.videoHeight):new gJ(e.width,e.height)}function dQ({width:e,height:t}){let{createCanvasElement:n}=JJ.getEnv(),a=n();return a.width=e,a.height=t,a}function cQ(e,t){let{ImageData:n}=JJ.getEnv();if(!(e instanceof n||lQ(e)))throw new Error("createCanvasFromMedia - media has not finished loading yet");let{width:a,height:r}=uQ(e),s=dQ({width:a,height:r});return e instanceof n?eQ(s).putImageData(e,0,0):eQ(s).drawImage(e,0,0,a,r),s}function pQ(e){let{Image:t,Canvas:n,Video:a}=JJ.getEnv();return e instanceof t||e instanceof n||e instanceof a}var hQ=class{constructor(e,t=!1){if(this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],this._inputSize=0,!Array.isArray(e))throw new Error(`NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have ${e}`);this._treatAsBatchInput=t,this._batchSize=e.length,e.forEach((e,t)=>{if(wJ(e))return this._imageTensors[t]=e,void(this._inputDimensions[t]=e.shape);if(vJ(e)){let n=e.shape[0];if(1!==n)throw new Error(`NetInput - tf.Tensor4D with batchSize ${n} passed, but not supported in input array`);return this._imageTensors[t]=e,void(this._inputDimensions[t]=e.shape.slice(1))}let n=e instanceof JJ.getEnv().Canvas?e:cQ(e);this._canvases[t]=n,this._inputDimensions[t]=[n.height,n.width,3]})}get imageTensors(){return this._imageTensors}get canvases(){return this._canvases}get isBatchInput(){return this.batchSize>1||this._treatAsBatchInput}get batchSize(){return this._batchSize}get inputDimensions(){return this._inputDimensions}get inputSize(){return this._inputSize}get reshapedInputDimensions(){return TJ(this.batchSize,0,1).map((e,t)=>this.getReshapedInputDimensions(t))}getInput(e){return this.canvases[e]||this.imageTensors[e]}getInputDimensions(e){return this._inputDimensions[e]}getInputHeight(e){return this._inputDimensions[e][0]}getInputWidth(e){return this._inputDimensions[e][1]}getReshapedInputDimensions(e){if("number"!=typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");return _J({width:this.getInputWidth(e),height:this.getInputHeight(e)},this.inputSize)}toBatchTensor(e,t=!0){return this._inputSize=e,to(()=>{let n=TJ(this.batchSize,0,1).map(n=>{let a=this.getInput(n);if(a instanceof ri){let n=vJ(a)?a:hd(a);return n=function(e,t=!1){return to(()=>{let[n,a]=e.shape.slice(1);if(n===a)return e;let r=Math.abs(n-a),s=Math.round(r*(t?.5:1)),i=n>a?2:1,o=t=>{let n=e.shape.slice();return n[i]=t,hu(n,0,"float32")},l=o(s),u=r-l.shape[i],d=[t&&u?o(u):null,e,l].filter(e=>!!e).map(e=>pl(e,"float32"));return Yl(d,i)})}(n,t),(n.shape[1]!==e||n.shape[2]!==e)&&(n=gm.resizeBilinear(n,[e,e],!1,!1)),n.as3D(e,e,3)}if(a instanceof JJ.getEnv().Canvas)return of.fromPixels(function(e,t,n=!1){let{Image:a,Canvas:r}=JJ.getEnv();if(!(e instanceof a||e instanceof r))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");if(t<=0)return dQ({width:1,height:1});let s=uQ(e),i=t/Math.max(s.height,s.width),o=i*s.width,l=i*s.height,u=dQ({width:t,height:t}),d=e instanceof r?e:cQ(e),c=Math.abs(o-l)/2,p=n&&o<l?c:0,h=n&&l<o?c:0;return d.width>0&&d.height>0&&eQ(u).drawImage(d,p,h,o,l),u}(a,e,t));throw new Error(`toBatchTensor - at batchIdx ${n}, expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have ${a}`)});return Ep(n.map(e=>pl(e,"float32"))).as4D(this.batchSize,e,e,3)})}};async function mQ(e){if(e instanceof hQ)return e;let t=Array.isArray(e)?e:[e];if(!t.length)throw new Error("toNetInput - empty array passed as input");let n=t=>Array.isArray(e)?` at input index ${t}:`:"",a=t.map(QJ);return a.forEach((e,a)=>{if(!pQ(e)&&!wJ(e)&&!vJ(e))throw"string"==typeof t[a]?new Error(`toNetInput -${n(a)} string passed, but could not resolve HTMLElement for element id ${t[a]}`):new Error(`toNetInput -${n(a)} expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id`);if(vJ(e)){let t=e.shape[0];if(1!==t)throw new Error(`toNetInput -${n(a)} tf.Tensor4D with batchSize ${t} passed, but not supported in input array`)}}),await Promise.all(a.map(e=>pQ(e)&&function(e){return new Promise((t,n)=>{function a(e){e.currentTarget&&(e.currentTarget.removeEventListener("load",r),e.currentTarget.removeEventListener("error",a),n(e))}function r(e){e.currentTarget&&(e.currentTarget.removeEventListener("load",r),e.currentTarget.removeEventListener("error",a),t(e))}e instanceof JJ.getEnv().Canvas||lQ(e)?t(null):(e.addEventListener("load",r),e.addEventListener("error",a))})}(e))),new hQ(a,Array.isArray(e))}async function fQ(e,t){let{Canvas:n}=JJ.getEnv(),a=e;if(!(e instanceof n)){let t=await mQ(e);if(t.batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");let r=t.getInput(0);a=r instanceof n?r:await async function(e){let t=JJ.getEnv().createCanvasElement(),[n,a,r]=e.shape.slice(vJ(e)?1:0),s=to(()=>e.as3D(n,a,r).toInt());return await of.toPixels(s,t),s.dispose(),t}(r)}let r=eQ(a);return t.map(e=>e instanceof MJ?e.forSize(a.width,a.height).box.floor():e).map(e=>e.clipAtImageBorders(a.width,a.height)).map(({x:e,y:t,width:n,height:a})=>{let s=dQ({width:n,height:a});return n>0&&a>0&&eQ(s).putImageData(r.getImageData(e,t,n,a),0,0),s})}async function gQ(e,t){if(!wJ(e)&&!vJ(e))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(vJ(e)&&e.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return to(()=>{let[n,a,r]=e.shape.slice(vJ(e)?1:0);return t.map(e=>e instanceof MJ?e.forSize(a,n).box:e).map(e=>e.clipAtImageBorders(a,n)).filter(e=>e.width>0&&e.height>0).map(({x:t,y:s,width:i,height:o})=>yp(e.as3D(n,a,r),[s,t,0],[o,i,r]))})}function xQ(e,t){let n=`${t}-weights_manifest.json`;if(!e)return{modelBaseUri:"",manifestUri:n};if("/"===e)return{modelBaseUri:"/",manifestUri:`/${n}`};let a=e.startsWith("http://")?"http://":e.startsWith("https://")?"https://":"",r=(e=e.replace(a,"")).split("/").filter(e=>e),s=e.endsWith(".json")?r[r.length-1]:n,i=a+(e.endsWith(".json")?r.slice(0,r.length-1):r).join("/");return i=e.startsWith("/")?`/${i}`:i,{modelBaseUri:i,manifestUri:"/"===i?`/${s}`:`${i}/${s}`}}var bQ=class{constructor(e){this._params=void 0,this._paramMappings=[],this._name=e}get params(){return this._params}get paramMappings(){return this._paramMappings}get isLoaded(){return!!this.params}getParamFromPath(e){let{obj:t,objProp:n}=this.traversePropertyPath(e);return t[n]}reassignParamFromPath(e,t){let{obj:n,objProp:a}=this.traversePropertyPath(e);n[a].dispose(),n[a]=t}getParamList(){return this._paramMappings.map(({paramPath:e})=>({path:e,tensor:this.getParamFromPath(e)}))}getTrainableParams(){return this.getParamList().filter(e=>e.tensor instanceof ii)}getFrozenParams(){return this.getParamList().filter(e=>!(e.tensor instanceof ii))}variable(){this.getFrozenParams().forEach(({path:e,tensor:t})=>{this.reassignParamFromPath(e,t.variable())})}freeze(){this.getTrainableParams().forEach(({path:e,tensor:t})=>{let n=Ui(t.dataSync());t.dispose(),this.reassignParamFromPath(e,n)})}dispose(e=!0){this.getParamList().forEach(t=>{if(e&&t.tensor.isDisposed)throw new Error(`param tensor has already been disposed for path ${t.path}`);t.tensor.dispose()}),this._params=void 0}serializeParams(){return new Float32Array(this.getParamList().map(({tensor:e})=>Array.from(e.dataSync())).reduce((e,t)=>e.concat(t)))}async load(e){e instanceof Float32Array?this.extractWeights(e):await this.loadFromUri(e)}async loadFromUri(e){if(e&&"string"!=typeof e)throw new Error(`${this._name}.loadFromUri - expected model uri`);let t=await async function(e,t){let{manifestUri:n,modelBaseUri:a}=xQ(e,t),r=await async function(e){return(await async function(e){let{fetch:t}=JJ.getEnv(),n=await t(e,void 0);if(!(n.status<400))throw new Error(`failed to fetch: (${n.status}) ${n.statusText}, from url: ${n.url}`);return n}(e)).json()}(n);return jm.loadWeights(r,a)}(e,this.getDefaultModelName());this.loadFromWeightMap(t)}async loadFromDisk(e){if(e&&"string"!=typeof e)throw new Error(`${this._name}.loadFromDisk - expected model file path`);let{readFile:t}=JJ.getEnv(),{manifestUri:n,modelBaseUri:a}=xQ(e,this.getDefaultModelName()),r=jm.weightsLoaderFactory(e=>Promise.all(e.map(e=>t(e).then(e=>"string"==typeof e?Buffer.from(e):e.buffer)))),s=JSON.parse((await t(n)).toString()),i=await r(s,a);this.loadFromWeightMap(i)}loadFromWeightMap(e){let{paramMappings:t,params:n}=this.extractParamsFromWeightMap(e);this._paramMappings=t,this._params=n}extractWeights(e){let{paramMappings:t,params:n}=this.extractParams(e);this._paramMappings=t,this._params=n}traversePropertyPath(e){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");let t=e.split("/").reduce((t,n)=>{if(!t.nextObj.hasOwnProperty(n))throw new Error(`traversePropertyPath - object does not have property ${n}, for path ${e}`);return{obj:t.nextObj,objProp:n,nextObj:t.nextObj[n]}},{nextObj:this.params}),{obj:n,objProp:a}=t;if(!(n&&a&&n[a]instanceof ri))throw new Error(`traversePropertyPath - parameter is not a tensor, for path ${e}`);return{obj:n,objProp:a}}};function yQ(e,t,n){return to(()=>{let a=pp(e,t.depthwise_filter,t.pointwise_filter,n,"same");return a=fl(a,t.bias),a})}function wQ(e,t,n=!1){return to(()=>{let a=np(n?fl(yu(e,t.conv0.filters,[2,2],"same"),t.conv0.bias):yQ(e,t.conv0,[2,2])),r=yQ(a,t.conv1,[1,1]),s=yQ(np(fl(a,r)),t.conv2,[1,1]);return np(fl(a,fl(r,s)))})}function vQ(e,t,n=!1,a=!0){return to(()=>{let r=np(n?fl(yu(e,t.conv0.filters,a?[2,2]:[1,1],"same"),t.conv0.bias):yQ(e,t.conv0,a?[2,2]:[1,1])),s=yQ(r,t.conv1,[1,1]),i=yQ(np(fl(r,s)),t.conv2,[1,1]),o=yQ(np(fl(r,fl(s,i))),t.conv3,[1,1]);return np(fl(r,fl(s,fl(i,o))))})}function kQ(e,t,n="same",a=!1){return to(()=>{let r=fl(yu(e,t.filters,[1,1],n),t.bias);return a?np(r):r})}function NQ(e,t){Object.keys(e).forEach(n=>{t.some(e=>e.originalPath===n)||e[n].dispose()})}function SQ(e,t){return(n,a,r,s)=>{let i=Op(e(n*a*r*r),[r,r,n,a]),o=Fp(e(a));return t.push({paramPath:`${s}/filters`},{paramPath:`${s}/bias`}),{filters:i,bias:o}}}function IQ(e,t){return(n,a,r)=>{let s=Dp(e(n*a),[n,a]),i=Fp(e(a));return t.push({paramPath:`${r}/weights`},{paramPath:`${r}/bias`}),{weights:s,bias:i}}}var _Q=class{constructor(e,t,n){this.depthwise_filter=e,this.pointwise_filter=t,this.bias=n}};function CQ(e,t){return(n,a,r)=>{let s=Op(e(9*n),[3,3,n,1]),i=Op(e(n*a),[1,1,n,a]),o=Fp(e(a));return t.push({paramPath:`${r}/depthwise_filter`},{paramPath:`${r}/pointwise_filter`},{paramPath:`${r}/bias`}),new _Q(s,i,o)}}function TQ(e){return t=>{let n=e(`${t}/depthwise_filter`,4),a=e(`${t}/pointwise_filter`,4),r=e(`${t}/bias`,1);return new _Q(n,a,r)}}function EQ(e,t){return(n,a,r)=>{let s=e[n];if(!xJ(s,a))throw new Error(`expected weightMap[${n}] to be a Tensor${a}D, instead have ${s}`);return t.push({originalPath:n,paramPath:r||n}),s}}function AQ(e){let t=e;return{extractWeights:function(e){let n=t.slice(0,e);return t=t.slice(e),n},getRemainingWeights:function(){return t}}}function $Q(e,t){let n=SQ(e,t),a=CQ(e,t);function r(e,t,r,s=!1){return{conv0:s?n(e,t,3,`${r}/conv0`):a(e,t,`${r}/conv0`),conv1:a(t,t,`${r}/conv1`),conv2:a(t,t,`${r}/conv2`)}}return{extractDenseBlock3Params:r,extractDenseBlock4Params:function(e,t,n,s=!1){let{conv0:i,conv1:o,conv2:l}=r(e,t,n,s);return{conv0:i,conv1:o,conv2:l,conv3:a(t,t,`${n}/conv3`)}}}}function RQ(e){return t=>({filters:e(`${t}/filters`,4),bias:e(`${t}/bias`,1)})}function FQ(e,t){let n=EQ(e,t),a=RQ(n),r=TQ(n);return{extractDenseBlock3Params:function(e,t=!1){return{conv0:t?a(`${e}/conv0`):r(`${e}/conv0`),conv1:r(`${e}/conv1`),conv2:r(`${e}/conv2`)}},extractDenseBlock4Params:function(e,t=!1){return{conv0:t?a(`${e}/conv0`):r(`${e}/conv0`),conv1:r(`${e}/conv1`),conv2:r(`${e}/conv2`),conv3:r(`${e}/conv3`)}}}}var DQ=class extends bQ{constructor(){super("FaceFeatureExtractor")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("FaceFeatureExtractor - load model before inference");return to(()=>{let n=vQ(jJ(pl(e.toBatchTensor(112,!0),"float32"),[122.782,117.001,104.298]).div(255),t.dense0,!0);return n=vQ(n,t.dense1),n=vQ(n,t.dense2),n=vQ(n,t.dense3),n=Kl(n,[7,7],[2,2],"valid"),n})}async forward(e){return this.forwardInput(await mQ(e))}getDefaultModelName(){return"face_feature_extractor_model"}extractParamsFromWeightMap(e){return function(e){let t=[],{extractDenseBlock4Params:n}=FQ(e,t),a={dense0:n("dense0",!0),dense1:n("dense1"),dense2:n("dense2"),dense3:n("dense3")};return NQ(e,t),{params:a,paramMappings:t}}(e)}extractParams(e){return function(e){let t=[],{extractWeights:n,getRemainingWeights:a}=AQ(e),{extractDenseBlock4Params:r}=$Q(n,t),s=r(3,32,"dense0",!0),i=r(32,64,"dense1"),o=r(64,128,"dense2"),l=r(128,256,"dense3");if(0!==a().length)throw new Error(`weights remaing after extract: ${a().length}`);return{paramMappings:t,params:{dense0:s,dense1:i,dense2:o,dense3:l}}}(e)}};function MQ(e,t){return to(()=>fl(Zl(e,t.weights),t.bias))}function OQ(e){let t={},n={};return Object.keys(e).forEach(a=>{(a.startsWith("fc")?n:t)[a]=e[a]}),{featureExtractorMap:t,classifierMap:n}}var jQ=class extends bQ{constructor(e,t){super(e),this._faceFeatureExtractor=t}get faceFeatureExtractor(){return this._faceFeatureExtractor}runNet(e){let{params:t}=this;if(!t)throw new Error(`${this._name} - load model before inference`);return to(()=>{let n=e instanceof hQ?this.faceFeatureExtractor.forwardInput(e):e;return MQ(n.as2D(n.shape[0],-1),t.fc)})}dispose(e=!0){this.faceFeatureExtractor.dispose(e),super.dispose(e)}loadClassifierParams(e){let{params:t,paramMappings:n}=this.extractClassifierParams(e);this._params=t,this._paramMappings=n}extractClassifierParams(e){return function(e,t,n){let a=[],{extractWeights:r,getRemainingWeights:s}=AQ(e),i=IQ(r,a)(t,n,"fc");if(0!==s().length)throw new Error(`weights remaing after extract: ${s().length}`);return{paramMappings:a,params:{fc:i}}}(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())}extractParamsFromWeightMap(e){let{featureExtractorMap:t,classifierMap:n}=OQ(e);return this.faceFeatureExtractor.loadFromWeightMap(t),function(e){let t=[],n=EQ(e,t),a={fc:{weights:n("fc/weights",2),bias:n("fc/bias",1)}};return NQ(e,t),{params:a,paramMappings:t}}(n)}extractParams(e){let t=this.getClassifierChannelsIn(),n=this.getClassifierChannelsOut(),a=n*t+n,r=e.slice(0,e.length-a),s=e.slice(e.length-a);return this.faceFeatureExtractor.extractWeights(r),this.extractClassifierParams(s)}},LQ=["neutral","happy","sad","angry","fearful","disgusted","surprised"],zQ=class{constructor(e){if(this.neutral=0,this.happy=0,this.sad=0,this.angry=0,this.fearful=0,this.disgusted=0,this.surprised=0,7!==e.length)throw new Error(`FaceExpressions.constructor - expected probabilities.length to be 7, have: ${e.length}`);LQ.forEach((t,n)=>{this[t]=e[n]})}asSortedArray(){return LQ.map(e=>({expression:e,probability:this[e]})).sort((e,t)=>t.probability-e.probability)}};function PQ(e,t){return{...e,expressions:t}}function BQ(e,t,n=.1,a){(Array.isArray(t)?t:[t]).forEach(t=>{let r=t instanceof zQ?t:function(e){return e.expressions instanceof zQ}(t)?t.expressions:void 0;if(!r)throw new Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");let s=r.asSortedArray().filter(e=>e.probability>n),i=VJ(t)?t.detection.box.bottomLeft:a||new $J(0,0);new rQ(s.map(e=>`${e.expression} (${SJ(e.probability)})`),i).draw(e)})}function WQ(e){return VJ(e)&&e.landmarks instanceof BJ&&e.unshiftedLandmarks instanceof BJ&&e.alignedRect instanceof MJ}function VQ(e,t){let{box:n}=e.detection,a=t.shiftBy(n.x,n.y),r=a.align(),{imageDims:s}=e.detection,i=new MJ(e.detection.score,r.rescale(s.reverse()),s),o=function(e){let t=e=>180*e/Math.PI,n=(e,t)=>Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2),a={roll:void 0,pitch:void 0,yaw:void 0};if(!e||!e.positions||68!==e.positions.length)return a;let r=e.positions;return a.roll=((e,n)=>{let a=Math.hypot(n.x-e.x,n.y-e.y),r=n.y-e.y,s=Math.asin(r/a),i=t(s);return Math.floor(90-i)*(n.x-e.x<0?-1:1)})(r[27],r[66]),a.pitch=((e,a,r)=>{let s=n(e,r),i=new $J((e.x+r.x)/2,(e.y+r.y)/2),o=n(a,i),l=Math.atan(o/s);return Math.floor(t(l))*(i.y-a.y<0?-1:1)})(r[14],r[30],r[2]),a.yaw=(s=r[14],i=r[33],o=r[2],Math.floor(s.x-i.x)-Math.floor(i.x-o.x)),a;var s,i,o}(t);return{...e,landmarks:a,unshiftedLandmarks:t,alignedRect:i,angle:o}}var UQ=class{constructor(e={}){let{drawLines:t=!0,drawPoints:n=!0,lineWidth:a,lineColor:r,pointSize:s,pointColor:i}=e;this.drawLines=t,this.drawPoints=n,this.lineWidth=a||1,this.pointSize=s||2,this.lineColor=r||"rgba(0, 255, 255, 1)",this.pointColor=i||"rgba(255, 0, 255, 1)"}},GQ=class{constructor(e,t={}){this.faceLandmarks=e,this.options=new UQ(t)}draw(e){let t=eQ(e),{drawLines:n,drawPoints:a,lineWidth:r,lineColor:s,pointSize:i,pointColor:o}=this.options;if(n&&this.faceLandmarks instanceof WJ&&(t.strokeStyle=s,t.lineWidth=r,fJ(t,this.faceLandmarks.getJawOutline()),fJ(t,this.faceLandmarks.getLeftEyeBrow()),fJ(t,this.faceLandmarks.getRightEyeBrow()),fJ(t,this.faceLandmarks.getNose()),fJ(t,this.faceLandmarks.getLeftEye(),!0),fJ(t,this.faceLandmarks.getRightEye(),!0),fJ(t,this.faceLandmarks.getMouth(),!0)),a){t.strokeStyle=o,t.fillStyle=o;let e=e=>{t.beginPath(),t.arc(e.x,e.y,i,0,2*Math.PI),t.fill()};this.faceLandmarks.positions.forEach(e)}}};function HQ(e,t){(Array.isArray(t)?t:[t]).forEach(t=>{let n=t instanceof BJ?t:WQ(t)?t.landmarks:void 0;if(!n)throw new Error("drawFaceLandmarks - expected faceExpressions to be FaceLandmarks | WithFaceLandmarks<WithFaceDetection<{}>> or array thereof");new GQ(n).draw(e)})}function qQ(e,t,n){return fl(yu(e,t.filters,n,"same"),t.bias)}function KQ(e,t,n=!0){let a=n?np(e):e;return a=yQ(a,t.separable_conv0,[1,1]),a=yQ(np(a),t.separable_conv1,[1,1]),a=Jd(a,[3,3],[2,2],"same"),a=fl(a,qQ(e,t.expansion_conv,[2,2])),a}var XQ,YQ=class extends bQ{constructor(e){super("TinyXception"),this._numMainBlocks=e}forwardInput(e){let{params:t}=this;if(!t)throw new Error("TinyXception - load model before inference");return to(()=>{let n=jJ(pl(e.toBatchTensor(112,!0),"float32"),[122.782,117.001,104.298]).div(255),a=np(qQ(n,t.entry_flow.conv_in,[2,2]));return a=KQ(a,t.entry_flow.reduction_block_0,!1),a=KQ(a,t.entry_flow.reduction_block_1),TJ(this._numMainBlocks,0,1).forEach(e=>{a=function(e,t){let n=yQ(np(e),t.separable_conv0,[1,1]);return n=yQ(np(n),t.separable_conv1,[1,1]),n=yQ(np(n),t.separable_conv2,[1,1]),n=fl(n,e),n}(a,t.middle_flow[`main_block_${e}`])}),a=KQ(a,t.exit_flow.reduction_block),a=np(yQ(a,t.exit_flow.separable_conv,[1,1])),a})}async forward(e){return this.forwardInput(await mQ(e))}getDefaultModelName(){return"tiny_xception_model"}extractParamsFromWeightMap(e){return function(e,t){let n=[],{extractConvParams:a,extractSeparableConvParams:r,extractReductionBlockParams:s,extractMainBlockParams:i}=function(e,t){let n=EQ(e,t),a=RQ(n),r=TQ(n);return{extractConvParams:a,extractSeparableConvParams:r,extractReductionBlockParams:function(e){return{separable_conv0:r(`${e}/separable_conv0`),separable_conv1:r(`${e}/separable_conv1`),expansion_conv:a(`${e}/expansion_conv`)}},extractMainBlockParams:function(e){return{separable_conv0:r(`${e}/separable_conv0`),separable_conv1:r(`${e}/separable_conv1`),separable_conv2:r(`${e}/separable_conv2`)}}}}(e,n),o={conv_in:a("entry_flow/conv_in"),reduction_block_0:s("entry_flow/reduction_block_0"),reduction_block_1:s("entry_flow/reduction_block_1")},l={};TJ(t,0,1).forEach(e=>{l[`main_block_${e}`]=i(`middle_flow/main_block_${e}`)});let u={reduction_block:s("exit_flow/reduction_block"),separable_conv:r("exit_flow/separable_conv")};return NQ(e,n),{params:{entry_flow:o,middle_flow:l,exit_flow:u},paramMappings:n}}(e,this._numMainBlocks)}extractParams(e){return function(e,t){let n=[],{extractWeights:a,getRemainingWeights:r}=AQ(e),{extractConvParams:s,extractSeparableConvParams:i,extractReductionBlockParams:o,extractMainBlockParams:l}=function(e,t){let n=SQ(e,t),a=CQ(e,t);return{extractConvParams:n,extractSeparableConvParams:a,extractReductionBlockParams:function(e,t,r){return{separable_conv0:a(e,t,`${r}/separable_conv0`),separable_conv1:a(t,t,`${r}/separable_conv1`),expansion_conv:n(e,t,1,`${r}/expansion_conv`)}},extractMainBlockParams:function(e,t){return{separable_conv0:a(e,e,`${t}/separable_conv0`),separable_conv1:a(e,e,`${t}/separable_conv1`),separable_conv2:a(e,e,`${t}/separable_conv2`)}}}}(a,n),u={conv_in:s(3,32,3,"entry_flow/conv_in"),reduction_block_0:o(32,64,"entry_flow/reduction_block_0"),reduction_block_1:o(64,128,"entry_flow/reduction_block_1")},d={};TJ(t,0,1).forEach(e=>{d[`main_block_${e}`]=l(128,`middle_flow/main_block_${e}`)});let c={reduction_block:o(128,256,"exit_flow/reduction_block"),separable_conv:i(256,512,"exit_flow/separable_conv")};if(0!==r().length)throw new Error(`weights remaing after extract: ${r().length}`);return{paramMappings:n,params:{entry_flow:u,middle_flow:d,exit_flow:c}}}(e,this._numMainBlocks)}},ZQ=((XQ=ZQ||{}).FEMALE="female",XQ.MALE="male",XQ),JQ=class extends jQ{postProcess(e,t,n){let a=n.map(({width:e,height:n})=>{let a=t/Math.max(n,e);return{width:e*a,height:n*a}}),r=a.length;return to(()=>{let n=(e,t)=>Ep([hu([68],e,"float32"),hu([68],t,"float32")],1).as2D(1,136).as1D(),s=(e,t)=>{let{width:n,height:r}=a[e];return t(n,r)?Math.abs(n-r)/2:0};return e.mul(hu([r,136],t,"float32")).sub(Ep(Array.from(Array(r),(e,t)=>n((e=>s(e,(e,t)=>e<t))(t),(e=>s(e,(e,t)=>t<e))(t))))).div(Ep(Array.from(Array(r),(e,t)=>n(a[t].width,a[t].height))))})}forwardInput(e){return to(()=>{let t=this.runNet(e);return this.postProcess(t,e.inputSize,e.inputDimensions.map(([e,t])=>({height:e,width:t})))})}async forward(e){return this.forwardInput(await mQ(e))}async detectLandmarks(e){let t=await mQ(e),n=to(()=>Kp(this.forwardInput(t))),a=await Promise.all(n.map(async(e,n)=>{let a=Array.from(e.dataSync()),r=a.filter((e,t)=>NJ(t)),s=a.filter((e,t)=>!NJ(t));return new WJ(Array(68).fill(0).map((e,t)=>new $J(r[t],s[t])),{height:t.getInputHeight(n),width:t.getInputWidth(n)})}));return n.forEach(e=>e.dispose()),t.isBatchInput?a:a[0]}getClassifierChannelsOut(){return 136}},QQ=class extends bQ{constructor(){super("TinyFaceFeatureExtractor")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("TinyFaceFeatureExtractor - load model before inference");return to(()=>{let n=wQ(jJ(pl(e.toBatchTensor(112,!0),"float32"),[122.782,117.001,104.298]).div(255),t.dense0,!0);return n=wQ(n,t.dense1),n=wQ(n,t.dense2),n=Kl(n,[14,14],[2,2],"valid"),n})}async forward(e){return this.forwardInput(await mQ(e))}getDefaultModelName(){return"face_feature_extractor_tiny_model"}extractParamsFromWeightMap(e){return function(e){let t=[],{extractDenseBlock3Params:n}=FQ(e,t),a={dense0:n("dense0",!0),dense1:n("dense1"),dense2:n("dense2")};return NQ(e,t),{params:a,paramMappings:t}}(e)}extractParams(e){return function(e){let t=[],{extractWeights:n,getRemainingWeights:a}=AQ(e),{extractDenseBlock3Params:r}=$Q(n,t),s=r(3,32,"dense0",!0),i=r(32,64,"dense1"),o=r(64,128,"dense2");if(0!==a().length)throw new Error(`weights remaing after extract: ${a().length}`);return{paramMappings:t,params:{dense0:s,dense1:i,dense2:o}}}(e)}};function e0(e,t,n,a,r="same"){let{filters:s,bias:i}=t.conv,o=yu(e,s,n,r);return o=fl(o,i),o=function(e,t){return fl(bl(e,t.weights),t.biases)}(o,t.scale),a?np(o):o}function t0(e,t){return e0(e,t,[1,1],!1)}function n0(e,t){return e0(e,t,[2,2],!0,"valid")}function a0(e,t){function n(n,a,r,s){let i=function(n,a,r,s){let i=function(t,n,a){let r=e(t),s=r.length/(n*a*a);if(kJ(s))throw new Error(`depth has to be an integer: ${s}, weights.length: ${r.length}, numFilters: ${n}, filterSize: ${a}`);return to(()=>eh(Op(r,[n,s,a,a]),[2,3,1,0]))}(n,a,r),o=Fp(e(a));return t.push({paramPath:`${s}/filters`},{paramPath:`${s}/bias`}),{filters:i,bias:o}}(n,a,r,`${s}/conv`),o=function(n,a){let r=Fp(e(n)),s=Fp(e(n));return t.push({paramPath:`${a}/weights`},{paramPath:`${a}/biases`}),{weights:r,biases:s}}(a,`${s}/scale`);return{conv:i,scale:o}}return{extractConvLayerParams:n,extractResidualLayerParams:function(e,t,a,r,s=!1){return{conv1:n((s?.5:1)*e,t,a,`${r}/conv1`),conv2:n(e,t,a,`${r}/conv2`)}}}}function r0(e,t){let n=function(e,t){return e0(e,t,[1,1],!0)}(e,t.conv1);return n=t0(n,t.conv2),n=fl(n,e),n=np(n),n}function s0(e,t){let n=n0(e,t.conv1);n=t0(n,t.conv2);let a=Kl(e,2,2,"valid"),r=ac(a.shape),s=a.shape[3]!==n.shape[3];if(a.shape[1]!==n.shape[1]||a.shape[2]!==n.shape[2]){let e=[...n.shape];e[1]=1;let t=ac(e);n=Yl([n,t],1);let a=[...n.shape];a[2]=1;let r=ac(a);n=Yl([n,r],2)}return a=s?Yl([a,r],3):a,n=fl(a,n),n=np(n),n}function i0(e,t){return{...e,descriptor:t}}function o0(e,t){return{...e,age:t}}function l0(e,t,n){return{...e,gender:t,genderProbability:n}}function u0(e,t,n){return to(()=>{let a=yu(e,t.filters,n,"same");return a=fl(a,t.batch_norm_offset),mu(a,0,6)})}function d0(e,t,n){let a=e.arraySync(),r=Math.min(a[t][0],a[t][2]),s=Math.min(a[t][1],a[t][3]),i=Math.max(a[t][0],a[t][2]),o=Math.max(a[t][1],a[t][3]),l=Math.min(a[n][0],a[n][2]),u=Math.min(a[n][1],a[n][3]),d=Math.max(a[n][0],a[n][2]),c=Math.max(a[n][1],a[n][3]),p=(i-r)*(o-s),h=(d-l)*(c-u);if(p<=0||h<=0)return 0;let m=Math.max(r,l),f=Math.max(s,u),g=Math.min(i,d),x=Math.min(o,c),b=Math.max(g-m,0)*Math.max(x-f,0);return b/(p+h-b)}function c0(e,t){return to(()=>{let n=e.shape[0];return{boxPredictionEncoding:ql(kQ(e,t.box_encoding_predictor),[n,-1,1,4]),classPrediction:ql(kQ(e,t.class_predictor),[n,-1,3])}})}var p0=class{constructor({minConfidence:e,maxResults:t}={}){if(this._name="SsdMobilenetv1Options",this._minConfidence=e||.5,this._maxResults=t||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||this._minConfidence>=1)throw new Error(`${this._name} - expected minConfidence to be a number between 0 and 1`);if("number"!=typeof this._maxResults)throw new Error(`${this._name} - expected maxResults to be a number`)}get minConfidence(){return this._minConfidence}get maxResults(){return this._maxResults}},h0=[new $J(.738768,.874946),new $J(2.42204,2.65704),new $J(4.30971,7.04493),new $J(10.246,4.59428),new $J(12.6868,11.8741)],m0=[new $J(1.603231,2.094468),new $J(6.041143,7.080126),new $J(2.882459,3.518061),new $J(4.266906,5.178857),new $J(9.041765,10.66308)],f0=[117.001,114.697,97.404],g0=e=>"number"==typeof e;function x0(e){return to(()=>{let t=bl(e,sd(.10000000149011612));return fl(np(Wd(e,t)),t)})}function b0(e,t){return to(()=>{let n=gc(e,[[0,0],[1,1],[1,1],[0,0]]);return n=yu(n,t.conv.filters,[1,1],"valid"),n=Wd(n,t.bn.sub),n=bl(n,t.bn.truediv),n=fl(n,t.conv.bias),x0(n)})}function y0(e,t){return to(()=>{let n=gc(e,[[0,0],[1,1],[1,1],[0,0]]);return n=pp(n,t.depthwise_filter,t.pointwise_filter,[1,1],"valid"),n=fl(n,t.bias),x0(n)})}var w0=class{constructor({inputSize:e,scoreThreshold:t}={}){if(this._name="TinyYolov2Options",this._inputSize=e||416,this._scoreThreshold=t||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw new Error(`${this._name} - expected inputSize to be a number divisible by 32`);if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(`${this._name} - expected scoreThreshold to be a number between 0 and 1`)}get inputSize(){return this._inputSize}get scoreThreshold(){return this._scoreThreshold}},v0=class e extends bQ{constructor(e){super("TinyYolov2"),function(e){if(!e)throw new Error(`invalid config: ${e}`);if("boolean"!=typeof e.withSeparableConvs)throw new Error(`config.withSeparableConvs has to be a boolean, have: ${e.withSeparableConvs}`);if(!g0(e.iouThreshold)||e.iouThreshold<0||e.iouThreshold>1)throw new Error(`config.iouThreshold has to be a number between [0, 1], have: ${e.iouThreshold}`);if(!Array.isArray(e.classes)||!e.classes.length||!e.classes.every(e=>"string"==typeof e))throw new Error(`config.classes has to be an array class names: string[], have: ${JSON.stringify(e.classes)}`);if(!Array.isArray(e.anchors)||!e.anchors.length||!e.anchors.map(e=>e||{}).every(e=>g0(e.x)&&g0(e.y)))throw new Error(`config.anchors has to be an array of { x: number, y: number }, have: ${JSON.stringify(e.anchors)}`);if(e.meanRgb&&(!Array.isArray(e.meanRgb)||3!==e.meanRgb.length||!e.meanRgb.every(g0)))throw new Error(`config.meanRgb has to be an array of shape [number, number, number], have: ${JSON.stringify(e.meanRgb)}`)}(e),this._config=e}get config(){return this._config}get withClassScores(){return this.config.withClassScores||this.config.classes.length>1}get boxEncodingSize(){return 5+(this.withClassScores?this.config.classes.length:0)}runTinyYolov2(e,t){let n=b0(e,t.conv0);return n=Jd(n,[2,2],[2,2],"same"),n=b0(n,t.conv1),n=Jd(n,[2,2],[2,2],"same"),n=b0(n,t.conv2),n=Jd(n,[2,2],[2,2],"same"),n=b0(n,t.conv3),n=Jd(n,[2,2],[2,2],"same"),n=b0(n,t.conv4),n=Jd(n,[2,2],[2,2],"same"),n=b0(n,t.conv5),n=Jd(n,[2,2],[1,1],"same"),n=b0(n,t.conv6),n=b0(n,t.conv7),kQ(n,t.conv8,"valid",!1)}runMobilenet(e,t){let n=this.config.isFirstLayerConv2d?x0(kQ(e,t.conv0,"valid",!1)):y0(e,t.conv0);return n=Jd(n,[2,2],[2,2],"same"),n=y0(n,t.conv1),n=Jd(n,[2,2],[2,2],"same"),n=y0(n,t.conv2),n=Jd(n,[2,2],[2,2],"same"),n=y0(n,t.conv3),n=Jd(n,[2,2],[2,2],"same"),n=y0(n,t.conv4),n=Jd(n,[2,2],[2,2],"same"),n=y0(n,t.conv5),n=Jd(n,[2,2],[1,1],"same"),n=t.conv6?y0(n,t.conv6):n,n=t.conv7?y0(n,t.conv7):n,kQ(n,t.conv8,"valid",!1)}forwardInput(e,t){let{params:n}=this;if(!n)throw new Error("TinyYolov2 - load model before inference");return to(()=>{let a=pl(e.toBatchTensor(t,!1),"float32");return a=this.config.meanRgb?jJ(a,this.config.meanRgb):a,a=a.div(255),this.config.withSeparableConvs?this.runMobilenet(a,n):this.runTinyYolov2(a,n)})}async forward(e,t){return this.forwardInput(await mQ(e),t)}async detect(e,t={}){let{inputSize:n,scoreThreshold:a}=new w0(t),r=await mQ(e),s=await this.forwardInput(r,n),i=to(()=>Kp(s)[0].expandDims()),o={width:r.getInputWidth(0),height:r.getInputHeight(0)},l=await this.extractBoxes(i,r.getReshapedInputDimensions(0),a);s.dispose(),i.dispose();let u=l.map(e=>e.box),d=l.map(e=>e.score),c=l.map(e=>e.classScore),p=l.map(e=>this.config.classes[e.label]);return function(e,t,n,a=!0){let r=t.map((e,t)=>({score:e,boxIndex:t})).sort((e,t)=>e.score-t.score).map(e=>e.boxIndex),s=[];for(;r.length>0;){let t=r.pop();s.push(t);let i=r,o=[];for(let n=0;n<i.length;n++){let r=i[n],s=e[t],l=e[r];o.push(OJ(s,l,a))}r=r.filter((e,t)=>o[t]<=n)}return s}(u.map(e=>e.rescale(n)),d,this.config.iouThreshold,!0).map(e=>new DJ(d[e],c[e],p[e],u[e],o))}getDefaultModelName(){return""}extractParamsFromWeightMap(e){return function(e,t){let n,a=[],{extractConvParams:r,extractConvWithBatchNormParams:s,extractSeparableConvParams:i}=function(e,t){let n=EQ(e,t);function a(e){return{filters:n(`${e}/filters`,4),bias:n(`${e}/bias`,1)}}return{extractConvParams:a,extractConvWithBatchNormParams:function(e){let t=a(`${e}/conv`),r=function(e){return{sub:n(`${e}/sub`,1),truediv:n(`${e}/truediv`,1)}}(`${e}/bn`);return{conv:t,bn:r}},extractSeparableConvParams:TQ(n)}}(e,a);if(t.withSeparableConvs){let e=t.filterSizes&&t.filterSizes.length||9;n={conv0:t.isFirstLayerConv2d?r("conv0"):i("conv0"),conv1:i("conv1"),conv2:i("conv2"),conv3:i("conv3"),conv4:i("conv4"),conv5:i("conv5"),conv6:e>7?i("conv6"):void 0,conv7:e>8?i("conv7"):void 0,conv8:r("conv8")}}else n={conv0:s("conv0"),conv1:s("conv1"),conv2:s("conv2"),conv3:s("conv3"),conv4:s("conv4"),conv5:s("conv5"),conv6:s("conv6"),conv7:s("conv7"),conv8:r("conv8")};return NQ(e,a),{params:n,paramMappings:a}}(e,this.config)}extractParams(t){let n=this.config.filterSizes||e.DEFAULT_FILTER_SIZES,a=n?n.length:void 0;if(7!==a&&8!==a&&9!==a)throw new Error(`TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found ${a} filterSizes in config`);return function(e,t,n,a){let r,{extractWeights:s,getRemainingWeights:i}=AQ(e),o=[],{extractConvParams:l,extractConvWithBatchNormParams:u,extractSeparableConvParams:d}=function(e,t){let n=SQ(e,t),a=CQ(e,t);return{extractConvParams:n,extractConvWithBatchNormParams:function(a,r,s){let i=n(a,r,3,`${s}/conv`),o=function(n,a){let r=Fp(e(n)),s=Fp(e(n));return t.push({paramPath:`${a}/sub`},{paramPath:`${a}/truediv`}),{sub:r,truediv:s}}(r,`${s}/bn`);return{conv:i,bn:o}},extractSeparableConvParams:a}}(s,o);if(t.withSeparableConvs){let[e,s,i,o,u,c,p,h,m]=a;r={conv0:t.isFirstLayerConv2d?l(e,s,3,"conv0"):d(e,s,"conv0"),conv1:d(s,i,"conv1"),conv2:d(i,o,"conv2"),conv3:d(o,u,"conv3"),conv4:d(u,c,"conv4"),conv5:d(c,p,"conv5"),conv6:h?d(p,h,"conv6"):void 0,conv7:m?d(h,m,"conv7"):void 0,conv8:l(m||h||p,5*n,1,"conv8")}}else{let[e,t,s,i,o,d,c,p,h]=a;r={conv0:u(e,t,"conv0"),conv1:u(t,s,"conv1"),conv2:u(s,i,"conv2"),conv3:u(i,o,"conv3"),conv4:u(o,d,"conv4"),conv5:u(d,c,"conv5"),conv6:u(c,p,"conv6"),conv7:u(p,h,"conv7"),conv8:l(h,5*n,1,"conv8")}}if(0!==i().length)throw new Error(`weights remaing after extract: ${i().length}`);return{params:r,paramMappings:o}}(t,this.config,this.boxEncodingSize,n)}async extractBoxes(e,t,n){let{width:a,height:r}=t,s=Math.max(a,r),i=s/a,o=s/r,l=e.shape[1],u=this.config.anchors.length,[d,c,p]=to(()=>{let t=e.reshape([l,l,u,this.boxEncodingSize]);return[t.slice([0,0,0,0],[l,l,u,4]),t.slice([0,0,0,4],[l,l,u,1]),this.withClassScores?vp(t.slice([0,0,0,5],[l,l,u,this.config.classes.length]),3):sd(0)]}),h=[],m=await c.array(),f=await d.array();for(let g=0;g<l;g++)for(let e=0;e<l;e++)for(let t=0;t<u;t++){let a=LJ(m[g][e][t][0]);if(!n||a>n){let n=(e+LJ(f[g][e][t][0]))/l*i,r=(g+LJ(f[g][e][t][1]))/l*o,s=Math.exp(f[g][e][t][2])*this.config.anchors[t].x/l*i,u=Math.exp(f[g][e][t][3])*this.config.anchors[t].y/l*o,d=n-s/2,c=r-u/2,m={row:g,col:e,anchor:t},{classScore:x,label:b}=this.withClassScores?await this.extractPredictedClass(p,m):{classScore:1,label:0};h.push({box:new FJ(d,c,d+s,c+u),score:a,classScore:a*x,label:b,...m})}}return d.dispose(),c.dispose(),p.dispose(),h}async extractPredictedClass(e,t){let{row:n,col:a,anchor:r}=t,s=await e.array();return Array(this.config.classes.length).fill(0).map((e,t)=>s[n][a][r][t]).map((e,t)=>({classScore:e,label:t})).reduce((e,t)=>e.classScore>t.classScore?e:t)}};v0.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024];var k0=v0,N0=class extends w0{constructor(){super(...arguments),this._name="TinyFaceDetectorOptions"}},S0=class{async then(e){return e(await this.run())}async run(){throw new Error("ComposableTask - run is not implemented")}};async function I0(e,t,n,a,r=({alignedRect:e})=>e){let s=e.map(e=>WQ(e)?r(e):e.detection),i=a||(t instanceof ri?await gQ(t,s):await fQ(t,s)),o=await n(i);return i.forEach(e=>e instanceof ri&&e.dispose()),o}async function _0(e,t,n,a,r){return I0([e],t,async e=>n(e[0]),a,r)}var C0=[new $J(1.603231,2.094468),new $J(6.041143,7.080126),new $J(2.882459,3.518061),new $J(4.266906,5.178857),new $J(9.041765,10.66308)],T0=[117.001,114.697,97.404],E0={ssdMobilenetv1:new class extends bQ{constructor(){super("SsdMobilenetv1")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("SsdMobilenetv1 - load model before inference");return to(()=>{let n=pl(e.toBatchTensor(512,!1),"float32"),a=function(e,t){return to(()=>{let n,a=u0(e,t.conv_0,[2,2]);if([t.conv_1,t.conv_2,t.conv_3,t.conv_4,t.conv_5,t.conv_6,t.conv_7,t.conv_8,t.conv_9,t.conv_10,t.conv_11,t.conv_12,t.conv_13].forEach((e,t)=>{let r=t+1,s=function(e){return[2,4,6,12].some(t=>t===e)?[2,2]:[1,1]}(r);a=function(e,t,n){return to(()=>{let a=Ru(e,t.filters,n,"same");return a=ru(a,t.batch_norm_mean,t.batch_norm_variance,t.batch_norm_offset,t.batch_norm_scale,.0010000000474974513),mu(a,0,6)})}(a,e.depthwise_conv,s),a=u0(a,e.pointwise_conv,[1,1]),11===r&&(n=a)}),null===n)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:a,conv11:n}})}(Wd(xl(n,127.5),1),t.mobilenetv1),{boxPredictions:r,classPredictions:s}=function(e,t,n){return to(()=>{let a=u0(e,n.conv_0,[1,1]),r=u0(a,n.conv_1,[2,2]),s=u0(r,n.conv_2,[1,1]),i=u0(s,n.conv_3,[2,2]),o=u0(i,n.conv_4,[1,1]),l=u0(o,n.conv_5,[2,2]),u=u0(l,n.conv_6,[1,1]),d=u0(u,n.conv_7,[2,2]),c=c0(t,n.box_predictor_0),p=c0(e,n.box_predictor_1),h=c0(r,n.box_predictor_2),m=c0(i,n.box_predictor_3),f=c0(l,n.box_predictor_4),g=c0(d,n.box_predictor_5);return{boxPredictions:Yl([c.boxPredictionEncoding,p.boxPredictionEncoding,h.boxPredictionEncoding,m.boxPredictionEncoding,f.boxPredictionEncoding,g.boxPredictionEncoding],1),classPredictions:Yl([c.classPrediction,p.classPrediction,h.classPrediction,m.classPrediction,f.classPrediction,g.classPrediction],1)}})}(a.out,a.conv11,t.prediction_layer);return function(e,t,n){return to(()=>{let a=e.shape[0],r=function(e,t){let{sizes:n,centers:a}=function(e){let t=Kp(eh(e,[1,0])),n=[Wd(t[2],t[0]),Wd(t[3],t[1])];return{sizes:n,centers:[fl(t[0],xl(n[0],2)),fl(t[1],xl(n[1],2))]}}(e),r=Kp(eh(t,[1,0])),s=xl(bl(pd(xl(r[2],5)),n[0]),2),i=fl(bl(xl(r[0],10),n[0]),a[0]),o=xl(bl(pd(xl(r[3],5)),n[1]),2),l=fl(bl(xl(r[1],10),n[1]),a[1]);return eh(Ep([Wd(i,s),Wd(l,o),fl(i,s),fl(l,o)]),[1,0])}(ql(fd(n.extra_dim,[a,1,1]),[-1,4]),ql(e,[-1,4]));r=ql(r,[a,r.shape[0]/a,4]);let s=Jl(Ql(t,[0,0,1],[-1,-1,-1])),i=Ql(s,[0,0,0],[-1,-1,1]);return i=ql(i,[a,i.shape[1]]),{boxes:Kp(r),scores:Kp(i)}})}(r,s,t.output_layer)})}async forward(e){return this.forwardInput(await mQ(e))}async locateFaces(e,t={}){let{maxResults:n,minConfidence:a}=new p0(t),r=await mQ(e),{boxes:s,scores:i}=this.forwardInput(r),o=s[0],l=i[0];for(let x=1;x<s.length;x++)s[x].dispose(),i[x].dispose();let u=Array.from(l.dataSync()),d=function(e,t,n,a,r){let s=e.shape[0],i=Math.min(n,s),o=t.map((e,t)=>({score:e,boxIndex:t})).filter(e=>e.score>r).sort((e,t)=>t.score-e.score),l=e=>e<=.5?1:0,u=[];return o.forEach(t=>{if(u.length>=i)return;let n=t.score;for(let a=u.length-1;a>=0;--a){let n=d0(e,t.boxIndex,u[a]);if(0!==n&&(t.score*=l(n),t.score<=r))break}n===t.score&&u.push(t.boxIndex)}),u}(o,u,n,0,a),c=r.getReshapedInputDimensions(0),p=r.inputSize,h=p/c.width,m=p/c.height,f=o.arraySync(),g=d.map(e=>{let[t,n]=[Math.max(0,f[e][0]),Math.min(1,f[e][2])].map(e=>e*m),[a,s]=[Math.max(0,f[e][1]),Math.min(1,f[e][3])].map(e=>e*h);return new MJ(u[e],new PJ(a,t,s-a,n-t),{height:r.getInputHeight(0),width:r.getInputWidth(0)})});return o.dispose(),l.dispose(),g}getDefaultModelName(){return"ssd_mobilenetv1_model"}extractParamsFromWeightMap(e){return function(e){let t=[],{extractMobilenetV1Params:n,extractPredictionLayerParams:a}=function(e,t){let n=EQ(e,t);function a(e,t,a){return{filters:n(`${e}/Conv2d_${t}_pointwise/weights`,4,`${a}/filters`),batch_norm_offset:n(`${e}/Conv2d_${t}_pointwise/convolution_bn_offset`,1,`${a}/batch_norm_offset`)}}function r(e){let t=`mobilenetv1/conv_${e}`,r=`MobilenetV1/Conv2d_${e}_depthwise`,s=`${t}/depthwise_conv`,i=`${t}/pointwise_conv`;return{depthwise_conv:{filters:n(`${r}/depthwise_weights`,4,`${s}/filters`),batch_norm_scale:n(`${r}/BatchNorm/gamma`,1,`${s}/batch_norm_scale`),batch_norm_offset:n(`${r}/BatchNorm/beta`,1,`${s}/batch_norm_offset`),batch_norm_mean:n(`${r}/BatchNorm/moving_mean`,1,`${s}/batch_norm_mean`),batch_norm_variance:n(`${r}/BatchNorm/moving_variance`,1,`${s}/batch_norm_variance`)},pointwise_conv:a("MobilenetV1",e,i)}}function s(e,t){return{filters:n(`${e}/weights`,4,`${t}/filters`),bias:n(`${e}/biases`,1,`${t}/bias`)}}function i(e){return{box_encoding_predictor:s(`Prediction/BoxPredictor_${e}/BoxEncodingPredictor`,`prediction_layer/box_predictor_${e}/box_encoding_predictor`),class_predictor:s(`Prediction/BoxPredictor_${e}/ClassPredictor`,`prediction_layer/box_predictor_${e}/class_predictor`)}}return{extractMobilenetV1Params:function(){return{conv_0:a("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:r(1),conv_2:r(2),conv_3:r(3),conv_4:r(4),conv_5:r(5),conv_6:r(6),conv_7:r(7),conv_8:r(8),conv_9:r(9),conv_10:r(10),conv_11:r(11),conv_12:r(12),conv_13:r(13)}},extractPredictionLayerParams:function(){return{conv_0:a("Prediction",0,"prediction_layer/conv_0"),conv_1:a("Prediction",1,"prediction_layer/conv_1"),conv_2:a("Prediction",2,"prediction_layer/conv_2"),conv_3:a("Prediction",3,"prediction_layer/conv_3"),conv_4:a("Prediction",4,"prediction_layer/conv_4"),conv_5:a("Prediction",5,"prediction_layer/conv_5"),conv_6:a("Prediction",6,"prediction_layer/conv_6"),conv_7:a("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:i(0),box_predictor_1:i(1),box_predictor_2:i(2),box_predictor_3:i(3),box_predictor_4:i(4),box_predictor_5:i(5)}}}}(e,t),r=e["Output/extra_dim"];if(t.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!wJ(r))throw new Error(`expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have ${r}`);let s={mobilenetv1:n(),prediction_layer:a(),output_layer:{extra_dim:r}};return NQ(e,t),{params:s,paramMappings:t}}(e)}extractParams(e){return function(e){let t=[],{extractWeights:n,getRemainingWeights:a}=AQ(e),{extractMobilenetV1Params:r,extractPredictionLayerParams:s}=function(e,t){function n(n,a,r,s,i){let o=Op(e(n*a*r*r),[r,r,n,a]),l=Fp(e(a));return t.push({paramPath:`${s}/filters`},{paramPath:`${s}/${i?"batch_norm_offset":"bias"}`}),{filters:o,bias:l}}function a(e,t,a,r){let{filters:s,bias:i}=n(e,t,a,r,!0);return{filters:s,batch_norm_offset:i}}function r(n,r,s){let i=function(n,a){let r=Op(e(9*n),[3,3,n,1]),s=Fp(e(n)),i=Fp(e(n)),o=Fp(e(n)),l=Fp(e(n));return t.push({paramPath:`${a}/filters`},{paramPath:`${a}/batch_norm_scale`},{paramPath:`${a}/batch_norm_offset`},{paramPath:`${a}/batch_norm_mean`},{paramPath:`${a}/batch_norm_variance`}),{filters:r,batch_norm_scale:s,batch_norm_offset:i,batch_norm_mean:o,batch_norm_variance:l}}(n,`${s}/depthwise_conv`);return{depthwise_conv:i,pointwise_conv:a(n,r,1,`${s}/pointwise_conv`)}}return{extractMobilenetV1Params:function(){return{conv_0:a(3,32,3,"mobilenetv1/conv_0"),conv_1:r(32,64,"mobilenetv1/conv_1"),conv_2:r(64,128,"mobilenetv1/conv_2"),conv_3:r(128,128,"mobilenetv1/conv_3"),conv_4:r(128,256,"mobilenetv1/conv_4"),conv_5:r(256,256,"mobilenetv1/conv_5"),conv_6:r(256,512,"mobilenetv1/conv_6"),conv_7:r(512,512,"mobilenetv1/conv_7"),conv_8:r(512,512,"mobilenetv1/conv_8"),conv_9:r(512,512,"mobilenetv1/conv_9"),conv_10:r(512,512,"mobilenetv1/conv_10"),conv_11:r(512,512,"mobilenetv1/conv_11"),conv_12:r(512,1024,"mobilenetv1/conv_12"),conv_13:r(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function(){return{conv_0:a(1024,256,1,"prediction_layer/conv_0"),conv_1:a(256,512,3,"prediction_layer/conv_1"),conv_2:a(512,128,1,"prediction_layer/conv_2"),conv_3:a(128,256,3,"prediction_layer/conv_3"),conv_4:a(256,128,1,"prediction_layer/conv_4"),conv_5:a(128,256,3,"prediction_layer/conv_5"),conv_6:a(256,64,1,"prediction_layer/conv_6"),conv_7:a(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:n(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:n(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:n(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:n(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:n(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:n(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:n(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:n(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:n(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:n(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:n(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:n(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}(n,t),i=r(),o=s(),l={extra_dim:Mp(n(20472),[1,5118,4])};if(t.push({paramPath:"output_layer/extra_dim"}),0!==a().length)throw new Error(`weights remaing after extract: ${a().length}`);return{params:{mobilenetv1:i,prediction_layer:o,output_layer:l},paramMappings:t}}(e)}},tinyFaceDetector:new class extends k0{constructor(){super({withSeparableConvs:!0,iouThreshold:.4,classes:["face"],anchors:C0,meanRgb:T0,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]})}get anchors(){return this.config.anchors}async locateFaces(e,t){return(await this.detect(e,t)).map(e=>new MJ(e.score,e.relativeBox,{width:e.imageWidth,height:e.imageHeight}))}getDefaultModelName(){return"tiny_face_detector_model"}extractParamsFromWeightMap(e){return super.extractParamsFromWeightMap(e)}},tinyYolov2:new class extends k0{constructor(e=!0){super({withSeparableConvs:e,iouThreshold:.4,classes:["face"],...e?{anchors:m0,meanRgb:f0}:{anchors:h0,withClassScores:!0}})}get withSeparableConvs(){return this.config.withSeparableConvs}get anchors(){return this.config.anchors}async locateFaces(e,t){return(await this.detect(e,t)).map(e=>new MJ(e.score,e.relativeBox,{width:e.imageWidth,height:e.imageHeight}))}getDefaultModelName(){return this.withSeparableConvs?"tiny_yolov2_separable_conv_model":"tiny_yolov2_model"}extractParamsFromWeightMap(e){return super.extractParamsFromWeightMap(e)}},faceLandmark68Net:new class extends JQ{constructor(e=new DQ){super("FaceLandmark68Net",e)}getDefaultModelName(){return"face_landmark_68_model"}getClassifierChannelsIn(){return 256}},faceLandmark68TinyNet:new class extends JQ{constructor(e=new QQ){super("FaceLandmark68TinyNet",e)}getDefaultModelName(){return"face_landmark_68_tiny_model"}getClassifierChannelsIn(){return 128}},faceRecognitionNet:new class extends bQ{constructor(){super("FaceRecognitionNet")}forwardInput(e){let{params:t}=this;if(!t)throw new Error("FaceRecognitionNet - load model before inference");return to(()=>{let n=n0(jJ(pl(e.toBatchTensor(150,!0),"float32"),[122.782,117.001,104.298]).div(255),t.conv32_down);n=Jd(n,3,2,"valid"),n=r0(n,t.conv32_1),n=r0(n,t.conv32_2),n=r0(n,t.conv32_3),n=s0(n,t.conv64_down),n=r0(n,t.conv64_1),n=r0(n,t.conv64_2),n=r0(n,t.conv64_3),n=s0(n,t.conv128_down),n=r0(n,t.conv128_1),n=r0(n,t.conv128_2),n=s0(n,t.conv256_down),n=r0(n,t.conv256_1),n=r0(n,t.conv256_2),n=s0(n,t.conv256_down_out);let a=n.mean([1,2]);return Zl(a,t.fc)})}async forward(e){return this.forwardInput(await mQ(e))}async computeFaceDescriptor(e){var t;if(null!=(t=null==e?void 0:e.shape)&&t.some(e=>e<=0))return new Float32Array(128);let n=await mQ(e),a=to(()=>Kp(this.forwardInput(n))),r=await Promise.all(a.map(e=>e.data()));return a.forEach(e=>e.dispose()),n.isBatchInput?r:r[0]}getDefaultModelName(){return"face_recognition_model"}extractParamsFromWeightMap(e){return function(e){let t=[],{extractConvLayerParams:n,extractResidualLayerParams:a}=function(e,t){let n=EQ(e,t);function a(e){let t=n(`${e}/conv/filters`,4),a=n(`${e}/conv/bias`,1),r=function(e){return{weights:n(`${e}/scale/weights`,1),biases:n(`${e}/scale/biases`,1)}}(e);return{conv:{filters:t,bias:a},scale:r}}return{extractConvLayerParams:a,extractResidualLayerParams:function(e){return{conv1:a(`${e}/conv1`),conv2:a(`${e}/conv2`)}}}}(e,t),r=n("conv32_down"),s=a("conv32_1"),i=a("conv32_2"),o=a("conv32_3"),l=a("conv64_down"),u=a("conv64_1"),d=a("conv64_2"),c=a("conv64_3"),p=a("conv128_down"),h=a("conv128_1"),m=a("conv128_2"),f=a("conv256_down"),g=a("conv256_1"),x=a("conv256_2"),b=a("conv256_down_out"),{fc:y}=e;if(t.push({originalPath:"fc",paramPath:"fc"}),!yJ(y))throw new Error(`expected weightMap[fc] to be a Tensor2D, instead have ${y}`);let w={conv32_down:r,conv32_1:s,conv32_2:i,conv32_3:o,conv64_down:l,conv64_1:u,conv64_2:d,conv64_3:c,conv128_down:p,conv128_1:h,conv128_2:m,conv256_down:f,conv256_1:g,conv256_2:x,conv256_down_out:b,fc:y};return NQ(e,t),{params:w,paramMappings:t}}(e)}extractParams(e){return function(e){let{extractWeights:t,getRemainingWeights:n}=AQ(e),a=[],{extractConvLayerParams:r,extractResidualLayerParams:s}=a0(t,a),i=r(4704,32,7,"conv32_down"),o=s(9216,32,3,"conv32_1"),l=s(9216,32,3,"conv32_2"),u=s(9216,32,3,"conv32_3"),d=s(36864,64,3,"conv64_down",!0),c=s(36864,64,3,"conv64_1"),p=s(36864,64,3,"conv64_2"),h=s(36864,64,3,"conv64_3"),m=s(147456,128,3,"conv128_down",!0),f=s(147456,128,3,"conv128_1"),g=s(147456,128,3,"conv128_2"),x=s(589824,256,3,"conv256_down",!0),b=s(589824,256,3,"conv256_1"),y=s(589824,256,3,"conv256_2"),w=s(589824,256,3,"conv256_down_out"),v=to(()=>eh(Dp(t(32768),[128,256]),[1,0]));if(a.push({paramPath:"fc"}),0!==n().length)throw new Error(`weights remaing after extract: ${n().length}`);return{params:{conv32_down:i,conv32_1:o,conv32_2:l,conv32_3:u,conv64_down:d,conv64_1:c,conv64_2:p,conv64_3:h,conv128_down:m,conv128_1:f,conv128_2:g,conv256_down:x,conv256_1:b,conv256_2:y,conv256_down_out:w,fc:v},paramMappings:a}}(e)}},faceExpressionNet:new class extends jQ{constructor(e=new DQ){super("FaceExpressionNet",e)}forwardInput(e){return to(()=>vp(this.runNet(e)))}async forward(e){return this.forwardInput(await mQ(e))}async predictExpressions(e){let t=await mQ(e),n=await this.forwardInput(t),a=await Promise.all(Kp(n).map(async e=>{let t=e.dataSync();return e.dispose(),t}));n.dispose();let r=a.map(e=>new zQ(e));return t.isBatchInput?r:r[0]}getDefaultModelName(){return"face_expression_model"}getClassifierChannelsIn(){return 256}getClassifierChannelsOut(){return 7}},ageGenderNet:new class extends bQ{constructor(e=new YQ(2)){super("AgeGenderNet"),this._faceFeatureExtractor=e}get faceFeatureExtractor(){return this._faceFeatureExtractor}runNet(e){let{params:t}=this;if(!t)throw new Error(`${this._name} - load model before inference`);return to(()=>{let n=e instanceof hQ?this.faceFeatureExtractor.forwardInput(e):e,a=Kl(n,[7,7],[2,2],"valid").as2D(n.shape[0],-1);return{age:MQ(a,t.fc.age).as1D(),gender:MQ(a,t.fc.gender)}})}forwardInput(e){return to(()=>{let{age:t,gender:n}=this.runNet(e);return{age:t,gender:vp(n)}})}async forward(e){return this.forwardInput(await mQ(e))}async predictAgeAndGender(e){let t=await mQ(e),n=await this.forwardInput(t),a=Kp(n.age),r=Kp(n.gender),s=a.map((e,t)=>({ageTensor:e,genderTensor:r[t]})),i=await Promise.all(s.map(async({ageTensor:e,genderTensor:t})=>{let n=e.dataSync()[0],a=t.dataSync()[0],r=a>.5,s=r?"male":"female",i=r?a:1-a;return e.dispose(),t.dispose(),{age:n,gender:s,genderProbability:i}}));return n.age.dispose(),n.gender.dispose(),t.isBatchInput?i:i[0]}getDefaultModelName(){return"age_gender_model"}dispose(e=!0){this.faceFeatureExtractor.dispose(e),super.dispose(e)}loadClassifierParams(e){let{params:t,paramMappings:n}=this.extractClassifierParams(e);this._params=t,this._paramMappings=n}extractClassifierParams(e){return function(e){let t=[],{extractWeights:n,getRemainingWeights:a}=AQ(e),r=IQ(n,t),s=r(512,1,"fc/age"),i=r(512,2,"fc/gender");if(0!==a().length)throw new Error(`weights remaing after extract: ${a().length}`);return{paramMappings:t,params:{fc:{age:s,gender:i}}}}(e)}extractParamsFromWeightMap(e){let{featureExtractorMap:t,classifierMap:n}=OQ(e);return this.faceFeatureExtractor.loadFromWeightMap(t),function(e){let t=[],n=EQ(e,t);function a(e){return{weights:n(`${e}/weights`,2),bias:n(`${e}/bias`,1)}}let r={fc:{age:a("fc/age"),gender:a("fc/gender")}};return NQ(e,t),{params:r,paramMappings:t}}(n)}extractParams(e){let t=e.slice(0,e.length-1539),n=e.slice(e.length-1539);return this.faceFeatureExtractor.extractWeights(t),this.extractClassifierParams(n)}}},A0=class extends S0{constructor(e,t,n){super(),this.parentTask=e,this.input=t,this.extractedFaces=n}},$0=class extends A0{async run(){let e=await this.parentTask,t=await I0(e,this.input,async e=>Promise.all(e.map(e=>E0.faceExpressionNet.predictExpressions(e))),this.extractedFaces);return e.map((e,n)=>PQ(e,t[n]))}withAgeAndGender(){return new O0(this,this.input)}},R0=class extends A0{async run(){let e=await this.parentTask;if(e)return PQ(e,await _0(e,this.input,e=>E0.faceExpressionNet.predictExpressions(e),this.extractedFaces))}withAgeAndGender(){return new j0(this,this.input)}},F0=class extends $0{withAgeAndGender(){return new L0(this,this.input)}withFaceDescriptors(){return new B0(this,this.input)}},D0=class extends R0{withAgeAndGender(){return new z0(this,this.input)}withFaceDescriptor(){return new W0(this,this.input)}},M0=class extends S0{constructor(e,t,n){super(),this.parentTask=e,this.input=t,this.extractedFaces=n}},O0=class extends M0{async run(){let e=await this.parentTask,t=await I0(e,this.input,async e=>Promise.all(e.map(e=>E0.ageGenderNet.predictAgeAndGender(e))),this.extractedFaces);return e.map((e,n)=>{let{age:a,gender:r,genderProbability:s}=t[n];return o0(l0(e,r,s),a)})}withFaceExpressions(){return new $0(this,this.input)}},j0=class extends M0{async run(){let e=await this.parentTask;if(!e)return;let{age:t,gender:n,genderProbability:a}=await _0(e,this.input,e=>E0.ageGenderNet.predictAgeAndGender(e),this.extractedFaces);return o0(l0(e,n,a),t)}withFaceExpressions(){return new R0(this,this.input)}},L0=class extends O0{withFaceExpressions(){return new F0(this,this.input)}withFaceDescriptors(){return new B0(this,this.input)}},z0=class extends j0{withFaceExpressions(){return new D0(this,this.input)}withFaceDescriptor(){return new W0(this,this.input)}},P0=class extends S0{constructor(e,t){super(),this.parentTask=e,this.input=t}},B0=class extends P0{async run(){let e=await this.parentTask;return(await I0(e,this.input,e=>Promise.all(e.map(e=>E0.faceRecognitionNet.computeFaceDescriptor(e))),null,e=>e.landmarks.align(null,{useDlibAlignment:!0}))).map((t,n)=>i0(e[n],t))}withFaceExpressions(){return new F0(this,this.input)}withAgeAndGender(){return new L0(this,this.input)}},W0=class extends P0{async run(){let e=await this.parentTask;if(e)return i0(e,await _0(e,this.input,e=>E0.faceRecognitionNet.computeFaceDescriptor(e),null,e=>e.landmarks.align(null,{useDlibAlignment:!0})))}withFaceExpressions(){return new D0(this,this.input)}withAgeAndGender(){return new z0(this,this.input)}},V0=class extends S0{constructor(e,t,n){super(),this.parentTask=e,this.input=t,this.useTinyLandmarkNet=n}get landmarkNet(){return this.useTinyLandmarkNet?E0.faceLandmark68TinyNet:E0.faceLandmark68Net}},U0=class extends V0{async run(){let e=await this.parentTask,t=e.map(e=>e.detection),n=this.input instanceof ri?await gQ(this.input,t):await fQ(this.input,t),a=await Promise.all(n.map(e=>this.landmarkNet.detectLandmarks(e)));return n.forEach(e=>e instanceof ri&&e.dispose()),e.filter((e,t)=>a[t]).map((e,t)=>VQ(e,a[t]))}withFaceExpressions(){return new F0(this,this.input)}withAgeAndGender(){return new L0(this,this.input)}withFaceDescriptors(){return new B0(this,this.input)}},G0=class extends V0{async run(){let e=await this.parentTask;if(!e)return;let{detection:t}=e,n=this.input instanceof ri?await gQ(this.input,[t]):await fQ(this.input,[t]),a=await this.landmarkNet.detectLandmarks(n[0]);return n.forEach(e=>e instanceof ri&&e.dispose()),VQ(e,a)}withFaceExpressions(){return new D0(this,this.input)}withAgeAndGender(){return new z0(this,this.input)}withFaceDescriptor(){return new W0(this,this.input)}},H0=class extends S0{constructor(e,t=new p0){super(),this.input=e,this.options=t}},q0=class extends H0{async run(){let e,{input:t,options:n}=this;if(n instanceof N0)e=E0.tinyFaceDetector.locateFaces(t,n);else if(n instanceof p0)e=E0.ssdMobilenetv1.locateFaces(t,n);else{if(!(n instanceof w0))throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | TinyYolov2Options");e=E0.tinyYolov2.locateFaces(t,n)}return e}runAndExtendWithFaceDetections(){return new Promise((e,t)=>{this.run().then(t=>e(t.map(e=>UJ({},e)))).catch(e=>t(e))})}withFaceLandmarks(e=!1){return new U0(this.runAndExtendWithFaceDetections(),this.input,e)}withFaceExpressions(){return new $0(this.runAndExtendWithFaceDetections(),this.input)}withAgeAndGender(){return new O0(this.runAndExtendWithFaceDetections(),this.input)}},K0=class extends H0{async run(){let e=await new q0(this.input,this.options),t=e[0];return e.forEach(e=>{e.score>t.score&&(t=e)}),t}runAndExtendWithFaceDetection(){return new Promise(async e=>{let t=await this.run();e(t?UJ({},t):void 0)})}withFaceLandmarks(e=!1){return new G0(this.runAndExtendWithFaceDetection(),this.input,e)}withFaceExpressions(){return new R0(this.runAndExtendWithFaceDetection(),this.input)}withAgeAndGender(){return new j0(this.runAndExtendWithFaceDetection(),this.input)}};const X0=()=>{const[t,n]=k.useState(null),[a,r]=k.useState([]),[s,i]=k.useState(null),[o,l]=k.useState(!1),[u,d]=k.useState(!1),[c,p]=k.useState(!1),[h,m]=k.useState([]),[f,g]=k.useState(null),[x,b]=k.useState(!1),[y,w]=k.useState(""),[v,N]=k.useState({}),I=k.useRef(null),_=k.useRef(null),C=k.useRef(null);k.useEffect(()=>{const e=localStorage.getItem("userData");if(e){const t=JSON.parse(e);n(t)}},[]),k.useEffect(()=>{(async()=>{try{const e="/models";await Promise.all([E0.tinyFaceDetector.loadFromUri(e),E0.faceLandmark68Net.loadFromUri(e),E0.faceRecognitionNet.loadFromUri(e),E0.faceExpressionNet.loadFromUri(e)]),d(!0)}catch(e){b(!0),d(!1)}})()},[]),k.useEffect(()=>{t?._id&&T()},[t]);const T=async()=>{if(t?._id)try{l(!0);const e=await S.get(`/api/users/?user_id=${t._id}`),n=Array.isArray(e.data)?e.data:e.data.users||e.data.data||[];r(n);const a=n.slice(0,20).map(e=>S.get(`/api/attendance/face/${e._id}?user_id=${t._id}`).then(t=>({[e._id]:t.data})).catch(()=>({[e._id]:{face_registered:!1}}))),s=(await Promise.all(a)).reduce((e,t)=>({...e,...t}),{});N(s)}catch(e){}finally{l(!1)}},E=()=>{C.current&&(C.current.getTracks().forEach(e=>e.stop()),C.current=null),I.current&&(I.current.srcObject=null),p(!1)};return e.jsxs("div",{className:"face-registration-container p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent",children:" Facial Recognition Management"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Register employee faces for automated attendance verification"})]}),!u&&!x&&e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4",children:e.jsx("p",{className:"text-yellow-700",children:" Loading face recognition models..."})}),x&&e.jsx("div",{className:"bg-orange-100 border-l-4 border-orange-500 p-4 mb-4",children:e.jsx("p",{className:"text-orange-700",children:" Face detection models unavailable - basic camera capture will still work. Face auto-detection disabled."})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Select Employee"}),e.jsx("input",{type:"text",placeholder:" Search employee...",value:y,onChange:e=>w(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3 focus:outline-none focus:border-purple-400"}),o?e.jsx("p",{className:"text-gray-400 text-center py-8",children:" Loading employees..."}):0===a.length?e.jsx("p",{className:"text-gray-400 text-center py-8",children:"No employees found"}):e.jsx("div",{className:"space-y-2 max-h-[540px] overflow-y-auto",children:a.filter(e=>{const t=`${e.first_name||""} ${e.last_name||""}`.toLowerCase(),n=(e.email||"").toLowerCase(),a=(e.emp_id||e.employee_id||e.code||"").toLowerCase(),r=y.toLowerCase();return!r||t.includes(r)||n.includes(r)||a.includes(r)}).map(t=>e.jsx("div",{className:"p-3 rounded-lg border-2 cursor-pointer transition-all "+(s?._id===t._id?"border-purple-500 bg-purple-50":"border-gray-200 hover:border-purple-300"),onClick:()=>i(t),children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-800",children:[t.first_name," ",t.last_name]}),e.jsx("p",{className:"text-sm text-gray-500",children:t.email}),e.jsx("p",{className:"text-xs text-gray-400",children:t.emp_id||t.employee_id||t.code||""})]}),e.jsx("div",{className:"ml-2 flex-shrink-0",children:v[t._id]?.face_registered?e.jsx("span",{className:"text-green-600 text-xs font-semibold bg-green-50 px-2 py-1 rounded",children:" Face"}):e.jsx("span",{className:"text-gray-400 text-xs",children:""})})]})},t._id))})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Capture Face Samples"}),s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 rounded",children:[e.jsxs("p",{className:"font-medium",children:[s.first_name," ",s.last_name]}),e.jsx("p",{className:"text-sm text-gray-600",children:v[s._id]?.face_registered?`Current samples: ${v[s._id].samples_count}`:"No face registered yet"})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx("video",{ref:I,autoPlay:!0,muted:!0,playsInline:!0,className:"w-full rounded-lg bg-black",style:{maxHeight:"360px"}}),e.jsx("canvas",{ref:_,className:"absolute top-0 left-0 w-full h-full",style:{maxHeight:"360px"}})]}),e.jsx("div",{className:"space-y-3",children:c?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:async()=>{if(I.current)try{const t=document.createElement("canvas");t.width=I.current.videoWidth||640,t.height=I.current.videoHeight||480,t.getContext("2d").drawImage(I.current,0,0);const n=t.toDataURL("image/jpeg",.8);let a=[],r=1;if(u)try{const e=await function(e,t=new p0){return new K0(e,t)}(I.current,new N0).withFaceLandmarks().withFaceDescriptor();if(!e)return void alert("No face detected. Please ensure your face is clearly visible.");const t=_.current;if(t){const n=t.getContext("2d");t.width=I.current.videoWidth,t.height=I.current.videoHeight,n.clearRect(0,0,t.width,t.height);const a=e.detection.box;n.strokeStyle="#00ff00",n.lineWidth=3,n.strokeRect(a.x,a.y,a.width,a.height)}a=Array.from(e.descriptor),r=e.detection.score}catch(e){}const s={descriptor:a,detection_score:r,photoData:n,timestamp:(new Date).toISOString()};m(e=>[...e,s])}catch(t){alert("Failed to capture sample. Please try again.")}else alert("Camera not ready")},disabled:o,className:"w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:bg-gray-300",children:[" Capture Sample (",h.length,"/5)"]}),e.jsx("button",{onClick:E,className:"w-full py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600",children:" Stop Camera"})]}):e.jsx("button",{onClick:async()=>{try{const e=await navigator.mediaDevices.getUserMedia({video:{width:640,height:480,facingMode:"user"}});I.current&&(I.current.srcObject=e,C.current=e,p(!0))}catch(e){alert("Failed to access camera. Please grant camera permissions.")}},disabled:o,className:"w-full py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300",children:" Start Camera"})}),e.jsxs("div",{className:"mt-4 p-3 bg-gray-50 rounded text-sm",children:[e.jsx("p",{className:"font-medium mb-2",children:" Instructions:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-gray-600",children:[e.jsx("li",{children:"Start camera and ensure good lighting"}),e.jsx("li",{children:"Face should be clearly visible"}),e.jsx("li",{children:"Capture 3-5 samples from different angles"}),e.jsx("li",{children:'Click "Register Face" when done'})]})]})]}):e.jsx("p",{className:"text-gray-500 text-center py-8",children:" Select an employee to begin"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Captured Samples"}),e.jsx("div",{className:"space-y-3 mb-4 max-h-[400px] overflow-y-auto",children:0===h.length?e.jsx("p",{className:"text-gray-500 text-center py-8",children:"No samples captured yet"}):h.map((t,n)=>e.jsxs("div",{className:"border rounded-lg p-2",children:[e.jsx("img",{src:t.photoData,alt:`Sample ${n+1}`,className:"w-full rounded mb-2"}),e.jsxs("p",{className:"text-xs text-gray-600",children:["Sample ",n+1," - Confidence: ",(100*t.detection_score).toFixed(1),"%"]}),e.jsx("button",{onClick:()=>m(e=>e.filter((e,t)=>t!==n)),className:"text-red-500 text-xs mt-1",children:"Remove"})]},n))}),h.length>=3&&e.jsx("button",{onClick:async()=>{if(h.length<3)alert("Please capture at least 3 face samples for accurate registration");else if(s)try{l(!0),g("Registering face...");const e={employee_id:s._id,face_descriptors:h.map(e=>({descriptor:e.descriptor,detection_score:e.detection_score})),photo_data:h[0].photoData},n=await S.post(`/api/attendance/face/register?admin_user_id=${t._id}`,e);n.data.success&&(g(` Face registered successfully with ${n.data.samples_count} samples!`),N(e=>({...e,[s._id]:{face_registered:!0,samples_count:n.data.samples_count,registered_at:n.data.registered_at}})),setTimeout(()=>{m([]),E(),g(null)},3e3))}catch(e){const t=e.response?.data?.detail||"Failed to register face";g(` ${t}`)}finally{l(!1)}else alert("Please select an employee")},disabled:o||!s,className:"w-full py-3 px-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 disabled:bg-gray-300 font-semibold",children:o?" Registering...":" Register Face"}),h.length>0&&h.length<3&&e.jsxs("p",{className:"text-yellow-600 text-sm text-center",children:[" ",3-h.length," more sample(s) needed"]}),f&&e.jsx("div",{className:"mt-4 p-3 rounded-lg "+(f.includes("")?"bg-green-100 text-green-700":"bg-red-100 text-red-700"),children:f}),s&&v[s._id]?.face_registered&&e.jsx("button",{onClick:()=>(async e=>{if(window.confirm("Are you sure you want to delete this face registration?"))try{l(!0),await S.delete(`/api/attendance/face/${e}?admin_user_id=${t._id}`),alert("Face registration deleted successfully"),N(t=>({...t,[e]:{face_registered:!1}}))}catch(n){alert("Failed to delete face registration")}finally{l(!1)}})(s._id),disabled:o,className:"w-full mt-3 py-2 px-4 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 disabled:bg-gray-300",children:" Delete Registration"})]})]})]})},Y0="/api",Z0=()=>{const[t,n]=N.useState(()=>{try{return JSON.parse(localStorage.getItem("userData")||"null")}catch{return null}}),[a,r]=k.useState([]),[s,i]=k.useState(null),[o,l]=k.useState(null),[u,d]=k.useState([]),[c,p]=k.useState(!1),[h,m]=k.useState(null),[f,g]=k.useState(null),[x,b]=k.useState(!1),[y,w]=k.useState("paid"),[v,I]=k.useState(""),[_,C]=k.useState("");k.useEffect(()=>{T()},[]);const T=async()=>{try{p(!0),m(null);const e=t?.user_id||t?._id,n=await S.get(`${Y0}/users/?user_id=${e}`),a=Array.isArray(n.data)?n.data:n.data.users||n.data.data||[];r(a)}catch(e){m("Failed to load employees: "+(e.response?.data?.detail||e.message))}finally{p(!1)}},E=async e=>{try{p(!0),m(null);const n=await S.get(`${Y0}/settings/leave-balance/${e}?user_id=${t?.user_id||t?._id}`);n.data.success&&l(n.data.data);const a=await S.get(`${Y0}/settings/leave-balance/history/${e}?user_id=${t?.user_id||t?._id}`);d(a.data||[])}catch(n){m(n.response?.data?.detail||"Failed to load leave balance")}finally{p(!1)}};return e.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[e.jsxs("div",{className:"bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-lg shadow-lg mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:" Paid Leave Management"}),e.jsx("p",{className:"text-indigo-100",children:"Allocate and manage employee leave balances"})]}),f&&e.jsxs("div",{className:"bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4",children:[" ",f]}),h&&e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",children:[" ",h]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:" Select Employee"}),c&&e.jsx("p",{className:"text-gray-400 text-center py-6",children:" Loading employees..."}),!c&&0===a.length&&e.jsx("p",{className:"text-gray-400 text-center py-6",children:"No employees found"}),e.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:a.map(t=>e.jsxs("button",{onClick:()=>(e=>{i(e),E(e._id||e.id)})(t),className:"w-full text-left p-3 rounded-lg transition-all "+(s?._id===(t._id||t.id)?"bg-indigo-100 border-2 border-indigo-500":"bg-gray-50 border border-gray-200 hover:bg-gray-100"),children:[e.jsxs("div",{className:"font-semibold text-gray-800",children:[t.first_name," ",t.last_name]}),e.jsx("div",{className:"text-sm text-gray-600",children:t.department_name||t.department||""}),e.jsx("div",{className:"text-xs text-gray-500",children:t.emp_id||t.employee_code||t.code||""})]},t._id||t.id))})]})}),e.jsx("div",{className:"lg:col-span-2",children:s?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-800",children:[s.first_name," ",s.last_name]}),e.jsxs("p",{className:"text-gray-600",children:[s.department_name||s.department||""," | ",s.emp_id||s.employee_code||s.code||""]})]}),e.jsx("button",{onClick:()=>b(!0),className:"bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors",children:" Allocate/Deduct Leaves"})]}),c&&!o?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Loading leave balance..."})]}):o?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow-lg",children:[e.jsx("div",{className:"text-sm opacity-90 mb-1",children:"Paid Leaves"}),e.jsxs("div",{className:"text-3xl font-bold",children:[o.paid_leaves_remaining,"/",o.paid_leaves_total]}),e.jsxs("div",{className:"text-xs mt-2",children:["Used: ",o.paid_leaves_used]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow-lg",children:[e.jsx("div",{className:"text-sm opacity-90 mb-1",children:"Earned Leaves"}),e.jsxs("div",{className:"text-3xl font-bold",children:[o.earned_leaves_remaining,"/",o.earned_leaves_total]}),e.jsxs("div",{className:"text-xs mt-2",children:["Used: ",o.earned_leaves_used]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow-lg",children:[e.jsx("div",{className:"text-sm opacity-90 mb-1",children:"Sick Leaves"}),e.jsxs("div",{className:"text-3xl font-bold",children:[o.sick_leaves_remaining,"/",o.sick_leaves_total]}),e.jsxs("div",{className:"text-xs mt-2",children:["Used: ",o.sick_leaves_used]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow-lg",children:[e.jsx("div",{className:"text-sm opacity-90 mb-1",children:"Casual Leaves"}),e.jsxs("div",{className:"text-3xl font-bold",children:[o.casual_leaves_remaining,"/",o.casual_leaves_total]}),e.jsxs("div",{className:"text-xs mt-2",children:["Used: ",o.casual_leaves_used]})]})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800 mb-3",children:" Leave Transaction History"}),0===u.length?e.jsx("div",{className:"text-center text-gray-500 py-8 bg-gray-50 rounded-lg",children:"No leave transactions yet"}):e.jsx("div",{className:"space-y-3 max-h-[400px] overflow-y-auto",children:u.map((t,n)=>{return e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:e.jsx("div",{className:"flex justify-between items-start",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-semibold ${a=t.leave_type,{paid:"text-green-600 bg-green-100",earned:"text-blue-600 bg-blue-100",sick:"text-orange-600 bg-orange-100",casual:"text-purple-600 bg-purple-100"}[a]||"text-gray-600 bg-gray-100"}`,children:t.leave_type.toUpperCase()}),e.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-semibold "+("allocation"===t.transaction_type?"bg-green-100 text-green-600":"bg-red-100 text-red-600"),children:"allocation"===t.transaction_type?" Allocation":" Deduction"}),e.jsx("span",{className:"text-lg font-bold text-gray-800",children:t.quantity})]}),e.jsxs("div",{className:"text-sm text-gray-700 mb-2",children:[e.jsx("strong",{children:"Reason:"})," ",t.reason]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-600",children:[e.jsxs("span",{children:[" ",t.performed_by_name]}),e.jsxs("span",{children:[" ",new Date(t.timestamp).toLocaleString()]}),e.jsxs("span",{children:["Before: ",t.balance_before,"  After: ",t.balance_after]})]})]})})},n);var a})})]})]}):null]})}):e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-12 text-center",children:[e.jsx("div",{className:"text-6xl mb-4",children:""}),e.jsx("h3",{className:"text-xl font-semibold text-gray-600 mb-2",children:"Select an Employee"}),e.jsx("p",{className:"text-gray-500",children:"Choose an employee from the list to view and manage their leave balance"})]})})]}),x&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-2xl max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-2xl font-bold text-gray-800 mb-4",children:" Manage Leaves"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 font-semibold mb-2",children:"Leave Type"}),e.jsxs("select",{value:y,onChange:e=>w(e.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500",children:[e.jsx("option",{value:"paid",children:"Paid Leave"}),e.jsx("option",{value:"earned",children:"Earned Leave"}),e.jsx("option",{value:"sick",children:"Sick Leave"}),e.jsx("option",{value:"casual",children:"Casual Leave"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 font-semibold mb-2",children:"Quantity"}),e.jsx("input",{type:"number",min:"1",value:v,onChange:e=>I(e.target.value),placeholder:"Enter number of leaves",className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 font-semibold mb-2",children:"Reason *"}),e.jsx("textarea",{value:_,onChange:e=>C(e.target.value),placeholder:"Enter reason for allocation/deduction",rows:3,className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:async()=>{if(s&&v&&_.trim())try{p(!0),m(null);const e={employee_id:s._id||s.id,leave_type:y,quantity:parseInt(v),reason:_.trim()},n=await S.post(`${Y0}/settings/leave-balance/allocate?user_id=${t?.user_id||t?._id}`,e);g(n.data.message),b(!1),I(""),C(""),E(s._id||s.id),setTimeout(()=>g(null),3e3)}catch(e){m(e.response?.data?.detail||"Failed to allocate leave")}finally{p(!1)}else m("Please fill all fields")},disabled:c,className:"flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold disabled:opacity-50",children:" Allocate"}),e.jsx("button",{onClick:async()=>{if(s&&v&&_.trim())try{p(!0),m(null);const e={employee_id:s._id||s.id,leave_type:y,quantity:parseInt(v),reason:_.trim()},n=await S.post(`${Y0}/settings/leave-balance/deduct?user_id=${t?.user_id||t?._id}`,e);g(n.data.message),b(!1),I(""),C(""),E(s._id||s.id),setTimeout(()=>g(null),3e3)}catch(e){m(e.response?.data?.detail||"Failed to deduct leave")}finally{p(!1)}else m("Please fill all fields")},disabled:c,className:"flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold disabled:opacity-50",children:" Deduct"}),e.jsx("button",{onClick:()=>{b(!1),I(""),C("")},className:"flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition-colors font-semibold",children:"Cancel"})]})]})]})})]})},J0=({userId:I})=>{const[_,C]=N.useState("settings"),[T,E]=k.useState({shift_start_time:"10:00",shift_end_time:"19:00",reporting_deadline:"10:15",full_day_working_hours:9,half_day_minimum_working_hours:5,grace_period_minutes:30,grace_usage_limit:2,pending_leave_auto_convert_days:3,absconding_penalty:-1,enable_sunday_sandwich_rule:!0,minimum_working_days_for_sunday:5,check_in_time:"09:30",check_out_time:"18:30",total_working_hours:9,late_arrival_threshold:"10:30",early_departure_threshold:"17:30",minimum_working_hours_full_day:8,minimum_working_hours_half_day:4,overtime_threshold:9,weekend_days:[5,6],allow_early_check_in:!0,allow_late_check_out:!0,require_photo:!0,require_geolocation:!0,geofence_enabled:!1,office_latitude:null,office_longitude:null,geofence_radius:100}),[A,$]=k.useState(!1),[R,F]=k.useState(!1),[D,M]=k.useState(null),[O,j]=k.useState(null),[L,z]=k.useState(!1),[P,B]=k.useState({});k.useEffect(()=>{W()},[]);const W=async()=>{$(!0),M(null);try{const e=await S.get(`${BASE_URL}/settings/attendance-settings`,{params:{user_id:I}});if(e.data.success){const t=e.data.data;E(t),B(t),z(!1)}}catch(e){M("Failed to load attendance settings")}finally{$(!1)}},V=(e,t)=>{const n={...T,[e]:t};E(n);const a=JSON.stringify(n)!==JSON.stringify(P);z(a)},U=(e,t)=>{V(e,t)},G=e=>{if(!e)return"";const[t,n]=e.split(":");return`${t.padStart(2,"0")}:${n.padStart(2,"0")}`};return A?e.jsx(t,{elevation:2,sx:{p:3,textAlign:"center"},children:e.jsx(n,{children:"Loading attendance settings..."})}):e.jsxs(a,{sx:{maxWidth:1200,mx:"auto",p:2},children:[e.jsxs(a,{sx:{display:"flex",gap:0,mb:3,border:"1px solid #374151",borderRadius:"8px",overflow:"hidden"},children:[e.jsx("button",{onClick:()=>C("settings"),style:{flex:1,padding:"12px 16px",border:"none",cursor:"pointer",fontSize:"14px",fontWeight:"500",background:"settings"===_?"linear-gradient(to right, #2563eb, #7c3aed)":"#111827",color:"settings"===_?"#fff":"#9ca3af",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:" Attendance Settings"}),e.jsx("button",{onClick:()=>C("face-registration"),style:{flex:1,padding:"12px 16px",border:"none",cursor:"pointer",fontSize:"14px",fontWeight:"500",background:"face-registration"===_?"linear-gradient(to right, #7c3aed, #db2777)":"#111827",color:"face-registration"===_?"#fff":"#9ca3af",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:" Face Registration"}),e.jsx("button",{onClick:()=>C("leave-management"),style:{flex:1,padding:"12px 16px",border:"none",cursor:"pointer",fontSize:"14px",fontWeight:"500",background:"leave-management"===_?"linear-gradient(to right, #059669, #0891b2)":"#111827",color:"leave-management"===_?"#fff":"#9ca3af",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},children:" Leave Management"})]}),"face-registration"===_&&e.jsx(X0,{}),"leave-management"===_&&e.jsx(Z0,{}),"settings"===_&&e.jsxs(a,{sx:{maxWidth:1200,mx:"auto"},children:[e.jsx(r,{elevation:2,sx:{mb:3},children:e.jsx(s,{avatar:e.jsx(u,{}),title:"Attendance Settings",subheader:"Configure attendance system parameters and rules",action:e.jsxs(a,{sx:{display:"flex",gap:1},children:[e.jsx(i,{variant:"outlined",startIcon:e.jsx(o,{}),onClick:async()=>{if(window.confirm("Are you sure you want to reset all attendance settings to default values?")){F(!0),M(null);try{(await S.post(`${BASE_URL}/settings/attendance-settings/reset`,{},{params:{user_id:I}})).data.message&&(j("Attendance settings reset to defaults"),await W(),setTimeout(()=>j(null),3e3))}catch(e){M(e.response?.data?.detail||"Failed to reset attendance settings")}finally{F(!1)}}},disabled:R,children:"Reset to Defaults"}),e.jsx(i,{variant:"contained",startIcon:e.jsx(l,{}),onClick:async()=>{F(!0),M(null);try{const e={};Object.keys(T).forEach(t=>{T[t]!==P[t]&&(e[t]=T[t])}),(await S.put(`${BASE_URL}/settings/attendance-settings`,e,{params:{user_id:I}})).data.message&&(j("Attendance settings updated successfully"),B(T),z(!1),setTimeout(()=>j(null),3e3))}catch(e){M(e.response?.data?.detail||"Failed to save attendance settings")}finally{F(!1)}},disabled:!L||R,loading:R,children:R?"Saving...":"Save Settings"})]})})}),e.jsxs(d,{container:!0,spacing:3,children:[e.jsx(d,{item:!0,xs:12,children:e.jsxs(r,{elevation:2,sx:{bgcolor:"#f8f9fa",border:"2px solid #2196f3"},children:[e.jsx(s,{avatar:e.jsx(c,{sx:{color:"#2196f3"}}),title:"Shift Timing Settings (Primary)",subheader:" Main shift timing configuration - This overrides check-in/check-out times",titleTypographyProps:{fontWeight:"bold"}}),e.jsx(p,{children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsx(d,{item:!0,xs:12,md:4,children:e.jsx(h,{label:"Shift Start Time",type:"time",value:G(T.shift_start_time),onChange:e=>U("shift_start_time",e.target.value),fullWidth:!0,InputLabelProps:{shrink:!0},helperText:"Official shift start (e.g., 10:00 AM)"})}),e.jsx(d,{item:!0,xs:12,md:4,children:e.jsx(h,{label:"Shift End Time",type:"time",value:G(T.shift_end_time),onChange:e=>U("shift_end_time",e.target.value),fullWidth:!0,InputLabelProps:{shrink:!0},helperText:"Official shift end (e.g., 7:00 PM)"})}),e.jsx(d,{item:!0,xs:12,md:4,children:e.jsx(h,{label:"Reporting Deadline",type:"time",value:G(T.reporting_deadline),onChange:e=>U("reporting_deadline",e.target.value),fullWidth:!0,InputLabelProps:{shrink:!0},helperText:"After this = Half Day (e.g., 10:15 AM)",sx:{"& .MuiInputBase-root":{bgcolor:"#fff3cd"}}})}),e.jsx(d,{item:!0,xs:12,children:e.jsxs(m,{severity:"info",children:[e.jsx("strong",{children:"Rule:"})," Punch In before ",G(T.reporting_deadline)," = Present | Punch In after ",G(T.reporting_deadline)," = Half Day"]})})]})})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(r,{elevation:2,sx:{bgcolor:"#f1f8ff",border:"2px solid #0366d6"},children:[e.jsx(s,{title:"Working Hours Settings (Main Calculation)",subheader:"These hours determine final attendance status",titleTypographyProps:{fontWeight:"bold"}}),e.jsx(p,{children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(h,{label:"Full Day Working Hours",type:"number",value:T.full_day_working_hours,onChange:e=>V("full_day_working_hours",parseFloat(e.target.value)),fullWidth:!0,inputProps:{min:1,max:24,step:.5},helperText:"Working  9 hrs = Full Day (Count = 1)"})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(h,{label:"Half Day Minimum Working Hours",type:"number",value:T.half_day_minimum_working_hours,onChange:e=>V("half_day_minimum_working_hours",parseFloat(e.target.value)),fullWidth:!0,inputProps:{min:1,max:12,step:.5},helperText:"Working  5 hrs but < 9 = Half Day (Count = 0.5)"})}),e.jsx(d,{item:!0,xs:12,children:e.jsxs(m,{severity:"warning",children:[e.jsx("strong",{children:"Logic:"})," ",e.jsx("br",{}),"  ",T.full_day_working_hours," hrs = ",e.jsx("strong",{children:"Full Day"})," (1) ",e.jsx("br",{}),"  ",T.half_day_minimum_working_hours," hrs but < ",T.full_day_working_hours," = ",e.jsx("strong",{children:"Half Day"})," (0.5) ",e.jsx("br",{})," < ",T.half_day_minimum_working_hours," hrs = ",e.jsx("strong",{children:"Zero"})," (0)"]})})]})})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(r,{elevation:2,sx:{bgcolor:"#fff8e1",border:"2px solid #ffc107"},children:[e.jsx(s,{title:"Grace Period Configuration",subheader:"Limited late coming without penalty",titleTypographyProps:{fontWeight:"bold"}}),e.jsx(p,{children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(h,{label:"Grace Period (Minutes)",type:"number",value:T.grace_period_minutes,onChange:e=>V("grace_period_minutes",parseInt(e.target.value)),fullWidth:!0,inputProps:{min:0,max:60,step:5},helperText:"E.g., 30 mins grace after deadline"})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(h,{label:"Grace Usage Limit (per month)",type:"number",value:T.grace_usage_limit,onChange:e=>V("grace_usage_limit",parseInt(e.target.value)),fullWidth:!0,inputProps:{min:0,max:10,step:1},helperText:"How many times grace can be used per month"})}),e.jsx(d,{item:!0,xs:12,children:e.jsxs(m,{severity:"info",children:[e.jsx("strong",{children:"Example:"})," Reporting deadline 10:15, Grace 30 mins",e.jsx("br",{})," Punch In 10:40 with grace available = ",e.jsx("strong",{children:"Present"}),e.jsx("br",{})," Punch In 10:40 with grace exhausted = ",e.jsx("strong",{children:"Half Day"})]})})]})})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(r,{elevation:2,sx:{bgcolor:"#fff3f3",border:"2px solid #dc3545"},children:[e.jsx(s,{title:"Leave & Absconding Rules",subheader:"Auto-conversion and penalty settings",titleTypographyProps:{fontWeight:"bold"}}),e.jsx(p,{children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(h,{label:"Pending Leave Auto-Convert (Days)",type:"number",value:T.pending_leave_auto_convert_days,onChange:e=>V("pending_leave_auto_convert_days",parseInt(e.target.value)),fullWidth:!0,inputProps:{min:1,max:7,step:1},helperText:"Convert unapproved leave to Absconding after X days"})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(h,{label:"Absconding Penalty",type:"number",value:T.absconding_penalty,onChange:e=>V("absconding_penalty",parseInt(e.target.value)),fullWidth:!0,inputProps:{min:-2,max:0,step:1},helperText:"Attendance count for absconding (negative value)",disabled:!0})}),e.jsx(d,{item:!0,xs:12,children:e.jsxs(m,{severity:"error",children:[e.jsx("strong",{children:"Rule:"})," ",e.jsx("br",{})," Leave not approved for ",T.pending_leave_auto_convert_days," days = Auto Absconding (-1)",e.jsx("br",{})," Manager can still approve later to convert back to Leave"]})})]})})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(r,{elevation:2,sx:{bgcolor:"#f3e5f5",border:"2px solid #9c27b0"},children:[e.jsx(s,{title:"Sunday & Sandwich Rules",subheader:"Weekend penalty rules for absconding",titleTypographyProps:{fontWeight:"bold"}}),e.jsx(p,{children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsxs(d,{item:!0,xs:12,children:[e.jsx(f,{control:e.jsx(g,{checked:T.enable_sunday_sandwich_rule,onChange:e=>V("enable_sunday_sandwich_rule",e.target.checked),color:"primary"}),label:"Enable Sunday Sandwich Rule"}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{ml:4,mt:1},children:"Saturday/Monday absconding  Sunday automatically becomes Zero"})]}),e.jsx(d,{item:!0,xs:12,children:e.jsx(h,{label:"Minimum Working Days for Sunday",type:"number",value:T.minimum_working_days_for_sunday,onChange:e=>V("minimum_working_days_for_sunday",parseInt(e.target.value)),fullWidth:!0,inputProps:{min:3,max:6,step:1},helperText:"If worked days < this, Sunday = 0",disabled:!T.enable_sunday_sandwich_rule})}),e.jsx(d,{item:!0,xs:12,children:e.jsxs(m,{severity:"warning",children:[e.jsx("strong",{children:"Rules:"})," ",e.jsx("br",{})," Saturday OR Monday absconding/unapproved = Sunday becomes ",e.jsx("strong",{children:"Zero (0)"}),e.jsx("br",{})," Working days < ",T.minimum_working_days_for_sunday," in week = Sunday ",e.jsx("strong",{children:"Zero (0)"}),e.jsx("br",{})," Penalty applied only once per Sunday"]})})]})})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(r,{elevation:2,children:[e.jsx(s,{avatar:e.jsx(c,{}),title:"Time Configuration",subheader:"Set standard check-in and check-out times"}),e.jsx(p,{children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsx(d,{item:!0,xs:6,children:e.jsx(h,{label:"Check-in Time",type:"time",value:G(T.check_in_time),onChange:e=>U("check_in_time",e.target.value),fullWidth:!0,InputLabelProps:{shrink:!0}})}),e.jsx(d,{item:!0,xs:6,children:e.jsx(h,{label:"Check-out Time",type:"time",value:G(T.check_out_time),onChange:e=>U("check_out_time",e.target.value),fullWidth:!0,InputLabelProps:{shrink:!0}})}),e.jsx(d,{item:!0,xs:6,children:e.jsx(h,{label:"Late Arrival Threshold",type:"time",value:G(T.late_arrival_threshold),onChange:e=>U("late_arrival_threshold",e.target.value),fullWidth:!0,InputLabelProps:{shrink:!0},helperText:"Check-in after this time = Half Day"})}),e.jsx(d,{item:!0,xs:6,children:e.jsx(h,{label:"Early Departure Threshold",type:"time",value:G(T.early_departure_threshold),onChange:e=>U("early_departure_threshold",e.target.value),fullWidth:!0,InputLabelProps:{shrink:!0},helperText:"Check-out before this time = Half Day"})})]})})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(r,{elevation:2,children:[e.jsx(s,{title:"Working Hours Configuration",subheader:"Define minimum hours for attendance status"}),e.jsx(p,{children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsx(d,{item:!0,xs:12,children:e.jsx(h,{label:"Total Working Hours",type:"number",value:T.total_working_hours,onChange:e=>V("total_working_hours",parseFloat(e.target.value)),fullWidth:!0,inputProps:{min:1,max:24,step:.5},helperText:"Expected daily working hours"})}),e.jsx(d,{item:!0,xs:6,children:e.jsx(h,{label:"Minimum Hours for Full Day",type:"number",value:T.minimum_working_hours_full_day,onChange:e=>V("minimum_working_hours_full_day",parseFloat(e.target.value)),fullWidth:!0,inputProps:{min:1,max:24,step:.5}})}),e.jsx(d,{item:!0,xs:6,children:e.jsx(h,{label:"Minimum Hours for Half Day",type:"number",value:T.minimum_working_hours_half_day,onChange:e=>V("minimum_working_hours_half_day",parseFloat(e.target.value)),fullWidth:!0,inputProps:{min:1,max:12,step:.5}})}),e.jsx(d,{item:!0,xs:6,children:e.jsx(h,{label:"Overtime Threshold (hours)",type:"number",value:T.overtime_threshold,onChange:e=>V("overtime_threshold",parseFloat(e.target.value)),fullWidth:!0,inputProps:{min:1,max:24,step:.5},helperText:"Hours after which overtime is calculated"})})]})})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(r,{elevation:2,children:[e.jsx(s,{title:"Weekend Configuration",subheader:"Select days considered as weekends"}),e.jsx(p,{children:e.jsx(x,{row:!0,children:[{value:0,label:"Monday"},{value:1,label:"Tuesday"},{value:2,label:"Wednesday"},{value:3,label:"Thursday"},{value:4,label:"Friday"},{value:5,label:"Saturday"},{value:6,label:"Sunday"}].map(t=>e.jsx(f,{control:e.jsx(b,{checked:T.weekend_days.includes(t.value),onChange:()=>(e=>{E(t=>({...t,weekend_days:t.weekend_days.includes(e)?t.weekend_days.filter(t=>t!==e):[...t.weekend_days,e].sort()}))})(t.value),color:"primary"}),label:t.label},t.value))})})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(r,{elevation:2,children:[e.jsx(s,{title:"Check-in/Check-out Permissions",subheader:"Control early and late check-in/out options"}),e.jsx(p,{children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsxs(d,{item:!0,xs:12,md:6,children:[e.jsx(f,{control:e.jsx(g,{checked:T.allow_early_check_in,onChange:e=>V("allow_early_check_in",e.target.checked),color:"primary"}),label:"Allow Early Check-in"}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Allow employees to check-in before scheduled time"})]}),e.jsxs(d,{item:!0,xs:12,md:6,children:[e.jsx(f,{control:e.jsx(g,{checked:T.allow_late_check_out,onChange:e=>V("allow_late_check_out",e.target.checked),color:"primary"}),label:"Allow Late Check-out"}),e.jsx(n,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Allow employees to check-out after scheduled time"})]})]})})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(r,{elevation:2,children:[e.jsx(s,{avatar:e.jsx(y,{}),title:"Requirements & Security",subheader:"Configure mandatory fields and validations"}),e.jsx(p,{children:e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(f,{control:e.jsx(g,{checked:T.require_photo,onChange:e=>V("require_photo",e.target.checked)}),label:"Photo Required for Check-in/out"}),e.jsx(f,{control:e.jsx(g,{checked:T.require_geolocation,onChange:e=>V("require_geolocation",e.target.checked)}),label:"Geolocation Required"}),e.jsx(f,{control:e.jsx(g,{checked:T.geofence_enabled,onChange:e=>V("geofence_enabled",e.target.checked)}),label:"Enable Geofence Validation"})]})})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(r,{elevation:2,children:[e.jsx(s,{avatar:e.jsx(w,{}),title:"Geofence Configuration",subheader:"Set office location and allowed radius"}),e.jsx(p,{children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsx(d,{item:!0,xs:6,children:e.jsx(h,{label:"Office Latitude",type:"number",value:T.office_latitude||"",onChange:e=>V("office_latitude",parseFloat(e.target.value)||null),fullWidth:!0,inputProps:{step:"any"},disabled:!T.geofence_enabled})}),e.jsx(d,{item:!0,xs:6,children:e.jsx(h,{label:"Office Longitude",type:"number",value:T.office_longitude||"",onChange:e=>V("office_longitude",parseFloat(e.target.value)||null),fullWidth:!0,inputProps:{step:"any"},disabled:!T.geofence_enabled})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(h,{label:"Geofence Radius (meters)",type:"number",value:T.geofence_radius,onChange:e=>V("geofence_radius",parseFloat(e.target.value)),fullWidth:!0,inputProps:{min:10,max:1e4,step:10},disabled:!T.geofence_enabled,helperText:"Allowed distance from office location"})})]})})]})})]}),e.jsx(v,{open:!!O,autoHideDuration:6e3,onClose:()=>j(null),children:e.jsx(m,{onClose:()=>j(null),severity:"success",children:O})}),e.jsx(v,{open:!!D,autoHideDuration:6e3,onClose:()=>M(null),children:e.jsx(m,{onClose:()=>M(null),severity:"error",children:D})})]})]})},{Title:Q0,Text:e1}=te,{Option:t1}=ne,{TextArea:n1}=ae,a1="/api",r1=()=>{const[t,n]=k.useState([]),[a,r]=k.useState(!1),[s,i]=k.useState(!1),[o,l]=k.useState(null),[u,d]=k.useState(new Set),[c,p]=k.useState(!1),[h,m]=k.useState(null),[f,g]=k.useState(""),[x,b]=k.useState(!1),[y,w]=k.useState(!0),[v,N]=k.useState(null),[S,$]=k.useState(new Set),[R,F]=k.useState({name:"",description:"",parent_id:null});k.useEffect(()=>{D()},[]),k.useEffect(()=>{const e=e=>{x&&!e.target.closest(".parent-dropdown-container")&&b(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[x]);const D=async()=>{r(!0);try{const e=localStorage.getItem("userData");if(!e)return void n([]);const{user_id:t}=JSON.parse(e),a=`${a1}/departments/?user_id=${t}`,r=await fetch(a);if(r.ok){const e=await r.json();n(Array.isArray(e)?e:[])}else n([])}catch(e){re.error("Failed to fetch departments"),n([])}finally{r(!1)}},M=e=>t.filter(t=>t.parent_id===e),O=()=>{if(f)return t.filter(e=>!(o&&e._id===o._id)&&e.name.toLowerCase().includes(f.toLowerCase())).map(e=>({...e,level:0,hasChildren:!1}));const e=(t,n=0,a=null)=>{const r=t._id,s=M(r).filter(e=>!o||e._id!==o._id),i=[{...t,level:n,hasChildren:s.length>0,isExpanded:S.has(r),parentName:a}];return S.has(r)&&s.forEach(a=>{const r=e(a,n+1,t.name);i.push(...r)}),i},n=[];return t.filter(e=>null===e.parent_id||void 0===e.parent_id).filter(e=>!o||e._id!==o._id).forEach(t=>{const a=e(t,0,null);n.push(...a)}),n},j=(e=null)=>{l(e),F(e?{name:e.name||"",description:e.description||"",parent_id:e.parent_id||null}:{name:"",description:"",parent_id:null}),w(!0),N(null),g(""),$(new Set),i(!0)},L=()=>{i(!1),l(null),F({name:"",description:"",parent_id:null}),w(!0),N(null),g(""),b(!1),$(new Set)},z=(t,n=!1)=>t&&0!==t.length?t.map(t=>e.jsxs("div",{className:"tree-item my-2 "+(n?"child-item":""),children:[e.jsxs("div",{className:"item-content bg-gray-900/50 hover:bg-gray-800/70 transition-colors duration-200 rounded-lg p-4 grid grid-cols-12 gap-4 items-center",children:[e.jsxs("div",{className:"col-span-6 flex items-center",children:[e.jsx("span",{className:`toggle-icon cursor-pointer user-select-none inline-flex items-center justify-center w-6 h-6 text-gray-400 transition-transform duration-300 ${t.children&&t.children.length>0?"hover:text-gray-200":"invisible"} ${u.has(t._id)?"rotate-[-90deg]":""}`,onClick:()=>t.children&&t.children.length>0&&(e=>{const t=new Set(u);t.has(e)?t.delete(e):t.add(e),d(t)})(t._id),children:e.jsx(A,{className:"h-4 w-4"})}),e.jsx(E,{className:"h-5 w-5 text-blue-400 ml-2 mr-3"}),e.jsx("span",{className:"font-medium text-white",children:t.name}),t.children&&t.children.length>0&&e.jsx("span",{className:"ml-3 bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full",children:t.children.length})]}),e.jsx("div",{className:"col-span-4 text-sm text-gray-400 truncate",children:t.description||"-"}),e.jsxs("div",{className:"col-span-2 flex items-center justify-end space-x-3",children:[e.jsx(_,{className:"h-5 w-5 text-gray-400 hover:text-white hover:scale-110 transition-all cursor-pointer",onClick:()=>j(t)}),e.jsx(C,{className:"h-5 w-5 text-gray-400 hover:text-red-400 hover:scale-110 transition-all cursor-pointer",onClick:()=>(m(t),void p(!0))})]})]}),t.children&&t.children.length>0&&e.jsx("div",{className:"children-container ml-7 pl-6 border-l border-blue-600/50 transition-all duration-400 overflow-hidden bg-white/[0.02] rounded-lg mt-2 "+(u.has(t._id)?"max-h-0 opacity-0 mt-0 pt-0 pb-0":"max-h-[1000px] opacity-100 pt-2 pb-2"),children:z(t.children,!0)})]},t._id)):e.jsx("div",{className:"text-gray-400 p-4",children:"No departments to display"}),P=k.useMemo(()=>((e,t="parent_id")=>{if(!Array.isArray(e)||0===e.length)return[];const n=e.map(e=>({...e,children:[]})),a=new Map(n.map((e,t)=>[e._id,t])),r=[];return n.forEach(e=>{null!==e[t]&&void 0!==e[t]&&a.has(e[t])?n[a.get(e[t])].children.push(e):r.push(e)}),r})(t),[t]);return e.jsxs("div",{className:"max-w-7xl mx-auto bg-gray-900/90 backdrop-blur-sm border border-white/10 rounded-xl shadow-2xl p-6 text-white",style:{fontFamily:"Inter, sans-serif"},children:[e.jsxs("div",{className:"flex justify-between items-center mb-6 px-2",children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Departments"}),e.jsxs("button",{onClick:()=>j(),className:"bg-gradient-to-r from-blue-500 to-sky-600 text-white font-bold py-2 px-5 rounded-lg flex items-center space-x-2 transform hover:scale-105 transition-transform",children:[e.jsx(I,{className:"h-5 w-5"}),e.jsx("span",{children:"Add Department"})]})]}),e.jsxs("div",{className:"item-content text-gray-400 uppercase text-xs font-semibold tracking-wide mb-4 px-4 grid grid-cols-12 gap-4",children:[e.jsx("div",{className:"col-span-6",children:"Department Name"}),e.jsx("div",{className:"col-span-4",children:"Description"}),e.jsx("div",{className:"col-span-2 text-center",children:"Actions"})]}),a?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"})}):0===P.length?e.jsxs("div",{className:"text-center py-12 text-gray-400",children:[e.jsx(E,{className:"h-16 w-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg",children:"No departments found"}),e.jsx("p",{className:"text-sm",children:'Click "Add Department" to create your first department'})]}):e.jsx("div",{className:"space-y-2",children:z(P)}),s&&e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 opacity-100 transition-opacity duration-300",children:e.jsxs("div",{className:"bg-gray-800 border border-white/10 p-8 rounded-xl w-full max-w-2xl transform scale-100 transition-transform duration-300",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:o?"Edit Department":"Add Department"}),e.jsx("button",{onClick:L,className:"text-gray-400 hover:text-white transition-colors p-1",children:e.jsx(T,{size:24})})]}),e.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{let e;if(o)e=`${a1}/departments/${o._id}`;else{const t=localStorage.getItem("userData"),{user_id:n}=JSON.parse(t);e=`${a1}/departments/?user_id=${n}`}const t=o?"PUT":"POST";if(!(await fetch(e,{method:t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(R)})).ok)throw new Error("Failed to save department");re.success(`Department ${o?"updated":"created"} successfully`),L(),D()}catch(t){re.error("Failed to save department")}},children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Department Name"}),e.jsx("input",{type:"text",required:!0,className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500",value:R.name,onChange:e=>F({...R,name:e.target.value}),placeholder:"Enter department name"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Description"}),e.jsx("input",{type:"text",className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500",value:R.description,onChange:e=>F({...R,description:e.target.value}),placeholder:"Enter description"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Parent Department"}),e.jsxs("div",{className:"relative parent-dropdown-container",children:[e.jsxs("button",{type:"button",className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 flex justify-between items-center",onClick:()=>b(!x),children:[e.jsx("span",{className:"text-left",children:(()=>{if(null===R.parent_id)return"No Parent";const e=t.find(e=>e._id===R.parent_id);return e?e.name:"Select Parent Department"})()}),e.jsx("svg",{className:"w-5 h-5 transition-transform "+(x?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),x&&e.jsxs("div",{className:"absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-xl mt-1 max-h-80 overflow-hidden flex flex-col",children:[e.jsx("div",{className:"p-3 border-b border-gray-200 bg-white sticky top-0",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{type:"text",className:"w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-black focus:outline-none focus:border-blue-400",placeholder:"Search departments...",value:f,onChange:e=>g(e.target.value),onClick:e=>e.stopPropagation(),autoFocus:!0})]})}),e.jsxs("div",{className:"overflow-y-auto max-h-60",children:[e.jsxs("div",{className:"px-4 py-3 cursor-pointer border-b border-gray-100 transition-colors "+(null===R.parent_id?"bg-yellow-200 text-black font-medium":"text-gray-800 hover:bg-blue-50"),onClick:()=>{F({...R,parent_id:null}),b(!1),g(""),$(new Set)},children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-2 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 14l-7 7m0 0l-7-7m7 7V3"})}),"No Parent"]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Top level department"})]}),O().map(t=>(t=>{const n=t._id,a=R.parent_id===n,r=20*t.level+16;return e.jsxs("div",{className:"border-b border-gray-100 transition-colors "+(a?"bg-yellow-200 text-black font-medium":"text-gray-800 hover:bg-blue-50"),children:[e.jsxs("div",{className:"py-3 flex items-center justify-between",style:{paddingLeft:`${r}px`,paddingRight:"16px"},children:[e.jsxs("div",{className:"flex items-center flex-1",children:[t.hasChildren&&!f?e.jsx("div",{className:"cursor-pointer p-1 hover:bg-gray-200 rounded mr-1",onClick:e=>{e.stopPropagation(),(e=>{const t=new Set(S);t.has(e)?t.delete(e):t.add(e),$(t)})(n)},children:e.jsx("svg",{className:"w-4 h-4 text-gray-500 transition-transform "+(t.isExpanded?"rotate-90":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5l7 7-7 7"})})}):e.jsx("div",{className:"w-6 h-6 mr-1 flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})})}),e.jsx("div",{className:"flex-1 cursor-pointer",onClick:()=>{F({...R,parent_id:n}),b(!1),g(""),$(new Set)},children:e.jsx("span",{children:t.name})})]}),t.hasChildren&&!f&&e.jsxs("div",{className:"text-xs text-gray-500 ml-2",children:[M(n).length," sub-department",1!==M(n).length?"s":""]})]}),t.level>0&&t.parentName&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",style:{paddingLeft:`${r}px`},children:["Sub-department of ",t.parentName]})]},n)})(t)),0===O().length&&e.jsxs("div",{className:"px-4 py-6 text-center text-gray-500",children:[e.jsx("svg",{className:"w-8 h-8 mx-auto mb-2 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})}),e.jsx("div",{className:"font-medium text-gray-600",children:0===t.length?"No departments created yet":f?`No departments found matching "${f}"`:"No departments available as parent"}),0===t.length?e.jsx("div",{className:"text-xs mt-2 text-gray-400",children:"Create your first department to establish hierarchy"}):e.jsxs("div",{className:"text-xs mt-2 text-gray-400",children:["Total departments: ",t.length," | Available as parent: ",O().length]})]})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsxs("button",{type:"button",onClick:L,className:"px-5 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold transition-colors",children:[e.jsx(T,{size:16,className:"inline mr-2"}),"Cancel"]}),e.jsx("button",{type:"submit",className:"px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-colors",children:"Save"})]})]})]})]})}),c&&e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 border border-white/10 p-8 rounded-xl max-w-md text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Are you sure?"}),e.jsxs("p",{className:"text-gray-400 mb-6",children:['This will permanently delete the department "',h?.name,'" and all its sub-departments.']}),e.jsxs("div",{className:"flex justify-center space-x-4",children:[e.jsx("button",{onClick:()=>p(!1),className:"px-5 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold transition-colors",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(h)try{const e=localStorage.getItem("userData");if(!e)return void re.error("User not authenticated");const{user_id:t}=JSON.parse(e),n=await fetch(`${a1}/departments/${h._id}?user_id=${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(n.ok)re.success("Department deleted successfully"),p(!1),m(null),D();else{const e=(await n.json().catch(()=>({}))).detail||"Failed to delete department";re.error(e)}}catch(e){re.error("Failed to delete department")}},className:"px-5 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors",children:"Delete"})]})]})})]})},s1=()=>{const[t,n]=k.useState([]),[a,r]=k.useState([]),[s,i]=k.useState(!1),[o,l]=k.useState(!1),[u,d]=k.useState(null),[c,p]=k.useState(!1),[h,m]=k.useState(null),[f,g]=k.useState(new Set(["SuperAdmin","feeds","leads","login","tasks","ickets","hrms","leaves","attendance","warnings","users","charts","apps","settings","interview","reports"])),[x,b]=k.useState(!1),[y,w]=k.useState(""),[v,N]=k.useState(!1),[S,T]=k.useState(!0),[E,M]=k.useState(null),[O,j]=k.useState(""),[L,z]=k.useState(new Set),[P,B]=k.useState(!1),[W,V]=k.useState(!0),[U,G]=k.useState(null),[H,q]=k.useState(""),[K,X]=k.useState(new Set),[Y,Z]=k.useState(null),[J,Q]=k.useState({}),[ee,te]=k.useState({name:"",description:"",department_id:null,reporting_id:null,permissions:[]}),ne={SuperAdmin:["*"],feeds:["show","post","all","delete"],"Leads CRM":{"Create LEAD":["show","add","reassignment_popup"],"PL & ODD LEADS":["show","own","junior","all","assign","download_obligation","status_update","delete"]},login:["show","own","junior","all","channel","edit","delete"],tasks:["show","own","junior","all","delete"],tickets:["show","own","junior","all","delete"],warnings:["show","own","junior","all","delete"],interview:["show","junior","all","settings","delete"],hrms:["show"],employees:["show","password","junior","all","role","delete"],leaves:["show","own","junior","all","delete"],attendance:["show","own","junior","all","delete"],apps:["show","manage"],notification:["show","delete","send"],reports:["show"],settings:["show"]},ae={"*":" Super Admin - Complete system access with all permissions",show:" Show - Can see the module in navigation menu",own:" Own Only - Can only manage their own records",junior:" Manager Level - Can manage subordinate records + own",all:" Admin Level - Can manage all records",settings:" Settings - Can manage module settings and configurations",delete:" Delete - Can delete records in this module",add:" Add - Can create new records",edit:" Edit - Can modify existing records",assign:" Assign - Can assign records to other users",reassignment_popup:" Reassignment Popup - Can view and interact with reassignment popup window",download_obligation:" Download - Can download obligation documents",status_update:" Status Update - Can update record status",view_other:" View Others - Can view other users records (deprecated)"};k.useEffect(()=>{se(),ie()},[]),k.useEffect(()=>{const e=e=>{null!==Y&&(e.target.closest(".reporting-role-dropdown")||(Z(null),Q({})))};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[Y]),k.useEffect(()=>{},[ee.permissions]),k.useEffect(()=>{const e=e=>{v&&!e.target.closest(".department-dropdown-container")&&N(!1),P&&!e.target.closest(".reporting-dropdown-container")&&B(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[v,P]);const se=async()=>{i(!0);try{const t=localStorage.getItem("userData");if(!t)return void n([]);const{user_id:a}=JSON.parse(t),r=[`/api/roles?user_id=${a}`,`/api/roles/?user_id=${a}`,"/api/roles/","/api/roles"];let s=null,i=!1;for(const n of r)try{const e=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(e.ok){s=await e.json(),i=!0;break}if(307===e.status){e.headers.get("Location");continue}}catch(e){continue}if(i&&s){const e=Array.isArray(s)?s:[];n(e)}else n([])}catch(t){re.error("Failed to fetch roles"),n([])}finally{i(!1)}},ie=async()=>{try{const e=localStorage.getItem("userData");if(!e)return void r([]);const{user_id:t}=JSON.parse(e),n=`/api/departments/?user_id=${t}`,a=await fetch(n);if(a.ok){const e=await a.json();r(Array.isArray(e)?e:[])}else r([])}catch(e){r([])}},oe=e=>{const t=new Set(f);t.has(e)?t.delete(e):t.add(e),g(t)},le=e=>a.filter(t=>t.parent_id===e),ue=()=>{if(O)return a.filter(e=>e.name.toLowerCase().includes(O.toLowerCase())).map(e=>({...e,level:0,hasChildren:!1}));const e=(t,n=0,a=null)=>{const r=t._id||t.id,s=le(r),i=[{...t,level:n,hasChildren:s.length>0,isExpanded:L.has(r),parentName:a}];return L.has(r)&&s.forEach(a=>{const r=e(a,n+1,t.name);i.push(...r)}),i},t=[];return a.filter(e=>null===e.parent_id||void 0===e.parent_id).forEach(n=>{const a=e(n,0,null);t.push(...a)}),t},de=(e=null)=>{if(d(e),e){const t={};let n=!1;e.permissions&&Array.isArray(e.permissions)&&(e.permissions.forEach(e=>{e.page.startsWith("leads.")&&"leads"!==e.page&&(n=!0)}),e.permissions.forEach(e=>{if("*"===e.page&&"*"===e.actions)t.SuperAdmin=["*"];else if(e.page.startsWith("leads.")){const n=e.page.split(".")[1];let a="";if("create_lead"===n?a="Create LEAD":"pl_&_odd_leads"!==n&&"pl_odd_leads"!==n||(a="PL & ODD LEADS"),a){const n=`Leads CRM.${a}`;t[n]||(t[n]=[]);const r=Array.isArray(e.actions)?e.actions:[e.actions];t[n]=[...t[n]||[],...r]}}else if("leads"!==e.page||n)if("leads"===e.page&&n);else{t[e.page]||(t[e.page]=[]);const n=Array.isArray(e.actions)?e.actions:[e.actions];t[e.page]=[...t[e.page]||[],...n]}else{const n=Array.isArray(e.actions)?e.actions:[e.actions],a=n.filter(e=>["show","add","edit","delete"].includes(e)),r=n.filter(e=>["show","own","junior","all"].includes(e)),s=n.filter(e=>["assign","download_obligation","status_update","delete"].includes(e));if(a.length>0){const e="Leads CRM.Create LEAD";t[e]||(t[e]=[]),a.forEach(n=>{t[e].includes(n)||t[e].push(n)})}const i=[...new Set([...r,...s])];if(i.length>0){const e="Leads CRM.PL & ODD LEADS";t[e]||(t[e]=[]),i.forEach(n=>{t[e].includes(n)||t[e].push(n)})}}}));let a=e.reporting_ids||[];!a.length&&e.reporting_id&&(a=[e.reporting_id]),a=a.filter(e=>e),te({name:e.name||"",description:e.description||"",department_id:e.department_id||null,reporting_ids:a,permissions:t})}else te({name:"",description:"",department_id:null,reporting_ids:[],permissions:{}});T(!0),M(null),j(""),N(!1),z(new Set),V(!0),G(null),q(""),B(!1),X(new Set),l(!0)},ce=()=>{l(!1),d(null),te({name:"",description:"",department_id:null,reporting_ids:[],permissions:{}}),T(!0),M(null),j(""),N(!1),z(new Set),V(!0),G(null),q(""),B(!1),X(new Set)},pe=(e,t)=>{const n=((e,t)=>({feeds:{show:" Show in Sidebar",post:" Create Post",all:" View All Posts",delete:" Delete Posts"},login:{show:" Show in Sidebar",own:" View Own Logins",junior:" View Team Logins",all:" View All Logins",channel:" Manage Channels",edit:" Edit Login Records",delete:" Delete Records"},tasks:{show:" Show in Sidebar",own:" View Own Tasks",junior:" View Team Tasks",all:" View All Tasks",delete:" Delete Tasks"},tickets:{show:" Show in Sidebar",own:" View Own Tickets",junior:" View Team Tickets",all:" View All Tickets",delete:" Delete Tickets"},warnings:{show:" Show in Sidebar",own:" View Own Warnings",junior:" View Team Warnings",all:" View All Warnings",delete:" Delete Warnings"},interview:{show:" Show in Sidebar",junior:" View Team Interviews",all:" View All Interviews",settings:" Interview Settings",delete:" Delete Interviews"},hrms:{show:" Show in Sidebar"},employees:{show:" Show in Sidebar",password:" Edit Password",junior:" View Team Employees",all:" View All Employees",delete:" Delete Employee"},leaves:{show:" Show in Sidebar",own:" View Own Leaves",junior:" Manage Team Leaves",all:" Manage All Leaves",delete:" Delete Leave Records"},attendance:{show:" Show in Sidebar",own:" View Own Attendance",junior:" View Team Attendance",all:" View All Attendance",delete:" Delete Attendance"},apps:{show:" Show in Sidebar",manage:" Create & Manage Apps"},notification:{show:" Show Notifications",delete:" Delete Notifications",send:" Send Notifications"},reports:{show:" View Reports"},settings:{show:" Access Settings"},"Leads CRM.Create LEAD":{show:" Show Section",add:" Create New Lead",reassignment_popup:" Reassignment Popup"},"Leads CRM.PL & ODD LEADS":{show:" Show Section",own:" View Own Leads",junior:" View Team Leads",all:" View All Leads",assign:" Assign Leads",download_obligation:" Download Docs",status_update:" Update Status",delete:" Delete Leads"}}[e]?.[t]||null))(e,t);return n||({show:" Show in Sidebar",own:" View Own Records",junior:" View Team Records",all:" View All Records",add:" Create New",edit:" Edit Records",delete:" Can Delete",settings:" Module Settings",assign:" Assign Records",password:" Edit Password",post:" Create Post",channel:" Manage Channels",manage:" Full Control",send:" Send Notifications",role:" Edit Role Field",reassignment_popup:" Reassignment Popup",download_obligation:" Download Docs",status_update:" Update Status"}[t]||t)},he=e=>{const t=ee.permissions["employees.role_field_roles"]||[],n=t.includes(e)?t.filter(t=>t!==e):[...t,e];te({...ee,permissions:{...ee.permissions,"employees.role_field_roles":n}})},me=(e,t,n)=>{const a={...ee.permissions};if("SuperAdmin"===e&&n)te({...ee,permissions:{SuperAdmin:["*"]}});else{if("SuperAdmin"===e&&!n){const e={...ee.permissions};return delete e.SuperAdmin,void te({...ee,permissions:e})}if("SuperAdmin"!==e&&ee.permissions.SuperAdmin&&delete a.SuperAdmin,a[e]||(a[e]=[]),e.includes(".")){const[t,n]=e.split(".")}n?a[e].includes(t)||a[e].push(t):a[e]=a[e].filter(e=>e!==t),te({...ee,permissions:a})}},fe=(e,t)=>{const n={...ee.permissions};if(t)if(e.includes(".")){const[t,a]=e.split("."),r=ne[t]?.[a];r&&(n[e]=[...r])}else{const t=ne[e];("object"!=typeof t||Array.isArray(t))&&(n[e]=[...ne[e]])}else n[e]=[];te({...ee,permissions:n})},ge=e=>{const t=a.find(t=>(t.id||t._id)===e);return t?t.name:"-"},xe=e=>!(!e.permissions||!Array.isArray(e.permissions))&&e.permissions.some(e=>"*"===e.page||"SuperAdmin"===e.page),be=e=>t.some(t=>(t.reporting_ids||(t.reporting_id?[t.reporting_id]:[])).includes(e)),ye=(e,n=new Set)=>{if(n.has(e))return[];n.add(e);const a=t.filter(t=>{const n=(t.reporting_ids||(t.reporting_id?[t.reporting_id]:[])).includes(e),a=t.name.toLowerCase().includes("manager");return n&&!a}),r=[...a];return a.forEach(e=>{r.push(...ye(e.id||e._id,n))}),r},we=(n,a,r)=>{const s=n.id||n._id,i=be(s),o=(n.reporting_ids||(n.reporting_id?[n.reporting_id]:[])).map(e=>{const n=t.find(t=>(t.id||t._id)===e);return n?n.name:null}).filter(e=>e),l=0===o.length||xe(n);return e.jsxs("tr",{style:{background:r?"#0a0a0a":"#000000",borderLeft:r?"6px solid #ffffff":"none",borderBottom:"1px solid #222222",transition:"all 0.2s ease"},onMouseEnter:e=>e.currentTarget.style.background="#0a0a0a",onMouseLeave:e=>e.currentTarget.style.background=r?"#0a0a0a":"#000000",children:[e.jsx("td",{style:{padding:r?"20px 15px":"16px 15px",paddingLeft:a>0?15+50*a+"px":"15px",borderRight:"1px solid #1a1a1a"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx("div",{style:{width:r?"12px":"10px",height:r?"12px":"10px",background:"#ffffff",borderRadius:"50%"}}),e.jsx("span",{style:{color:"#ffffff",fontWeight:r?"700":"500",fontSize:r?"1.05rem":"0.95rem"},children:n.name})]})}),e.jsx("td",{style:{padding:"16px 15px",borderRight:"1px solid #1a1a1a"},children:n.department_id?e.jsx("span",{style:{display:"inline-block",padding:"6px 14px",borderRadius:"6px",fontSize:"0.85rem",fontWeight:"600",background:"#000000",color:"#ffffff",border:"2px solid #555555"},children:ge(n.department_id)}):e.jsx("span",{style:{color:"#666666"},children:"-"})}),e.jsx("td",{style:{padding:"16px 15px",borderRight:"1px solid #1a1a1a"},children:l?e.jsx("span",{style:{color:"#666666",fontSize:"0.85rem"},children:"Top Level"}):o.length>0?o.length>1?e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"4px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx("svg",{style:{width:"16px",height:"16px"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 10l7-7m0 0l7 7m-7-7v18"})}),e.jsx("span",{style:{color:"#ffffff",fontWeight:"500"},children:o[0]})]}),o.slice(1).map((t,n)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px",color:"#cccccc"},children:[e.jsx("svg",{style:{width:"16px",height:"16px"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 10l7-7m0 0l7 7m-7-7v18"})}),e.jsx("span",{children:t}),e.jsx("span",{style:{fontSize:"0.75rem",color:"#888888"},children:"(Secondary)"})]},n))]}):e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx("svg",{style:{width:"16px",height:"16px"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 10l7-7m0 0l7 7m-7-7v18"})}),e.jsx("span",{style:{color:"#ffffff",fontWeight:"500"},children:o[0]})]}):e.jsx("span",{style:{color:"#666666"},children:"-"})}),e.jsx("td",{style:{padding:"16px 15px",borderRight:"1px solid #1a1a1a"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx("svg",{style:{width:"16px",height:"16px"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"})}),e.jsx("span",{style:{color:"#ffffff",fontWeight:"500"},children:(u=n.permissions,u&&Array.isArray(u)?u.reduce((e,t)=>{if("*"===t.page){let e=0;return Object.values(ne).forEach(t=>{"*"===t||Array.isArray(t)&&t.includes("*")||("object"!=typeof t||Array.isArray(t)?Array.isArray(t)&&(e+=t.length):Object.values(t).forEach(t=>{Array.isArray(t)&&(e+=t.length)}))}),e}return t.page&&t.page.includes("."),e+(t.actions?.length||0)},0):0)})]})}),e.jsx("td",{style:{padding:"16px 15px"},children:e.jsxs("div",{style:{display:"flex",gap:"10px",justifyContent:"center"},children:[e.jsx("button",{onClick:()=>de(n),style:{width:"36px",height:"36px",borderRadius:"6px",border:"2px solid #ffffff",background:"#000000",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#ffffff",transition:"all 0.2s"},onMouseEnter:e=>{e.currentTarget.style.background="#ffffff",e.currentTarget.style.color="#000000",e.currentTarget.style.transform="scale(1.05)"},onMouseLeave:e=>{e.currentTarget.style.background="#000000",e.currentTarget.style.color="#ffffff",e.currentTarget.style.transform="scale(1)"},title:"Edit",children:e.jsx(_,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>(n=>{const a=t.some(e=>e.reporting_id===(n.id||n._id));a?re.error({content:e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold",children:['Cannot delete role "',n.name,'"']}),e.jsx("p",{className:"text-sm mt-1",children:"This role has direct reports. Please reassign or delete subordinate roles first."})]}),duration:5}):(m(n),p(!0))})(n),disabled:i,style:{width:"36px",height:"36px",borderRadius:"6px",border:i?"2px solid #333333":"2px solid #666666",background:"#000000",cursor:i?"not-allowed":"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:i?"#333333":"#666666",transition:"all 0.2s"},onMouseEnter:e=>{i||(e.currentTarget.style.background="#ffffff",e.currentTarget.style.borderColor="#ffffff",e.currentTarget.style.color="#000000",e.currentTarget.style.transform="scale(1.05)")},onMouseLeave:e=>{i||(e.currentTarget.style.background="#000000",e.currentTarget.style.borderColor="#666666",e.currentTarget.style.color="#666666",e.currentTarget.style.transform="scale(1)")},title:i?"Cannot delete - has direct reports":"Delete",children:e.jsx(C,{className:"h-4 w-4"})})]})})]},s);var u};return(e=>{if(!Array.isArray(e)||0===e.length)return[];const t=new Map(e.map((e,t)=>[e.id||e._id,{...e,children:[]}])),n=[];e.forEach(e=>{const a=t.get(e.id||e._id);let r=!1;const s=e.reporting_ids||(e.reporting_id?[e.reporting_id]:[]);if(s.length>0){const e=s[0];t.has(e)&&(t.get(e).children.push(a),r=!0)}r||n.push(a)})})(t),Object.values(ne).flat().length,Object.values(ee.permissions).flat().length,e.jsxs("div",{style:{maxWidth:"1400px",margin:"0 auto",background:"#000000",border:"1px solid #333333",borderRadius:"12px",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.5)",padding:"2rem",color:"#ffffff",fontFamily:"Segoe UI, Tahoma, Geneva, Verdana, sans-serif"},children:[e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"center",marginBottom:"2rem"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:e.jsxs("button",{onClick:async e=>{e.preventDefault(),e.stopPropagation();try{await(async()=>{try{const n=localStorage.getItem("userData"),r=localStorage.getItem("token");if(!n||!r)return void re.error("Authentication required");const{user_id:s}=JSON.parse(n);re.loading("Fetching latest data from database...",0);let i=null;const o=[`/api/roles?user_id=${s}`,`/api/roles/?user_id=${s}`,"/api/roles/","/api/roles"];for(const t of o)try{const e=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`}});if(e.ok){i=await e.json();break}}catch(e){continue}let l=null;try{const e=await fetch(`/api/departments/?user_id=${s}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`}});e.ok&&(l=await e.json())}catch(e){l=a}re.destroy();const u=i&&Array.isArray(i)&&i.length>0?i:t,d=l&&Array.isArray(l)&&l.length>0?l:a;if(!u||0===u.length)return void re.warning("No roles data available");const c=((e,n)=>{try{const r=e||t,s=n||a,i=[];Object.entries(ne).forEach(([e,t])=>{"SuperAdmin"!==e&&("object"!=typeof t||Array.isArray(t)?Array.isArray(t)&&i.push({module:e,originalModule:e,section:null,actions:[...t],isNested:!1}):Object.entries(t).forEach(([t,n])=>{Array.isArray(n)&&i.push({module:`${e} - ${t}`,originalModule:e,section:t,actions:[...n],isNested:!0})}))});const o=e=>e.permissions&&Array.isArray(e.permissions)?e.permissions.reduce((e,t)=>{if("*"===t.page){let e=0;return Object.values(ne).forEach(t=>{"*"===t||Array.isArray(t)&&t.includes("*")||("object"!=typeof t||Array.isArray(t)?Array.isArray(t)&&(e+=t.length):Object.values(t).forEach(t=>{Array.isArray(t)&&(e+=t.length)}))}),e}return t.page&&t.page.includes("."),e+(t.actions?.length||0)},0):0;let l='\n                <tr>\n                    <th rowspan="2" class="sticky-col role-col">\n                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">\n                            <span>Role Name</span>\n                            <div style="display: flex; gap: 4px;">\n                                <button onclick="toggleFilter()" class="filter-btn" title="Filter Roles"></button>\n                                <button onclick="sortTable()" class="sort-btn" title="Sort A-Z / Z-A"></button>\n                            </div>\n                        </div>\n                    </th>\n                    <th rowspan="2">\n                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">\n                            <span>Department</span>\n                            <button onclick="sortByDepartment()" class="sort-btn" title="Sort by Department"></button>\n                        </div>\n                    </th>\n                    <th rowspan="2">\n                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">\n                            <span>Reports To</span>\n                            <button onclick="sortByReportsTo()" class="sort-btn" title="Sort by Reports To"></button>\n                        </div>\n                    </th>\n                    <th rowspan="2" class="sticky-col perm-col">\n                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">\n                            <span>Permissions</span>\n                            <button onclick="sortByPermissions()" class="sort-btn" title="Sort by Permission Count"></button>\n                        </div>\n                    </th>';i.forEach((e,t)=>{const n=t===i.length-1;l+=`<th colspan="${e.actions.length}" class="module-header ${n?"":"module-partition"}">${e.module.toUpperCase()}</th>`}),l+="</tr>";let u="<tr>";i.forEach((e,t)=>{e.actions.forEach((e,n)=>{u+=`<th class="action-header ${0===n&&t>0?"action-partition":""}">${e}</th>`})}),u+="</tr>";let d="";return r.forEach(e=>{const t=e.permissions&&e.permissions.some(e=>"*"===e.page),n=s.find(t=>(t.id||t._id)===e.department_id),a=(e.reporting_ids||(e.reporting_id?[e.reporting_id]:[])).map(e=>r.find(t=>(t.id||t._id)===e)).filter(e=>e).map(e=>e.name),l=o(e);d+='<tr class="data-row">',d+=`<td class="sticky-col role-name" data-role="${e.name.toLowerCase()}">${e.name}</td>`,d+=`<td class="dept-cell">${n?.name||"-"}</td>`,d+=`<td class="reports-cell">${a.length>0?a.join(", "):"Top Level"}</td>`,d+=`<td class="sticky-col perm-cell">${l}</td>`,i.forEach((n,a)=>{n.actions.forEach((r,s)=>{const i=0===s&&a>0;let o=!1;if(t)o=!0;else if(e.permissions&&Array.isArray(e.permissions))if(n.isNested){const t=`${"Leads CRM"===n.originalModule?"leads":n.originalModule.toLowerCase()}.${n.section.toLowerCase().replace(/ & /g,"_").replace(/ /g,"_")}`,a=e.permissions.find(e=>e.page===t);n.originalModule,a&&a.actions&&a.actions.includes(r)&&(o=!0)}else{const t=e.permissions.find(e=>e.page===n.module);t&&t.actions&&t.actions.includes(r)&&(o=!0)}d+=`<td class="check-cell ${i?"cell-partition":""}">${o?'<span class="check-yes"></span>':'<span class="check-no">-</span>'}</td>`})}),d+="</tr>"}),`\n                <!DOCTYPE html>\n                <html>\n                <head>\n                    <title>Roles & Permissions Report</title>\n                    <meta charset="UTF-8">\n                    <style>\n                        * { margin: 0; padding: 0; box-sizing: border-box; }\n                        body { \n                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                            padding: 20px;\n                            min-height: 100vh;\n                        }\n                        .container {\n                            max-width: 100%;\n                            background: #fff;\n                            border-radius: 12px;\n                            box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n                            overflow: hidden;\n                        }\n                        .header {\n                            background: linear-gradient(135deg, #000 0%, #333 100%);\n                            color: #fff;\n                            padding: 30px;\n                            text-align: center;\n                        }\n                        .header h1 {\n                            font-size: 28px;\n                            margin-bottom: 10px;\n                        }\n                        .header .timestamp {\n                            font-size: 14px;\n                            opacity: 0.8;\n                        }\n                        .table-wrapper {\n                            overflow-x: auto;\n                            overflow-y: visible;\n                            margin: 20px;\n                            scroll-behavior: smooth;\n                            -webkit-overflow-scrolling: touch;\n                        }\n                        table {\n                            width: max-content;\n                            border-collapse: separate;\n                            border-spacing: 0;\n                            font-size: 13px;\n                        }\n                        thead {\n                            position: sticky;\n                            top: 0;\n                            z-index: 20;\n                        }\n                        th {\n                            position: sticky;\n                            top: 0;\n                            background: #000;\n                            color: #fff;\n                            padding: 12px 8px;\n                            font-weight: bold;\n                            text-align: center;\n                            border: 1px solid #333;\n                            white-space: nowrap;\n                        }\n                        .sticky-col {\n                            position: sticky;\n                            background: #fff;\n                            z-index: 10;\n                        }\n                        th.sticky-col {\n                            z-index: 25;\n                            background: #000;\n                        }\n                        .role-col { left: 0; min-width: 250px; max-width: 250px; text-align: left !important; }\n                        .perm-col { left: 250px; min-width: 100px; }\n                        \n                        td.sticky-col {\n                            box-shadow: 2px 0 5px rgba(0,0,0,0.1);\n                        }\n                        \n                        .sort-btn, .filter-btn {\n                            background: #ffd700;\n                            color: #000;\n                            border: none;\n                            padding: 4px 8px;\n                            border-radius: 4px;\n                            cursor: pointer;\n                            font-size: 14px;\n                            font-weight: bold;\n                            transition: all 0.2s;\n                        }\n                        .sort-btn:hover, .filter-btn:hover {\n                            background: #ffed4e;\n                            transform: scale(1.1);\n                        }\n                        .filter-modal {\n                            display: none;\n                            position: fixed;\n                            z-index: 1000;\n                            left: 0;\n                            top: 0;\n                            width: 100%;\n                            height: 100%;\n                            background: rgba(0,0,0,0.8);\n                            align-items: center;\n                            justify-content: center;\n                        }\n                        .filter-modal.active {\n                            display: flex;\n                        }\n                        .filter-content {\n                            background: #1a1a1a;\n                            padding: 30px;\n                            border-radius: 12px;\n                            max-width: 500px;\n                            max-height: 80vh;\n                            overflow-y: auto;\n                            box-shadow: 0 10px 40px rgba(255,215,0,0.3);\n                        }\n                        .filter-content h3 {\n                            color: #ffd700;\n                            margin-bottom: 20px;\n                            font-size: 20px;\n                        }\n                        .filter-options {\n                            display: flex;\n                            flex-direction: column;\n                            gap: 10px;\n                            margin-bottom: 20px;\n                        }\n                        .filter-option {\n                            display: flex;\n                            align-items: center;\n                            gap: 10px;\n                            padding: 10px;\n                            background: #2a2a2a;\n                            border-radius: 6px;\n                            cursor: pointer;\n                            transition: all 0.2s;\n                        }\n                        .filter-option:hover {\n                            background: #3a3a3a;\n                        }\n                        .filter-option input[type="checkbox"] {\n                            width: 18px;\n                            height: 18px;\n                            cursor: pointer;\n                            accent-color: #ffd700;\n                        }\n                        .filter-option label {\n                            color: #fff;\n                            cursor: pointer;\n                            flex: 1;\n                        }\n                        .filter-buttons {\n                            display: flex;\n                            gap: 10px;\n                            justify-content: flex-end;\n                        }\n                        .filter-buttons button {\n                            padding: 10px 20px;\n                            border: none;\n                            border-radius: 6px;\n                            cursor: pointer;\n                            font-weight: bold;\n                            transition: all 0.2s;\n                        }\n                        .apply-filter {\n                            background: #ffd700;\n                            color: #000;\n                        }\n                        .apply-filter:hover {\n                            background: #ffed4e;\n                        }\n                        .cancel-filter {\n                            background: #555;\n                            color: #fff;\n                        }\n                        .cancel-filter:hover {\n                            background: #666;\n                        }\n                        .module-header {\n                            background: #000 !important;\n                            color: #ffd700 !important;\n                            font-size: 13px;\n                            text-transform: uppercase;\n                            letter-spacing: 1px;\n                            padding: 15px 8px !important;\n                            font-weight: 700;\n                        }\n                        .module-partition {\n                            border-left: 5px solid #ffd700 !important;\n                        }\n                        .action-header {\n                            background: #333 !important;\n                            color: #ffd700 !important;\n                            font-size: 12px;\n                            font-weight: 600;\n                            text-transform: lowercase;\n                        }\n                        .action-partition {\n                            border-left: 5px solid #ffd700 !important;\n                        }\n                        td {\n                            padding: 12px 8px;\n                            border: 1px solid #e0e0e0;\n                            text-align: center;\n                            white-space: nowrap;\n                        }\n                        \n                        .role-name {\n                            font-weight: 600;\n                            color: #000;\n                            text-align: left !important;\n                            padding-left: 15px !important;\n                            background: #f9f9f9;\n                            left: 0;\n                        }\n                        .dept-cell {\n                            font-size: 13px;\n                            color: #000;\n                            font-weight: 600;\n                            background: #fafafa;\n                        }\n                        .reports-cell {\n                            font-size: 13px;\n                            color: #000;\n                            font-weight: 600;\n                            background: #fafafa;\n                        }\n                        .perm-cell {\n                            font-weight: 700;\n                            color: #000;\n                            background: #fff9e6;\n                            left: 250px;\n                        }\n                        .check-cell {\n                            background: #fff;\n                            min-width: 50px;\n                        }\n                        .cell-partition {\n                            border-left: 5px solid #ffd700 !important;\n                        }\n                        .check-yes {\n                            color: #00c851;\n                            font-size: 20px;\n                            font-weight: bold;\n                        }\n                        .check-no {\n                            color: #ddd;\n                            font-size: 16px;\n                        }\n                        tr:hover td:not(.sticky-col) {\n                            background: #f0f7ff;\n                        }\n                        .data-row.hidden {\n                            display: none;\n                        }\n                        @media print {\n                            body { background: #fff; padding: 0; }\n                            .container { box-shadow: none; }\n                            @page { size: landscape; }\n                        }\n                    </style>\n                    <script>\n                        let sortAscending = true;\n                        let sortPermAscending = true;\n                        let sortDeptAscending = true;\n                        let sortReportsAscending = true;\n                        let selectedRoles = [];\n\n                        function sortTable() {\n                            const table = document.querySelector('tbody');\n                            const rows = Array.from(table.querySelectorAll('.data-row'));\n                            \n                            rows.sort((a, b) => {\n                                const aText = a.querySelector('.role-name').textContent.toLowerCase();\n                                const bText = b.querySelector('.role-name').textContent.toLowerCase();\n                                \n                                if (sortAscending) {\n                                    return aText.localeCompare(bText);\n                                } else {\n                                    return bText.localeCompare(aText);\n                                }\n                            });\n                            \n                            sortAscending = !sortAscending;\n                            rows.forEach(row => table.appendChild(row));\n                        }\n\n                        function sortByPermissions() {\n                            const table = document.querySelector('tbody');\n                            const rows = Array.from(table.querySelectorAll('.data-row'));\n                            \n                            rows.sort((a, b) => {\n                                const aCount = parseInt(a.querySelector('.perm-cell').textContent);\n                                const bCount = parseInt(b.querySelector('.perm-cell').textContent);\n                                \n                                if (sortPermAscending) {\n                                    return aCount - bCount; // Low to High\n                                } else {\n                                    return bCount - aCount; // High to Low\n                                }\n                            });\n                            \n                            sortPermAscending = !sortPermAscending;\n                            rows.forEach(row => table.appendChild(row));\n                        }\n\n                        function sortByDepartment() {\n                            const table = document.querySelector('tbody');\n                            const rows = Array.from(table.querySelectorAll('.data-row'));\n                            \n                            rows.sort((a, b) => {\n                                const aText = a.querySelector('.dept-cell').textContent.toLowerCase();\n                                const bText = b.querySelector('.dept-cell').textContent.toLowerCase();\n                                \n                                if (sortDeptAscending) {\n                                    return aText.localeCompare(bText);\n                                } else {\n                                    return bText.localeCompare(aText);\n                                }\n                            });\n                            \n                            sortDeptAscending = !sortDeptAscending;\n                            rows.forEach(row => table.appendChild(row));\n                        }\n\n                        function sortByReportsTo() {\n                            const table = document.querySelector('tbody');\n                            const rows = Array.from(table.querySelectorAll('.data-row'));\n                            \n                            rows.sort((a, b) => {\n                                const aText = a.querySelector('.reports-cell').textContent.toLowerCase();\n                                const bText = b.querySelector('.reports-cell').textContent.toLowerCase();\n                                \n                                if (sortReportsAscending) {\n                                    return aText.localeCompare(bText);\n                                } else {\n                                    return bText.localeCompare(aText);\n                                }\n                            });\n                            \n                            sortReportsAscending = !sortReportsAscending;\n                            rows.forEach(row => table.appendChild(row));\n                        }\n\n                        function toggleFilter() {\n                            const modal = document.getElementById('filterModal');\n                            modal.classList.toggle('active');\n                        }\n\n                        function applyFilter() {\n                            const checkboxes = document.querySelectorAll('.role-checkbox:checked');\n                            selectedRoles = Array.from(checkboxes).map(cb => cb.value);\n                            \n                            const rows = document.querySelectorAll('.data-row');\n                            if (selectedRoles.length === 0) {\n                                rows.forEach(row => row.classList.remove('hidden'));\n                            } else {\n                                rows.forEach(row => {\n                                    const roleName = row.querySelector('.role-name').getAttribute('data-role');\n                                    if (selectedRoles.includes(roleName)) {\n                                        row.classList.remove('hidden');\n                                    } else {\n                                        row.classList.add('hidden');\n                                    }\n                                });\n                            }\n                            \n                            toggleFilter();\n                        }\n\n                        function clearFilter() {\n                            const checkboxes = document.querySelectorAll('.role-checkbox');\n                            checkboxes.forEach(cb => cb.checked = false);\n                            selectedRoles = [];\n                            \n                            const rows = document.querySelectorAll('.data-row');\n                            rows.forEach(row => row.classList.remove('hidden'));\n                            \n                            toggleFilter();\n                        }\n                    <\/script>\n                </head>\n                <body>\n                    <div class="container">\n                        <div class="header">\n                            <h1> ROLES & PERMISSIONS REPORT</h1>\n                            <div class="timestamp">Generated: ${(new Date).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}</div>\n                        </div>\n                        \n                        \x3c!-- Filter Modal --\x3e\n                        <div id="filterModal" class="filter-modal">\n                            <div class="filter-content">\n                                <h3> Filter Roles</h3>\n                                <div class="filter-options">\n                                    ${r.map(e=>`\n                                        <div class="filter-option">\n                                            <input type="checkbox" class="role-checkbox" value="${e.name.toLowerCase()}" id="role-${e.name.replace(/\s+/g,"-").toLowerCase()}">\n                                            <label for="role-${e.name.replace(/\s+/g,"-").toLowerCase()}">${e.name}</label>\n                                        </div>\n                                    `).join("")}\n                                </div>\n                                <div class="filter-buttons">\n                                    <button class="cancel-filter" onclick="clearFilter()">Clear All</button>\n                                    <button class="apply-filter" onclick="applyFilter()">Apply Filter</button>\n                                </div>\n                            </div>\n                        </div>\n                        \n                        <div class="table-wrapper">\n                            <table>\n                                <thead>\n                                    ${l}\n                                    ${u}\n                                </thead>\n                                <tbody>\n                                    ${d}\n                                </tbody>\n                            </table>\n                        </div>\n                    </div>\n                </body>\n                </html>\n            `}catch(r){return"<html><body><h1>Error generating report</h1><p>"+r.message+"</p></body></html>"}})(u,d),p=window.open("","_blank");if(!p)return void re.error("Unable to open report window. Please check if pop-ups are blocked.");p.document.write(c),p.document.close(),re.success("Report generated successfully!")}catch(n){re.destroy(),re.error("Failed to generate report: "+n.message)}})()}catch(n){re.error("Error: "+n.message)}},style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",color:"#ffffff",fontWeight:"700",padding:"0.75rem 1.5rem",borderRadius:"0.5rem",display:"flex",alignItems:"center",gap:"0.5rem",border:"none",cursor:"pointer",transition:"all 0.3s",boxShadow:"0 4px 15px rgba(102, 126, 234, 0.4)"},onMouseEnter:e=>{e.currentTarget.style.transform="translateY(-2px)",e.currentTarget.style.boxShadow="0 6px 20px rgba(102, 126, 234, 0.6)"},onMouseLeave:e=>{e.currentTarget.style.transform="translateY(0)",e.currentTarget.style.boxShadow="0 4px 15px rgba(102, 126, 234, 0.4)"},title:"Download comprehensive interactive HTML report - Opens in new tab with all permissions and fixed columns",type:"button",children:[e.jsx($,{className:"h-5 w-5"}),e.jsx("span",{children:" Download Report"})]})}),e.jsxs("button",{onClick:()=>de(),style:{background:"#ffffff",color:"#000000",fontWeight:"600",padding:"0.625rem 1.5rem",borderRadius:"0.5rem",display:"flex",alignItems:"center",gap:"0.5rem",border:"none",cursor:"pointer",transition:"all 0.2s"},onMouseEnter:e=>{e.currentTarget.style.transform="scale(1.05)",e.currentTarget.style.background="#f0f0f0"},onMouseLeave:e=>{e.currentTarget.style.transform="scale(1)",e.currentTarget.style.background="#ffffff"},children:[e.jsx(I,{className:"h-5 w-5"}),e.jsx("span",{children:"Add New Role"})]})]})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsx("div",{className:"bg-gradient-to-br from-blue-500/10 to-blue-600/10 border border-blue-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-blue-400 text-sm font-medium",children:"Total Roles"}),e.jsx("div",{className:"text-2xl font-bold text-white mt-1",children:t.length})]}),e.jsx("div",{className:"bg-blue-500/20 p-3 rounded-lg",children:e.jsx(R,{className:"h-6 w-6 text-blue-400"})})]})}),e.jsx("div",{className:"bg-gradient-to-br from-purple-500/10 to-purple-600/10 border border-purple-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-purple-400 text-sm font-medium",children:"Top Level Roles"}),e.jsx("div",{className:"text-2xl font-bold text-white mt-1",children:t.filter(e=>!(e.reporting_id||e.reporting_ids&&0!==e.reporting_ids.length)).length})]}),e.jsx("div",{className:"bg-purple-500/20 p-3 rounded-lg",children:e.jsx(F,{className:"h-6 w-6 text-purple-400"})})]})}),e.jsx("div",{className:"bg-gradient-to-br from-green-500/10 to-green-600/10 border border-green-500/30 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-green-400 text-sm font-medium",children:"Departments"}),e.jsx("div",{className:"text-2xl font-bold text-white mt-1",children:a.length})]}),e.jsx("div",{className:"bg-green-500/20 p-3 rounded-lg",children:e.jsx("svg",{className:"h-6 w-6 text-green-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})})})]})})]}),s?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white"})}):e.jsxs("div",{style:{position:"relative",border:"2px solid #ffffff",borderRadius:"12px",overflow:"hidden",background:"#000000",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.5)"},children:[e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",textAlign:"left",fontSize:"0.95rem",borderCollapse:"collapse"},children:[e.jsx("thead",{style:{background:"#000000",borderBottom:"3px solid #ffffff",position:"sticky",top:0,zIndex:10},children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",style:{padding:"18px 15px",textAlign:"left",fontWeight:"700",fontSize:"0.95rem",textTransform:"uppercase",letterSpacing:"1.5px",color:"#ffffff",borderRight:"1px solid #333333",width:"30%"},children:"ROLE NAME"}),e.jsx("th",{scope:"col",style:{padding:"18px 15px",textAlign:"left",fontWeight:"700",fontSize:"0.95rem",textTransform:"uppercase",letterSpacing:"1.5px",color:"#ffffff",borderRight:"1px solid #333333",width:"20%"},children:"DEPARTMENT"}),e.jsx("th",{scope:"col",style:{padding:"18px 15px",textAlign:"left",fontWeight:"700",fontSize:"0.95rem",textTransform:"uppercase",letterSpacing:"1.5px",color:"#ffffff",borderRight:"1px solid #333333",width:"25%"},children:"REPORTS TO"}),e.jsx("th",{scope:"col",style:{padding:"18px 15px",textAlign:"left",fontWeight:"700",fontSize:"0.95rem",textTransform:"uppercase",letterSpacing:"1.5px",color:"#ffffff",borderRight:"1px solid #333333",width:"12%"},children:"PERMISSIONS"}),e.jsx("th",{scope:"col",style:{padding:"18px 15px",textAlign:"left",fontWeight:"700",fontSize:"0.95rem",textTransform:"uppercase",letterSpacing:"1.5px",color:"#ffffff",width:"13%"},children:"ACTIONS"})]})}),e.jsx("tbody",{children:(()=>{const n=[],a=(()=>{const e={superAdminRoles:[],teamGroups:[],standaloneRoles:[]};e.superAdminRoles=t.filter(e=>xe(e));const n=t.filter(e=>!xe(e));n.filter(e=>{const t=e.id||e._id;return be(t)}).forEach(t=>{const n=t.id||t._id;e.teamGroups.push({head:t,members:ye(n)})});const a=new Set;return e.teamGroups.forEach(e=>{e.members.forEach(e=>{a.add(e.id||e._id)})}),e.standaloneRoles=n.filter(e=>{const t=e.id||e._id,n=be(t),r=a.has(t);return!n&&!r}),e.teamGroups.sort((e,t)=>{const n=e.head.name.toLowerCase().includes("manager"),a=t.head.name.toLowerCase().includes("manager");return n&&!a?-1:!n&&a?1:e.head.name.localeCompare(t.head.name)}),e})();return a.superAdminRoles.forEach(e=>{n.push(we(e,0,!0))}),a.standaloneRoles.forEach(e=>{n.push(we(e,1,!1))}),a.teamGroups.forEach((t,r)=>{(r>0||a.standaloneRoles.length>0)&&n.push(e.jsx("tr",{style:{height:"2px",background:"#000000"},children:e.jsx("td",{colSpan:"5",style:{padding:0,borderTop:"2px solid #ffffff",borderBottom:"none"}})},`separator-${t.head.id||t.head._id}`)),n.push(we(t.head,0,!0)),t.members.forEach(e=>{n.push(we(e,1,!1))})}),n})()})]})}),t&&0===t.length&&e.jsxs("div",{style:{textAlign:"center",padding:"4rem 0",color:"#999999"},children:[e.jsx("div",{style:{background:"#1a1a1a",borderRadius:"50%",width:"80px",height:"80px",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 1rem",border:"2px solid #333333"},children:e.jsx(R,{className:"h-10 w-10",style:{opacity:.5,color:"#666666"}})}),e.jsx("p",{style:{fontSize:"1.125rem",fontWeight:"500",marginBottom:"0.5rem",color:"#cccccc"},children:"No roles found"}),e.jsx("p",{style:{fontSize:"0.875rem",color:"#666666"},children:'Click "Add New Role" to create your first role'})]})]}),o&&e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 border border-white/10 p-8 rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-6",children:u?"Edit Role":"Add Role"}),e.jsxs("form",{onSubmit:async e=>{e.preventDefault();const t=[];if(ee.permissions.SuperAdmin&&ee.permissions.SuperAdmin.length>0)t.push({page:"*",actions:"*"});else{const e=new Set;if(Object.keys(ee.permissions).forEach(n=>{const a=ee.permissions[n];if(n.includes(".")){const[r,s]=n.split("."),i=`${"Leads CRM"===r?"leads":r.toLowerCase()}.${s.toLowerCase().replace(/ & /g,"_").replace(/ /g,"_")}`;t.push({page:i,actions:a.length>0?a:[]}),"Leads CRM"===r&&a.length>0&&a.forEach(t=>e.add(t))}else a.length>0&&t.push({page:n,actions:a})}),e.size>0){const n=Array.from(e);t.push({page:"leads",actions:n})}}const n={...ee,permissions:t};try{const e=u?u.id||u._id:null;await D(n,e),re.success(`Role ${u?"updated":"created"} successfully! Permissions applied immediately.`),ce(),se()}catch(a){re.error("Failed to save role: "+(a.message||"Unknown error"))}},children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Role Name"}),e.jsx("input",{type:"text",required:!0,className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500",value:ee.name,onChange:e=>te({...ee,name:e.target.value}),placeholder:"Enter role name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Department"}),e.jsxs("div",{className:"relative department-dropdown-container",children:[e.jsxs("button",{type:"button",className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 flex justify-between items-center",onClick:()=>N(!v),children:[e.jsx("span",{className:"text-left",children:(()=>{if(null===ee.department_id)return"No Department";const e=a.find(e=>e._id===ee.department_id||e.id===ee.department_id);return e?e.name:"Select Department"})()}),e.jsx("svg",{className:"w-5 h-5 transition-transform "+(v?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),v&&e.jsxs("div",{className:"absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-xl mt-1 max-h-80 overflow-hidden flex flex-col",children:[e.jsx("div",{className:"p-3 border-b border-gray-200 bg-white sticky top-0",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{type:"text",className:"w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-black focus:outline-none focus:border-blue-400",placeholder:"Search departments...",value:O,onChange:e=>j(e.target.value),onClick:e=>e.stopPropagation()})]})}),e.jsxs("div",{className:"overflow-y-auto max-h-60",children:[e.jsxs("div",{className:"px-4 py-3 cursor-pointer border-b border-gray-100 transition-colors "+(null===ee.department_id?"bg-yellow-200 text-black font-medium":"text-gray-800 hover:bg-blue-50"),onClick:()=>{te({...ee,department_id:null}),N(!1),j(""),z(new Set)},children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-2 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 14l-7 7m0 0l-7-7m7 7V3"})}),"No Department"]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"No department assignment"})]}),ue().map(t=>(t=>{const n=t._id||t.id,a=ee.department_id===n,r=20*t.level+16;return e.jsxs("div",{className:"border-b border-gray-100 transition-colors "+(a?"bg-yellow-200 text-black font-medium":"text-gray-800 hover:bg-blue-50"),children:[e.jsxs("div",{className:"py-3 flex items-center justify-between",style:{paddingLeft:`${r}px`,paddingRight:"16px"},children:[e.jsxs("div",{className:"flex items-center flex-1",children:[t.hasChildren&&!O?e.jsx("div",{className:"cursor-pointer p-1 hover:bg-gray-200 rounded mr-1",onClick:e=>{e.stopPropagation(),(e=>{const t=new Set(L);t.has(e)?t.delete(e):t.add(e),z(t)})(n)},children:e.jsx("svg",{className:"w-4 h-4 text-gray-500 transition-transform "+(t.isExpanded?"rotate-90":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5l7 7-7 7"})})}):e.jsx("div",{className:"w-6 h-6 mr-1 flex items-center justify-center",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})})}),e.jsx("div",{className:"flex-1 cursor-pointer",onClick:()=>{te({...ee,department_id:n}),N(!1),j(""),z(new Set)},children:e.jsx("span",{children:t.name})})]}),t.hasChildren&&!O&&e.jsxs("div",{className:"text-xs text-gray-500 ml-2",children:[le(n).length," sub-department",1!==le(n).length?"s":""]})]}),t.level>0&&t.parentName&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",style:{paddingLeft:`${r}px`},children:["Sub-department of ",t.parentName]})]},n)})(t)),0===ue().length&&e.jsxs("div",{className:"px-4 py-6 text-center text-gray-500",children:[e.jsx("svg",{className:"w-8 h-8 mx-auto mb-2 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})}),e.jsx("div",{className:"font-medium text-gray-600",children:0===a.length?"No departments created yet":O?`No departments found matching "${O}"`:"No departments available"}),0===a.length?e.jsx("div",{className:"text-xs mt-2 text-gray-400",children:"Create your first department to organize roles"}):e.jsxs("div",{className:"text-xs mt-2 text-gray-400",children:["Total departments: ",a.length," | Available: ",ue().length]})]})]})]})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Reporting Roles"}),e.jsxs("div",{className:"space-y-2",children:[(ee.reporting_ids||[]).map((n,a)=>{const r=t.find(e=>(e._id||e.id)===n);return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 relative reporting-role-dropdown",children:e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>{Y===a?(Z(null),Q({...J,[a]:""})):(Z(a),Q({...J,[a]:""}))},className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-left focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-between",children:[e.jsx("span",{children:r?.name||"Select Reporting Role"}),e.jsx(A,{className:"h-4 w-4 transition-transform "+(Y===a?"rotate-180":"")})]}),Y===a&&e.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-gray-800 border border-gray-600 rounded-lg shadow-xl max-h-80 overflow-hidden",children:[e.jsx("div",{className:"p-2 border-b border-gray-600 sticky top-0 bg-gray-800",children:e.jsx("input",{type:"text",placeholder:" Search roles...",value:J[a]||"",onChange:e=>{Q({...J,[a]:e.target.value})},className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",onClick:e=>e.stopPropagation(),autoFocus:!0})}),e.jsx("div",{className:"overflow-y-auto max-h-64",children:(()=>{const r=t.filter(e=>{const t=e._id||e.id;return t!==(u?._id||u?.id)&&(!(ee.reporting_ids||[]).includes(t)||t===n)}),s=r.find(e=>e.name.toLowerCase().includes("super admin")||"super admin"===e.name.toLowerCase()),i=r.filter(e=>!(e.name.toLowerCase().includes("super admin")||"super admin"===e.name.toLowerCase()));i.sort((e,t)=>e.name.localeCompare(t.name));const o=s?[s,...i]:i,l=J[a]||"",d=l?o.filter(e=>e.name.toLowerCase().includes(l.toLowerCase())):o;return 0===d.length?e.jsx("div",{className:"px-4 py-3 text-gray-400 text-sm text-center",children:"No roles found"}):d.map(t=>{const r=t._id||t.id,s=t.name.toLowerCase().includes("super admin")||"super admin"===t.name.toLowerCase(),i=r===n;return e.jsxs("button",{type:"button",onClick:()=>{const e=[...ee.reporting_ids||[]];e[a]=r,te({...ee,reporting_ids:e}),Z(null),Q({...J,[a]:""})},className:`w-full text-left px-4 py-2 hover:bg-gray-700 transition-colors flex items-center ${i?"bg-blue-600 text-white":"text-gray-200"} ${s?"font-semibold":""}`,children:[s&&e.jsx("span",{className:"mr-2",children:""}),t.name,i&&e.jsx("span",{className:"ml-auto",children:""})]},r)})})()})]})]})}),e.jsx("button",{type:"button",onClick:()=>{const e=(ee.reporting_ids||[]).filter((e,t)=>t!==a);te({...ee,reporting_ids:e})},className:"px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",title:"Remove this reporting role",children:""})]},a)}),e.jsxs("button",{type:"button",onClick:()=>{const e=[...ee.reporting_ids||[],""];te({...ee,reporting_ids:e})},className:"w-full border-2 border-dashed border-gray-600 rounded-lg px-3 py-3 text-gray-400 hover:border-blue-500 hover:text-blue-500 transition-colors flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"+"}),e.jsx("span",{children:"Add Reporting Role"})]}),(!ee.reporting_ids||0===ee.reporting_ids.length)&&e.jsx("div",{className:"text-xs text-gray-500 text-center py-2",children:"This role doesn't report to anyone"})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-4",children:"Permissions"}),e.jsx("div",{className:"border-2 rounded-lg overflow-hidden mb-4 transition-all duration-300 "+(ee.permissions.SuperAdmin?"border-yellow-500 bg-gradient-to-r from-yellow-500/10 to-orange-500/10 shadow-lg shadow-yellow-500/20":"border-gray-600 hover:border-yellow-500/50"),children:e.jsx("div",{className:"p-4",children:e.jsxs("label",{className:"flex items-center cursor-pointer group",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"checkbox",className:"h-6 w-6 rounded mr-4 accent-yellow-500 transition-all",checked:!!ee.permissions.SuperAdmin,onChange:e=>me("SuperAdmin","*",e.target.checked)}),ee.permissions.SuperAdmin&&e.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-yellow-500 rounded-full animate-pulse"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(F,{className:"h-6 w-6 mr-3 transition-colors "+(ee.permissions.SuperAdmin?"text-yellow-400":"text-gray-400 group-hover:text-yellow-400")}),e.jsxs("div",{children:[e.jsx("span",{className:"text-lg font-bold transition-colors "+(ee.permissions.SuperAdmin?"text-yellow-400":"text-white group-hover:text-yellow-400"),children:"Super Administrator"}),ee.permissions.SuperAdmin&&e.jsx("span",{className:"ml-3 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full animate-pulse",children:"ACTIVE"}),e.jsx("p",{className:"text-sm mt-1 transition-colors "+(ee.permissions.SuperAdmin?"text-yellow-300":"text-gray-400"),children:"Complete system access with all permissions (page: *, actions: *)"})]})]})]})})}),!ee.permissions.SuperAdmin&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center text-lg font-semibold text-white mb-4"}),Object.entries(ne).filter(([e])=>"SuperAdmin"!==e).map(([n,a])=>{if("object"==typeof a&&!Array.isArray(a)){const t=Object.entries(a),r=t.reduce((e,[t,n])=>e+n.length,0),s=t.reduce((e,[t,a])=>e+(ee.permissions[`${n}.${t}`]||[]).length,0);return e.jsxs("div",{className:"border-2 border-indigo-600 rounded-lg overflow-hidden hover:border-indigo-400 transition-colors",children:[e.jsxs("div",{className:"bg-gradient-to-r from-indigo-700 to-indigo-600 p-3 cursor-pointer flex justify-between items-center hover:from-indigo-600 hover:to-indigo-500 transition-colors",onClick:()=>oe(n),children:[e.jsxs("label",{className:"font-bold flex items-center cursor-pointer text-lg",children:[e.jsxs("span",{className:"text-white",children:[" ",n]}),s>0&&e.jsxs("span",{className:"ml-2 bg-yellow-400 text-indigo-900 text-xs font-bold px-2 py-1 rounded-full",children:[s,"/",r]})]}),e.jsx(A,{className:"h-5 w-5 transition-transform text-white "+(f.has(n)?"rotate-180":"")})]}),e.jsx("div",{className:"transition-all duration-300 overflow-hidden "+(f.has(n)?"max-h-0":"max-h-[800px]"),children:e.jsx("div",{className:"p-4 bg-gray-800/50 space-y-3",children:t.map(([t,a])=>{const r=`${n}.${t}`,s=ee.permissions[r]||[],i=a.length>0&&a.length===s.length&&a.every(e=>s.includes(e)),o=s.length>0&&!i;return e.jsxs("div",{className:"border border-gray-600 rounded-lg overflow-hidden bg-gray-900/30",children:[e.jsx("div",{className:"bg-gray-700/70 p-2.5 flex items-center justify-between",children:e.jsxs("label",{className:"font-semibold flex items-center cursor-pointer text-sm",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded mr-2 accent-green-500",checked:i,ref:e=>{e&&(e.indeterminate=o)},onChange:e=>fe(r,e.target.checked),onClick:e=>e.stopPropagation()}),e.jsxs("span",{className:"text-gray-200",children:[" ",t]}),s.length>0&&e.jsx("span",{className:"ml-2 bg-green-500 text-white text-xs font-bold px-2 py-0.5 rounded-full",children:s.length})]})}),e.jsx("div",{className:"p-3 grid grid-cols-2 md:grid-cols-3 gap-2",children:a.map(t=>e.jsxs("label",{className:"flex items-center text-xs hover:bg-gray-700/50 p-2 rounded transition-colors",children:[e.jsx("input",{type:"checkbox",className:"h-3.5 w-3.5 rounded mr-2 accent-green-500",checked:s.includes(t),onChange:e=>me(r,t,e.target.checked)}),e.jsx("span",{className:"text-gray-300",children:pe(r,t)})]},t))})]},t)})})})]},n)}{const r=ee.permissions[n]||[],s=a.length>0&&a.length===r.length&&a.every(e=>r.includes(e)),i=r.length>0&&!s;return e.jsxs("div",{className:"border border-gray-600 rounded-lg overflow-hidden hover:border-indigo-500/50 transition-colors",children:[e.jsxs("div",{className:"bg-gray-700 p-3 cursor-pointer flex justify-between items-center hover:bg-gray-600 transition-colors",onClick:()=>oe(n),children:[e.jsxs("label",{className:"font-semibold flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"h-5 w-5 rounded mr-3 accent-indigo-500",checked:s,ref:e=>{e&&(e.indeterminate=i)},onChange:e=>fe(n,e.target.checked),onClick:e=>e.stopPropagation()}),e.jsx("span",{className:"text-white",children:n}),r.length>0&&e.jsx("span",{className:"ml-2 bg-indigo-500 text-white text-xs font-bold px-2 py-1 rounded-full",children:r.length})]}),e.jsx(A,{className:"h-5 w-5 transition-transform text-gray-400 "+(f.has(n)?"rotate-180":"")})]}),e.jsx("div",{className:"transition-all duration-300 overflow-hidden "+(f.has(n)?"max-h-0":"max-h-96"),children:e.jsx("div",{className:"p-4 bg-gray-800/50 grid grid-cols-2 md:grid-cols-3 gap-4",children:a.map(a=>{if("employees"===n&&"role"===a){const s=ee.permissions["employees.role_field_roles"]||[],i=r.includes("role");return e.jsxs("div",{className:"col-span-2 md:col-span-3 bg-indigo-900/30 border border-indigo-500/40 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs("label",{className:"flex items-center text-sm hover:bg-gray-700/50 p-1 rounded transition-colors cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded mr-2 accent-indigo-500",checked:i,onChange:e=>me(n,a,e.target.checked)}),e.jsx("span",{className:"text-gray-300 font-medium",children:" Role Field Edit"})]}),i&&e.jsxs("button",{type:"button",onClick:()=>b(!0),className:"flex items-center gap-1 px-3 py-1 bg-indigo-600 hover:bg-indigo-500 text-white text-xs rounded-full transition-colors",children:[" Configure Roles (",s.length,")"]})]}),i&&s.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-1",children:s.map(n=>{const a=t.find(e=>(e._id||e.id)===n);return a?e.jsxs("span",{className:"inline-flex items-center gap-1 bg-indigo-500/30 border border-indigo-400/50 text-indigo-200 text-xs px-2 py-0.5 rounded-full",children:[" ",a.name,e.jsx("button",{type:"button",onClick:()=>he(n),className:"hover:text-red-400 ml-1",children:""})]},n):null})}),i&&0===s.length&&e.jsx("p",{className:"text-xs text-yellow-400 mt-1",children:" No roles configured  all roles will be shown in dropdown"})]},a)}return e.jsxs("label",{className:"flex items-center text-sm hover:bg-gray-700/50 p-2 rounded transition-colors",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded mr-2 accent-indigo-500",checked:r.includes(a),onChange:e=>me(n,a,e.target.checked)}),e.jsx("span",{className:"text-gray-300",title:ae[a]||a,children:pe(n,a)})]},a)})})})]},n)}})]}),x&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",padding:"16px"},children:e.jsxs("div",{style:{background:"#1e1b4b",border:"1px solid #4f46e5",borderRadius:"12px",width:"100%",maxWidth:"480px",maxHeight:"80vh",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid #312e81",display:"flex",justifyContent:"space-between",alignItems:"center",background:"linear-gradient(to right, #312e81, #1e1b4b)"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{color:"white",margin:0,fontSize:"16px",fontWeight:700},children:" Configure Role Field Access"}),e.jsx("p",{style:{color:"#a5b4fc",margin:"4px 0 0",fontSize:"12px"},children:'Select which roles this employee\'s "Role" dropdown will show'})]}),e.jsx("button",{type:"button",onClick:()=>{b(!1),w("")},style:{background:"none",border:"none",color:"#a5b4fc",cursor:"pointer",fontSize:"18px",lineHeight:1},children:""})]}),e.jsx("div",{style:{padding:"12px 16px",borderBottom:"1px solid #312e81"},children:e.jsx("input",{type:"text",placeholder:" Search roles...",value:y,onChange:e=>w(e.target.value),style:{width:"100%",padding:"8px 12px",background:"#0f0a3c",border:"1px solid #4f46e5",borderRadius:"8px",color:"white",outline:"none",fontSize:"14px",boxSizing:"border-box"}})}),e.jsx("div",{style:{flex:1,overflowY:"auto",padding:"8px"},children:t.filter(e=>e.name?.toLowerCase().includes(y.toLowerCase())).map(t=>{const n=t._id||t.id,a=(ee.permissions["employees.role_field_roles"]||[]).includes(n);return e.jsxs("div",{onClick:()=>he(n),style:{display:"flex",alignItems:"center",gap:"12px",padding:"10px 14px",borderRadius:"8px",cursor:"pointer",marginBottom:"4px",background:a?"rgba(99,102,241,0.25)":"rgba(255,255,255,0.03)",border:a?"1px solid #6366f1":"1px solid transparent",transition:"all 0.15s"},children:[e.jsx("div",{style:{width:"20px",height:"20px",borderRadius:"4px",flexShrink:0,background:a?"#6366f1":"#312e81",border:"2px solid "+(a?"#818cf8":"#4f46e5"),display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px"},children:a?"":""}),e.jsxs("div",{style:{flex:1},children:[e.jsxs("div",{style:{color:a?"#e0e7ff":"#c7d2fe",fontSize:"14px",fontWeight:a?600:400},children:[" ",t.name]}),t.description&&e.jsx("div",{style:{color:"#7c83ad",fontSize:"11px",marginTop:"1px"},children:t.description})]})]},n)})}),e.jsxs("div",{style:{padding:"12px 16px",borderTop:"1px solid #312e81",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("span",{style:{color:"#a5b4fc",fontSize:"13px"},children:[(ee.permissions["employees.role_field_roles"]||[]).length," role(s) selected"]}),e.jsxs("div",{style:{display:"flex",gap:"8px"},children:[e.jsx("button",{type:"button",onClick:()=>te({...ee,permissions:{...ee.permissions,"employees.role_field_roles":[]}}),style:{padding:"7px 14px",background:"#7f1d1d",border:"none",borderRadius:"6px",color:"#fca5a5",fontSize:"12px",cursor:"pointer"},children:"Clear All"}),e.jsx("button",{type:"button",onClick:()=>{b(!1),w("")},style:{padding:"7px 16px",background:"#4f46e5",border:"none",borderRadius:"6px",color:"white",fontSize:"13px",fontWeight:600,cursor:"pointer"},children:" Done"})]})]})]})}),ee.permissions.SuperAdmin&&e.jsx("div",{className:"mt-6 p-4 bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-500/50 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(F,{className:"h-6 w-6 text-yellow-400 mr-3"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-yellow-400 font-semibold",children:"Super Administrator Access Enabled"}),e.jsx("p",{className:"text-yellow-300 text-sm mt-1",children:"This role has complete system access (page: *, actions: *). Individual permissions are not needed."})]})]})})]}),e.jsxs("div",{className:"flex justify-end space-x-4 mt-8",children:[e.jsx("button",{type:"button",onClick:ce,className:"px-5 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-5 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition-colors",children:"Save"})]})]})]})}),c&&e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 border border-white/10 p-8 rounded-xl max-w-md text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Are you sure?"}),e.jsxs("p",{className:"text-gray-400 mb-6",children:['This will permanently delete the role "',h?.name,'". Subordinate roles will need to be reassigned.']}),e.jsxs("div",{className:"flex justify-center space-x-4",children:[e.jsx("button",{onClick:()=>p(!1),className:"px-5 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold transition-colors",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(h)try{const e=await fetch(`/api/roles/${h.id||h._id}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(e.ok)re.success("Role deleted successfully"),p(!1),m(null),se();else{const t=await e.json().catch(()=>({}));let n="Failed to delete role";400===e.status&&t.detail&&(n=t.detail.includes("direct reports")?"Cannot delete role with direct reports. Please reassign subordinate roles first.":t.detail),re.error({content:n,duration:5}),p(!1),m(null)}}catch(e){re.error("Network error occurred while deleting role"),p(!1),m(null)}},className:"px-5 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors",children:"Delete"})]})]})})]})},i1=()=>{const[t,n]=k.useState([]),[a,r]=k.useState([]),[s,i]=k.useState(!1),[o,l]=k.useState(!1),[u,d]=k.useState(null),[c,p]=k.useState(new Set),[h,m]=k.useState(!1),[f,g]=k.useState(null),[x,b]=k.useState(!1),[y,w]=k.useState(!0),[v,N]=k.useState(null),[S,T]=k.useState(""),[E,$]=k.useState(!1),[R,F]=k.useState(!0),[D,j]=k.useState(null),[L,z]=k.useState(""),[P,B]=k.useState({name:"",description:"",department_id:null,reporting_designation_id:null,is_active:!0});k.useEffect(()=>{W(),V()},[]),k.useEffect(()=>{const e=e=>{x&&!e.target.closest(".department-dropdown-container")&&(b(!1),w(!0),N(null),T("")),E&&!e.target.closest(".reports-to-dropdown-container")&&($(!1),F(!0),j(null),z(""))};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[x,E]);const W=async()=>{i(!0);try{const e=await ee.getDesignations();if(e&&e.data){const t=Array.isArray(e.data)?e.data:e.data.designations||[];n(t)}else n([])}catch(e){re.error("Failed to fetch designations")}finally{i(!1)}},V=async()=>{try{const e=localStorage.getItem("userData");if(!e)return void r([]);const{user_id:t}=JSON.parse(e),n=`/api/departments/?user_id=${t}`,a=await fetch(n);if(a.ok){const e=await a.json();r(Array.isArray(e)?e:[])}else r([])}catch(e){r([])}},U=(e,t="reporting_designation_id")=>{if(!Array.isArray(e)||0===e.length)return[];const n=new Map(e.map((e,t)=>[e._id,t])),a=[];return e.forEach(e=>e.children=[]),e.forEach(r=>{null!==r[t]&&void 0!==r[t]&&n.has(r[t])?e[n.get(r[t])].children.push(r):a.push(r)}),a},G=(e=null)=>{d(e),B(e?{name:e.name||"",description:e.description||"",department_id:e.department_id||null,reporting_designation_id:e.reporting_designation_id||null,is_active:void 0===e.is_active||e.is_active}:{name:"",description:"",department_id:null,reporting_designation_id:null,is_active:!0}),l(!0)},H=()=>{l(!1),d(null),B({name:"",description:"",department_id:null,reporting_designation_id:null,is_active:!0})},q=e=>a.filter(t=>(t.parent_department_id||t.parent_id||t.parent_department||t.parentDepartmentId||t.parentId)===e),K=(e,t=!1)=>{t?(B(t=>({...t,department_id:e})),b(!1),w(!0),N(null),T("")):(N(e),w(!1))},X=e=>t.filter(t=>t.reporting_designation_id===e),Y=(e,t=!1)=>{t?(B(t=>({...t,reporting_designation_id:e})),$(!1),F(!0),j(null),z("")):(j(e),F(!1))},Z=e=>{const t=a.find(t=>t._id===e);return t?t.name:"-"},J=(t,n=!1)=>t.map(t=>e.jsxs("div",{className:"tree-item my-2 "+(n?"child-item":""),children:[e.jsxs("div",{className:"item-content bg-gray-900/50 hover:bg-gray-800/70 transition-colors duration-200 rounded-lg p-4 grid grid-cols-12 gap-4 items-center",children:[e.jsxs("div",{className:"col-span-3 flex items-center",children:[e.jsx("span",{className:`toggle-icon cursor-pointer user-select-none inline-flex items-center justify-center w-6 h-6 text-gray-400 transition-transform duration-300 ${t.children&&t.children.length>0?"hover:text-gray-200":"invisible"} ${c.has(t._id)?"rotate-[-90deg]":""}`,onClick:()=>t.children&&t.children.length>0&&(e=>{const t=new Set(c);t.has(e)?t.delete(e):t.add(e),p(t)})(t._id),children:e.jsx(A,{className:"h-4 w-4"})}),e.jsx(O,{className:"h-5 w-5 text-yellow-400 ml-2 mr-3"}),e.jsx("span",{className:"font-medium text-white",children:t.name}),t.children&&t.children.length>0&&e.jsx("span",{className:"ml-3 bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full",children:t.children.length})]}),e.jsx("div",{className:"col-span-2 text-sm",children:t.department_id?e.jsx("span",{className:"bg-blue-500/20 text-blue-300 px-2 py-1 rounded-md text-xs",children:Z(t.department_id)}):e.jsx("span",{className:"text-gray-400",children:"-"})}),e.jsx("div",{className:"col-span-4 text-sm text-gray-400 truncate",children:t.description||"-"}),e.jsx("div",{className:"col-span-1 text-center",children:e.jsx("span",{className:"px-2 py-1 rounded-full text-xs "+(t.is_active?"bg-green-500/20 text-green-300":"bg-red-500/20 text-red-300"),children:t.is_active?"Active":"Inactive"})}),e.jsxs("div",{className:"col-span-2 flex items-center justify-end space-x-3",children:[e.jsx(_,{className:"h-5 w-5 text-gray-400 hover:text-white hover:scale-110 transition-all cursor-pointer",onClick:()=>G(t)}),e.jsx(C,{className:"h-5 w-5 text-gray-400 hover:text-red-400 hover:scale-110 transition-all cursor-pointer",onClick:()=>(g(t),void m(!0))})]})]}),t.children&&t.children.length>0&&e.jsx("div",{className:"children-container ml-7 pl-6 border-l border-yellow-600/50 transition-all duration-400 overflow-hidden bg-white/[0.02] rounded-lg mt-2 "+(c.has(t._id)?"max-h-0 opacity-0 mt-0 pt-0 pb-0":"max-h-[1000px] opacity-100 pt-2 pb-2"),children:J(t.children,!0)})]},t._id)),Q=U(t);return U(a,"parent_id"),U(t),e.jsxs("div",{className:"max-w-7xl mx-auto bg-gray-900/90 backdrop-blur-sm border border-white/10 rounded-xl shadow-2xl p-6 text-white",style:{fontFamily:"Inter, sans-serif"},children:[e.jsxs("div",{className:"flex justify-between items-center mb-6 px-2",children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Designations"}),e.jsxs("button",{onClick:()=>G(),className:"bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-bold py-2 px-5 rounded-lg flex items-center space-x-2 transform hover:scale-105 transition-transform",children:[e.jsx(I,{className:"h-5 w-5"}),e.jsx("span",{children:"Add Designation"})]})]}),e.jsxs("div",{className:"item-content text-gray-400 uppercase text-xs font-semibold tracking-wide mb-4 px-4 grid grid-cols-12 gap-4",children:[e.jsx("div",{className:"col-span-3",children:"Designation Name"}),e.jsx("div",{className:"col-span-2",children:"Department"}),e.jsx("div",{className:"col-span-4",children:"Description"}),e.jsx("div",{className:"col-span-1 text-center",children:"Status"}),e.jsx("div",{className:"col-span-2 text-center",children:"Actions"})]}),s?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500"})}):e.jsx("div",{className:"space-y-2",children:J(Q)}),o&&e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 border border-white/10 p-8 rounded-xl w-full max-w-2xl",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-6",children:u?"Edit Designation":"Add Designation"}),e.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{u?(await ee.updateDesignation(u._id,P),re.success("Designation updated successfully")):(await ee.createDesignation(P),re.success("Designation created successfully")),H(),W()}catch(t){re.error("Failed to save designation")}},children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Designation Name"}),e.jsx("input",{type:"text",required:!0,className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500",value:P.name,onChange:e=>B({...P,name:e.target.value}),placeholder:"Enter designation name"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Department"}),e.jsxs("div",{className:"relative department-dropdown-container",children:[e.jsxs("button",{type:"button",onClick:()=>b(!x),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500 flex justify-between items-center",children:[e.jsx("span",{children:(()=>{if(P.department_id){const e=a.find(e=>e._id===P.department_id);return e?e.name:"Select Department"}return"Select Department"})()}),e.jsx(A,{className:"h-4 w-4"})]}),x&&e.jsxs("div",{className:"absolute top-full mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto",children:[e.jsxs("div",{className:"p-3 border-b border-gray-200 bg-white sticky top-0 z-10 rounded-t-lg",children:[!y&&v&&e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("button",{onClick:()=>w(!0),className:"flex items-center text-blue-600 hover:text-blue-800 text-sm font-medium",children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M15 19l-7-7 7-7"})}),"Back to Main Departments"]}),e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:a.find(e=>e._id===v)?.name})]}),e.jsx("input",{type:"text",placeholder:"Search departments...",value:S,onChange:e=>T(e.target.value),className:"w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",onClick:e=>e.stopPropagation()})]}),e.jsxs("div",{children:[e.jsx("div",{onClick:()=>{B(e=>({...e,department_id:null})),b(!1),w(!0),N(null)},className:"px-4 py-3 cursor-pointer text-black hover:bg-blue-200 transition-colors border-b border-gray-100 last:border-b-0 text-left",style:{backgroundColor:P.department_id?"":"#FFFF00",color:"#000000",fontWeight:P.department_id?"normal":"bold"},children:e.jsx("div",{className:"text-sm font-medium text-left select-none",children:"-- No Department --"})}),y?e.jsx("div",{children:a.filter(e=>{const t=e.parent_department_id||e.parent_id||e.parent_department||e.parentDepartmentId||e.parentId;return!t||null==t||""===t}).filter(e=>e.name.toLowerCase().includes(S.toLowerCase())).map(t=>{const n=q(t._id).length>0;return e.jsx("div",{className:"border-b border-gray-100 last:border-b-0",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-8 flex justify-center flex-shrink-0",children:n?e.jsx("button",{type:"button",className:"w-6 h-6 flex items-center justify-center hover:bg-gray-200 rounded transition-colors z-10",onClick:e=>{e.preventDefault(),e.stopPropagation(),K(t._id)},title:"Show sub-departments",children:e.jsx("svg",{className:"w-3 h-3 transform transition-transform text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})}):e.jsx("div",{className:"w-6 h-6 flex items-center justify-center",children:e.jsxs("svg",{className:"w-3 h-3 text-gray-400",fill:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{d:"M10 2v20l-5.5-5.5L10 2z"}),e.jsx("rect",{x:"12",y:"9",width:"10",height:"6",rx:"1"})]})})}),e.jsx("div",{className:"flex-1 px-3 py-3 cursor-pointer hover:bg-blue-200 flex flex-col transition-colors "+(P.department_id===t._id?"text-black font-bold":"text-black"),style:{backgroundColor:P.department_id===t._id?"#FFFF00":""},onClick:e=>{e.preventDefault(),e.stopPropagation(),K(t._id,!0)},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-medium text-left select-none",children:t.name}),n&&e.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:[q(t._id).length," sub-dept",1!==q(t._id).length?"s":""]})]})})]})},t._id)})}):e.jsxs("div",{children:[e.jsxs("div",{onClick:()=>w(!0),className:"px-3 py-2 cursor-pointer border-b border-gray-200 text-blue-600 hover:bg-blue-50 flex items-center",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Back to Main Departments"]}),v&&q(v).filter(e=>e.name.toLowerCase().includes(S.toLowerCase())).map(t=>e.jsx("div",{onClick:()=>K(t._id,!0),className:"px-4 py-3 cursor-pointer text-black hover:bg-blue-200 transition-colors border-b border-gray-100 last:border-b-0 text-left",style:{backgroundColor:P.department_id===t._id?"#FFFF00":"",color:"#000000",fontWeight:P.department_id===t._id?"bold":"normal"},children:e.jsxs("div",{className:"text-sm font-medium text-left select-none",children:[t.name,e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Main Department: ",a.find(e=>e._id===v)?.name]})]})},t._id))]})]})]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Reports To"}),e.jsxs("div",{className:"relative reports-to-dropdown-container",children:[e.jsxs("button",{type:"button",onClick:()=>$(!E),className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500 flex justify-between items-center",children:[e.jsx("span",{children:(()=>{if(P.reporting_designation_id){const e=t.find(e=>e._id===P.reporting_designation_id);return e?e.name:"Select Reports To"}return"Select Reports To"})()}),e.jsx(A,{className:"h-4 w-4"})]}),E&&e.jsxs("div",{className:"absolute top-full mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto",children:[e.jsx("div",{onClick:()=>{B(e=>({...e,reporting_designation_id:null})),$(!1),F(!0),j(null)},className:"px-4 py-3 cursor-pointer text-black hover:bg-blue-200 transition-colors border-b border-gray-100 last:border-b-0 text-left",style:{backgroundColor:P.reporting_designation_id?"":"#FFFF00",color:"#000000",fontWeight:P.reporting_designation_id?"normal":"bold"},children:e.jsx("div",{className:"text-sm font-medium text-left select-none",children:"No Reporting Designation"})}),e.jsx("div",{className:"p-3 border-b border-gray-200",children:e.jsx("input",{type:"text",placeholder:"Search designations...",value:L,onChange:e=>z(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",onClick:e=>e.stopPropagation()})}),R?e.jsx("div",{children:t.filter(e=>!e.reporting_designation_id).filter(e=>e._id!==u?._id).filter(e=>e.name.toLowerCase().includes(L.toLowerCase())).map(t=>{const n=X(t._id).length>0;return e.jsxs("div",{onClick:()=>n?Y(t._id):Y(t._id,!0),className:"px-4 py-3 cursor-pointer text-black hover:bg-blue-200 transition-colors border-b border-gray-100 last:border-b-0 text-left",style:{backgroundColor:P.reporting_designation_id===t._id?"#FFFF00":"",color:"#000000",fontWeight:P.reporting_designation_id===t._id?"bold":"normal"},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-medium text-left select-none",children:t.name}),n&&e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 5l7 7-7 7"})})]}),n&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[X(t._id).length," sub-designation",1!==X(t._id).length?"s":""]})]},t._id)})}):e.jsxs("div",{children:[e.jsxs("div",{onClick:()=>F(!0),className:"px-3 py-2 cursor-pointer border-b border-gray-200 text-blue-600 hover:bg-blue-50 flex items-center",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Back to Main Designations"]}),D&&X(D).filter(e=>e._id!==u?._id).filter(e=>e.name.toLowerCase().includes(L.toLowerCase())).map(n=>e.jsx("div",{onClick:()=>Y(n._id,!0),className:"px-4 py-3 cursor-pointer text-black hover:bg-blue-200 transition-colors border-b border-gray-100 last:border-b-0 text-left",style:{backgroundColor:P.reporting_designation_id===n._id?"#FFFF00":"",color:"#000000",fontWeight:P.reporting_designation_id===n._id?"bold":"normal"},children:e.jsxs("div",{className:"text-sm font-medium text-left select-none",children:[n.name,e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Main Designation: ",t.find(e=>e._id===D)?.name]})]})},n._id))]})]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Description"}),e.jsx("textarea",{rows:3,className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500",value:P.description,onChange:e=>B({...P,description:e.target.value}),placeholder:"Enter description"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Status"}),e.jsxs("select",{className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-yellow-500",value:P.is_active,onChange:e=>B({...P,is_active:"true"===e.target.value}),children:[e.jsx("option",{value:!0,children:"Active"}),e.jsx("option",{value:!1,children:"Inactive"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx("button",{type:"button",onClick:H,className:"px-5 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-5 py-2 rounded-lg bg-yellow-600 hover:bg-yellow-700 text-white font-semibold transition-colors",children:u?"Update":"Create"})]})]})]})}),h&&e.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 border border-white/10 p-8 rounded-xl max-w-md text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Are you sure?"}),e.jsxs("p",{className:"text-gray-400 mb-6",children:['This will permanently delete the designation "',f?.name,'".']}),e.jsxs("div",{className:"flex justify-center space-x-4",children:[e.jsx("button",{onClick:()=>m(!1),className:"px-5 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-semibold transition-colors",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(f)try{await ee.deleteDesignation(f._id),re.success("Designation deleted successfully"),m(!1),g(null),W()}catch(e){re.error("Failed to delete designation")}},className:"px-5 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors",children:"Delete"})]})]})})]})},o1="/api",l1=({tabs:t,activeTab:n,setActiveTab:a})=>{const[r,s]=k.useState(!1),i=t.filter(e=>["campaigns","dataCodes","bankNames","channelNames","companyData","statuses","importantQuestions","warningData"].includes(e.id));t.find(e=>e.id===n);const o=["campaigns","dataCodes","bankNames","channelNames","companyData","statuses","importantQuestions","warningData"].includes(n);return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>s(!r),className:"flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all "+(o?"bg-blue-500 text-white shadow-lg":"bg-white text-black hover:bg-black hover:text-white border border-black"),children:[e.jsx(Z,{size:16}),e.jsx("span",{children:"Dropdown Management"}),e.jsx(A,{size:16,className:"transform transition-transform "+(r?"rotate-180":"")})]}),r&&e.jsx("div",{className:"absolute left-0 top-full mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-xl z-50",children:e.jsxs("div",{className:"p-2",children:[e.jsx("div",{className:"text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2 mb-1",children:"Data Management"}),i.filter(e=>["campaigns","dataCodes","bankNames","channelNames","companyData"].includes(e.id)).map(t=>e.jsxs("button",{onClick:()=>{a(t.id),s(!1)},className:"w-full flex items-center gap-3 px-3 py-2 rounded-md text-left transition-colors "+(n===t.id?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-800 hover:text-white"),children:[e.jsx(t.icon,{size:16,className:"text-blue-400"}),e.jsx("span",{className:"text-sm font-medium",children:t.label})]},t.id)),e.jsx("hr",{className:"border-gray-700 my-2"}),e.jsx("div",{className:"text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2 mb-1",children:"System Management"}),i.filter(e=>["statuses","importantQuestions","warningData"].includes(e.id)).map(t=>e.jsxs("button",{onClick:()=>{a(t.id),s(!1)},className:"w-full flex items-center gap-3 px-3 py-2 rounded-md text-left transition-colors "+(n===t.id?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-800 hover:text-white"),children:[e.jsx(t.icon,{size:16,className:"text-blue-400"}),e.jsx("span",{className:"text-sm font-medium",children:t.label})]},t.id))]})}),r&&e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>s(!1)})]})},u1=({tabs:t,activeTab:n,setActiveTab:a})=>{const[r,s]=k.useState(!1),i=t.filter(e=>["departments","designations","roles","emailSettings","adminEmails"].includes(e.id));t.find(e=>e.id===n);const o=["departments","designations","roles","emailSettings","adminEmails"].includes(n);return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>s(!r),className:"flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all "+(o?"bg-green-500 text-white shadow-lg":"bg-white text-black hover:bg-black hover:text-white border border-black"),children:[e.jsx(E,{size:16}),e.jsx("span",{children:"Core Management"}),e.jsx(A,{size:16,className:"transform transition-transform "+(r?"rotate-180":"")})]}),r&&e.jsx("div",{className:"absolute left-0 top-full mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-xl z-50",children:e.jsxs("div",{className:"p-2",children:[e.jsx("div",{className:"text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2 mb-1",children:"Organizational Structure"}),i.map(t=>e.jsxs("button",{onClick:()=>{a(t.id),s(!1)},className:"w-full flex items-center gap-3 px-3 py-2 rounded-md text-left transition-colors "+(n===t.id?"bg-green-600 text-white":"text-gray-300 hover:bg-gray-800 hover:text-white"),children:[e.jsx(t.icon,{size:16,className:"text-green-400"}),e.jsx("span",{className:"text-sm font-medium",children:t.label})]},t.id))]})}),r&&e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>s(!1)})]})},d1=({tabs:t,activeTab:n,setActiveTab:a})=>{const[r,s]=k.useState(!1),i=t.filter(e=>["attachmentTypes","excelUpload","attendance"].includes(e.id));t.find(e=>e.id===n);const o=["attachmentTypes","excelUpload","attendance"].includes(n);return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>s(!r),className:"flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all "+(o?"bg-purple-500 text-white shadow-lg":"bg-white text-black hover:bg-black hover:text-white border border-black"),children:[e.jsx(W,{size:16}),e.jsx("span",{children:"Other"}),e.jsx(A,{size:16,className:"transform transition-transform "+(r?"rotate-180":"")})]}),r&&e.jsx("div",{className:"absolute left-0 top-full mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-xl z-50",children:e.jsxs("div",{className:"p-2",children:[e.jsx("div",{className:"text-xs font-semibold text-gray-400 uppercase tracking-wide px-3 py-2 mb-1",children:"Additional Settings"}),i.map(t=>e.jsxs("button",{onClick:()=>{a(t.id),s(!1)},className:"w-full flex items-center gap-3 px-3 py-2 rounded-md text-left transition-colors "+(n===t.id?"bg-purple-600 text-white":"text-gray-300 hover:bg-gray-800 hover:text-white"),children:[e.jsx(t.icon,{size:16,className:"text-purple-400"}),e.jsx("span",{className:"text-sm font-medium",children:t.label})]},t.id))]})}),r&&e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>s(!1)})]})},c1=()=>{const[t,n]=k.useState("campaigns"),[a,r]=k.useState(!1),[s]=k.useState(localStorage.getItem("userId")||""),[i,o]=k.useState({}),[l,u]=k.useState(!1),[d,c]=k.useState(null),[p,h]=k.useState(!1),[m,f]=k.useState([]),[g,x]=k.useState([]),[b,y]=k.useState([]),[w,v]=k.useState([]),[N,$]=k.useState([]),[D,M]=k.useState([]),[Z,te]=k.useState([]),[ne,ae]=k.useState([]),[re,ie]=k.useState([]),[oe,le]=k.useState([]),[ue,de]=k.useState([]),[ce,pe]=k.useState([]),[he,me]=k.useState([]),[fe,ge]=k.useState([]),[xe,be]=k.useState([]),[ye,we]=k.useState(""),[ve,ke]=k.useState(new Set),[Ne,Se]=k.useState({check_in_time:"10:00",check_out_time:"19:00",required_working_hours:8,late_check_in_threshold:"10:30",early_check_out_threshold:"18:30",geo_location_required:!0,photo_required:!0,working_days:[0,1,2,3,4,5],half_day_rules:{late_check_in:!0,early_check_out:!0,insufficient_hours:!0},attendance_editable_by_admin:!0,date_time_format:"DD MMMM YYYY, HH:mm"}),[Ie,_e]=k.useState("leads"),[Ce,Te]=k.useState(null),[Ee,Ae]=k.useState(!1),[$e,Re]=k.useState(!1),[Fe,De]=k.useState("add"),[Me,Oe]=k.useState("add"),[je,Le]=k.useState(null),[ze,Pe]=k.useState(null),[Be,We]=k.useState(!1),[Ve,Ue]=k.useState(""),[Ge,He]=k.useState(null),[qe,Ke]=k.useState({}),[Xe,Ye]=k.useState(!1),[Ze,Je]=k.useState(null),[Qe,et]=k.useState(new Set),[tt,nt]=k.useState(!1),[at,rt]=k.useState({}),[st,it]=k.useState("no_permission"),[ot,lt]=k.useState({Global:!1,Feeds:!1,Tasks:!1,Attendance:!1,Tickets:!1,Leads:!1,Leaves:!1,Admin:!1,Employees:!1}),[ut,dt]=k.useState(1),[ct,pt]=k.useState(50),[ht,mt]=k.useState(0),[ft,gt]=k.useState(!1),[xt,bt]=k.useState(""),[yt,wt]=k.useState([]),[vt,kt]=k.useState(null),[Nt,St]=k.useState(0),[It,_t]=k.useState(new Map),[Ct,Tt]=k.useState([]),[Et,At]=k.useState(""),[$t,Rt]=k.useState(!1),[Ft,Dt]=k.useState(""),Mt=o1,Ot=(e,t)=>at[e]&&Array.isArray(at[e])&&at[e].includes(t),jt=e=>at[e]&&Array.isArray(at[e])&&at[e].includes("*"),Lt=()=>{We(!1),"mistakeType"!==t&&"warningAction"!==t||n("warningData"),Ye(!1),Je(null),et(new Set),nt(!1),lt({Global:!1,Feeds:!1,Tasks:!1,Attendance:!1,Tickets:!1,Leads:!1,Leaves:!1,Admin:!1,Employees:!1}),Ke({}),He(null),setTimeout(()=>lt({Global:!1,Feeds:!1,Tasks:!1,Attendance:!1,Tickets:!1,Leads:!1,Leaves:!1,Admin:!1,Employees:!1}),50)},zt=[{id:"campaigns",label:"Campaign Names",icon:R,color:"blue"},{id:"dataCodes",label:"Data Codes",icon:V,color:"green"},{id:"bankNames",label:"Bank Names",icon:U,color:"purple"},{id:"channelNames",label:"Channel Names",icon:E,color:"amber"},{id:"companyData",label:"Company Data",icon:E,color:"orange"},{id:"attachmentTypes",label:"Attachment Types",icon:G,color:"pink"},{id:"excelUpload",label:"Company Data Excel",icon:H,color:"red"},{id:"departments",label:"Departments",icon:E,color:"cyan"},{id:"designations",label:"Designations",icon:O,color:"rose"},{id:"roles",label:"Roles & Permissions",icon:R,color:"indigo"},{id:"emailSettings",label:"Email Settings",icon:q,color:"emerald"},{id:"adminEmails",label:"Admin Emails",icon:F,color:"red"},{id:"statuses",label:"Status Management",icon:K,color:"teal"},{id:"attendance",label:"Attendance Settings",icon:X,color:"emerald"},{id:"importantQuestions",label:"Important Questions",icon:Y,color:"violet"},{id:"warningData",label:"Warning Data",icon:P,color:"orange"}],Pt=e=>Z.filter(t=>t.parent_id===e||"object"==typeof t.parent_id&&t.parent_id&&(t.parent_id._id===e||t.parent_id.id===e)),Bt=()=>ye?D.filter(e=>e.target_type===ye):D;k.useEffect(()=>{try{const e=j();o(e);const t=L(e),n=z(e,"settings","view")||z(e,"settings","show");u(t||n),h(!0)}catch(e){c("Error loading permissions: "+e.message),u(!0),h(!0)}},[]),k.useEffect(()=>{l&&Wt()},[l]),k.useEffect(()=>{switch(t){case"campaigns":Vt();break;case"dataCodes":Ut();break;case"bankNames":Gt();break;case"companyData":dt(1),qt(1,ct),Kt();break;case"attachmentTypes":Yt();break;case"departments":Zt();break;case"designations":Jt();break;case"roles":Qt();break;case"emailSettings":en();break;case"adminEmails":tn();break;case"statuses":const e=Date.now();e-(window.lastStatusesLoadedAt||0)>5e3&&(window.lastStatusesLoadedAt=e,sn());break;case"attendance":wn();break;case"importantQuestions":nn();break;case"warningData":an(),rn()}},[t]),k.useEffect(()=>{const e=e=>{"Escape"===e.key&&Be&&Lt()},t=e=>{Xe&&!e.target.closest(".relative")&&(Ye(!1),Je(null))};return Be&&(document.addEventListener("keydown",e),document.addEventListener("click",t),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",e),document.removeEventListener("click",t),document.body.style.overflow="unset"}},[Be,Xe]),k.useEffect(()=>{Be&&Ve&&"importantQuestions"===t&&setTimeout(()=>{const e=document.querySelector('textarea[placeholder="e.g., Has customer provided all required documents?"]');e&&(e.style.height="auto",e.style.height=e.scrollHeight+"px")},200)},[Be,Ve,t]),k.useEffect(()=>{},[Be,t,ot]);const Wt=async()=>{await Promise.all([Vt(),Ut(),Gt(),Ht(),qt(1,50),Kt(),Yt(),Zt(),Jt(),Qt(),en(),tn(),wn(),sn(),nn()])},Vt=async()=>{try{const e=await S.get(`${Mt}/settings/campaign-names?user_id=${s}`);f(e.data)}catch(e){}},Ut=async()=>{try{const e=await S.get(`${Mt}/settings/data-codes?user_id=${s}`);x(e.data)}catch(e){}},Gt=async()=>{try{const e=await S.get(`${Mt}/settings/bank-names?user_id=${s}`);y(e.data)}catch(e){}},Ht=async()=>{try{const e=await S.get(`${Mt}/settings/channel-names?user_id=${s}`);v(e.data)}catch(e){}},qt=async(e=ut,t=ct)=>{try{gt(!0);const n=(e-1)*t;let a=`${Mt}/settings/company-data?user_id=${s}&limit=${t}&offset=${n}`;Et&&(a+=`&bank_name=${encodeURIComponent(Et)}`);const r=await S.get(a);if(r.data&&Array.isArray(r.data)){if($(r.data),1===e||0===n){let e=`${Mt}/settings/company-data?user_id=${s}`;Et&&(e+=`&bank_name=${encodeURIComponent(Et)}`);const t=await S.get(e);mt(t.data?.length||0)}}else $([]),mt(0)}catch(n){$([]),mt(0)}finally{gt(!1)}},Kt=async()=>{try{const e=await S.get(`${Mt}/settings/banks?user_id=${s}`);Tt(e.data)}catch(e){}},Xt=async()=>{if(Ft&&window.confirm(`Are you sure you want to delete ALL companies for bank "${Ft}"? This action cannot be undone!`))try{const e=await S.delete(`${Mt}/settings/company-data/delete-by-bank/${encodeURIComponent(Ft)}?user_id=${s}`);e.data.success?(alert(`Successfully deleted ${e.data.deleted_count} companies for bank "${Ft}"`),dt(1),await qt(1,ct),await Kt(),Et===Ft&&At("")):alert(e.data.message)}catch(e){alert("Error deleting companies: "+(e.response?.data?.detail||e.message))}finally{Rt(!1),Dt("")}},Yt=async()=>{try{const e=await ee.getAllAttachmentTypes();if(e.success){const t=e.data.map(e=>{const t={...e};return t._id&&!t.id?t.id=t._id:t.id&&!t._id&&(t._id=t.id),t});M(t)}}catch(e){}},Zt=async()=>{try{const e=await S.get(`${Mt}/departments?user_id=${s}`),t=e.data.departments||e.data;te(t)}catch(e){}},Jt=async()=>{try{const e=await S.get(`${Mt}/designations?user_id=${s}`),t=(e.data.designations||e.data).map(e=>{const t={...e};return t._id&&!t.id?t.id=t._id:t.id&&!t._id&&(t._id=t.id),t});ae(t)}catch(e){}},Qt=async()=>{try{const e=await S.get(`${Mt}/roles?user_id=${s}`),t=(e.data.roles||e.data).map(e=>{const t={...e};return t._id&&!t.id?t.id=t._id:t.id&&!t._id&&(t._id=t.id),t});ie(t)}catch(e){}},en=async()=>{try{const e=(await S.get(`${Mt}/otp/email-settings?user_id=${s}`)).data||[];de(e)}catch(e){de([])}},tn=async()=>{try{const e=(await S.get(`${Mt}/otp/admin-emails?user_id=${s}`)).data||[];pe(e)}catch(e){pe([])}},nn=async()=>{try{const e=await S.get(`${Mt}/important-questions?user_id=${s}`),t=e.data?.questions||e.data||[];me(t)}catch(e){me([])}},an=async()=>{try{const e=await S.get(`${o1}/warnings/mistake-types/list?user_id=${localStorage.getItem("userId")}`),t=(e.data?.mistake_types||e.data||[]).map(e=>({...e,id:e.id||e._id}));ge(t)}catch(e){ge([])}},rn=async()=>{try{const e=await S.get(`${o1}/warnings/warning-actions/list?user_id=${localStorage.getItem("userId")}`),t=(e.data?.warning_actions||e.data||[]).map(e=>({...e,id:e.id||e._id}));be(t)}catch(e){be([])}},sn=async()=>{try{const e=(await S.get(`${o1}/leads/admin/statuses?user_id=${localStorage.getItem("user_id")}`)).data;Array.isArray(e)?le(e):e&&Array.isArray(e.statuses)?le(e.statuses):e&&Array.isArray(e.data)?le(e.data):le([])}catch(e){le([])}},on=async e=>{try{if(201===(await S.post(`${o1}/leads/admin/statuses?user_id=${s}`,e)).status)return await sn(),!0}catch(t){alert("Failed to create status")}return!1},ln=async(e,t)=>{try{const n=localStorage.getItem("userId");if(!n)return alert("Authentication error: Please log in again"),!1;const a=await S.put(`/leads/admin/statuses/${e}?user_id=${n}`,t);if(200===a.status||201===a.status)return await sn(),!0}catch(n){n.response,alert(`Failed to update status: ${n.response?.data?.detail||n.message}`)}return!1},un=async e=>{try{if(200===(await S.delete(`/leads/admin/statuses/${e}?user_id=${localStorage.getItem("user_id")}`)).status)return await sn(),!0}catch(t){alert("Failed to delete status")}return!1},dn=async(e,t,n)=>{try{const t=oe.find(t=>(t._id||t.id)===e);if(!t)return!1;const a=[...t.sub_statuses||[]];return a.splice(n,1),await ln(e,{sub_statuses:a})}catch(a){alert("Failed to delete sub-status")}return!1},cn=async e=>{try{if(201===(await S.post(`/leads/admin/sub-statuses?user_id=${s}`,e)).status)return await sn(),!0}catch(t){alert("Failed to create sub-status")}return!1},pn=async(e,t)=>{try{if(200===(await S.put(`/leads/admin/sub-statuses/${e}?user_id=${s}`,t)).status)return await sn(),!0}catch(n){alert("Failed to update sub-status")}return!1},hn=async e=>{try{if(200===(await S.delete(`/leads/admin/sub-statuses/${e}?user_id=${s}`)).status)return await sn(),!0}catch(t){alert("Failed to delete sub-status")}return!1},mn=e=>{Ue("add"),He(null),"mistakeType"!==e&&"warningAction"!==e||n(e),Ke("attachmentTypes"===e?{name:"",target_type:"employees",sort_number:"",description:"",is_active:!0}:"roles"===e?{name:"",department_id:null,reporting_ids:[]}:"emailSettings"===e?{email:"",password:"",smtp_server:"smtp.gmail.com",smtp_port:587,use_ssl:!0,is_active:!0,purpose:"otp"}:"importantQuestions"===e?{question:"",type:"checkbox",mandatory:!0,is_active:!0}:"mistakeType"===e||"warningAction"===e?{value:"",label:"",is_active:!0}:{}),"roles"===e&&(rt({}),it("no_permission"),lt({Global:!1,Feeds:!1,Tasks:!1,Attendance:!1,Tickets:!1,Leads:!1,Leaves:!1,Admin:!1,Employees:!1}),setTimeout(()=>lt({Global:!1,Feeds:!1,Tasks:!1,Attendance:!1,Tickets:!1,Leads:!1,Leaves:!1,Admin:!1,Employees:!1}),0)),We(!0)},fn=(e,t)=>{const a={...e};if(a._id&&!a.id?a.id=a._id:a.id&&!a._id&&(a._id=a.id),"roles"===t&&(!a.reporting_ids&&a.reporting_id?a.reporting_ids=[a.reporting_id]:a.reporting_ids||(a.reporting_ids=[]),a.reporting_ids=(a.reporting_ids||[]).filter(e=>e)),Ue("edit"),He(a),Ke(a),"importantQuestions"===t&&setTimeout(()=>{const e=document.querySelector('textarea[placeholder="e.g., Has customer provided all required documents?"]');e&&(e.style.height="auto",e.style.height=e.scrollHeight+"px")},100),"mistakeType"!==t&&"warningAction"!==t||(n(t),Ke({value:a.value||"",label:a.label||a.value||"",is_active:!1!==a.is_active})),"roles"===t&&a.permissions){const e={},t=Array.isArray(a.permissions)&&a.permissions.length>0;it(t?"select":"no_permission"),t&&a.permissions.forEach(t=>{t.page&&t.actions&&(e[t.page]=t.actions)}),rt(e),lt({Global:!1,Feeds:!1,Tasks:!1,Attendance:!1,Tickets:!1,Leads:!1,Leaves:!1,Admin:!1,Employees:!1}),setTimeout(()=>lt({Global:!1,Feeds:!1,Tasks:!1,Attendance:!1,Tickets:!1,Leads:!1,Leaves:!1,Admin:!1,Employees:!1}),0)}We(!0)},gn=async(e,t)=>{if(e){if(window.confirm("Are you sure you want to delete this item?")&&!ve.has(e)){ke(t=>new Set(t).add(e));try{if("attachmentTypes"===t)return await ee.deleteAttachmentType(e),Yt(),void alert("Attachment type deleted successfully!");if("emailSettings"===t)return await S.delete(`${Mt}/otp/email-settings/${e}?user_id=${s}`),en(),void alert("Email setting deleted successfully!");if("adminEmails"===t)return await S.delete(`${Mt}/otp/admin-emails/${e}?user_id=${s}`),tn(),void alert("Admin email deleted successfully!");if("importantQuestions"===t)return await S.delete(`${Mt}/important-questions/${e}?user_id=${s}`),nn(),void alert("Important question deleted successfully!");let n;switch(t){case"campaigns":n=`/settings/campaign-names/${e}`;break;case"dataCodes":n=`/settings/data-codes/${e}`;break;case"bankNames":n=`/settings/bank-names/${e}`;break;case"channelNames":n=`/settings/channel-names/${e}`;break;case"companyData":n=`/settings/company-data/${e}`;break;case"departments":n=`/departments/${e}`;break;case"designations":n=`/designations/${e}`;break;case"roles":n=`/roles/${e}`;break;case"mistakeType":n=`/warnings/mistake-types/${e}`;break;case"warningAction":n=`/warnings/warning-actions/${e}`}switch(await S.delete(`${Mt}${n}?user_id=${s}`),t){case"campaigns":Vt();break;case"dataCodes":Ut();break;case"bankNames":Gt();break;case"channelNames":Ht();break;case"companyData":dt(1),qt(1,ct),Kt();break;case"departments":Zt();break;case"designations":Jt();break;case"roles":Qt();break;case"emailSettings":en();break;case"importantQuestions":nn();break;case"mistakeType":await an();break;case"warningAction":await rn()}alert("Item deleted successfully!")}catch(n){alert("Error deleting item: "+(n.response?.data?.detail||n.message))}finally{ke(t=>{const n=new Set(t);return n.delete(e),n})}}}else alert("Cannot delete this item - no ID found")},xn=async()=>{if(!vt)return void alert("Please select a file first");const e=(vt.size/1048576).toFixed(2),t=vt.name.toLowerCase().substring(vt.name.lastIndexOf("."));if([".xlsx",".xls"].includes(t))try{r(!0),St(0);const t=Date.now(),n=new FormData;n.append("file",vt);const a=await S.post(`${Mt}/settings/upload-excel?user_id=${s}`,n,{headers:{"Content-Type":"multipart/form-data"},timeout:3e4,onUploadProgress:e=>{const t=Math.round(100*e.loaded/e.total);St(t)}}),i=((Date.now()-t)/1e3).toFixed(1);alert(` Upload Complete in ${i}s!\n\nFile: ${vt.name} (${e} MB)\nStatus: Processing in background\nUpload ID: ${a.data.upload_id}\n\nYou can continue working while processing happens in the background!`),kt(null),St(0),a.data.upload_id&&bn(a.data.upload_id,vt.name)}catch(n){let e="Error uploading file: ";"ECONNABORTED"===n.code?e+="Upload timeout. Please try with a smaller file.":413===n.response?.status?e+="File too large. Maximum size is 500 MB.":422===n.response?.status?e+="Invalid file format. Please ensure you have the required columns: COMPANY NAME, CATEGORIES, BANK.":e+=n.response?.data?.detail||n.message||"Unknown error occurred.",alert(e)}finally{r(!1)}else alert("Please select a valid Excel file (.xlsx or .xls)")},bn=(e,t)=>{_t(n=>new Map(n.set(e,{filename:t,status:"processing",progress:0,startTime:Date.now()})));const n=setInterval(async()=>{try{const a=(await S.get(`${Mt}/settings/upload-status/${e}?user_id=${s}`,{timeout:5e3})).data;if(_t(t=>{const n=new Map(t);return n.has(e)&&n.set(e,{...n.get(e),status:a.status,progress:a.progress_percent||0,message:a.message}),n}),"completed"===a.status){clearInterval(n);const r=a.result?.stats||{},s=a.end_time&&a.start_time?((new Date(a.end_time)-new Date(a.start_time))/1e3).toFixed(1):"N/A";alert(` Processing Complete!\n\nFile: ${t}\nProcessing Time: ${s}s\n\nResults:\n Valid Records: ${r.valid_records_processed||0}\n New Companies: ${r.created||0}\n Updated Companies: ${r.updated||0}\n Errors Skipped: ${r.errors_skipped||0}\n Success Rate: ${r.success_rate_percent||0}%`),_t(t=>{const n=new Map(t);return n.delete(e),n}),dt(1),qt(1,ct),Kt()}else"failed"===a.status&&(clearInterval(n),alert(` Processing Failed!\n\nFile: ${t}\nError: ${a.error||a.message}\n\nPlease try again or contact support.`),_t(t=>{const n=new Map(t);return n.delete(e),n}))}catch(a){}},2e3);setTimeout(()=>{clearInterval(n),_t(t=>{const n=new Map(t);return n.delete(e),n})},6e5)},yn=async()=>{if(xt.trim())try{r(!0);const e=await S.post(`${Mt}/settings/search-companies?user_id=${s}`,{company_name:xt,similarity_threshold:.8});wt(e.data)}catch(e){alert("Error searching companies: "+(e.response?.data?.detail||e.message))}finally{r(!1)}else alert("Please enter a company name to search")},wn=async()=>{try{const e=await S.get(`${Mt}/settings/attendance-settings?user_id=${s}`);e.data&&e.data.data&&Se(e.data.data)}catch(e){}},vn=(t,n,a)=>e.jsxs("div",{className:"bg-black rounded-xl shadow-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-black flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:zt.find(e=>e.id===n)?.label||n}),(L(i)||z(i,"settings","create"))&&e.jsxs("button",{onClick:()=>mn(n),className:"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-blue-600 hover:to-blue-700 transition-all",children:[e.jsx(I,{size:16}),"Add New"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-black",children:e.jsxs("tr",{children:[a.map(t=>e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:t.replace("_"," ")},t)),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-black",children:t.map((t,r)=>e.jsxs("tr",{className:"hover:bg-black",children:[a.map(n=>e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-white",children:"is_active"===n?e.jsx("span",{className:"px-2 py-1 rounded-full text-xs font-medium "+(t[n]?"bg-green-100 text-white":"bg-black text-white"),children:t[n]?"Active":"Inactive"}):t[n]||"-"},n)),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex gap-2",children:[(L(i)||z(i,"settings","edit"))&&e.jsx("button",{onClick:()=>fn(t,n),className:"text-white hover:text-white",title:"Edit",children:e.jsx(_,{size:16})}),(L(i)||z(i,"settings","delete"))&&e.jsx("button",{onClick:()=>gn(t._id||t.id,n),className:"text-white hover:text-white",title:"Delete",children:e.jsx(C,{size:16})})]})})]},t._id||t.id||r))})]})})]});return d?e.jsx("div",{className:"min-h-screen bg-black text-white flex items-center justify-center",children:e.jsxs("div",{className:"max-w-md w-full bg-black rounded-lg shadow-lg p-8 text-center",children:[e.jsx(P,{className:"h-16 w-16 text-white mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Error"}),e.jsx("p",{className:"text-white mb-4",children:d}),e.jsx("button",{onClick:()=>window.location.reload(),className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600",children:"Reload Page"})]})}):p?l?e.jsxs("div",{className:"min-h-screen bg-black text-white",children:[e.jsx("div",{className:"bg-black shadow-sm border-b border-black",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"flex items-center justify-between h-16",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(W,{className:"h-8 w-8 text-white mr-3"}),e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Settings Management"})]})})})}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 mb-6",children:[e.jsx(l1,{tabs:zt,activeTab:t,setActiveTab:n}),e.jsx(u1,{tabs:zt,activeTab:t,setActiveTab:n}),e.jsx(d1,{tabs:zt,activeTab:t,setActiveTab:n})]}),e.jsx("div",{className:"space-y-6",children:(()=>{switch(t){case"campaigns":return vn(m,"campaigns",["name","description","is_active"]);case"dataCodes":return vn(g,"dataCodes",["name","description","is_active"]);case"bankNames":return vn(b,"bankNames",["name","is_active"]);case"channelNames":return vn(w,"channelNames",["name","description","is_active"]);case"companyData":return(()=>{const t=Math.ceil(ht/ct),n=(ut-1)*ct+1,r=Math.min(ut*ct,ht),s=e=>{e>=1&&e<=t&&(dt(e),qt(e,ct))};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-bold text-white mb-4 flex items-center gap-2",children:[e.jsx(E,{className:"text-orange-400",size:24}),"Bank Filter & Management"]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-4",children:[e.jsxs("select",{value:Et,onChange:e=>(async e=>{At(e),dt(1),await qt(1,ct)})(e.target.value),className:"bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-w-[200px]",children:[e.jsxs("option",{value:"",children:["All Banks (",ht," companies)"]}),Ct.map(t=>e.jsx("option",{value:t,children:t},t))]}),Et&&e.jsxs("button",{onClick:()=>{Dt(Et),Rt(!0)},className:"bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-red-600 hover:to-red-700 transition-all shadow-lg",children:[e.jsx(C,{size:16}),'Delete All for "',Et,'"']}),e.jsxs("button",{onClick:()=>{At(""),dt(1),qt(1,ct)},className:"bg-gradient-to-r from-gray-600 to-gray-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-gray-700 hover:to-gray-800 transition-all shadow-lg",children:[e.jsx(T,{size:16}),"Clear Filter"]})]}),Et&&e.jsxs("div",{className:"text-sm text-gray-300 bg-gray-700 p-3 rounded-lg border-l-4 border-orange-400",children:["Showing companies for bank: ",e.jsx("strong",{className:"text-orange-400",children:Et})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-700",children:[e.jsxs("h3",{className:"text-xl font-bold text-white mb-4 flex items-center gap-2",children:[e.jsx(Q,{className:"text-green-400",size:24}),"Search Similar Companies"]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("input",{type:"text",value:xt,onChange:e=>bt(e.target.value),placeholder:"Enter company name to search...",className:"flex-1 bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500 placeholder-gray-400"}),e.jsxs("button",{onClick:yn,disabled:a,className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 hover:from-green-600 hover:to-green-700 transition-all disabled:opacity-50 shadow-lg",children:[e.jsx(Q,{size:16}),"Search"]})]}),yt.length>0&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-semibold text-white mb-2",children:"Search Results:"}),e.jsx("div",{className:"space-y-2",children:yt.map((t,n)=>e.jsx("div",{className:"bg-gray-700 p-3 rounded-lg border border-gray-600",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-white",children:t.company_name}),e.jsxs("p",{className:"text-sm text-gray-300",children:["Categories: ",t.categories.join(", ")]}),e.jsxs("p",{className:"text-sm text-gray-300",children:["Banks: ",t.bank_names.join(", ")]})]}),e.jsxs("span",{className:"bg-blue-600 text-white px-2 py-1 rounded text-sm font-medium",children:[t.similarity_percentage,"% match"]})]})},n))})]})]}),e.jsxs("div",{className:"bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700",children:[e.jsxs("div",{className:"p-6 border-b border-gray-700 flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx(E,{className:"text-orange-400",size:24}),"Company Data",Et&&` - ${Et}`]}),e.jsxs("p",{className:"text-sm text-gray-300 mt-1",children:["Showing ",n,"-",r," of ",ht," companies"]})]}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("label",{className:"text-sm text-gray-300",children:["Show:",e.jsxs("select",{value:ct,onChange:e=>{return t=parseInt(e.target.value),pt(t),dt(1),void qt(1,t);var t},className:"ml-2 bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:25,children:"25"}),e.jsx("option",{value:50,children:"50"}),e.jsx("option",{value:100,children:"100"}),e.jsx("option",{value:200,children:"200"})]}),"per page"]})})]}),ft&&e.jsx("div",{className:"p-6 text-center",children:e.jsxs("div",{className:"inline-flex items-center gap-2 text-gray-300",children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"}),"Loading companies..."]})}),!ft&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-900",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider",children:"Company Name"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider",children:"Categories"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider",children:"Bank Names"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-gray-800 divide-y divide-gray-700",children:0===N.length?e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"px-6 py-12 text-center text-gray-400",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx(E,{size:48,className:"text-gray-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-medium",children:Et?`No companies found for bank "${Et}"`:"No company data available"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:!Et&&"Upload an Excel file to get started."})]})]})})}):N.map((t,n)=>e.jsxs("tr",{className:"hover:bg-gray-700 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 text-sm font-medium text-white",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{size:16,className:"text-orange-400 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:t.company_name})]})}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-300",children:e.jsx("div",{className:"flex flex-wrap gap-1",children:(t.categories||[]).map((t,n)=>e.jsx("span",{className:"bg-blue-600 text-white px-2 py-1 rounded-full text-xs font-medium",children:t},n))})}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-300",children:e.jsx("div",{className:"flex flex-wrap gap-1",children:(t.bank_names||[]).map((t,n)=>e.jsx("span",{className:"bg-green-600 text-white px-2 py-1 rounded-full text-xs font-medium",children:t},n))})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsx("button",{onClick:()=>gn(t.id,"companyData"),className:"text-red-400 hover:text-red-300 transition-colors p-1 rounded hover:bg-red-900/20",title:"Delete this company",children:e.jsx(C,{size:16})})})]},t.id||n))})]})}),!ft&&t>1&&e.jsx("div",{className:"bg-gray-900 px-6 py-4 border-t border-gray-700",children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-center gap-4",children:[e.jsxs("div",{className:"text-sm text-gray-300",children:["Showing ",n," to ",r," of ",ht," results"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>s(1),disabled:1===ut,className:"px-3 py-1 text-sm bg-gray-700 text-gray-300 rounded hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"First page",children:""}),e.jsx("button",{onClick:()=>s(ut-1),disabled:1===ut,className:"px-3 py-1 text-sm bg-gray-700 text-gray-300 rounded hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Previous page",children:""}),Array.from({length:Math.min(5,t)},(n,a)=>{let r;return r=t<=5||ut<=3?a+1:ut>=t-2?t-4+a:ut-2+a,e.jsx("button",{onClick:()=>s(r),className:"px-3 py-1 text-sm rounded transition-colors "+(ut===r?"bg-blue-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"),children:r},r)}),e.jsx("button",{onClick:()=>s(ut+1),disabled:ut===t,className:"px-3 py-1 text-sm bg-gray-700 text-gray-300 rounded hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Next page",children:""}),e.jsx("button",{onClick:()=>s(t),disabled:ut===t,className:"px-3 py-1 text-sm bg-gray-700 text-gray-300 rounded hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Last page",children:""}),e.jsxs("div",{className:"flex items-center gap-2 ml-4",children:[e.jsx("span",{className:"text-sm text-gray-300",children:"Go to:"}),e.jsx("input",{type:"number",min:"1",max:t,value:ut,onChange:e=>{const n=parseInt(e.target.value);n>=1&&n<=t&&s(n)},className:"w-16 px-2 py-1 text-sm bg-gray-700 text-white border border-gray-600 rounded focus:ring-2 focus:ring-blue-500"})]})]})]})})]}),$t&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full border border-gray-700",children:[e.jsxs("h3",{className:"text-lg font-bold text-red-400 mb-4 flex items-center gap-2",children:[e.jsx(P,{size:24})," Confirm Bulk Delete"]}),e.jsxs("p",{className:"text-gray-300 mb-6",children:["Are you sure you want to delete ",e.jsx("strong",{children:"ALL"})," companies for bank ",e.jsxs("strong",{className:"text-orange-400",children:['"',Ft,'"']}),"?",e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{className:"text-red-400",children:"This action will permanently remove all company records associated with this bank and cannot be undone."})]}),e.jsxs("div",{className:"flex gap-4 justify-end",children:[e.jsx("button",{onClick:()=>{Rt(!1),Dt("")},className:"px-4 py-2 bg-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:Xt,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:"Delete All"})]})]})})]})})();case"attachmentTypes":return e.jsxs("div",{className:"bg-black rounded-xl shadow-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-black flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Attachment Types"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm text-white",children:"Filter by:"}),e.jsxs("select",{value:ye,onChange:e=>we(e.target.value),className:"px-3 py-1 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:"All Target Types"}),e.jsx("option",{value:"employees",children:"Employees"}),e.jsx("option",{value:"leads",children:"Leads"})]})]})]}),(L(i)||z(i,"settings","create"))&&e.jsxs("button",{onClick:()=>mn("attachmentTypes"),className:"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-blue-600 hover:to-blue-700 transition-all",children:[e.jsx(I,{size:16}),"Add New Attachment Type"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-black",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Name"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Target Type"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Sort Order"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Description"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Created"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:0===Bt().length?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"px-6 py-8 text-center text-gray-500",children:ye?`No attachment types found for ${"employees"===ye?"Employees":"Leads"}.`:'No attachment types found. Click "Add New Attachment Type" to create one.'})}):Bt().map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap font-medium text-gray-900",children:t.name}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium "+("employees"===t.target_type?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"),children:"employees"===t.target_type?"Employees":"Leads"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:e.jsx("span",{className:"inline-flex items-center justify-center w-8 h-8 bg-gray-100 text-gray-800 rounded-full text-sm font-medium",children:t.sort_number||"-"})}),e.jsx("td",{className:"px-6 py-4 text-gray-700 max-w-xs truncate",children:t.description||"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium "+(t.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:t.is_active?"Active":"Inactive"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.created_at?new Date(t.created_at).toLocaleDateString():"-"}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2",children:[(L(i)||z(i,"settings","edit"))&&e.jsxs("button",{onClick:()=>{He(t),Ke({name:t.name,target_type:t.target_type,sort_number:t.sort_number,description:t.description,is_active:t.is_active}),Ue("edit"),We(!0)},className:"text-blue-600 hover:text-blue-900 inline-flex items-center gap-1",children:[e.jsx(_,{size:14}),"Edit"]}),(L(i)||z(i,"settings","delete"))&&e.jsxs("button",{onClick:()=>gn(t._id||t.id,"attachmentTypes"),disabled:ve.has(t._id||t.id),className:"inline-flex items-center gap-1 "+(ve.has(t._id||t.id)?"text-gray-400 cursor-not-allowed":"text-red-600 hover:text-red-900"),children:[e.jsx(C,{size:14}),ve.has(t._id||t.id)?"Deleting...":"Delete"]})]})]},t._id||t.id))})]})})]});case"excelUpload":return L(i)||z(i,"settings","create")?e.jsxs("div",{className:"bg-black rounded-xl shadow-lg p-6",children:[It.size>0&&e.jsxs("div",{className:"mb-6 bg-blue-900/20 border border-blue-500/30 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-blue-400 font-medium mb-3",children:[" Active Processing (",It.size,")"]}),Array.from(It.entries()).map(([t,n])=>e.jsxs("div",{className:"mb-3 last:mb-0",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"text-sm text-blue-200",children:n.filename}),e.jsxs("span",{className:"text-xs text-blue-300",children:[n.progress,"%"]})]}),e.jsx("div",{className:"bg-blue-800 rounded-full h-2",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-400 to-green-400 h-2 rounded-full transition-all duration-500",style:{width:`${n.progress}%`}})}),e.jsx("p",{className:"text-xs text-blue-300 mt-1",children:n.message||n.status})]},t))]}),e.jsxs("div",{className:"border-2 border-dashed border-gray-600 rounded-lg p-8 text-center",children:[e.jsx(J,{size:48,className:"mx-auto text-gray-400 mb-4"}),e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:e=>{const t=e.target.files[0];kt(t),t&&(t.size/1048576).toFixed(2)},className:"hidden",id:"file-upload"}),e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-lg inline-flex items-center gap-2 hover:from-blue-600 hover:to-blue-700 transition-all",children:[e.jsx(H,{size:20}),"Choose Excel File (.xlsx, .xls)"]}),vt&&e.jsxs("div",{className:"mt-6 bg-gray-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"text-left",children:[e.jsxs("p",{className:"text-white font-medium",children:[" ",vt.name]}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Size: ",(vt.size/1048576).toFixed(2)," MB",vt.size>104857600?e.jsx("span",{className:"text-yellow-400 ml-2",children:" Will process in background"}):e.jsx("span",{className:"text-green-400 ml-2",children:" Ready for instant upload"})]})]}),e.jsx("button",{onClick:()=>kt(null),className:"text-red-400 hover:text-red-300",title:"Remove file",children:""})]}),Nt>0&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-300 mb-1",children:[e.jsx("span",{children:"Upload Progress"}),e.jsxs("span",{children:[Nt,"%"]})]}),e.jsx("div",{className:"bg-gray-700 rounded-full h-3",children:e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-300",style:{width:`${Nt}%`}})})]}),e.jsx("button",{onClick:xn,disabled:a,className:"w-full py-3 px-6 rounded-lg font-medium transition-all "+(a?"bg-gray-600 text-gray-400 cursor-not-allowed":"bg-gradient-to-r from-green-500 to-green-600 text-white hover:from-green-600 hover:to-green-700"),children:a?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-gray-400 border-t-transparent"}),"Uploading..."]}):e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(J,{size:16})," INSTANT Upload & Background Processing"]})})]})]})]}):e.jsxs("div",{className:"bg-black rounded-xl shadow-lg p-6",children:[e.jsx("h3",{className:"text-xl font-bold text-white mb-4",children:"Upload Excel File"}),e.jsxs("div",{className:"bg-black border border-black rounded-lg p-4 text-center",children:[e.jsx(B,{className:"h-8 w-8 text-white mx-auto mb-2"}),e.jsx("p",{className:"text-white",children:"You don't have permission to upload Excel files."}),e.jsx("p",{className:"text-sm text-white mt-1",children:"Required permission: settings.create"}),e.jsxs("div",{className:"mt-2 text-xs text-white",children:[e.jsx("p",{children:"Debug info:"}),e.jsxs("p",{children:["Super Admin: ",L(i)?"Yes":"No"]}),e.jsxs("p",{children:["Settings Create: ",z(i,"settings","create")?"Yes":"No"]})]})]})]});case"departments":try{return e.jsx(r1,{})}catch(n){return e.jsx("div",{className:"p-4 text-red-500",children:"Error loading departments. Please refresh the page."})}case"designations":try{return e.jsx(i1,{})}catch(n){return e.jsx("div",{className:"p-4 text-red-500",children:"Error loading designations. Please refresh the page."})}case"roles":try{return e.jsx(s1,{})}catch(n){return e.jsx("div",{className:"p-4 text-red-500",children:"Error loading roles. Please refresh the page."})}case"emailSettings":return e.jsxs("div",{className:"bg-black rounded-xl shadow-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-700 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Email Settings for OTP"}),e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:"Configure email accounts that will be used to send OTP codes to users"})]}),(L(i)||z(i,"settings","create"))&&e.jsxs("button",{onClick:()=>mn("emailSettings"),className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-green-600 hover:to-green-700 transition-all",children:[e.jsx(I,{size:16}),"Add Email Account"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Email"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"SMTP Server"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Port"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"SSL"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Purpose"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Created"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-gray-900 divide-y divide-gray-700",children:0===ue.length?e.jsx("tr",{children:e.jsx("td",{colSpan:"8",className:"px-6 py-8 text-center text-gray-400",children:'No email settings configured. Click "Add Email Account" to configure an email for sending OTP codes.'})}):ue.map(t=>e.jsxs("tr",{className:"hover:bg-gray-800 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap font-medium text-white",children:t.email}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-gray-300",children:t.smtp_server}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-gray-300",children:t.smtp_port}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium "+(t.use_ssl?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:t.use_ssl?"SSL":"No SSL"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:t.purpose||"OTP"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium "+(t.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:t.is_active?"Active":"Inactive"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-400",children:t.created_at?new Date(t.created_at).toLocaleDateString():"-"}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2",children:[(L(i)||z(i,"settings","edit"))&&e.jsxs("button",{onClick:()=>fn(t,"emailSettings"),className:"text-blue-400 hover:text-blue-300 inline-flex items-center gap-1",children:[e.jsx(_,{size:14}),"Edit"]}),(L(i)||z(i,"settings","delete"))&&e.jsxs("button",{onClick:()=>gn(t._id||t.id,"emailSettings"),className:"text-red-400 hover:text-red-300 inline-flex items-center gap-1",children:[e.jsx(C,{size:14}),"Delete"]})]})]},t._id||t.id))})]})}),ue.length>0&&e.jsx("div",{className:"bg-gray-800 px-6 py-3 border-t border-gray-700",children:e.jsxs("p",{className:"text-sm text-gray-400",children:[e.jsx("strong",{children:"Note:"})," Only one email setting can be active at a time for OTP delivery. The active setting will be used to send OTP codes to users."]})})]});case"adminEmails":return e.jsxs("div",{className:"bg-black rounded-xl shadow-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-700 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Admin Emails for OTP Reception"}),e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:"Configure admin email addresses that will receive OTP codes when employees request login. Employees will need to contact admin to get their OTP codes."})]}),(L(i)||z(i,"settings","create"))&&e.jsxs("button",{onClick:()=>mn("adminEmails"),className:"bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-red-600 hover:to-red-700 transition-all",children:[e.jsx(I,{size:16}),"Add Admin Email"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Email"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-gray-900 divide-y divide-gray-700",children:0===ce.length?e.jsx("tr",{children:e.jsx("td",{colSpan:"2",className:"px-6 py-8 text-center text-gray-400",children:'No admin emails configured. Click "Add Admin Email" to configure admin emails for OTP reception.'})}):ce.map(t=>e.jsxs("tr",{className:"hover:bg-gray-800 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-gray-300",children:t.email}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2",children:[(L(i)||z(i,"settings","edit"))&&e.jsxs("button",{onClick:()=>fn(t,"adminEmails"),className:"text-blue-400 hover:text-blue-300 inline-flex items-center gap-1",children:[e.jsx(_,{size:14}),"Edit"]}),(L(i)||z(i,"settings","delete"))&&e.jsxs("button",{onClick:()=>gn(t._id||t.id,"adminEmails"),className:"text-red-400 hover:text-red-300 inline-flex items-center gap-1",children:[e.jsx(C,{size:14}),"Delete"]})]})]},t._id||t.id))})]})}),ce.length>0&&e.jsx("div",{className:"bg-gray-800 px-6 py-3 border-t border-gray-700",children:e.jsxs("p",{className:"text-sm text-gray-400",children:[e.jsx("strong",{children:" Security Note:"}),' OTP codes will be sent to all active admin emails with "Receive OTP" enabled. Employees will need to contact these admins to get their OTP codes for login.']})})]});case"statuses":{const e=Date.now();e-(window.lastStatusesLoadedAt||0)>5e3&&(window.lastStatusesLoadedAt=e,sn())}return e.jsx(se,{statuses:oe,selectedDepartment:Ie,setSelectedDepartment:_e,showStatusModal:Ee,setShowStatusModal:Ae,showSubStatusModal:$e,setShowSubStatusModal:Re,statusModalType:Fe,setStatusModalType:De,subStatusModalType:Me,setSubStatusModalType:Oe,editingStatus:je,setEditingStatus:Le,editingSubStatus:ze,setEditingSubStatus:Pe,selectedStatus:Ce,setSelectedStatus:Te,createStatus:on,updateStatus:ln,deleteStatus:un,deleteSubStatusFromArray:dn,createSubStatus:cn,updateSubStatus:pn,deleteSubStatus:hn});case"attendance":return e.jsx(J0,{userId:s});case"importantQuestions":return e.jsxs("div",{className:"bg-black rounded-xl shadow-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-700 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Important Questions Management"}),e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:"Configure important questions that will be displayed during lead processing and validation"})]}),(L(i)||z(i,"settings","create"))&&e.jsxs("button",{onClick:()=>mn("importantQuestions"),className:"bg-gradient-to-r from-violet-500 to-violet-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-violet-600 hover:to-violet-700 transition-all",children:[e.jsx(I,{size:16}),"Add Question"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Question"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Type"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Mandatory"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Display Order"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Created"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-gray-900 divide-y divide-gray-700",children:0===he.length?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"px-6 py-8 text-center text-gray-400",children:'No important questions configured. Click "Add Question" to create important questions for lead processing.'})}):he.map(t=>e.jsxs("tr",{className:"hover:bg-gray-800 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 text-white",children:e.jsx("div",{className:"max-w-md whitespace-pre-wrap",children:e.jsx("p",{className:"font-medium",style:{whiteSpace:"pre-wrap"},children:t.question})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:t.type||"checkbox"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium "+(t.mandatory?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"),children:t.mandatory?"Required":"Optional"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium "+(t.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:t.is_active?"Active":"Inactive"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-300",children:t.display_order||"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-400",children:t.created_at?new Date(t.created_at).toLocaleDateString():"-"}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2",children:[(L(i)||z(i,"settings","edit"))&&e.jsxs("button",{onClick:()=>fn(t,"importantQuestions"),className:"text-blue-400 hover:text-blue-300 inline-flex items-center gap-1",children:[e.jsx(_,{size:14}),"Edit"]}),(L(i)||z(i,"settings","delete"))&&e.jsxs("button",{onClick:()=>gn(t._id||t.id,"importantQuestions"),className:"text-red-400 hover:text-red-300 inline-flex items-center gap-1",children:[e.jsx(C,{size:14}),"Delete"]})]})]},t._id||t.id))})]})}),he.length>0&&e.jsx("div",{className:"bg-gray-800 px-6 py-3 border-t border-gray-700",children:e.jsxs("p",{className:"text-sm text-gray-400",children:[e.jsx("strong",{children:" Note:"})," Important questions are displayed during lead processing to ensure critical information is validated. Active questions will appear in the lead validation workflow. Questions are displayed in order of their display order."]})})]});case"warningData":return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-black rounded-xl shadow-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-700 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Mistake Types"}),e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:"Configure mistake types that will be available in the warning system dropdown"})]}),(L(i)||z(i,"settings","create"))&&e.jsxs("button",{onClick:()=>mn("mistakeType"),className:"bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-orange-600 hover:to-orange-700 transition-all",children:[e.jsx(I,{size:16}),"Add Mistake Type"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Value"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Display Label"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Created"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-gray-900 divide-y divide-gray-700",children:0===fe.length?e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-6 py-8 text-center text-gray-400",children:'No mistake types configured. Click "Add Mistake Type" to create options for the mistake type dropdown.'})}):fe.map(t=>e.jsxs("tr",{className:"hover:bg-gray-800 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 text-white",children:e.jsx("p",{className:"font-medium",children:t.value})}),e.jsx("td",{className:"px-6 py-4 text-gray-300",children:t.label||t.value}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium "+(!1!==t.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:!1!==t.is_active?"Active":"Inactive"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-400",children:t.created_at?new Date(t.created_at).toLocaleDateString():"-"}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2",children:[(L(i)||z(i,"settings","edit"))&&e.jsxs("button",{onClick:()=>fn(t,"mistakeType"),className:"text-blue-400 hover:text-blue-300 inline-flex items-center gap-1",title:"Edit this mistake type",children:[e.jsx(_,{size:14}),"Edit"]}),(L(i)||z(i,"settings","delete"))&&e.jsxs("button",{onClick:()=>{const e=t._id||t.id;e?gn(e,"mistakeType"):alert("Cannot delete default items. You can edit them to create a custom version.")},className:"text-red-400 hover:text-red-300 inline-flex items-center gap-1",title:t._id||t.id?"Delete this mistake type":"Cannot delete default items",children:[e.jsx(C,{size:14}),"Delete"]})]})]},t._id||t.id||t.value))})]})})]}),e.jsxs("div",{className:"bg-black rounded-xl shadow-lg overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-700 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"Warning Actions"}),e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:"Configure warning action types that will be available in the warning system dropdown"})]}),(L(i)||z(i,"settings","create"))&&e.jsxs("button",{onClick:()=>mn("warningAction"),className:"bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:from-red-600 hover:to-red-700 transition-all",children:[e.jsx(I,{size:16}),"Add Warning Action"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-800",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Value"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Display Label"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Created"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-gray-900 divide-y divide-gray-700",children:0===xe.length?e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-6 py-8 text-center text-gray-400",children:'No warning actions configured. Click "Add Warning Action" to create options for the warning action dropdown.'})}):xe.map(t=>e.jsxs("tr",{className:"hover:bg-gray-800 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 text-white",children:e.jsx("p",{className:"font-medium",children:t.value})}),e.jsx("td",{className:"px-6 py-4 text-gray-300",children:t.label||t.value}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium "+(!1!==t.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:!1!==t.is_active?"Active":"Inactive"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-400",children:t.created_at?new Date(t.created_at).toLocaleDateString():"-"}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2",children:[(L(i)||z(i,"settings","edit"))&&e.jsxs("button",{onClick:()=>fn(t,"warningAction"),className:"text-blue-400 hover:text-blue-300 inline-flex items-center gap-1",title:"Edit this warning action",children:[e.jsx(_,{size:14}),"Edit"]}),(L(i)||z(i,"settings","delete"))&&e.jsxs("button",{onClick:()=>{const e=t._id||t.id;e?gn(e,"warningAction"):alert("Cannot delete default items. You can edit them to create a custom version.")},className:"text-red-400 hover:text-red-300 inline-flex items-center gap-1",title:t._id||t.id?"Delete this warning action":"Cannot delete default items",children:[e.jsx(C,{size:14}),"Delete"]})]})]},t._id||t.id||t.value))})]})})]})]});default:return null}})()})]}),Be?"roles"===t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-start justify-center pt-4 pb-4",onClick:e=>{e.target===e.currentTarget&&Lt()},style:{height:"100vh",overflowY:"auto"},children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl mx-4 text-black shadow-2xl flex flex-col",style:{maxHeight:"calc(100vh - 2rem)",minHeight:"80vh"},onClick:e=>e.stopPropagation(),role:"dialog","aria-modal":"true","aria-labelledby":"modal-title",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b border-gray-200 bg-white sticky top-0 z-10 rounded-t-xl",children:[e.jsxs("h3",{id:"modal-title",className:"text-lg font-bold text-black",children:["add"===Ve?"Add":"Edit"," ",zt.find(e=>e.id===t)?.label]}),e.jsx("button",{onClick:Lt,className:"text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full p-1 transition-colors","aria-label":"Close modal",children:e.jsx(T,{size:20})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Role Name *"}),e.jsx("input",{type:"text",value:qe.name||"",onChange:e=>Ke({...qe,name:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Department"}),e.jsxs("select",{value:qe.department_id||"",onChange:e=>Ke({...qe,department_id:e.target.value||null}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",children:[e.jsx("option",{value:"",children:"Select Department"}),Array.isArray(Z)&&Z.map(t=>e.jsx("option",{value:t._id||t.id,children:t.name},t._id||t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Reporting Roles"}),e.jsxs("div",{className:"space-y-2",children:[(qe.reporting_ids||[]).map((t,n)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:t,onChange:e=>{const t=[...qe.reporting_ids||[]];t[n]=e.target.value,Ke({...qe,reporting_ids:t})},className:"flex-1 border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",children:[e.jsx("option",{value:"",children:"Select Reporting Role"}),re.filter(e=>{const n=e._id||e.id;return n!==(Ge?._id||Ge?.id)&&!(qe.reporting_ids||[]).includes(n)||n===t}).map(t=>{const n=t._id||t.id;return e.jsx("option",{value:n,children:t.name},n)})]}),e.jsx("button",{type:"button",onClick:()=>{const e=(qe.reporting_ids||[]).filter((e,t)=>t!==n);Ke({...qe,reporting_ids:e})},className:"px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",children:""})]},n)),e.jsxs("button",{type:"button",onClick:()=>{const e=[...qe.reporting_ids||[],""];Ke({...qe,reporting_ids:e})},className:"w-full border-2 border-dashed border-gray-400 rounded-lg px-3 py-2 text-black hover:border-blue-500 hover:text-blue-500 transition-colors flex items-center justify-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"+"}),e.jsx("span",{children:"Add Reporting Role"})]})]})]}),e.jsxs("div",{className:"space-y-3 mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-black",children:"Permissions"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("label",{className:"flex items-center text-black",children:[e.jsx("input",{type:"radio",name:"permissionType",value:"no_permission",checked:"no_permission"===st,onChange:e=>it(e.target.value),className:"mr-2"}),"No Permission"]}),e.jsxs("label",{className:"flex items-center text-black",children:[e.jsx("input",{type:"radio",name:"permissionType",value:"select",checked:"select"===st,onChange:e=>it(e.target.value),className:"mr-2"}),"Select Permissions"]})]}),"select"===st&&e.jsxs("div",{className:"border border-gray-300 rounded-lg p-4 bg-gray-50",children:[e.jsxs("div",{className:"text-xs text-gray-600 mb-4 flex items-center justify-between",children:[e.jsx("span",{children:"Select individual permissions (all sections are fully scrollable):"}),Object.values(ot).some(e=>e)&&e.jsx("button",{type:"button",onClick:()=>{const e=document.querySelector(".fixed.inset-0 .flex-1.overflow-y-auto");e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})},className:"text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition-colors",children:"Scroll to Bottom "})]}),e.jsx("div",{className:"space-y-3",style:{paddingBottom:"300px"},children:Object.entries({Global:["show","all"],Feeds:["show","own","junior","all"],Leads:["show","own","junior","all","assign"],Login:["show","own","junior","all"],Tasks:["show","own","junior","all"],Tickets:["show","own","junior","all"],"HRMS Employees":["show","own","junior","all"],Leaves:["show","own","junior","all"],Attendance:["show","own","junior","all"],Warnings:["show","own","junior","all"],Users:["show","own","junior","all"],Charts:["show","own","junior","all"],Apps:["show","own","junior","all"],Settings:["show","own","junior","all"],"Interview Panel":["show"],Reports:["show"]}).map(([t,n],a,r)=>{ot[t],jt(t);const s=a===r.length-1;return e.jsxs("div",{"data-section":t,className:"border border-gray-200 rounded-lg bg-white",style:{marginBottom:s?"200px":"12px"},children:[e.jsxs("div",{className:"flex items-center justify-between p-3 "+(ot[t]?"border-b border-gray-200":""),children:[e.jsxs("button",{type:"button",onClick:()=>{return e=t,void lt(t=>{const n={...t,[e]:!t[e]};return!t[e]&&e&&setTimeout(()=>{const t=document.querySelector(".fixed.inset-0 .flex-1.overflow-y-auto"),n=document.querySelector(`[data-section="${e}"]`);if(t&&n){const e=t.getBoundingClientRect(),a=n.getBoundingClientRect(),r=t.scrollTop+a.top-e.top-50;t.scrollTo({top:r,behavior:"smooth"}),setTimeout(()=>{t.scrollBy({top:200,behavior:"smooth"})},300)}},100),n});var e},className:"flex items-center gap-2 font-semibold text-black hover:text-blue-600 transition-colors",children:[e.jsx(A,{className:"w-4 h-4 transform transition-transform "+(ot[t]?"rotate-0":"-rotate-90")}),e.jsx("span",{children:t.charAt(0).toUpperCase()+t.slice(1)})]}),e.jsxs("label",{className:"flex items-center text-sm text-black",children:[e.jsx("input",{type:"checkbox",checked:jt(t),onChange:e=>((e,t)=>{rt(n=>{const a={...n};return t?a[e]=["*"]:delete a[e],a})})(t,e.target.checked),className:"mr-1"}),"All (",t," *)"]})]}),ot[t]&&e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-3",style:{paddingBottom:s?"150px":"12px"},children:[!jt(t)&&n.filter(e=>"*"!==e).map(n=>e.jsxs("label",{className:"flex items-center text-sm text-black mb-2",children:[e.jsx("input",{type:"checkbox",checked:Ot(t,n),onChange:e=>((e,t,n)=>{rt(a=>{const r={...a};return r[e]||(r[e]=[]),Array.isArray(r[e])||(r[e]=[]),n?r[e].includes(t)||(r[e]=[...r[e],t]):(r[e]=r[e].filter(e=>e!==t),0===r[e].length&&delete r[e]),r})})(t,n,e.target.checked),className:"mr-2"}),n]},n)),jt(t)&&e.jsx("div",{className:"text-gray-500 italic",children:"All permissions selected via wildcard (*)"})]})]},t)})})]})]})]})}),e.jsx("div",{className:"border-t border-gray-200 p-6 bg-white sticky bottom-0 rounded-b-xl",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:Lt,className:"px-4 py-2 text-black border border-black rounded-lg hover:bg-gray-100 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:handleSubmit,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"add"===Ve?"Add":"Update"})]})})]})}):e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-[9999] overflow-y-auto",onClick:e=>{e.target===e.currentTarget&&Lt()},children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-4xl mx-auto my-8 text-black shadow-2xl",style:{minHeight:"calc(100vh - 4rem)"},onClick:e=>e.stopPropagation(),role:"dialog","aria-modal":"true","aria-labelledby":"modal-title",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b border-gray-200 bg-white sticky top-0 z-10",children:[e.jsxs("h3",{id:"modal-title",className:"text-lg font-bold text-black",children:["add"===Ve?"Add":"Edit"," ",zt.find(e=>e.id===t)?.label]}),e.jsx("button",{onClick:Lt,className:"text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full p-1 transition-colors","aria-label":"Close modal",children:e.jsx(T,{size:20})})]}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"space-y-4",children:["campaigns"===t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Name *"}),e.jsx("input",{type:"text",value:qe.name||"",onChange:e=>Ke({...qe,name:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Description"}),e.jsx("textarea",{value:qe.description||"",onChange:e=>Ke({...qe,description:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",rows:"3"})]})]}),"dataCodes"===t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Name *"}),e.jsx("input",{type:"text",value:qe.name||"",onChange:e=>Ke({...qe,name:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Description"}),e.jsx("textarea",{value:qe.description||"",onChange:e=>Ke({...qe,description:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",rows:"3"})]})]}),"bankNames"===t&&e.jsx(e.Fragment,{children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Bank Name *"}),e.jsx("input",{type:"text",value:qe.name||"",onChange:e=>Ke({...qe,name:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black"})]})}),"channelNames"===t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Channel Name *"}),e.jsx("input",{type:"text",value:qe.name||"",onChange:e=>Ke({...qe,name:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Description"}),e.jsx("textarea",{value:qe.description||"",onChange:e=>Ke({...qe,description:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",rows:"3"})]})]}),"attachmentTypes"===t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Attachment Type Name *"}),e.jsx("input",{type:"text",value:qe.name||"",onChange:e=>Ke({...qe,name:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"e.g., Aadhar Card, PAN Card, Resume"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Target Type *"}),e.jsxs("select",{value:qe.target_type||"employees",onChange:e=>Ke({...qe,target_type:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",children:[e.jsx("option",{value:"employees",children:"Employees"}),e.jsx("option",{value:"leads",children:"Leads"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Sort Number *"}),e.jsx("input",{type:"number",min:"1",value:qe.sort_number||"",onChange:e=>Ke({...qe,sort_number:parseInt(e.target.value)||""}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"Enter sort order (1, 2, 3, etc.)"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"Sort order within the target type. Must be unique (e.g., 1, 2, 3, etc.)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Description"}),e.jsx("textarea",{value:qe.description||"",onChange:e=>Ke({...qe,description:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",rows:"3",placeholder:"Brief description of this attachment type"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"attachment-active",checked:!1!==qe.is_active,onChange:e=>Ke({...qe,is_active:e.target.checked}),className:"mr-2"}),e.jsx("label",{htmlFor:"attachment-active",className:"text-sm text-black",children:"Active"})]})]}),"departments"===t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Department Name *"}),e.jsx("input",{type:"text",value:qe.name||"",onChange:e=>Ke({...qe,name:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Description"}),e.jsx("textarea",{value:qe.description||"",onChange:e=>Ke({...qe,description:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",rows:"3"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Parent Department"}),e.jsxs("select",{value:qe.parent_id||"",onChange:e=>Ke({...qe,parent_id:e.target.value||null}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",children:[e.jsx("option",{value:"",children:"No Parent"}),Z.filter(e=>(e._id||e.id)!==(Ge?._id||Ge?.id)).map(t=>{const n=t._id||t.id;return e.jsx("option",{value:n,children:t.name},n)})]})]})]}),"designations"===t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Name of Designation *"}),e.jsx("input",{type:"text",value:qe.name||"",onChange:e=>Ke({...qe,name:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"e.g., Senior Manager, Team Lead, Developer"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Reports To"}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black cursor-pointer bg-white flex justify-between items-center",onClick:()=>Ye(!Xe),children:[e.jsx("span",{className:"flex-1",children:qe.department_id&&(kn=qe.department_id,Z.find(e=>(e._id||e.id)===kn))?.name||"Select Department"}),e.jsx(A,{size:16,className:"transform transition-transform "+(Xe?"rotate-180":"")})]}),Xe&&e.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-80 overflow-auto",children:[e.jsx("div",{className:"p-2 border-b border-gray-100",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Search departments...",className:"w-full pl-8 pr-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500",onClick:e=>e.stopPropagation()}),e.jsx("svg",{className:"absolute left-2.5 top-2.5 h-4 w-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]})}),e.jsxs("div",{className:"py-1",children:[e.jsxs("div",{className:"px-3 py-2 text-gray-500 hover:bg-yellow-50 cursor-pointer bg-yellow-100 border-b border-gray-100",onClick:e=>{e.preventDefault(),e.stopPropagation(),Ke({...qe,department_id:""}),Ye(!1),et(new Set)},children:["-- No Department --",e.jsx("div",{className:"text-xs text-gray-400",children:"No department assignment"})]}),Z.filter(e=>!e.parent_id).map(t=>{const n=t._id||t.id,a=(e=>Pt(e).length>0)(n),r=Qe.has(n),s=Pt(n);return e.jsxs("div",{className:"border-b border-gray-100 last:border-b-0",children:[e.jsxs("div",{className:"flex items-center hover:bg-gray-50",children:[e.jsx("div",{className:"w-8 flex justify-center",children:a?e.jsx("button",{type:"button",className:"w-6 h-6 flex items-center justify-center hover:bg-gray-200 rounded transition-colors",onClick:e=>{e.preventDefault(),e.stopPropagation();const t=new Set(Qe);r?t.delete(n):t.add(n),et(t)},title:r?"Collapse sub-departments":"Show sub-departments",children:e.jsx("svg",{className:"w-3 h-3 transform transition-transform text-gray-600 "+(r?"rotate-90":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})}):e.jsx("div",{className:"w-6 h-6 flex items-center justify-center",children:e.jsxs("svg",{className:"w-4 h-4 text-gray-400",fill:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{d:"M10 2v20l-5.5-5.5L10 2z"}),e.jsx("rect",{x:"12",y:"9",width:"10",height:"6",rx:"1"})]})})}),e.jsxs("div",{className:"flex-1 px-3 py-3 cursor-pointer hover:bg-blue-50 flex items-center transition-colors "+(qe.department_id===n?"bg-blue-100 text-blue-700":"text-black"),onClick:e=>{e.preventDefault(),e.stopPropagation(),Ke({...qe,department_id:n}),Ye(!1),et(new Set)},children:[e.jsx("span",{className:"flex-1 font-medium",children:t.name}),a&&e.jsxs("span",{className:"text-xs text-gray-500 ml-2",children:[s.length," sub-department",1!==s.length?"s":""]})]})]}),a&&r&&e.jsx("div",{className:"bg-gray-50",children:s.map(t=>{const n=t._id||t.id;return e.jsx("div",{className:"px-6 py-2 cursor-pointer hover:bg-blue-50 flex items-center border-l-4 border-blue-200 "+(qe.department_id===n?"bg-blue-100 text-blue-700 border-blue-500":"text-gray-700"),onClick:e=>{e.preventDefault(),e.stopPropagation(),Ke({...qe,department_id:n}),Ye(!1),et(new Set)},children:e.jsxs("span",{className:"flex-1 text-sm",children:[" ",t.name]})},n)})})]},n)})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Message"}),e.jsx("textarea",{value:qe.description||"",onChange:e=>Ke({...qe,description:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",rows:"3",placeholder:"Description or message about this designation"})]})]}),"emailSettings"===t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Email Address *"}),e.jsx("input",{type:"email",value:qe.email||"",onChange:e=>Ke({...qe,email:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"e.g., otp@yourcompany.com",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Email Password *"}),e.jsx("input",{type:"password",value:qe.password||"",onChange:e=>Ke({...qe,password:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"Enter email password",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"SMTP Server *"}),e.jsx("input",{type:"text",value:qe.smtp_server||"smtp.gmail.com",onChange:e=>Ke({...qe,smtp_server:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"e.g., smtp.gmail.com, smtp.outlook.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"SMTP Port *"}),e.jsx("input",{type:"number",value:qe.smtp_port||587,onChange:e=>Ke({...qe,smtp_port:parseInt(e.target.value)}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"e.g., 587, 465, 25"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Purpose"}),e.jsxs("select",{value:qe.purpose||"otp",onChange:e=>Ke({...qe,purpose:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",children:[e.jsx("option",{value:"otp",children:"OTP (One-Time Password)"}),e.jsx("option",{value:"general",children:"None"})]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"email-use-ssl",checked:!1!==qe.use_ssl,onChange:e=>Ke({...qe,use_ssl:e.target.checked}),className:"mr-2"}),e.jsx("label",{htmlFor:"email-use-ssl",className:"text-sm text-black",children:"Use SSL/TLS"})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold text-blue-800 mb-2",children:"Common SMTP Settings:"}),e.jsxs("div",{className:"text-sm text-blue-700 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Gmail:"})," smtp.gmail.com, Port 587 (SSL)"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Outlook:"})," smtp.live.com, Port 587 (SSL)"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Yahoo:"})," smtp.mail.yahoo.com, Port 587 (SSL)"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Custom Domain:"})," Check with your hosting provider"]})]})]})]}),"adminEmails"===t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Admin Name *"}),e.jsx("input",{type:"text",value:qe.name||"",onChange:e=>Ke({...qe,name:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"e.g., John Doe",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Email Address *"}),e.jsx("input",{type:"email",value:qe.email||"",onChange:e=>Ke({...qe,email:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"e.g., admin@yourcompany.com",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Department"}),e.jsx("input",{type:"text",value:qe.department||"",onChange:e=>Ke({...qe,department:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"e.g., IT, HR, Admin"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Role"}),e.jsx("input",{type:"text",value:qe.role||"Admin",onChange:e=>Ke({...qe,role:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"e.g., Admin, Super Admin, Manager"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"admin-receive-otp",checked:!1!==qe.receive_otp,onChange:e=>Ke({...qe,receive_otp:e.target.checked}),className:"mr-2"}),e.jsxs("label",{htmlFor:"admin-receive-otp",className:"text-sm text-black",children:[e.jsx("strong",{children:"Receive OTP Codes"})," - This admin will receive OTP codes when employees request login"]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"admin-receive-notifications",checked:!1!==qe.receive_notifications,onChange:e=>Ke({...qe,receive_notifications:e.target.checked}),className:"mr-2"}),e.jsxs("label",{htmlFor:"admin-receive-notifications",className:"text-sm text-black",children:[e.jsx("strong",{children:"Receive Notifications"})," - This admin will receive general system notifications"]})]})]}),e.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold text-amber-800 mb-2",children:" Security Note:"}),e.jsxs("div",{className:"text-sm text-amber-700 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Centralized OTP Security:"})," OTP codes will be sent to admin emails instead of individual users."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Employee Process:"})," Employees will need to contact admins to get their OTP codes for login."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Admin Responsibility:"})," Admins should verify employee identity before sharing OTP codes."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email Setup:"})," Ensure admin emails are properly configured and monitored."]})]})]})]}),"importantQuestions"===t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Question Text *"}),e.jsx("textarea",{value:qe.question||"",onChange:e=>{Ke({...qe,question:e.target.value}),e.target.style.height="auto",e.target.style.height=e.target.scrollHeight+"px"},className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"e.g., Has customer provided all required documents?",rows:"3",style:{minHeight:"80px",resize:"vertical"},required:!0}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"You can write multi-line questions. Line breaks will be preserved when displayed."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Question Type *"}),e.jsxs("select",{value:qe.type||"checkbox",onChange:e=>Ke({...qe,type:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",children:[e.jsx("option",{value:"checkbox",children:"Checkbox (Yes/No)"}),e.jsx("option",{value:"text",children:"Text Input"}),e.jsx("option",{value:"select",children:"Dropdown Select"}),e.jsx("option",{value:"radio",children:"Radio Button"})]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"mandatory",checked:!1!==qe.mandatory,onChange:e=>Ke({...qe,mandatory:e.target.checked}),className:"mr-2"}),e.jsxs("label",{htmlFor:"mandatory",className:"text-sm font-medium text-black",children:[e.jsx("strong",{children:"Mandatory Question"})," - Must be answered before proceeding"]})]}),e.jsxs("div",{className:"bg-violet-50 border border-violet-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold text-violet-800 mb-2",children:" Usage Information:"}),e.jsxs("div",{className:"text-sm text-violet-700 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Lead Processing:"})," Questions appear during lead validation workflow."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Quality Control:"})," Ensures critical information is checked before advancing leads."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Compliance:"})," Helps maintain consistent verification processes."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Ordering:"})," Questions display in the order of their display order value."]})]})]})]}),("mistakeType"===t||"warningAction"===t)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-black mb-1",children:["mistakeType"===t?"Mistake Type":"Warning Action"," Value *"]}),e.jsx("input",{type:"text",value:qe.value||"",onChange:e=>Ke({...qe,value:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:"mistakeType"===t?"e.g., Late Arrival, Abuse, Early Leave":"e.g., Verbal Warning, Written Warning",required:!0}),e.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:["This will appear in the ","mistakeType"===t?"mistake type":"warning action"," dropdown when issuing warnings."]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-black mb-1",children:"Display Label *"}),e.jsx("input",{type:"text",value:qe.label||"",onChange:e=>Ke({...qe,label:e.target.value}),className:"w-full border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",placeholder:qe.value||"Same as value above",required:!0}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"The display name shown in the dropdown (usually same as value)."})]}),e.jsxs("div",{className:("mistakeType"===t?"bg-orange-50 border-orange-200":"bg-red-50 border-red-200")+" border rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold text-orange-800 mb-2",children:" Usage Information:"}),e.jsxs("div",{className:"text-sm text-orange-700 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Warning System:"})," Types appear in the warning/mistake type dropdown."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Consistency:"})," Ensures standardized warning categorization across the system."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Flexibility:"})," Easily add or modify warning types as needed."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Ordering:"})," Types display in alphabetical order by default."]})]})]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("label",{className:"block text-sm font-medium text-black mr-3",children:"Status"}),e.jsxs("select",{value:!1!==qe.is_active?"active":"inactive",onChange:e=>Ke({...qe,is_active:"active"===e.target.value}),className:"w-40 border border-black rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-black",children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"inactive",children:"Deactivate"})]})]})]})}),e.jsxs("div",{className:"flex gap-3 p-6 border-t border-gray-200 bg-white sticky bottom-0",children:[e.jsx("button",{onClick:Lt,className:"flex-1 bg-gray-200 text-black py-2 rounded-lg hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{onClick:async()=>{try{let e,a;switch(r(!0),t){case"campaigns":e="add"===Ve?"/settings/campaign-names":`/settings/campaign-names/${Ge.id}`,a={name:qe.name,description:qe.description,is_active:!1!==qe.is_active};break;case"dataCodes":e="add"===Ve?"/settings/data-codes":`/settings/data-codes/${Ge.id}`,a={name:qe.name,description:qe.description,is_active:!1!==qe.is_active};break;case"bankNames":e="add"===Ve?"/settings/bank-names":`/settings/bank-names/${Ge.id}`,a={name:qe.name,is_active:!1!==qe.is_active};break;case"channelNames":e="add"===Ve?"/settings/channel-names":`/settings/channel-names/${Ge.id}`,a={name:qe.name,description:qe.description,is_active:!1!==qe.is_active};break;case"attachmentTypes":const t={name:qe.name,target_type:qe.target_type,sort_number:qe.sort_number||1,description:qe.description,is_active:!1!==qe.is_active};if("add"===Ve)await ee.createAttachmentType(t);else{const e=Ge?._id||Ge?.id;if(!e)throw new Error("No valid ID found for attachment type");await ee.updateAttachmentType(e,t)}return We(!1),Yt(),alert(`Attachment type ${"add"===Ve?"created":"updated"} successfully!`),void r(!1);case"emailSettings":const i={email:qe.email,password:qe.password,smtp_server:qe.smtp_server,smtp_port:qe.smtp_port,use_ssl:!1!==qe.use_ssl,is_active:!1!==qe.is_active,purpose:qe.purpose||"otp"};if("add"===Ve)await S.post(`${Mt}/otp/email-settings?user_id=${s}`,i);else{const e=Ge?._id||Ge?.id;if(!e)throw new Error("No valid ID found for email setting");await S.put(`${Mt}/otp/email-settings/${e}?user_id=${s}`,i)}return We(!1),en(),alert(`Email setting ${"add"===Ve?"created":"updated"} successfully!`),void r(!1);case"departments":e="add"===Ve?"/departments":`/departments/${Ge.id}`,a={name:qe.name,description:qe.description,parent_id:qe.parent_id,is_active:!1!==qe.is_active};break;case"designations":e="add"===Ve?"/designations":`/designations/${Ge.id}`,a={name:qe.name,description:qe.description,department_id:qe.department_id,is_active:!1!==qe.is_active};break;case"roles":e="add"===Ve?"/roles/":`/roles/${Ge?._id||Ge?.id}`;let o=[];"select"===st&&(o=Object.entries(at).map(([e,t])=>({page:e.toLowerCase(),actions:Array.isArray(t)?t.map(e=>e.toLowerCase()):[t.toLowerCase()]})));let l=qe.department_id;""!==l&&void 0!==l||(l=null);let u=(qe.reporting_ids||[]).filter(e=>e&&""!==e.trim());a={name:qe.name,department_id:l,reporting_ids:u,permissions:o};break;case"adminEmails":const d={name:qe.name,email:qe.email,department:qe.department||null,role:qe.role||"Admin",receive_otp:!1!==qe.receive_otp,receive_notifications:!1!==qe.receive_notifications,is_active:!1!==qe.is_active};if("add"===Ve)await S.post(`${Mt}/otp/admin-emails?user_id=${s}`,d);else{const e=Ge?._id||Ge?.id;if(!e)throw new Error("No valid ID found for admin email");await S.put(`${Mt}/otp/admin-emails/${e}?user_id=${s}`,d)}return We(!1),tn(),alert(`Admin email ${"add"===Ve?"created":"updated"} successfully!`),void r(!1);case"importantQuestions":const c={question:qe.question,type:qe.type||"checkbox",mandatory:!1!==qe.mandatory,is_active:!1!==qe.is_active};if("add"===Ve)await S.post(`${Mt}/important-questions?user_id=${s}`,c);else{const e=Ge?._id||Ge?.id;if(!e)throw new Error("No valid ID found for important question");await S.put(`${Mt}/important-questions/${e}?user_id=${s}`,c)}return We(!1),nn(),alert(`Important question ${"add"===Ve?"created":"updated"} successfully!`),void r(!1);case"mistakeType":const p={value:qe.value,label:qe.label||qe.value,is_active:!1!==qe.is_active},h=Ge?._id||Ge?.id;return"add"!==Ve&&h?await S.put(`${o1}/warnings/mistake-types/${h}?user_id=${localStorage.getItem("userId")}`,p):await S.post(`${o1}/warnings/mistake-types?user_id=${localStorage.getItem("userId")}`,p),We(!1),n("warningData"),await an(),alert(`Mistake type ${"add"!==Ve&&h?"updated":"created"} successfully!`),void r(!1);case"warningAction":const m={value:qe.value,label:qe.label||qe.value,is_active:!1!==qe.is_active},f=Ge?._id||Ge?.id;return"add"!==Ve&&f?await S.put(`${o1}/warnings/warning-actions/${f}?user_id=${localStorage.getItem("userId")}`,m):await S.post(`${o1}/warnings/warning-actions?user_id=${localStorage.getItem("userId")}`,m),We(!1),n("warningData"),await rn(),alert(`Warning action ${"add"!==Ve&&f?"updated":"created"} successfully!`),void r(!1)}"add"===Ve?await S.post(`${Mt}${e}?user_id=${s}`,a):await S.put(`${Mt}${e}?user_id=${s}`,a),We(!1),Wt(),alert(("add"===Ve?"Created":"Updated")+" successfully!")}catch(e){alert("Error saving: "+(e.response?.data?.detail||e.message))}finally{r(!1)}},disabled:a,className:"flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all disabled:opacity-50",children:a?"Saving...":"Save"})]})]})}):null]}):e.jsx("div",{className:"min-h-screen bg-black text-white flex items-center justify-center",children:e.jsxs("div",{className:"max-w-md w-full bg-black rounded-lg shadow-lg p-8 text-center",children:[e.jsx(B,{className:"h-16 w-16 text-white mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-white mb-4",children:"You don't have permission to access the Settings page. Please contact your administrator if you need access."}),e.jsx("div",{className:"bg-black border border-black rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(F,{className:"h-5 w-5 text-white mr-2"}),e.jsxs("span",{className:"text-sm text-white",children:["Required permission: ",e.jsx("code",{className:"bg-black px-2 py-1 rounded",children:"settings.view"})]})]})})]})}):e.jsx("div",{className:"min-h-screen bg-black text-white flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-white",children:"Loading permissions..."})]})});var kn};export{c1 as default};
