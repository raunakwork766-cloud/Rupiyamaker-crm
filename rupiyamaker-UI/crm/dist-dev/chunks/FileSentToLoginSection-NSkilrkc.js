import{j as e}from"./vendor-mui-C1GmDdcn.js";import{r as t}from"./vendor-react-EzoxUMNY.js";import"./vendor-utils-QXd9EeNt.js";import"./vendor-antd-BB3a0mYC.js";const a="/api",n=({lead:n,onClose:s,onUpdate:o})=>{const[r,i]=t.useState("pending"),[l,d]=t.useState(!1),[c,m]=t.useState(""),[g,u]=t.useState(null),[y,h]=t.useState([]),[p,_]=t.useState(""),[f,x]=t.useState([]),[b,S]=t.useState(""),[j,N]=t.useState(!1),[w,v]=t.useState(!1);return t.useEffect(()=>{(async()=>{try{N(!0);const e=localStorage.getItem("userId"),t=await fetch(`${a}/departments/?user_id=${e}`,{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.json();h(n);const s=n.find(e=>e.name.toLowerCase().includes("login"));s&&_(s._id)}catch(e){}finally{N(!1)}})()},[]),t.useEffect(()=>{(async()=>{if(!p)return x([]),void S("");try{v(!0),localStorage.getItem("userId");const e=await fetch(`${a}/users/?department_id=${p}`,{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();x(t),t.length>0?S(t[0]._id):S("")}catch(e){}finally{v(!1)}})()},[p]),e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gradient-to-b from-gray-900 to-black p-4 rounded-xl shadow-2xl max-w-lg w-full border border-cyan-800",children:[e.jsx("h2",{className:"text-lg font-bold text-cyan-400 mb-3",children:"Send Lead to Login CRM"}),"pending"===r&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-white text-base mb-3",children:["You are about to send lead information for ",e.jsxs("span",{className:"font-bold text-cyan-300",children:[n?.first_name," ",n?.last_name]})," to the Login CRM."]}),e.jsxs("div",{className:"bg-gray-800 p-2 rounded-lg mb-3 border border-gray-700",children:[e.jsx("h3",{className:"text-base font-bold text-cyan-300 mb-1",children:"Lead Summary"}),e.jsxs("ul",{className:"space-y-0 text-gray-300 text-sm",children:[e.jsxs("li",{children:[e.jsx("span",{className:"font-medium text-gray-400",children:"Name:"})," ",n?.first_name," ",n?.last_name]}),e.jsxs("li",{children:[e.jsx("span",{className:"font-medium text-gray-400",children:"Mobile:"})," ",n?.mobile_number||n?.phone]}),e.jsxs("li",{children:[e.jsx("span",{className:"font-medium text-gray-400",children:"Email:"})," ",n?.email||"N/A"]}),e.jsxs("li",{children:[e.jsx("span",{className:"font-medium text-gray-400",children:"Loan Type:"})," ",n?.loan_type_name||n?.loan_type||"N/A"]})]})]}),e.jsxs("div",{className:"bg-gray-800 p-2 rounded-lg mb-3 border border-gray-700",children:[e.jsx("h3",{className:"text-base font-bold text-cyan-300 mb-1",children:"Select Department & User"}),e.jsxs("div",{className:"mb-2",children:[e.jsx("label",{className:"block text-gray-400 mb-1 font-medium text-sm",children:"Department"}),e.jsxs("select",{className:"w-full bg-gray-900 border border-gray-700 text-white p-1.5 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm",value:p,onChange:e=>_(e.target.value),disabled:j,children:[e.jsx("option",{value:"",children:"Select Department"}),Array.isArray(y)&&y.map(t=>e.jsx("option",{value:t._id,children:t.name},t._id))]}),j&&e.jsx("p",{className:"text-gray-400 mt-1 text-xs",children:"Loading departments..."})]}),p&&e.jsxs("div",{className:"mb-1",children:[e.jsx("label",{className:"block text-gray-400 mb-1 font-medium text-sm",children:"User"}),e.jsxs("select",{className:"w-full bg-gray-900 border border-gray-700 text-white p-1.5 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm",value:b,onChange:e=>S(e.target.value),disabled:w||0===f.length,children:[e.jsx("option",{value:"",children:"Select User"}),f.map(t=>e.jsxs("option",{value:t._id,children:[t.first_name," ",t.last_name]},t._id))]}),w&&e.jsx("p",{className:"text-gray-400 mt-1 text-xs",children:"Loading users..."}),!w&&0===f.length&&e.jsx("p",{className:"text-yellow-500 mt-1 text-sm",children:"No users found in this department"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:s,className:"px-3 py-1.5 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition text-sm",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(!n?._id)return i("error"),void m("No lead ID available");if(!p)return i("error"),void m("Please select a department");d(!0),m("Sending lead data to Login CRM...");try{const s=localStorage.getItem("userId");try{const t=`${a}/leads/${n._id}/obligations?user_id=${s}`,o=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});let r=null;if(o.ok&&(r=await o.json()),r&&Object.keys(r).length>0){const e={...r,_transferMetadata:{originalLeadId:n._id,transferDate:(new Date).toISOString(),sourceSystem:"LEAD_CRM",targetSystem:"LOGIN_CRM",version:"2.0"},salary:r.salary||r.monthly_income,monthly_income:r.salary||r.monthly_income,loanRequired:r.loanRequired||r.loan_required,loan_required:r.loanRequired||r.loan_required,loan_amount:r.loanRequired||r.loan_amount,companyName:r.companyName||r.company_name,company_name:r.companyName||r.company_name,dynamic_fields:{...r.dynamic_fields||{},financial_details:{...r.dynamic_fields?.financial_details||{},monthly_income:r.salary||r.monthly_income,salary:r.salary||r.monthly_income,loan_required:r.loanRequired?"string"==typeof r.loanRequired?parseFloat(r.loanRequired.replace(/[₹,]/g,"")):r.loanRequired:null,loan_amount:r.loanRequired?"string"==typeof r.loanRequired?parseFloat(r.loanRequired.replace(/[₹,]/g,"")):r.loanRequired:null,partner_salary:r.partnerSalary,yearly_bonus:r.yearlyBonus,cibil_score:r.cibilScore},personal_details:{...r.dynamic_fields?.personal_details||{},company_name:r.companyName||r.company_name,company_type:r.companyType,company_category:r.companyCategory},obligation_data:{...r.dynamic_fields?.obligation_data||{},salary:r.salary,loanRequired:r.loanRequired,companyName:r.companyName,obligations:r.obligations||[]}},dynamic_details:{financial_details:{monthly_income:r.salary||r.monthly_income,salary:r.salary||r.monthly_income,loan_required:r.loanRequired?"string"==typeof r.loanRequired?parseFloat(r.loanRequired.replace(/[₹,]/g,"")):r.loanRequired:null,partner_salary:r.partnerSalary,yearly_bonus:r.yearlyBonus,cibil_score:r.cibilScore},personal_details:{company_name:r.companyName||r.company_name,company_type:r.companyType,company_category:r.companyCategory}}},o={leadId:n._id,timestamp:(new Date).toISOString(),originalData:r,enhancedData:e,leadInfo:{name:`${n.first_name} ${n.last_name}`,mobile:n.mobile_number||n.phone,email:n.email}};localStorage.setItem(`loginTransferBackup_${n._id}`,JSON.stringify(o));const i=[];i.push(fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(e)}).then(e=>({method:"obligations_endpoint",success:e.ok,status:e.status})).catch(e=>({method:"obligations_endpoint",success:!1,error:e.message}))),i.push(fetch(`${a}/leads/${n._id}?user_id=${s}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({obligation_data:e,_lastObligationUpdate:(new Date).toISOString(),_loginTransferReady:!0})}).then(e=>({method:"lead_update",success:e.ok,status:e.status})).catch(e=>({method:"lead_update",success:!1,error:e.message}))),i.push(fetch(`${a}/leads/${n._id}/backup-obligations?user_id=${s}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({...e,_isBackup:!0,_backupTimestamp:(new Date).toISOString()})}).then(e=>({method:"backup_endpoint",success:e.ok,status:e.status})).catch(e=>({method:"backup_endpoint",success:!1,error:e.message})));(await Promise.allSettled(i)).filter(e=>"fulfilled"===e.status&&e.value.success).map(e=>e.value).length}else{const a={_transferMetadata:{originalLeadId:n._id,transferDate:(new Date).toISOString(),sourceSystem:"LEAD_CRM",targetSystem:"LOGIN_CRM",dataStatus:"NO_DATA_FOUND"},obligations:[],dynamic_fields:{financial_details:{},personal_details:{}},dynamic_details:{financial_details:{},personal_details:{}}};try{await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(a)})}catch(e){}}}catch(e){m("Warning: Obligation data may need manual verification after transfer");try{const t={leadId:n._id,timestamp:(new Date).toISOString(),leadData:n,errorInfo:e.message};localStorage.setItem(`emergencyBackup_${n._id}`,JSON.stringify(t))}catch(t){}}m("Sending lead data to Login CRM...");const r=`${a}/lead-login/send-to-login-department/${n._id}?user_id=${s}`,l=`${a}/leads/${n._id}/activities?user_id=${s}`,d=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({department_id:p,assigned_user_id:b||null})});if(!d.ok)throw new Error(`HTTP error! status: ${d.status}`);const c=await d.json();(await fetch(l,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({lead_id:n._id,user_id:s,activity_type:"file_sent_to_login",description:"File sent to login",details:{form_type:"login",login_status:"sent",timestamp:(new Date).toISOString(),department_id:p,assigned_user_id:b||null}})})).ok,u(c),i("success"),m("Lead successfully sent to Login CRM!"),setTimeout(async()=>{try{const e=await fetch(`${a}/leads/${n._id}/obligations?user_id=${s}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(e.ok){const t=await e.json();if(!(t.salary||t.loanRequired||t.dynamic_fields?.financial_details?.monthly_income||t.dynamic_details?.financial_details?.monthly_income)){const e=localStorage.getItem(`loginTransferBackup_${n._id}`);if(e){const t=JSON.parse(e);(await fetch(`${a}/leads/${n._id}/obligations?user_id=${s}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({...t.enhancedData,_recoveredFromBackup:!0,_recoveryTimestamp:(new Date).toISOString()})})).ok}}}}catch(e){}},3e3);const g=JSON.parse(localStorage.getItem("sentToLoginLeads")||"[]");g.includes(n._id)||(g.push(n._id),localStorage.setItem("sentToLoginLeads",JSON.stringify(g))),o&&o({...n,file_sent_to_login:!0,login_department_sent_date:(new Date).toISOString(),login_department_id:p,login_assigned_user_id:b||null})}catch(e){i("error"),m(`Failed to send lead to Login CRM: ${e.message}`)}finally{d(!1)}},disabled:l||!p,className:"px-3 py-1.5 rounded-lg text-white transition text-sm "+(l||!p?"bg-gray-600 cursor-not-allowed":"bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-blue-600 hover:to-cyan-500"),children:l?"Sending...":"Send to Login CRM"})]})]}),"success"===r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-green-900/30 border border-green-700 rounded-lg p-2 mb-3",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 text-green-500 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})}),e.jsx("p",{className:"text-green-400 font-medium text-base",children:c})]})}),g&&e.jsxs("div",{className:"bg-gray-800 p-2 rounded-lg mb-3 border border-gray-700",children:[e.jsx("h3",{className:"text-base font-bold text-cyan-300 mb-1",children:"Login CRM Details"}),e.jsx("p",{className:"text-gray-300 text-sm",children:"Lead successfully transferred to Login CRM system."}),e.jsxs("p",{className:"text-gray-300 text-sm",children:["Department: ",y.find(e=>e._id===p)?.name||"N/A"]}),e.jsxs("p",{className:"text-gray-300 text-sm",children:["Assigned to: ",f.find(e=>e._id===b)?.first_name," ",f.find(e=>e._id===b)?.last_name||"Unassigned"]}),e.jsxs("p",{className:"text-gray-400 text-sm",children:["Transfer ID: ",g.transferId||g._id||"N/A"]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:s,className:"px-3 py-1.5 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-cyan-500 transition text-sm",children:"Close"})})]}),"error"===r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-red-900/30 border border-red-700 rounded-lg p-2 mb-3",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 text-red-500 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})}),e.jsx("p",{className:"text-red-400 font-medium text-base",children:c})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:s,className:"px-3 py-1.5 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-cyan-500 transition text-sm",children:"Close"})})]})]})})};export{n as default};
