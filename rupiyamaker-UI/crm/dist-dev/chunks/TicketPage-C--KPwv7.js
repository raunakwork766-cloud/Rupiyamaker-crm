const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["chunks/CreateTicket-DXvZWB2h.js","chunks/vendor-mui-C1GmDdcn.js","chunks/vendor-react-EzoxUMNY.js","chunks/vendor-utils-QXd9EeNt.js","chunks/vendor-antd-BB3a0mYC.js","chunks/employee-components-DG4zFnGp.js","chunks/lead-components-BqJ0uj9n.js","chunks/vendor-office-CbbGW2MO.js","styles/employee-components-CAryrO_Y.css","chunks/task-components-COurVJWn.js","styles/task-components-DguWJUkH.css","chunks/EditTicket-CjqTcHVq.js"])))=>i.map(i=>d[i]);
import{i as e,g as t,r as s,_ as a}from"./lead-components-BqJ0uj9n.js";import{j as i}from"./vendor-mui-C1GmDdcn.js";import{r as n}from"./vendor-react-EzoxUMNY.js";import{A as l,f as r}from"./employee-components-DG4zFnGp.js";import{y as o}from"./task-components-COurVJWn.js";import"./vendor-antd-BB3a0mYC.js";import"./vendor-utils-QXd9EeNt.js";import"./vendor-office-CbbGW2MO.js";const c=n.lazy(()=>a(()=>import("./CreateTicket-DXvZWB2h.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]))),d=n.lazy(()=>a(()=>import("./EditTicket-CjqTcHVq.js"),__vite__mapDeps([11,1,2,3,4,5,6,7,8,9,10])));function u(){const[a,u]=n.useState([]),[h,m]=n.useState([]),[f,p]=n.useState(!1),[x,g]=n.useState(!0),[y,k]=n.useState(null),[b,w]=n.useState(""),[j,v]=n.useState("open"),[N,S]=n.useState(null),[C,_]=n.useState(!1),[T,A]=n.useState(""),[E,$]=n.useState(!1),[I,F]=n.useState(!1),[L,P]=n.useState(null),[D,O]=n.useState({}),[U,z]=n.useState(!1),[J,B]=n.useState({show:!0,own:!0,junior:!1,all:!1,delete:!1}),[M,R]=n.useState([]),[W,G]=n.useState(!1),[V,K]=n.useState(!1),Y=()=>{try{const a=t();if(e(a))return void B({show:!0,own:!0,junior:!0,all:!0,delete:!0});const i={show:s(a,"tickets","show")||s(a,"Tickets","show"),own:s(a,"tickets","own")||s(a,"Tickets","own"),junior:s(a,"tickets","junior")||s(a,"Tickets","junior"),all:s(a,"tickets","all")||s(a,"Tickets","all"),delete:s(a,"tickets","delete")||s(a,"Tickets","delete")};if("*"===a?.tickets||"*"===a?.Tickets)return void B({show:!0,own:!0,junior:!0,all:!0,delete:!0});i.show?B({show:!0,own:i.own||!0,junior:i.junior,all:i.all,delete:i.delete}):B({show:!1,own:!1,junior:!1,all:!1,delete:!1})}catch(a){B({show:!0,own:!0,junior:!1,all:!1,delete:!1})}};n.useEffect(()=>{try{const t=localStorage.getItem("userName"),s=localStorage.getItem("userFirstName"),a=localStorage.getItem("userLastName");if(t)return void A(t);if(s&&a)return void A(`${s} ${a}`);if(s)return void A(s);const i=localStorage.getItem("user");if(i)try{const e=JSON.parse(i);if(e.name)return void A(e.name);if(e.fullName)return void A(e.fullName);if(e.firstName&&e.lastName)return void A(`${e.firstName} ${e.lastName}`);if(e.firstName)return void A(e.firstName);if(e.username)return void A(e.username);if(e.email)return void A(e.email)}catch(e){}A("Current User")}catch(t){A("Current User")}},[]),n.useEffect(()=>{!1!==Y()&&g(!1)},[]),n.useEffect(()=>{const e=e=>{"userPermissions"!==e.key&&null!==e.key||(Y(),O({}))};window.addEventListener("storage",e);const t=()=>{Y(),O({})};return window.addEventListener("permissionsUpdated",t),()=>{window.removeEventListener("storage",e),window.removeEventListener("permissionsUpdated",t)}},[]),n.useEffect(()=>{x||(q(),X())},[J.junior,J.all,j,x]);const q=async()=>{try{const e=`${j}_${J.junior}_${J.all}`;if(D[e]&&!x)return u(D[e]),p(!1),void H(e);p(!0),await H(e)}catch(e){Q(e)}finally{p(!1)}},H=async e=>{k(null);try{const s=localStorage.getItem("userData");if(!s)return void k("Please log in to view tickets");let a;try{a=JSON.parse(s)}catch(t){return void k("Invalid user session. Please log in again.")}const i="open"===j?"open":"closed"===j?"closed":"failed"===j?"failed":void 0,n=i?{status:i}:{},r=JSON.parse(localStorage.getItem("userPermissions")||"[]");let o=!1,c=!1,d=!1;if(Array.isArray(r))for(const e of r)if(e&&("tickets"===e.page||"Tickets"===e.page)){d=!0,Array.isArray(e.actions)?(o=e.actions.includes("junior"),c=e.actions.includes("all")):"junior"===e.actions?o=!0:"all"===e.actions&&(c=!0);break}const f=await l.tickets.getTickets(1,100,n);if(!f||!Array.isArray(f.tickets))throw new Error("Invalid response format from server");const p=f.tickets.map(e=>(e.attachments||(e.attachments=[]),e.status&&(e.status=e.status.toLowerCase()),e));u(p),O(t=>({...t,[e]:p})),0!==h.length||j&&"all"!==j||m(p)}catch(s){throw s}},Q=e=>{let t="Failed to load tickets. ";e.message.includes("User not authenticated")?t+="Please log in and try again.":e.message.includes("Network error")?t+="Please check your internet connection.":e.message.includes("fetch")?t+="Cannot connect to server. Please verify the backend is running.":t+="Please try again later.",k(t),o.error(t)};n.useEffect(()=>{if(!x&&J.show&&!U){const e=`${j}_${J.junior}_${J.all}`;O(t=>{const s={...t};return delete s[e],s}),q()}},[j,x,J.show,J.junior,J.all,U]);const X=async(e=null)=>{try{const e=localStorage.getItem("userData");if(!e)return void m([]);const t=JSON.parse(e),s={},a=JSON.parse(localStorage.getItem("userPermissions")||"[]");let i=!1,n=!1;if(Array.isArray(a))for(const l of a)if(l&&("tickets"===l.page||"Tickets"===l.page)){Array.isArray(l.actions)?(i=l.actions.includes("junior"),n=l.actions.includes("all")):"junior"===l.actions?i=!0:"all"===l.actions&&(n=!0);break}i||n||(s.user_id=t.user_id,s.created_by_me=!0);const r=await l.tickets.getTickets(1,100,s);r&&Array.isArray(r.tickets)?(m(r.tickets),r.tickets.filter(e=>"open"===e.status).length,r.tickets.filter(e=>"closed"===e.status).length,r.tickets.filter(e=>"failed"===e.status).length,r.tickets.length):m([])}catch(t){m([])}},Z=h.filter(e=>"open"===e.status).length,ee=h.filter(e=>"closed"===e.status).length,te=h.filter(e=>"failed"===e.status).length,se=h.length,ae=a.filter(e=>"open"===e.status).length,ie=a.filter(e=>"closed"===e.status).length,ne=a.filter(e=>"failed"===e.status).length,le=a.length,re=h.length>0?Z:ae,oe=h.length>0?ee:ie,ce=h.length>0?te:ne,de=h.length>0?se:le,ue=re>0?re:ae,he=oe>0?oe:ie,me=ce>0?ce:ne,fe=de>0?de:le;n.useEffect(()=>{h.length},[h,a,ue,he,me,fe]);const pe=n.useMemo(()=>({open:ue,closed:he,failed:me,all:fe}),[ue,he,me,fe]),xe=n.useMemo(()=>[{key:"open",label:"OpenTicket",count:pe.open},{key:"closed",label:"CloseTicket",count:pe.closed},{key:"failed",label:"Failed",count:pe.failed},{key:"all",label:"All",count:pe.all}],[pe]),ge=n.useMemo(()=>{let e=a;if("open"===j?e=a.filter(e=>"open"===e.status):"closed"===j?e=a.filter(e=>"closed"===e.status):"failed"===j&&(e=a.filter(e=>"failed"===e.status)),!b.trim())return e;const t=b.toLowerCase();return e.filter(e=>e.created_by_name&&e.created_by_name.toLowerCase().includes(t)||e.subject.toLowerCase().includes(t)||e.description.toLowerCase().includes(t)||e.assigned_users_details&&e.assigned_users_details.some(e=>e.name&&e.name.toLowerCase().includes(t)))},[a,b,j]),ye=n.useCallback(async e=>{try{if(I||N||E||L===e.id)return;P(e.id),$(!0),F(!0),setTimeout(()=>{P(null)},1e3),await new Promise(e=>setTimeout(e,50));try{const t=e._id||e.id,s=await l.tickets.getTicketById(t);s?(s.attachments||(s.attachments=[]),s.attachments&&s.attachments.length>0&&(s.attachments=s.attachments.map(e=>(e.url&&!e.url.startsWith("http")&&(e.url=`/api${e.url}`),e))),S(s)):(e.attachments||(e.attachments=[]),S(e))}catch(t){e.attachments||(e.attachments=[]),S(e)}finally{$(!1),F(!1),P(null)}}catch(t){$(!1),F(!1),P(null)}},[I,N,E,L]),ke=e=>{G(e),R(e?ge.map(e=>e.id||e._id):[])},be=()=>{R([]),G(!1),K(!1)},we=n.useCallback(()=>{S(null),$(!1),F(!1),P(null)},[]),je=n.useCallback(()=>{_(!0)},[]),ve=n.useCallback(()=>{_(!1),$(!1),F(!1),P(null)},[]);n.useCallback(()=>{q(),X(J)},[q,X,J]);const Ne=n.useCallback(e=>{w(e.target.value)},[]),Se=n.useCallback(e=>{v(e)},[]);return i.jsxs(i.Fragment,{children:[i.jsx("style",{children:"\n    .sticky-table-container {\n      max-height: 600px;\n      overflow-y: auto;\n      overflow-x: auto;\n      border-radius: 12px;\n    }\n    \n    .sticky-header {\n      position: sticky;\n      top: 0;\n      background: white;\n      // z-index: 10;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n    }\n    \n    .sticky-th {\n      position: sticky;\n      top: 0;\n      background: white;\n      // z-index: 10;\n      border-bottom: 2px solid #e5e7eb;\n    }\n  "}),i.jsxs("div",{className:"min-h-screen bg-black text-white font-sans pb-4 p-4",style:{zoom:.97,MozTransform:"scale(0.97)"},children:[i.jsxs("div",{className:"flex justify-between items-center px-8 pt-8",children:[i.jsx("div",{className:"flex items-center gap-3",children:(()=>{const s=e(t());return J.delete||s})()&&i.jsx("div",{className:"flex items-center gap-3",children:V?i.jsxs("div",{className:"flex items-center gap-6 bg-gray-900 rounded-lg p-3",children:[i.jsxs("label",{className:"flex items-center cursor-pointer text-[#03B0F5] font-bold",children:[i.jsx("input",{type:"checkbox",className:"accent-blue-500 mr-2",checked:W,onChange:e=>ke(e.target.checked),style:{width:18,height:18}}),"Select All"]}),i.jsxs("span",{className:"text-white font-semibold",children:[M.length," row",1!==M.length?"s":""," selected"]}),i.jsxs("button",{className:"px-3 py-1 bg-red-600 text-white rounded font-bold hover:bg-red-700 transition",onClick:async()=>{if(0!==M.length&&window.confirm(`Are you sure you want to delete ${M.length} selected ticket(s)?`))try{let t=0,s=0;for(const a of M)try{await l.tickets.deleteTicket(a),t++}catch(e){s++}t>0&&0===s?o.success(`Successfully deleted ${t} ticket(s)`):t>0&&s>0?o.warning(`Deleted ${t} ticket(s), failed to delete ${s} ticket(s)`):o.error(`Failed to delete all ${s} ticket(s)`),be(),await q(),await X(J)}catch(e){o.error("Error deleting tickets")}},disabled:0===M.length,children:["Delete (",M.length,")"]}),i.jsx("button",{className:"px-3 py-1 bg-gray-600 text-white rounded font-bold hover:bg-gray-700 transition",onClick:be,children:"Cancel"})]}):i.jsx("button",{className:"bg-[#03B0F5] text-white px-5 py-3 rounded-lg font-bold shadow hover:bg-[#0280b5] transition text-base",onClick:()=>{K(!0),R([]),G(!1)},children:M.length>0?`Select (${M.length})`:"Select"})})}),i.jsx("div",{className:"flex items-center gap-3",children:i.jsx("button",{className:"bg-[#00C5FA] hover:bg-[#00a9d4] text-white text-base font-bold px-6 py-2 rounded-lg shadow focus:outline-none transition",onClick:je,children:"Create Ticket"})})]}),i.jsxs("div",{className:"flex flex-wrap items-center gap-3 px-7 mt-4 mb-6",children:[xe.map(e=>i.jsxs("button",{onClick:()=>Se(e.key),className:`flex items-center gap-2 px-5 py-2 rounded-full font-bold text-base shadow transition-all duration-200 ${j===e.key?"bg-[#00C5FA] text-white shadow-lg":"bg-white text-[#00C5FA] hover:bg-blue-50"}\n            `,style:{minWidth:144,justifyContent:"center",fontSize:"1.18rem"},children:[e.label,i.jsx("span",{className:"ml-2 px-2 py-0.5 rounded-full text-xs font-bold "+(e.count>0?"bg-[#222] text-white":"bg-[#eee] text-[#00C5FA]"),children:e.count})]},e.key)),i.jsx("div",{className:"ml-auto flex items-center",children:i.jsx("input",{className:"rounded-full px-4 py-2 border-2 border-[#00C5FA] bg-[#232a36] text-[#eee] font-medium focus:outline-none text-base shadow",style:{minWidth:258,maxWidth:268},placeholder:"Search by created by, subject, assign, message...",value:b,onChange:Ne})})]}),i.jsx("div",{className:"overflow-x-auto px-2 sticky-table-container",children:f?i.jsx("div",{className:"flex justify-center py-8",children:i.jsx("div",{className:"bg-[#181e29] rounded-xl shadow p-5 text-center font-bold text-[#00C5FA]",children:"Loading tickets..."})}):y?i.jsx("div",{className:"flex justify-center py-8",children:i.jsx("div",{className:"bg-[#181e29] rounded-xl shadow p-5 text-center font-bold text-red-500",children:y})}):i.jsxs("table",{className:"min-w-[616px] w-full rounded-xl overflow-hidden",children:[i.jsx("thead",{className:"sticky-header",children:i.jsxs("tr",{className:"bg-white text-[#00C5FA]",children:[(J.delete||e(t()))&&V&&i.jsx("th",{className:"py-1 px-3 text-left text-lg font-extrabold sticky-th",children:i.jsx("input",{type:"checkbox",checked:W,onChange:e=>ke(e.target.checked),className:"rounded border-gray-300"})}),i.jsx("th",{className:"py-1 px-4 text-left text-lg font-extrabold sticky-th",children:"#"}),i.jsx("th",{className:"py-1 px-3 text-left text-lg font-extrabold sticky-th",children:"DATE & TIME"}),i.jsx("th",{className:"py-1 px-3 text-left text-lg font-extrabold sticky-th",children:"CREATED BY"}),i.jsx("th",{className:"py-1 px-3 text-left text-lg font-extrabold sticky-th",children:"SUBJECT"}),i.jsx("th",{className:"py-1 px-3 text-left text-lg font-extrabold sticky-th",children:"TICKET DETAILS"}),i.jsx("th",{className:"py-1 px-3 text-left text-lg font-extrabold sticky-th",children:"ASSIGN"})]})}),i.jsx("tbody",{children:0===ge.length?i.jsx("tr",{children:i.jsx("td",{colSpan:(J.delete||e(t()))&&V?7:6,className:"bg-[#181e29] rounded-xl shadow p-5 text-center font-bold text-[#00C5FA]",children:f?"Loading tickets...":0===a.length?i.jsxs("div",{children:[i.jsx("div",{className:"mb-2",children:"No tickets available."}),i.jsx("div",{className:"text-sm text-gray-400",children:y?"There was an error loading tickets.":"Create your first ticket using the 'Create Ticket' button above."})]}):`No tickets match your current filter "${j}" or search criteria.`})}):ge.map((s,a)=>i.jsxs("tr",{className:"border-b border-gray-800 hover:bg-[#1a222e] transition align-top cursor-pointer "+(I||E||L===s.id?"opacity-50 cursor-not-allowed":""),onClick:e=>{V&&"checkbox"===e.target.type||ye(s)},children:[(J.delete||e(t()))&&V&&i.jsx("td",{className:"py-3 px-3 text-md text-left",onClick:e=>e.stopPropagation(),children:i.jsx("input",{type:"checkbox",checked:M.includes(s.id||s._id),onChange:e=>{var t,a;e.stopPropagation(),t=s.id||s._id,a=e.target.checked,R(e=>a?[...e,t]:e.filter(e=>e!==t))},onClick:e=>e.stopPropagation(),className:"rounded border-gray-300"})}),i.jsx("td",{className:"py-3 text-md font-bold px-3 text-left",children:a+1}),i.jsx("td",{className:"py-3 px-3 text-md font-bold text-left",children:s.created_at?r(s.created_at):"N/A"}),i.jsx("td",{className:"py-3 px-3 text-md font-bold text-left",children:s.created_by_name||"Unknown"}),i.jsx("td",{className:"py-3 px-3 text-md font-extrabold text-left",children:s.subject}),i.jsx("td",{className:"py-3 px-3 text-md font-bold whitespace-pre-line text-left",children:(()=>{const e=((e,t=41)=>{if(!e)return"";const s=e.split(" ");let a=[],i="";return s.forEach(e=>{(i+" "+e).trim().length>t?(i&&a.push(i.trim()),i=e):i+=" "+e}),i&&a.push(i.trim()),a})(s.description,41);return e.length<=2?e.map((e,t)=>i.jsx("div",{children:e},t)):[...e.slice(0,1).map((e,t)=>i.jsx("div",{children:e},t)),i.jsxs("div",{children:[e[1],"..."]},"ellipsis")]})()}),i.jsx("td",{className:"py-3 px-3 text-base font-bold text-left",children:s.assigned_users_details&&s.assigned_users_details.length>0?s.assigned_users_details.map(e=>e.name).join(", "):"Unassigned"})]},s._id))})]})}),N&&i.jsx("div",{className:"fixed inset-0 z-[1000] flex items-center bg-transparent justify-center",style:{backdropFilter:"blur(3px)"},children:i.jsx("div",{className:"w-full max-w-xl mx-auto",children:i.jsx(d,{ticket:N,onSave:async e=>{try{const i=e._id||e.id,n={subject:e.subject,description:e.description||e.message,priority:e.priority||"medium",assigned_users:Array.isArray(e.assigned_users)?e.assigned_users:[e.assign],status:e.status.toLowerCase()},r=a.find(e=>(e._id||e.id)===i),c="closed"===n.status&&"open"===r?.status,d="open"===n.status&&("closed"===r?.status||"failed"===r?.status),u="failed"===n.status&&"open"===r?.status;(c||u||d)&&z(!0),S(null);try{await l.tickets.updateTicket(i,n)}catch(t){return o.error(`Failed to update ticket: ${t.message}`),void z(!1)}if(c&&"open"===j){const e=`closed_${J.junior}_${J.all}`;O(t=>{const s={...t};return delete s[e],s}),v("closed"),setTimeout(async()=>{await q(),await X(J),z(!1)},300),o.success("Ticket closed successfully! Switched to Closed Tickets tab.");const t=new CustomEvent("ticketStatusChanged",{detail:{ticketId:i,newStatus:"closed",oldStatus:"open",suggestedTab:"closed",shouldAutoSwitch:!0,immediate:!0,timestamp:(new Date).toISOString()}});window.dispatchEvent(t)}else if(u&&"open"===j){const e=`failed_${J.junior}_${J.all}`;O(t=>{const s={...t};return delete s[e],s}),v("failed"),setTimeout(async()=>{await q(),await X(J),z(!1)},300),o.success("Ticket marked as failed! Switched to Failed tab.");const t=new CustomEvent("ticketStatusChanged",{detail:{ticketId:i,newStatus:"failed",oldStatus:"open",suggestedTab:"failed",shouldAutoSwitch:!0,immediate:!0,timestamp:(new Date).toISOString()}});window.dispatchEvent(t)}else if(!d||"closed"!==j&&"failed"!==j)await q(),await X(J),o.success("Ticket updated successfully"),z(!1);else{const e=`open_${J.junior}_${J.all}`;O(t=>{const s={...t};return delete s[e],s}),v("open"),setTimeout(async()=>{await q(),await X(J),z(!1)},300),o.success("Ticket reopened successfully! Switched to Open Tickets tab.");const t=new CustomEvent("ticketStatusChanged",{detail:{ticketId:i,newStatus:"open",oldStatus:r?.status||"closed",suggestedTab:"open",shouldAutoSwitch:!0,immediate:!0,timestamp:(new Date).toISOString()}});window.dispatchEvent(t)}if(e.newAttachments&&e.newAttachments.length>0)try{const t=e.newAttachments.filter(e=>e.file).map(e=>e.file);t.length>0&&(await l.tickets.uploadAttachments(i,t),o.success("Attachments uploaded successfully"))}catch(s){o.error(`Failed to upload attachments: ${s.message}`)}e.attachmentsToRemove&&e.attachmentsToRemove.length,X(J)}catch(t){o.error("Failed to save ticket changes"),S(null),z(!1)}},onClose:we})})}),C&&i.jsx("div",{className:"fixed inset-0 z-[1000] flex items-center justify-center bg-transparent bg-opacity-40 backdrop-blur-sm",children:i.jsx("div",{className:"w-full min-w-md mx-auto",children:i.jsx(c,{onClose:ve,onSubmit:async e=>{try{const s={subject:e.subject,description:e.details||e.message,priority:e.priority||"medium",assigned_users:Array.isArray(e.assignedUserIds)&&e.assignedUserIds.length>0?e.assignedUserIds:Array.isArray(e.assignedTo)?e.assignedTo:[e.assign]},a=await l.tickets.createTicket(s);if(e.files&&e.files.length>0)try{await l.tickets.uploadAttachments(a._id,e.files),o.success(`Ticket created with ${e.files.length} attachment(s)`)}catch(t){o.warning("Ticket created but attachments could not be uploaded")}else o.success("Ticket created successfully");q(),X(J),_(!1)}catch(s){o.error("Failed to create ticket")}}})})})]})]})}export{u as default};
