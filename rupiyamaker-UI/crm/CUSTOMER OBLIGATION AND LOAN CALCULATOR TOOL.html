<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }

        // Get numeric value from input with suffix
        function getNumericValue(inputElement, suffix = '') {
            if (!inputElement) return 0;
            let value = String(inputElement.value || '').trim();
            if (suffix && value.endsWith(suffix)) {
                value = value.replace(suffix, '').trim();
            }
            // Parse based on expected type
            if (suffix.includes('Years') || suffix.includes('Months')) {
                return parseInt(value.replace(/[^0-9]/g, '')) || 0; // Integer for tenure
            } else {
                return parseFloat(value.replace(/[^0-9.]/g, '')) || 0; // Float otherwise
            }
        }

        // Format currency with commas (Indian format)
        function formatCurrencyWithCommas(amount) {
            if (isNaN(amount) || amount === 0) return '₹0';

            // Round the amount to remove any decimals
            amount = Math.round(amount);

            // Convert to string (no decimals)
            const amountStr = Math.floor(amount).toString();

            // Format integer part with commas (Indian format: 1,23,456)
            let formattedInteger = '';
            let integerPart = amountStr;

            // Apply Indian number formatting (1,23,456)
            if (integerPart.length > 3) {
                formattedInteger = ',' + integerPart.substring(integerPart.length - 3);
                integerPart = integerPart.substring(0, integerPart.length - 3);

                while (integerPart.length > 0) {
                    if (integerPart.length >= 2) {
                        formattedInteger = ',' + integerPart.substring(integerPart.length - 2) + formattedInteger;
                        integerPart = integerPart.substring(0, integerPart.length - 2);
                    } else {
                        formattedInteger = integerPart + formattedInteger;
                        integerPart = '';
                    }
                }

                // Remove leading comma if present
                if (formattedInteger.startsWith(',')) {
                    formattedInteger = formattedInteger.substring(1);
                }
            } else {
                formattedInteger = integerPart;
            }

            return '₹' + formattedInteger;
        }

        // Parse currency string to number
        function parseCurrency(currencyStr) {
            if (!currencyStr) return 0;
            // Remove currency symbol and commas, then parse as integer
            return Math.round(parseFloat(currencyStr.replace(/[^\d.]/g, ''))) || 0;
        }

        // Calculate eligibility based on FOIR
        function calculateEligibilityFOIR() {
            // Get input values
            const totalIncomeInput = document.getElementById('eligibilityTotalIncome');
            const totalObligationInput = document.getElementById('eligibilityTotalObligation');
            const foirPercentageInput = document.getElementById('foirPercentage');
            const tenureMonthsInput = document.getElementById('eligibilityTenureMonths');
            const roiInput = document.getElementById('eligibilityRoi');
            const totalBtPosInput = document.getElementById('eligibilityTotalBtPos');

            if (!totalIncomeInput || !totalObligationInput || !foirPercentageInput || !tenureMonthsInput || !roiInput) {
                console.log('Missing required elements for FOIR calculation');
                return 0;
            }

            const totalIncome = parseCurrency(totalIncomeInput.value);
            const totalObligation = parseCurrency(totalObligationInput.value);
            const foirPercentage = getNumericValue(foirPercentageInput, '%');
            const totalBtPos = totalBtPosInput ? parseCurrency(totalBtPosInput.value) : 0;

            console.log('FOIR Calculation Inputs:', {
                totalIncome,
                totalObligation,
                foirPercentage,
                tenureMonthsValue: tenureMonthsInput.value,
                roiValue: roiInput.value
            });

            // Don't set default values if empty
            // Let the user enter these values manually

            // Now parse the values
            const tenureMonths = getNumericValue(tenureMonthsInput, ' Months');
            const roi = getNumericValue(roiInput, '%');

            console.log('Parsed values:', { tenureMonths, roi });

            // Additional validation for essential values
            if (!foirPercentage || foirPercentage <= 0 || !tenureMonths || !roi) {
                // Clear the result if any essential value is invalid
                const foirEligibilityResult = document.getElementById('foirEligibilityResult');
                if (foirEligibilityResult) {
                    foirEligibilityResult.innerHTML = '';
                }
                console.log('Missing or invalid essential values');
                return 0;
            }

            // Calculate monthly EMI can pay
            const emiCanPayFOIR = (totalIncome * foirPercentage) / 100;
            const monthlyEmiCanPay = Math.max(0, emiCanPayFOIR - totalObligation);

            // Update Monthly EMI Can Pay field
            const monthlyEmiCanPayElement = document.getElementById('monthlyEmiCanPay');
            if (monthlyEmiCanPayElement) {
                monthlyEmiCanPayElement.value = formatCurrencyWithCommas(Math.round(monthlyEmiCanPay));
            }

            // Calculate loan eligibility based on FOIR
            const monthlyRate = roi / 1200;
            let loanAmountFOIR = 0;

            if (monthlyRate === 0) {
                loanAmountFOIR = monthlyEmiCanPay * tenureMonths;
            } else {
                const powerTerm = Math.pow(1 + monthlyRate, tenureMonths);
                if (powerTerm !== 1) {
                    loanAmountFOIR = (monthlyEmiCanPay * (powerTerm - 1)) / (monthlyRate * powerTerm);
                } else {
                    loanAmountFOIR = monthlyEmiCanPay * tenureMonths;
                }
            }

            if (isNaN(loanAmountFOIR) || !isFinite(loanAmountFOIR)) loanAmountFOIR = 0;

            // Display result in FOIR section
            const foirEligibilityResult = document.getElementById('foirEligibilityResult');
            if (foirEligibilityResult) {
                foirEligibilityResult.innerHTML = `
                    <div style="text-align: center; margin-top: 20px;">
                        <div style="font-size: 32px; font-weight: bold; color: #FFFFFF; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);">${formatCurrencyWithCommas(loanAmountFOIR)}</div>
                    </div>
                `;
            }

            // Check if there's a shortfall between BT POS and FOIR eligibility
            checkEligibilityShortfall(loanAmountFOIR);

            return loanAmountFOIR;
        }

        // Calculate eligibility based on multiplier
        function calculateEligibilityMultiplier() {
            const totalIncomeInput = document.getElementById('eligibilityTotalIncome');
            const totalObligationInput = document.getElementById('eligibilityTotalObligation');
            const multiplierInput = document.getElementById('multiplierValue');

            if (!totalIncomeInput || !totalObligationInput || !multiplierInput) {
                console.log('Missing required elements for multiplier calculation');
                return 0;
            }

            const totalIncome = parseCurrency(totalIncomeInput.value);
            const totalObligation = parseCurrency(totalObligationInput.value);

            console.log('Multiplier Calculation Inputs:', {
                totalIncome,
                totalObligation,
                multiplierValue: multiplierInput.value
            });

            // Don't set default multiplier if empty
            // Let the user enter this value manually

            const multiplier = parseInt(multiplierInput.value);

            // Validate multiplier range and check if it's empty
            if (!multiplier || multiplier > 35) {
                const multiplierEligibilityResult = document.getElementById('multiplierEligibilityResult');
                if (multiplierEligibilityResult) {
                    multiplierEligibilityResult.innerHTML = '';
                }
                if (!multiplier) {
                    console.log('Missing multiplier value');
                } else {
                    console.log('Multiplier too high (> 35)');
                }
                return 0;
            }

            const result = Math.max(0, (totalIncome || 0) - (totalObligation || 0)) * multiplier;

            const multiplierEligibilityResult = document.getElementById('multiplierEligibilityResult');
            if (multiplierEligibilityResult) {
                multiplierEligibilityResult.innerHTML = `
                    <div style="text-align: center; margin-top: 20px;">
                        <div style="font-size: 32px; font-weight: bold; color: #FFFFFF; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);">${formatCurrencyWithCommas(result)}</div>
                    </div>
                `;
            }

            return result;
        }

        // Check if there's a shortfall between BT POS and FOIR eligibility
        function checkEligibilityShortfall(foirEligibility) {
            const totalBtPosInput = document.getElementById('eligibilityTotalBtPos');
            const shortfallContainer = document.getElementById('eligibilityShortfallContainer');

            if (!totalBtPosInput || !shortfallContainer) {
                console.log('Missing elements for shortfall check');
                return;
            }

            const totalBtPos = parseCurrency(totalBtPosInput.value);

            // Don't show any message if TOTAL BT POS is empty
            if (totalBtPos <= 0 || totalBtPosInput.value.trim() === '') {
                shortfallContainer.innerHTML = '';
                shortfallContainer.style.display = 'none';
                return;
            }

            // Show shortfall message if BT POS is greater than FOIR eligibility
            if (foirEligibility > 0 && totalBtPos > foirEligibility) {
                const shortfallAmount = totalBtPos - foirEligibility;

                shortfallContainer.innerHTML = `
                    <div style="
                        background: #FF0000;
                        border-radius: 12px;
                        padding: 10px;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                        width: 100%;
                        box-sizing: border-box;
                        position: relative;
                        overflow: hidden;
                    ">
                        <h3 style="
                            color: #ffffff;
                            margin-top: 0;
                            margin-bottom: 8px;
                            text-align: center;
                            font-size: 1.6rem;
                            font-weight: 800;
                        ">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i>Balance Transfer Not Possible
                        </h3>

                        <div style="
                            color: #ffffff;
                            font-size: 1.3rem;
                            font-weight: 700;
                            text-align: center;
                            margin-bottom: 10px;
                        ">
                            There is a shortfall of
                            <span style="
                                font-weight: 900;
                                font-size: 1.6rem;
                                color: #ffffff;
                                display: inline-block;
                                padding: 2px 8px;
                                margin: 0 5px;
                                background: rgba(0, 0, 0, 0.2);
                                border-radius: 6px;
                            ">${formatCurrencyWithCommas(shortfallAmount)}</span>
                        </div>

                        <div style="
                            background: rgba(255, 255, 255, 0.1);
                            border-radius: 8px;
                            padding: 8px;
                            margin-bottom: 5px;
                        ">
                            <p style="
                                margin: 0 0 6px 0;
                                color: #ffffff;
                                font-weight: 700;
                                font-size: 1.1rem;
                            ">These are the following things you can do to increase the eligibility:</p>

                            <div style="
                                margin: 0;
                                padding-left: 10px;
                                color: #ffffff;
                                font-weight: 700;
                                font-size: 0.95rem;
                                line-height: 1.2;
                            ">
                                <h3 style="margin-top: 10px; margin-bottom: 5px; font-size: 1.1rem;">1. Increase Customer Income:</h3>
                                <ul style="list-style-type: disc; padding-left: 25px; margin-top: 5px; margin-bottom: 10px;">
                                    <li style="margin-bottom: 3px;">Ask: Is your partner working? Are they salaried?</li>
                                    <li style="margin-bottom: 3px;">Ask: Do you get a bonus from your company?</li>
                                    <li style="margin-bottom: 3px;">Ask: Do you have other income, like rent or anything else?</li>
                                </ul>

                                <h3 style="margin-top: 10px; margin-bottom: 5px; font-size: 1.1rem;">2. Check Closed Loans:</h3>
                                <ul style="list-style-type: disc; padding-left: 25px; margin-top: 5px; margin-bottom: 10px;">
                                    <li style="margin-bottom: 3px;">Check if any customer loan is closed or if they plan to close it. Subtract that loan EMI to increase loan eligibility.</li>
                                </ul>

                                <h3 style="margin-top: 10px; margin-bottom: 5px; font-size: 1.1rem;">3. Check Joint Loans or EMIs Paid by Others:</h3>
                                <ul style="list-style-type: disc; padding-left: 25px; margin-top: 5px; margin-bottom: 10px;">
                                    <li style="margin-bottom: 3px;">Co-pay Option: If the partner pays half the loan EMI, the customer's EMI obligation is cut in half. Needs partner's income proof and bank proof of EMI deduction.</li>
                                    <li style="margin-bottom: 3px;">No-pay Option: If the partner pays the full loan EMI, the customer has no EMI obligation. Needs loan sanction letter (partner as main applicant, customer as co-applicant), partner's income proof, and bank proof of EMI deduction.</li>
                                </ul>

                                <h3 style="margin-top: 10px; margin-bottom: 5px; font-size: 1.1rem;">4. Increase Loan Tenure:</h3>
                                <ul style="list-style-type: disc; padding-left: 25px; margin-top: 5px; margin-bottom: 10px;">
                                    <li style="margin-bottom: 3px;">Extend loan tenure to increase eligibility, up to 7 years. Confirm with the manager which bank allows 7-year loans.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                shortfallContainer.style.display = 'block';
            }
            // Show congratulations message if FOIR eligibility is equal to or greater than BT POS
            else if (foirEligibility > 0 && totalBtPos > 0 && foirEligibility >= totalBtPos) {
                shortfallContainer.innerHTML = `
                    <div style="
                        background: #00CC00;
                        border-radius: 12px;
                        padding: 15px;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                        width: 100%;
                        box-sizing: border-box;
                        position: relative;
                        overflow: hidden;
                    ">
                        <h3 style="
                            color: #ffffff;
                            margin-top: 0;
                            margin-bottom: 10px;
                            text-align: center;
                            font-size: 1.8rem;
                            font-weight: 800;
                        ">
                            <i class="fas fa-check-circle" style="margin-right: 10px;"></i>Congratulations!
                        </h3>

                        <div style="
                            color: #ffffff;
                            font-size: 1.4rem;
                            font-weight: 600;
                            text-align: center;
                        ">
                            Balance Transfer is Eligible
                        </div>
                    </div>
                `;
                shortfallContainer.style.display = 'block';
            } else {
                shortfallContainer.innerHTML = '';
                shortfallContainer.style.display = 'none';
            }
        }

        // Calculate eligibility automatically
        function calculateEligibility() {
            // Get input elements
            const totalIncomeInput = document.getElementById('eligibilityTotalIncome');
            const foirPercentageInput = document.getElementById('foirPercentage');
            const tenureMonthsInput = document.getElementById('eligibilityTenureMonths');
            const roiInput = document.getElementById('eligibilityRoi');

            if (!totalIncomeInput || !foirPercentageInput || !tenureMonthsInput || !roiInput) {
                console.log('Missing required elements for eligibility calculation');
                return;
            }

            // Ensure eligibility total obligation is updated from main total obligation
            const mainTotalObligation = document.getElementById('totalObligation');
            const eligibilityTotalObligation = document.getElementById('eligibilityTotalObligation');
            if (mainTotalObligation && eligibilityTotalObligation) {
                eligibilityTotalObligation.value = mainTotalObligation.value;
            }

            // Ensure eligibility total BT POS is updated from main total BT POS
            const mainTotalBtPos = document.getElementById('totalBtPos');
            const eligibilityTotalBtPos = document.getElementById('eligibilityTotalBtPos');
            if (mainTotalBtPos && eligibilityTotalBtPos) {
                eligibilityTotalBtPos.value = mainTotalBtPos.value;
            }

            console.log('Calculate Eligibility - Input Values:', {
                totalIncome: totalIncomeInput.value,
                foirPercentage: foirPercentageInput.value,
                tenureMonths: tenureMonthsInput.value,
                roi: roiInput.value,
                totalObligation: eligibilityTotalObligation ? eligibilityTotalObligation.value : 'N/A',
                totalBtPos: eligibilityTotalBtPos ? eligibilityTotalBtPos.value : 'N/A'
            });

            // Don't set default values if empty
            // Let the user enter these values manually

            // Now parse all values
            const totalIncome = parseCurrency(totalIncomeInput.value);
            const foirPercentage = getNumericValue(foirPercentageInput, '%');
            const tenureMonths = getNumericValue(tenureMonthsInput, ' Months');
            const roi = getNumericValue(roiInput, '%');

            console.log('Calculate Eligibility - Parsed Values:', {
                totalIncome,
                foirPercentage,
                tenureMonths,
                roi
            });

            // Additional validation for parsed values
            if (!totalIncome || !foirPercentage || !tenureMonths || !roi) {
                // Clear results if essential values are invalid
                const foirEligibilityResult = document.getElementById('foirEligibilityResult');
                const finalEligibilityResult = document.getElementById('finalEligibilityResult');

                if (foirEligibilityResult) {
                    foirEligibilityResult.innerHTML = '';
                }

                if (finalEligibilityResult) {
                    finalEligibilityResult.innerHTML = '';
                }

                console.log('Missing essential values for calculation');
                return;
            }

            // Calculate eligibility based on FOIR
            const foirEligibility = calculateEligibilityFOIR();

            // Calculate eligibility based on multiplier
            const multiplierEligibility = calculateEligibilityMultiplier();

            // Display summary in the final eligibility result section
            const finalEligibilityResult = document.getElementById('finalEligibilityResult');
            if (!finalEligibilityResult) return;

            if (foirEligibility > 0 || multiplierEligibility > 0) {
                let summaryHTML = '<div style="padding: 10px;">';

                if (foirEligibility > 0 && multiplierEligibility > 0) {
                    const lowerAmount = Math.min(foirEligibility, multiplierEligibility);
                    summaryHTML += `
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center;">
                            Final Loan Eligibility (Lower of FOIR and Multiplier):
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: #27ae60; text-align: center; margin-bottom: 15px;">
                            ${formatCurrencyWithCommas(lowerAmount)}
                        </div>
                    `;
                } else if (foirEligibility > 0) {
                    summaryHTML += `
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center;">
                            Loan Eligibility as per FOIR:
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: #27ae60; text-align: center; margin-bottom: 15px;">
                            ${formatCurrencyWithCommas(foirEligibility)}
                        </div>
                    `;
                } else if (multiplierEligibility > 0) {
                    summaryHTML += `
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center;">
                            Loan Eligibility as per Multiplier:
                        </div>
                        <div style="font-size: 28px; font-weight: bold; color: #27ae60; text-align: center; margin-bottom: 15px;">
                            ${formatCurrencyWithCommas(multiplierEligibility)}
                        </div>
                    `;
                }

                summaryHTML += '</div>';
                finalEligibilityResult.innerHTML = summaryHTML;
            } else {
                finalEligibilityResult.innerHTML = '';
            }
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Bonus Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add SheetJS for Excel export/import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Color variables with pure black backgrounds */
            --bg-dark: #000000; /* Pure black */
            --card-dark: #000000; /* Pure black */
            --text-light: #ffffff; /* Pure white */
            --text-medium: #ffffff; /* Pure white */
            --text-dark: #000000;
            --primary: #00ff7f; /* Mint Green */
            --secondary: #8a2be2; /* Blue Violet */
            --editable-bg: #ffff00; /* Yellow background */
            --editable-text: #1b96ff; /* Blue text */
            --danger-text: #ff4081; /* Pinkish Red */
            --success-text: #00ff7f; /* Mint Green */
            --non-editable-bg: #000000; /* Pure black */
            --result-item-bg: #000000; /* Pure black */
            --shadow-glow: 0 8px 28px rgba(0, 255, 127, 0.3);
            --shadow-dark: 0 6px 15px rgba(0, 0, 0, 0.6);
            --border-color: rgba(0, 255, 127, 0.1);
            --input-border: rgba(255, 255, 255, 0.1);
            --input-focus-border: var(--primary);
            --input-focus-shadow: 0 0 15px rgba(0, 255, 127, 0.4);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #000000; /* Pure black background */
            color: var(--text-light);
            font-size: 16px;
            line-height: 1.4;
            padding: 10px;
            max-width: 1400px;
            margin: 5px auto;
            overflow-x: hidden;
            /* Remove background gradient */
            background-image: none;
            background-attachment: fixed;
        }

        /* Main layout container */
        .main-container {
            width: 100%;
            overflow: visible; /* Allow content to be visible */
            position: relative; /* For absolute positioning of Excel buttons */
        }

        /* Left column (main content) */
        .left-column {
            width: 100%; /* Take full width */
            overflow: visible; /* Allow content to be visible without scrolling */
            padding-top: 10px; /* Add space for the Excel buttons */
        }

        /* Calculator card base style - matching EMI calculator */
        .calculator-card-base {
            background: var(--card-dark);
            padding: 12px;
            border-radius: 14px;
            box-shadow: var(--shadow-glow);
            border: 1px solid var(--border-color);
            position: relative;
            margin-top: 6px;
        }

        /* Section title styling */
        .calculator-card-base h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin-top: 0;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(0, 255, 127, 0.5);
        }

        /* Input group styling */
        .calculator-card-base .input-group {
            margin-bottom: 8px;
            position: relative;
        }

        .calculator-card-base label {
            display: block;
            margin-bottom: 2px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Editable input styling - matching EMI calculator */
        .calculator-card-base input, .calculator-card-base select {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
            height: 28px;
        }

        .calculator-card-base input:not([readonly]), .calculator-card-base select {
            background: var(--editable-bg);
            color: #000000; /* Black text for better visibility */
            border-color: var(--primary);
            font-weight: 700;
            font-size: 0.9rem;
            height: 28px;
        }

        .calculator-card-base input:not([readonly]):focus, .calculator-card-base select:focus {
            border-color: var(--secondary);
            box-shadow: var(--input-focus-shadow);
            outline: none;
        }

        /* Readonly input styling - matching EMI calculator */
        .calculator-card-base input[readonly] {
            background: var(--non-editable-bg);
            color: var(--text-light);
            border: 1px solid rgba(0, 255, 127, 0.2);
            cursor: not-allowed;
            font-weight: 600;
            text-shadow: 0 0 5px rgba(0, 255, 127, 0.5);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 0 5px rgba(0, 255, 127, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 24px; /* Smaller height for readonly fields */
            padding: 3px 8px;
        }

        /* Ensure specific input colors override the readonly styling */
        #totalObligation[readonly], #eligibilityTotalObligation[readonly] {
            color: #FFFF00 !important; /* Bright yellow text color */
        }

        #totalBtPos[readonly], #eligibilityTotalBtPos[readonly] {
            color: #00FF00 !important; /* Bright green text color */
        }

        .calculator-card-base input[readonly]:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4), inset 0 0 8px rgba(0, 255, 127, 0.3);
        }

        /* Button styling - matching EMI calculator */
        .calculator-card-base button {
            background: var(--primary);
            color: #000;
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-glow);
            position: relative;
            margin: 2px;
            height: 28px;
        }

        .calculator-card-base button:hover {
            background: #33ff99;
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 6px 15px rgba(0, 255, 127, 0.5);
        }

        /* Results styling - matching EMI calculator */
        .calculator-card-base .results {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 127, 0.1);
        }

        .calculator-card-base .result-item {
            margin: 8px 0;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--result-item-bg);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        /* Specific style for result labels to prevent wrapping */
        .calculator-card-base .result-label {
            white-space: nowrap;
            margin-right: 10px; /* Add space between label and value */
            flex-shrink: 0; /* Prevent label from shrinking */
            color: var(--text-light); /* Ensure label text color */
            font-weight: 500; /* Match surrounding text */
        }

        .calculator-card-base .result-value {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
            margin-left: auto; /* Push value to the right */
            text-align: right;
        }

        /* Eligibility section styling - matching EMI calculator */
        .eligibility-section {
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 127, 0.1);
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
        }

        .eligibility-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            width: 100%;
        }

        .eligibility-stacked-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            width: 100%;
        }

        .eligibility-category-container {
            display: flex;
            flex-direction: column;
            width: 85%;
            margin-right: 10px;
        }

        .eligibility-foir-container {
            display: flex;
            flex-direction: column;
            width: 15%;
        }

        .eligibility-three-columns {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            width: 100%;
            align-items: flex-end;
        }

        .eligibility-column {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .eligibility-column:nth-child(1) {
            width: 34%;
        }

        .eligibility-column:nth-child(2) {
            width: 34%;
        }

        .eligibility-column:nth-child(3) {
            width: 25%;
        }

        .eligibility-label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
        }

        .eligibility-column .eligibility-label {
            white-space: nowrap;
            text-align: center;
            margin-bottom: 5px;
        }

        .eligibility-row > .eligibility-label {
            width: 40%;
            margin-right: 8px;
            margin-bottom: 0;
            padding-top: 5px; /* Align with input */
        }

        .eligibility-input-container {
            flex: 1;
            width: 100%;
        }

        .eligibility-row > .eligibility-input-container {
            width: 60%;
        }

        .eligibility-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            color: #000000; /* Black text for better visibility */
            background: var(--editable-bg);
            text-align: left;
            box-sizing: border-box;
            transition: all 0.3s ease;
            height: 36px;
        }

        /* Override for specific eligibility inputs */
        #eligibilityTotalObligation.eligibility-input {
            color: #FFFF00 !important; /* Bright yellow text color */
        }

        #eligibilityTotalBtPos.eligibility-input {
            color: #00FF00 !important; /* Bright green text color */
        }

        /* Larger font size for specific input fields */
        #eligibilityTotalIncome, #foirPercentage,
        #eligibilityTotalObligation, #monthlyEmiCanPay,
        #eligibilityTenureYears, #eligibilityTotalBtPos,
        #totalBtPos, #totalObligation {
            font-size: 1.5rem !important; /* 1.5x larger font */
            font-weight: 900 !important; /* Extra bold text */
        }

        /* Custom text color for specific input fields */
        #totalObligation, #eligibilityTotalObligation {
            color: #FFFF00 !important; /* Bright yellow text color */
        }

        #totalBtPos, #eligibilityTotalBtPos {
            color: #00FF00 !important; /* Bright green text color */
        }

        .eligibility-input:focus {
            border-color: var(--secondary);
            box-shadow: var(--input-focus-shadow);
            outline: none;
        }

        .foir-input {
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: center;
            font-size: 1rem;
            font-weight: 700;
            background: var(--non-editable-bg);
            color: var(--text-light);
            border: 1px solid rgba(0, 255, 127, 0.2);
            border-radius: 8px;
            margin: 0 auto;
            display: inline-block;
            padding: 8px 5px;
            height: 30px;
            text-shadow: 0 0 5px rgba(0, 255, 127, 0.5);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 0 5px rgba(0, 255, 127, 0.2);
        }

        .foir-toggle-btn {
            margin-left: 8px;
            padding: 6px 12px;
            background: var(--secondary);
            color: var(--text-light);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            vertical-align: middle;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            height: 30px;
        }

        .foir-toggle-btn.active {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 127, 0.6);
        }

        .foir-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(138, 43, 226, 0.4);
        }

        .foir-options {
            margin-top: 5px;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 5px;
            width: 100%;
            overflow-x: auto;
        }

        .foir-options button {
            padding: 6px 12px;
            background: var(--editable-bg); /* Yellow background */
            color: var(--text-dark); /* Black text */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            flex: 0 0 auto;
            min-width: 50px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            height: 30px;
        }

        .foir-options button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(138, 43, 226, 0.4);
        }

        .foir-options button.active {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 10px rgba(0, 255, 127, 0.6);
        }

        .custom-foir-input {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
            flex-direction: row;
        }

        .custom-foir-input input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            background: var(--editable-bg);
            color: #000000; /* Black text for better visibility */
            text-align: center;
            transition: all 0.3s ease;
            height: 30px;
        }

        .custom-foir-input input:focus {
            border-color: var(--secondary);
            box-shadow: var(--input-focus-shadow);
            outline: none;
        }

        .custom-foir-input button {
            padding: 6px 12px;
            background: var(--editable-bg); /* Yellow background */
            color: var(--text-dark); /* Black text */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: var(--shadow-glow);
            transition: all 0.3s ease;
            height: 30px;
        }

        .custom-foir-input button:hover {
            background: #ffff33; /* Slightly brighter yellow */
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 36px rgba(255, 255, 0, 0.5);
        }

        .tenure-months-input {
            text-align: left;
            font-size: 1rem;
            font-weight: 700;
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background: var(--editable-bg);
            color: #000000; /* Black text for better visibility */
            transition: all 0.3s ease;
            height: 36px;
            width: 100%;
            box-sizing: border-box;
        }

        .tenure-months-input:focus {
            border-color: var(--secondary);
            box-shadow: var(--input-focus-shadow);
            outline: none;
        }

        .tenure-years-input {
            text-align: left;
            font-size: 1rem;
            font-weight: 600;
            padding: 8px 12px;
            background: var(--non-editable-bg);
            color: var(--text-light);
            border: 1px solid rgba(0, 255, 127, 0.2);
            border-radius: 8px;
            text-shadow: 0 0 5px rgba(0, 255, 127, 0.5);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 0 5px rgba(0, 255, 127, 0.2);
            height: 30px;
            width: 100%;
            box-sizing: border-box;
        }

        .roi-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .roi-input-elig {
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: left;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 14px 18px;
            padding-right: 30px;
            border: 1px solid var(--input-border);
            border-radius: 10px;
            background: var(--editable-bg);
            color: var(--editable-text);
            transition: all 0.3s ease;
        }

        .roi-input-elig:focus {
            border-color: var(--secondary);
            box-shadow: var(--input-focus-shadow);
            outline: none;
        }

        .roi-percent {
            position: absolute;
            right: 15px;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--editable-text);
            pointer-events: none;
        }

        .eligibility-calculate-btn {
            width: 100%;
            padding: 14px 25px;
            margin-top: 30px;
            background: var(--primary);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            box-shadow: var(--shadow-glow);
            transition: all 0.3s ease;
        }

        .eligibility-calculate-btn:hover {
            background: #33ff99;
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 36px rgba(0, 255, 127, 0.5);
        }

        .eligibility-select {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid var(--input-border);
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--editable-text);
            background: var(--editable-bg);
            cursor: pointer;
            box-sizing: border-box;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23f0f0f0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 20px center;
            padding-right: 45px;
            transition: all 0.3s ease;
        }

        .eligibility-select:focus {
            border-color: var(--secondary);
            box-shadow: var(--input-focus-shadow);
            outline: none;
        }

        .eligibility-select option {
            background: var(--card-dark);
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 600;
        }

        .eligibility-input-group {
            margin-bottom: 15px;
        }

        .eligibility-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .eligibility-result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .eligibility-result h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #ccc;
        }

        .result-label {
            font-weight: bold;
        }

        .result-value {
            color: #2980b9;
            font-weight: bold;
        }

        .calculate-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        .calculate-btn:hover {
            background-color: #2980b9;
        }

        .header-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .header-section label {
            display: flex;
            flex-direction: column;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .header-section input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        h2.section-title {
            margin-top: 30px;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 1.75rem;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 255, 127, 0.5);
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Add more space between sections */
        h2.section-title + div + div + div + h2.section-title {
            margin-top: 40px; /* Adjusted margin for the second section title */
        }

        /* Style for readonly inputs */
        input[readonly].eligibility-input {
            background-color: #f5f5f5;
            color: #000;
            font-weight: bold;
        }

        /* Override for specific eligibility inputs */
        #eligibilityTotalObligation[readonly].eligibility-input {
            color: #FFFF00 !important; /* Bright yellow text color */
        }

        #eligibilityTotalBtPos[readonly].eligibility-input {
            color: #00FF00 !important; /* Bright green text color */
        }

        /* Excel controls styling - matching EMI calculator */
        .excel-controls {
            display: flex;
            gap: 8px;
            margin: 5px 0;
            flex-wrap: wrap;
            justify-content: flex-end;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        .excel-btn {
            background: var(--primary);
            color: #000;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-glow);
            position: relative;
            display: flex;
            align-items: center;
            gap: 5px;
            height: 28px;
        }

        .download-btn {
            background: var(--primary);
            color: #000;
        }

        .upload-btn {
            background: var(--secondary);
            color: var(--text-light);
        }

        .test-btn {
            background: var(--danger-text);
            color: var(--text-light);
        }

        .excel-btn:hover {
            background: #33ff99;
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 6px 15px rgba(0, 255, 127, 0.5);
        }

        .upload-btn:hover {
            background: #a13ffc;
            box-shadow: 0 6px 12px rgba(138, 43, 226, 0.4);
        }

        .test-btn:hover {
            background: #ff6b9d;
            box-shadow: 0 6px 12px rgba(255, 64, 129, 0.4);
        }

        /* Summary fields container - matching EMI calculator */
        .summary-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .summary-field {
            flex: 1;
            min-width: 200px;
        }

        /* Styled readonly inputs - matching EMI calculator */
        .summary-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--editable-bg);
            border: 1px solid var(--primary);
            border-radius: 8px;
            color: var(--editable-text);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .summary-input:hover {
            box-shadow: var(--input-focus-shadow);
            transform: translateY(-1px);
        }

        .bt-input .summary-input {
            background-color: rgba(0, 255, 127, 0.1) !important;
            color: var(--success-text) !important;
            border-color: var(--success-text) !important;
        }

        .obligation-input .summary-input {
            background-color: rgba(255, 255, 0, 0.1) !important;
            color: #FFFF00 !important;
            border-color: #FFFF00 !important;
        }

        /* Information icon styling */
        .label-with-info {
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
            justify-content: space-between; /* Ensure proper spacing */
            width: 100%; /* Take full width */
        }

        .info-icon-wrapper {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 5px; /* Add some spacing */
            width: 18px; /* Fixed width */
            height: 18px; /* Fixed height */
            border-radius: 50%; /* Make it circular */
            background-color: #1589EE; /* Salesforce blue background */
        }

        .info-icon {
            color: #FFFFFF; /* White icon */
            font-size: 0.8rem; /* Slightly smaller */
            transition: all 0.3s ease;
        }

        .info-icon-wrapper:hover .info-icon {
            color: #FFFFFF;
            transform: scale(1.2);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        /* Special styling for table headers with info icon */
        th.label-with-info {
            position: relative;
            padding-right: 25px; /* Make room for the icon */
            background-color: #000000 !important; /* Pure black background */
            color: #1589EE !important; /* Salesforce blue text */
            text-align: center !important; /* Center align text */
        }

        th.label-with-info span {
            display: inline-block; /* Allow margin to be applied */
        }

        th.label-with-info .info-icon-wrapper {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Popup styling */
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-dark);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
            border: 1px solid var(--primary);
        }

        .popup.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .popup h2 {
            color: var(--primary);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5rem;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 255, 127, 0.3);
        }

        .popup p {
            color: var(--text-light);
            margin-bottom: 15px;
            font-size: 1rem;
            line-height: 1.5;
        }

        .popup ul {
            color: var(--text-light);
            margin-bottom: 15px;
            padding-left: 20px;
        }

        .popup li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .popup strong {
            color: var(--primary);
            font-weight: 700;
        }

        .popup-close-btn {
            display: block;
            margin: 15px auto 0;
            padding: 8px 20px;
            background: var(--primary);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .popup-close-btn:hover {
            background: #33ff99;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 127, 0.5);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Table styling - redesigned with no height restriction */
        .table-container {
            max-height: none !important; /* Remove height restriction */
            overflow-y: visible;
            overflow-x: auto;
            position: relative;
            border-radius: 0;
            padding: 0;
            margin: 0;
            background: transparent;
            box-shadow: none;
        }

        table {
            width: 100%;
            min-width: 1200px; /* Increased minimum width */
            border-collapse: collapse;
            border-spacing: 0;
            font-size: 0.85rem;
            color: #000000;
            table-layout: fixed;
            border: 1px solid #000000;
        }

        th {
            background: #FFFF00; /* Yellow header background */
            color: #000;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 3px 2px; /* Reduced padding */
            text-align: left;
            box-shadow: none;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            border: 1px solid #000000;
            height: 22px; /* Fixed height */
        }

        td {
            padding: 2px 2px; /* Reduced padding */
            text-align: left;
            border: 1px solid #000000;
            background-color: #ffffff;
            color: #000000;
            height: 24px; /* Fixed height */
        }

        tr:hover td {
            background-color: #f5f5f5;
        }

        /* Table inputs */
        .number-input, .product-display, .bank-display {
            width: 100%;
            padding: 3px 5px;
            background: var(--editable-bg);
            border: 1px solid rgba(0, 255, 127, 0.2);
            border-radius: 4px;
            color: #000000; /* Black text for better visibility */
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: 'Poppins', Arial, sans-serif;
            height: 20px;
            box-sizing: border-box;
        }

        /* Action select has its own styling */
        .action-select {
            width: 100%;
            padding: 3px 5px;
            background: #FFFFFF; /* White background by default */
            border: 1px solid #ccc; /* Light gray border */
            border-radius: 4px; /* Rounded corners */
            color: #000000; /* Black text */
            font-size: 12px; /* Adjusted font size for better visibility */
            font-weight: 700;
            transition: none;
            font-family: inherit;
            min-width: 100px; /* Ensure minimum width */
            height: 24px; /* Match number input height */
            -webkit-appearance: none; /* Remove default styling */
            -moz-appearance: none; /* Remove default styling */
            appearance: none; /* Remove default styling */
            text-align: left; /* Left align the text */
            text-transform: none; /* No text transformation */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="4"><path d="M0 0h8L4 4z" fill="%23000000"/></svg>');
            background-repeat: no-repeat;
            background-position: right 4px center;
        }

        /* Fix for select option text visibility */
        .action-select option {
            background-color: white;
            color: black;
            font-weight: 700;
            font-size: 12px;
            text-align: left;
            text-transform: none;
        }

        /* Special styling for BT option */
        .action-select option[value="BT"] {
            background-color: #4CD964;
            color: black;
        }

        /* Special styling for Obligate option */
        .action-select option[value="Obligate"] {
            background-color: #FFFF00;
            color: black;
        }

        /* Special styling for CO-PAY option */
        .action-select option[value="CO-PAY"] {
            background-color: #FFA500;
            color: black;
        }

        /* Special styling for NO-PAY option */
        .action-select option[value="NO-PAY"] {
            background-color: #0080FF;
            color: black;
        }

        /* Special styling for Closed option */
        .action-select option[value="Closed"] {
            background-color: #FF0000;
            color: black;
        }

        /* Custom styling to show the selected text */
        .action-select {
            position: relative;
            color: #000000 !important; /* Make text black and visible */
        }

        /* We're not using the ::before pseudo-element anymore since we're showing the actual select text */
        .action-select option {
            color: #000000 !important; /* Ensure options are also black */
            font-weight: 700 !important;
            font-size: 12px !important;
            text-align: left !important;
            text-transform: none !important;
        }

        .number-input:focus, .product-display:focus, .bank-display:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--input-focus-shadow);
        }

        .action-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 255, 127, 0.5);
        }

        /* Additional action select properties */
        .action-select {
            cursor: pointer;
        }

        /* Delete button */
        .delete-btn {
            background: transparent;
            color: var(--danger-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 12px;
            font-size: 1rem;
        }

        .delete-btn:hover {
            background: rgba(255, 77, 77, 0.1);
            transform: scale(1.1);
        }

        /* BT and Obligate styling - matching screenshot */
        tr.bt-row td, tr.green-row td {
            background-color: #4CD964; /* Green color from screenshot */
        }

        tr.bt-row:hover td, tr.green-row:hover td {
            background-color: #3cb853; /* Slightly darker green on hover */
        }

        tr.obligate-row td, tr.orange-row td {
            background-color: #FFFF00; /* Yellow color */
        }

        tr.obligate-row:hover td, tr.orange-row:hover td {
            background-color: #e6e600; /* Slightly darker yellow on hover */
        }

        tr.red-row td {
            background-color: #ffcccc; /* Light red */
        }

        tr.red-row:hover td {
            background-color: #ffb3b3; /* Slightly darker light red on hover */
        }

        /* Add row button styling - centered at bottom of wrapper */
        .add-row-btn {
            background: #FFFFFF; /* White background */
            color: #000;
            padding: 8px 15px;
            border: 1px solid #000000; /* Black border */
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            width: 100%;
            text-align: center;
        }

        .add-row-btn:hover {
            background: #f0f0f0; /* Light gray on hover */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .bt-obligation-container input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* Obligations section - contains table and button in separate divs */
        .obligations-section {
            display: flex;
            flex-direction: column;
            min-height: 200px;
            border: 1px solid #333;
            background-color: #000;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Table container with proper overflow handling */
        .table-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: visible; /* Allow vertical content to be visible */
            background-color: #000000 !important; /* Black background */
            display: block; /* Ensure it's a block element */
            max-height: none !important; /* Remove any max-height restrictions */
        }

        table {
            width: 100%;
            border-collapse: collapse; /* Changed to collapse for proper borders */
            border-spacing: 0;
            table-layout: fixed; /* Fixed layout for better control of column widths */
            border: 2px solid #FFFFFF; /* White border */
            background-color: #000000 !important; /* Black background */
        }

        th, td {
            border: none;
            padding: 8px 6px; /* Increased padding for better spacing */
            text-align: left;
            overflow: visible; /* Allow overflow for numbers */
            font-size: 13px; /* Smaller font */
            vertical-align: middle; /* Center content vertically */
            font-weight: bold;
            background-color: #000000 !important; /* Black background for all cells */
            color: #FFFFFF; /* White text for better visibility */
            position: relative; /* For absolute positioning of content */
            border-bottom: 1px solid #333333; /* Dark border between rows */
        }

        th {
            background-color: #000000 !important; /* Black background for headers */
            color: #1589EE !important; /* Salesforce blue text */
            font-weight: 800; /* Extra bold */
            font-size: 14px; /* Slightly larger font size */
            text-transform: uppercase;
            padding: 10px 6px; /* Increased padding for headers */
            border-bottom: none;
            white-space: nowrap; /* Prevent header text from wrapping */
            letter-spacing: 0.5px; /* Better letter spacing for readability */
            text-shadow: 0 0 2px rgba(21, 137, 238, 0.3); /* Subtle glow effect */
            text-align: center !important; /* Center align all headers */
        }

        /* Column width adjustments to match screenshot */
        #obligationsTable th:nth-child(1), #obligationsTable td:nth-child(1) { width: 1%; padding-left: 1px; padding-right: 1px; text-align: center; border-right: 2px solid #FFFFFF; } /* Row number - reduced by half */
        #obligationsTable th:nth-child(2), #obligationsTable td:nth-child(2) { width: 24.7%; border-right: 2px solid #FFFFFF; } /* PRODUCT - adjusted width */
        #obligationsTable th:nth-child(3), #obligationsTable td:nth-child(3) { width: 20%; border-right: 2px solid #FFFFFF; } /* BANK NAME - slightly reduced */
        #obligationsTable th:nth-child(4), #obligationsTable td:nth-child(4) { width: 6.3%; min-width: 52px; border-right: 2px solid #FFFFFF; } /* TENURE - reduced by 55% total */
        #obligationsTable th:nth-child(5), #obligationsTable td:nth-child(5) { width: 6%; border-right: 2px solid #FFFFFF; } /* ROI % - increased width */
        #obligationsTable th:nth-child(6), #obligationsTable td:nth-child(6) { width: 12%; border-right: 2px solid #FFFFFF; } /* TOTAL LOAN AMOUNT */
        #obligationsTable th:nth-child(7), #obligationsTable td:nth-child(7) { width: 11.5%; border-right: 2px solid #FFFFFF; } /* OUTSTANDING - increased width */
        #obligationsTable th:nth-child(8), #obligationsTable td:nth-child(8) { width: 11.5%; border-right: 2px solid #FFFFFF; } /* EMI AMOUNT - increased width */
        #obligationsTable th:nth-child(9), #obligationsTable td:nth-child(9) { width: 8%; border-right: 2px solid #FFFFFF; } /* ACTIONS - increased width */
        #obligationsTable th:nth-child(10), #obligationsTable td:nth-child(10) { width: 1%; } /* Delete button column - reduced */

        /* Auto-resize font based on content length */
        .auto-resize-text {
            width: 100%;
            height: 100%;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            word-break: break-word;
            line-height: 1.2;
        }

        th {
            background-color: #000000 !important; /* Black background for headers */
            color: #1589EE !important; /* Salesforce blue text */
            font-weight: 800; /* Extra bold */
            font-size: 14px;
            text-transform: uppercase;
            padding: 12px 6px; /* Larger padding for headers */
            border-bottom: 2px solid #FFFFFF; /* White bottom border */
            text-shadow: 0 0 2px rgba(21, 137, 238, 0.3); /* Subtle glow effect */
            text-align: center !important; /* Center align all headers */
        }

        .actions-cell {
            white-space: nowrap;
        }

        .button-row {
            margin: 10px 0;
        }

        button {
            padding: 3px 6px;
            margin-right: 4px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-size: 11px;
        }

        .add-btn {
            background-color: #4CAF50;
        }

        .save-btn {
            background-color: #2196F3;
        }

        .delete-btn {
            background-color: #607d8b;
        }

        input[type="text"], select {
            width: 100%;
            padding: 4px 6px;
            box-sizing: border-box;
            font-weight: 700; /* Bold font */
            color: #000000; /* Dark black text */
            font-size: 14px; /* Appropriate font size */
            text-align: left; /* Align text to the left */
            border: 1px solid #000000; /* Black border */
            border-radius: 0; /* No rounded corners */
            height: auto; /* Auto height */
            background-color: #4CD964; /* Green background for the screenshot */
            box-shadow: none; /* No shadow */
        }

        /* Special styling for amount fields */
        input[type="text"].number-input {
            text-align: left;
            padding-left: 6px;
            font-size: 14px;
            border: 1px solid #000000; /* Black border */
            height: auto; /* Auto height */
            background-color: #4CD964; /* Green background for the screenshot */
            font-weight: 700; /* Bold font */
        }

        /* Make placeholder text dark black and left-aligned */
        ::placeholder {
            color: #000000 !important;
            opacity: 1 !important;
            font-weight: 700 !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            text-align: left !important;
        }

        ::-webkit-input-placeholder {
            text-align: left !important;
        }

        ::-moz-placeholder {
            text-align: left !important;
        }

        :-ms-input-placeholder {
            text-align: left !important;
        }

        :-moz-placeholder {
            text-align: left !important;
        }

        /* Ensure input text doesn't overflow */
        input[type="text"] {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        select {
            width: 100%;
            padding: 4px 6px;
            box-sizing: border-box;
            font-size: 14px;
            font-weight: 700;
            border: 1px solid #000000; /* Black border */
            border-radius: 0;
            height: auto;
            background-color: #4CD964; /* Green background for the screenshot */
            color: #000;
            box-shadow: none;
            appearance: menulist; /* Show dropdown arrow */
            background-image: none; /* Remove custom arrow */
            text-align: left; /* Left align text for consistency */
        }

        select option {
            background-color: #fff;
            color: #000;
            font-weight: 700;
            font-size: 14px;
        }

        /* Action select specific styling */
        .action-select {
            text-align: left; /* Left align text for consistency */
        }

        /* Auto-resize font for action select based on content length */
        .action-select.medium-length {
            font-size: 12px; /* Slightly smaller font for medium length */
        }

        .action-select.long-length {
            font-size: 11px; /* Smaller font for long values */
            letter-spacing: -0.3px; /* Slightly tighter letter spacing */
        }

        .action-select.very-long-length {
            font-size: 10px; /* Even smaller font for very long values */
            letter-spacing: -0.5px; /* Tighter letter spacing */
        }

        /* Custom select styling */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
            z-index: 1; /* Lower default z-index */
            height: 20px; /* Reduced height */
        }

        /* Increase z-index when dropdown is active */
        .custom-select-wrapper.active {
            z-index: 10000; /* Very high z-index when active */
        }

        .product-display {
            width: 100%;
            padding: 3px 8px;
            box-sizing: border-box;
            font-weight: 700;
            color: #000000;
            font-size: 16px; /* Increased default font size */
            background-color: #4CD964; /* Green background for the screenshot */
            border: 1px solid #000000; /* Black border */
            border-radius: 0;
            cursor: pointer;
            background-image: none;
            white-space: nowrap; /* Prevent text wrapping in input box */
            min-height: 20px; /* Minimum height */
            height: 24px; /* Fixed height */
            line-height: 1.2; /* Line height for better readability */
            resize: none; /* Disable textarea resizing */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            font-family: inherit; /* Use the same font as other inputs */
            display: block; /* Don't use -webkit-box which limits text */
            box-shadow: none;
            transition: none;
        }

        .product-display:hover {
            border-color: #999;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Auto-resize font for product display based on content length */
        .product-display.long-text {
            font-size: 14px; /* Reduce font size for long text */
            letter-spacing: -0.2px; /* Reduce letter spacing */
        }

        .product-display.very-long-text {
            font-size: 12px; /* Further reduce font size for very long text */
            letter-spacing: -0.3px; /* Further reduce letter spacing */
            word-spacing: -1px; /* Reduce word spacing */
        }

        .product-display:focus {
            outline: none;
            border-color: #4d90fe;
            box-shadow: 0 0 5px rgba(77, 144, 254, 0.5);
        }

        .custom-select-dropdown {
            position: fixed; /* Use fixed positioning for better control */
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 9999; /* Very high z-index to ensure visibility */
            display: none; /* Hidden by default */
            max-height: 210px; /* Limit height to fit 6-7 items plus search box */
            overflow: visible; /* Changed from hidden to visible */
            min-width: 180px; /* Minimum width */
            width: auto; /* Allow width to be set dynamically */
            flex-direction: column; /* Stack children vertically */
        }

        /* Style for dropdown when positioned above the input */
        .custom-select-dropdown.dropdown-above {
            box-shadow: 0 -4px 8px rgba(0,0,0,0.3);
        }

        /* Force dropdown to be visible when active */
        .custom-select-dropdown.active {
            display: flex !important; /* Use flex display for better control of children */
        }

        .search-container {
            padding: 4px;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 1001;
            height: 30px; /* Fixed height to match option height */
            box-sizing: content-box; /* Ensure padding is added to height */
            flex: 0 0 auto; /* Don't grow or shrink, use auto basis */
            order: 1; /* Place search box before options by default */
        }

        /* Adjust search container position for dropdowns shown above */
        .dropdown-above .search-container {
            border-bottom: none;
            border-top: 1px solid #eee;
            position: sticky;
            top: 0; /* Keep at top of dropdown */
            bottom: auto;
            height: 30px; /* Fixed height to match option height */
            box-sizing: content-box; /* Ensure padding is added to height */
            order: 1; /* Place search box before options */
            z-index: 1002; /* Ensure search is above options */
        }

        .search-input {
            width: 100%;
            padding: 3px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
            font-size: 12px;
            text-align: left; /* Explicitly set text alignment to left */
            height: 30px; /* Fixed height to match option height */
            line-height: 24px; /* Vertically center text */
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow text */
            margin-bottom: 0; /* Remove bottom margin to ensure consistent spacing */
            position: sticky; /* Keep search at top when scrolling */
            top: 0; /* Stick to top */
            z-index: 2; /* Ensure it stays above options */
            background-color: #fff; /* Ensure background is white */
        }

        .custom-select-options {
            max-height: 180px; /* Height for approximately 6-7 items, leaving room for search box */
            overflow-y: auto; /* Ensure vertical scrolling works */
            background-color: #fff;
            text-align: left; /* Explicitly set text alignment to left */
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: #888 #f1f1f1; /* For Firefox */
            height: auto; /* Allow height to adjust based on content up to max-height */
            flex: 1; /* Take remaining space in flex container */
            order: 2; /* Place options after search box by default */
            display: flex; /* Use flex display */
            flex-direction: column; /* Stack options vertically */
        }

        /* Scrollbar styling for WebKit browsers (Chrome, Safari, Edge) */
        .custom-select-options::-webkit-scrollbar {
            width: 8px;
        }

        .custom-select-options::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-select-options::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .custom-select-options::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Adjust options container for dropdowns shown above */
        .dropdown-above .custom-select-options {
            /* Remove flex-direction: column-reverse which was causing display issues */
            order: 2; /* Place options after search box */
            margin-top: 0;
            margin-bottom: auto;
        }

        .custom-option {
            padding: 4px 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: #fff;
            color: #000;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
            text-align: left; /* Explicitly set text alignment to left */
            height: 30px; /* Fixed height for each option to ensure consistent sizing */
            line-height: 22px; /* Line height for vertical centering */
            box-sizing: border-box; /* Include padding in height calculation */
            white-space: nowrap; /* Prevent text wrapping to keep options compact */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow text */
            width: 100%; /* Ensure full width */
            padding: 4px 8px; /* Consistent padding */
            flex: 0 0 auto; /* Don't grow or shrink, use auto basis */
            display: flex; /* Use flex display */
            align-items: center; /* Center content vertically */
        }

        .custom-option:hover {
            background-color: #f5f5f5;
        }

        .custom-option.selected {
            background-color: #e6f7ff;
            font-weight: bold;
        }

        .custom-option.highlighted {
            background-color: #f0f0f0;
        }

        /* Position relative for dropdown positioning */
        .product-cell {
            position: relative;
            height: auto; /* Allow height to adjust */
            min-height: 24px; /* Reduced minimum height */
            vertical-align: top; /* Align content to top for multi-line text */
            overflow: visible; /* Allow content to be visible */
            padding: 4px; /* Slightly increased padding */
        }

        .bank-cell {
            position: relative;
            height: auto; /* Allow height to adjust */
            min-height: 24px; /* Reduced minimum height */
            vertical-align: top; /* Align content to top for multi-line text */
            overflow: visible; /* Allow content to be visible */
            padding: 4px; /* Slightly increased padding */
        }

        /* Bank display styling */
        .bank-display {
            width: 100%;
            padding: 3px 8px;
            box-sizing: border-box;
            font-weight: 700;
            color: #000000;
            font-size: 16px; /* Increased default font size */
            background-color: #4CD964; /* Green background for the screenshot */
            border: 1px solid #000000; /* Black border */
            border-radius: 0;
            cursor: pointer;
            background-image: none;
            white-space: nowrap; /* Prevent text wrapping in input box */
            min-height: 20px; /* Minimum height */
            height: 24px; /* Fixed height */
            line-height: 1.2; /* Line height for better readability */
            resize: none; /* Disable textarea resizing */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            font-family: inherit; /* Use the same font as other inputs */
            display: block; /* Don't use -webkit-box which limits text */
            box-shadow: none;
            transition: none;
            text-transform: uppercase; /* Always display text in uppercase */
        }

        .bank-display:hover {
            border-color: #999;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Auto-resize font for bank display based on content length */
        .bank-display.long-text {
            font-size: 14px; /* Reduce font size for long text */
            letter-spacing: -0.2px; /* Reduce letter spacing */
        }

        .bank-display.very-long-text {
            font-size: 12px; /* Further reduce font size for very long text */
            line-height: 1.2; /* Tighter line height for very long text */
            letter-spacing: -0.3px; /* Further reduce letter spacing */
            word-spacing: -1px; /* Reduce word spacing */
        }

        /* Adjust table layout */
        #obligationsTable {
            table-layout: fixed; /* Use fixed table layout */
            width: 100%; /* Full width */
            border-collapse: separate; /* Use separate border model for better control */
            border-spacing: 0; /* No spacing between cells */
            border: 2px solid #FFFFFF; /* White border around the table */
            display: table; /* Ensure proper display */
            margin-bottom: 0; /* Remove bottom margin */
        }

        /* Adjust row height */
        #obligationsTable tr {
            min-height: 45px; /* Minimum row height */
            height: auto; /* Allow height to adjust */
            background-color: #000000 !important; /* Black background */
        }

        /* Ensure table rows can expand for multi-line content */
        #obligationsTable tbody tr {
            height: auto !important; /* Force auto height */
            min-height: 45px; /* Minimum row height */
            border-bottom: 1px solid #FFFFFF; /* Add white horizontal border between rows */
            display: table-row; /* Ensure proper display */
        }

        /* Ensure the table body displays properly */
        #obligationsBody {
            display: table-row-group !important; /* Force table-row-group display */
        }

        /* Adjust all table cells */
        #obligationsTable td {
            vertical-align: middle; /* Center content vertically */
            padding: 4px; /* Reduced padding */
            height: auto; /* Allow height to adjust */
            border-right: 2px solid #FFFFFF; /* Add white vertical border between cells */
            border-bottom: none; /* Remove bottom border from cells to avoid double borders */
        }

        /* Styling for tenure cell */
        #obligationsTable td:nth-child(3) {
            padding: 4px;
        }

        /* Make tenure input more compact and ensure it uses auto-resize font */
        .tenure-input {
            font-weight: 700; /* Bold font */
            font-size: 12px; /* Reduced font size */
            padding: 3px 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            height: 24px;
            background-color: white;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            text-align: left; /* Left align text for consistency */
            transition: all 0.2s ease-in-out;
            width: 52.5%; /* Reduced width by 55% total (25% + 30% more) */
            overflow: visible; /* Allow content to be visible */
            white-space: nowrap; /* Prevent wrapping */
            text-overflow: clip; /* Don't use ellipsis, show full text */
        }

        .tenure-input:focus {
            border-color: #4a5568; /* Darker border on focus */
            box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.2); /* Focus ring */
            outline: none;
        }

        /* Auto-resize font for tenure input based on content length */
        .tenure-input.medium-length {
            font-size: 16px; /* Keep font size consistent */
        }

        .tenure-input.long-length {
            font-size: 16px; /* Keep font size consistent */
            letter-spacing: -0.1px; /* Very slight letter spacing adjustment if needed */
        }

        .tenure-input.very-long-length {
            font-size: 16px; /* Keep font size consistent */
            letter-spacing: -0.1px; /* Very slight letter spacing adjustment if needed */
        }

        /* Style for ROI cell */
        #obligationsTable td:nth-child(4) {
            padding: 4px;
        }

        /* Style for ROI input - make it consistent with other inputs */
        .roi-input {
            font-weight: 700; /* Bold font */
            text-align: left; /* Left align the text for consistency */
            font-size: 12px; /* Reduced font size */
            padding: 3px 4px; /* Reduced padding to fit more text */
            box-sizing: border-box;
            overflow: visible; /* Allow overflow */
            margin: 0; /* Remove any margin */
            border: 1px solid #ccc; /* Lighter border */
            background-color: white; /* White background */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); /* Subtle shadow */
            border-radius: 4px; /* Smaller border radius */
            height: 24px; /* Reduced height */
            width: 70px; /* Increased width to fill space */
            min-width: 70px;
            max-width: 70px;
            transition: all 0.2s ease-in-out; /* Smooth transition */
        }

        .roi-input:focus {
            border-color: #4a5568; /* Darker border on focus */
            box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.2); /* Focus ring */
            outline: none;
        }

        /* Auto-resize font for ROI input based on content length */
        .roi-input.medium-length {
            font-size: 16px; /* Keep font size consistent */
        }

        .roi-input.long-length {
            font-size: 16px; /* Keep font size consistent */
            letter-spacing: -0.1px; /* Very slight letter spacing adjustment if needed */
        }

        .roi-input.very-long-length {
            font-size: 16px; /* Keep font size consistent */
            letter-spacing: -0.1px; /* Very slight letter spacing adjustment if needed */
        }

        /* Additional action select properties - matched to EMI amount input */
        .action-select {
            text-align: left; /* Left align text like other inputs */
            box-sizing: border-box;
            height: 24px; /* Match number input height */
            padding: 3px 5px; /* Match number input padding */
            font-size: 12px; /* Match number input font size */
            font-weight: 700; /* Match number input font weight */
            text-transform: none; /* Remove uppercase */
            border: 1px solid #ccc; /* Match number input border */
            border-radius: 4px; /* Match number input border radius */
            background-color: #FFFF00; /* Yellow background for Obligate */
            color: #000000; /* Black text */
            width: 100%; /* Full width */
            appearance: none; /* Remove default select styling */
            -webkit-appearance: none; /* For Safari */
            -moz-appearance: none; /* For Firefox */
            background-image: none; /* Remove default arrow */
        }

        /* Auto-resize font for action select based on content length */
        .action-select.medium-length {
            font-size: 12px; /* Keep font size consistent */
        }

        .action-select.long-length {
            font-size: 11px; /* Slightly smaller for longer text */
            letter-spacing: -0.1px; /* Very slight letter spacing adjustment if needed */
        }

        .action-select.very-long-length {
            font-size: 10px; /* Even smaller for very long text */
            letter-spacing: -0.2px; /* More letter spacing adjustment for very long text */
        }

        /* Make ROI column look exactly like others */
        #obligationsTable th:nth-child(4), #obligationsTable td:nth-child(4) {
            padding: 4px;
            border-right: 2px solid #FFFFFF; /* White border like others */
            background-color: transparent; /* No background color */
        }

        /* Make ROI header match other headers */
        #obligationsTable th:nth-child(4) {
            font-weight: bold;
            text-align: center;
            background-color: #000000 !important; /* Black background like other headers */
        }

        /* Row number column styling */
        .row-number {
            text-align: center;
            font-weight: 900; /* Extra bold */
            padding-left: 0px !important;
            padding-right: 0px !important;
            font-size: 16px; /* Increased font size */
            color: white; /* Ensure text is white */
        }

        /* Row number header styling */
        #obligationsTable th:first-child {
            text-align: center;
            padding-left: 0px !important;
            padding-right: 0px !important;
            font-size: 18px; /* Increased font size */
            font-weight: 900; /* Extra bold */
            color: #1589EE; /* Salesforce blue */
        }

        /* Styling for the TOTAL LOAN AMOUNT column */
        #obligationsTable th:nth-child(5), #obligationsTable td:nth-child(5) {
            padding: 4px;
        }

        /* Styling for the OUTSTANDING column */
        #obligationsTable th:nth-child(6), #obligationsTable td:nth-child(6) {
            padding: 4px;
            min-width: 110px;
            width: 110px;
        }

        /* Styling for the EMI AMOUNT column */
        #obligationsTable th:nth-child(7), #obligationsTable td:nth-child(7) {
            padding: 4px;
            min-width: 110px;
            width: 110px;
        }

        /* Styling for the ACTIONS column */
        #obligationsTable th:nth-child(8), #obligationsTable td:nth-child(8) {
            padding: 4px;
            min-width: 80px;
            width: 80px;
        }

        /* First column (row number) width */
        #obligationsTable th:first-child {
            width: 30px;
            min-width: 30px;
            max-width: 30px;
        }

        /* Second column (product) width */
        #obligationsTable th:nth-child(2) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
        }

        /* Third column (bank name) width */
        #obligationsTable th:nth-child(3) {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
        }

        /* Tenure column width */
        #obligationsTable th:nth-child(4) {
            min-width: 57px;
            width: 57px;
        }

        /* Debug styles - hidden in production */
        .debug-border {
            border: 2px solid red !important;
        }

        /* Hide all debug elements */
        [id*="debug"], [class*="debug"], [id*="Debug"], [class*="Debug"] {
            display: none !important;
        }

        /* Delete button styling */
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            font-size: 12px;
            color: #777;
            transition: color 0.2s;
            margin: 0 auto;
        }

        .delete-btn:hover {
            color: #ff0000;
        }

        /* Delete icon column styling */
        #obligationsTable td:last-child {
            text-align: center;
            padding: 0;
            vertical-align: middle;
        }



        .green-row {
            background-color: #4CD964 !important; /* Matching the green color from the screenshot */
        }

        .green-row input,
        .green-row textarea,
        .green-row .product-display,
        .green-row .bank-display {
            background-color: #4CD964 !important; /* Matching the green color from the screenshot */
            color: #000000 !important; /* Dark black text */
            /* Keep original font styling */
            font-weight: 700 !important;
            font-size: 14px !important;
        }

        .green-row select.action-select {
            background-color: #4CD964 !important;
            color: #000000 !important;
            font-weight: 700 !important;
            font-size: 12px !important;
            text-align: left !important;
            height: 24px !important;
            padding: 3px 5px !important;
            border: 1px solid #ccc !important;
            border-radius: 4px !important;
            text-transform: none !important;
        }

        .orange-row {
            background-color: #FFFF00 !important; /* Yellow color */
        }

        .orange-row input,
        .orange-row textarea,
        .orange-row .product-display,
        .orange-row .bank-display {
            background-color: #FFFF00 !important; /* Yellow color */
            color: #000000 !important; /* Dark black text */
            /* Keep original font styling */
            font-weight: 700 !important;
            font-size: 14px !important;
        }

        .orange-row select.action-select {
            background-color: #FFFF00 !important;
            color: #000000 !important;
            font-weight: 700 !important;
            font-size: 12px !important;
            text-align: left !important;
            height: 24px !important;
            padding: 3px 5px !important;
            border: 1px solid #ccc !important;
            border-radius: 4px !important;
            text-transform: none !important;
        }

        .red-row {
            background-color: #FF0000 !important; /* Bright red */
        }

        .red-row input,
        .red-row textarea,
        .red-row .product-display,
        .red-row .bank-display {
            background-color: #FF0000 !important;
            color: #000000 !important; /* Dark black text */
            /* Keep original font styling */
            font-weight: 700 !important;
            font-size: 14px !important;
        }

        .red-row select.action-select {
            background-color: #FF0000 !important;
            color: #000000 !important;
            font-weight: 700 !important;
            font-size: 12px !important;
            text-align: left !important;
            height: 24px !important;
            padding: 3px 5px !important;
            border: 1px solid #ccc !important;
            border-radius: 4px !important;
            text-transform: none !important;
        }

        /* Blue row styling for NO-PAY */
        .blue-row {
            background-color: #0080FF !important; /* Bright blue */
        }

        .blue-row input,
        .blue-row textarea,
        .blue-row .product-display,
        .blue-row .bank-display {
            background-color: #0080FF !important;
            color: #000000 !important; /* Dark black text */
            /* Keep original font styling */
            font-weight: 700 !important;
            font-size: 14px !important;
        }

        .blue-row select.action-select {
            background-color: #0080FF !important;
            color: #000000 !important;
            font-weight: 700 !important;
            font-size: 12px !important;
            text-align: left !important;
            height: 24px !important;
            padding: 3px 5px !important;
            border: 1px solid #ccc !important;
            border-radius: 4px !important;
            text-transform: none !important;
        }

        /* Bright orange row styling for CO-PAY */
        .bright-orange-row {
            background-color: #FFA500 !important; /* Bright orange */
        }

        .bright-orange-row input,
        .bright-orange-row textarea,
        .bright-orange-row .product-display,
        .bright-orange-row .bank-display {
            background-color: #FFA500 !important;
            color: #000000 !important; /* Dark black text */
            /* Keep original font styling */
            font-weight: 700 !important;
            font-size: 14px !important;
        }

        .bright-orange-row select.action-select {
            background-color: #FFA500 !important;
            color: #000000 !important;
            font-weight: 700 !important;
            font-size: 12px !important;
            text-align: left !important;
            height: 24px !important;
            padding: 3px 5px !important;
            border: 1px solid #ccc !important;
            border-radius: 4px !important;
            text-transform: none !important;
        }

        .number-input {
            text-align: left; /* Align text to the left */
            font-weight: 700; /* Bold font */
            color: #000000; /* Dark black text */
            font-size: 12px; /* Reduced font size */
            width: 100%; /* Use full width of cell */
            overflow: visible; /* Allow overflow */
            white-space: nowrap; /* Prevent wrapping */
            padding: 3px 5px; /* Reduced padding */
            border: 1px solid #ccc; /* Lighter border */
            border-radius: 4px; /* Slightly larger border radius */
            height: 24px; /* Reduced height */
            background-color: white; /* White background */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); /* Subtle shadow */
            transition: all 0.2s ease-in-out; /* Smooth transition for hover effects */
        }

        .number-input:focus {
            border-color: #4a5568; /* Darker border on focus */
            box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.2); /* Focus ring */
            outline: none;
        }

        /* Auto-resize font for number inputs based on content length */
        .number-input.medium-length {
            font-size: 16px; /* Keep font size consistent */
        }

        .number-input.long-length {
            font-size: 16px; /* Keep font size consistent */
            letter-spacing: -0.1px; /* Very slight letter spacing adjustment if needed */
        }

        .number-input.very-long-length {
            font-size: 16px; /* Keep font size consistent */
            letter-spacing: -0.1px; /* Very slight letter spacing adjustment if needed */
        }

        .outstanding-cell.green-bg input {
            background-color: #4CD964 !important; /* Matching the green color from the screenshot */
            font-size: 18px !important; /* Increased text size for highlight */
            font-weight: 900 !important; /* Extra bold font */
            color: #000000 !important; /* Dark black text */
        }

        .emi-cell.orange-bg input {
            background-color: #FFFF00 !important; /* Yellow for EMI Amount when Obligate */
            font-size: 18px !important; /* Increased text size for highlight */
            font-weight: 900 !important; /* Extra bold font */
            color: #000000 !important; /* Dark black text */
        }

        /* Simple styling for cells */
        .roi-cell, .loan-amount-cell {
            background-color: transparent;
        }

        .outstanding-cell input,
        .emi-cell input,
        .roi-cell input,
        .loan-amount-cell input {
            background-color: inherit;
        }

        #error {
            color: red;
            display: none;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
        }

        /* Beautiful centered notification */
        .centered-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
        }

        .centered-notification.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .centered-notification .notification-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: #4CD964;
        }

        .centered-notification .notification-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4CD964;
        }

        .centered-notification .notification-message {
            font-size: 16px;
            text-align: center;
            margin-bottom: 15px;
        }

        .centered-notification .notification-button {
            background-color: #4CD964;
            color: black;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .centered-notification .notification-button:hover {
            background-color: #3cb053;
        }
    </style>
</head>
<body>
<!-- Beautiful centered notification -->
<div id="centeredNotification" class="centered-notification">
    <div class="notification-icon">
        <i class="fas fa-check-circle"></i>
    </div>
    <div class="notification-title">Success!</div>
    <div id="notificationMessage" class="notification-message">Data imported successfully!</div>
    <button class="notification-button" onclick="closeNotification()">OK</button>
</div>

<div class="main-container">
    <!-- Version Button - Top Left -->
    <div style="position: absolute; top: 10px; left: 10px; z-index: 100;">
        <button id="versionBtn" style="background: var(--primary); color: #000; padding: 5px 10px; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; box-shadow: var(--shadow-glow);">
            VERSION 1 6th April 2025
        </button>
    </div>

    <!-- Left Column - Main Content -->
    <div class="left-column">
        <!-- Excel Import/Export Controls -->
        <div class="excel-controls">
            <button id="downloadExcelBtn" class="excel-btn download-btn">
                <i class="fas fa-download"></i> Download
            </button>
            <div style="position: relative; overflow: hidden;">
                <button id="uploadExcelBtn" class="excel-btn upload-btn">
                    <i class="fas fa-upload"></i> Upload
                </button>
                <input type="file" id="excelFileInput" accept=".xlsx" style="position: absolute; top: 0; left: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer;">
            </div>
        </div>

        <!-- Customer Details Section -->
        <div class="calculator-card-base">
            <h1>Customer Details</h1>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="display: flex; gap: 10px;">
                    <div class="input-group" style="flex: 1;">
                        <label for="customerName">Customer Name</label>
                        <input type="text" class="input-editable" id="customerName" placeholder="ENTER CUSTOMER NAME" style="text-transform: uppercase; background-color: #FFFF00; color: #000000; font-weight: bold;" oninput="this.value = this.value.toUpperCase();" autocomplete="off">
                    </div>

                    <div class="input-group" style="flex: 0.7;">
                        <label for="salary">Salary</label>
                        <input type="text" class="input-editable" id="salary"
                               oninput="this.value = this.value.replace(/[^0-9]/g, ''); formatNumber(this); calculateTotal(); this.value = this.value.split('.')[0];"
                               onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                               placeholder="Enter salary"
                               style="background-color: #FFFF00; color: #000000; font-weight: bold;"
                               autocomplete="off">
                    </div>

                    <div class="input-group" style="flex: 0.7;">
                        <label for="partnerSalary">Partner's Salary</label>
                        <input type="text" class="input-editable" id="partnerSalary"
                               oninput="this.value = this.value.replace(/[^0-9]/g, ''); formatNumber(this); calculateTotal(); this.value = this.value.split('.')[0];"
                               onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                               placeholder="Enter partner's salary"
                               style="background-color: #FFFF00; color: #000000; font-weight: bold;"
                               autocomplete="off">
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <div class="input-group" style="flex: 0.7;">
                        <label for="bonus">Bonus</label>
                        <input type="text" class="input-editable" id="bonus"
                               oninput="this.value = this.value.replace(/[^0-9]/g, ''); formatNumber(this); calculateTotal(); toggleDivideByMonths()"
                               onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                               placeholder="Enter bonus"
                               style="background-color: #FFFF00; color: #000000; font-weight: bold;"
                               autocomplete="off">

                        <div id="divideByMonthsSection" style="margin-top: 5px; display: none;">
                            <div style="display: flex; align-items: center; gap: 3px;">
                                <span style="font-weight: 600; white-space: nowrap; font-size: 11px; color: var(--text-light);">Divide by months</span>
                                <div style="display: flex; gap: 3px; flex: 1;">
                                    <button id="bonusButton3" onclick="applyBonus(3)" style="flex: 1; padding: 3px 2px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid rgba(0, 255, 127, 0.3); border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 11px;">3</button>
                                    <button id="bonusButton6" onclick="applyBonus(6)" style="flex: 1; padding: 3px 2px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid rgba(0, 255, 127, 0.3); border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 11px;">6</button>
                                    <button id="bonusButton12" onclick="applyBonus(12)" style="flex: 1; padding: 3px 2px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid rgba(0, 255, 127, 0.3); border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 11px;">12</button>
                                    <button id="bonusButton24" onclick="applyBonus(24)" style="flex: 1; padding: 3px 2px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid rgba(0, 255, 127, 0.3); border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 11px;">24</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="input-group" style="flex: 1; position: relative;">
                        <label for="companyName">Company Name</label>
                        <div style="position: relative; display: flex; align-items: center;">
                            <input type="text" class="input-editable" id="companyName" placeholder="ENTER COMPANY NAME" style="text-transform: uppercase; padding-right: 40px; background-color: #FFFF00; color: #000000; font-weight: bold; width: 100%;" oninput="this.value = this.value.toUpperCase();" autocomplete="off">
                            <div id="companySearchIcon" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); cursor: pointer; background-color: #1589EE; width: 36px; height: 36px; border-radius: 0 4px 4px 0; display: flex; align-items: center; justify-content: center;" onclick="openZaubaCorp()" title="Search on Zauba Corp">
                                <i class="fas fa-search" style="color: white; font-size: 18px;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" style="color: #ff4d4d; background: rgba(255, 77, 77, 0.1); border-radius: 8px; padding: 10px; margin: 10px 0; display: none;"></div>

        <!-- Customer Obligations Section -->
        <div class="calculator-card-base">
            <h1>Customer Obligations</h1>

            <!-- Summary Fields -->
            <div class="summary-container">
                <div class="summary-field bt-input">
                    <label for="totalBtPos">TOTAL BT POS</label>
                    <input type="text" class="summary-input" id="totalBtPos" readonly>
                </div>

                <div class="summary-field obligation-input">
                    <label for="totalObligation">TOTAL OBLIGATION</label>
                    <input type="text" class="summary-input" id="totalObligation" readonly>
                </div>
            </div>
        <!-- Obligations Section - Contains table and button in separate divs -->
        <div class="obligations-section" style="border: 1px solid #333; background-color: #000; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
            <!-- Table Container -->
            <div class="table-container" style="width: 100%; overflow-x: auto; overflow-y: visible; display: block;">
                <table id="obligationsTable" style="width: 100%; table-layout: fixed; border-collapse: separate; border-spacing: 0;">
                    <thead>
                        <tr>
                            <th style="width: 40px; text-align: center; background-color: #000000; color: #1589EE; font-size: 18px; font-weight: 900;">#</th>
                            <th style="background-color: #000000; color: #1589EE;">PRODUCT</th>
                            <th style="background-color: #000000; color: #1589EE;">BANK NAME</th>
                            <th style="background-color: #000000; color: #1589EE; position: relative; padding: 3px 25px 3px 3px; text-align: center;">
                                TENURE
                                <span style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border-radius: 50%; background-color: #1589EE; cursor: pointer;" onclick="showTenureInfoPopup()" title="Tenure Conversion Info">
                                    <i class="fa-solid fa-info" style="color: #FFFFFF; font-size: 0.8rem;"></i>
                                </span>
                            </th>
                            <th style="text-align: center; background-color: #000000; color: #1589EE;">ROI %</th>
                            <th style="background-color: #000000; color: #1589EE;">TOTAL LOAN</th>
                            <th style="background-color: #000000; color: #1589EE;">OUTSTANDING</th>
                            <th style="background-color: #000000; color: #1589EE;">EMI</th>
                            <th style="background-color: #000000; color: #1589EE;">ACTIONS</th>
                            <th style="background-color: #000000;"></th>
                        </tr>
                    </thead>
                    <tbody id="obligationsBody">
                <tr style="background-color: #FFFFFF;">
                <td class="row-number" style="text-align: center; font-weight: bold;">1</td>
                <td class="product-cell">
                    <div class="custom-select-wrapper">
                        <textarea class="product-display" readonly placeholder="Select Product" rows="1" style="background-color: #FFFFFF; height: 24px; min-height: 24px; overflow: hidden; resize: none; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></textarea>
                        <input type="hidden" class="product-value">
                        <div class="custom-select-dropdown">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search products...">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-option" data-value="">Select Product</div>
                                <div class="custom-option" data-value="PL (Personal Loan)">PL (Personal Loan)</div>
                                <div class="custom-option" data-value="OD (Overdraft)">OD (Overdraft)</div>
                                <div class="custom-option" data-value="CC (Credit Card)">CC (Credit Card)</div>
                                <div class="custom-option" data-value="BL (Business Loan)">BL (Business Loan)</div>
                                <div class="custom-option" data-value="HL (Home Loan)">HL (Home Loan)</div>
                                <div class="custom-option" data-value="LAP (Loan Against Property)">LAP (Loan Against Property)</div>
                                <div class="custom-option" data-value="AL (Auto Loan/ Car Loan)">AL (Auto Loan/ Car Loan)</div>
                                <div class="custom-option" data-value="EL (Education Loan)">EL (Education Loan)</div>
                                <div class="custom-option" data-value="GL (Gold Loan)">GL (Gold Loan)</div>
                                <div class="custom-option" data-value="LOC (Loan On Credit Card)">LOC (Loan On Credit Card)</div>
                                <div class="custom-option" data-value="CD (Consumer Durable Loan)">CD (Consumer Durable Loan)</div>
                                <div class="custom-option" data-value="APP LOAN">APP LOAN</div>
                                <div class="custom-option" data-value="INSURANCE">INSURANCE</div>
                            </div>
                        </div>
                    </div>
                </td>
                <td class="bank-cell">
                    <div class="custom-select-wrapper bank-select-wrapper">
                        <textarea class="bank-display" readonly placeholder="Select Bank" rows="1" style="background-color: #FFFFFF; height: 24px; min-height: 24px; overflow: hidden; resize: none; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></textarea>
                        <input type="hidden" class="bank-value">
                        <div class="custom-select-dropdown bank-dropdown">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search banks...">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-option" data-value="">Select Bank</div>
                                <!-- Private Banks -->
                                <div class="custom-option" data-value="Axis Bank">Axis Bank</div>
                                <div class="custom-option" data-value="Axis Finance">Axis Finance</div>
                                <div class="custom-option" data-value="Bandhan Bank">Bandhan Bank</div>
                                <div class="custom-option" data-value="City Union Bank">City Union Bank</div>
                                <div class="custom-option" data-value="CSB Bank">CSB Bank</div>
                                <div class="custom-option" data-value="DCB Bank">DCB Bank</div>
                                <div class="custom-option" data-value="Dhanlaxmi Bank">Dhanlaxmi Bank</div>
                                <div class="custom-option" data-value="Federal Bank">Federal Bank</div>
                                <div class="custom-option" data-value="HDFC Bank">HDFC Bank</div>
                                <div class="custom-option" data-value="ICICI Bank">ICICI Bank</div>
                                <div class="custom-option" data-value="IDBI Bank">IDBI Bank</div>
                                <div class="custom-option" data-value="IDFC FIRST Bank">IDFC FIRST Bank</div>
                                <div class="custom-option" data-value="IndusInd Bank">IndusInd Bank</div>
                                <div class="custom-option" data-value="Karnataka Bank">Karnataka Bank</div>
                                <div class="custom-option" data-value="Kotak Mahindra Bank">Kotak Mahindra Bank</div>
                                <div class="custom-option" data-value="Nainital Bank">Nainital Bank</div>
                                <div class="custom-option" data-value="RBL Bank">RBL Bank</div>
                                <div class="custom-option" data-value="South Indian Bank">South Indian Bank</div>
                                <div class="custom-option" data-value="Tamilnad Mercantile Bank">Tamilnad Mercantile Bank</div>
                                <div class="custom-option" data-value="YES Bank">YES Bank</div>

                                <!-- Public Banks -->
                                <div class="custom-option" data-value="Bank of Baroda">Bank of Baroda</div>
                                <div class="custom-option" data-value="Bank of India">Bank of India</div>
                                <div class="custom-option" data-value="Bank of Maharashtra">Bank of Maharashtra</div>
                                <div class="custom-option" data-value="Canara Bank">Canara Bank</div>
                                <div class="custom-option" data-value="Central Bank of India">Central Bank of India</div>
                                <div class="custom-option" data-value="Indian Bank">Indian Bank</div>
                                <div class="custom-option" data-value="Indian Overseas Bank">Indian Overseas Bank</div>
                                <div class="custom-option" data-value="PNB Bank">PNB Bank</div>
                                <div class="custom-option" data-value="Punjab & Sind Bank">Punjab & Sind Bank</div>
                                <div class="custom-option" data-value="SBI Bank">SBI Bank</div>
                                <div class="custom-option" data-value="UCO Bank">UCO Bank</div>

                                <!-- NBFCs -->
                                <div class="custom-option" data-value="Aditya Birla Capital">Aditya Birla Capital</div>
                                <div class="custom-option" data-value="Bajaj Finance">Bajaj Finance</div>
                                <div class="custom-option" data-value="Bajaj Finserv">Bajaj Finserv</div>
                                <div class="custom-option" data-value="Capri Global Capital">Capri Global Capital</div>
                                <div class="custom-option" data-value="Cholamandalam Investment and Finance">Cholamandalam Investment and Finance</div>
                                <div class="custom-option" data-value="Edelweiss Financial Services">Edelweiss Financial Services</div>
                                <div class="custom-option" data-value="Fullerton India">Fullerton India</div>
                                <div class="custom-option" data-value="HDB Financial Services">HDB Financial Services</div>
                                <div class="custom-option" data-value="IIFL Finance">IIFL Finance</div>
                                <div class="custom-option" data-value="InCred Finance">InCred Finance</div>
                                <div class="custom-option" data-value="JM Financial">JM Financial</div>
                                <div class="custom-option" data-value="L&T Finance">L&T Finance</div>
                                <div class="custom-option" data-value="Mahindra Finance">Mahindra Finance</div>
                                <div class="custom-option" data-value="Mas Financial Services">Mas Financial Services</div>
                                <div class="custom-option" data-value="Motilal Oswal Financial Services">Motilal Oswal Financial Services</div>
                                <div class="custom-option" data-value="Muthoot Finance">Muthoot Finance</div>
                                <div class="custom-option" data-value="Piramal Capital & Housing Finance">Piramal Capital & Housing Finance</div>
                                <div class="custom-option" data-value="Poonawalla Fincorp">Poonawalla Fincorp</div>
                                <div class="custom-option" data-value="Reliance Capital">Reliance Capital</div>
                                <div class="custom-option" data-value="Shriram Finance">Shriram Finance</div>
                                <div class="custom-option" data-value="Srei Infrastructure Finance">Srei Infrastructure Finance</div>
                                <div class="custom-option" data-value="Tata Capital">Tata Capital</div>
                                <div class="custom-option" data-value="Ugro Capital">Ugro Capital</div>
                                <div class="custom-option" data-value="Vistaar Financial Services">Vistaar Financial Services</div>

                                <!-- Fintechs -->
                                <div class="custom-option" data-value="50Fin">50Fin</div>
                                <div class="custom-option" data-value="Capital Float">Capital Float</div>
                                <div class="custom-option" data-value="CASHe">CASHe</div>
                                <div class="custom-option" data-value="Credy">Credy</div>
                                <div class="custom-option" data-value="Dhani">Dhani</div>
                                <div class="custom-option" data-value="DMI Finance">DMI Finance</div>
                                <div class="custom-option" data-value="Faircent">Faircent</div>
                                <div class="custom-option" data-value="Fibe">Fibe</div>
                                <div class="custom-option" data-value="Finnable">Finnable</div>
                                <div class="custom-option" data-value="FlexSalary">FlexSalary</div>
                                <div class="custom-option" data-value="Hero FinCorp">Hero FinCorp</div>
                                <div class="custom-option" data-value="Home Credit India">Home Credit India</div>
                                <div class="custom-option" data-value="i2iFunding">i2iFunding</div>
                                <div class="custom-option" data-value="IndiaLends">IndiaLends</div>
                                <div class="custom-option" data-value="Kissht">Kissht</div>
                                <div class="custom-option" data-value="KreditBee">KreditBee</div>
                                <div class="custom-option" data-value="LazyPay">LazyPay</div>
                                <div class="custom-option" data-value="LenDenClub">LenDenClub</div>
                                <div class="custom-option" data-value="Lendingkart">Lendingkart</div>
                                <div class="custom-option" data-value="LoanTap">LoanTap</div>
                                <div class="custom-option" data-value="MoneyTap">MoneyTap</div>
                                <div class="custom-option" data-value="Moneyview">Moneyview</div>
                                <div class="custom-option" data-value="Monexo">Monexo</div>
                                <div class="custom-option" data-value="mPokket">mPokket</div>
                                <div class="custom-option" data-value="Navi">Navi</div>
                                <div class="custom-option" data-value="NIRA Finance">NIRA Finance</div>
                                <div class="custom-option" data-value="NoBroker InstaCash">NoBroker InstaCash</div>
                                <div class="custom-option" data-value="PayMe">PayMe</div>
                                <div class="custom-option" data-value="PaySense">PaySense</div>
                                <div class="custom-option" data-value="RapidRupee">RapidRupee</div>
                                <div class="custom-option" data-value="RupeeLend">RupeeLend</div>
                                <div class="custom-option" data-value="Rupifi">Rupifi</div>
                                <div class="custom-option" data-value="SmartCoin">SmartCoin</div>
                                <div class="custom-option" data-value="StashFin">StashFin</div>
                                <div class="custom-option" data-value="Svatantra Microfin">Svatantra Microfin</div>
                                <div class="custom-option" data-value="ZestMoney">ZestMoney</div>

                                <!-- Foreign Banks -->
                                <div class="custom-option" data-value="American Express Banking Corp">American Express Banking Corp</div>
                                <div class="custom-option" data-value="Bank of China">Bank of China</div>
                                <div class="custom-option" data-value="Barclays Bank">Barclays Bank</div>
                                <div class="custom-option" data-value="Citibank">Citibank</div>
                                <div class="custom-option" data-value="DBS Bank">DBS Bank</div>
                                <div class="custom-option" data-value="Deutsche Bank">Deutsche Bank</div>
                                <div class="custom-option" data-value="HSBC">HSBC</div>
                                <div class="custom-option" data-value="SBM Bank">SBM Bank</div>
                                <div class="custom-option" data-value="Standard Chartered Bank">Standard Chartered Bank</div>

                                <!-- Small Finance Banks -->
                                <div class="custom-option" data-value="AU Small Finance Bank">AU Small Finance Bank</div>
                                <div class="custom-option" data-value="Capital Small Finance Bank">Capital Small Finance Bank</div>
                                <div class="custom-option" data-value="Equitas Small Finance Bank">Equitas Small Finance Bank</div>
                                <div class="custom-option" data-value="Jana Small Finance Bank">Jana Small Finance Bank</div>
                                <div class="custom-option" data-value="North East Small Finance Bank">North East Small Finance Bank</div>
                                <div class="custom-option" data-value="Shivalik Small Finance Bank">Shivalik Small Finance Bank</div>
                                <div class="custom-option" data-value="Ujjivan Small Finance Bank">Ujjivan Small Finance Bank</div>
                                <div class="custom-option" data-value="Utkarsh Small Finance Bank">Utkarsh Small Finance Bank</div>

                                <!-- Other -->
                                <div class="custom-option" data-value="OTHER">OTHER</div>
                            </div>
                        </div>
                    </div>
                </td>
                <td><input type="text" class="number-input tenure-input" placeholder="months" maxlength="3" style="text-align: left; background-color: #FFFFFF; height: 24px; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></td>
                <td class="roi-cell"><input type="text" class="number-input roi-input" placeholder="%" maxlength="6" style="text-align: left; background-color: #FFFFFF; height: 24px; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></td>
                <td class="loan-amount-cell"><input type="text" class="number-input" oninput="formatNumber(this)" placeholder="Total loan" style="background-color: #FFFFFF; height: 24px; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></td>
                <td class="outstanding-cell"><input type="text" class="number-input os-input" oninput="formatNumber(this)" placeholder="Outstanding" style="background-color: #FFFFFF; height: 24px; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></td>
                <td class="emi-cell"><input type="text" class="number-input emi-input" oninput="formatNumber(this)" placeholder="EMI" style="background-color: #FFFFFF; height: 24px; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></td>
                <td class="actions-cell">
                    <select class="action-select" onchange="setAction(this)" style="width: 100%; height: 24px; background-color: #FFFF00; border: 1px solid #ccc; border-radius: 4px; text-align: left; font-size: 12px; font-weight: 700; padding: 3px 5px;">
                        <option value="">Select Action</option>
                        <option value="BT">BT</option>
                        <option value="Obligate" selected>Obligate</option>
                        <option value="CO-PAY">CO-PAY</option>
                        <option value="NO-PAY">NO-PAY</option>
                        <option value="Closed">Closed</option>
                    </select>
                    <input type="hidden" class="action-state" value="Obligate">
                    <input type="hidden" class="bt-applied" value="false">
                    <input type="hidden" class="obligate-applied" value="true">
                </td>
                <!-- Delete button column is hidden -->
                </tr>
            </tbody>
                </table>
            </div>
            <!-- Add Row Button - In its own div after the table, not absolutely positioned -->
            <div style="padding: 10px; background-color: #000000; text-align: center; border-top: 1px solid #333;">
                <button class="add-row-btn" onclick="addRegularRow()" style="background-color: #FFFFFF; color: #000000; border: 1px solid #000000; padding: 5px 10px; height: 30px; font-size: 0.9rem; font-weight: 600; width: 200px; margin: 0 auto; display: block;">
                    ADD NEW ROW
                </button>
            </div>
        </div><!-- End of obligations-section -->

        <!-- Calculate Eligibility Section -->
        <div class="calculator-card-base">
            <h1>Calculate Eligibility</h1>

            <!-- Row 1: Total Income, Company Category, FOIR %, FOIR AMOUNT, Total Obligation -->
            <div style="display: grid; grid-template-columns: 0.8fr 1.8fr 0.6fr 0.8fr 0.8fr; gap: 8px; margin-bottom: 8px;">
                <!-- Total Income -->
                <div class="input-group">
                    <label for="eligibilityTotalIncome">Total Income</label>
                    <input type="text" id="eligibilityTotalIncome" readonly>
                </div>

                <!-- Company Category -->
                <div class="input-group">
                    <label for="companyCategory" class="label-with-info">
                        <span>Company Category</span>
                        <span class="info-icon-wrapper" onclick="showFoirInfoPopup()" title="FOIR Calculation Info">
                            <i class="fa-solid fa-info info-icon"></i>
                        </span>
                    </label>
                    <select id="companyCategory" onchange="resetFOIRAndCalculate()">
                        <option value="">Select Category</option>
                        <option value="SUPER_CAT_A">SUPER CAT A</option>
                        <option value="CAT_A">CAT A</option>
                        <option value="CAT_B">CAT B</option>
                        <option value="CAT_C">CAT C</option>
                        <option value="UNLISTED">UNLISTED or MANUAL FOIR</option>
                    </select>
                    <div id="foirButtonsContainer" style="display: flex; gap: 3px; flex-wrap: wrap; margin-top: 3px;">
                        <button onclick="selectFOIR(50)" style="padding: 2px 4px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid var(--primary); border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 0.75rem; flex: 1;">50%</button>
                        <button onclick="selectFOIR(55)" style="padding: 2px 4px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid var(--primary); border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 0.75rem; flex: 1;">55%</button>
                        <button onclick="selectFOIR(60)" style="padding: 2px 4px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid var(--primary); border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 0.75rem; flex: 1;">60%</button>
                        <button onclick="selectFOIR(65)" style="padding: 2px 4px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid var(--primary); border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 0.75rem; flex: 1;">65%</button>
                    </div>
                    <div id="customFoirInputContainer" style="display: flex; gap: 3px; margin-top: 3px;">
                        <input type="text" id="customFoirInputInline" placeholder="Custom FOIR %" maxlength="3" style="flex: 2; padding: 2px 4px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid var(--primary); border-radius: 4px; font-size: 0.75rem;">
                        <button onclick="applyCustomFOIRInline()" style="padding: 2px 4px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid var(--primary); border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 0.75rem; flex: 1;">APPLY</button>
                    </div>
                </div>

                <!-- FOIR % -->
                <div class="input-group">
                    <label for="foirPercentage">FOIR %</label>
                    <div style="display: flex; align-items: center; gap: 3px;">
                        <input type="text" id="foirPercentage" maxlength="3" readonly style="width: 100px;">
                        <button id="foirToggleBtn" onclick="toggleFOIR()" style="display: none; padding: 2px 4px; background: var(--editable-bg); color: var(--text-dark); border: 1px solid var(--primary); border-radius: 4px; font-weight: 700; font-size: 0.75rem;">+5%</button>
                    </div>
                </div>

                <!-- FOIR AMOUNT -->
                <div class="input-group">
                    <label for="foirAmount">FOIR AMOUNT</label>
                    <input type="text" id="foirAmount" readonly>
                </div>

                <!-- Total Obligation -->
                <div class="input-group">
                    <label for="eligibilityTotalObligation">Total Obligation</label>
                    <input type="text" id="eligibilityTotalObligation" readonly>
                </div>
            </div>

            <!-- FOIR Options Row - Hidden since we moved the buttons under Company Category -->
            <div id="foirOptionsRow" style="display: none;">
            </div>

            <!-- Row 2: Monthly EMI Can Pay, Tenure (Months), Tenure (Years), ROI -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <!-- Monthly EMI Can Pay -->
                <div class="input-group">
                    <label for="monthlyEmiCanPay">Monthly EMI Can Pay</label>
                    <input type="text" id="monthlyEmiCanPay" readonly>
                </div>

                <!-- Tenure (Months) -->
                <div class="input-group">
                    <label for="eligibilityTenureMonths" class="label-with-info">
                        <span>Tenure (Months)</span>
                        <span class="info-icon-wrapper" onclick="showTenureInfoPopup()" title="Tenure Conversion Info">
                            <i class="fa-solid fa-info info-icon"></i>
                        </span>
                    </label>
                    <input type="text" id="eligibilityTenureMonths" placeholder="Months" maxlength="3">
                </div>

                <!-- Tenure (Years) -->
                <div class="input-group">
                    <label for="eligibilityTenureYears">Tenure (Years)</label>
                    <input type="text" id="eligibilityTenureYears" readonly>
                </div>

                <!-- ROI -->
                <div class="input-group">
                    <label for="eligibilityRoi">ROI %</label>
                    <input type="text" id="eligibilityRoi" placeholder="%" maxlength="5">
                </div>
            </div>

            <!-- Results Section: TOTAL BT POS, FOIR Eligibility, Multiplier Eligibility in one row -->
            <div style="display: grid; grid-template-columns: 1fr 2fr 2fr; gap: 8px; margin-top: 10px;">
                <!-- TOTAL BT POS -->
                <div style="background: #000000; border-radius: 8px; padding: 8px; border: 1px solid rgba(0, 255, 127, 0.2); display: flex; flex-direction: column; justify-content: center;">
                    <h3 style="color: #ffffff; margin-top: 0; margin-bottom: 5px; text-align: center; font-size: 1.2rem; font-weight: 700;">TOTAL BT POS</h3>
                    <div style="display: flex; align-items: center; justify-content: center; flex-grow: 1;">
                        <input type="text" id="eligibilityTotalBtPos" readonly style="width: 100%; text-align: center; font-size: 3rem; font-weight: 900; background: #000000; color: #ffffff; border: 1px solid rgba(0, 255, 127, 0.3); border-radius: 6px; padding: 10px; height: 70px;">
                    </div>
                </div>

                <!-- FOIR Eligibility -->
                <div style="background: #000000; border-radius: 8px; padding: 8px; border: 1px solid rgba(0, 255, 127, 0.2);">
                    <h3 style="color: #ffffff; margin-top: 0; margin-bottom: 5px; text-align: center; font-size: 1.2rem; font-weight: 700;">Loan Eligibility as per FOIR</h3>
                    <div id="foirEligibilityResult" style="min-height: 60px; color: #ffffff; font-size: 1.3rem; font-weight: 700;"></div>
                </div>

                <!-- Multiplier Eligibility -->
                <div style="background: #000000; border-radius: 8px; padding: 8px; border: 1px solid rgba(0, 255, 127, 0.2);">
                    <h3 style="color: #ffffff; margin-top: 0; margin-bottom: 5px; text-align: center; font-size: 1.2rem; font-weight: 700;">Loan Eligibility as per Multiplier</h3>
                    <div class="input-group" style="margin-bottom: 5px;">
                        <label for="multiplierValue" style="display: inline-block; margin-right: 5px; font-size: 1rem; color: #ffffff; font-weight: 700;">MULTIPLIER:</label>
                        <input type="text" id="multiplierValue" style="width: 60px; display: inline-block; height: 28px; padding: 2px 5px; font-size: 1rem; font-weight: 700; background: #ffff00; color: #000000; -moz-appearance: textfield; appearance: textfield; -webkit-appearance: none;">
                    </div>
                    <div id="multiplierEligibilityResult" style="min-height: 30px; color: #ffffff; font-size: 1.3rem; font-weight: 700;"></div>
                </div>
            </div>

            <!-- Shortfall Warning Container - Full Width Below Eligibility Sections -->
            <div id="eligibilityShortfallContainer" style="display: none; margin-top: 10px; width: 100%;"></div>

            <!-- No Calculate Button - Calculations happen automatically -->
        </div>

        <!-- FOIR Info Popup -->
        <div id="foirInfoPopup" class="popup">
            <h2>FOIR Calculation Rules</h2>
            <p>FOIR (Fixed Obligation to Income Ratio) determines the maximum percentage of your salary that can go towards loan EMIs.</p>
            <p><strong>SUPER CAT A / CAT A / CAT B Companies:</strong></p>
            <ul>
                <li>Salary ₹0 - ₹34,999: <strong>50% FOIR</strong></li>
                <li>Salary ₹35,000 - ₹49,999: <strong>60% FOIR</strong></li>
                <li>Salary ₹50,000 - ₹74,999: <strong>65% FOIR</strong></li>
                <li>Salary ₹75,000 and above: <strong>70% FOIR</strong></li>
            </ul>
            <p><strong>CAT C Companies:</strong></p>
            <ul>
                <li>Salary ₹0 - ₹34,999: <strong>45% FOIR</strong></li>
                <li>Salary ₹35,000 - ₹49,999: <strong>50% FOIR</strong></li>
                <li>Salary ₹50,000 - ₹74,999: <strong>60% FOIR</strong></li>
                <li>Salary ₹75,000 and above: <strong>70% FOIR</strong></li>
            </ul>
            <p>For <strong>UNLISTED</strong> companies, FOIR is selected manually.</p>
            <button class="popup-close-btn" onclick="closePopup('foirInfoPopup')">Close</button>
        </div>

        <!-- Tenure Info Popup -->
        <div id="tenureInfoPopup" class="popup">
            <h2>Loan Tenure Conversion</h2>
            <p>Loan tenure is typically expressed in months. Here's a quick conversion guide:</p>
            <ul>
                <li>4 Years = <strong>48 Months</strong></li>
                <li>5 Years = <strong>60 Months</strong></li>
                <li>6 Years = <strong>72 Months</strong></li>
                <li>7 Years = <strong>84 Months</strong></li>
                <li>8 Years = <strong>96 Months</strong></li>
                <li>10 Years = <strong>120 Months</strong></li>
                <li>15 Years = <strong>180 Months</strong></li>
                <li>20 Years = <strong>240 Months</strong></li>
                <li>25 Years = <strong>300 Months</strong></li>
                <li>30 Years = <strong>360 Months</strong></li>
            </ul>
            <p>Formula: <strong>Months = Years × 12</strong></p>
            <button class="popup-close-btn" onclick="closePopup('tenureInfoPopup')">Close</button>
        </div>

        <!-- Add minimal space at the bottom -->
        <div style="height: 20px; width: 100%;"></div>
    </div><!-- End of left-column -->
</div><!-- End of main-container -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let totalBtPos = 0;
        let totalObligation = 0;
        let activeBonusButton = null;
        let originalSalary = 0;
        let lastAppliedBonus = 0;
        let dividedBonusAmount = 0; // New variable to store the divided bonus amount

        // Store draft numbers for each customer
        const customerDrafts = {};

        function formatNumber(input) {
            // Special handling for ROI input - allow decimals
            if (input.classList.contains('roi-input')) {
                let value = input.value.replace(/[^0-9.]/g, ''); // Allow numbers and decimal point
                if (value === '') return;

                // Ensure only one decimal point
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }

                // Limit to 2 decimal places
                if (parts.length === 2 && parts[1].length > 2) {
                    value = parts[0] + '.' + parts[1].substring(0, 2);
                }

                const num = parseFloat(value);
                if (isNaN(num)) {
                    input.value = '';
                    return;
                }

                // Format without rounding
                input.value = num.toString() + '%';
                return;
            }

            // For all other inputs - round to whole numbers
            let value = input.value.replace(/[^0-9.]/g, ''); // Allow decimal temporarily for parsing
            if (value === '') return;

            // Parse as float first to handle any decimal input, then round to integer
            const num = Math.round(parseFloat(value));
            if (isNaN(num)) {
                input.value = '';
                return;
            }

            // Format with Indian comma format - integer only
            input.value = num.toLocaleString('en-IN', {maximumFractionDigits: 0});

            // Ensure the input has the right styling for large numbers
            input.style.textAlign = 'left';
            input.style.paddingLeft = '8px';
            input.style.fontSize = '13px';

            // Adjust font size for very large numbers
            if (num >= 10000000) { // 1 crore or more
                input.style.fontSize = '12px';
            }

            // Check if this is an Outstanding or EMI input and update totals
            if (input.classList.contains('os-input') || input.classList.contains('emi-input')) {
                const row = input.closest('tr');
                const actionState = row.querySelector('.action-state').value;

                // If this row has an action applied, recalculate totals
                if (actionState === 'BT' || actionState === 'Obligate') {
                    recalculateTotals();
                }
            }
        }

        function parseIndianNumber(str) {
            if (!str) return 0;

            // If it's already a number, return it
            if (typeof str === 'number') return str;

            // Convert to string if it's not already
            const strValue = String(str);

            // Remove all non-numeric characters, then parse as integer
            return parseInt(strValue.replace(/[^0-9]/g, '')) || 0;
        }

        // Function to handle Indian number format specifically
        function handleIndianNumberFormat(value) {
            if (!value) return '';

            // If it's already a formatted string with commas (like "1,10,000"), return it as is
            if (typeof value === 'string' && value.includes(',')) {
                console.log("Preserving formatted number:", value);
                return value;
            }

            // If it's a number or a string representation of a number without commas
            const numValue = parseFloat(String(value).replace(/[^0-9.]/g, ''));
            if (!isNaN(numValue)) {
                // Format with Indian number format
                const formatted = Math.round(numValue).toLocaleString('en-IN');
                console.log(`Formatted ${value} to ${formatted}`);
                return formatted;
            }

            // If all else fails, return the original value
            return value;
        }

        function calculateTotal() {
            const salary = parseIndianNumber(document.getElementById('salary').value);
            const partnerSalary = parseIndianNumber(document.getElementById('partnerSalary').value);

            // Include the divided bonus amount in the total income calculation
            // Only if a bonus button is active (activeBonusButton is set)
            let bonusToAdd = 0;
            if (activeBonusButton !== null) {
                bonusToAdd = dividedBonusAmount;
            }

            // Calculate total income (salary + partner's salary + divided bonus)
            const totalIncome = salary + partnerSalary + bonusToAdd;

            // Update the Total Income field
            const eligibilityTotalIncome = document.getElementById('eligibilityTotalIncome');
            if (eligibilityTotalIncome) {
                // Round to ensure no decimals and format with Indian number format
                eligibilityTotalIncome.value = Math.round(totalIncome).toLocaleString('en-IN', {maximumFractionDigits: 0});
            }

            // Update the total display element if it exists
            const totalDisplay = document.getElementById('total');
            if (totalDisplay) {
                totalDisplay.textContent = Math.round(totalIncome).toLocaleString('en-IN', {maximumFractionDigits: 0});
            }
        }

        function updateDisplayValues() {
            const btPosInput = document.getElementById('totalBtPos');
            const obligationInput = document.getElementById('totalObligation');

            // Round to ensure no decimals and format with Indian number format
            btPosInput.value = Math.round(totalBtPos).toLocaleString('en-IN', {maximumFractionDigits: 0});
            obligationInput.value = Math.round(totalObligation).toLocaleString('en-IN', {maximumFractionDigits: 0});

            // Adjust font size for very large numbers
            if (totalBtPos >= 10000000) { // 1 crore or more
                btPosInput.style.fontSize = '12px';
            } else {
                btPosInput.style.fontSize = '14px';
            }

            if (totalObligation >= 10000000) { // 1 crore or more
                obligationInput.style.fontSize = '12px';
            } else {
                obligationInput.style.fontSize = '14px';
            }

            // Ensure left alignment
            btPosInput.style.textAlign = 'left';
            btPosInput.style.paddingLeft = '10px';
            obligationInput.style.textAlign = 'left';
            obligationInput.style.paddingLeft = '10px';

            // Update the eligibility total obligation field
            updateEligibilityTotalObligation();
        }

        function recalculateTotals() {
            console.log("recalculateTotals called");
            totalBtPos = 0;
            totalObligation = 0;

            const rows = document.querySelectorAll('#obligationsBody tr');
            rows.forEach(row => {
                try {
                    const btAppliedElement = row.querySelector('.bt-applied');
                    const obligateAppliedElement = row.querySelector('.obligate-applied');

                    if (!btAppliedElement || !obligateAppliedElement) {
                        console.warn("Missing bt-applied or obligate-applied elements in row:", row);
                        return;
                    }

                    const btApplied = btAppliedElement.value === 'true';
                    const obligateApplied = obligateAppliedElement.value === 'true';
                    const actionStateElement = row.querySelector('.action-state');
                    const actionState = actionStateElement ? actionStateElement.value : '';

                    const osInput = row.querySelector('.os-input');
                    const emiInput = row.querySelector('.emi-input');

                    if (!osInput || !emiInput) {
                        console.warn("Missing os-input or emi-input elements in row:", row);

                        // Try to fix the row by adding the missing classes
                        if (!osInput && row.querySelector('.outstanding-cell input')) {
                            const input = row.querySelector('.outstanding-cell input');
                            input.className += ' os-input';
                            console.log("Added os-input class to input in outstanding-cell");
                        }

                        if (!emiInput && row.querySelector('.emi-cell input')) {
                            const input = row.querySelector('.emi-cell input');
                            input.className += ' emi-input';
                            console.log("Added emi-input class to input in emi-cell");
                        }

                        // Try again with the fixed elements
                        const fixedOsInput = row.querySelector('.os-input');
                        const fixedEmiInput = row.querySelector('.emi-input');

                        if (!fixedOsInput || !fixedEmiInput) {
                            console.error("Still missing inputs after fix attempt, skipping row");
                            return;
                        }
                    }

                    // Get the inputs again in case they were fixed
                    const finalOsInput = row.querySelector('.os-input');
                    const finalEmiInput = row.querySelector('.emi-input');

                    const osValue = parseIndianNumber(finalOsInput.value || '0');
                    const emiValue = parseIndianNumber(finalEmiInput.value || '0');

                    console.log(`Row action state: ${actionState}, BT=${btApplied}, Obligate=${obligateApplied}, OS=${osValue}, EMI=${emiValue}`);

                    if (btApplied) totalBtPos += osValue;

                    // For CO-PAY, add only half of the EMI amount to total obligation
                    if (obligateApplied) {
                        if (actionState === 'CO-PAY') {
                            totalObligation += Math.round(emiValue / 2);
                            console.log(`CO-PAY: Adding half EMI (${Math.round(emiValue / 2)}) to total obligation`);
                        } else {
                            totalObligation += emiValue;
                        }
                    }
                } catch (error) {
                    console.error("Error processing row:", error, row);
                }
            });

            console.log(`Total BT POS: ${totalBtPos}, Total Obligation: ${totalObligation}`);

            // Update display values in the main section
            updateDisplayValues();

            // Update eligibility section values
            const eligibilityTotalObligation = document.getElementById('eligibilityTotalObligation');
            const eligibilityTotalBtPos = document.getElementById('eligibilityTotalBtPos');

            if (eligibilityTotalObligation) {
                eligibilityTotalObligation.value = Math.round(totalObligation).toLocaleString('en-IN', {maximumFractionDigits: 0});
                console.log(`Updated eligibilityTotalObligation to ${eligibilityTotalObligation.value}`);
            } else {
                console.warn("eligibilityTotalObligation element not found");
            }

            if (eligibilityTotalBtPos) {
                eligibilityTotalBtPos.value = Math.round(totalBtPos).toLocaleString('en-IN', {maximumFractionDigits: 0});
                console.log(`Updated eligibilityTotalBtPos to ${eligibilityTotalBtPos.value}`);
            } else {
                console.warn("eligibilityTotalBtPos element not found");
            }

            // Calculate monthly EMI can pay
            if (typeof calculateMonthlyEmiCanPay === 'function') {
                try {
                    calculateMonthlyEmiCanPay();
                    console.log("calculateMonthlyEmiCanPay executed successfully");
                } catch (error) {
                    console.error("Error in calculateMonthlyEmiCanPay:", error);
                }
            } else {
                console.warn("calculateMonthlyEmiCanPay function not found");
            }

            // Recalculate eligibility
            if (typeof calculateEligibility === 'function') {
                try {
                    calculateEligibility();
                    console.log("calculateEligibility executed successfully");
                } catch (error) {
                    console.error("Error in calculateEligibility:", error);
                }
            } else {
                console.warn("calculateEligibility function not found");
            }
        }

        // Add a test row with maximum values to check visibility
        function addTestRow() {
            const tbody = document.getElementById('obligationsBody');

            // Clear existing rows
            tbody.innerHTML = '';

            // Create test row with maximum values
            const testRow = document.createElement('tr');
            testRow.innerHTML = `
                <td class="row-number" style="text-align: center; font-weight: bold;">1</td>
                <td class="product-cell">
                    <div class="custom-select-wrapper">
                        <textarea class="product-display very-long-text" readonly rows="2">LAP (Loan Against Property)</textarea>
                        <input type="hidden" class="product-value" value="LAP (Loan Against Property)">
                        <div class="custom-select-dropdown">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search products...">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-option" data-value="">Select Product</div>
                                <div class="custom-option selected" data-value="LAP (Loan Against Property)">LAP (Loan Against Property)</div>
                            </div>
                        </div>
                    </div>
                </td>
                <td class="bank-cell">
                    <div class="custom-select-wrapper bank-select-wrapper">
                        <textarea class="bank-display very-long-text" readonly rows="2">Cholamandalam Investment and Finance</textarea>
                        <input type="hidden" class="bank-value" value="Cholamandalam Investment and Finance">
                        <div class="custom-select-dropdown bank-dropdown">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search banks...">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-option" data-value="">Select Bank</div>
                                <div class="custom-option selected" data-value="Cholamandalam Investment and Finance">Cholamandalam Investment and Finance</div>
                            </div>
                        </div>
                    </div>
                </td>
                <td><input type="text" class="number-input tenure-input" value="360 Months" placeholder="months" maxlength="3" style="text-align: left;"></td>
                <td class="roi-cell"><input type="text" class="number-input roi-input" value="50.55%" placeholder="%" maxlength="6" style="text-align: left;"></td>
                <td class="loan-amount-cell"><input type="text" class="number-input very-long-length" value="100,000,000" oninput="formatNumber(this)" placeholder="Total loan"></td>
                <td class="outstanding-cell"><input type="text" class="number-input os-input very-long-length" value="100,000,000" oninput="formatNumber(this)" placeholder="Outstanding"></td>
                <td class="emi-cell"><input type="text" class="number-input emi-input long-length" value="5,000,000" oninput="formatNumber(this)" placeholder="EMI amount"></td>
                <td class="actions-cell">
                    <select class="action-select" onchange="setAction(this)" style="width: 100%; height: 24px; background-color: #FFFFFF; border: 1px solid #ccc; border-radius: 4px; text-align: left; font-size: 12px; font-weight: 700; padding: 3px 5px;">
                        <option value="">Select Action</option>
                        <option value="BT">BT</option>
                        <option value="Obligate">Obligate</option>
                        <option value="CO-PAY">CO-PAY</option>
                        <option value="NO-PAY">NO-PAY</option>
                        <option value="Closed">Closed</option>
                    </select>
                    <input type="hidden" class="action-state" value="">
                    <input type="hidden" class="bt-applied" value="false">
                    <input type="hidden" class="obligate-applied" value="false">
                </td>
                <td>
                    <button class="delete-btn" onclick="deleteRow(this, event)" oncontextmenu="deleteRow(this, event); return false;" title="Click to delete row">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(testRow);

            // Add a second test row with different values
            const testRow2 = document.createElement('tr');
            testRow2.innerHTML = `
                <td class="row-number" style="text-align: center; font-weight: bold;">2</td>
                <td class="product-cell">
                    <div class="custom-select-wrapper">
                        <textarea class="product-display" readonly rows="2">PL (Personal Loan)</textarea>
                        <input type="hidden" class="product-value" value="PL (Personal Loan)">
                        <div class="custom-select-dropdown">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search products...">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-option" data-value="">Select Product</div>
                                <div class="custom-option selected" data-value="PL (Personal Loan)">PL (Personal Loan)</div>
                            </div>
                        </div>
                    </div>
                </td>
                <td class="bank-cell">
                    <div class="custom-select-wrapper bank-select-wrapper">
                        <textarea class="bank-display" readonly rows="2">HDFC Bank</textarea>
                        <input type="hidden" class="bank-value" value="HDFC Bank">
                        <div class="custom-select-dropdown bank-dropdown">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search banks...">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-option" data-value="">Select Bank</div>
                                <div class="custom-option selected" data-value="HDFC Bank">HDFC Bank</div>
                            </div>
                        </div>
                    </div>
                </td>
                <td><input type="text" class="number-input tenure-input" value="60 Months" placeholder="months" maxlength="3" style="text-align: left;"></td>
                <td class="roi-cell"><input type="text" class="number-input roi-input" value="12.5%" placeholder="%" maxlength="6" style="text-align: left;"></td>
                <td class="loan-amount-cell"><input type="text" class="number-input" value="500,000" oninput="formatNumber(this)" placeholder="Total loan"></td>
                <td class="outstanding-cell"><input type="text" class="number-input os-input" value="450,000" oninput="formatNumber(this)" placeholder="Outstanding"></td>
                <td class="emi-cell"><input type="text" class="number-input emi-input" value="10,000" oninput="formatNumber(this)" placeholder="EMI"></td>
                <td class="actions-cell">
                    <select class="action-select" onchange="setAction(this)" style="width: 100%; height: 24px; background-color: #4CD964; border: 1px solid #ccc; border-radius: 4px; text-align: left; font-size: 12px; font-weight: 700; padding: 3px 5px;">
                        <option value="">Select Action</option>
                        <option value="BT" selected>BT</option>
                        <option value="Obligate">Obligate</option>
                        <option value="CO-PAY">CO-PAY</option>
                        <option value="NO-PAY">NO-PAY</option>
                        <option value="Closed">Closed</option>
                    </select>
                    <input type="hidden" class="action-state" value="BT">
                    <input type="hidden" class="bt-applied" value="true">
                    <input type="hidden" class="obligate-applied" value="false">
                </td>
                <td>
                    <button class="delete-btn" onclick="deleteRow(this, event)" oncontextmenu="deleteRow(this, event); return false;" title="Click to delete row">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(testRow2);

            // Add a regular empty row for comparison
            addRegularRow();

            // Apply font size adjustments
            setTimeout(adjustFontSize, 100);
        }

        // Regular row addition function
        function addRegularRow() {
            console.log("Adding new row...");
            const tbody = document.getElementById('obligationsBody');

            if (!tbody) {
                console.error("Could not find obligationsBody element");
                alert("Error: Could not find table body. Please refresh the page and try again.");
                return;
            }

            // Ensure the table container has no height restriction
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.style.maxHeight = 'none';
                tableContainer.style.overflowY = 'visible';
            }

            const row = document.createElement('tr');

            // Get the current number of rows and add 1 for the new row number
            const rowCount = tbody.querySelectorAll('tr').length + 1;
            console.log(`Creating row #${rowCount}`);

            // Set initial white background for the row
            row.style.backgroundColor = '#FFFFFF';
            row.innerHTML = `
                <td class="row-number" style="text-align: center; font-weight: bold;">${rowCount}</td>
                <td class="product-cell">
                    <div class="custom-select-wrapper">
                        <textarea class="product-display" readonly placeholder="Select Product" rows="1" style="background-color: #FFFFFF; height: 24px; min-height: 24px; overflow: hidden; resize: none; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></textarea>
                        <input type="hidden" class="product-value">
                        <div class="custom-select-dropdown">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search products...">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-option" data-value="">Select Product</div>
                                <div class="custom-option" data-value="PL (Personal Loan)">1. PL (Personal Loan)</div>
                                <div class="custom-option" data-value="OD (Overdraft)">2. OD (Overdraft)</div>
                                <div class="custom-option" data-value="CC (Credit Card)">3. CC (Credit Card)</div>
                                <div class="custom-option" data-value="BL (Business Loan)">4. BL (Business Loan)</div>
                                <div class="custom-option" data-value="HL (Home Loan)">5. HL (Home Loan)</div>
                                <div class="custom-option" data-value="LAP (Loan Against Property)">6. LAP (Loan Against Property)</div>
                                <div class="custom-option" data-value="AL (Auto Loan/ Car Loan)">7. AL (Auto Loan/ Car Loan)</div>
                                <div class="custom-option" data-value="EL (Education Loan)">8. EL (Education Loan)</div>
                                <div class="custom-option" data-value="GL (Gold Loan)">9. GL (Gold Loan)</div>
                                <div class="custom-option" data-value="LOC (Loan On Credit Card)">10. LOC (Loan On Credit Card)</div>
                                <div class="custom-option" data-value="CD (Consumer Durable Loan)">11. CD (Consumer Durable Loan)</div>
                                <div class="custom-option" data-value="APP LOAN">12. APP LOAN</div>
                                <div class="custom-option" data-value="INSURANCE">13. INSURANCE</div>
                            </div>
                        </div>
                    </div>
                </td>
                <td class="bank-cell">
                    <div class="custom-select-wrapper bank-select-wrapper">
                        <textarea class="bank-display" readonly placeholder="Select Bank" rows="1" style="background-color: #FFFFFF; height: 24px; min-height: 24px; overflow: hidden; resize: none; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></textarea>
                        <input type="hidden" class="bank-value">
                        <div class="custom-select-dropdown bank-dropdown">
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search banks...">
                            </div>
                            <div class="custom-select-options">
                                <div class="custom-option" data-value="">Select Bank</div>
                                <!-- Private Banks -->
                                <div class="custom-option" data-value="Axis Bank">1. Axis Bank</div>
                                <div class="custom-option" data-value="Bandhan Bank">2. Bandhan Bank</div>
                                <div class="custom-option" data-value="City Union Bank">3. City Union Bank</div>
                                <div class="custom-option" data-value="CSB Bank">4. CSB Bank</div>
                                <div class="custom-option" data-value="DCB Bank">5. DCB Bank</div>
                                <div class="custom-option" data-value="Dhanlaxmi Bank">6. Dhanlaxmi Bank</div>
                                <div class="custom-option" data-value="Federal Bank">7. Federal Bank</div>
                                <div class="custom-option" data-value="HDFC Bank">8. HDFC Bank</div>
                                <div class="custom-option" data-value="ICICI Bank">9. ICICI Bank</div>
                                <div class="custom-option" data-value="IDBI Bank">10. IDBI Bank</div>
                                <div class="custom-option" data-value="IDFC FIRST Bank">11. IDFC FIRST Bank</div>
                                <div class="custom-option" data-value="IndusInd Bank">12. IndusInd Bank</div>
                                <div class="custom-option" data-value="Karnataka Bank">13. Karnataka Bank</div>
                                <div class="custom-option" data-value="Kotak Mahindra Bank">14. Kotak Mahindra Bank</div>
                                <div class="custom-option" data-value="Nainital Bank">15. Nainital Bank</div>
                                <div class="custom-option" data-value="RBL Bank">16. RBL Bank</div>
                                <div class="custom-option" data-value="South Indian Bank">17. South Indian Bank</div>
                                <div class="custom-option" data-value="Tamilnad Mercantile Bank">18. Tamilnad Mercantile Bank</div>
                                <div class="custom-option" data-value="YES Bank">19. YES Bank</div>

                                <!-- Public Banks -->
                                <div class="custom-option" data-value="Bank of Baroda">20. Bank of Baroda</div>
                                <div class="custom-option" data-value="Bank of India">21. Bank of India</div>
                                <div class="custom-option" data-value="Bank of Maharashtra">22. Bank of Maharashtra</div>
                                <div class="custom-option" data-value="Canara Bank">23. Canara Bank</div>
                                <div class="custom-option" data-value="Central Bank of India">24. Central Bank of India</div>
                                <div class="custom-option" data-value="Indian Bank">25. Indian Bank</div>
                                <div class="custom-option" data-value="Indian Overseas Bank">26. Indian Overseas Bank</div>
                                <div class="custom-option" data-value="PNB Bank">27. PNB Bank</div>
                                <div class="custom-option" data-value="Punjab & Sind Bank">28. Punjab & Sind Bank</div>
                                <div class="custom-option" data-value="SBI Bank">29. SBI Bank</div>
                                <div class="custom-option" data-value="UCO Bank">30. UCO Bank</div>

                                <!-- NBFCs -->
                                <div class="custom-option" data-value="Aditya Birla Capital">31. Aditya Birla Capital</div>
                                <div class="custom-option" data-value="Bajaj Finance">32. Bajaj Finance</div>
                                <div class="custom-option" data-value="Bajaj Finserv">33. Bajaj Finserv</div>
                                <div class="custom-option" data-value="Capri Global Capital">34. Capri Global Capital</div>
                                <div class="custom-option" data-value="Cholamandalam Investment and Finance">35. Cholamandalam Investment and Finance</div>
                                <div class="custom-option" data-value="Edelweiss Financial Services">36. Edelweiss Financial Services</div>
                                <div class="custom-option" data-value="Fullerton India">37. Fullerton India</div>
                                <div class="custom-option" data-value="HDB Financial Services">38. HDB Financial Services</div>
                                <div class="custom-option" data-value="IIFL Finance">39. IIFL Finance</div>
                                <div class="custom-option" data-value="InCred Finance">40. InCred Finance</div>
                                <div class="custom-option" data-value="JM Financial">41. JM Financial</div>
                                <div class="custom-option" data-value="L&T Finance">42. L&T Finance</div>
                                <div class="custom-option" data-value="Mahindra Finance">43. Mahindra Finance</div>
                                <div class="custom-option" data-value="Mas Financial Services">44. Mas Financial Services</div>
                                <div class="custom-option" data-value="Motilal Oswal Financial Services">45. Motilal Oswal Financial Services</div>
                                <div class="custom-option" data-value="Muthoot Finance">46. Muthoot Finance</div>
                                <div class="custom-option" data-value="Piramal Capital & Housing Finance">47. Piramal Capital & Housing Finance</div>
                                <div class="custom-option" data-value="Poonawalla Fincorp">48. Poonawalla Fincorp</div>
                                <div class="custom-option" data-value="Reliance Capital">49. Reliance Capital</div>
                                <div class="custom-option" data-value="Shriram Finance">50. Shriram Finance</div>
                                <div class="custom-option" data-value="Srei Infrastructure Finance">51. Srei Infrastructure Finance</div>
                                <div class="custom-option" data-value="Tata Capital">52. Tata Capital</div>
                                <div class="custom-option" data-value="Ugro Capital">53. Ugro Capital</div>
                                <div class="custom-option" data-value="Vistaar Financial Services">54. Vistaar Financial Services</div>

                                <!-- Fintechs -->
                                <div class="custom-option" data-value="50Fin">55. 50Fin</div>
                                <div class="custom-option" data-value="Capital Float">56. Capital Float</div>
                                <div class="custom-option" data-value="CASHe">57. CASHe</div>
                                <div class="custom-option" data-value="Credy">58. Credy</div>
                                <div class="custom-option" data-value="Dhani">59. Dhani</div>
                                <div class="custom-option" data-value="DMI Finance">60. DMI Finance</div>
                                <div class="custom-option" data-value="Faircent">61. Faircent</div>
                                <div class="custom-option" data-value="Fibe">62. Fibe</div>
                                <div class="custom-option" data-value="Finnable">63. Finnable</div>
                                <div class="custom-option" data-value="FlexSalary">64. FlexSalary</div>
                                <div class="custom-option" data-value="Hero FinCorp">65. Hero FinCorp</div>
                                <div class="custom-option" data-value="Home Credit India">66. Home Credit India</div>
                                <div class="custom-option" data-value="i2iFunding">67. i2iFunding</div>
                                <div class="custom-option" data-value="IndiaLends">68. IndiaLends</div>
                                <div class="custom-option" data-value="Kissht">69. Kissht</div>
                                <div class="custom-option" data-value="KreditBee">70. KreditBee</div>
                                <div class="custom-option" data-value="LazyPay">71. LazyPay</div>
                                <div class="custom-option" data-value="LenDenClub">72. LenDenClub</div>
                                <div class="custom-option" data-value="Lendingkart">73. Lendingkart</div>
                                <div class="custom-option" data-value="LoanTap">74. LoanTap</div>
                                <div class="custom-option" data-value="MoneyTap">75. MoneyTap</div>
                                <div class="custom-option" data-value="Moneyview">76. Moneyview</div>
                                <div class="custom-option" data-value="Monexo">77. Monexo</div>
                                <div class="custom-option" data-value="mPokket">78. mPokket</div>
                                <div class="custom-option" data-value="Navi">79. Navi</div>
                                <div class="custom-option" data-value="NIRA Finance">80. NIRA Finance</div>
                                <div class="custom-option" data-value="NoBroker InstaCash">81. NoBroker InstaCash</div>
                                <div class="custom-option" data-value="PayMe">82. PayMe</div>
                                <div class="custom-option" data-value="PaySense">83. PaySense</div>
                                <div class="custom-option" data-value="RapidRupee">84. RapidRupee</div>
                                <div class="custom-option" data-value="RupeeLend">85. RupeeLend</div>
                                <div class="custom-option" data-value="Rupifi">86. Rupifi</div>
                                <div class="custom-option" data-value="SmartCoin">87. SmartCoin</div>
                                <div class="custom-option" data-value="StashFin">88. StashFin</div>
                                <div class="custom-option" data-value="Svatantra Microfin">89. Svatantra Microfin</div>
                                <div class="custom-option" data-value="ZestMoney">90. ZestMoney</div>

                                <!-- Foreign Banks -->
                                <div class="custom-option" data-value="American Express Banking Corp">91. American Express Banking Corp</div>
                                <div class="custom-option" data-value="Bank of China">92. Bank of China</div>
                                <div class="custom-option" data-value="Barclays Bank">93. Barclays Bank</div>
                                <div class="custom-option" data-value="Citibank">94. Citibank</div>
                                <div class="custom-option" data-value="DBS Bank">95. DBS Bank</div>
                                <div class="custom-option" data-value="Deutsche Bank">96. Deutsche Bank</div>
                                <div class="custom-option" data-value="HSBC">97. HSBC</div>
                                <div class="custom-option" data-value="SBM Bank">98. SBM Bank</div>
                                <div class="custom-option" data-value="Standard Chartered Bank">99. Standard Chartered Bank</div>

                                <!-- Small Finance Banks -->
                                <div class="custom-option" data-value="AU Small Finance Bank">100. AU Small Finance Bank</div>
                                <div class="custom-option" data-value="Capital Small Finance Bank">101. Capital Small Finance Bank</div>
                                <div class="custom-option" data-value="Equitas Small Finance Bank">102. Equitas Small Finance Bank</div>
                                <div class="custom-option" data-value="Jana Small Finance Bank">103. Jana Small Finance Bank</div>
                                <div class="custom-option" data-value="North East Small Finance Bank">104. North East Small Finance Bank</div>
                                <div class="custom-option" data-value="Shivalik Small Finance Bank">105. Shivalik Small Finance Bank</div>
                                <div class="custom-option" data-value="Ujjivan Small Finance Bank">106. Ujjivan Small Finance Bank</div>
                                <div class="custom-option" data-value="Utkarsh Small Finance Bank">107. Utkarsh Small Finance Bank</div>
                                <div class="custom-option" data-value="OTHER">108. OTHER</div>
                            </div>
                        </div>
                    </div>
                </td>
                <td><input type="text" class="number-input tenure-input" placeholder="months" maxlength="3" style="text-align: left; background-color: #FFFFFF; height: 24px; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></td>
                <td class="roi-cell"><input type="text" class="number-input roi-input" placeholder="%" maxlength="6" style="text-align: left; background-color: #FFFFFF; height: 24px; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></td>
                <td class="loan-amount-cell"><input type="text" class="number-input" oninput="formatNumber(this)" placeholder="Total loan" style="background-color: #FFFFFF; height: 24px; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></td>
                <td class="outstanding-cell"><input type="text" class="number-input os-input" oninput="formatNumber(this)" placeholder="Outstanding" style="background-color: #FFFFFF; height: 24px; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></td>
                <td class="emi-cell"><input type="text" class="number-input emi-input" oninput="formatNumber(this)" placeholder="EMI" style="background-color: #FFFFFF; height: 24px; padding: 3px 6px; font-size: 0.9rem; font-weight: 600; color: #000000;"></td>
                <td class="actions-cell">
                    <select class="action-select" onchange="setAction(this)" style="width: 100%; height: 24px; background-color: #FFFF00; border: 1px solid #ccc; border-radius: 4px; text-align: left; font-size: 12px; font-weight: 700; padding: 3px 5px;">
                        <option value="">Select Action</option>
                        <option value="BT">BT</option>
                        <option value="Obligate" selected>Obligate</option>
                        <option value="CO-PAY">CO-PAY</option>
                        <option value="NO-PAY">NO-PAY</option>
                        <option value="Closed">Closed</option>
                    </select>
                    <input type="hidden" class="action-state" value="Obligate">
                    <input type="hidden" class="bt-applied" value="false">
                    <input type="hidden" class="obligate-applied" value="true">
                </td>
                <td>
                    <button class="delete-btn" onclick="deleteRow(this, event)" oncontextmenu="deleteRow(this, event); return false;" title="Click to delete row">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            try {
                // Append the row to the tbody
                tbody.appendChild(row);
                console.log("Successfully added new row to table");

                // Ensure the Calculate Eligibility section is pushed down
                const obligationsSection = document.querySelector('.obligations-section');
                if (obligationsSection) {
                    // Force a reflow to ensure the table expands properly
                    obligationsSection.style.display = 'flex';
                    obligationsSection.style.flexDirection = 'column';

                    // Make sure there's enough space between sections
                    obligationsSection.style.marginBottom = '20px';
                }

                // Scroll to the newly added row
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (error) {
                console.error("Error appending row to table:", error);
                alert("Error adding new row. Please try again.");
            }

            // Initialize the product dropdown in the new row
            initializeNewProductDropdown(row);

            // Initialize the tenure input in the new row
            const tenureInput = row.querySelector('.tenure-input');
            if (tenureInput) {
                tenureInput.addEventListener('input', formatTenureInput);
                tenureInput.addEventListener('blur', formatTenureInput);
                tenureInput.addEventListener('click', handleTenureInputClick);
                tenureInput.addEventListener('focus', handleTenureInputClick);
            }

            // Initialize the ROI input in the new row
            const roiInput = row.querySelector('.roi-input');
            if (roiInput) {
                roiInput.addEventListener('input', formatRoiInput);
                roiInput.addEventListener('blur', formatRoiInput);
                roiInput.addEventListener('click', handleRoiInputClick);
                roiInput.addEventListener('focus', handleRoiInputClick);
            }

            // Trigger the setAction function to apply the default "Obligate" action
            const actionSelect = row.querySelector('.action-select');
            if (actionSelect) {
                setAction(actionSelect);
            }

            // Reinitialize all dropdowns to ensure they work properly in all rows
            setTimeout(function() {
                console.log("Reinitializing all dropdowns after adding new row");
                reinitializeAllCustomDropdowns();
            }, 100);

            sortRows();
        }

        function deleteRow(btn, event) {
            // Allow both left-click and right-click (contextmenu) events
            // No need to check event type anymore

            const tbody = document.getElementById('obligationsBody');
            const row = btn.closest('tr');

            if (tbody.children.length > 1) {
                // Remove the row
                row.remove();

                // Recalculate totals from scratch instead of manually adjusting
                // This ensures accurate totals even after Excel import
                recalculateTotals();

                // Update row numbers for remaining rows based on their position
                const remainingRows = tbody.querySelectorAll('tr');
                remainingRows.forEach((row, index) => {
                    const rowNumberCell = row.querySelector('.row-number');
                    if (rowNumberCell) {
                        // Update the row number based on its current position
                        rowNumberCell.textContent = (index + 1).toString();
                    }
                });

                // Sort the rows based on action
                sortRows();
            }
        }

        function setAction(select) {
            const row = select.closest('tr');
            const actionStateInput = row.querySelector('.action-state');
            const btAppliedInput = row.querySelector('.bt-applied');
            const obligateAppliedInput = row.querySelector('.obligate-applied');

            // Find the outstanding and EMI inputs correctly
            const osInput = row.querySelector('.os-input');
            const emiInput = row.querySelector('.emi-input');

            const osValue = osInput ? parseIndianNumber(osInput.value || '0') : 0;
            const emiValue = emiInput ? parseIndianNumber(emiInput.value || '0') : 0;

            // If no action is selected, default to "Obligate"
            let action = select.value;
            if (!action) {
                action = "Obligate";
                select.value = action;
                // Find the Obligate option and select it
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === "Obligate") {
                        select.options[i].selected = true;
                        break;
                    }
                }
            }

            // Set the data-text attribute to make the text visible
            const selectedOption = select.options[select.selectedIndex];
            const selectedText = selectedOption ? selectedOption.textContent : '';
            select.setAttribute('data-text', selectedText);

            // Force the select to have the correct styling
            select.style.height = '24px';
            select.style.width = '100%';
            select.style.textAlign = 'left';
            select.style.fontWeight = '700';
            select.style.fontSize = '12px';
            select.style.textTransform = 'none';
            select.style.borderRadius = '4px';
            select.style.border = '1px solid #ccc';
            select.style.padding = '3px 5px';
            select.style.color = '#000000'; // Ensure text is black

            console.log("Setting action to:", action);
            console.log("Selected text:", selectedText);
            console.log("Row:", row);
            console.log("OS Value:", osValue);
            console.log("EMI Value:", emiValue);

            // Update the select element styling based on the selected action
            if (action === 'BT') {
                select.style.backgroundColor = '#4CD964'; // Green
                select.style.color = '#000000';
                select.style.fontWeight = '700';
                select.style.textAlign = 'left';
                select.style.fontSize = '12px';
                select.style.height = '24px';
                select.style.padding = '3px 5px';
                select.style.border = '1px solid #ccc';
                select.style.textTransform = 'none';
            } else if (action === 'Obligate') {
                select.style.backgroundColor = '#FFFF00'; // Yellow
                select.style.color = '#000000';
                select.style.fontWeight = '700';
                select.style.textAlign = 'left';
                select.style.fontSize = '12px';
                select.style.height = '24px';
                select.style.padding = '3px 5px';
                select.style.border = '1px solid #ccc';
                select.style.textTransform = 'none';
            } else if (action === 'CO-PAY') {
                select.style.backgroundColor = '#FFA500'; // Bright Orange
                select.style.color = '#000000';
                select.style.fontWeight = '700';
                select.style.textAlign = 'left';
                select.style.fontSize = '12px';
                select.style.height = '24px';
                select.style.padding = '3px 5px';
                select.style.border = '1px solid #ccc';
                select.style.textTransform = 'none';
            } else if (action === 'Closed') {
                select.style.backgroundColor = '#FF0000'; // Red
                select.style.color = '#000000';
                select.style.fontWeight = '700';
                select.style.textAlign = 'left';
                select.style.fontSize = '12px';
                select.style.height = '24px';
                select.style.padding = '3px 5px';
                select.style.border = '1px solid #ccc';
                select.style.textTransform = 'none';
            } else if (action === 'NO-PAY') {
                select.style.backgroundColor = '#0080FF'; // Bright Blue
                select.style.color = '#000000';
                select.style.fontWeight = '700';
                select.style.textAlign = 'left';
                select.style.fontSize = '12px';
                select.style.height = '24px';
                select.style.padding = '3px 5px';
                select.style.border = '1px solid #ccc';
                select.style.textTransform = 'none';
            } else {
                select.style.backgroundColor = '#FFFFFF'; // White
                select.style.color = '#000000';
                select.style.fontWeight = '700';
                select.style.textAlign = 'left';
                select.style.fontSize = '12px';
                select.style.height = '24px';
                select.style.padding = '3px 5px';
                select.style.border = '1px solid #ccc';
                select.style.textTransform = 'none';
            }

            // Remove previous contributions
            if (btAppliedInput.value === 'true') {
                totalBtPos -= osValue;
                btAppliedInput.value = 'false';
            }
            if (obligateAppliedInput.value === 'true') {
                totalObligation -= emiValue;
                obligateAppliedInput.value = 'false';
            }

            // Reset row and cell styles
            row.classList.remove('green-row', 'orange-row', 'red-row');

            // Remove highlight classes from cells
            const outstandingCell = row.querySelector('.outstanding-cell');
            const emiCell = row.querySelector('.emi-cell');
            if (outstandingCell) outstandingCell.classList.remove('green-bg');
            if (emiCell) emiCell.classList.remove('orange-bg');

            // Get all elements in the row
            const productDisplay = row.querySelector('.product-display');
            const bankDisplay = row.querySelector('.bank-display');
            const tenureInput = row.querySelector('.tenure-input');
            const roiInput = row.querySelector('.roi-input');
            const totalLoanInput = row.querySelector('.loan-amount-cell input');
            const outstandingInput = row.querySelector('.outstanding-cell input');
            const emiAmountInput = row.querySelector('.emi-cell input');

            // Get all cells
            const allCells = row.querySelectorAll('td');

            // Reset all inputs to default style
            [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                if (input) {
                    input.style.backgroundColor = '#FFFFFF';
                    input.style.color = '#000000';
                    input.style.fontWeight = '700';
                    input.style.fontSize = '12px'; // Reset font size to default
                }
            });

            // Apply new action
            actionStateInput.value = action;
            if (action === 'BT') {
                row.classList.add('green-row');
                totalBtPos += osValue;
                btAppliedInput.value = 'true';

                // Apply green background to all cells
                allCells.forEach(cell => {
                    cell.style.backgroundColor = '#4CD964';
                });

                // Apply green background to all inputs
                [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                    if (input) {
                        input.style.backgroundColor = '#4CD964';
                        input.style.color = '#000000';
                        input.style.fontWeight = '700';
                    }
                });

                // Highlight the Outstanding input for BT action
                if (outstandingInput) {
                    outstandingInput.style.fontSize = '20px';  // Increased from 18px to 20px
                    outstandingInput.style.fontWeight = '900';

                    // Add green-bg class to the outstanding cell
                    const outstandingCell = row.querySelector('.outstanding-cell');
                    if (outstandingCell) {
                        outstandingCell.classList.add('green-bg');
                    }
                }

            } else if (action === 'Obligate') {
                row.classList.add('orange-row');
                totalObligation += emiValue;
                obligateAppliedInput.value = 'true';

                // Apply yellow background to all cells
                allCells.forEach(cell => {
                    cell.style.backgroundColor = '#FFFF00';
                });

                // Apply yellow background to all inputs
                [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                    if (input) {
                        input.style.backgroundColor = '#FFFF00';
                        input.style.color = '#000000';
                        input.style.fontWeight = '700';
                    }
                });

                // Highlight the EMI Amount input for Obligate action
                if (emiAmountInput) {
                    emiAmountInput.style.fontSize = '20px';  // Increased from 18px to 20px
                    emiAmountInput.style.fontWeight = '900';

                    // Add orange-bg class to the EMI cell
                    const emiCell = row.querySelector('.emi-cell');
                    if (emiCell) {
                        emiCell.classList.add('orange-bg');
                    }
                }

            } else if (action === 'CO-PAY') {
                row.classList.add('bright-orange-row');
                // Add only half of the EMI amount to total obligation
                totalObligation += Math.round(emiValue / 2);
                obligateAppliedInput.value = 'true';

                // Apply bright orange background to all cells
                allCells.forEach(cell => {
                    cell.style.backgroundColor = '#FFA500';
                });

                // Apply bright orange background to all inputs
                [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                    if (input) {
                        input.style.backgroundColor = '#FFA500';
                        input.style.color = '#000000';
                        input.style.fontWeight = '700';
                    }
                });

            } else if (action === 'Closed') {
                row.classList.add('red-row');

                // Apply red background to all cells
                allCells.forEach(cell => {
                    cell.style.backgroundColor = '#FF0000';
                });

                // Apply red background to all inputs
                [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                    if (input) {
                        input.style.backgroundColor = '#FF0000';
                        input.style.color = '#000000';
                        input.style.fontWeight = '700';
                    }
                });

            } else if (action === 'NO-PAY') {
                row.classList.add('blue-row');

                // Apply bright blue background to all cells
                allCells.forEach(cell => {
                    cell.style.backgroundColor = '#0080FF';
                });

                // Apply bright blue background to all inputs
                [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                    if (input) {
                        input.style.backgroundColor = '#0080FF';
                        input.style.color = '#000000';
                        input.style.fontWeight = '700';
                    }
                });

            } else {
                // Reset all cells to white background
                allCells.forEach(cell => {
                    cell.style.backgroundColor = '#FFFFFF';
                });

                // Reset all inputs to white background
                [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                    if (input) {
                        input.style.backgroundColor = '#FFFFFF';
                        input.style.color = '#000000';
                        input.style.fontWeight = '700';
                    }
                });
            }

            // Trigger font size adjustment for the action select
            setTimeout(adjustFontSize, 0);

            console.log("setAction: Updating totals and recalculating");

            // Recalculate totals - this will update the display values and eligibility calculations
            recalculateTotals();

            // Sort rows
            sortRows();
        }

        function sortRows() {
            const tbody = document.getElementById('obligationsBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                const aAction = a.querySelector('.action-state').value;
                const bAction = b.querySelector('.action-state').value;

                const order = {
                    'BT': 1,
                    'Obligate': 2,
                    'CO-PAY': 3,
                    'NO-PAY': 4,
                    '': 5,
                    'Closed': 6
                };

                return order[aAction] - order[bAction];
            });

            // First, remove all rows from the tbody
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }

            // Then append them back in the sorted order and update row numbers
            rows.forEach((row, index) => {
                tbody.appendChild(row);

                // Update the row number based on its new position in the table
                const rowNumberCell = row.querySelector('.row-number');
                if (rowNumberCell) {
                    // Set the row number based on its current position (index + 1)
                    const newRowNumber = (index + 1).toString();
                    rowNumberCell.textContent = newRowNumber;
                }
            });
        }

        function downloadExcel() {
            try {
                console.log('Download Excel button clicked');
                if (!window.XLSX) {
                    throw new Error('SheetJS library not loaded');
                }

                const salary = parseIndianNumber(document.getElementById('salary').value);
                const partnerSalary = parseIndianNumber(document.getElementById('partnerSalary').value);
                const bonus = parseIndianNumber(document.getElementById('bonus').value);
                // Only include bonus in total income if it has been divided (activeBonusButton is set)
                // When a bonus button is active, the divided bonus is already included in the salary
                const total = salary + partnerSalary; // The divided bonus is already included in salary if applicable
                const companyName = document.getElementById('companyName').value || '';

                const obligationsData = [];
                const rowStyles = [];
                const rows = document.querySelectorAll('#obligationsBody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const actionState = row.querySelector('.action-state').value || '';
                    obligationsData.push([
                        cells[0].querySelector('.product-value') ? cells[0].querySelector('.product-value').value : '',
                        cells[1].querySelector('.bank-value') ? cells[1].querySelector('.bank-value').value : '',
                        cells[2].querySelector('input').value,
                        cells[3].querySelector('input').value,
                        parseIndianNumber(cells[4].querySelector('input').value),
                        parseIndianNumber(cells[5].querySelector('input').value),
                        parseIndianNumber(cells[6].querySelector('input').value),
                        actionState
                    ]);

                    // Determine the row color based on action
                    let fillColor = null;
                    if (actionState === 'BT') {
                        fillColor = { rgb: "4CD964" }; // Green matching the screenshot
                    } else if (actionState === 'Obligate') {
                        fillColor = { rgb: "FFFF00" }; // Yellow
                    } else if (actionState === 'CO-PAY') {
                        fillColor = { rgb: "FFA500" }; // Bright Orange
                    } else if (actionState === 'Closed') {
                        fillColor = { rgb: "FF0000" }; // Red
                    } else if (actionState === 'NO-PAY') {
                        fillColor = { rgb: "0080FF" }; // Bright Blue
                    }
                    rowStyles.push(fillColor);
                });

                const data = [
                    ['Salary', 'Partner\'s Salary', 'Bonus', 'Total Income', 'Company Name'],
                    [salary, partnerSalary, bonus, total, companyName],
                    [],
                    ['Total BT/POS', 'Total Obligation'],
                    [totalBtPos, totalObligation],
                    [],
                    ['Product', 'Bank Name', 'Tenure', 'ROI %', 'Total Loan', 'Outstanding', 'EMI Amount', 'Action']
                ].concat(obligationsData);

                const ws = XLSX.utils.aoa_to_sheet(data);

                // Apply styles to the worksheet
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = 0; R <= range.e.r; R++) {
                    if (R < 7) continue; // Skip header rows (0-6)

                    const rowIndex = R - 7; // Adjust for header rows
                    if (rowIndex < rowStyles.length && rowStyles[rowIndex]) {
                        for (let C = range.s.c; C <= range.e.c; C++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                            if (!ws[cellAddress]) continue;

                            ws[cellAddress].s = {
                                fill: {
                                    fgColor: rowStyles[rowIndex]
                                }
                            };
                        }
                    }
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Customer_Details');

                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Customer_Details.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                document.getElementById('error').style.display = 'none';
                console.log('Excel file generated and download initiated');
            } catch (error) {
                document.getElementById('error').textContent = 'Error downloading Excel: ' + error.message;
                document.getElementById('error').style.display = 'block';
                console.error('Download error:', error);
            }
        }

        // Initialize product dropdowns when page loads
        // Function to update row numbers in the table
        function updateRowNumbers() {
            console.log("Updating row numbers...");
            const tbody = document.getElementById('obligationsBody');
            if (!tbody) {
                console.error("Could not find obligationsBody element");
                return;
            }

            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const rowNumberCell = row.querySelector('.row-number');
                if (rowNumberCell) {
                    // Set the row number based on its current position in the table
                    const newNumber = (index + 1).toString();
                    rowNumberCell.textContent = newNumber;
                }
            });
        }

        // Function to adjust font size based on content length
        function adjustFontSize() {
            // Adjust product display font size
            document.querySelectorAll('.product-display').forEach(element => {
                const text = element.value || element.textContent;
                element.classList.remove('long-text', 'very-long-text');

                if (text.length > 15 && text.length <= 22) {
                    element.classList.add('long-text');
                } else if (text.length > 22) {
                    element.classList.add('very-long-text');
                }
            });

            // Adjust bank display font size
            document.querySelectorAll('.bank-display').forEach(element => {
                const text = element.value || element.textContent;
                element.classList.remove('long-text', 'very-long-text');

                if (text.length > 15 && text.length <= 25) {
                    element.classList.add('long-text');
                } else if (text.length > 25) {
                    element.classList.add('very-long-text');
                }
            });

            // Adjust number input font size
            document.querySelectorAll('.number-input').forEach(element => {
                const text = element.value;
                element.classList.remove('medium-length', 'long-length', 'very-long-length');

                if (text.length > 6 && text.length <= 9) {
                    element.classList.add('medium-length');
                } else if (text.length > 9 && text.length <= 12) {
                    element.classList.add('long-length');
                } else if (text.length > 12) {
                    element.classList.add('very-long-length');
                }
            });

            // Specifically adjust tenure input font size
            document.querySelectorAll('.tenure-input').forEach(element => {
                const text = element.value;
                element.classList.remove('medium-length', 'long-length', 'very-long-length');

                if (text.length > 5 && text.length <= 8) {
                    element.classList.add('medium-length');
                } else if (text.length > 8 && text.length <= 10) {
                    element.classList.add('long-length');
                } else if (text.length > 10) {
                    element.classList.add('very-long-length');
                }
            });

            // Specifically adjust ROI input font size
            document.querySelectorAll('.roi-input').forEach(element => {
                const text = element.value;
                element.classList.remove('medium-length', 'long-length', 'very-long-length');

                if (text.length > 4 && text.length <= 6) {
                    element.classList.add('medium-length');
                } else if (text.length > 6 && text.length <= 8) {
                    element.classList.add('long-length');
                } else if (text.length > 8) {
                    element.classList.add('very-long-length');
                }
            });

            // Specifically adjust action select font size
            document.querySelectorAll('.action-select').forEach(element => {
                const text = element.options[element.selectedIndex]?.text || '';
                element.classList.remove('medium-length', 'long-length', 'very-long-length');

                if (text.length > 5 && text.length <= 8) {
                    element.classList.add('medium-length');
                } else if (text.length > 8 && text.length <= 10) {
                    element.classList.add('long-length');
                } else if (text.length > 10) {
                    element.classList.add('very-long-length');
                }
            });
        }

        // Function to observe changes to the table and adjust font sizes
        function setupFontSizeObserver() {
            // Create a MutationObserver to watch for changes to the table
            const observer = new MutationObserver(function(mutations) {
                adjustFontSize();
            });

            // Start observing the table for changes
            const table = document.getElementById('obligationsTable');
            observer.observe(table, {
                childList: true,
                subtree: true,
                characterData: true,
                attributes: true,
                attributeFilter: ['value', 'textContent']
            });

            // Also adjust font sizes when inputs change
            document.querySelectorAll('input, textarea, .product-display, .bank-display').forEach(element => {
                element.addEventListener('input', adjustFontSize);
                element.addEventListener('change', adjustFontSize);
                element.addEventListener('blur', adjustFontSize);
            });

            // Initial adjustment
            adjustFontSize();
        }

        // Function to disable autocomplete for all input fields
        function disableAutocompleteForAllInputs() {
            document.querySelectorAll('input').forEach(input => {
                input.setAttribute('autocomplete', 'off');
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            setupCustomSelects();
            setupFontSizeObserver();
            disableAutocompleteForAllInputs();

            // For backward compatibility
            window.addObligationRow = addRegularRow;

            // Ensure table container has no height restriction
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.style.maxHeight = 'none';
                tableContainer.style.overflowY = 'visible';
            }

            // Ensure the obligations section expands properly
            const obligationsSection = document.querySelector('.obligations-section');
            if (obligationsSection) {
                obligationsSection.style.height = 'auto';
                obligationsSection.style.minHeight = '200px';
            }

            // Initial font size adjustment
            setTimeout(adjustFontSize, 500);

            // Initialize all action selects to ensure text is visible
            setTimeout(initializeAllActionSelects, 800);

            // Apply default "Obligate" action to the initial row
            setTimeout(function() {
                // Get all action selects in the default row
                const defaultRowActionSelects = document.querySelectorAll('#obligationsBody tr:first-child .action-select');
                defaultRowActionSelects.forEach(select => {
                    // Make sure the Obligate option is selected
                    select.value = "Obligate";
                    // Find the Obligate option and select it
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === "Obligate") {
                            select.options[i].selected = true;
                            break;
                        }
                    }
                    // Set the hidden inputs
                    const row = select.closest('tr');
                    if (row) {
                        const actionStateInput = row.querySelector('.action-state');
                        const obligateAppliedInput = row.querySelector('.obligate-applied');
                        if (actionStateInput) actionStateInput.value = 'Obligate';
                        if (obligateAppliedInput) obligateAppliedInput.value = 'true';
                    }
                    // Apply the correct styling
                    select.style.backgroundColor = '#FFFF00';
                    select.style.height = '24px';
                    select.style.width = '100%';
                    select.style.textAlign = 'left';
                    select.style.fontWeight = '700';
                    select.style.fontSize = '12px';
                    select.style.textTransform = 'none';
                    select.style.borderRadius = '4px';
                    select.style.border = '1px solid #ccc';
                    select.style.padding = '3px 5px';
                    select.style.color = '#000000';
                    // Trigger the setAction function to apply styling and update totals
                    setAction(select);
                });
                // Recalculate totals to ensure they reflect the default Obligate action
                recalculateTotals();
            }, 900);

            // Reinitialize all dropdowns to ensure they work properly
            setTimeout(reinitializeAllCustomDropdowns, 1000);
        });

        // Initialize custom selects
        function setupCustomSelects() {
            // Initialize product dropdowns
            const productSelects = document.querySelectorAll('.product-cell .custom-select-wrapper');
            productSelects.forEach(select => {
                initializeCustomSelect(select, 'product');
            });

            // Initialize bank dropdowns
            const bankSelects = document.querySelectorAll('.bank-cell .custom-select-wrapper');
            bankSelects.forEach(select => {
                initializeCustomSelect(select, 'bank');
            });

            // Add resize event listener to reposition dropdowns when window is resized
            window.addEventListener('resize', function() {
                const activeDropdowns = document.querySelectorAll('.custom-select-dropdown.active');
                activeDropdowns.forEach(dropdown => {
                    const wrapper = dropdown.closest('.custom-select-wrapper');
                    if (wrapper) {
                        const display = wrapper.querySelector('.product-display') || wrapper.querySelector('.bank-display');
                        if (display) {
                            const rect = display.getBoundingClientRect();
                            const viewportHeight = window.innerHeight;
                            const dropdownHeight = 210; // Height for approximately 6-7 items

                            // Set the dropdown options container to have proper height and scrolling
                            const optionsContainer = dropdown.querySelector('.custom-select-options');
                            if (optionsContainer) {
                                // Calculate height for 6-7 items (30px per item) plus search box (30px)
                                const searchHeight = 30; // Height of search box
                                const itemHeight = 30; // Height of each option
                                const numItems = 6; // Show 6 items
                                const calculatedHeight = searchHeight + (itemHeight * numItems);

                                optionsContainer.style.maxHeight = `${itemHeight * numItems}px`; // Height for 6 items
                                optionsContainer.style.overflowY = 'auto'; // Ensure vertical scrolling works

                                // Force the dropdown to have a fixed height
                                dropdown.style.maxHeight = `${calculatedHeight}px`; // Fixed height for dropdown + search
                            }

                            // Check if there's enough space below
                            const spaceBelow = viewportHeight - rect.bottom;
                            const showAbove = spaceBelow < dropdownHeight && rect.top > dropdownHeight;

                            dropdown.style.position = 'fixed';

                            if (showAbove) {
                                // Position above the input
                                dropdown.style.top = 'auto';
                                dropdown.style.bottom = (viewportHeight - rect.top + 2) + 'px';
                                dropdown.classList.add('dropdown-above');
                            } else {
                                // Position below the input
                                dropdown.style.top = (rect.bottom + 2) + 'px';
                                dropdown.style.bottom = 'auto';
                                dropdown.classList.remove('dropdown-above');
                            }

                            dropdown.style.left = rect.left + 'px';
                            dropdown.style.width = (rect.width) + 'px';
                            dropdown.style.display = 'flex'; // Use flex display instead of block

                            // Ensure the dropdown is fully visible
                            dropdown.style.overflow = 'visible';
                        }
                    }
                });
            }, { passive: true });

            // Add scroll event listener to reposition dropdowns when scrolling
            window.addEventListener('scroll', function() {
                const activeDropdowns = document.querySelectorAll('.custom-select-dropdown.active');
                activeDropdowns.forEach(dropdown => {
                    const wrapper = dropdown.closest('.custom-select-wrapper');
                    if (wrapper) {
                        const display = wrapper.querySelector('.product-display') || wrapper.querySelector('.bank-display');
                        if (display) {
                            const rect = display.getBoundingClientRect();
                            const viewportHeight = window.innerHeight;
                            const dropdownHeight = 210; // Height for approximately 6-7 items

                            // Set the dropdown options container to have proper height and scrolling
                            const optionsContainer = dropdown.querySelector('.custom-select-options');
                            if (optionsContainer) {
                                // Calculate height for 6-7 items (30px per item) plus search box (30px)
                                const searchHeight = 30; // Height of search box
                                const itemHeight = 30; // Height of each option
                                const numItems = 6; // Show 6 items
                                const calculatedHeight = searchHeight + (itemHeight * numItems);

                                optionsContainer.style.maxHeight = `${itemHeight * numItems}px`; // Height for 6 items
                                optionsContainer.style.overflowY = 'auto'; // Ensure vertical scrolling works

                                // Force the dropdown to have a fixed height
                                dropdown.style.maxHeight = `${calculatedHeight}px`; // Fixed height for dropdown + search
                            }

                            // Check if there's enough space below
                            const spaceBelow = viewportHeight - rect.bottom;
                            const showAbove = spaceBelow < dropdownHeight && rect.top > dropdownHeight;

                            dropdown.style.position = 'fixed';

                            if (showAbove) {
                                // Position above the input
                                dropdown.style.top = 'auto';
                                dropdown.style.bottom = (viewportHeight - rect.top + 2) + 'px';
                                dropdown.classList.add('dropdown-above');
                            } else {
                                // Position below the input
                                dropdown.style.top = (rect.bottom + 2) + 'px';
                                dropdown.style.bottom = 'auto';
                                dropdown.classList.remove('dropdown-above');
                            }

                            dropdown.style.left = rect.left + 'px';
                            dropdown.style.width = (rect.width) + 'px';
                            dropdown.style.display = 'flex'; // Use flex display instead of block

                            // Ensure the dropdown is fully visible
                            dropdown.style.overflow = 'visible';
                        }
                    }
                });
            }, { passive: true });
        }

        // Initialize dropdowns in a new row
        function initializeNewProductDropdown(row) {
            // Initialize product dropdown
            const productSelect = row.querySelector('.product-cell .custom-select-wrapper');
            if (productSelect) {
                initializeCustomSelect(productSelect, 'product');
            }

            // Initialize bank dropdown
            const bankSelect = row.querySelector('.bank-cell .custom-select-wrapper');
            if (bankSelect) {
                initializeCustomSelect(bankSelect, 'bank');
            }
        }

        // Function to initialize all action selects
        function initializeAllActionSelects() {
            console.log("Initializing all action selects");

            // Get all action selects in the table
            const actionSelects = document.querySelectorAll('.action-select');

            // For each action select, set the data-text attribute based on the selected option
            actionSelects.forEach(select => {
                const selectedOption = select.options[select.selectedIndex];
                const selectedText = selectedOption ? selectedOption.textContent : '';
                select.setAttribute('data-text', selectedText);

                // Force the select to have the correct styling
                select.style.height = '24px';
                select.style.width = '100%';
                select.style.textAlign = 'left';
                select.style.fontWeight = '700';
                select.style.fontSize = '12px';
                select.style.textTransform = 'none';
                select.style.borderRadius = '4px';
                select.style.border = '1px solid #ccc';
                select.style.padding = '3px 5px';
                select.style.color = '#000000'; // Ensure text is black

                // Set background color based on selected value
                const action = select.value;
                if (action === 'BT') {
                    select.style.backgroundColor = '#4CD964'; // Green
                } else if (action === 'Obligate') {
                    select.style.backgroundColor = '#FFFF00'; // Yellow
                } else if (action === 'CO-PAY') {
                    select.style.backgroundColor = '#FFA500'; // Bright Orange
                } else if (action === 'Closed') {
                    select.style.backgroundColor = '#FF0000'; // Red
                } else if (action === 'NO-PAY') {
                    select.style.backgroundColor = '#0080FF'; // Bright Blue
                } else {
                    select.style.backgroundColor = '#FFFFFF'; // White
                }

                console.log("Initialized action select with text:", selectedText, "and action:", action);
            });
        }

        // Function to reinitialize all custom dropdowns in the table
        function reinitializeAllCustomDropdowns() {
            console.log("Reinitializing all custom dropdowns");

            // Get all rows in the table
            const rows = document.querySelectorAll('#obligationsBody tr');

            // For each row, completely rebuild and reinitialize the product and bank dropdowns
            rows.forEach((row, index) => {
                console.log(`Reinitializing dropdowns for row ${index + 1}`);

                // Handle product dropdown
                const productCell = row.querySelector('.product-cell');
                if (productCell) {
                    const productWrapper = productCell.querySelector('.custom-select-wrapper');
                    if (productWrapper) {
                        // Store the current values
                        const productDisplay = productWrapper.querySelector('.product-display');
                        const productValue = productWrapper.querySelector('.product-value');
                        const displayValue = productDisplay ? productDisplay.value : '';
                        const hiddenValue = productValue ? productValue.value : '';

                        // Create a completely new dropdown structure
                        const newProductWrapper = document.createElement('div');
                        newProductWrapper.className = 'custom-select-wrapper';

                        // Create the product display textarea
                        const newProductDisplay = document.createElement('textarea');
                        newProductDisplay.className = 'product-display';
                        newProductDisplay.readOnly = true;
                        newProductDisplay.placeholder = 'Select Product';
                        newProductDisplay.rows = 1;
                        newProductDisplay.style.backgroundColor = '#FFFFFF';
                        newProductDisplay.style.height = '24px';
                        newProductDisplay.style.minHeight = '24px';
                        newProductDisplay.style.overflow = 'hidden';
                        newProductDisplay.style.resize = 'none';
                        newProductDisplay.style.padding = '3px 6px';
                        newProductDisplay.style.fontSize = '0.9rem';
                        newProductDisplay.style.fontWeight = '600';
                        newProductDisplay.style.color = '#000000';
                        newProductDisplay.value = displayValue;

                        // Create the hidden input for product value
                        const newProductValue = document.createElement('input');
                        newProductValue.type = 'hidden';
                        newProductValue.className = 'product-value';
                        newProductValue.value = hiddenValue;

                        // Create the dropdown container
                        const dropdown = document.createElement('div');
                        dropdown.className = 'custom-select-dropdown';

                        // Create the search container
                        const searchContainer = document.createElement('div');
                        searchContainer.className = 'search-container';

                        // Create the search input
                        const searchInput = document.createElement('input');
                        searchInput.type = 'text';
                        searchInput.className = 'search-input';
                        searchInput.placeholder = 'Search products...';

                        // Add the search input to the search container
                        searchContainer.appendChild(searchInput);

                        // Create the options container
                        const optionsContainer = document.createElement('div');
                        optionsContainer.className = 'custom-select-options';

                        // Add the default option
                        const defaultOption = document.createElement('div');
                        defaultOption.className = 'custom-option';
                        defaultOption.dataset.value = '';
                        defaultOption.textContent = 'Select Product';
                        optionsContainer.appendChild(defaultOption);

                        // Add the product options with numbers
                        const productOptions = [
                            'PL (Personal Loan)',
                            'OD (Overdraft)',
                            'CC (Credit Card)',
                            'BL (Business Loan)',
                            'HL (Home Loan)',
                            'LAP (Loan Against Property)',
                            'AL (Auto Loan)',
                            'EL (Education Loan)',
                            'GL (Gold Loan)',
                            'LOC (Loan On Credit Card)',
                            'CD (Consumer Durable Loan)',
                            'APP LOAN',
                            'INSURANCE'
                        ];

                        productOptions.forEach((option, i) => {
                            const optionElement = document.createElement('div');
                            optionElement.className = 'custom-option';
                            optionElement.dataset.value = option;
                            optionElement.textContent = `${i+1}. ${option}`;

                            // Mark as selected if it matches the product value
                            if (option === hiddenValue) {
                                optionElement.classList.add('selected');
                            }

                            optionsContainer.appendChild(optionElement);
                        });

                        // Add all elements to the dropdown
                        dropdown.appendChild(searchContainer);
                        dropdown.appendChild(optionsContainer);

                        // Add all elements to the wrapper
                        newProductWrapper.appendChild(newProductDisplay);
                        newProductWrapper.appendChild(newProductValue);
                        newProductWrapper.appendChild(dropdown);

                        // Replace the old wrapper with the new one
                        productCell.innerHTML = '';
                        productCell.appendChild(newProductWrapper);

                        // Initialize the new dropdown
                        initializeCustomSelect(newProductWrapper, 'product');
                    }
                }

                // Handle bank dropdown
                const bankCell = row.querySelector('.bank-cell');
                if (bankCell) {
                    const bankWrapper = bankCell.querySelector('.custom-select-wrapper');
                    if (bankWrapper) {
                        // Store the current values
                        const bankDisplay = bankWrapper.querySelector('.bank-display');
                        const bankValue = bankWrapper.querySelector('.bank-value');
                        const displayValue = bankDisplay ? bankDisplay.value : '';
                        const hiddenValue = bankValue ? bankValue.value : '';

                        // Create a completely new dropdown structure
                        const newBankWrapper = document.createElement('div');
                        newBankWrapper.className = 'custom-select-wrapper bank-select-wrapper';

                        // Create the bank display textarea
                        const newBankDisplay = document.createElement('textarea');
                        newBankDisplay.className = 'bank-display';
                        newBankDisplay.readOnly = true;
                        newBankDisplay.placeholder = 'Select Bank';
                        newBankDisplay.rows = 1;
                        newBankDisplay.style.backgroundColor = '#FFFFFF';
                        newBankDisplay.style.height = '24px';
                        newBankDisplay.style.minHeight = '24px';
                        newBankDisplay.style.overflow = 'hidden';
                        newBankDisplay.style.resize = 'none';
                        newBankDisplay.style.padding = '3px 6px';
                        newBankDisplay.style.fontSize = '0.9rem';
                        newBankDisplay.style.fontWeight = '600';
                        newBankDisplay.style.color = '#000000';
                        newBankDisplay.value = displayValue;

                        // Create the hidden input for bank value
                        const newBankValue = document.createElement('input');
                        newBankValue.type = 'hidden';
                        newBankValue.className = 'bank-value';
                        newBankValue.value = hiddenValue;

                        // Create the dropdown container
                        const dropdown = document.createElement('div');
                        dropdown.className = 'custom-select-dropdown bank-dropdown';

                        // Create the search container
                        const searchContainer = document.createElement('div');
                        searchContainer.className = 'search-container';

                        // Create the search input
                        const searchInput = document.createElement('input');
                        searchInput.type = 'text';
                        searchInput.className = 'search-input';
                        searchInput.placeholder = 'Search banks...';

                        // Add the search input to the search container
                        searchContainer.appendChild(searchInput);

                        // Create the options container
                        const optionsContainer = document.createElement('div');
                        optionsContainer.className = 'custom-select-options';

                        // Add the default option
                        const defaultOption = document.createElement('div');
                        defaultOption.className = 'custom-option';
                        defaultOption.dataset.value = '';
                        defaultOption.textContent = 'Select Bank';
                        optionsContainer.appendChild(defaultOption);

                        // Add the bank options with numbers
                        // Private Banks
                        const privateBanks = [
                            'Axis Bank', 'Axis Finance', 'Bandhan Bank', 'City Union Bank', 'CSB Bank', 'DCB Bank',
                            'Dhanlaxmi Bank', 'Federal Bank', 'HDFC Bank', 'ICICI Bank', 'IDBI Bank',
                            'IDFC FIRST Bank', 'IndusInd Bank', 'Karnataka Bank', 'Kotak Mahindra Bank',
                            'Nainital Bank', 'RBL Bank', 'South Indian Bank', 'Tamilnad Mercantile Bank', 'YES Bank'
                        ];

                        // Public Banks
                        const publicBanks = [
                            'Bank of Baroda', 'Bank of India', 'Bank of Maharashtra', 'Canara Bank',
                            'Central Bank of India', 'Indian Bank', 'Indian Overseas Bank', 'PNB Bank',
                            'Punjab & Sind Bank', 'SBI Bank', 'UCO Bank'
                        ];

                        // NBFCs (Non-Banking Financial Companies)
                        const nbfcs = [
                            'Aditya Birla Capital', 'Bajaj Finance', 'Bajaj Finserv', 'Capri Global Capital',
                            'Cholamandalam Investment and Finance', 'Edelweiss Financial Services', 'Fullerton India',
                            'HDB Financial Services', 'IIFL Finance', 'InCred Finance', 'JM Financial', 'L&T Finance',
                            'Mahindra Finance', 'Mas Financial Services', 'Motilal Oswal Financial Services',
                            'Muthoot Finance', 'Piramal Capital & Housing Finance', 'Poonawalla Fincorp',
                            'Reliance Capital', 'Shriram Finance', 'Srei Infrastructure Finance', 'Tata Capital',
                            'Ugro Capital', 'Vistaar Financial Services'
                        ];

                        // Fintechs
                        const fintechs = [
                            '50Fin', 'Capital Float', 'CASHe', 'Credy', 'Dhani', 'DMI Finance', 'Faircent',
                            'Fibe', 'Finnable', 'FlexSalary', 'Hero FinCorp', 'Home Credit India', 'i2iFunding',
                            'IndiaLends', 'Kissht', 'KreditBee', 'LazyPay', 'LenDenClub', 'Lendingkart',
                            'LoanTap', 'MoneyTap', 'Moneyview', 'Monexo', 'mPokket', 'Navi', 'NIRA Finance',
                            'NoBroker InstaCash', 'PayMe', 'PaySense', 'RapidRupee', 'RupeeLend', 'Rupifi',
                            'SmartCoin', 'StashFin', 'Svatantra Microfin', 'ZestMoney'
                        ];

                        // Foreign Banks
                        const foreignBanks = [
                            'American Express Banking Corp', 'Bank of China', 'Barclays Bank', 'Citibank',
                            'DBS Bank', 'Deutsche Bank', 'HSBC', 'SBM Bank', 'Standard Chartered Bank'
                        ];

                        // Small Finance Banks
                        const smallFinanceBanks = [
                            'AU Small Finance Bank', 'Capital Small Finance Bank', 'Equitas Small Finance Bank',
                            'Jana Small Finance Bank', 'North East Small Finance Bank', 'Shivalik Small Finance Bank',
                            'Ujjivan Small Finance Bank', 'Utkarsh Small Finance Bank'
                        ];

                        // Combine all banks
                        const allBanks = [...privateBanks, ...publicBanks, ...nbfcs, ...fintechs, ...foreignBanks, ...smallFinanceBanks];

                        // Add all banks with numbers
                        allBanks.forEach((bank, i) => {
                            const optionElement = document.createElement('div');
                            optionElement.className = 'custom-option';
                            optionElement.dataset.value = bank;
                            optionElement.textContent = `${i+1}. ${bank}`;

                            // Mark as selected if it matches the bank value
                            if (bank === hiddenValue) {
                                optionElement.classList.add('selected');
                            }

                            optionsContainer.appendChild(optionElement);
                        });

                        // Add "OTHER" option at the end
                        const otherOption = document.createElement('div');
                        otherOption.className = 'custom-option';
                        otherOption.dataset.value = 'OTHER';
                        otherOption.textContent = `${allBanks.length + 1}. OTHER`;
                        optionsContainer.appendChild(otherOption);

                        // Add all elements to the dropdown
                        dropdown.appendChild(searchContainer);
                        dropdown.appendChild(optionsContainer);

                        // Add all elements to the wrapper
                        newBankWrapper.appendChild(newBankDisplay);
                        newBankWrapper.appendChild(newBankValue);
                        newBankWrapper.appendChild(dropdown);

                        // Replace the old wrapper with the new one
                        bankCell.innerHTML = '';
                        bankCell.appendChild(newBankWrapper);

                        // Initialize the new dropdown
                        initializeCustomSelect(newBankWrapper, 'bank');
                    }
                }
            });

            console.log("All custom dropdowns reinitialized");
        }

        // Initialize a single custom select
        function initializeCustomSelect(wrapper, type = 'product') {
            const display = type === 'product' ? wrapper.querySelector('.product-display') : wrapper.querySelector('.bank-display');
            const hiddenInput = type === 'product' ? wrapper.querySelector('.product-value') : wrapper.querySelector('.bank-value');
            const dropdown = wrapper.querySelector('.custom-select-dropdown');
            const searchInput = wrapper.querySelector('.search-input');
            const options = wrapper.querySelectorAll('.custom-option');

            // Add uppercase transformation for bank search input
            if (type === 'bank' && searchInput) {
                searchInput.style.textTransform = 'uppercase';
                searchInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }

            // Set the no results message based on type
            const noResultsText = type === 'product' ? 'No matching products' : 'No matching banks';

            // Click event for display input to show dropdown
            display.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent event from bubbling up

                // Close all other dropdowns first and reset z-index
                document.querySelectorAll('.custom-select-wrapper').forEach(w => {
                    if (w !== wrapper) {
                        w.classList.remove('active');
                        const d = w.querySelector('.custom-select-dropdown');
                        if (d) {
                            d.classList.remove('active');
                            d.style.display = 'none';
                        }
                    }
                });

                // Toggle this dropdown
                dropdown.classList.toggle('active');
                wrapper.classList.toggle('active');

                if (dropdown.classList.contains('active')) {
                    // Position the dropdown correctly
                    const rect = display.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const dropdownHeight = 210; // Height for approximately 6-7 items

                    // Set the dropdown options container to have proper height and scrolling
                    const optionsContainer = dropdown.querySelector('.custom-select-options');
                    if (optionsContainer) {
                        // Calculate height for 6-7 items (30px per item) plus search box (30px)
                        const searchHeight = 30; // Height of search box
                        const itemHeight = 30; // Height of each option
                        const numItems = 6; // Show 6 items
                        const calculatedHeight = searchHeight + (itemHeight * numItems);

                        optionsContainer.style.maxHeight = `${itemHeight * numItems}px`; // Height for 6 items
                        optionsContainer.style.overflowY = 'auto'; // Ensure vertical scrolling works

                        // Force the dropdown to have a fixed height
                        dropdown.style.maxHeight = `${calculatedHeight}px`; // Fixed height for dropdown + search
                    }

                    // Check if there's enough space below
                    const spaceBelow = viewportHeight - rect.bottom;
                    const showAbove = spaceBelow < dropdownHeight && rect.top > dropdownHeight;

                    // Use fixed positioning with viewport coordinates
                    dropdown.style.position = 'fixed';

                    if (showAbove) {
                        // Position above the input
                        dropdown.style.top = 'auto';
                        dropdown.style.bottom = (viewportHeight - rect.top + 2) + 'px';
                        dropdown.classList.add('dropdown-above');
                    } else {
                        // Position below the input
                        dropdown.style.top = (rect.bottom + 2) + 'px';
                        dropdown.style.bottom = 'auto';
                        dropdown.classList.remove('dropdown-above');
                    }

                    dropdown.style.left = rect.left + 'px';
                    dropdown.style.width = (rect.width) + 'px';
                    dropdown.style.display = 'flex'; // Use flex display instead of block

                    // Ensure the dropdown is fully visible
                    dropdown.style.overflow = 'visible';

                    console.log('Dropdown positioned:', showAbove ? 'above' : 'below', 'Space below:', spaceBelow, 'px');

                    // Focus the search input
                    setTimeout(() => {
                        searchInput.focus();
                    }, 100);

                    // Highlight the currently selected option
                    const value = hiddenInput.value;
                    options.forEach(option => {
                        option.classList.remove('selected');
                        if (option.getAttribute('data-value') === value) {
                            option.classList.add('selected');
                            // Scroll to the selected option
                            setTimeout(() => {
                                option.scrollIntoView({ block: 'nearest' });
                            }, 100);
                        }
                    });
                } else {
                    dropdown.style.display = 'none';
                    wrapper.classList.remove('active');
                }
            });

            // Click events for options
            options.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent event from bubbling

                    const value = this.getAttribute('data-value');
                    let text = this.textContent;

                    // Remove the number prefix (e.g., "1. ") if present
                    if (text.match(/^\d+\.\s/)) {
                        text = text.replace(/^\d+\.\s/, '');
                    }

                    // Convert bank name to uppercase if this is a bank dropdown
                    if (type === 'bank') {
                        text = text.toUpperCase();
                    }

                    console.log('Option clicked:', text, value);

                    // Set the display value and add title for tooltip on hover
                    display.value = text;
                    display.title = text; // Add tooltip
                    hiddenInput.value = value;

                    // Adjust textarea height to fit content
                    setTimeout(() => {
                        // Reset height to auto to accommodate the text
                        display.style.height = 'auto';
                        // Set height to scrollHeight to fit content exactly
                        display.style.height = (display.scrollHeight) + 'px';
                        console.log('Adjusted height to:', display.style.height);

                        // Apply font size adjustment
                        adjustFontSize();

                        // Preserve row color if it exists
                        const row = display.closest('tr');
                        if (row) {
                            if (row.classList.contains('green-row')) {
                                display.style.backgroundColor = '#4CD964';
                                display.style.color = '#000000';
                                display.style.fontWeight = '900';
                                display.style.fontSize = '16px';
                            } else if (row.classList.contains('orange-row')) {
                                display.style.backgroundColor = '#FFFF00';
                                display.style.color = '#000000';
                                display.style.fontWeight = '900';
                                display.style.fontSize = '16px';
                            } else if (row.classList.contains('red-row')) {
                                display.style.backgroundColor = '#FF0000';
                                display.style.color = '#000000';
                                display.style.fontWeight = '900';
                                display.style.fontSize = '16px';
                            }
                        }
                    }, 0);

                    // Store the previous product value
                    const previousValue = hiddenInput.getAttribute('data-previous-value') || '';

                    // If the previous product was Credit Card, remove the EMI calculation event listener
                    if (previousValue === "CC (Credit Card)" && value !== "CC (Credit Card)") {
                        const row = display.closest('tr');
                        if (row) {
                            // Show tenure and ROI fields again when switching from Credit Card to another product
                            const tenureInput = row.querySelector('.tenure-input');
                            const roiInput = row.querySelector('.roi-input');

                            if (tenureInput) {
                                tenureInput.style.display = '';
                                tenureInput.parentElement.style.backgroundColor = '';
                            }

                            if (roiInput) {
                                roiInput.style.display = '';
                                roiInput.parentElement.style.backgroundColor = '';
                            }

                            // Clear the EMI input box when changing from Credit Card to another product
                            const emiInput = row.querySelector('.emi-input');
                            if (emiInput) {
                                emiInput.value = '';
                            }

                            const outstandingInput = row.querySelector('.os-input');
                            if (outstandingInput) {
                                // Remove the Credit Card EMI calculation event listener
                                // We need to clone and replace the element to remove all event listeners
                                const newOutstandingInput = outstandingInput.cloneNode(true);
                                outstandingInput.parentNode.replaceChild(newOutstandingInput, outstandingInput);

                                // Add back the standard formatNumber event listener
                                newOutstandingInput.addEventListener('input', function() {
                                    formatNumber(this);
                                });
                            }
                        }
                    }

                    // Update the previous value attribute for future reference
                    hiddenInput.setAttribute('data-previous-value', value);

                    // If Credit Card is selected, handle automatic EMI calculation
                    if (value === "CC (Credit Card)") {
                        const row = display.closest('tr');
                        if (row) {
                            // Get the tenure, ROI, outstanding input and EMI input
                            const tenureInput = row.querySelector('.tenure-input');
                            const roiInput = row.querySelector('.roi-input');
                            const outstandingInput = row.querySelector('.os-input');
                            const emiInput = row.querySelector('.emi-input');

                            // Hide tenure and ROI fields for Credit Card
                            if (tenureInput) {
                                tenureInput.style.display = 'none';
                                tenureInput.parentElement.style.backgroundColor = '#000000'; // Black background for hidden field
                            }

                            if (roiInput) {
                                roiInput.style.display = 'none';
                                roiInput.parentElement.style.backgroundColor = '#000000'; // Black background for hidden field
                            }

                            // Add event listener to outstanding input to auto-calculate EMI
                            if (outstandingInput && emiInput) {
                                // Calculate EMI immediately if outstanding already has a value
                                if (outstandingInput.value) {
                                    const outstandingValue = parseIndianNumber(outstandingInput.value);
                                    const emiValue = Math.round(outstandingValue * 0.05); // 5% of outstanding
                                    emiInput.value = emiValue.toLocaleString('en-IN', {maximumFractionDigits: 0});
                                }

                                // Create a named function for the event listener so we can reference it later
                                function creditCardEmiCalculator() {
                                    const outstandingValue = parseIndianNumber(this.value);
                                    const emiValue = Math.round(outstandingValue * 0.05); // 5% of outstanding
                                    const emiInput = this.closest('tr').querySelector('.emi-input');
                                    if (emiInput) {
                                        emiInput.value = emiValue.toLocaleString('en-IN');
                                    }

                                    // If this row has an action applied, recalculate totals
                                    const actionState = this.closest('tr').querySelector('.action-state').value;
                                    if (actionState === 'BT' || actionState === 'Obligate') {
                                        recalculateTotals();
                                    }
                                }

                                // Remove any existing event listeners by cloning and replacing
                                const newOutstandingInput = outstandingInput.cloneNode(true);
                                outstandingInput.parentNode.replaceChild(newOutstandingInput, outstandingInput);

                                // Add the formatNumber event listener
                                newOutstandingInput.addEventListener('input', function() {
                                    formatNumber(this);
                                });

                                // Add the credit card EMI calculator event listener
                                newOutstandingInput.addEventListener('input', creditCardEmiCalculator);
                            }
                        }
                    }

                    // Update selected class
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');

                    // Hide dropdown
                    dropdown.classList.remove('active');
                    dropdown.style.display = 'none';
                    wrapper.classList.remove('active');

                    // Clear search
                    searchInput.value = '';
                    filterOptions(wrapper, '');
                });
            });

            // Search input event
            searchInput.addEventListener('input', function() {
                filterOptions(wrapper, this.value);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!wrapper.contains(e.target)) {
                    dropdown.classList.remove('active');
                    dropdown.style.display = 'none';
                    wrapper.classList.remove('active');

                    // Clear search when closing
                    searchInput.value = '';
                    filterOptions(wrapper, '');
                }
            });

            // Prevent clicks inside dropdown from closing it
            dropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            // Prevent clicks in search input from closing dropdown
            searchInput.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        // Filter options based on search text
        function filterOptions(wrapper, searchText) {
            const options = wrapper.querySelectorAll('.custom-option');
            const optionsContainer = wrapper.querySelector('.custom-select-options');
            let hasResults = false;

            searchText = searchText.toLowerCase();

            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                // Remove the number prefix for searching purposes
                const textWithoutNumber = text.replace(/^\d+\.\s/, '');
                const value = option.getAttribute('data-value');

                // Skip the first "Select Product" option when searching
                if (value === '' && searchText) {
                    option.style.display = 'none';
                    return;
                }

                // Check if the search text is in the text with or without the number
                if (text.includes(searchText) || textWithoutNumber.includes(searchText)) {
                    option.style.display = 'block';
                    hasResults = true;
                } else {
                    option.style.display = 'none';
                }
            });

            // Show "no results" message if needed
            let noResultsMsg = wrapper.querySelector('.no-results');

            if (!hasResults && searchText) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'custom-option no-results';
                    // Check if this is a bank dropdown or product dropdown
                    const isBank = wrapper.closest('.bank-cell') !== null;
                    noResultsMsg.textContent = isBank ? 'No matching banks' : 'No matching products';
                    noResultsMsg.style.fontStyle = 'italic';
                    noResultsMsg.style.color = '#999';
                    optionsContainer.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        function uploadExcel() {
            const file = document.getElementById('uploadFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets['Customer_Details'];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (json.length > 1) {
                        document.getElementById('salary').value = parseInt(json[1][0] || 0).toLocaleString('en-IN');
                        document.getElementById('partnerSalary').value = parseInt(json[1][1] || 0).toLocaleString('en-IN');
                        document.getElementById('bonus').value = parseInt(json[1][2] || 0).toLocaleString('en-IN');
                        document.getElementById('companyName').value = json[1][4] || '';
                        calculateTotal();

                        totalBtPos = parseInt(json[4][0] || 0);
                        totalObligation = parseInt(json[4][1] || 0);
                        updateDisplayValues();

                        const tbody = document.getElementById('obligationsBody');
                        tbody.innerHTML = ''; // Clear the table completely

                        // Add rows from the uploaded Excel file
                        for (let i = 7; i < json.length; i++) {
                            if (json[i].length > 0) {
                                const row = document.createElement('tr');
                                const actionState = json[i][7] || '';
                                const osValue = parseInt(json[i][5] || 0);
                                const emiValue = parseInt(json[i][6] || 0);

                                // Format tenure value to include "Months"
                                let tenureValue = json[i][2] || '';
                                if (tenureValue && !isNaN(parseInt(tenureValue))) {
                                    tenureValue = parseInt(tenureValue) + " Months";
                                }

                                row.innerHTML = `
                                    <td class="product-cell">
                                        <div class="custom-select-wrapper">
                                            <textarea class="product-display" readonly placeholder="Select Product" rows="2">${json[i][0] || ''}</textarea>
                                            <input type="hidden" class="product-value" value="${json[i][0] || ''}">
                                            <div class="custom-select-dropdown">
                                                <div class="search-container">
                                                    <input type="text" class="search-input" placeholder="Search products...">
                                                </div>
                                                <div class="custom-select-options">
                                                    <div class="custom-option" data-value="">Select Product</div>
                                                    <div class="custom-option" data-value="PL (Personal Loan)">PL (Personal Loan)</div>
                                                    <div class="custom-option" data-value="OD (Overdraft)">OD (Overdraft)</div>
                                                    <div class="custom-option" data-value="CC (Credit Card)">CC (Credit Card)</div>
                                                    <div class="custom-option" data-value="BL (Business Loan)">BL (Business Loan)</div>
                                                    <div class="custom-option" data-value="HL (Home Loan)">HL (Home Loan)</div>
                                                    <div class="custom-option" data-value="LAP (Loan Against Property)">LAP (Loan Against Property)</div>
                                                    <div class="custom-option" data-value="AL (Auto Loan/ Car Loan)">AL (Auto Loan/ Car Loan)</div>
                                                    <div class="custom-option" data-value="EL (Education Loan)">EL (Education Loan)</div>
                                                    <div class="custom-option" data-value="GL (Gold Loan)">GL (Gold Loan)</div>
                                                    <div class="custom-option" data-value="LOC (Loan On Credit Card)">LOC (Loan On Credit Card)</div>
                                                    <div class="custom-option" data-value="CD (Consumer Durable Loan)">CD (Consumer Durable Loan)</div>
                                                    <div class="custom-option" data-value="APP LOAN">APP LOAN</div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="bank-cell">
                                        <div class="custom-select-wrapper bank-select-wrapper">
                                            <textarea class="bank-display" readonly placeholder="Select Bank" rows="2">${json[i][1] || ''}</textarea>
                                            <input type="hidden" class="bank-value" value="${json[i][1] || ''}">
                                            <div class="custom-select-dropdown bank-dropdown">
                                                <div class="search-container">
                                                    <input type="text" class="search-input" placeholder="Search banks...">
                                                </div>
                                                <div class="custom-select-options">
                                                    <div class="custom-option" data-value="">Select Bank</div>
                                                    <!-- Private Banks -->
                                                    <div class="custom-option" data-value="Axis Bank">Axis Bank</div>
                                                    <div class="custom-option" data-value="Bandhan Bank">Bandhan Bank</div>
                                                    <div class="custom-option" data-value="City Union Bank">City Union Bank</div>
                                                    <div class="custom-option" data-value="CSB Bank">CSB Bank</div>
                                                    <div class="custom-option" data-value="DCB Bank">DCB Bank</div>
                                                    <div class="custom-option" data-value="Dhanlaxmi Bank">Dhanlaxmi Bank</div>
                                                    <div class="custom-option" data-value="Federal Bank">Federal Bank</div>
                                                    <div class="custom-option" data-value="HDFC Bank">HDFC Bank</div>
                                                    <div class="custom-option" data-value="ICICI Bank">ICICI Bank</div>
                                                    <div class="custom-option" data-value="IDBI Bank">IDBI Bank</div>
                                                    <div class="custom-option" data-value="IDFC FIRST Bank">IDFC FIRST Bank</div>
                                                    <div class="custom-option" data-value="IndusInd Bank">IndusInd Bank</div>
                                                    <div class="custom-option" data-value="Karnataka Bank">Karnataka Bank</div>
                                                    <div class="custom-option" data-value="Kotak Mahindra Bank">Kotak Mahindra Bank</div>
                                                    <div class="custom-option" data-value="Nainital Bank">Nainital Bank</div>
                                                    <div class="custom-option" data-value="RBL Bank">RBL Bank</div>
                                                    <div class="custom-option" data-value="South Indian Bank">South Indian Bank</div>
                                                    <div class="custom-option" data-value="Tamilnad Mercantile Bank">Tamilnad Mercantile Bank</div>
                                                    <div class="custom-option" data-value="YES Bank">YES Bank</div>

                                                    <!-- Public Banks -->
                                                    <div class="custom-option" data-value="Bank of Baroda">Bank of Baroda</div>
                                                    <div class="custom-option" data-value="Bank of India">Bank of India</div>
                                                    <div class="custom-option" data-value="Bank of Maharashtra">Bank of Maharashtra</div>
                                                    <div class="custom-option" data-value="Canara Bank">Canara Bank</div>
                                                    <div class="custom-option" data-value="Central Bank of India">Central Bank of India</div>
                                                    <div class="custom-option" data-value="Indian Bank">Indian Bank</div>
                                                    <div class="custom-option" data-value="Indian Overseas Bank">Indian Overseas Bank</div>
                                                    <div class="custom-option" data-value="PNB Bank">PNB Bank</div>
                                                    <div class="custom-option" data-value="Punjab & Sind Bank">Punjab & Sind Bank</div>
                                                    <div class="custom-option" data-value="SBI Bank">SBI Bank</div>
                                                    <div class="custom-option" data-value="UCO Bank">UCO Bank</div>

                                                    <!-- NBFCs -->
                                                    <div class="custom-option" data-value="Bajaj Finance">Bajaj Finance</div>
                                                    <div class="custom-option" data-value="Bajaj Finserv">Bajaj Finserv</div>
                                                    <div class="custom-option" data-value="Capri Global Capital">Capri Global Capital</div>
                                                    <div class="custom-option" data-value="Cholamandalam Investment and Finance">Cholamandalam Investment and Finance</div>
                                                    <div class="custom-option" data-value="Edelweiss Financial Services">Edelweiss Financial Services</div>
                                                    <div class="custom-option" data-value="Fullerton India">Fullerton India</div>
                                                    <div class="custom-option" data-value="HDB Financial Services">HDB Financial Services</div>
                                                    <div class="custom-option" data-value="IIFL Finance">IIFL Finance</div>
                                                    <div class="custom-option" data-value="InCred Finance">InCred Finance</div>
                                                    <div class="custom-option" data-value="JM Financial">JM Financial</div>
                                                    <div class="custom-option" data-value="L&T Finance">L&T Finance</div>
                                                    <div class="custom-option" data-value="Mahindra Finance">Mahindra Finance</div>
                                                    <div class="custom-option" data-value="Mas Financial Services">Mas Financial Services</div>
                                                    <div class="custom-option" data-value="Motilal Oswal Financial Services">Motilal Oswal Financial Services</div>
                                                    <div class="custom-option" data-value="Muthoot Finance">Muthoot Finance</div>
                                                    <div class="custom-option" data-value="Piramal Capital & Housing Finance">Piramal Capital & Housing Finance</div>
                                                    <div class="custom-option" data-value="Poonawalla Fincorp">Poonawalla Fincorp</div>
                                                    <div class="custom-option" data-value="Reliance Capital">Reliance Capital</div>
                                                    <div class="custom-option" data-value="Shriram Finance">Shriram Finance</div>
                                                    <div class="custom-option" data-value="Srei Infrastructure Finance">Srei Infrastructure Finance</div>
                                                    <div class="custom-option" data-value="Tata Capital">Tata Capital</div>
                                                    <div class="custom-option" data-value="Ugro Capital">Ugro Capital</div>
                                                    <div class="custom-option" data-value="Vistaar Financial Services">Vistaar Financial Services</div>

                                                    <!-- Fintechs -->
                                                    <div class="custom-option" data-value="50Fin">50Fin</div>
                                                    <div class="custom-option" data-value="Capital Float">Capital Float</div>
                                                    <div class="custom-option" data-value="CASHe">CASHe</div>
                                                    <div class="custom-option" data-value="Credy">Credy</div>
                                                    <div class="custom-option" data-value="Dhani">Dhani</div>
                                                    <div class="custom-option" data-value="DMI Finance">DMI Finance</div>
                                                    <div class="custom-option" data-value="Faircent">Faircent</div>
                                                    <div class="custom-option" data-value="Fibe">Fibe</div>
                                                    <div class="custom-option" data-value="Finnable">Finnable</div>
                                                    <div class="custom-option" data-value="FlexSalary">FlexSalary</div>
                                                    <div class="custom-option" data-value="Hero FinCorp">Hero FinCorp</div>
                                                    <div class="custom-option" data-value="Home Credit India">Home Credit India</div>
                                                    <div class="custom-option" data-value="i2iFunding">i2iFunding</div>
                                                    <div class="custom-option" data-value="IndiaLends">IndiaLends</div>
                                                    <div class="custom-option" data-value="Kissht">Kissht</div>
                                                    <div class="custom-option" data-value="KreditBee">KreditBee</div>
                                                    <div class="custom-option" data-value="LazyPay">LazyPay</div>
                                                    <div class="custom-option" data-value="LenDenClub">LenDenClub</div>
                                                    <div class="custom-option" data-value="Lendingkart">Lendingkart</div>
                                                    <div class="custom-option" data-value="LoanTap">LoanTap</div>
                                                    <div class="custom-option" data-value="MoneyTap">MoneyTap</div>
                                                    <div class="custom-option" data-value="Moneyview">Moneyview</div>
                                                    <div class="custom-option" data-value="Monexo">Monexo</div>
                                                    <div class="custom-option" data-value="mPokket">mPokket</div>
                                                    <div class="custom-option" data-value="Navi">Navi</div>
                                                    <div class="custom-option" data-value="NIRA Finance">NIRA Finance</div>
                                                    <div class="custom-option" data-value="NoBroker InstaCash">NoBroker InstaCash</div>
                                                    <div class="custom-option" data-value="PayMe">PayMe</div>
                                                    <div class="custom-option" data-value="PaySense">PaySense</div>
                                                    <div class="custom-option" data-value="RapidRupee">RapidRupee</div>
                                                    <div class="custom-option" data-value="RupeeLend">RupeeLend</div>
                                                    <div class="custom-option" data-value="Rupifi">Rupifi</div>
                                                    <div class="custom-option" data-value="SmartCoin">SmartCoin</div>
                                                    <div class="custom-option" data-value="StashFin">StashFin</div>
                                                    <div class="custom-option" data-value="Svatantra Microfin">Svatantra Microfin</div>
                                                    <div class="custom-option" data-value="ZestMoney">ZestMoney</div>

                                                    <!-- Foreign Banks -->
                                                    <div class="custom-option" data-value="American Express Banking Corp">American Express Banking Corp</div>
                                                    <div class="custom-option" data-value="Bank of China">Bank of China</div>
                                                    <div class="custom-option" data-value="Barclays Bank">Barclays Bank</div>
                                                    <div class="custom-option" data-value="Citibank">Citibank</div>
                                                    <div class="custom-option" data-value="DBS Bank">DBS Bank</div>
                                                    <div class="custom-option" data-value="Deutsche Bank">Deutsche Bank</div>
                                                    <div class="custom-option" data-value="HSBC">HSBC</div>
                                                    <div class="custom-option" data-value="SBM Bank">SBM Bank</div>
                                                    <div class="custom-option" data-value="Standard Chartered Bank">Standard Chartered Bank</div>

                                                    <!-- Small Finance Banks -->
                                                    <div class="custom-option" data-value="AU Small Finance Bank">AU Small Finance Bank</div>
                                                    <div class="custom-option" data-value="Capital Small Finance Bank">Capital Small Finance Bank</div>
                                                    <div class="custom-option" data-value="Equitas Small Finance Bank">Equitas Small Finance Bank</div>
                                                    <div class="custom-option" data-value="Jana Small Finance Bank">Jana Small Finance Bank</div>
                                                    <div class="custom-option" data-value="North East Small Finance Bank">North East Small Finance Bank</div>
                                                    <div class="custom-option" data-value="Shivalik Small Finance Bank">Shivalik Small Finance Bank</div>
                                                    <div class="custom-option" data-value="Ujjivan Small Finance Bank">Ujjivan Small Finance Bank</div>
                                                    <div class="custom-option" data-value="Utkarsh Small Finance Bank">Utkarsh Small Finance Bank</div>

                                                    <!-- Other -->
                                                    <div class="custom-option" data-value="OTHER">OTHER</div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td><input type="text" class="number-input tenure-input" value="${tenureValue}" maxlength="3"></td>
                                    <td><input type="text" class="number-input roi-input" value="${json[i][3] || ''}" maxlength="6"></td>
                                    <td><input type="text" class="number-input" oninput="formatNumber(this)" value="${parseInt(json[i][4] || 0).toLocaleString('en-IN')}"></td>
                                    <td class="outstanding-cell ${actionState === 'BT' ? 'green-bg' : ''}"><input type="text" class="number-input os-input" oninput="formatNumber(this)" value="${osValue.toLocaleString('en-IN')}"></td>
                                    <td class="emi-cell ${actionState === 'Obligate' ? 'orange-bg' : ''}"><input type="text" class="number-input emi-input" oninput="formatNumber(this)" value="${emiValue.toLocaleString('en-IN')}"></td>
                                    <td class="actions-cell">
                                        <select class="action-select" onchange="setAction(this)">
                                            <option value="">Select Action</option>
                                            <option value="BT" ${actionState === 'BT' ? 'selected' : ''}>BT</option>
                                            <option value="Obligate" ${actionState === 'Obligate' ? 'selected' : ''}>Obligate</option>
                                            <option value="Closed" ${actionState === 'Closed' ? 'selected' : ''}>Closed</option>
                                        </select>
                                        <input type="hidden" class="action-state" value="${actionState}">
                                        <input type="hidden" class="bt-applied" value="${actionState === 'BT' ? 'true' : 'false'}">
                                        <input type="hidden" class="obligate-applied" value="${actionState === 'Obligate' ? 'true' : 'false'}">
                                    </td>
                                    <td>
                                        <button class="delete-btn" onclick="deleteRow(this, event)" oncontextmenu="deleteRow(this, event); return false;" title="Click to delete row">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                `;
                                if (actionState === 'BT') row.classList.add('green-row');
                                if (actionState === 'Obligate') row.classList.add('orange-row');
                                if (actionState === 'Closed') row.classList.add('red-row');
                                tbody.appendChild(row);

                                // Initialize the product dropdown in the new row
                                initializeNewProductDropdown(row);

                                // Initialize the tenure input in the new row
                                const tenureInput = row.querySelector('.tenure-input');
                                if (tenureInput) {
                                    tenureInput.addEventListener('input', formatTenureInput);
                                    tenureInput.addEventListener('blur', formatTenureInput);
                                    tenureInput.addEventListener('click', handleTenureInputClick);
                                    tenureInput.addEventListener('focus', handleTenureInputClick);
                                }

                                // Initialize the ROI input in the new row
                                const roiInput = row.querySelector('.roi-input');
                                if (roiInput) {
                                    roiInput.addEventListener('input', formatRoiInput);
                                    roiInput.addEventListener('blur', formatRoiInput);
                                    roiInput.addEventListener('click', handleRoiInputClick);
                                    roiInput.addEventListener('focus', handleRoiInputClick);
                                }
                            }
                        }

                        // If no rows were added from the Excel file, add the default first row
                        if (tbody.children.length === 0) {
                            const defaultRow = document.createElement('tr');
                            defaultRow.innerHTML = `
                                <td class="product-cell">
                                    <div class="custom-select-wrapper">
                                        <textarea class="product-display" readonly placeholder="Select Product" rows="2"></textarea>
                                        <input type="hidden" class="product-value">
                                        <div class="custom-select-dropdown">
                                            <div class="search-container">
                                                <input type="text" class="search-input" placeholder="Search products...">
                                            </div>
                                            <div class="custom-select-options">
                                                <div class="custom-option" data-value="">Select Product</div>
                                                <div class="custom-option" data-value="PL (Personal Loan)">PL (Personal Loan)</div>
                                                <div class="custom-option" data-value="OD (Overdraft)">OD (Overdraft)</div>
                                                <div class="custom-option" data-value="CC (Credit Card)">CC (Credit Card)</div>
                                                <div class="custom-option" data-value="BL (Business Loan)">BL (Business Loan)</div>
                                                <div class="custom-option" data-value="HL (Home Loan)">HL (Home Loan)</div>
                                                <div class="custom-option" data-value="LAP (Loan Against Property)">LAP (Loan Against Property)</div>
                                                <div class="custom-option" data-value="AL (Auto Loan/ Car Loan)">AL (Auto Loan/ Car Loan)</div>
                                                <div class="custom-option" data-value="EL (Education Loan)">EL (Education Loan)</div>
                                                <div class="custom-option" data-value="GL (Gold Loan)">GL (Gold Loan)</div>
                                                <div class="custom-option" data-value="LOC (Loan On Credit Card)">LOC (Loan On Credit Card)</div>
                                                <div class="custom-option" data-value="CD (Consumer Durable Loan)">CD (Consumer Durable Loan)</div>
                                                <div class="custom-option" data-value="APP LOAN">APP LOAN</div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="bank-cell">
                                    <div class="custom-select-wrapper bank-select-wrapper">
                                        <textarea class="bank-display" readonly placeholder="Select Bank" rows="2"></textarea>
                                        <input type="hidden" class="bank-value">
                                        <div class="custom-select-dropdown bank-dropdown">
                                            <div class="search-container">
                                                <input type="text" class="search-input" placeholder="Search banks...">
                                            </div>
                                            <div class="custom-select-options">
                                                <div class="custom-option" data-value="">Select Bank</div>
                                                <!-- Private Banks -->
                                                <div class="custom-option" data-value="Axis Bank">Axis Bank</div>
                                                <div class="custom-option" data-value="Bandhan Bank">Bandhan Bank</div>
                                                <div class="custom-option" data-value="City Union Bank">City Union Bank</div>
                                                <div class="custom-option" data-value="CSB Bank">CSB Bank</div>
                                                <div class="custom-option" data-value="DCB Bank">DCB Bank</div>
                                                <div class="custom-option" data-value="Dhanlaxmi Bank">Dhanlaxmi Bank</div>
                                                <div class="custom-option" data-value="Federal Bank">Federal Bank</div>
                                                <div class="custom-option" data-value="HDFC Bank">HDFC Bank</div>
                                                <div class="custom-option" data-value="ICICI Bank">ICICI Bank</div>
                                                <div class="custom-option" data-value="IDBI Bank">IDBI Bank</div>
                                                <div class="custom-option" data-value="IDFC FIRST Bank">IDFC FIRST Bank</div>
                                                <div class="custom-option" data-value="IndusInd Bank">IndusInd Bank</div>
                                                <div class="custom-option" data-value="Karnataka Bank">Karnataka Bank</div>
                                                <div class="custom-option" data-value="Kotak Mahindra Bank">Kotak Mahindra Bank</div>
                                                <div class="custom-option" data-value="Nainital Bank">Nainital Bank</div>
                                                <div class="custom-option" data-value="RBL Bank">RBL Bank</div>
                                                <div class="custom-option" data-value="South Indian Bank">South Indian Bank</div>
                                                <div class="custom-option" data-value="Tamilnad Mercantile Bank">Tamilnad Mercantile Bank</div>
                                                <div class="custom-option" data-value="YES Bank">YES Bank</div>

                                                <!-- Public Banks -->
                                                <div class="custom-option" data-value="Bank of Baroda">Bank of Baroda</div>
                                                <div class="custom-option" data-value="Bank of India">Bank of India</div>
                                                <div class="custom-option" data-value="Bank of Maharashtra">Bank of Maharashtra</div>
                                                <div class="custom-option" data-value="Canara Bank">Canara Bank</div>
                                                <div class="custom-option" data-value="Central Bank of India">Central Bank of India</div>
                                                <div class="custom-option" data-value="Indian Bank">Indian Bank</div>
                                                <div class="custom-option" data-value="Indian Overseas Bank">Indian Overseas Bank</div>
                                                <div class="custom-option" data-value="PNB Bank">PNB Bank</div>
                                                <div class="custom-option" data-value="Punjab & Sind Bank">Punjab & Sind Bank</div>
                                                <div class="custom-option" data-value="SBI Bank">SBI Bank</div>
                                                <div class="custom-option" data-value="UCO Bank">UCO Bank</div>

                                                <!-- NBFCs -->
                                                <div class="custom-option" data-value="Bajaj Finance">Bajaj Finance</div>
                                                <div class="custom-option" data-value="Bajaj Finserv">Bajaj Finserv</div>
                                                <div class="custom-option" data-value="Capri Global Capital">Capri Global Capital</div>
                                                <div class="custom-option" data-value="Cholamandalam Investment and Finance">Cholamandalam Investment and Finance</div>
                                                <div class="custom-option" data-value="Edelweiss Financial Services">Edelweiss Financial Services</div>
                                                <div class="custom-option" data-value="Fullerton India">Fullerton India</div>
                                                <div class="custom-option" data-value="HDB Financial Services">HDB Financial Services</div>
                                                <div class="custom-option" data-value="IIFL Finance">IIFL Finance</div>
                                                <div class="custom-option" data-value="InCred Finance">InCred Finance</div>
                                                <div class="custom-option" data-value="JM Financial">JM Financial</div>
                                                <div class="custom-option" data-value="L&T Finance">L&T Finance</div>
                                                <div class="custom-option" data-value="Mahindra Finance">Mahindra Finance</div>
                                                <div class="custom-option" data-value="Mas Financial Services">Mas Financial Services</div>
                                                <div class="custom-option" data-value="Motilal Oswal Financial Services">Motilal Oswal Financial Services</div>
                                                <div class="custom-option" data-value="Muthoot Finance">Muthoot Finance</div>
                                                <div class="custom-option" data-value="Piramal Capital & Housing Finance">Piramal Capital & Housing Finance</div>
                                                <div class="custom-option" data-value="Poonawalla Fincorp">Poonawalla Fincorp</div>
                                                <div class="custom-option" data-value="Reliance Capital">Reliance Capital</div>
                                                <div class="custom-option" data-value="Shriram Finance">Shriram Finance</div>
                                                <div class="custom-option" data-value="Srei Infrastructure Finance">Srei Infrastructure Finance</div>
                                                <div class="custom-option" data-value="Tata Capital">Tata Capital</div>
                                                <div class="custom-option" data-value="Ugro Capital">Ugro Capital</div>
                                                <div class="custom-option" data-value="Vistaar Financial Services">Vistaar Financial Services</div>

                                                <!-- Fintechs -->
                                                <div class="custom-option" data-value="50Fin">50Fin</div>
                                                <div class="custom-option" data-value="Capital Float">Capital Float</div>
                                                <div class="custom-option" data-value="CASHe">CASHe</div>
                                                <div class="custom-option" data-value="Credy">Credy</div>
                                                <div class="custom-option" data-value="Dhani">Dhani</div>
                                                <div class="custom-option" data-value="DMI Finance">DMI Finance</div>
                                                <div class="custom-option" data-value="Faircent">Faircent</div>
                                                <div class="custom-option" data-value="Fibe">Fibe</div>
                                                <div class="custom-option" data-value="Finnable">Finnable</div>
                                                <div class="custom-option" data-value="FlexSalary">FlexSalary</div>
                                                <div class="custom-option" data-value="Hero FinCorp">Hero FinCorp</div>
                                                <div class="custom-option" data-value="Home Credit India">Home Credit India</div>
                                                <div class="custom-option" data-value="i2iFunding">i2iFunding</div>
                                                <div class="custom-option" data-value="IndiaLends">IndiaLends</div>
                                                <div class="custom-option" data-value="Kissht">Kissht</div>
                                                <div class="custom-option" data-value="KreditBee">KreditBee</div>
                                                <div class="custom-option" data-value="LazyPay">LazyPay</div>
                                                <div class="custom-option" data-value="LenDenClub">LenDenClub</div>
                                                <div class="custom-option" data-value="Lendingkart">Lendingkart</div>
                                                <div class="custom-option" data-value="LoanTap">LoanTap</div>
                                                <div class="custom-option" data-value="MoneyTap">MoneyTap</div>
                                                <div class="custom-option" data-value="Moneyview">Moneyview</div>
                                                <div class="custom-option" data-value="Monexo">Monexo</div>
                                                <div class="custom-option" data-value="mPokket">mPokket</div>
                                                <div class="custom-option" data-value="Navi">Navi</div>
                                                <div class="custom-option" data-value="NIRA Finance">NIRA Finance</div>
                                                <div class="custom-option" data-value="NoBroker InstaCash">NoBroker InstaCash</div>
                                                <div class="custom-option" data-value="PayMe">PayMe</div>
                                                <div class="custom-option" data-value="PaySense">PaySense</div>
                                                <div class="custom-option" data-value="RapidRupee">RapidRupee</div>
                                                <div class="custom-option" data-value="RupeeLend">RupeeLend</div>
                                                <div class="custom-option" data-value="Rupifi">Rupifi</div>
                                                <div class="custom-option" data-value="SmartCoin">SmartCoin</div>
                                                <div class="custom-option" data-value="StashFin">StashFin</div>
                                                <div class="custom-option" data-value="Svatantra Microfin">Svatantra Microfin</div>
                                                <div class="custom-option" data-value="ZestMoney">ZestMoney</div>

                                                <!-- Foreign Banks -->
                                                <div class="custom-option" data-value="American Express Banking Corp">American Express Banking Corp</div>
                                                <div class="custom-option" data-value="Bank of China">Bank of China</div>
                                                <div class="custom-option" data-value="Barclays Bank">Barclays Bank</div>
                                                <div class="custom-option" data-value="Citibank">Citibank</div>
                                                <div class="custom-option" data-value="DBS Bank">DBS Bank</div>
                                                <div class="custom-option" data-value="Deutsche Bank">Deutsche Bank</div>
                                                <div class="custom-option" data-value="HSBC">HSBC</div>
                                                <div class="custom-option" data-value="SBM Bank">SBM Bank</div>
                                                <div class="custom-option" data-value="Standard Chartered Bank">Standard Chartered Bank</div>

                                                <!-- Small Finance Banks -->
                                                <div class="custom-option" data-value="AU Small Finance Bank">AU Small Finance Bank</div>
                                                <div class="custom-option" data-value="Capital Small Finance Bank">Capital Small Finance Bank</div>
                                                <div class="custom-option" data-value="Equitas Small Finance Bank">Equitas Small Finance Bank</div>
                                                <div class="custom-option" data-value="Jana Small Finance Bank">Jana Small Finance Bank</div>
                                                <div class="custom-option" data-value="North East Small Finance Bank">North East Small Finance Bank</div>
                                                <div class="custom-option" data-value="Shivalik Small Finance Bank">Shivalik Small Finance Bank</div>
                                                <div class="custom-option" data-value="Ujjivan Small Finance Bank">Ujjivan Small Finance Bank</div>
                                                <div class="custom-option" data-value="Utkarsh Small Finance Bank">Utkarsh Small Finance Bank</div>

                                                <!-- Other -->
                                                <div class="custom-option" data-value="OTHER">OTHER</div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td><input type="text" class="number-input tenure-input" placeholder="months" maxlength="3"></td>
                                <td><input type="text" class="number-input roi-input" placeholder="%" maxlength="6"></td>
                                <td><input type="text" class="number-input" oninput="formatNumber(this)" placeholder="Total loan amt"></td>
                                <td class="outstanding-cell"><input type="text" class="number-input os-input" oninput="formatNumber(this)" placeholder="Outstanding"></td>
                                <td class="emi-cell"><input type="text" class="number-input emi-input" oninput="formatNumber(this)" placeholder="EMI"></td>
                                <td class="actions-cell">
                                    <select class="action-select" onchange="setAction(this)">
                                        <option value="">Select Action</option>
                                        <option value="BT">BT</option>
                                        <option value="Obligate">Obligate</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                    <input type="hidden" class="action-state" value="">
                                    <input type="hidden" class="bt-applied" value="false">
                                    <input type="hidden" class="obligate-applied" value="false">
                                </td>
                                <td>
                                    <button class="delete-btn" onclick="deleteRow(this, event)" oncontextmenu="deleteRow(this, event); return false;" title="Click to delete row" style="display: none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(defaultRow);

                            // Initialize the product dropdown in the default row
                            initializeNewProductDropdown(defaultRow);

                            // Initialize the tenure input in the default row
                            const tenureInput = defaultRow.querySelector('.tenure-input');
                            if (tenureInput) {
                                tenureInput.addEventListener('input', formatTenureInput);
                                tenureInput.addEventListener('blur', formatTenureInput);
                                tenureInput.addEventListener('click', handleTenureInputClick);
                                tenureInput.addEventListener('focus', handleTenureInputClick);
                            }

                            // Initialize the ROI input in the default row
                            const roiInput = defaultRow.querySelector('.roi-input');
                            if (roiInput) {
                                roiInput.addEventListener('input', formatRoiInput);
                                roiInput.addEventListener('blur', formatRoiInput);
                                roiInput.addEventListener('click', handleRoiInputClick);
                                roiInput.addEventListener('focus', handleRoiInputClick);
                            }
                        }

                        // Sort rows
                        sortRows();

                        // Reinitialize all custom dropdowns to ensure they work properly
                        setTimeout(function() {
                            console.log("Reinitializing dropdowns after Excel import");
                            reinitializeAllCustomDropdowns();

                            // Add a message to inform the user
                            const errorDiv = document.getElementById('error');
                            errorDiv.style.backgroundColor = "#e6ffe6";
                            errorDiv.style.color = "#006600";
                            errorDiv.textContent = "Excel data imported successfully. If dropdowns don't work, click the 'Fix Dropdowns' button.";
                            errorDiv.style.display = "block";

                            // Hide the message after 5 seconds
                            setTimeout(function() {
                                errorDiv.style.display = "none";
                            }, 5000);
                        }, 500);

                        console.log("Excel import completed successfully");
                    }
                } catch (error) {
                    document.getElementById('error').textContent = 'Error reading Excel file: ' + error.message;
                    document.getElementById('error').style.display = 'block';
                    console.error('Upload error:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Initialize event listeners for ROI inputs and input change tracking
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize ROI inputs
            initializeRoiInputs();

            // Initialize TENURE inputs
            initializeTenureInputs();

            // Initialize input change listeners for automatic total updates
            initializeInputListeners();

            // Initialize eligibility total income field
            initializeEligibilityTotalIncome();

            // Initialize eligibility tenure and ROI fields
            initializeEligibilityTenureAndRoi();

            // Create a MutationObserver to watch for new rows being added
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        initializeRoiInputs();
                        initializeTenureInputs();
                        initializeInputListeners();
                    }
                });
            });

            // Start observing the table body for changes
            observer.observe(document.getElementById('obligationsBody'), { childList: true, subtree: true });

            // Initial calculation of totals
            recalculateTotals();
        });

        function initializeRoiInputs() {
            // Get all ROI inputs
            const roiInputs = document.querySelectorAll('.roi-input');

            roiInputs.forEach(function(input) {
                // Remove existing listeners to avoid duplicates
                input.removeEventListener('input', formatRoiInput);
                input.removeEventListener('blur', formatRoiInput);
                input.removeEventListener('click', handleRoiInputClick);
                input.removeEventListener('focus', handleRoiInputClick);

                // Add new listeners
                input.addEventListener('input', formatRoiInput);
                input.addEventListener('blur', formatRoiInput);
                input.addEventListener('click', handleRoiInputClick);
                input.addEventListener('focus', handleRoiInputClick);
            });
        }

        // Enhanced approach for ROI inputs
        function formatRoiInput(event) {
            const input = event.target;

            if (event.type === 'input') {
                // Allow only numbers and one decimal point
                let value = input.value;

                // Remove any % signs and spaces
                value = value.replace(/%/g, '').replace(/\s/g, '');

                // Keep track of cursor position
                const cursorPos = input.selectionStart;

                // Allow only digits and one decimal point
                let cleanValue = '';
                let hasDecimal = false;
                let digitsBeforeDecimal = 0;
                let digitsAfterDecimal = 0;

                for (let i = 0; i < value.length; i++) {
                    const char = value[i];

                    if (char === '.' && !hasDecimal) {
                        cleanValue += char;
                        hasDecimal = true;
                    } else if (char >= '0' && char <= '9') {
                        if (!hasDecimal) {
                            if (digitsBeforeDecimal < 2) {
                                cleanValue += char;
                                digitsBeforeDecimal++;
                            }
                        } else {
                            if (digitsAfterDecimal < 2) {
                                cleanValue += char;
                                digitsAfterDecimal++;
                            }
                        }
                    }
                }

                // Update the input value
                if (cleanValue !== value) {
                    // Calculate new cursor position
                    let newCursorPos = cursorPos - (value.length - cleanValue.length);
                    newCursorPos = Math.max(0, Math.min(newCursorPos, cleanValue.length));

                    input.value = cleanValue;

                    // Set cursor position
                    setTimeout(() => {
                        input.setSelectionRange(newCursorPos, newCursorPos);
                    }, 0);
                } else {
                    input.value = cleanValue;
                }

                // Trigger font size adjustment immediately
                adjustFontSize();
            } else if (event.type === 'blur') {
                // When losing focus, format with % sign
                let value = input.value.trim();

                if (value) {
                    // Remove any existing % signs
                    value = value.replace(/%/g, '').replace(/\s/g, '');

                    // Format with % sign (no space)
                    input.value = value + "%";

                    // Ensure proper styling for ROI display - make it look exactly like other inputs
                    input.style.textAlign = 'center';
                    input.style.fontWeight = '700';
                    input.style.backgroundColor = '#fff';
                    input.style.border = '1px solid #333';
                    input.style.borderRadius = '4px';
                    input.style.boxShadow = 'inset 0 1px 2px rgba(0,0,0,0.1)';
                    input.style.padding = '8px 10px';
                    input.style.height = '38px';

                    // Ensure the input has the roi-input class for styling
                    input.classList.add('roi-input');

                    // Trigger font size adjustment after adding "%"
                    setTimeout(adjustFontSize, 0);
                }
            }
        }

        // Function to handle clicks on ROI inputs
        function handleRoiInputClick(event) {
            const input = event.target;

            // Ensure the input has the roi-input class for styling
            input.classList.add('roi-input');

            // When clicking on an input that has "%", remove the "%" part
            if (input.value.includes("%")) {
                // Remove the "%" and any spaces
                const numericPart = input.value.replace(/%/g, '').trim();
                input.value = numericPart;

                // Position cursor at the end
                setTimeout(() => {
                    input.setSelectionRange(numericPart.length, numericPart.length);
                }, 0);
            }
        }

        function initializeTenureInputs() {
            // Get all TENURE inputs
            const tenureInputs = document.querySelectorAll('.tenure-input');

            tenureInputs.forEach(function(input) {
                // Remove existing listeners to avoid duplicates
                input.removeEventListener('input', formatTenureInput);
                input.removeEventListener('blur', formatTenureInput);
                input.removeEventListener('click', handleTenureInputClick);
                input.removeEventListener('focus', handleTenureInputClick);

                // Add new listeners
                input.addEventListener('input', formatTenureInput);
                input.addEventListener('blur', formatTenureInput);
                input.addEventListener('click', handleTenureInputClick);
                input.addEventListener('focus', handleTenureInputClick);
            });
        }

        // Keep track of which inputs are currently being edited
        const editingTenureInputs = new Set();

        /**
         * Shows a popup with the specified ID and message.
         * @param {string} popupId - The ID of the popup element to show.
         * @param {string} message - The message to display in the popup (if applicable).
         */
        function showPopup(popupId, message) {
            const popup = document.getElementById(popupId);

            if (popup && (popupId === 'foirInfoPopup' || popupId === 'tenureInfoPopup')) {
                popup.classList.add('active');
            } else {
                console.error("Popup not found for ID:", popupId);
                alert(message); // Fallback alert
            }
        }

        /**
         * Closes the specified popup.
         * @param {string} popupId - The ID of the popup element to close.
         */
        function closePopup(popupId) {
            const popup = document.getElementById(popupId);
            if (popup) {
                popup.classList.remove('active');
            }
        }

        /**
         * Shows the FOIR info popup.
         */
        function showFoirInfoPopup() {
            showPopup('foirInfoPopup', '');
        }

        /**
         * Shows the Tenure info popup.
         */
        function showTenureInfoPopup() {
            showPopup('tenureInfoPopup', '');
        }

        function formatTenureInput(event) {
            const input = event.target;

            // If this is an input event, mark this input as being edited
            if (event.type === 'input') {
                editingTenureInputs.add(input);

                // Just allow normal typing without formatting while editing
                // Only keep the numeric part (up to 3 digits)
                let value = input.value.replace(/[^0-9]/g, '');
                if (value.length > 3) {
                    value = value.substring(0, 3);
                }

                // Update the input value without appending "Months" yet
                input.value = value;

                // Trigger font size adjustment immediately
                adjustFontSize();
                return;
            }

            // If this is a blur event, format the input with "Months"
            if (event.type === 'blur') {
                // Remove this input from the editing set
                editingTenureInputs.delete(input);

                // Get the numeric part
                let numericPart = input.value.replace(/[^0-9]/g, '');

                if (numericPart === '') {
                    input.value = '';
                    return;
                }

                // Limit to 3 digits
                if (numericPart.length > 3) {
                    numericPart = numericPart.substring(0, 3);
                }

                const num = parseInt(numericPart);
                if (isNaN(num)) {
                    input.value = '';
                    return;
                }

                // Set the value with "Months" appended only when losing focus
                input.value = numericPart + " Months";

                // Trigger font size adjustment after adding "Months"
                setTimeout(adjustFontSize, 0);
            }
        }

        // Function to handle clicks on tenure inputs
        function handleTenureInputClick(event) {
            const input = event.target;

            // When clicking on an input that has "Months", remove the "Months" part
            // to allow easier editing
            if (input.value.includes(" Months")) {
                const numericPart = input.value.replace(/ Months/g, '');
                input.value = numericPart;

                // Mark this input as being edited
                editingTenureInputs.add(input);

                // Position cursor at the end of the numeric part
                setTimeout(() => {
                    input.setSelectionRange(numericPart.length, numericPart.length);
                }, 0);
            }
        }

        function initializeInputListeners() {
            // Add input event listeners to all Outstanding and EMI inputs
            document.querySelectorAll('.os-input, .emi-input').forEach(input => {
                // Remove existing listeners to avoid duplicates
                input.removeEventListener('input', handleInputChange);
                input.removeEventListener('change', handleInputChange);

                // Add new listeners
                input.addEventListener('input', handleInputChange);
                input.addEventListener('change', handleInputChange);
            });

            // Check for Credit Card rows and set up automatic EMI calculation
            document.querySelectorAll('#obligationsBody tr').forEach(row => {
                const productValue = row.querySelector('.product-value');
                const osInput = row.querySelector('.os-input');
                const emiInput = row.querySelector('.emi-input');
                const tenureInput = row.querySelector('.tenure-input');
                const roiInput = row.querySelector('.roi-input');

                if (productValue && productValue.value === "CC (Credit Card)") {
                    // Hide tenure and ROI fields for Credit Card
                    if (tenureInput) {
                        tenureInput.style.display = 'none';
                        tenureInput.parentElement.style.backgroundColor = '#000000'; // Black background for hidden field
                    }

                    if (roiInput) {
                        roiInput.style.display = 'none';
                        roiInput.parentElement.style.backgroundColor = '#000000'; // Black background for hidden field
                    }

                    if (osInput && emiInput) {
                        // Set up special listener for Credit Card outstanding input
                        osInput.addEventListener('input', function() {
                            const outstandingValue = parseIndianNumber(this.value);
                            const emiValue = Math.round(outstandingValue * 0.05); // 5% of outstanding
                            emiInput.value = emiValue.toLocaleString('en-IN');
                        });

                        // Calculate EMI immediately if outstanding already has a value
                        if (osInput.value) {
                            const outstandingValue = parseIndianNumber(osInput.value);
                            const emiValue = Math.round(outstandingValue * 0.05); // 5% of outstanding
                            emiInput.value = emiValue.toLocaleString('en-IN', {maximumFractionDigits: 0});
                        }
                    }
                }
            });
        }

        function handleInputChange(event) {
            const input = event.target;
            const row = input.closest('tr');
            const actionState = row.querySelector('.action-state').value;

            // Special handling for Credit Card EMI calculation
            if (input.classList.contains('os-input')) {
                const productValue = row.querySelector('.product-value');
                const emiInput = row.querySelector('.emi-input');

                if (productValue && emiInput && productValue.value === "CC (Credit Card)") {
                    const outstandingValue = parseIndianNumber(input.value);
                    const emiValue = Math.round(outstandingValue * 0.05); // 5% of outstanding
                    emiInput.value = emiValue.toLocaleString('en-IN', {maximumFractionDigits: 0});
                }
            }

            // If this row has an action applied, recalculate totals
            if (actionState === 'BT' || actionState === 'Obligate') {
                recalculateTotals();
            }
        }

        // Initialize the eligibility total income field
        function initializeEligibilityTotalIncome() {
            const eligibilityTotalIncome = document.getElementById('eligibilityTotalIncome');
            if (eligibilityTotalIncome) {
                // Set initial value from the main total income
                const totalIncome = document.getElementById('total');
                if (totalIncome) {
                    eligibilityTotalIncome.value = totalIncome.textContent;
                }

                // Add event listener to track when user edits the field
                eligibilityTotalIncome.addEventListener('input', function() {
                    // Mark that the user has edited this field
                    this._userEdited = true;
                });

                // Format the number when user finishes editing
                eligibilityTotalIncome.addEventListener('blur', function() {
                    const value = parseIndianNumber(this.value);
                    if (value > 0) {
                        this.value = value.toLocaleString('en-IN', {maximumFractionDigits: 0});
                        // Recalculate Monthly EMI Can Pay when total income changes
                        calculateMonthlyEmiCanPay();
                    }
                });
            }

            // Initialize FOIR input - now readonly, no event listeners needed
            const foirInput = document.getElementById('foirPercentage');
            // No event listeners needed for readonly field

            // Initialize total obligation field
            updateEligibilityTotalObligation();
        }

        /**
         * Handles changes in the company category dropdown.
         */
        function resetFOIRAndCalculate() {
            const companyCategory = document.getElementById('companyCategory').value;
            const foirInput = document.getElementById('foirPercentage');
            const foirToggleBtn = document.getElementById('foirToggleBtn');
            const foirButtonsContainer = document.getElementById('foirButtonsContainer');
            const customFoirInputContainer = document.getElementById('customFoirInputContainer');
            const salary = parseIndianNumber(document.getElementById('salary').value);

            // Show/Hide FOIR Toggle/Options based on selection
            if (companyCategory && companyCategory !== 'UNLISTED') {
                foirToggleBtn.style.display = 'inline-block'; // Show toggle
                foirButtonsContainer.style.display = 'none'; // Hide FOIR buttons
                customFoirInputContainer.style.display = 'none'; // Hide custom FOIR input
                foirToggleBtn.classList.remove('active'); // Reset toggle state
                calculateFOIR(); // Calculate FOIR based on salary and category
            } else if (companyCategory === 'UNLISTED') {
                foirToggleBtn.style.display = 'none'; // Hide toggle
                foirButtonsContainer.style.display = 'flex'; // Show FOIR buttons
                customFoirInputContainer.style.display = 'flex'; // Show custom FOIR input
                // Reset button highlights
                const buttons = document.querySelectorAll('#foirButtonsContainer button');
                buttons.forEach(btn => {
                    btn.style.background = 'var(--editable-bg)';
                });
                foirInput.value = ''; // Clear FOIR for manual selection
            } else { // No category selected
                foirToggleBtn.style.display = 'none';
                foirButtonsContainer.style.display = 'none'; // Hide FOIR buttons
                customFoirInputContainer.style.display = 'none'; // Hide custom FOIR input
                foirInput.value = ''; // Clear fields
            }

            // Recalculate Monthly EMI Can Pay when FOIR changes
            calculateMonthlyEmiCanPay();

            // Calculate eligibility when company category changes
            calculateEligibility();
        }

        /**
         * Calculates the base FOIR percentage based on salary and company category.
         */
        function calculateFOIR() {
            const salary = parseIndianNumber(document.getElementById('salary').value);
            const companyCategory = document.getElementById('companyCategory').value;
            const foirInput = document.getElementById('foirPercentage');

            // Don't proceed if salary invalid or category allows manual input
            if (isNaN(salary) || salary <= 0 || !companyCategory || companyCategory === 'UNLISTED') {
                if (companyCategory !== 'UNLISTED') { // Clear only if not manual mode
                    foirInput.value = '';
                }
                calculateMonthlyEmiCanPay(); // Update dependent fields
                return;
            }

            // Determine FOIR based on rules
            let foir = 0;
            if (companyCategory === 'SUPER_CAT_A' || companyCategory === 'CAT_A' || companyCategory === 'CAT_B') {
                if (salary <= 34999) foir = 50;
                else if (salary <= 49999) foir = 60;
                else if (salary <= 74999) foir = 65;
                else foir = 70;
            } else if (companyCategory === 'CAT_C') {
                if (salary <= 34999) foir = 45;
                else if (salary <= 49999) foir = 50;
                else if (salary <= 74999) foir = 60;
                else foir = 70;
            }

            // Ensure toggle is reset when base FOIR recalculates
            document.getElementById('foirToggleBtn').classList.remove('active');
            foirInput.value = foir;
            calculateMonthlyEmiCanPay(); // Calculate EMI based on new FOIR
            calculateEligibility(); // Calculate eligibility when FOIR changes
        }

        /**
         * Handles selection of manual FOIR percentage.
         * @param {number} foir - The selected FOIR percentage.
         */
        function selectFOIR(foir) {
            const foirInput = document.getElementById('foirPercentage');
            foirInput.value = foir;

            // Highlight the selected button
            const buttons = document.querySelectorAll('#foirButtonsContainer button');
            buttons.forEach(btn => {
                if (btn.textContent === foir + '%') {
                    btn.style.background = 'var(--primary)';
                } else {
                    btn.style.background = 'var(--editable-bg)';
                }
            });

            // Clear the custom input field when a preset is selected
            document.getElementById('customFoirInputInline').value = '';

            calculateMonthlyEmiCanPay(); // Update EMI based on selected FOIR
            calculateEligibility(); // Calculate eligibility when FOIR changes
        }

        /**
         * Applies a custom FOIR percentage from the input field.
         */
        function applyCustomFOIR() {
            const customFoirInput = document.getElementById('customFoirInput');
            let customFoir = parseFloat(customFoirInput.value.replace(/[^0-9.]/g, ''));

            // Validate the input
            if (isNaN(customFoir) || customFoir <= 0) {
                alert('Please enter a valid FOIR percentage greater than 0.');
                return;
            }

            // Cap the FOIR at a reasonable maximum (e.g., 100%)
            customFoir = Math.min(100, customFoir);

            // Update the FOIR input field
            const foirInput = document.getElementById('foirPercentage');
            foirInput.value = customFoir;

            calculateMonthlyEmiCanPay(); // Update EMI based on selected FOIR
            calculateEligibility(); // Calculate eligibility when FOIR changes
        }

        /**
         * Applies a custom FOIR percentage from the inline input field.
         */
        function applyCustomFOIRInline() {
            const customFoirInput = document.getElementById('customFoirInputInline');
            let customFoir = parseFloat(customFoirInput.value.replace(/[^0-9.]/g, ''));

            // Validate the input
            if (isNaN(customFoir) || customFoir <= 0) {
                alert('Please enter a valid FOIR percentage greater than 0.');
                return;
            }

            // Cap the FOIR at a reasonable maximum (e.g., 100%)
            customFoir = Math.min(100, customFoir);

            // Update the FOIR input field
            const foirInput = document.getElementById('foirPercentage');
            foirInput.value = customFoir;

            // Reset button highlights
            const buttons = document.querySelectorAll('#foirButtonsContainer button');
            buttons.forEach(btn => {
                btn.style.background = 'var(--editable-bg)';
            });

            calculateMonthlyEmiCanPay(); // Update EMI based on selected FOIR
            calculateEligibility(); // Calculate eligibility when FOIR changes
        }

        /**
         * Toggles the +5% FOIR adjustment.
         */
        function toggleFOIR() {
            const foirInput = document.getElementById('foirPercentage');
            const foirToggleBtn = document.getElementById('foirToggleBtn');
            let foir = parseInt(foirInput.value);

            if (isNaN(foir)) return; // Don't toggle if base FOIR isn't set

            if (foirToggleBtn.classList.contains('active')) { // If active, deactivate and subtract 5
                foir -= 5;
                foirToggleBtn.classList.remove('active');
            } else { // If inactive, activate and add 5
                foir += 5;
                foirToggleBtn.classList.add('active');
            }

            foir = Math.min(80, Math.max(40, foir)); // Clamp FOIR between 40% and 80%
            foirInput.value = foir; // Update display
            calculateMonthlyEmiCanPay(); // Update EMI
            calculateEligibility(); // Calculate eligibility when FOIR changes
        }

        // Update the eligibility total obligation field
        function updateEligibilityTotalObligation() {
            const mainTotalObligation = document.getElementById('totalObligation');
            const eligibilityTotalObligation = document.getElementById('eligibilityTotalObligation');
            const mainTotalBtPos = document.getElementById('totalBtPos');
            const eligibilityTotalBtPos = document.getElementById('eligibilityTotalBtPos');

            if (mainTotalObligation && eligibilityTotalObligation) {
                eligibilityTotalObligation.value = mainTotalObligation.value;
            }

            if (mainTotalBtPos && eligibilityTotalBtPos) {
                eligibilityTotalBtPos.value = mainTotalBtPos.value;
            }

            // Also update the Monthly EMI Can Pay field
            calculateMonthlyEmiCanPay();

            // Calculate eligibility when Total Obligation changes
            calculateEligibility();
        }

        /**
         * Toggle the visibility of the "Divide by months" section based on bonus value
         */
        function toggleDivideByMonths() {
            const bonusInput = document.getElementById('bonus');
            const divideByMonthsSection = document.getElementById('divideByMonthsSection');

            if (bonusInput && divideByMonthsSection) {
                const bonusValue = parseIndianNumber(bonusInput.value);

                // Show the section only if bonus has a value greater than 0
                if (bonusValue > 0) {
                    divideByMonthsSection.style.display = 'block';
                } else {
                    divideByMonthsSection.style.display = 'none';

                    // Reset any active bonus button when bonus is cleared
                    if (activeBonusButton) {
                        activeBonusButton = null;
                        dividedBonusAmount = 0; // Reset the divided bonus amount

                        // Reset all button styles to default
                        document.getElementById('bonusButton3').style.background = 'var(--editable-bg)';
                        document.getElementById('bonusButton6').style.background = 'var(--editable-bg)';
                        document.getElementById('bonusButton12').style.background = 'var(--editable-bg)';
                        document.getElementById('bonusButton24').style.background = 'var(--editable-bg)';

                        // Recalculate total
                        calculateTotal();
                    }
                }
            }
        }

        /**
         * Applies the bonus amount divided by the specified months.
         * The bonus is divided by the specified months and added to the total income calculation.
         * @param {number} months - The number of months to divide the bonus by (3, 6, 12, or 24).
         */
        function applyBonus(months) {
            const bonusAmount = parseIndianNumber(document.getElementById('bonus').value);
            if (isNaN(bonusAmount) || bonusAmount <= 0) {
                console.log('Invalid bonus amount');
                return;
            }

            // Store original salary if this is the first bonus application
            if (!activeBonusButton) {
                originalSalary = parseIndianNumber(document.getElementById('salary').value) || 0;
            }

            // Reset all button styles to default
            document.getElementById('bonusButton3').style.background = 'var(--editable-bg)';
            document.getElementById('bonusButton3').style.color = 'var(--text-dark)';
            document.getElementById('bonusButton6').style.background = 'var(--editable-bg)';
            document.getElementById('bonusButton6').style.color = 'var(--text-dark)';
            document.getElementById('bonusButton12').style.background = 'var(--editable-bg)';
            document.getElementById('bonusButton12').style.color = 'var(--text-dark)';
            document.getElementById('bonusButton24').style.background = 'var(--editable-bg)';
            document.getElementById('bonusButton24').style.color = 'var(--text-dark)';

            // If clicking the same button that's already active, deactivate it
            if (activeBonusButton === months) {
                activeBonusButton = null;
                dividedBonusAmount = 0; // Reset the divided bonus amount
            } else {
                // Calculate the divided bonus amount
                dividedBonusAmount = Math.round(bonusAmount / months); // Round to ensure whole number

                // Set the new active button
                activeBonusButton = months;
                lastAppliedBonus = bonusAmount;

                // Highlight only the active button
                if (months === 3) {
                    document.getElementById('bonusButton3').style.background = 'var(--primary)';
                    document.getElementById('bonusButton3').style.color = '#000';
                } else if (months === 6) {
                    document.getElementById('bonusButton6').style.background = 'var(--primary)';
                    document.getElementById('bonusButton6').style.color = '#000';
                } else if (months === 12) {
                    document.getElementById('bonusButton12').style.background = 'var(--primary)';
                    document.getElementById('bonusButton12').style.color = '#000';
                } else {
                    document.getElementById('bonusButton24').style.background = 'var(--primary)';
                    document.getElementById('bonusButton24').style.color = '#000';
                }
            }

            // Update the Total Income field with the new values
            calculateTotal();

            // Recalculate FOIR when total income changes
            calculateFOIR();

            // Calculate eligibility when total income changes
            calculateEligibility();
        }

        /**
         * Calculates and updates the Monthly EMI Can Pay field and FOIR AMOUNT.
         */
        function calculateMonthlyEmiCanPay() {
            console.log("calculateMonthlyEmiCanPay called");

            const totalIncomeInput = document.getElementById('eligibilityTotalIncome');
            const foirInput = document.getElementById('foirPercentage');
            const totalObligationInput = document.getElementById('eligibilityTotalObligation');
            const monthlyEmiCanPayInput = document.getElementById('monthlyEmiCanPay');
            const foirAmountInput = document.getElementById('foirAmount');

            if (!totalIncomeInput || !foirInput || !totalObligationInput || !monthlyEmiCanPayInput || !foirAmountInput) {
                console.warn("Missing required elements for Monthly EMI Can Pay calculation");
                return;
            }

            // Ensure we have the latest total obligation value
            const mainTotalObligation = document.getElementById('totalObligation');
            if (mainTotalObligation && totalObligationInput) {
                totalObligationInput.value = mainTotalObligation.value;
            }

            const totalIncome = parseIndianNumber(totalIncomeInput.value || '0');
            const foirValue = parseInt(foirInput.value || '0');
            const totalObligation = parseIndianNumber(totalObligationInput.value || '0');

            console.log("Monthly EMI Can Pay calculation inputs:", {
                totalIncome,
                foirValue,
                totalObligation
            });

            if (isNaN(totalIncome) || isNaN(foirValue) || foirValue <= 0) {
                console.warn("Invalid inputs for Monthly EMI Can Pay calculation");
                monthlyEmiCanPayInput.value = '';
                foirAmountInput.value = '';
                return;
            }

            // Calculate maximum EMI based on FOIR
            const maxEmiBasedOnFoir = Math.round(totalIncome * foirValue / 100);

            // Calculate FOIR AMOUNT (the amount after applying FOIR percentage to total income)
            const foirAmount = maxEmiBasedOnFoir;

            // Update FOIR AMOUNT field
            foirAmountInput.value = Math.round(foirAmount).toLocaleString('en-IN', {maximumFractionDigits: 0});
            foirAmountInput.style.backgroundColor = '#000000'; // Pure black background
            foirAmountInput.style.color = '#ffffff'; // Pure white text
            foirAmountInput.style.border = '1px solid rgba(0, 255, 127, 0.2)';
            foirAmountInput.style.fontWeight = 'bold';

            // Subtract existing obligations
            const monthlyEmiCanPay = Math.max(0, maxEmiBasedOnFoir - totalObligation);

            console.log("Monthly EMI Can Pay calculation results:", {
                maxEmiBasedOnFoir,
                foirAmount,
                monthlyEmiCanPay
            });

            // Update the field with appropriate styling
            if (monthlyEmiCanPay <= 0 && (maxEmiBasedOnFoir > 0 || totalObligation > 0)) {
                // Not eligible
                monthlyEmiCanPayInput.value = 'Not Eligible';
                monthlyEmiCanPayInput.style.backgroundColor = '#ff4444';
                monthlyEmiCanPayInput.style.color = '#ffffff'; // Pure white text
                monthlyEmiCanPayInput.style.border = '1px solid #ff4444';
                monthlyEmiCanPayInput.style.fontWeight = '700';
            } else if (monthlyEmiCanPay > 0) {
                // Eligible
                monthlyEmiCanPayInput.value = Math.round(monthlyEmiCanPay).toLocaleString('en-IN', {maximumFractionDigits: 0});
                monthlyEmiCanPayInput.style.backgroundColor = '#000000'; // Pure black background
                monthlyEmiCanPayInput.style.color = '#ffffff'; // Pure white text
                monthlyEmiCanPayInput.style.border = '1px solid rgba(0, 255, 127, 0.2)';
                monthlyEmiCanPayInput.style.fontWeight = 'bold';
            } else {
                // No data
                monthlyEmiCanPayInput.value = '';
                monthlyEmiCanPayInput.style.backgroundColor = '#000000'; // Pure black background
                monthlyEmiCanPayInput.style.color = '#ffffff'; // Pure white text
                monthlyEmiCanPayInput.style.border = '1px solid rgba(0, 255, 127, 0.2)';
                monthlyEmiCanPayInput.style.fontWeight = 'bold';
            }

            // Automatically calculate eligibility when Monthly EMI Can Pay changes
            calculateEligibility();
        }

        // Initialize the eligibility tenure and ROI fields
        function initializeEligibilityTenureAndRoi() {
            const tenureMonthsInput = document.getElementById('eligibilityTenureMonths');
            const tenureYearsInput = document.getElementById('eligibilityTenureYears');
            const roiInput = document.getElementById('eligibilityRoi');

            if (tenureMonthsInput && tenureYearsInput) {
                // Handle tenure months input
                tenureMonthsInput.addEventListener('input', function() {
                    // Only allow numbers
                    this.value = this.value.replace(/[^0-9]/g, '');

                    // Update years field
                    updateTenureYears();
                });

                // Format tenure months when losing focus
                tenureMonthsInput.addEventListener('blur', function() {
                    if (this.value) {
                        // Add "Months" text when losing focus
                        if (!this.value.includes(' Months')) {
                            this.value = this.value + ' Months';
                        }
                    }

                    // Update years field
                    updateTenureYears();
                });

                // Remove "Months" text when focusing
                tenureMonthsInput.addEventListener('focus', function() {
                    if (this.value) {
                        this.value = this.value.replace(' Months', '');
                    }
                });
            }

            if (roiInput) {
                // Handle ROI input
                roiInput.addEventListener('input', function() {
                    // Only allow numbers and decimal point
                    this.value = this.value.replace(/[^0-9.]/g, '');

                    // Ensure only one decimal point
                    const parts = this.value.split('.');
                    if (parts.length > 2) {
                        this.value = parts[0] + '.' + parts.slice(1).join('');
                    }

                    // Limit to 2 decimal places
                    if (parts.length > 1 && parts[1].length > 2) {
                        this.value = parts[0] + '.' + parts[1].substring(0, 2);
                    }
                });

                // Format ROI when losing focus
                roiInput.addEventListener('blur', function() {
                    if (this.value) {
                        // Add % sign when losing focus
                        if (!this.value.includes('%')) {
                            this.value = this.value + '%';
                        }
                    }
                });

                // Remove % sign when focusing
                roiInput.addEventListener('focus', function() {
                    if (this.value) {
                        this.value = this.value.replace('%', '');
                    }
                });
            }
        }

        // Update the tenure years field based on months
        function updateTenureYears() {
            const tenureMonthsInput = document.getElementById('eligibilityTenureMonths');
            const tenureYearsInput = document.getElementById('eligibilityTenureYears');

            if (tenureMonthsInput && tenureYearsInput) {
                const monthsValue = parseInt(tenureMonthsInput.value.replace(/[^0-9]/g, ''));

                if (!isNaN(monthsValue) && monthsValue > 0) {
                    // Calculate years without decimal places
                    const years = Math.round(monthsValue / 12);
                    tenureYearsInput.value = years + ' Years';
                } else {
                    tenureYearsInput.value = '';
                }
            }
        }

        // Add event listeners for salary, partner's salary, and bonus inputs
        document.addEventListener('DOMContentLoaded', function() {
            const salaryInput = document.getElementById('salary');
            const partnerSalaryInput = document.getElementById('partnerSalary');
            const bonusInput = document.getElementById('bonus');

            salaryInput.addEventListener('input', function() {
                // Reset bonus button state when salary is manually changed
                if (activeBonusButton) {
                    activeBonusButton = null;
                    dividedBonusAmount = 0; // Reset the divided bonus amount

                    // Reset all button styles to default
                    document.getElementById('bonusButton3').style.background = 'var(--editable-bg)';
                    document.getElementById('bonusButton3').style.color = 'var(--text-dark)';
                    document.getElementById('bonusButton6').style.background = 'var(--editable-bg)';
                    document.getElementById('bonusButton6').style.color = 'var(--text-dark)';
                    document.getElementById('bonusButton12').style.background = 'var(--editable-bg)';
                    document.getElementById('bonusButton12').style.color = 'var(--text-dark)';
                    document.getElementById('bonusButton24').style.background = 'var(--editable-bg)';
                    document.getElementById('bonusButton24').style.color = 'var(--text-dark)';
                    originalSalary = parseIndianNumber(this.value) || 0;
                }

                // Update the Total Income field
                calculateTotal();

                // Recalculate FOIR when salary changes
                calculateFOIR();
            });

            partnerSalaryInput.addEventListener('input', function() {
                // Update the Total Income field
                calculateTotal();

                // Recalculate FOIR when partner's salary changes
                calculateFOIR();
            });

            bonusInput.addEventListener('input', function() {
                // If bonus amount changes and a button is active, reset the divided bonus amount
                if (activeBonusButton) {
                    const currentBonusAmount = parseIndianNumber(this.value) || 0;
                    // Only reset if the bonus amount has changed significantly (more than 1 rupee difference)
                    if (Math.abs(currentBonusAmount - lastAppliedBonus) > 1) {
                        // Reset the active button state
                        activeBonusButton = null;
                        dividedBonusAmount = 0; // Reset the divided bonus amount

                        // Reset all button styles to default
                        document.getElementById('bonusButton3').style.background = 'var(--editable-bg)';
                        document.getElementById('bonusButton3').style.color = 'var(--text-dark)';
                        document.getElementById('bonusButton6').style.background = 'var(--editable-bg)';
                        document.getElementById('bonusButton6').style.color = 'var(--text-dark)';
                        document.getElementById('bonusButton12').style.background = 'var(--editable-bg)';
                        document.getElementById('bonusButton12').style.color = 'var(--text-dark)';
                        document.getElementById('bonusButton24').style.background = 'var(--editable-bg)';
                        document.getElementById('bonusButton24').style.color = 'var(--text-dark)';

                        // Recalculate total
                        calculateTotal();

                        // Recalculate FOIR when total income changes
                        calculateFOIR();
                    }
                }
            });

            // Initialize the company category dropdown
            const companyCategory = document.getElementById('companyCategory');
            if (companyCategory) {
                // Set initial state
                resetFOIRAndCalculate();

                // Add event listener for changes
                companyCategory.addEventListener('change', resetFOIRAndCalculate);
            }

            // Initialize the custom FOIR input
            const customFoirInput = document.getElementById('customFoirInput');
            if (customFoirInput) {
                customFoirInput.addEventListener('input', function() {
                    // Only allow numbers and decimal point
                    this.value = this.value.replace(/[^0-9.]/g, '');

                    // Ensure only one decimal point
                    const parts = this.value.split('.');
                    if (parts.length > 2) {
                        this.value = parts[0] + '.' + parts.slice(1).join('');
                    }
                });
            }

            // These functions have been moved to the global scope
            // No need to redefine them here

            // Update tenure years when months change
            function updateTenureYears() {
                const months = getNumericValue(document.getElementById('eligibilityTenureMonths'), ' Months');
                const years = months / 12;

                if (months > 0) {
                    document.getElementById('eligibilityTenureYears').value =
                        Math.round(years) + ' Years';
                } else {
                    document.getElementById('eligibilityTenureYears').value = '';
                }
            }

            // Initialize multiplier input for automatic calculation
            const multiplierValue = document.getElementById('multiplierValue');
            if (multiplierValue) {
                multiplierValue.addEventListener('input', function(e) {
                    // Only allow numbers
                    let value = e.target.value.replace(/[^0-9]/g, '');

                    // Parse the value
                    let num = parseInt(value);

                    // Handle validation
                    if (!isNaN(num)) {
                        // Cap at 35
                        if (num > 35) {
                            num = 35;
                            e.target.value = '35';
                        } else {
                            e.target.value = num.toString();
                        }
                    } else if (value === '') {
                        // Allow empty value
                        e.target.value = '';
                    } else {
                        // Invalid input, reset
                        e.target.value = '';
                    }

                    // Calculate eligibility with the new value
                    calculateEligibility();
                });
            }

            // Initialize tenure months input
            const eligibilityTenureMonths = document.getElementById('eligibilityTenureMonths');
            if (eligibilityTenureMonths) {
                eligibilityTenureMonths.addEventListener('input', function() {
                    updateTenureYears();
                    calculateEligibility(); // Auto-calculate on input
                });

                eligibilityTenureMonths.addEventListener('blur', function() {
                    const value = this.value.replace(/[^\d]/g, '');
                    if (value) {
                        this.value = value + ' Months';
                        updateTenureYears();
                        calculateEligibility(); // Auto-calculate on blur
                    }
                });

                eligibilityTenureMonths.addEventListener('focus', function() {
                    this.value = this.value.replace(' Months', '');
                });
            }

            // Initialize ROI input
            const eligibilityRoi = document.getElementById('eligibilityRoi');
            if (eligibilityRoi) {
                eligibilityRoi.addEventListener('input', function() {
                    calculateEligibility(); // Auto-calculate on input
                });

                eligibilityRoi.addEventListener('blur', function() {
                    const value = this.value.replace(/[^\d.]/g, '');
                    if (value) {
                        this.value = value + '%';
                        calculateEligibility(); // Auto-calculate on blur
                    }
                });

                eligibilityRoi.addEventListener('focus', function() {
                    this.value = this.value.replace('%', '');
                });
            }

            // Update total income when salary, partner's salary, or bonus changes
            // Use the existing variables
            if (salaryInput) {
                // Add another event listener for eligibility calculation
                salaryInput.addEventListener('input', function() {
                    calculateTotal(); // This will update the Total Income field
                    calculateEligibility(); // Auto-calculate on salary change
                });
            }

            if (partnerSalaryInput) {
                // Add another event listener for eligibility calculation
                partnerSalaryInput.addEventListener('input', function() {
                    calculateTotal(); // This will update the Total Income field
                    calculateEligibility(); // Auto-calculate on partner's salary change
                });
            }

            if (bonusInput) {
                // Add another event listener for eligibility calculation
                bonusInput.addEventListener('input', function() {
                    calculateTotal(); // This will update the Total Income field
                    calculateEligibility(); // Auto-calculate on bonus change
                });
            }

            // Update total obligation when table data changes
            const totalObligationInput = document.getElementById('totalObligation');
            if (totalObligationInput) {
                totalObligationInput.addEventListener('input', function() {
                    const totalObligation = parseIndianNumber(this.value);
                    document.getElementById('eligibilityTotalObligation').value = formatCurrencyWithCommas(Math.round(totalObligation));
                    calculateEligibility(); // Auto-calculate on obligation change
                });
            }

            // Update eligibility calculation when FOIR changes
            const foirPercentage = document.getElementById('foirPercentage');
            if (foirPercentage) {
                // Use MutationObserver to detect changes to the FOIR value
                const foirObserver = new MutationObserver(function(mutations) {
                    calculateEligibility(); // Auto-calculate when FOIR changes
                });

                foirObserver.observe(foirPercentage, {
                    attributes: true,
                    attributeFilter: ['value']
                });
            }

            // Update eligibility calculation when Monthly EMI Can Pay changes
            const monthlyEmiCanPay = document.getElementById('monthlyEmiCanPay');
            if (monthlyEmiCanPay) {
                // Use MutationObserver to detect changes to the Monthly EMI Can Pay value
                const emiCanPayObserver = new MutationObserver(function(mutations) {
                    calculateEligibility(); // Auto-calculate when Monthly EMI Can Pay changes
                });

                emiCanPayObserver.observe(monthlyEmiCanPay, {
                    attributes: true,
                    attributeFilter: ['value']
                });

                // Also add an input event listener
                monthlyEmiCanPay.addEventListener('input', function() {
                    calculateEligibility();
                });
            }

            // Update total BT POS when table data changes
            const totalBtPosInput = document.getElementById('totalBtPos');
            if (totalBtPosInput) {
                totalBtPosInput.addEventListener('input', function() {
                    const totalBtPos = parseIndianNumber(this.value);
                    document.getElementById('eligibilityTotalBtPos').value = formatCurrencyWithCommas(Math.round(totalBtPos));
                    // Recalculate eligibility when BT POS changes
                    calculateEligibility();
                });
            }

            // Ensure eligibility recalculates when company category changes
            // We already have companyCategory from earlier, so we don't need to get it again
            if (companyCategory) {
                // Add another event listener for eligibility calculation
                companyCategory.addEventListener('change', function() {
                    // The resetFOIRAndCalculate function already updates FOIR
                    // We just need to trigger eligibility calculation after FOIR is updated
                    setTimeout(calculateEligibility, 100);
                });
            }

            // Initialize values on page load
            calculateTotal(); // This will update the Total Income field with all income sources

            const totalObligation = parseIndianNumber(document.getElementById('totalObligation')?.value || '0');
            document.getElementById('eligibilityTotalObligation').value = formatCurrencyWithCommas(totalObligation);

            const totalBtPos = parseIndianNumber(document.getElementById('totalBtPos')?.value || '0');
            document.getElementById('eligibilityTotalBtPos').value = formatCurrencyWithCommas(totalBtPos);

            // Initialize the "Divide by months" section visibility
            toggleDivideByMonths();

            // Don't set default values for tenure, ROI, and multiplier
            // Let the user enter these values manually

            // Calculate eligibility on page load
            setTimeout(calculateEligibility, 500);

            // Excel Export/Import Functionality
            setupExcelFunctionality();
        });

        // Function to set up Excel export and import functionality
        function setupExcelFunctionality() {
            const downloadExcelBtn = document.getElementById('downloadExcelBtn');
            const excelFileInput = document.getElementById('excelFileInput');

            // Download Excel button click handler
            if (downloadExcelBtn) {
                downloadExcelBtn.addEventListener('click', function() {
                    exportToExcel();
                });
            }

            // Upload Excel file input change handler
            if (excelFileInput) {
                excelFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        importFromExcel(file);

                        // Clear the file input so the same file can be selected again
                        this.value = '';

                        // Reinitialize all custom dropdowns and action selects after a delay
                        setTimeout(function() {
                            console.log("Reinitializing dropdowns after Excel import from file input handler");
                            reinitializeAllCustomDropdowns();

                            // First, make sure all action selects have the correct data-text attribute
                            document.querySelectorAll('.action-select').forEach(select => {
                                // If no action is selected from Excel, set default to Obligate
                                if (!select.value) {
                                    select.value = 'Obligate';
                                    select.style.height = '24px';
                                    select.style.width = '100%';
                                    select.style.textAlign = 'left';
                                    select.style.fontWeight = '700';
                                    select.style.fontSize = '12px';
                                    select.style.textTransform = 'none';
                                    select.style.borderRadius = '4px';
                                    select.style.border = '1px solid #ccc';
                                    select.style.padding = '3px 5px';
                                    select.style.color = '#000000';
                                    select.style.backgroundColor = '#FFFF00'; // Yellow
                                    const row = select.closest('tr');
                                    if (row) {
                                        const actionStateInput = row.querySelector('.action-state');
                                        const obligateAppliedInput = row.querySelector('.obligate-applied');
                                        if (actionStateInput) actionStateInput.value = 'Obligate';
                                        if (obligateAppliedInput) obligateAppliedInput.value = 'true';
                                    }
                                }

                                const selectedOption = select.options[select.selectedIndex];
                                const selectedText = selectedOption ? selectedOption.textContent : '';
                                select.setAttribute('data-text', selectedText);

                                // Force the select to have the correct styling
                                select.style.height = '38px';
                                select.style.width = '100%';
                                select.style.textAlign = 'center';
                                select.style.fontWeight = 'bold';
                                select.style.fontSize = '14px';
                                select.style.textTransform = 'uppercase';
                                select.style.borderRadius = '4px';
                                select.style.border = '1px solid #000000';

                                // Set background color based on selected value
                                const action = select.value;
                                if (action === 'BT') {
                                    select.style.backgroundColor = '#4CD964'; // Green
                                } else if (action === 'Obligate') {
                                    select.style.backgroundColor = '#FFFF00'; // Yellow
                                } else if (action === 'CO-PAY') {
                                    select.style.backgroundColor = '#FFA500'; // Bright Orange
                                } else if (action === 'Closed') {
                                    select.style.backgroundColor = '#FF0000'; // Red
                                } else if (action === 'NO-PAY') {
                                    select.style.backgroundColor = '#0080FF'; // Bright Blue
                                } else {
                                    // If somehow still no action, set to Obligate
                                    select.value = 'Obligate';
                                    select.style.backgroundColor = '#FFFF00'; // Yellow
                                    select.style.height = '24px';
                                    select.style.width = '100%';
                                    select.style.textAlign = 'left';
                                    select.style.fontWeight = '700';
                                    select.style.fontSize = '12px';
                                    select.style.textTransform = 'none';
                                    select.style.borderRadius = '4px';
                                    select.style.border = '1px solid #ccc';
                                    select.style.padding = '3px 5px';
                                    select.style.color = '#000000';
                                    const row = select.closest('tr');
                                    if (row) {
                                        const actionStateInput = row.querySelector('.action-state');
                                        const obligateAppliedInput = row.querySelector('.obligate-applied');
                                        if (actionStateInput) actionStateInput.value = 'Obligate';
                                        if (obligateAppliedInput) obligateAppliedInput.value = 'true';
                                    }
                                }
                            });

                            // Then run the standard initialization
                            initializeAllActionSelects();
                        }, 1000);
                    }
                });
            }

            // Test Eligibility Export button functionality removed
        }

        // Function to convert string to ArrayBuffer for Excel export
        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) {
                view[i] = s.charCodeAt(i) & 0xFF;
            }
            return buf;
        }

        // Function to format date as "4th May 2025"
        function formatDateWithOrdinal(date) {
            const day = date.getDate();
            const month = date.toLocaleString('en-US', { month: 'long' });
            const year = date.getFullYear();

            // Add ordinal suffix to day
            let ordinal;
            if (day > 3 && day < 21) {
                ordinal = 'th';
            } else {
                switch (day % 10) {
                    case 1: ordinal = 'st'; break;
                    case 2: ordinal = 'nd'; break;
                    case 3: ordinal = 'rd'; break;
                    default: ordinal = 'th';
                }
            }

            return `${day}${ordinal} ${month} ${year}`;
        }

        // Format currency with commas (Indian format)
        function formatCurrencyWithCommas(amount) {
            if (isNaN(amount) || amount === 0) return '₹0';

            // Round the amount to remove any decimals
            amount = Math.round(amount);

            // Convert to string (no decimals)
            const amountStr = Math.floor(amount).toString();

            // Format integer part with commas (Indian format: 1,23,456)
            let formattedInteger = '';
            let integerPart = amountStr;

            // Apply Indian number formatting (1,23,456)
            if (integerPart.length > 3) {
                formattedInteger = ',' + integerPart.substring(integerPart.length - 3);
                integerPart = integerPart.substring(0, integerPart.length - 3);

                while (integerPart.length > 0) {
                    if (integerPart.length >= 2) {
                        formattedInteger = ',' + integerPart.substring(integerPart.length - 2) + formattedInteger;
                        integerPart = integerPart.substring(0, integerPart.length - 2);
                    } else {
                        formattedInteger = integerPart + formattedInteger;
                        integerPart = '';
                    }
                }

                // Remove leading comma if present
                if (formattedInteger.startsWith(',')) {
                    formattedInteger = formattedInteger.substring(1);
                }
            } else {
                formattedInteger = integerPart;
            }

            return '₹' + formattedInteger;
        }

        // Parse currency string to number
        function parseCurrency(currencyStr) {
            if (!currencyStr) return 0;
            // Remove currency symbol and commas, then parse as integer
            return Math.round(parseFloat(currencyStr.replace(/[^\d.]/g, ''))) || 0;
        }

        // Helper function to download Excel workbook
        function downloadExcelWorkbook(workbook, filename) {
            try {
                // Generate Excel file
                const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' });

                // Create blob and download
                const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);

                return true;
            } catch (error) {
                console.error('Error downloading Excel workbook:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                return false;
            }
        }

        // Function to export data to Excel
        function exportToExcel() {
            try {
                // Create a new workbook
                const wb = XLSX.utils.book_new();

                // Get FOIR eligibility result from the display
                let foirEligibility = '';
                const foirEligibilityElement = document.getElementById('foirEligibilityResult');
                if (foirEligibilityElement) {
                    const amountElement = foirEligibilityElement.querySelector('div > div');
                    if (amountElement) {
                        foirEligibility = amountElement.textContent.trim();
                    }
                }

                // Get Multiplier eligibility result from the display
                let multiplierEligibility = '';
                const multiplierEligibilityElement = document.getElementById('multiplierEligibilityResult');
                if (multiplierEligibilityElement) {
                    const amountElement = multiplierEligibilityElement.querySelector('div > div');
                    if (amountElement) {
                        multiplierEligibility = amountElement.textContent.trim();
                    }
                }

                // Calculate final eligible amount (lower of FOIR and Multiplier)
                let finalEligibleAmount = '';
                if (foirEligibility && multiplierEligibility) {
                    const foirAmount = parseCurrency(foirEligibility);
                    const multiplierAmount = parseCurrency(multiplierEligibility);
                    if (!isNaN(foirAmount) && !isNaN(multiplierAmount)) {
                        finalEligibleAmount = 'Rs. ' + Math.min(foirAmount, multiplierAmount).toLocaleString('en-IN');
                    }
                } else if (foirEligibility) {
                    finalEligibleAmount = foirEligibility;
                } else if (multiplierEligibility) {
                    finalEligibleAmount = multiplierEligibility;
                }

                // Get customer details
                const salary = document.getElementById('salary')?.value || '';
                const partnerSalary = document.getElementById('partnerSalary')?.value || '';
                const bonus = document.getElementById('bonus')?.value || '';
                const companyName = document.getElementById('companyName')?.value || '';
                // Include the divided bonus amount in the total income calculation
                // Only if a bonus button is active (activeBonusButton is set)
                let bonusToAdd = 0;
                if (activeBonusButton !== null) {
                    bonusToAdd = dividedBonusAmount;
                }
                const totalIncome = parseCurrency(salary) + parseCurrency(partnerSalary) + bonusToAdd;

                // Create a single worksheet with all data in three clear sections
                const allData = [
                    ['LOAN ELIGIBILITY CALCULATOR - ALL DATA'],
                    [''],
                    ['===== SECTION 1: CUSTOMER DETAILS ====='],
                    [''],
                    ['Customer Name', document.getElementById('customerName')?.value || ''],
                    ['Salary', salary],
                    ['Partner\'s Salary', partnerSalary],
                    ['Bonus', bonus],
                    ['Active Bonus Button', activeBonusButton],
                    ['Company Name', companyName],
                    ['Total Income', 'Rs. ' + totalIncome.toLocaleString('en-IN')],
                    [''],
                    ['===== SECTION 2: CUSTOMER OBLIGATIONS ====='],
                    [''],
                    ['Total BT/POS', document.getElementById('totalBtPos')?.value || ''],
                    ['Total Obligation', document.getElementById('totalObligation')?.value || ''],
                    [''],
                    ['Detailed Obligations'],
                    ['#', 'Product', 'Bank Name', 'Tenure', 'ROI %', 'Total Loan', 'Outstanding', 'EMI Amount', 'Action']
                ];

                // Add table rows to obligations section
                const obligationsTable = document.getElementById('obligationsTable');
                if (obligationsTable) {
                    console.log('Exporting obligations table data');
                    const rows = obligationsTable.querySelectorAll('tbody tr');
                    console.log('Found ' + rows.length + ' rows in the obligations table');

                    rows.forEach((row, index) => {
                        const rowData = [];
                        // Row number
                        rowData.push(index + 1);

                        // Get product value - try different selectors to ensure we get the value
                        let productValue = '';
                        const productDisplay = row.querySelector('.product-display');
                        const productValueInput = row.querySelector('.product-value');

                        if (productDisplay && productDisplay.value) {
                            productValue = productDisplay.value;
                        } else if (productValueInput && productValueInput.value) {
                            productValue = productValueInput.value;
                        } else if (productDisplay && productDisplay.textContent) {
                            productValue = productDisplay.textContent.trim();
                        }

                        // For debugging
                        console.log('Product value for row ' + (index + 1) + ':', productValue);

                        // Get bank value - try different selectors to ensure we get the value
                        let bankValue = '';
                        const bankDisplay = row.querySelector('.bank-display');
                        const bankValueInput = row.querySelector('.bank-value');

                        if (bankDisplay && bankDisplay.value) {
                            bankValue = bankDisplay.value;
                        } else if (bankValueInput && bankValueInput.value) {
                            bankValue = bankValueInput.value;
                        } else if (bankDisplay && bankDisplay.textContent) {
                            bankValue = bankDisplay.textContent.trim();
                        }

                        // Get tenure value
                        let tenureValue = '';
                        const tenureInput = row.querySelector('.tenure-input');
                        if (tenureInput) {
                            tenureValue = tenureInput.value || '';
                        }

                        // Get ROI value
                        let roiValue = '';
                        const roiInput = row.querySelector('.roi-input');
                        if (roiInput) {
                            roiValue = roiInput.value || '';
                        }

                        // Get total loan value
                        let totalLoanValue = '';
                        const totalLoanInput = row.querySelector('td:nth-child(6) input');
                        if (totalLoanInput) {
                            totalLoanValue = totalLoanInput.value || '';
                        }

                        // Get outstanding value
                        let outstandingValue = '';
                        const outstandingInput = row.querySelector('.os-input');
                        if (outstandingInput) {
                            outstandingValue = outstandingInput.value || '';
                        }

                        // Get EMI value
                        let emiValue = '';
                        const emiInput = row.querySelector('.emi-input');
                        if (emiInput) {
                            emiValue = emiInput.value || '';
                        }

                        // Get action value from the display or select element
                        let actionValue = '';
                        const actionSelect = row.querySelector('.action-select');
                        if (actionSelect) {
                            actionValue = actionSelect.value || '';
                        }

                        // Add all values to the row data
                        rowData.push(productValue);
                        rowData.push(bankValue);
                        rowData.push(tenureValue);
                        rowData.push(roiValue);
                        rowData.push(totalLoanValue);
                        rowData.push(outstandingValue);
                        rowData.push(emiValue);
                        rowData.push(actionValue);

                        console.log('Row data:', rowData);

                        // Add the row data to the allData array
                        allData.push(rowData);
                    });
                }

                // If we couldn't get the eligibility values from the DOM, calculate them directly
                if (!foirEligibility || !multiplierEligibility) {
                    // Calculate FOIR eligibility
                    const foirCalcResult = calculateEligibilityFOIR();
                    if (foirCalcResult > 0 && !foirEligibility) {
                        foirEligibility = formatCurrencyWithCommas(foirCalcResult);
                    }

                    // Calculate Multiplier eligibility
                    const multiplierCalcResult = calculateEligibilityMultiplier();
                    if (multiplierCalcResult > 0 && !multiplierEligibility) {
                        multiplierEligibility = formatCurrencyWithCommas(multiplierCalcResult);
                    }
                }

                // Add Calculate Eligibility section
                allData.push(
                    [''],
                    ['===== SECTION 3: CALCULATE ELIGIBILITY ====='],
                    [''],
                    ['Total Income', document.getElementById('eligibilityTotalIncome')?.value || ''],
                    ['Company Category', document.getElementById('companyCategory')?.value || ''],
                    ['FOIR %', document.getElementById('foirPercentage')?.value || ''],
                    ['FOIR AMOUNT', document.getElementById('foirAmount')?.value || ''],
                    ['Total Obligation', document.getElementById('eligibilityTotalObligation')?.value || ''],
                    ['Monthly EMI Can Pay', document.getElementById('monthlyEmiCanPay')?.value || ''],
                    ['Tenure (Months)', document.getElementById('eligibilityTenureMonths')?.value || ''],
                    ['Tenure (Years)', document.getElementById('eligibilityTenureYears')?.value || ''],
                    ['ROI', document.getElementById('eligibilityRoi')?.value || ''],
                    ['TOTAL BT POS', document.getElementById('eligibilityTotalBtPos')?.value || ''],
                    ['Loan Eligibility as per FOIR', foirEligibility || ''],
                    ['Multiplier', document.getElementById('multiplierValue')?.value || ''],
                    ['Loan Eligibility as per Multiplier', multiplierEligibility || '']
                );

                // Check if shortfall warning or congratulations message is visible and add it to Excel
                const shortfallContainer = document.getElementById('eligibilityShortfallContainer');
                if (shortfallContainer && shortfallContainer.style.display !== 'none' && shortfallContainer.innerHTML.trim() !== '') {
                    // Check the HTML content to determine if it's a shortfall warning or congratulations message
                    const htmlContent = shortfallContainer.innerHTML;
                    const isShortfall = htmlContent.includes('background: #FF0000') ||
                                       htmlContent.includes('Balance Transfer Not Possible');
                    const isCongratulations = htmlContent.includes('background: #00CC00') ||
                                             htmlContent.includes('Congratulations!');

                    console.log("Excel export - Message detection:", {
                        isShortfall,
                        isCongratulations,
                        containerVisible: shortfallContainer.style.display !== 'none',
                        hasContent: shortfallContainer.innerHTML.trim() !== ''
                    });

                    if (isShortfall) {
                        // Extract shortfall amount from the container
                        const shortfallAmountElement = shortfallContainer.querySelector('div > div > span');
                        const shortfallAmount = shortfallAmountElement ? shortfallAmountElement.textContent.trim() : '';

                        allData.push(
                            [''],
                            ['Shortfall Warning'],
                            ['Balance Transfer Not Possible - Shortfall Amount:', shortfallAmount]
                            // Recommendations to Increase Eligibility section removed from Excel export as requested
                        );
                    } else if (isCongratulations) {
                        // Add congratulations message to Excel
                        allData.push(
                            [''],
                            ['Eligibility Status'],
                            ['Congratulations! Balance Transfer is Eligible']
                        );
                    }
                }

                // Create worksheet with proper column widths
                const allDataWS = XLSX.utils.aoa_to_sheet(allData);
                allDataWS['!cols'] = [
                    {wch: 25}, // A
                    {wch: 25}, // B
                    {wch: 25}, // C
                    {wch: 15}, // D
                    {wch: 15}, // E
                    {wch: 15}, // F
                    {wch: 15}, // G
                    {wch: 15}, // H
                    {wch: 15}  // I
                ];

                // Add the worksheet to the workbook - only one sheet
                XLSX.utils.book_append_sheet(wb, allDataWS, 'All Data');

                // Get customer name for the filename
                const customerName = document.getElementById('customerName')?.value || 'Customer';
                const currentDate = new Date();
                const formattedDate = formatDateWithOrdinal(currentDate);

                // Get the current date in YYYY-MM-DD format for tracking
                const dateKey = currentDate.toISOString().slice(0, 10);

                // Check if we have a draft for this customer on this date
                if (!customerDrafts[customerName]) {
                    customerDrafts[customerName] = {};
                }

                // If this is a new date for this customer, start with draft 1
                if (!customerDrafts[customerName][dateKey]) {
                    customerDrafts[customerName][dateKey] = 1;
                } else {
                    // If we already have a draft for this customer on this date, increment it
                    customerDrafts[customerName][dateKey]++;
                }

                // Get the current draft number
                const draftNumber = customerDrafts[customerName][dateKey];

                // Create the ordinal suffix for the draft number
                let draftOrdinal;
                if (draftNumber > 3 && draftNumber < 21) {
                    draftOrdinal = 'th';
                } else {
                    switch (draftNumber % 10) {
                        case 1: draftOrdinal = 'st'; break;
                        case 2: draftOrdinal = 'nd'; break;
                        case 3: draftOrdinal = 'rd'; break;
                        default: draftOrdinal = 'th';
                    }
                }

                // Create the filename with customer name, date, and draft number
                const filename = `${customerName} ${formattedDate} ${draftNumber}${draftOrdinal} draft.xlsx`;

                // Download the Excel file using our helper function
                const success = downloadExcelWorkbook(wb, filename);

                if (!success) {
                    throw new Error('Failed to download Excel file');
                }

            } catch (error) {
                console.error('Error exporting to Excel:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                alert('Error exporting to Excel: ' + error.message + '. Please try again.');
            }
        }

        // Function to show the centered notification
        function showCenteredNotification(message) {
            const notification = document.getElementById('centeredNotification');
            const messageElement = document.getElementById('notificationMessage');

            if (messageElement) {
                messageElement.textContent = message;
            }

            if (notification) {
                notification.classList.add('show');

                // Optional: Auto-hide after 5 seconds
                // setTimeout(() => {
                //     closeNotification();
                // }, 5000);
            }
        }

        // Function to close the centered notification
        function closeNotification() {
            const notification = document.getElementById('centeredNotification');

            if (notification) {
                notification.classList.remove('show');
            }
        }

        // Function to import data from Excel
        function importFromExcel(file) {
            try {
                // Extract customer name and draft information from filename
                const filename = file.name;

                // Try to parse the filename to extract customer name and draft information
                // Expected format: "CUSTOMER NAME 4th May 2025 1st draft.xlsx"
                const match = filename.match(/^(.+?)\s+\d+(st|nd|rd|th)\s+\w+\s+\d{4}\s+(\d+)(st|nd|rd|th)\s+draft\.xlsx$/i);

                if (match) {
                    const customerName = match[1].trim();
                    const draftNumber = parseInt(match[3]);

                    // Update the draft counter for this customer
                    if (customerName && !isNaN(draftNumber)) {
                        console.log(`Importing file for customer ${customerName}, draft ${draftNumber}`);

                        // Ensure we have an entry for this customer
                        if (!customerDrafts[customerName]) {
                            customerDrafts[customerName] = {};
                        }

                        // Get the current date in YYYY-MM-DD format
                        const dateKey = new Date().toISOString().slice(0, 10);

                        // Set the draft number for today to the imported draft number
                        // This ensures the next export will increment from this draft number
                        customerDrafts[customerName][dateKey] = draftNumber;
                    }
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Only process the All Data worksheet (new format)
                    if (workbook.SheetNames.includes('All Data')) {
                        const allDataSheet = workbook.Sheets['All Data'];
                        const allData = XLSX.utils.sheet_to_json(allDataSheet, { header: 1 });

                        // Process the data by sections
                        let currentSection = '';
                        let customerDetailsFound = false;
                        let obligationSummaryFound = false;
                        let obligationDetailsFound = false;
                        let eligibilityFound = false;
                        let inDetailedObligations = false;

                        // Variables to track bonus division
                        let importedActiveBonusButton = null;
                        let importedOriginalSalary = 0;

                        // Variables to store obligation table data
                        const obligationRows = [];

                        for (let i = 0; i < allData.length; i++) {
                            const row = allData[i];
                            if (!row || row.length === 0 || !row[0]) continue;

                            // Check for section headers - make sure row[0] is a string before using includes()
                            if (typeof row[0] === 'string') {
                                if (row[0].includes('SECTION 1: CUSTOMER DETAILS') || row[0] === 'CUSTOMER DETAILS SECTION') {
                                    currentSection = 'customer_details';
                                    customerDetailsFound = true;
                                    continue;
                                } else if (row[0].includes('SECTION 2: CUSTOMER OBLIGATIONS') || row[0] === 'CUSTOMER OBLIGATIONS SECTION') {
                                    currentSection = 'obligation_summary';
                                    obligationSummaryFound = true;
                                    continue;
                                } else if (row[0] === 'Detailed Obligations') {
                                    inDetailedObligations = true;
                                    continue;
                                } else if (row[0].includes('SECTION 3: CALCULATE ELIGIBILITY') || row[0] === 'CALCULATE ELIGIBILITY SECTION') {
                                    currentSection = 'eligibility';
                                    eligibilityFound = true;
                                    inDetailedObligations = false;
                                    continue;
                                }
                            }

                            // Process data based on current section
                            if (currentSection === 'customer_details' && typeof row[0] === 'string') {
                                if (row[0] === 'Customer Name' && row.length > 1) {
                                    console.log("Importing Customer Name:", row[1]);
                                    const customerNameValue = row[1] || '';
                                    const customerNameInput = document.getElementById('customerName');

                                    if (customerNameInput) {
                                        customerNameInput.value = customerNameValue;
                                        console.log("Set customer name value to:", customerNameInput.value);
                                    }
                                }
                                else if (row[0] === 'Salary' && row.length > 1) {
                                    console.log("Importing Salary:", row[1]);
                                    // Use our specialized function to handle Indian number format
                                    const salaryValue = row[1] || '';
                                    const salaryInput = document.getElementById('salary');

                                    if (salaryInput) {
                                        // Preserve the exact format from Excel
                                        salaryInput.value = salaryValue;
                                        console.log("Set salary value to:", salaryInput.value);
                                    }
                                } else if (row[0] === 'Partner\'s Salary' && row.length > 1) {
                                    console.log("Importing Partner's Salary:", row[1]);
                                    // Use our specialized function to handle Indian number format
                                    const partnerSalaryValue = row[1] || '';
                                    const partnerSalaryInput = document.getElementById('partnerSalary');

                                    if (partnerSalaryInput) {
                                        // Preserve the exact format from Excel
                                        partnerSalaryInput.value = partnerSalaryValue;
                                        console.log("Set partner's salary value to:", partnerSalaryInput.value);
                                    }
                                } else if (row[0] === 'Original Salary' && row.length > 1) {
                                    importedOriginalSalary = parseIndianNumber(row[1] || '0');
                                } else if (row[0] === 'Bonus' && row.length > 1) {
                                    console.log("Importing Bonus:", row[1]);
                                    // Use our specialized function to handle Indian number format
                                    const bonusValue = row[1] || '';
                                    const bonusInput = document.getElementById('bonus');

                                    if (bonusInput) {
                                        // Preserve the exact format from Excel
                                        bonusInput.value = bonusValue;
                                        console.log("Set bonus value to:", bonusInput.value);
                                    }
                                } else if (row[0] === 'Active Bonus Button' && row.length > 1) {
                                    // Convert to number if it's a numeric string, or null if empty
                                    importedActiveBonusButton = row[1] ? Number(row[1]) : null;
                                } else if (row[0] === 'Company Name' && row.length > 1) {
                                    document.getElementById('companyName').value = row[1] || '';
                                }
                            } else if (currentSection === 'obligation_summary' && !inDetailedObligations && typeof row[0] === 'string') {
                                // Skip the "Summary" header if present
                                if (row[0] === 'Summary') {
                                    continue;
                                }

                                if (row[0] === 'Total BT/POS' && row.length > 1) {
                                    document.getElementById('totalBtPos').value = row[1] || '';
                                } else if (row[0] === 'Total Obligation' && row.length > 1) {
                                    document.getElementById('totalObligation').value = row[1] || '';
                                }
                            } else if (inDetailedObligations) {
                                // Skip header row - make sure row[0] is a string before comparing
                                if (typeof row[0] === 'string' && (row[0] === '#' || row[0] === 'Summary')) continue;

                                // Process data rows - check if it's a numeric first column (row number)
                                if (row.length >= 8 && !isNaN(row[0])) {
                                    console.log("Processing obligation row:", row);

                                    // Create an obligation row object with all the data
                                    const obligationRow = {
                                        product: row[1] || '',
                                        bank: row[2] || '',
                                        tenure: row[3] || '',
                                        roi: row[4] || '',
                                        totalLoan: row[5] || '',
                                        outstanding: row[6] || '',
                                        emi: row[7] || '',
                                        action: row[8] || ''
                                    };

                                    // Only add rows that have at least one non-empty value
                                    if (obligationRow.product || obligationRow.bank ||
                                        obligationRow.tenure || obligationRow.roi ||
                                        obligationRow.totalLoan || obligationRow.outstanding ||
                                        obligationRow.emi || obligationRow.action) {

                                        console.log("Adding obligation row:", obligationRow);
                                        obligationRows.push(obligationRow);
                                    }
                                }
                            } else if (currentSection === 'eligibility' && typeof row[0] === 'string') {
                                // Skip section headers like "Basic Information", "Loan Parameters", "Eligibility Results"
                                if (row[0] === 'Basic Information' || row[0] === 'Loan Parameters' || row[0] === 'Eligibility Results') {
                                    continue;
                                }

                                if (row[0] === 'Total Income' && row.length > 1) {
                                    document.getElementById('eligibilityTotalIncome').value = row[1] || '';
                                } else if (row[0] === 'Company Category' && row.length > 1) {
                                    document.getElementById('companyCategory').value = row[1] || '';
                                    // Process company category change
                                    if (row[1]) {
                                        // We need to handle the FOIR value carefully when changing company category
                                        // First, check if we have a FOIR value coming later in the Excel file
                                        let hasFoirInExcel = false;
                                        let foirValueFromExcel = '';

                                        // Look ahead in the data to see if there's a FOIR value
                                        for (let j = i + 1; j < allData.length; j++) {
                                            const nextRow = allData[j];
                                            if (nextRow && nextRow.length > 0 && nextRow[0] === 'FOIR' && nextRow.length > 1) {
                                                hasFoirInExcel = true;
                                                foirValueFromExcel = nextRow[1] || '';
                                                break;
                                            }
                                        }

                                        // If we're setting to UNLISTED, we'll handle FOIR separately
                                        if (row[1] === 'UNLISTED') {
                                            // Trigger the change event to update UI elements
                                            const event = new Event('change');
                                            document.getElementById('companyCategory').dispatchEvent(event);

                                            // If we have a FOIR value coming, we'll set it when we process that row
                                            // If not, we'll leave the FOIR field empty for manual selection
                                        } else {
                                            // For other company categories, we need to handle the toggle button

                                            // Trigger the change event to update UI elements
                                            const event = new Event('change');
                                            document.getElementById('companyCategory').dispatchEvent(event);

                                            // If we have a FOIR value coming from Excel
                                            if (hasFoirInExcel) {
                                                // Get the calculated FOIR after category change
                                                const calculatedFoir = document.getElementById('foirPercentage').value;
                                                const foirToggleBtn = document.getElementById('foirToggleBtn');

                                                // Parse the values as integers for comparison
                                                const foirExcelNum = parseInt(foirValueFromExcel);
                                                const calculatedFoirNum = parseInt(calculatedFoir);

                                                if (!isNaN(foirExcelNum) && !isNaN(calculatedFoirNum)) {
                                                    // If the Excel FOIR is 5% higher than calculated, activate toggle
                                                    if (foirExcelNum === calculatedFoirNum + 5) {
                                                        foirToggleBtn.classList.add('active');
                                                        document.getElementById('foirPercentage').value = foirExcelNum;
                                                    } else if (foirExcelNum !== calculatedFoirNum) {
                                                        // If the Excel FOIR doesn't match the calculated value or calculated+5%,
                                                        // we'll override the calculated value with the Excel value
                                                        // This handles cases where the FOIR was manually adjusted in Excel
                                                        document.getElementById('foirPercentage').value = foirExcelNum;
                                                    }
                                                    // Recalculate with the updated FOIR value
                                                    calculateMonthlyEmiCanPay();
                                                    calculateEligibility();
                                                }
                                            }
                                        }
                                    }
                                } else if ((row[0] === 'FOIR' || row[0] === 'FOIR %') && row.length > 1) {
                                    const foirValue = row[1] || '';
                                    document.getElementById('foirPercentage').value = foirValue;

                                    // Highlight the corresponding FOIR button if it matches a preset value
                                    if (document.getElementById('companyCategory').value === 'UNLISTED') {
                                        const foirNumeric = parseInt(foirValue);
                                        if (!isNaN(foirNumeric)) {
                                            // Reset all button highlights first
                                            const buttons = document.querySelectorAll('#foirButtonsContainer button');
                                            buttons.forEach(btn => {
                                                btn.style.background = 'var(--editable-bg)';
                                            });

                                            // Find and highlight the matching button if it exists
                                            let buttonFound = false;
                                            buttons.forEach(btn => {
                                                const btnValue = parseInt(btn.textContent);
                                                if (btnValue === foirNumeric) {
                                                    btn.style.background = 'var(--primary)';
                                                    buttonFound = true;
                                                }
                                            });

                                            // If no matching button was found, it's a custom FOIR value
                                            if (!buttonFound) {
                                                // Set the custom FOIR input field
                                                const customFoirInput = document.getElementById('customFoirInputInline');
                                                if (customFoirInput) {
                                                    customFoirInput.value = foirNumeric;
                                                }
                                            } else {
                                                // Clear the custom FOIR input if a preset button was selected
                                                const customFoirInput = document.getElementById('customFoirInputInline');
                                                if (customFoirInput) {
                                                    customFoirInput.value = '';
                                                }
                                            }
                                        }

                                        // Recalculate eligibility with the imported FOIR value
                                        calculateMonthlyEmiCanPay();
                                        calculateEligibility();
                                    }
                                } else if (row[0] === 'FOIR AMOUNT' && row.length > 1) {
                                    // FOIR AMOUNT is calculated automatically, so we don't need to set it
                                    // But we can verify it matches our calculation
                                    console.log("Imported FOIR AMOUNT:", row[1]);
                                } else if (row[0] === 'Total Obligation' && row.length > 1) {
                                    document.getElementById('eligibilityTotalObligation').value = row[1] || '';
                                } else if (row[0] === 'Monthly EMI Can Pay' && row.length > 1) {
                                    document.getElementById('monthlyEmiCanPay').value = row[1] || '';
                                } else if (row[0] === 'Tenure (Months)' && row.length > 1) {
                                    document.getElementById('eligibilityTenureMonths').value = row[1] || '';
                                    // Update tenure years
                                    updateTenureYears();
                                } else if (row[0] === 'Tenure (Years)' && row.length > 1) {
                                    document.getElementById('eligibilityTenureYears').value = row[1] || '';
                                } else if (row[0] === 'ROI' && row.length > 1) {
                                    document.getElementById('eligibilityRoi').value = row[1] || '';
                                } else if (row[0] === 'TOTAL BT POS' && row.length > 1) {
                                    document.getElementById('eligibilityTotalBtPos').value = row[1] || '';
                                } else if (row[0] === 'Multiplier' && row.length > 1) {
                                    document.getElementById('multiplierValue').value = row[1] || '';
                                } else if (row[0] === 'Loan Eligibility as per FOIR' && row.length > 1) {
                                    // Handle FOIR eligibility result if needed
                                } else if (row[0] === 'Loan Eligibility as per Multiplier' && row.length > 1) {
                                    // Handle Multiplier eligibility result if needed
                                }
                            }
                        }

                        // Populate the obligations table
                        if (obligationRows.length > 0) {
                            console.log("Found obligation rows:", obligationRows);
                            const obligationsTable = document.getElementById('obligationsTable');
                            const tbody = obligationsTable.querySelector('tbody');
                            tbody.innerHTML = '';

                            obligationRows.forEach((rowData, index) => {
                                // Create new row
                                const newRow = document.createElement('tr');

                                // Row number cell
                                const rowNumCell = document.createElement('td');
                                rowNumCell.className = 'row-number';
                                rowNumCell.style.textAlign = 'center';
                                rowNumCell.style.fontWeight = 'bold';
                                rowNumCell.textContent = index + 1; // Set initial row number based on index
                                newRow.appendChild(rowNumCell);

                                // Product cell
                                const productCell = document.createElement('td');
                                productCell.className = 'product-cell';

                                // Create the custom select wrapper
                                const customSelectWrapper = document.createElement('div');
                                customSelectWrapper.className = 'custom-select-wrapper';

                                // Create the product display textarea
                                const productDisplay = document.createElement('textarea');
                                productDisplay.className = 'product-display';
                                productDisplay.readOnly = true;
                                productDisplay.placeholder = 'Select Product';
                                productDisplay.rows = 1;
                                productDisplay.style.backgroundColor = '#FFFFFF';
                                productDisplay.style.height = '24px';
                                productDisplay.style.minHeight = '24px';
                                productDisplay.style.overflow = 'hidden';
                                productDisplay.style.resize = 'none';
                                productDisplay.style.padding = '3px 6px';
                                productDisplay.style.fontSize = '0.9rem';
                                productDisplay.style.fontWeight = '600';
                                productDisplay.style.color = '#000000';
                                productDisplay.value = rowData.product;

                                // Create the hidden input for product value
                                const productValueInput = document.createElement('input');
                                productValueInput.type = 'hidden';
                                productValueInput.className = 'product-value';
                                productValueInput.value = rowData.product;

                                // Create the dropdown container
                                const dropdownContainer = document.createElement('div');
                                dropdownContainer.className = 'custom-select-dropdown';

                                // Create the search container
                                const searchContainer = document.createElement('div');
                                searchContainer.className = 'search-container';

                                // Create the search input
                                const searchInput = document.createElement('input');
                                searchInput.type = 'text';
                                searchInput.className = 'search-input';
                                searchInput.placeholder = 'Search products...';

                                // Add the search input to the search container
                                searchContainer.appendChild(searchInput);

                                // Create the options container
                                const optionsContainer = document.createElement('div');
                                optionsContainer.className = 'custom-select-options';

                                // Add the default option
                                const defaultOption = document.createElement('div');
                                defaultOption.className = 'custom-option';
                                defaultOption.dataset.value = '';
                                defaultOption.textContent = 'Select Product';
                                optionsContainer.appendChild(defaultOption);

                                // Add the product options
                                const productOptions = [
                                    'PL (Personal Loan)',
                                    'OD (Overdraft)',
                                    'CC (Credit Card)',
                                    'BL (Business Loan)',
                                    'HL (Home Loan)',
                                    'LAP (Loan Against Property)',
                                    'AL (Auto Loan/ Car Loan)',
                                    'EL (Education Loan)',
                                    'GL (Gold Loan)',
                                    'LOC (Loan On Credit Card)',
                                    'CD (Consumer Durable Loan)',
                                    'APP LOAN',
                                    'INSURANCE'
                                ];

                                productOptions.forEach(option => {
                                    const optionElement = document.createElement('div');
                                    optionElement.className = 'custom-option';
                                    optionElement.dataset.value = option;
                                    optionElement.textContent = option;

                                    // Mark as selected if it matches the product value
                                    if (option === rowData.product) {
                                        optionElement.classList.add('selected');
                                    }

                                    optionsContainer.appendChild(optionElement);
                                });

                                // Add the search container and options container to the dropdown container
                                dropdownContainer.appendChild(searchContainer);
                                dropdownContainer.appendChild(optionsContainer);

                                // Add all elements to the custom select wrapper
                                customSelectWrapper.appendChild(productDisplay);
                                customSelectWrapper.appendChild(productValueInput);
                                customSelectWrapper.appendChild(dropdownContainer);

                                // Add the custom select wrapper to the product cell
                                productCell.appendChild(customSelectWrapper);

                                // Add the product cell to the row
                                newRow.appendChild(productCell);

                                // Bank name cell
                                const bankCell = document.createElement('td');
                                bankCell.className = 'bank-cell';

                                // Create the custom select wrapper for bank
                                const bankSelectWrapper = document.createElement('div');
                                bankSelectWrapper.className = 'custom-select-wrapper bank-select-wrapper';

                                // Create the bank display textarea
                                const bankDisplay = document.createElement('textarea');
                                bankDisplay.className = 'bank-display';
                                bankDisplay.readOnly = true;
                                bankDisplay.placeholder = 'Select Bank';
                                bankDisplay.rows = 1;
                                bankDisplay.style.backgroundColor = '#FFFFFF';
                                bankDisplay.style.height = '24px';
                                bankDisplay.style.minHeight = '24px';
                                bankDisplay.style.overflow = 'hidden';
                                bankDisplay.style.resize = 'none';
                                bankDisplay.style.padding = '3px 6px';
                                bankDisplay.style.fontSize = '0.9rem';
                                bankDisplay.style.fontWeight = '600';
                                bankDisplay.style.color = '#000000';
                                bankDisplay.value = rowData.bank;

                                // Create the hidden input for bank value
                                const bankValueInput = document.createElement('input');
                                bankValueInput.type = 'hidden';
                                bankValueInput.className = 'bank-value';
                                bankValueInput.value = rowData.bank;

                                // Create the dropdown container for bank
                                const bankDropdown = document.createElement('div');
                                bankDropdown.className = 'custom-select-dropdown bank-dropdown';

                                // Create the search container for bank
                                const bankSearchContainer = document.createElement('div');
                                bankSearchContainer.className = 'search-container';

                                // Create the search input for bank
                                const bankSearchInput = document.createElement('input');
                                bankSearchInput.type = 'text';
                                bankSearchInput.className = 'search-input';
                                bankSearchInput.placeholder = 'Search banks...';

                                // Add the search input to the search container
                                bankSearchContainer.appendChild(bankSearchInput);

                                // Create the options container for bank
                                const bankOptionsContainer = document.createElement('div');
                                bankOptionsContainer.className = 'custom-select-options';

                                // Add the default option for bank
                                const bankDefaultOption = document.createElement('div');
                                bankDefaultOption.className = 'custom-option';
                                bankDefaultOption.dataset.value = '';
                                bankDefaultOption.textContent = 'Select Bank';
                                bankOptionsContainer.appendChild(bankDefaultOption);

                                // Add the bank options (complete list of all banks)
                                // Private Banks
                                const privateBanks = [
                                    'Axis Bank', 'Bandhan Bank', 'City Union Bank', 'CSB Bank', 'DCB Bank',
                                    'Dhanlaxmi Bank', 'Federal Bank', 'HDFC Bank', 'ICICI Bank', 'IDBI Bank',
                                    'IDFC FIRST Bank', 'IndusInd Bank', 'Karnataka Bank', 'Kotak Mahindra Bank',
                                    'Nainital Bank', 'RBL Bank', 'South Indian Bank', 'Tamilnad Mercantile Bank', 'YES Bank'
                                ];

                                // Public Banks
                                const publicBanks = [
                                    'Bank of Baroda', 'Bank of India', 'Bank of Maharashtra', 'Canara Bank',
                                    'Central Bank of India', 'Indian Bank', 'Indian Overseas Bank', 'PNB Bank',
                                    'Punjab & Sind Bank', 'SBI Bank', 'UCO Bank'
                                ];

                                // NBFCs (Non-Banking Financial Companies)
                                const nbfcs = [
                                    'Aditya Birla Capital', 'Bajaj Finance', 'Bajaj Finserv', 'Capri Global Capital',
                                    'Cholamandalam Investment and Finance', 'Edelweiss Financial Services', 'Fullerton India',
                                    'HDB Financial Services', 'IIFL Finance', 'InCred Finance', 'JM Financial', 'L&T Finance',
                                    'Mahindra Finance', 'Mas Financial Services', 'Motilal Oswal Financial Services',
                                    'Muthoot Finance', 'Piramal Capital & Housing Finance', 'Poonawalla Fincorp',
                                    'Reliance Capital', 'Shriram Finance', 'Srei Infrastructure Finance', 'Tata Capital',
                                    'Ugro Capital', 'Vistaar Financial Services'
                                ];

                                // Fintechs
                                const fintechs = [
                                    '50Fin', 'Capital Float', 'CASHe', 'Credy', 'Dhani', 'DMI Finance', 'Faircent',
                                    'Fibe', 'Finnable', 'FlexSalary', 'Hero FinCorp', 'Home Credit India', 'i2iFunding',
                                    'IndiaLends', 'Kissht', 'KreditBee', 'LazyPay', 'LenDenClub', 'Lendingkart',
                                    'LoanTap', 'MoneyTap', 'Moneyview', 'Monexo', 'mPokket', 'Navi', 'NIRA Finance',
                                    'NoBroker InstaCash', 'PayMe', 'PaySense', 'RapidRupee', 'RupeeLend', 'Rupifi',
                                    'SmartCoin', 'StashFin', 'Svatantra Microfin', 'ZestMoney'
                                ];

                                // Foreign Banks
                                const foreignBanks = [
                                    'American Express Banking Corp', 'Bank of China', 'Barclays Bank', 'Citibank',
                                    'DBS Bank', 'Deutsche Bank', 'HSBC', 'SBM Bank', 'Standard Chartered Bank'
                                ];

                                // Small Finance Banks
                                const smallFinanceBanks = [
                                    'AU Small Finance Bank', 'Capital Small Finance Bank', 'Equitas Small Finance Bank',
                                    'Jana Small Finance Bank', 'North East Small Finance Bank', 'Shivalik Small Finance Bank',
                                    'Ujjivan Small Finance Bank', 'Utkarsh Small Finance Bank'
                                ];

                                // Combine all banks
                                const bankOptions = [
                                    ...privateBanks, ...publicBanks, ...nbfcs, ...fintechs, ...foreignBanks, ...smallFinanceBanks, 'OTHER'
                                ];

                                bankOptions.forEach(option => {
                                    const optionElement = document.createElement('div');
                                    optionElement.className = 'custom-option';
                                    optionElement.dataset.value = option;
                                    optionElement.textContent = option;

                                    // Mark as selected if it matches the bank value
                                    if (option === rowData.bank) {
                                        optionElement.classList.add('selected');
                                    }

                                    bankOptionsContainer.appendChild(optionElement);
                                });

                                // Add the search container and options container to the dropdown container
                                bankDropdown.appendChild(bankSearchContainer);
                                bankDropdown.appendChild(bankOptionsContainer);

                                // Add all elements to the bank select wrapper
                                bankSelectWrapper.appendChild(bankDisplay);
                                bankSelectWrapper.appendChild(bankValueInput);
                                bankSelectWrapper.appendChild(bankDropdown);

                                // Add the bank select wrapper to the bank cell
                                bankCell.appendChild(bankSelectWrapper);

                                // Add the bank cell to the row
                                newRow.appendChild(bankCell);

                                // Tenure cell
                                const tenureCell = document.createElement('td');
                                const tenureInput = document.createElement('input');
                                tenureInput.type = 'text';
                                tenureInput.className = 'number-input tenure-input';
                                tenureInput.value = rowData.tenure;
                                tenureInput.placeholder = 'months';
                                tenureInput.maxLength = 3;
                                tenureInput.style.textAlign = 'left';
                                tenureCell.appendChild(tenureInput);
                                newRow.appendChild(tenureCell);

                                // ROI cell
                                const roiCell = document.createElement('td');
                                roiCell.className = 'roi-cell';
                                const roiInput = document.createElement('input');
                                roiInput.type = 'text';
                                roiInput.className = 'number-input roi-input';
                                roiInput.value = rowData.roi;
                                roiInput.placeholder = '%';
                                roiInput.maxLength = 6;
                                roiInput.style.textAlign = 'left';
                                roiCell.appendChild(roiInput);
                                newRow.appendChild(roiCell);

                                // Total loan cell
                                const totalLoanCell = document.createElement('td');
                                totalLoanCell.className = 'loan-amount-cell';
                                const totalLoanInput = document.createElement('input');
                                totalLoanInput.type = 'text';
                                totalLoanInput.className = 'number-input';
                                totalLoanInput.value = rowData.totalLoan;
                                totalLoanInput.setAttribute('oninput', 'formatNumber(this)');
                                totalLoanInput.placeholder = 'Total loan';
                                totalLoanCell.appendChild(totalLoanInput);
                                newRow.appendChild(totalLoanCell);

                                // Outstanding cell
                                const outstandingCell = document.createElement('td');
                                outstandingCell.className = 'outstanding-cell';
                                const outstandingInput = document.createElement('input');
                                outstandingInput.type = 'text';
                                outstandingInput.className = 'number-input os-input';
                                outstandingInput.value = rowData.outstanding;
                                outstandingInput.setAttribute('oninput', 'formatNumber(this)');
                                outstandingInput.placeholder = 'Outstanding';
                                outstandingCell.appendChild(outstandingInput);
                                newRow.appendChild(outstandingCell);

                                // EMI amount cell
                                const emiCell = document.createElement('td');
                                emiCell.className = 'emi-cell';
                                const emiInput = document.createElement('input');
                                emiInput.type = 'text';
                                emiInput.className = 'number-input emi-input';
                                emiInput.value = rowData.emi;
                                emiInput.setAttribute('oninput', 'formatNumber(this)');
                                emiInput.placeholder = 'EMI';
                                emiCell.appendChild(emiInput);
                                newRow.appendChild(emiCell);

                                // Action cell
                                const actionCell = document.createElement('td');
                                actionCell.className = 'actions-cell';

                                // Create the action select element
                                const actionSelect = document.createElement('select');
                                actionSelect.className = 'action-select';
                                actionSelect.setAttribute('onchange', 'setAction(this)');

                                // Set styling for the select element
                                actionSelect.style.width = '100%';
                                actionSelect.style.height = '24px';
                                actionSelect.style.textAlign = 'center';
                                actionSelect.style.fontSize = '14px';
                                actionSelect.style.fontWeight = 'bold';
                                actionSelect.style.textTransform = 'uppercase';
                                actionSelect.style.borderRadius = '4px';
                                actionSelect.style.border = '1px solid #000000';

                                // Set background color based on action
                                if (rowData.action === 'BT') {
                                    actionSelect.style.backgroundColor = '#4CD964'; // Green
                                } else if (rowData.action === 'Obligate') {
                                    actionSelect.style.backgroundColor = '#FFFF00'; // Yellow
                                } else if (rowData.action === 'CO-PAY') {
                                    actionSelect.style.backgroundColor = '#FFA500'; // Bright Orange
                                } else if (rowData.action === 'Closed') {
                                    actionSelect.style.backgroundColor = '#FF0000'; // Red
                                } else if (rowData.action === 'NO-PAY') {
                                    actionSelect.style.backgroundColor = '#0080FF'; // Bright Blue
                                } else {
                                    actionSelect.style.backgroundColor = '#FFFFFF'; // White
                                }

                                // Add options to action select
                                const options = ['', 'BT', 'Obligate', 'CO-PAY', 'NO-PAY', 'Closed'];
                                options.forEach(option => {
                                    const optionElement = document.createElement('option');
                                    optionElement.value = option;
                                    optionElement.textContent = option === 'Obligate' ? 'OBLIGATE' :
                                                               option === 'Closed' ? 'CLOSED' :
                                                               option === 'CO-PAY' ? 'CO-PAY' :
                                                               option === 'NO-PAY' ? 'NO-PAY' : option;

                                    // Set selected option
                                    if (option === rowData.action) {
                                        optionElement.selected = true;
                                    }

                                    actionSelect.appendChild(optionElement);
                                });

                                // Create hidden inputs for action state
                                const actionState = document.createElement('input');
                                actionState.type = 'hidden';
                                actionState.className = 'action-state';
                                actionState.value = rowData.action || '';

                                const btApplied = document.createElement('input');
                                btApplied.type = 'hidden';
                                btApplied.className = 'bt-applied';
                                btApplied.value = rowData.action === 'BT' ? 'true' : 'false';

                                const obligateApplied = document.createElement('input');
                                obligateApplied.type = 'hidden';
                                obligateApplied.className = 'obligate-applied';
                                obligateApplied.value = rowData.action === 'Obligate' ? 'true' : 'false';

                                // Add the select element and hidden inputs to the action cell
                                actionCell.appendChild(actionSelect);
                                actionCell.appendChild(actionState);
                                actionCell.appendChild(btApplied);
                                actionCell.appendChild(obligateApplied);

                                // Add the action cell to the row
                                newRow.appendChild(actionCell);

                                // Delete button cell
                                const deleteCell = document.createElement('td');
                                const deleteButton = document.createElement('button');
                                deleteButton.className = 'delete-btn';
                                deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
                                deleteButton.title = 'Click to delete row';
                                deleteButton.onclick = function(event) {
                                    deleteRow(this, event);
                                };
                                deleteButton.oncontextmenu = function(event) {
                                    deleteRow(this, event);
                                    return false;
                                };
                                deleteCell.appendChild(deleteButton);
                                newRow.appendChild(deleteCell);

                                // Add row to table
                                tbody.appendChild(newRow);
                            });

                            // Apply the action for each row to ensure styling and calculations are correct
                            tbody.querySelectorAll('tr').forEach(row => {
                                const actionSelect = row.querySelector('.action-select');
                                if (actionSelect) {
                                    // Only trigger setAction if an action is selected
                                    if (actionSelect.value) {
                                        setAction(actionSelect);
                                    } else {
                                        // If no action is selected from Excel, set default to Obligate
                                        actionSelect.value = 'Obligate';
                                        actionSelect.style.backgroundColor = '#FFFF00';
                                        actionSelect.style.height = '24px';
                                        actionSelect.style.width = '100%';
                                        actionSelect.style.textAlign = 'left';
                                        actionSelect.style.fontWeight = '700';
                                        actionSelect.style.fontSize = '12px';
                                        actionSelect.style.textTransform = 'none';
                                        actionSelect.style.borderRadius = '4px';
                                        actionSelect.style.border = '1px solid #ccc';
                                        actionSelect.style.padding = '3px 5px';
                                        actionSelect.style.color = '#000000';
                                        const actionStateInput = row.querySelector('.action-state');
                                        const obligateAppliedInput = row.querySelector('.obligate-applied');
                                        if (actionStateInput) actionStateInput.value = 'Obligate';
                                        if (obligateAppliedInput) obligateAppliedInput.value = 'true';
                                        setAction(actionSelect);
                                    }
                                }
                            });

                            // Use recalculateTotals for consistent calculation
                            recalculateTotals();

                            // Sort rows and update row numbers
                            sortRows();

                            // Apply row colors based on actions
                            const rows = tbody.querySelectorAll('tr');
                            rows.forEach(row => {
                                const actionState = row.querySelector('.action-state');
                                if (actionState && actionState.value) {
                                    console.log("Found row with action:", actionState.value);

                                    // Get all elements in the row
                                    const productDisplay = row.querySelector('.product-display');
                                    const bankDisplay = row.querySelector('.bank-display');
                                    const tenureInput = row.querySelector('.tenure-input');
                                    const roiInput = row.querySelector('.roi-input');
                                    const totalLoanInput = row.querySelector('.loan-amount-cell input');
                                    const outstandingInput = row.querySelector('.outstanding-cell input');
                                    const emiAmountInput = row.querySelector('.emi-cell input');
                                    const actionDisplay = row.querySelector('.action-display');

                                    // Get all cells
                                    const allCells = row.querySelectorAll('td');

                                    // Apply colors based on action
                                    console.log(`Applying action state: ${actionState.value} to row`);

                                    if (actionState.value === 'BT') {
                                        row.classList.add('green-row');

                                        // Set BT applied flag
                                        const btApplied = row.querySelector('.bt-applied');
                                        const obligateApplied = row.querySelector('.obligate-applied');
                                        if (btApplied) btApplied.value = 'true';
                                        if (obligateApplied) obligateApplied.value = 'false';

                                        // Apply green background to all cells
                                        allCells.forEach(cell => {
                                            cell.style.backgroundColor = '#4CD964';
                                        });

                                        // Apply green background to all inputs
                                        [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                                            if (input) {
                                                input.style.backgroundColor = '#4CD964';
                                                input.style.color = '#000000';
                                                input.style.fontWeight = '700';
                                            }
                                        });

                                        // Highlight the Outstanding input for BT action
                                        if (outstandingInput) {
                                            outstandingInput.style.fontSize = '20px';  // Increased from 18px to 20px
                                            outstandingInput.style.fontWeight = '900';

                                            // Add green-bg class to the outstanding cell
                                            const outstandingCell = row.querySelector('.outstanding-cell');
                                            if (outstandingCell) {
                                                outstandingCell.classList.add('green-bg');
                                            }
                                        }

                                        // Update action select
                                        const actionSelect = row.querySelector('.action-select');
                                        if (actionSelect) {
                                            actionSelect.style.backgroundColor = '#4CD964';
                                            actionSelect.style.color = '#000000';
                                            actionSelect.style.fontWeight = 'bold';

                                            for (let i = 0; i < actionSelect.options.length; i++) {
                                                if (actionSelect.options[i].value === 'BT') {
                                                    actionSelect.selectedIndex = i;
                                                    break;
                                                }
                                            }
                                        }

                                    } else if (actionState.value === 'Obligate') {
                                        row.classList.add('orange-row');

                                        // Set Obligate applied flag
                                        const btApplied = row.querySelector('.bt-applied');
                                        const obligateApplied = row.querySelector('.obligate-applied');
                                        if (btApplied) btApplied.value = 'false';
                                        if (obligateApplied) obligateApplied.value = 'true';

                                        // Apply yellow background to all cells
                                        allCells.forEach(cell => {
                                            cell.style.backgroundColor = '#FFFF00';
                                        });

                                        // Apply yellow background to all inputs
                                        [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                                            if (input) {
                                                input.style.backgroundColor = '#FFFF00';
                                                input.style.color = '#000000';
                                                input.style.fontWeight = '700';
                                            }
                                        });

                                        // Highlight the EMI Amount input for Obligate action
                                        if (emiAmountInput) {
                                            emiAmountInput.style.fontSize = '20px';  // Increased from 18px to 20px
                                            emiAmountInput.style.fontWeight = '900';

                                            // Add orange-bg class to the EMI cell
                                            const emiCell = row.querySelector('.emi-cell');
                                            if (emiCell) {
                                                emiCell.classList.add('orange-bg');
                                            }
                                        }

                                        // Update action select
                                        const actionSelect = row.querySelector('.action-select');
                                        if (actionSelect) {
                                            actionSelect.style.backgroundColor = '#FFFF00';
                                            actionSelect.style.color = '#000000';
                                            actionSelect.style.fontWeight = 'bold';

                                            for (let i = 0; i < actionSelect.options.length; i++) {
                                                if (actionSelect.options[i].value === 'Obligate') {
                                                    actionSelect.selectedIndex = i;
                                                    break;
                                                }
                                            }
                                        }

                                    } else if (actionState.value === 'CO-PAY') {
                                        row.classList.add('bright-orange-row');

                                        // Set CO-PAY applied flag (use obligate flag since it adds to obligation)
                                        const btApplied = row.querySelector('.bt-applied');
                                        const obligateApplied = row.querySelector('.obligate-applied');
                                        if (btApplied) btApplied.value = 'false';
                                        if (obligateApplied) obligateApplied.value = 'true';

                                        // Apply bright orange background to all cells
                                        allCells.forEach(cell => {
                                            cell.style.backgroundColor = '#FFA500';
                                        });

                                        // Apply bright orange background to all inputs
                                        [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                                            if (input) {
                                                input.style.backgroundColor = '#FFA500';
                                                input.style.color = '#000000';
                                                input.style.fontWeight = '700';
                                            }
                                        });

                                        // Update action select
                                        const actionSelect = row.querySelector('.action-select');
                                        if (actionSelect) {
                                            actionSelect.style.backgroundColor = '#FFA500';
                                            actionSelect.style.color = '#000000';
                                            actionSelect.style.fontWeight = '700';
                                            actionSelect.style.textAlign = 'left';
                                            actionSelect.style.fontSize = '12px';
                                            actionSelect.style.height = '24px';
                                            actionSelect.style.padding = '3px 5px';
                                            actionSelect.style.border = '1px solid #ccc';
                                            actionSelect.style.textTransform = 'none';

                                            for (let i = 0; i < actionSelect.options.length; i++) {
                                                if (actionSelect.options[i].value === 'CO-PAY') {
                                                    actionSelect.selectedIndex = i;
                                                    break;
                                                }
                                            }
                                        }
                                    } else if (actionState.value === 'Closed') {
                                        row.classList.add('red-row');

                                        // Set Closed applied flag
                                        const btApplied = row.querySelector('.bt-applied');
                                        const obligateApplied = row.querySelector('.obligate-applied');
                                        if (btApplied) btApplied.value = 'false';
                                        if (obligateApplied) obligateApplied.value = 'false';

                                        // Apply red background to all cells
                                        allCells.forEach(cell => {
                                            cell.style.backgroundColor = '#FF0000';
                                        });

                                        // Apply red background to all inputs
                                        [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                                            if (input) {
                                                input.style.backgroundColor = '#FF0000';
                                                input.style.color = '#000000';
                                                input.style.fontWeight = '700';
                                            }
                                        });

                                        // Update action select
                                        const actionSelect = row.querySelector('.action-select');
                                        if (actionSelect) {
                                            actionSelect.style.backgroundColor = '#FF0000';
                                            actionSelect.style.color = '#000000';
                                            actionSelect.style.fontWeight = 'bold';

                                            for (let i = 0; i < actionSelect.options.length; i++) {
                                                if (actionSelect.options[i].value === 'Closed') {
                                                    actionSelect.selectedIndex = i;
                                                    break;
                                                }
                                            }
                                        }
                                    } else if (actionState.value === 'NO-PAY') {
                                        row.classList.add('blue-row');

                                        // Set NO-PAY applied flag (similar to Closed)
                                        const btApplied = row.querySelector('.bt-applied');
                                        const obligateApplied = row.querySelector('.obligate-applied');
                                        if (btApplied) btApplied.value = 'false';
                                        if (obligateApplied) obligateApplied.value = 'false';

                                        // Apply bright blue background to all cells
                                        allCells.forEach(cell => {
                                            cell.style.backgroundColor = '#0080FF';
                                        });

                                        // Apply bright blue background to all inputs
                                        [productDisplay, bankDisplay, tenureInput, roiInput, totalLoanInput, outstandingInput, emiAmountInput].forEach(input => {
                                            if (input) {
                                                input.style.backgroundColor = '#0080FF';
                                                input.style.color = '#000000';
                                                input.style.fontWeight = '700';
                                            }
                                        });

                                        // Update action select
                                        const actionSelect = row.querySelector('.action-select');
                                        if (actionSelect) {
                                            actionSelect.style.backgroundColor = '#0080FF';
                                            actionSelect.style.color = '#000000';
                                            actionSelect.style.fontWeight = 'bold';

                                            for (let i = 0; i < actionSelect.options.length; i++) {
                                                if (actionSelect.options[i].value === 'NO-PAY') {
                                                    actionSelect.selectedIndex = i;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }

                        console.log("Excel import: Initializing totals and calculations");

                        console.log("Excel import: Using recalculateTotals() for consistent calculation");

                        // Use the recalculateTotals function to ensure consistent calculation logic
                        // This will also handle CO-PAY and other special cases correctly
                        recalculateTotals();

                        // Calculate total income - make sure this happens after all salary fields are populated
                        if (typeof calculateTotal === 'function') {
                            console.log("Calculating total income after Excel import");
                            calculateTotal();
                        }

                        // Process bonus division if applicable
                        const bonusInput = document.getElementById('bonus');
                        if (bonusInput && parseIndianNumber(bonusInput.value) > 0) {
                            // Show the divide by months section
                            const divideByMonthsSection = document.getElementById('divideByMonthsSection');
                            if (divideByMonthsSection) {
                                divideByMonthsSection.style.display = 'block';

                                // If we have an active bonus button from the import, apply it
                                if (importedActiveBonusButton && [3, 6, 12, 24].includes(importedActiveBonusButton)) {
                                    console.log("Applying imported bonus button:", importedActiveBonusButton);

                                    // Set the original salary
                                    originalSalary = importedOriginalSalary > 0 ? importedOriginalSalary : parseIndianNumber(document.getElementById('salary').value);

                                    // Calculate the bonus amount
                                    const bonusAmount = parseIndianNumber(bonusInput.value);
                                    const monthlyBonus = Math.round(bonusAmount / importedActiveBonusButton);

                                    // Set the active button
                                    activeBonusButton = importedActiveBonusButton;
                                    lastAppliedBonus = bonusAmount;

                                    // Store the divided bonus amount
                                    dividedBonusAmount = monthlyBonus;

                                    // Update the total income calculation
                                    calculateTotal();

                                    // Highlight the active button
                                    document.getElementById('bonusButton3').style.background = importedActiveBonusButton === 3 ? 'var(--primary)' : 'var(--editable-bg)';
                                    document.getElementById('bonusButton3').style.color = importedActiveBonusButton === 3 ? '#000' : 'var(--text-dark)';

                                    document.getElementById('bonusButton6').style.background = importedActiveBonusButton === 6 ? 'var(--primary)' : 'var(--editable-bg)';
                                    document.getElementById('bonusButton6').style.color = importedActiveBonusButton === 6 ? '#000' : 'var(--text-dark)';

                                    document.getElementById('bonusButton12').style.background = importedActiveBonusButton === 12 ? 'var(--primary)' : 'var(--editable-bg)';
                                    document.getElementById('bonusButton12').style.color = importedActiveBonusButton === 12 ? '#000' : 'var(--text-dark)';

                                    document.getElementById('bonusButton24').style.background = importedActiveBonusButton === 24 ? 'var(--primary)' : 'var(--editable-bg)';
                                    document.getElementById('bonusButton24').style.color = importedActiveBonusButton === 24 ? '#000' : 'var(--text-dark)';
                                }
                            }
                        }

                        // Update eligibility section values
                        const eligibilityTotalObligation = document.getElementById('eligibilityTotalObligation');
                        const eligibilityTotalBtPos = document.getElementById('eligibilityTotalBtPos');

                        if (eligibilityTotalObligation) {
                            eligibilityTotalObligation.value = Math.round(totalObligation).toLocaleString('en-IN', {maximumFractionDigits: 0});
                        }

                        if (eligibilityTotalBtPos) {
                            eligibilityTotalBtPos.value = Math.round(totalBtPos).toLocaleString('en-IN', {maximumFractionDigits: 0});
                        }

                        // Calculate monthly EMI can pay
                        if (typeof calculateMonthlyEmiCanPay === 'function') {
                            try {
                                calculateMonthlyEmiCanPay();
                            } catch (error) {
                                console.error("Error in calculateMonthlyEmiCanPay:", error);
                            }
                        }

                        // Trigger calculation for eligibility
                        if (typeof calculateEligibility === 'function') {
                            try {
                                calculateEligibility();
                            } catch (error) {
                                console.error("Error in calculateEligibility:", error);
                            }
                        }

                        // Initialize all action selects to ensure text is visible
                        setTimeout(function() {
                            console.log("Running post-import action select initialization");

                            // First, make sure all action selects have the correct data-text attribute
                            document.querySelectorAll('.action-select').forEach(select => {
                                const selectedOption = select.options[select.selectedIndex];
                                const selectedText = selectedOption ? selectedOption.textContent : '';
                                select.setAttribute('data-text', selectedText);

                                // Force the select to have the correct styling
                                select.style.height = '24px';
                                select.style.width = '100%';
                                select.style.textAlign = 'left';
                                select.style.fontWeight = '700';
                                select.style.fontSize = '12px';
                                select.style.textTransform = 'none';
                                select.style.borderRadius = '4px';
                                select.style.border = '1px solid #ccc';
                                select.style.padding = '3px 5px';
                                select.style.color = '#000000'; // Ensure text is black

                                // Set background color based on selected value
                                const action = select.value;
                                if (action === 'BT') {
                                    select.style.backgroundColor = '#4CD964'; // Green
                                } else if (action === 'Obligate') {
                                    select.style.backgroundColor = '#FFFF00'; // Yellow
                                } else if (action === 'CO-PAY') {
                                    select.style.backgroundColor = '#FFA500'; // Bright Orange
                                } else if (action === 'Closed') {
                                    select.style.backgroundColor = '#FF0000'; // Red
                                } else if (action === 'NO-PAY') {
                                    select.style.backgroundColor = '#0080FF'; // Bright Blue
                                } else {
                                    select.style.backgroundColor = '#FFFFFF'; // White
                                }
                            });

                            // Then run the standard initialization
                            initializeAllActionSelects();
                        }, 500);

                        // Final recalculation of total income to ensure it reflects all imported values
                        setTimeout(function() {
                            console.log("Final recalculation of total income after import");
                            calculateTotal();

                            // Update eligibility calculations
                            if (typeof calculateEligibility === 'function') {
                                calculateEligibility();
                            }
                        }, 500);

                        // Show beautiful centered notification instead of alert
                        showCenteredNotification('Data imported successfully!');
                        return;
                    } else {
                        alert('No valid data found in the Excel file. Please use the correct format with an "All Data" sheet.');
                        return;
                    }

                    // No fallback to old format - we only support the All Data sheet
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error importing from Excel:', error);
                alert('Error importing from Excel. Please check the file format and try again.');
            }
        }

        // Function to open Zauba Corp website with company name
        function openZaubaCorp() {
            const companyName = document.getElementById('companyName').value.trim();
            const baseUrl = "https://www.zaubacorp.com/";

            // Open Zauba Corp website
            if (companyName) {
                // If company name is provided, search for it
                const searchUrl = baseUrl + "company-search?q=" + encodeURIComponent(companyName);
                window.open(searchUrl, '_blank');
            } else {
                // If no company name, just open the main site
                window.open(baseUrl, '_blank');
            }
        }
    </script>
</body>
</html>
