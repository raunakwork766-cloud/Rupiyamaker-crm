# Apache Virtual Host for RupiyaMe CRM Development (Port 4522)
# Optimized for maximum performance with compression and caching

<VirtualHost *:4522>
    ServerName localhost
    ServerAlias 127.0.0.1
    
    DocumentRoot /www/wwwroot/RupiyaMe/rupiyamaker-UI/crm/dist
    
    <Directory /www/wwwroot/RupiyaMe/rupiyamaker-UI/crm/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Enable SPA routing - all requests to index.html
        FallbackResource /index.html
    </Directory>
    
    # ========================================
    # COMPRESSION - Gzip
    # ========================================
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE text/javascript
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/atom_xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
        AddOutputFilterByType DEFLATE image/svg+xml
        
        # Disable for old browsers
        BrowserMatch ^Mozilla/4 gzip-only-text/html
        BrowserMatch ^Mozilla/4\.0[678] no-gzip
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
        
        Header append Vary User-Agent env=!dont-vary
        
        # Set compression level (1-9, 6 is good balance)
        DeflateCompressionLevel 6
    </IfModule>
    
    # ========================================
    # BROWSER CACHING - Aggressive
    # ========================================
    <IfModule mod_expires.c>
        ExpiresActive On
        
        # HTML files - no cache (for updates)
        ExpiresByType text/html "access plus 0 seconds"
        
        # CSS and JavaScript - 1 year (with hash in filename)
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType application/x-javascript "access plus 1 year"
        
        # Images - 1 year
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/x-icon "access plus 1 year"
        
        # Fonts - 1 year
        ExpiresByType font/ttf "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
        
        # JSON and XML - 1 hour
        ExpiresByType application/json "access plus 1 hour"
        ExpiresByType application/xml "access plus 1 hour"
    </IfModule>
    
    # Cache-Control headers
    <IfModule mod_headers.c>
        # HTML - no cache
        <FilesMatch "\.(html|htm)$">
            Header set Cache-Control "no-cache, no-store, must-revalidate"
            Header set Pragma "no-cache"
            Header set Expires 0
        </FilesMatch>
        
        # Static assets - immutable
        <FilesMatch "\.(js|css|jpg|jpeg|png|gif|ico|webp|svg|woff|woff2|ttf|otf|eot)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>
        
        # Security headers
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "no-referrer-when-downgrade"
        
        # Remove server signature
        Header unset Server
        Header unset X-Powered-By
    </IfModule>
    
    # ========================================
    # API PROXY to DEV Backend (Port 8051)
    # ========================================
    <IfModule mod_proxy.c>
        ProxyPreserveHost On
        
        # SSL proxy settings for HTTPS backend
        SSLProxyEngine On
        SSLProxyVerify none
        SSLProxyCheckPeerCN off
        SSLProxyCheckPeerName off
        SSLProxyCheckPeerExpire off
        
        ProxyPass /api/ https://localhost:8051/
        ProxyPassReverse /api/ https://localhost:8051/
        
        # Proxy timeout
        ProxyTimeout 60
        
        # Don't cache API responses
        <Location /api>
            Header set Cache-Control "no-cache, no-store, must-revalidate"
        </Location>
    </IfModule>
    
    # ========================================
    # PERFORMANCE OPTIMIZATIONS
    # ========================================
    
    # Enable KeepAlive
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5
    
    # Error and Access logs
    ErrorLog /www/wwwroot/RupiyaMe/rupiyamaker-UI/crm/logs/apache-dev-error.log
    CustomLog /www/wwwroot/RupiyaMe/rupiyamaker-UI/crm/logs/apache-dev-access.log combined env=!dontlog
    
    # Don't log static assets (for performance)
    SetEnvIf Request_URI "\.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf)$" dontlog
</VirtualHost>
