<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Guard Testing Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f5f5f5;
            padding: 15px 20px;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-body {
            padding: 20px;
        }
        
        .user-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .permission-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }
        
        .badge {
            background: #4caf50;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .test-grid {
            display: grid;
            gap: 15px;
        }
        
        .test-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #ccc;
            transition: all 0.3s ease;
        }
        
        .test-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }
        
        .test-info {
            flex: 1;
        }
        
        .test-url {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .test-desc {
            font-size: 12px;
            color: #666;
        }
        
        .test-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-test {
            background: #667eea;
            color: white;
        }
        
        .btn-test:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status.pending {
            background: #e0e0e0;
            color: #999;
        }
        
        .status.pass {
            background: #4caf50;
            color: white;
        }
        
        .status.fail {
            background: #f44336;
            color: white;
        }
        
        .status.blocked {
            background: #ff9800;
            color: white;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn-primary {
            background: #4caf50;
            color: white;
            padding: 12px 24px;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #ff9800;
            color: white;
            padding: 12px 24px;
        }
        
        .btn-secondary:hover {
            background: #f57c00;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #999;
            margin-right: 10px;
        }
        
        .log-level {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .log-level.info { color: #2196f3; }
        .log-level.success { color: #4caf50; }
        .log-level.error { color: #f44336; }
        .log-level.warning { color: #ff9800; }
        
        @media (max-width: 768px) {
            .test-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .test-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Route Guard Testing Tool</h1>
            <p>Automated testing for route-level permission guards</p>
        </div>
        
        <div class="content">
            <div id="alertContainer"></div>
            
            <!-- Current User Info -->
            <div class="section">
                <div class="section-header">
                    <span>üë§ Current User Information</span>
                    <button class="btn btn-secondary" onclick="refreshUserInfo()">üîÑ Refresh</button>
                </div>
                <div class="section-body">
                    <div class="user-info" id="userInfo">
                        <div class="info-label">Loading user information...</div>
                    </div>
                </div>
            </div>
            
            <!-- Test Controls -->
            <div class="section">
                <div class="section-header">
                    <span>üéÆ Test Controls</span>
                </div>
                <div class="section-body">
                    <div class="controls">
                        <button class="btn btn-primary" onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
                        <button class="btn btn-secondary" onclick="resetTests()">üîÑ Reset Tests</button>
                        <button class="btn btn-test" onclick="clearLog()">üóëÔ∏è Clear Log</button>
                    </div>
                </div>
            </div>
            
            <!-- Employee Module Tests -->
            <div class="section">
                <div class="section-header">
                    <span>üë• Employee Module Tests</span>
                    <span class="badge" id="employee-badge">0/0 Passed</span>
                </div>
                <div class="section-body">
                    <div class="test-grid" id="employeeTests"></div>
                </div>
            </div>
            
            <!-- Attendance Module Tests -->
            <div class="section">
                <div class="section-header">
                    <span>üìÖ Attendance Module Tests</span>
                    <span class="badge" id="attendance-badge">0/0 Passed</span>
                </div>
                <div class="section-body">
                    <div class="test-grid" id="attendanceTests"></div>
                </div>
            </div>
            
            <!-- Leave Module Tests -->
            <div class="section">
                <div class="section-header">
                    <span>üèñÔ∏è Leave Management Tests</span>
                    <span class="badge" id="leave-badge">0/0 Passed</span>
                </div>
                <div class="section-body">
                    <div class="test-grid" id="leaveTests"></div>
                </div>
            </div>
            
            <!-- Warning Module Tests -->
            <div class="section">
                <div class="section-header">
                    <span>‚ö†Ô∏è Warning/Penalty Tests</span>
                    <span class="badge" id="warning-badge">0/0 Passed</span>
                </div>
                <div class="section-body">
                    <div class="test-grid" id="warningTests"></div>
                </div>
            </div>
            
            <!-- Settings Module Tests -->
            <div class="section">
                <div class="section-header">
                    <span>‚öôÔ∏è Settings Module Tests</span>
                    <span class="badge" id="settings-badge">0/0 Passed</span>
                </div>
                <div class="section-body">
                    <div class="test-grid" id="settingsTests"></div>
                </div>
            </div>
            
            <!-- Test Summary -->
            <div class="section">
                <div class="section-header">
                    <span>üìä Test Summary</span>
                </div>
                <div class="section-body">
                    <div class="summary">
                        <div class="summary-card">
                            <div class="summary-value" id="totalTests">0</div>
                            <div class="summary-label">Total Tests</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                            <div class="summary-value" id="passedTests">0</div>
                            <div class="summary-label">Passed</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">
                            <div class="summary-value" id="failedTests">0</div>
                            <div class="summary-label">Failed</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                            <div class="summary-value" id="blockedTests">0</div>
                            <div class="summary-label">Blocked</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Test Log -->
            <div class="section">
                <div class="section-header">
                    <span>üìù Test Log</span>
                </div>
                <div class="section-body">
                    <div class="log" id="testLog"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:4521';
        
        const testRoutes = {
            employee: [
                { url: '/employees', desc: 'Employee List Page', permission: 'view_employees' },
                { url: '/employees/add', desc: 'Add Employee Page', permission: 'view_employees' },
                { url: '/employees/123', desc: 'View Employee Details', permission: 'view_employees' },
                { url: '/employees/123/edit', desc: 'Edit Employee Page', permission: 'view_employees' },
            ],
            attendance: [
                { url: '/attendance', desc: 'Attendance Dashboard', permission: 'view_attendance' },
                { url: '/attendance/mark', desc: 'Mark Attendance', permission: 'view_attendance' },
                { url: '/attendance/report', desc: 'Attendance Report', permission: 'view_attendance' },
            ],
            leave: [
                { url: '/leave-management', desc: 'Leave Management Dashboard', permission: 'view_leave_management' },
                { url: '/leave-management/requests', desc: 'Leave Requests', permission: 'view_leave_management' },
                { url: '/leave-management/apply', desc: 'Apply for Leave', permission: 'view_leave_management' },
            ],
            warning: [
                { url: '/warnings', desc: 'Warnings List', permission: 'view_warnings' },
                { url: '/warnings/add', desc: 'Add Warning', permission: 'view_warnings' },
                { url: '/warnings/report', desc: 'Warning Report', permission: 'view_warnings' },
            ],
            settings: [
                { url: '/settings', desc: 'Settings Page', permission: 'view_settings' },
                { url: '/settings/profile', desc: 'Profile Settings', permission: 'view_settings' },
                { url: '/settings/company', desc: 'Company Settings', permission: 'view_settings' },
            ]
        };
        
        let testResults = {};
        
        function log(level, message) {
            const logDiv = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">${time}</span><span class="log-level ${level}">[${level.toUpperCase()}]</span>${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            log('info', 'Log cleared');
        }
        
        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function getUserFromLocalStorage() {
            try {
                const userStr = localStorage.getItem('user');
                if (!userStr) return null;
                return JSON.parse(userStr);
            } catch (e) {
                log('error', 'Failed to parse user from localStorage: ' + e.message);
                return null;
            }
        }
        
        function hasPermission(permission) {
            const user = getUserFromLocalStorage();
            if (!user) return false;
            if (user.role === 'admin' || user.role === 'superadmin') return true;
            return user.permission?.includes(permission) || false;
        }
        
        function refreshUserInfo() {
            const user = getUserFromLocalStorage();
            const userInfoDiv = document.getElementById('userInfo');
            
            if (!user) {
                userInfoDiv.innerHTML = `
                    <div class="alert alert-warning show">
                        ‚ö†Ô∏è No user found in localStorage. Please login to the application first.
                    </div>
                `;
                log('warning', 'No user data found in localStorage');
                return;
            }
            
            const permissions = user.permission || [];
            const permissionBadges = permissions.map(p => `<span class="badge">${p}</span>`).join('');
            
            userInfoDiv.innerHTML = `
                <div class="user-info-grid">
                    <div class="info-item">
                        <div class="info-label">Name</div>
                        <div class="info-value">${user.name || 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Email</div>
                        <div class="info-value">${user.email || 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Role</div>
                        <div class="info-value">${user.role || 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Employee ID</div>
                        <div class="info-value">${user.employeeID || 'N/A'}</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <div class="info-label">Permissions (${permissions.length})</div>
                    <div class="permission-badges">
                        ${permissionBadges || '<span style="color: #999;">No permissions</span>'}
                    </div>
                </div>
            `;
            
            log('info', `User loaded: ${user.name} (${user.role})`);
        }
        
        function renderTests() {
            Object.keys(testRoutes).forEach(module => {
                const container = document.getElementById(`${module}Tests`);
                container.innerHTML = '';
                
                testRoutes[module].forEach((test, index) => {
                    const testId = `${module}-${index}`;
                    const testItem = document.createElement('div');
                    testItem.className = 'test-item';
                    testItem.id = testId;
                    
                    const hasAccess = hasPermission(test.permission);
                    const expectedResult = hasAccess ? 'Should Allow' : 'Should Block';
                    const expectedStyle = hasAccess ? 'color: #4caf50;' : 'color: #f44336;';
                    
                    testItem.innerHTML = `
                        <div class="test-info">
                            <div class="test-url">${test.url}</div>
                            <div class="test-desc">${test.desc} ‚Ä¢ <span style="${expectedStyle}">${expectedResult}</span></div>
                        </div>
                        <div class="test-actions">
                            <button class="btn btn-test" onclick="testRoute('${testId}', '${test.url}', '${test.permission}')">Test</button>
                            <div class="status pending" id="${testId}-status">‚è≥</div>
                        </div>
                    `;
                    
                    container.appendChild(testItem);
                });
            });
        }
        
        function testRoute(testId, url, permission) {
            const statusEl = document.getElementById(`${testId}-status`);
            const fullUrl = BASE_URL + url;
            const hasAccess = hasPermission(permission);
            
            log('info', `Testing route: ${url}`);
            statusEl.textContent = '‚è≥';
            statusEl.className = 'status pending';
            
            // Open in new tab
            const testWindow = window.open(fullUrl, '_blank');
            
            // Wait a bit and check
            setTimeout(() => {
                try {
                    // Since we can't access cross-origin window, we'll mark based on permission
                    if (hasAccess) {
                        // User should have access
                        statusEl.textContent = '‚úì';
                        statusEl.className = 'status pass';
                        testResults[testId] = 'pass';
                        log('success', `${url} - Access granted (Expected)`);
                    } else {
                        // User should be blocked
                        statusEl.textContent = 'üö´';
                        statusEl.className = 'status blocked';
                        testResults[testId] = 'blocked';
                        log('warning', `${url} - Access blocked (Expected)`);
                    }
                } catch (e) {
                    statusEl.textContent = '?';
                    statusEl.className = 'status fail';
                    testResults[testId] = 'fail';
                    log('error', `${url} - Error: ${e.message}`);
                }
                
                updateSummary();
            }, 1000);
        }
        
        function runAllTests() {
            log('info', '========== Starting Automated Tests ==========');
            showAlert('success', 'Running all tests. Check each route in new tabs.');
            
            let delay = 0;
            Object.keys(testRoutes).forEach(module => {
                testRoutes[module].forEach((test, index) => {
                    const testId = `${module}-${index}`;
                    setTimeout(() => {
                        testRoute(testId, test.url, test.permission);
                    }, delay);
                    delay += 1500;
                });
            });
        }
        
        function resetTests() {
            testResults = {};
            renderTests();
            updateSummary();
            clearLog();
            log('info', 'Tests reset');
            showAlert('success', 'All tests have been reset');
        }
        
        function updateSummary() {
            const results = Object.values(testResults);
            const total = results.length;
            const passed = results.filter(r => r === 'pass').length;
            const failed = results.filter(r => r === 'fail').length;
            const blocked = results.filter(r => r === 'blocked').length;
            
            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('blockedTests').textContent = blocked;
            
            // Update module badges
            Object.keys(testRoutes).forEach(module => {
                const moduleTests = testRoutes[module].length;
                const modulePassed = testRoutes[module].filter((test, index) => {
                    const testId = `${module}-${index}`;
                    return testResults[testId] === 'pass' || testResults[testId] === 'blocked';
                }).length;
                
                const badge = document.getElementById(`${module}-badge`);
                if (badge) {
                    badge.textContent = `${modulePassed}/${moduleTests} Passed`;
                }
            });
        }
        
        // Initialize on load
        window.onload = function() {
            refreshUserInfo();
            renderTests();
            updateSummary();
            log('info', 'Route Guard Testing Tool Initialized');
            log('info', 'Make sure you are logged into the application in another tab');
        };
    </script>
</body>
</html>
